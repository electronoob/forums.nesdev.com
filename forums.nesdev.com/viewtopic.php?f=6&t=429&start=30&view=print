<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html dir="ltr" lang="en-gb">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta http-equiv="Content-Style-Type" content="text/css">
<meta http-equiv="Content-Language" content="en-gb">
<title>nesdev.com :: View topic - Loading NSFs into ROMs</title>

<style type="text/css">
<!--

body {
	font-family: Verdana,serif;
	font-size: 10pt;
}

img {
	border: 0;
}

td {
	font-family: Verdana,serif;
	font-size: 10pt;
	line-height: 150%;
}

.code, .codecontent, 
.quote, .quotecontent {
	margin: 0 5px 0 5px;
	padding: 5px;
	font-size: smaller;
	border: black solid 1px;
}

.quotetitle {
	color: black;
	display : block;
	font-weight: bold;
}

.forum {
	font-family: Arial,Helvetica,sans-serif;
	font-weight: bold;
	font-size: 18pt;
}

.topic {
	font-family: Arial,Helvetica,sans-serif;
	font-size: 14pt;
	font-weight: bold;
}

.gensmall {
	font-size: 8pt;
}

hr {
	color: #888;
	height: 3px;
	border-style: solid;
}

hr.sep {
	color: #aaa;
	height: 1px;
	border-style: dashed;
}
//-->
</style>

</head>
<body>

<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
<tr>
	<td colspan="2" align="center"><span class="Forum">nesdev.com</span><br /><span class="gensmall"><a href="http://forums.nesdev.com/">http://forums.nesdev.com/</a></span></td>
</tr>
<tr>
	<td colspan="2"><br /></td>
</tr>
<tr>
	<td><span class="topic">Loading NSFs into ROMs</span><br /><span class="gensmall"><a href="http://forums.nesdev.com/viewtopic.php?f=6&amp;t=429">http://forums.nesdev.com/viewtopic.php?f=6&amp;t=429</a></span></td>
	<td align="right" valign="bottom"><span class="gensmall">Page <strong>3</strong> of <strong>3</strong></span></td>
</tr>
</table>



	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Celius</b> [ Mon Sep 26, 2005 3:00 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Okay, thank you very much for sending me that, but I'm really sorry, but could you send me the NSF replay code for that? if it's not too much to ask, because it won't work with my NSF, but it works with yours. And how did you get your NSF to be 8K? whenever I make mine, they're 16K. I would appreciate if you put up the NSF replay code <img src="./images/smilies/icon_smile.gif" alt=":)" title="Smile" />.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>blargg</b> [ Mon Sep 26, 2005 3:52 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Sorry, what I posted along with study of the NSF file spec will provide you with <em>plenty</em> of study.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Celius</b> [ Mon Sep 26, 2005 7:41 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />I just want to ask you if you used the NT2 to NSF code that was supplied? with modifications? Because I don't see how I could study the NSF itself, without the NSF replay code. Tell me if I'm wrong. I don't mean to be a pain, like I always am, sorry... <img src="./images/smilies/icon_sad.gif" alt=":(" title="Sad" />

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>blargg</b> [ Mon Sep 26, 2005 10:33 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />All I did was write some glue code to run an NSF inside a NES ROM. The code demonstrates how to locate the NSF data at the proper address (based on looking at the NSF header with a hex editor) and then call the init and play routines. If you already have no problem doing this and are having trouble with specific NSF files only, then I wasn't following the thread closely enough.
<br />
<br />I don't know much about the NT2 NSF engine, but if it doesn't use bank switching then an NSF generated by it should be usable with the above method.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>tepples</b> [ Mon Sep 26, 2005 10:33 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />If you cut out all the DPCM code then you can get the .ned file below 16 KB.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Celius</b> [ Wed Sep 28, 2005 6:39 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />ugh... I HATE that NSF replay code! it's SO LONG, and SO HARD TO FIND ANYTHING! Okay, I know I always just take the easy way out, and ask everyone else to do everything for me, but I really really need to know something. Does the NSF NT2 code use bank switching? and where's the DPCM stuff? This should be so unhard, it's not even funny! It's so complicated it really irritates me! I'm sorry, I know I'm a pain.... <img src="./images/smilies/icon_sad.gif" alt=":(" title="Sad" />

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Memblers</b> [ Thu Sep 29, 2005 2:41 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />NT2 NSFs never use bankswitching.  And usually the DPCM will be at $C000, it can be placed starting on a higher address too but noone hardly ever does that.  Usually there'd be a lot of space between the NSF code/data and samples, so I'd split them into seperate files.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>tepples</b> [ Thu Sep 29, 2005 11:51 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Or set it up so that it assembles the NT2 code right after the DPCM samples, and then use the initial bankswitch state bits in the header to map the 16 KB NSF into CPU$C000 space.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>norfair</b> [ Mon Aug 07, 2006 2:30 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />necro-bump <img src="./images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" />
<br />
<br />I used this thread to get nsf's running in a compiled rom. I know it is an old thread, and that the OP probably figured it out already, but I'll post what I did in case it can help other people.
<br />
<br />#1. Changed from nesasm to dasm. Got rid of .bank problems (was more trouble than it's worth).
<br />
<br />#2. "Padded" the NSF I wanted to use. I found no other way to align data properly in the rom. This is the area where advice would be welcome.
<br />
<br />For example, I wanted to include Zelda.nsf in my program. 
<br />
<br />The size of the music data, when the header is taken off is $12C4 bytes.
<br />
<br />It's load adress is $8D60, init is $A003 and play is $A000. For the rom to be the correct size (32 784 bytes?), I had to pad $0D60 worth of zeroes before the music data, and $1FDC worth after. 
<br />
<br />This was to make the $12C4 bytes file weight $4000 bytes, for the load offset to align properly(and fill an entire prg-rom bank).
<br />
<br />Is it common practice to do this? Is it assumed that nsf data within a nes rom weights exactly 16kb?
<br />
<br />#3. Cleared the ram from $0000 to $07FF ... It would NOT work at all without doing that. Nintendulator would just spew out some unorganized beeps! This is what happens when you don't follow chris's example closely enough...
<br />
<br />Anyways, for other newbies having problems with this, I ended up with this code:
<br />
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">INIT EQU #$A003<br />PLAY EQU #$A000<br />&nbsp; &nbsp;PROCESSOR 6502<br />&nbsp; &nbsp;ORG $C000<br />.reset&nbsp; &nbsp;<br />&nbsp; &nbsp;sei<br />&nbsp; &nbsp;cld<br /><br />.waitv&nbsp; &nbsp;<br />&nbsp; &nbsp;bit $2002<br />&nbsp; &nbsp;bpl .waitv<br /><br />&nbsp; &nbsp;lda #$0<br />&nbsp; &nbsp;tax<br />.clearRam<br />&nbsp; &nbsp;sta $0000,X<br />&nbsp; &nbsp;sta $0100,X<br />&nbsp; &nbsp;sta $0200,X<br />&nbsp; &nbsp;sta $0300,X<br />&nbsp; &nbsp;sta $0400,X<br />&nbsp; &nbsp;sta $0500,X<br />&nbsp; &nbsp;sta $0600,X<br />&nbsp; &nbsp;sta $0700,X<br />&nbsp; &nbsp;inx<br />&nbsp; &nbsp;bne .clearRam&nbsp; &nbsp; ;clear RAM<br /><br />&nbsp; &nbsp;lda #$0<br />&nbsp; &nbsp;ldx #$0<br />&nbsp; &nbsp;jsr INIT<br />&nbsp; &nbsp;lda #%10000000<br />&nbsp; &nbsp;sta $2000 ; &lt;- enable play after init<br /><br />.loop&nbsp; &nbsp;<br />&nbsp; &nbsp;jmp .loop<br /><br />.nmi&nbsp; &nbsp;<br />&nbsp; &nbsp;jsr PLAY<br /><br />.irq&nbsp; &nbsp;<br />&nbsp; &nbsp;rti<br /><br />&nbsp; &nbsp;ORG $FFFA,0<br />&nbsp; &nbsp;dc.w .nmi<br />&nbsp; &nbsp;dc.w .reset<br />&nbsp; &nbsp;dc.w .irq<br /></div><br /><br />You can compile it with dasm using this syntax:<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">dasm asmfile.asm -f3</div><br /><br />and then assemble the rom this way:<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">copy /b header.bin+music.bin+a.out rom.nes</div>
<br />
<br />where:
<br />header.bin is the iNes header (2 prg banks, 0 chr-bank, mapper0)
<br />music.bin is the padded music data (16kb)
<br />a.out is the 16kb prg-rom outputted by dasm
<br />
<br />Of course this code will only run the "First track" of the nsf.
<br />
<br />If anyone can answer my interrogations it would be most appreciated!

		

		</td>
	</tr>
	</table>


<hr width="85%" />

<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
<tr>
	<td><span class="gensmall">Page <strong>3</strong> of <strong>3</strong></span></td>
	<td align="right"><span class="gensmall">All times are UTC - 7 hours </span></td>
</tr>
<tr>
	<td colspan="2" align="center"><span class="gensmall">Powered by phpBB&reg; Forum Software &copy; phpBB Group<br />http://www.phpbb.com/</span></td>
</tr>
</table>

</body>
</html>