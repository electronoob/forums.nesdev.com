<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en-gb" xml:lang="en-gb">
<head>

<link rel="icon" href="/favicon.ico" type="image/x-icon" />
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
<meta http-equiv="content-language" content="en-gb" />
<meta http-equiv="content-style-type" content="text/css" />
<meta http-equiv="imagetoolbar" content="no" />
<meta name="resource-type" content="document" />
<meta name="distribution" content="global" />
<meta name="keywords" content="" />
<meta name="description" content="" />

<title>nesdev.com &bull; View topic - Adding features to discrete mapper with multipurposed CIC</title>

<link rel="alternate" type="application/atom+xml" title="Feed - nesdev.com" href="https://forums.nesdev.com/feed.php" /><link rel="alternate" type="application/atom+xml" title="Feed - News" href="https://forums.nesdev.com/feed.php?mode=news" /><link rel="alternate" type="application/atom+xml" title="Feed - All forums" href="https://forums.nesdev.com/feed.php?mode=forums" /><link rel="alternate" type="application/atom+xml" title="Feed - New Topics" href="https://forums.nesdev.com/feed.php?mode=topics" /><link rel="alternate" type="application/atom+xml" title="Feed - Active Topics" href="https://forums.nesdev.com/feed.php?mode=topics_active" /><link rel="alternate" type="application/atom+xml" title="Feed - Forum - NES Hardware and Flash Equipment" href="https://forums.nesdev.com/feed.php?f=9" /><link rel="alternate" type="application/atom+xml" title="Feed - Topic - Adding features to discrete mapper with multipurposed CIC" href="https://forums.nesdev.com/feed.php?f=9&amp;t=15633" />

<link rel="stylesheet" href="./style.php?id=1&amp;lang=en" type="text/css" />

<script type="text/javascript">
// <![CDATA[


function popup(url, width, height, name)
{
	if (!name)
	{
		name = '_popup';
	}

	window.open(url.replace(/&amp;/g, '&'), name, 'height=' + height + ',resizable=yes,scrollbars=yes,width=' + width);
	return false;
}

function jumpto()
{
	var page = prompt('Enter the page number you wish to go to:', '1');
	var per_page = '15';
	var base_url = './viewtopic.php?f=9&amp;t=15633';

	if (page !== null && !isNaN(page) && page == Math.floor(page) && page > 0)
	{
		if (base_url.indexOf('?') == -1)
		{
			document.location.href = base_url + '?start=' + ((page - 1) * per_page);
		}
		else
		{
			document.location.href = base_url.replace(/&amp;/g, '&') + '&start=' + ((page - 1) * per_page);
		}
	}
}

/**
* Find a member
*/
function find_username(url)
{
	popup(url, 760, 570, '_usersearch');
	return false;
}

/**
* Mark/unmark checklist
* id = ID of parent container, name = name prefix, state = state [true/false]
*/
function marklist(id, name, state)
{
	var parent = document.getElementById(id);
	if (!parent)
	{
		eval('parent = document.' + id);
	}

	if (!parent)
	{
		return;
	}

	var rb = parent.getElementsByTagName('input');
	
	for (var r = 0; r < rb.length; r++)
	{
		if (rb[r].name.substr(0, name.length) == name)
		{
			rb[r].checked = state;
		}
	}
}



// ]]>
</script>
</head>
<body class="ltr">

<a name="top"></a>

<div id="wrapheader">

	<div id="logodesc">
	</div>

	<div id="menubar">

		<table width="100%" cellspacing="0">
		<tr>
			<td rowspan="2"><a href="./index.php"><img src="./styles/subsilver2/imageset/site_logo.gif" alt="" title="" /></a></td>
			<td width="100%" align="center"><h1>nesdev.com</h1><span class="gen">NES Development and Strangulation Records message boards</span></td>
		</tr>
		<tr>
			<td align="center">
				<!--<div style="float: right;">
					<form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_top">
					<input type="hidden" name="cmd" value="_s-xclick">
					<input type="hidden" name="hosted_button_id" value="X2HM4WNR5YT8S">
					<input type="image" src="https://www.paypalobjects.com/en_US/i/btn/btn_donateCC_LG.gif" border="0" name="submit" alt="PayPal - The safer, easier way to pay online!">
					<img alt="" border="0" src="https://www.paypalobjects.com/en_US/i/scr/pixel.gif" width="1" height="1">
					</form>
				</div>-->
				<a href="./faq.php"><img src="./styles/prosilver/theme/images/icon_mini_faq.gif" width="12" height="13" alt="*" /> FAQ</a>
				&nbsp; &nbsp;<a href="./search.php"><img src="./styles/prosilver/theme/images/icon_mini_search.gif" width="12" height="13" alt="*" /> Search</a>
				<br />	
				 &nbsp;<a href="./ucp.php?mode=minion"><img src="./styles/prosilver/theme/images/icon_mini_register.gif" width="12" height="13" alt="*" /> Register</a>
					&nbsp; &nbsp;<a href="./ucp.php?mode=login"><img src="./styles/prosilver/theme/images/icon_mini_login.gif" width="12" height="13" alt="*" /> Login</a>&nbsp;
			</td>
		</tr>
		</table>
	</div>

	<div id="datebar">
		<table width="100%" cellspacing="0">
		<tr>
			<td class="gensmall"></td>
			<td class="gensmall" align="right">It is currently Fri Aug 17, 2018 2:24 am<br /></td>
		</tr>
		</table>
	</div>

</div>

<div id="wrapcentre">

	
	<p class="searchbar">
		<span style="float: left;"><a href="./search.php?search_id=unanswered">View unanswered posts</a> | <a href="./search.php?search_id=active_topics">View active topics</a></span>
		
	</p>
	

	<br style="clear: both;" />

	<table class="tablebg" width="100%" cellspacing="1" cellpadding="0" style="margin-top: 5px;">
	<tr>
		<td class="row1">
			<p class="breadcrumbs"><a href="./index.php">Board index</a> &#187; <a href="./viewforum.php?f=24">NES / Famicom</a> &#187; <a href="./viewforum.php?f=9">NES Hardware and Flash Equipment</a></p>
			<p class="datetime">All times are UTC - 7 hours </p>
		</td>
	</tr>
	</table>

	<br />
	

					<center>
					<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
					<!-- NesDev Forums -->
					<ins class="adsbygoogle"
						 style="display:block"
						 data-ad-client="ca-pub-7801010229099644"
						 data-ad-slot="7979066809"
						 data-ad-format="auto"></ins>
					<script>
					(adsbygoogle = window.adsbygoogle || []).push({});
					</script>
					</center>
	<br />


<div id="pageheader">
	<h2><a class="titles" href="./viewtopic.php?f=9&amp;t=15633">Adding features to discrete mapper with multipurposed CIC</a></h2>


	<p class="moderators">Moderators: <a href="./memberlist.php?mode=viewprofile&amp;u=3466">B00daW</a>, <a href="./memberlist.php?mode=group&amp;g=320">Moderators</a></p>

</div>

<br clear="all" /><br />

<div id="pagecontent">

	<table width="100%" cellspacing="1">
	<tr>
		<td align="left" valign="middle" nowrap="nowrap">
		<a href="./posting.php?mode=post&amp;f=9"><img src="./styles/subsilver2/imageset/en/button_topic_new.gif" alt="Post new topic" title="Post new topic" /></a>&nbsp;<a href="./posting.php?mode=reply&amp;f=9&amp;t=15633"><img src="./styles/subsilver2/imageset/en/button_topic_reply.gif" alt="Reply to topic" title="Reply to topic" /></a>
		</td>
		
			<td class="nav" valign="middle" nowrap="nowrap">&nbsp;Page <strong>1</strong> of <strong>7</strong><br /></td>
			<td class="gensmall" nowrap="nowrap">&nbsp;[ 97 posts ]&nbsp;</td>
			<td class="gensmall" width="100%" align="right" nowrap="nowrap"><b><a href="#" onclick="jumpto(); return false;" title="Click to jump to pageâ€¦">Go to page</a> <strong>1</strong><span class="page-sep">, </span><a href="./viewtopic.php?f=9&amp;t=15633&amp;start=15">2</a><span class="page-sep">, </span><a href="./viewtopic.php?f=9&amp;t=15633&amp;start=30">3</a><span class="page-sep">, </span><a href="./viewtopic.php?f=9&amp;t=15633&amp;start=45">4</a><span class="page-sep">, </span><a href="./viewtopic.php?f=9&amp;t=15633&amp;start=60">5</a><span class="page-dots"> ... </span><a href="./viewtopic.php?f=9&amp;t=15633&amp;start=90">7</a> &nbsp;<a href="./viewtopic.php?f=9&amp;t=15633&amp;start=15">Next</a></b></td>
		
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr>
		<td class="cat">
			<table width="100%" cellspacing="0">
			<tr>
				<td class="nav" nowrap="nowrap">&nbsp;
				<a href="./viewtopic.php?f=9&amp;t=15633&amp;view=print" title="Print view">Print view</a>
				</td>
				<td class="nav" align="right" nowrap="nowrap"><a href="./viewtopic.php?f=9&amp;t=15633&amp;view=previous">Previous topic</a> | <a href="./viewtopic.php?f=9&amp;t=15633&amp;view=next">Next topic</a>&nbsp;</td>
			</tr>
			</table>
		</td>
	</tr>

	</table>


	<table class="tablebg" width="100%" cellspacing="1">
	
		<tr>
			<th>Author</th>
			<th>Message</th>
		</tr>
	<tr class="row1">

			<td align="center" valign="middle">
				<a name="p190805"></a>
				<b class="postauthor">infiniteneslives</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p190805">Adding features to discrete mapper with multipurposed CIC</a></div><div style="float: right;"><a href="./viewtopic.php?p=190805#p190805"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Thu Mar 09, 2017 6:16 pm&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				<tr>
					<td><img src="./download/file.php?avatar=4832_1403414291.jpg" width="100" height="52" alt="User avatar" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Mon Apr 04, 2011 11:49 am<br /><b>Posts:</b> 2082<br /><b>Location:</b> WhereverIparkIt, USA
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">Starting a more in depth conversation about an idea I recently shared in discussion on methods for <a href="http://forums.nesdev.com/viewtopic.php?f=21&amp;t=15630#p190791" class="postlink">parallax techniques</a>.<br /><br />So the CIC is the 'necessary evil' of a ~50cent chip that must be included on any game seeking to be published in 72pin form.  The current popular choice is the attiny13, selected by both Jim's cool and Krikzz.  They utilize the 4Mhz CIC clock as the mcu's clock source and instruction cycle counting to ensure proper timing of communications with the main board CIC lock.  The selection of the attiny13 is a rather easy choice to target for a CIC solution.  It effectively the lowest cost microchip (AVR/PIC) solution that has adaquate i/o and nvm to store the current region.<br /><br />For several different NES/SNES projects I've been considering an alternate CIC solution that might allow the 50cent budget of the CIC to go towards a more powerful chip that would be capable of being dual tasked with CIC comms and some sort of mapper interfacing.  The attiny13 doesn't really have the io nor time to spare for dual tasking.  <br /><br />Looking over Krikzz's implemenation after the first few cycles where the current stream is determined, the main loop spins for 260+ cycles (65 usec) between each Din/Dout transaction.  I took some quick logic analyzer captures to confirm there is ~75usec between each transaction.  So the attiny13 operating at 4Mhz is only spending ~15% of it's time processing CIC communications.  With not other mcu timers available and nothing better to do with it's time the attiny13 has no choice other than cycle counting.  Trying to make use of the 2 remaining i/o, during that under utilized time would be rather challenging with exact cycle counting and not options for interrupts etc.<br /><br />So I started entertaining the idea of other chips available on the market.  For this purpose I discounted all other microchip offerings as they will be more expensive than the attiny13.  With those options discounted, and only the requirement of 5v supply and NVM/eeprom available there are a couple interesting options.  <br /><br />Cypress's CY8C4013SXI-400 is an interesting option with it's 16Mhz cortex M0, but only has 5io.  I'm tempted to target it considering it's cheaper than the attiny13 in volume, but the lack of spare i/o significantly limits what's possible.  The <a href="https://dmitry.gr/index.php?r=05.Projects&amp;proj=23.%20PSoC4" class="postlink">recent SROM cracking</a> that might double the flash for free is an interesting bonus however..<br /><br />The two most interesting prospects I found were STM offerings.  The STM32F030F4 with it's 48Mhz cortex M0 was quoted to me with better pricing than the attiny13.  Even though it's a 3v part, it has enough 5v tolerant i/o to get the CIC job done.  This is a nice option for a cartridge with 3v mapper logic.  And the 48Mhz M0 certainly has enough power to have only a small portion of it's time consumed by CIC communications.  I'm still kind of interested in tasking one of the STM32F0 family parts with both CIC and mapper tasks.  But for the purpose of this conversation, it's not a viable solution due to too few 5v tolerant io.<br /><br />That brings me to what I've deemed the 'winner' of the STM8S003F4 <a href="http://www.st.com/content/ccc/resource/technical/document/datasheet/42/5a/27/87/ac/5a/44/88/DM00024550.pdf/files/DM00024550.pdf/jcr:content/translations/en.DM00024550.pdf" class="postlink">datasheet here</a><br />It's a rather basic 8 bit mcu with common features including:<br /><ul><li>16Mhz &amp; 128Khz internal RC oscillators</li><li>8KByte flash, 1Kbyte SRAM, 128Byte eeprom</li><li>Nested vector interupt controller including external interrupts</li><li>2x 16bit adv/gen purp counters, 1x 8bit basic counter</li><li>16x GPIO</li><li>UART, SPI, I2C interfaces</li></ul><br />This all comes at a significant price drop compared to the attiny13 in volume.  The price alone is enough to motivate me to create my own CIC implementation using the STM8.  But there's a considerable amount of extra hardware getting left unused if only tasked to be a CIC.  If only being tasked as a CIC the easilest solution would probably be to clock the mcu externally by the 4Mhz CIC clock.  Then implement the CIC in much the same method that the attiny13 did.  But that's not much fun, and I think I can do better than that.  <br /><br />My goal is to run at 16Mhz and use one of the timers to interrupt the mcu every ~75usec to handle the next CIC transaction.  Doing that means the CIC CLK signal is pretty useless.  But one would have to take care to keep aligned with the CIC's clock.  The interrupt would have to come early and maybe poll the Din pin when it's expected to be high to sense how far the mcu has drifted and correct it's internal timer.  I'm expecting that worst case 15usec out of every 75usec will be utilized for CIC transfers.  That's more time than Krikzz is utilizing with the attiny13, and we're running 4x faster.  Maybe this solution could get to 5usec or less, either way it doesn't matter too much, it's still some portion of time the mcu MUST prioritize CIC transfers.<br /><br />Now comes the question of if this extra hardware is going to be utilized by the NES somehow, the CPU has to have a means to interface with the mcu.  This is not a simple feat with the expectation of being free.  I argued to myself that all the hoops that would need to be jumped through would make disinterest one to the point where you'd want to simply invest a couple dollars on a mapper more capable than a discrete mapper.<br /><br />Here's the pinout and port numbering with some preliminary assignments I've came up with:<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; _________________&nbsp; _______________<br />NES CPU D3&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -| PD4/UART_CLK&nbsp; &nbsp; \/&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;PD3 |-&nbsp; &nbsp;CPU D2<br />NES CPU D4/UART TX&nbsp; &nbsp; &nbsp; -| PD5/UART_TX&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PD2 |-&nbsp; &nbsp;CPU D1<br />NES CPU D5/UART RX&nbsp; &nbsp; &nbsp; -| PD6/UART_RX&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ISP/PD1 |-&nbsp; &nbsp;CPU D0<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -| /RST&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MISO/PC7 |-&nbsp; &nbsp; SPI?<br />MAPPER REG BIT&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -| PA1/OSCIN&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;MOSI/PC6 |-&nbsp; &nbsp; SPI?<br />CIC Din&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-| PA2/OSCOUT&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;SCK/PC5 |-&nbsp; &nbsp; SPI?<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -| VSS&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PC4 |-&nbsp; &nbsp;NES /IRQ<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -| Vcap&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;PC3 |-&nbsp; CIC Dout?<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -| VDD&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; SCL/PB4 |-&nbsp; &nbsp;NES CPU R/W<br />SPI? CICrst?&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -| PA3/SPI_NSS&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; SDA/PB5 |-&nbsp; &nbsp;NES A13<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ---------------------------------<br /></div><br /><br />The simplest method I could come up with would be to designate an unused mapper register bit to have the NES signal/interupt the mcu that it wants it's attention to start communicating to it.  However this mcu interrupt must have a lower priority than CIC comms.  Assuming a '377 is being used for the mapper reg we probably have an unused bit, even a BNROM utilizing a '161 has a unused bit if the PRG-ROM is &lt;= 256KByte.<br /><br />When the mapper bit is set (presumably $8000.7) the mcu would be instructed to start listening to CPU writes when CPU A13 is high.  This maps mcu's register to $6000-7FFF, but also maps/overlaps the PPU $2000-3FFF.  This was the fewest number of pins I could come up with for decoding that seems reasonable.   Moving the mcu reg bits to SPI's PC bits would give more bits for decoding and potentially decoding CPU A14 perhaps.  But A13 seems sufficient as it blocks writes to RAM and the APU which seems helpful to me.  The user would have to take care to not accidentally write to the PPU and mcu at the same time, but one should already be very deliberate when writing to the PPU.<br /><br />My proposed pin assignments would allow for 4bit nibble wide read/writes at a minimum.  If one wasn't looking to utilize the UART then the entirety of PORT D could be used for 6bit wide accesses.<br /><br />There is a problem though as we can't be certain the mcu is always able to listen to writes to $6000.  The mcu could be currently interrupted by CIC comms which must have a higher priority.  I can't think of a very clean way to get around this without adding dedicated logic.  Maybe the simplest idea is to have the NES set the mcu interrupt bit $8000.7, then the mcu waits for upcoming CIC comm to complete.  Once done, it interupts the NES CPU which uses it's interrupt routine to complete the transfer.  The NES would have the maximum time (~60usec) to complete the transfer.  This is probably a preferred solution if the NES CPU is looking to make big transfers to the mcu.  Maybe a big transfer would be verified by reading back a checksum.<br /><br />Another idea might be to write to $6000, but require the value to be read back from the mcu before being certain it stuck.  This would probably be a preferred solution for small transfers as we typically have &gt;80% chance the mcu is listening.<br /><br />You could maybe combine the two ideas to remove the need to use NES /IRQs for each transfer.  Maybe the NES can simply read from the mcu at $6000 after setting the $8000.7 mcu interupt bit.  And the mcu provides a designated value if there is sufficent time to write a nibble or two before the next CIC xfr.  <br /><br />Anyway, that's my idea and here's the place to toss out any other probably better ideas you guys might have.  My primary goal for such an interface is that it's effectively free being able to be implemented with wires alone.  It's not out of the question to add logic gates to implement the idea, but personally I'm not interested in doing so.  Start adding a gate here or there and it's no longer free.  I'm not even sure I have the pcb space currently to support routing the signals I've proposed.  I'll probably have to re-route a large portion of my current design to make room for the CIC to be placed closer to the PRG side of the board.<br /><br />As far as ideas of what could be done with utilization of something like this it's up to the imagination.  The mcu probably isn't going to be fast enough to implement any sort of CHR effects like finer backswitching or anything.  Even permitting selectable NT mirroring is sorta out of the question as you'd need to add more logic.<br /><br />As mentioned in my other post, unfortunately this mcu doesn't have any external pins available to clock the internal counters.  So you'd have to utilize the internal 16Mhz/128Khz oscillators for an IRQ timer.  The SPI bus is open on my pinout proposal above, and things could be shifted around to make the I2C bus available instead.  This potentially be connected to a large serial flash rom for lots of rom storage.  But it's not going to be as fast as one might like due to the limitations put on transfers.  One of the pins could be routed to EXP6 to implement some basic expansion sound perhaps.  You could even get crazy and utilize the UART interface to connect a cheapo BT/WiFi module, but if you're interested in that doesn't make much sense to restrict your budget to a discrete mapper..<br /><br />Anyway, my guess is chances are this idea won't go anywhere, but it's fun to talk about.   At this point I can say I'm going to do everything I can to migrate to the STM8 for my NES/SNES CIC solutions for the benefit of my other designs.  So from that point the hardware will be sitting idle waiting to be put to good use. <img src="./images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>

					
						<div class="postbody"><br />_________________<br />If you're gonna play the Game Boy, you gotta learn to play it right.  -Kenny Rogers</div>
					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=4832"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row2">

			<td align="center" valign="middle">
				<a name="p190887"></a>
				<b class="postauthor">Dwedit</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p190887">Re: Adding features to discrete mapper with multipurposed CI</a></div><div style="float: right;"><a href="./viewtopic.php?p=190887#p190887"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Sat Mar 11, 2017 7:40 am&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				<tr>
					<td><img src="./download/file.php?avatar=53.png" width="68" height="100" alt="User avatar" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Fri Nov 19, 2004 7:35 pm<br /><b>Posts:</b> 4066
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">Heh, once you have a 16MHz Thumb processor, why even bother making a NES game at all.  You can run the game logic on the coprocessor instead.</div>

					
						<div class="postbody"><br />_________________<br />Here come the fortune cookies!  Here come the fortune cookies!  They're wearing paper hats!</div>
					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=53"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row1">

			<td align="center" valign="middle">
				<a name="p190896"></a>
				<b class="postauthor" style="color: #FF3300">tepples</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p190896">Re: Adding features to discrete mapper with multipurposed CI</a></div><div style="float: right;"><a href="./viewtopic.php?p=190896#p190896"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Sat Mar 11, 2017 10:28 am&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Sun Sep 19, 2004 11:12 pm<br /><b>Posts:</b> 20409<br /><b>Location:</b> NE Indiana, USA (NTSC)
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">Except in this case, the problem with going the <a href="http://superfamicom.org/info/hayazashi-nidan-morita-shougi-2" class="postlink"><em>Hayazashi Nidan Morita Shogi 2</em></a> route of putting game logic on an ARM coprocessor is that everything has to be timed to ensure the CIC key logic executes at the appropriate time.</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=9"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row2">

			<td align="center" valign="middle">
				<a name="p190913"></a>
				<b class="postauthor">calima</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p190913">Re: Adding features to discrete mapper with multipurposed CI</a></div><div style="float: right;"><a href="./viewtopic.php?p=190913#p190913"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Sat Mar 11, 2017 11:42 am&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Tue Oct 06, 2015 10:16 am<br /><b>Posts:</b> 778
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">Does the CIC keep asking at runtime? Wikipedia makes it sound like it only checks at startup.</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=7237"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row1">

			<td align="center" valign="middle">
				<a name="p190918"></a>
				<b class="postauthor" style="color: #FF3300">tepples</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p190918">Re: Adding features to discrete mapper with multipurposed CI</a></div><div style="float: right;"><a href="./viewtopic.php?p=190918#p190918"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Sat Mar 11, 2017 12:09 pm&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Sun Sep 19, 2004 11:12 pm<br /><b>Posts:</b> 20409<br /><b>Location:</b> NE Indiana, USA (NTSC)
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody"><div class="quotetitle">calima wrote:</div><div class="quotecontent">Does the CIC keep asking at runtime?</div><br />Put a licensed Game Pak in a stock NES-001 Control Deck, turn it on, and pull out the Game Pak. The game will freeze. If the power light also starts blinking, this means the lock chip requires the key chip to continue to communicate. I just tried it with <em>Bionic Commando</em>, and yes, it starts blinking. That's why you need to perform the pin 4 modification to use TapeDump on a front-loader.<br /><br /><div class="quotetitle">calima wrote:</div><div class="quotecontent">Wikipedia makes it sound like it only checks at startup.</div><br />A charge pump-driven stunner may need to run only during the opening copyright screen, but a proper clone needs to communicate continuously.</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=9"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row2">

			<td align="center" valign="middle">
				<a name="p190920"></a>
				<b class="postauthor">lidnariq</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p190920">Re: Adding features to discrete mapper with multipurposed CI</a></div><div style="float: right;"><a href="./viewtopic.php?p=190920#p190920"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Sat Mar 11, 2017 12:16 pm&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Sun Apr 13, 2008 11:12 am<br /><b>Posts:</b> 7391<br /><b>Location:</b> Seattle
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">The NES CIC exchanges another bit of the 2^160 period random number generator output approximately every second. The lock will immediately start the reboot loop on the NES if it fails.</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=3512"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row1">

			<td align="center" valign="middle">
				<a name="p190921"></a>
				<b class="postauthor">rainwarrior</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p190921">Re: Adding features to discrete mapper with multipurposed CI</a></div><div style="float: right;"><a href="./viewtopic.php?p=190921#p190921"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Sat Mar 11, 2017 12:27 pm&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				<tr>
					<td><img src="./download/file.php?avatar=5165_1471663472.jpg" width="100" height="100" alt="User avatar" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Sun Jan 22, 2012 12:03 pm<br /><b>Posts:</b> 6592<br /><b>Location:</b> Canada
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody"><div class="quotetitle">tepples wrote:</div><div class="quotecontent">A charge pump-driven stunner may need to run only during the opening copyright screen, but a proper clone needs to communicate continuously.</div><br />Does the stunner approach actually halt/crash the internal CIC until the next reset or something?</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=5165"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row2">

			<td align="center" valign="middle">
				<a name="p190978"></a>
				<b class="postauthor">infiniteneslives</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p190978">Re: Adding features to discrete mapper with multipurposed CI</a></div><div style="float: right;"><a href="./viewtopic.php?p=190978#p190978"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Sat Mar 11, 2017 7:58 pm&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				<tr>
					<td><img src="./download/file.php?avatar=4832_1403414291.jpg" width="100" height="52" alt="User avatar" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Mon Apr 04, 2011 11:49 am<br /><b>Posts:</b> 2082<br /><b>Location:</b> WhereverIparkIt, USA
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody"><div class="quotetitle">lidnariq wrote:</div><div class="quotecontent">The NES CIC exchanges another bit of the 2^160 period random number generator output approximately every second. The lock will immediately start the reboot loop on the NES if it fails.</div><br /><br />The lock and key exchange the next bit approximately every 75usec.  If the key doesn't produce the proper value, the lock panics and stops paying attention to the key.  Once it panics it sits in a loop resetting the console every other second.<br /><br />The actual time between exchanged bits of the pseudorandom number actually depends on the precise current value of the currently calculated/&quot;mangled&quot; number.  But the lock and key are operating through the &quot;mangle&quot; calculations in lock step.  So each takes the same exact amount of time to perform the calculation of the next bit.<br /><br />Been digging through segher's disassembly to get a better understanding of how the lock behaves exactly and understand what it's expecting from the key.  Good news is from what I can tell the lock doesn't pay any attention to the key's output aside from the precise moment every ~75usec.  So I'm thinking this could be abused to alleviate the problems with the CIC mcu needing to prioritize CIC comms over everything else.  Appears one could simply output the next stream value early.  Appears the key could just toggle the Dout line to whatever the upcoming value is instead of providing a precisely timed 750nsec pulse of the current bit as the original does.<br /><br />That means this implementation can give the NES CPU priority so long as the NES isn't steaming data for longer than ~50usec.<br /><br />Additionally I confirmed what I was seeing on the scope with the code.  The lock sets its output high for 8 cycles after resetting the key.  So I'm thinking this could be used to sense reset instead of the CIC reset pin.  So with a little effort there can minimize down to the mcu only needing 2 io for CIC comms.<br /><br /><div class="quotetitle">Dwedit wrote:</div><div class="quotecontent">Heh, once you have a 16MHz Thumb processor, why even bother making a NES game at all.  You can run the game logic on the coprocessor instead.</div><br />The biggest problem for running game logic on a low cost ARM coprocessor is providing a enough rom for the mcu, and a adequate interface between the mcu and PPU.</div>

					
						<div class="postbody"><br />_________________<br />If you're gonna play the Game Boy, you gotta learn to play it right.  -Kenny Rogers</div>
					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=4832"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row1">

			<td align="center" valign="middle">
				<a name="p191139"></a>
				<b class="postauthor">elseyf</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p191139">Re: Adding features to discrete mapper with multipurposed CI</a></div><div style="float: right;"><a href="./viewtopic.php?p=191139#p191139"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Tue Mar 14, 2017 2:25 am&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				<tr>
					<td><img src="./download/file.php?avatar=5776_1530215141.png" width="100" height="90" alt="User avatar" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Sat Dec 01, 2012 4:10 am<br /><b>Posts:</b> 67
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">This sounds interestening. Is the CIC Firmware going to be open source, and if so, is it supplied in a manner that it could be easily worked into a custom program running on the mcu?<br />I see this as a free means to do some basic DRM protection for a new homebrew game, the mcu could interface some additional extertal memory (namely spi Flash) which contains encrypted data, and would decode it when requested (in this case the mcu is kind of a blackbox). Best would be to encrypt program data and only supply to the NES the code which is currently needed, but this is then left to decide by the programmer. The interface could use the NES IRQ Signal to halt the NES from transferring data when the mcu is supposed to act as a CIC, this allow at least for a seamless interface.</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=5776"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row2">

			<td align="center" valign="middle">
				<a name="p191226"></a>
				<b class="postauthor">lidnariq</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p191226">Re: Adding features to discrete mapper with multipurposed CI</a></div><div style="float: right;"><a href="./viewtopic.php?p=191226#p191226"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Wed Mar 15, 2017 11:05 am&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Sun Apr 13, 2008 11:12 am<br /><b>Posts:</b> 7391<br /><b>Location:</b> Seattle
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">I find discussions about DRM to be somewhere between &quot;boring&quot; and &quot;annoying&quot;. Regardless, the biggest problem is that because necessarily no emulator already supports whatever scheme you'd want to add, and because the NES is so limited, any DRM you add stands a very good chance of breaking any existing timing-sensitive code (and you'll be surprised at how much NES code becomes timing sensitive...) so then you need to reimplement the DRM scheme in your own in-house debugging emulator fork.<br /><br /><br />Now, the part I actually find interesting:<br /><br />I spending a little time thinking about this, and I believe a modern PIC with some Configurable Logic Cells (and maybe the Peripheral Pin Select) could actually subsume all of this, adding GNROM banking, mirroring control, and an IRQ. The down sides are a serial interface to programming the mapper, and not being able to write to Flash....<br /><br />A CLC would let us detect writes (/ROMSEL OR R/W); the PPS lets us forward that to the SPI module clock input (or else use an external pin). The CPU is responsible for taking the received bytes and relaying them to the various pins (â‰ˆGNROM), configuring another CLC (mirroring control), and the timer (IRQ).<br /><br />Meanwhile, another CLC and a timer clocked by the CIC clock lets us actually use the timer hardware to copy the already-calculated CIC output stream at exactly the right moment. The CPU's involvement is minimal, leaving more than enough time for ... whatever's left.</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=3512"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row1">

			<td align="center" valign="middle">
				<a name="p191230"></a>
				<b class="postauthor" style="color: #FF3300">tepples</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p191230">Re: Adding features to discrete mapper with multipurposed CI</a></div><div style="float: right;"><a href="./viewtopic.php?p=191230#p191230"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Wed Mar 15, 2017 12:02 pm&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Sun Sep 19, 2004 11:12 pm<br /><b>Posts:</b> 20409<br /><b>Location:</b> NE Indiana, USA (NTSC)
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody"><div class="quotetitle">lidnariq wrote:</div><div class="quotecontent">I spending a little time thinking about this, and I believe a modern PIC with some Configurable Logic Cells (and maybe the Peripheral Pin Select) could actually subsume all of this, adding GNROM banking, mirroring control, and an IRQ. The down sides are a serial interface to programming the mapper</div><br />Could the serial interface be made compatible with a subset of the MMC1?</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=9"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row2">

			<td align="center" valign="middle">
				<a name="p191233"></a>
				<b class="postauthor">lidnariq</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p191233">Re: Adding features to discrete mapper with multipurposed CI</a></div><div style="float: right;"><a href="./viewtopic.php?p=191233#p191233"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Wed Mar 15, 2017 12:38 pm&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Sun Apr 13, 2008 11:12 am<br /><b>Posts:</b> 7391<br /><b>Location:</b> Seattle
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">The PIC's serial ports (MSSP/EUSART) really want to deserialize writes 8 (or 9) bits at a time, so I think that counts as &quot;possible but not trivially so&quot;.<br /><br />All of the PICs with three or four CLCs only have four CLC pin inputs, and to emulate an MMC1 we really need to pay attention to five pins: A14, A13, D0, /ROMSEL, &amp; R/W. But I think we could probably actually get that by cleverly using the timer 1 gate function. Don't get IRQs if it's an MMC1 subset, though, and there's no good reason to be compatible with the MMC1 if one does add IRQs.<br /><br />It probably mostly depends on whether the hardware can manage all of the CIC timing without the CPU involvement, and the CPU &quot;just&quot; needs to calculate the next bit and next time.</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=3512"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row1">

			<td align="center" valign="middle">
				<a name="p191768"></a>
				<b class="postauthor">infiniteneslives</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p191768">Re: Adding features to discrete mapper with multipurposed CI</a></div><div style="float: right;"><a href="./viewtopic.php?p=191768#p191768"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Thu Mar 23, 2017 8:40 pm&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				<tr>
					<td><img src="./download/file.php?avatar=4832_1403414291.jpg" width="100" height="52" alt="User avatar" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Mon Apr 04, 2011 11:49 am<br /><b>Posts:</b> 2082<br /><b>Location:</b> WhereverIparkIt, USA
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody"><div class="quotetitle">elseyf wrote:</div><div class="quotecontent"> Is the CIC Firmware going to be open source, and if so, is it supplied in a manner that it could be easily worked into a custom program running on the mcu?</div><br />My goal would be to make it available for community use so people could utilize it for whatever they pleased such as your DRM idea if they wanted.  So at a minimum I would provide the source code on request.  Not sure what licensing option I will choose when the time comes to releasing something that's fully functional.  But I'd like it share it with anyone that would put it to good use.<br /><br /><br /><div class="quotetitle">lidnariq wrote:</div><div class="quotecontent">I spending a little time thinking about this, and I believe a modern PIC with some Configurable Logic Cells (and maybe the Peripheral Pin Select) could actually subsume all of this, adding GNROM banking, mirroring control, and an IRQ.</div><br />The configurable logic is an interesting feature that could help out quite a bit.  The biggest deterrent personally is that it isn't 'free' in comparison to the stm8 solution.  Looks like the lowest cost part with a CLC, eeprom, [EDIT: and enough spare i/o] is the attiny814 (appears they're called CCL on avr cores).  The attiny814 is rather generous with 12 i/o, and comparably priced to the attiny13.  It only has one logic cell though, but that's enough to bit bang mapper writes with the benefit dedicated logic.  The attiny814 does have a little speed boost with 20Mhz internal osc compared to stm8s003's 16Mhz.  But if you're running core off of the 4Mhz CIC clock then that's irrelevant.<br /><br />The cheapest offering with 4x CLC's looks to be the 16F15344.  In 3k volume, microchip's claiming 63cent pricing which isn't bad considering one could potentially integrate all the discrete mapper logic chips into the PIC.  But it's going to be hard/impossible to reach that volume without leveraging all of my CIC consumption into a single solution.  Either way this is even further from free in my personal quest.  But it would be a pretty decent solution for someone looking to make a custom dedicated solution.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">It probably mostly depends on whether the hardware can manage all of the CIC timing without the CPU involvement, and the CPU &quot;just&quot; needs to calculate the next bit and next time.</div>  Assuming my analysis of segher's disassembly holds true, my idea of simply outputting the next bit anytime during the 79usec between bit exchanges removes the CPU from time sensitive involvement.<br /><br /><div class="quotetitle">infiniteneslives wrote:</div><div class="quotecontent">Additionally I confirmed what I was seeing on the scope with the code. The lock sets its output high for 8 cycles after resetting the key. So I'm thinking this could be used to sense reset instead of the CIC reset pin. So with a little effort there can minimize down to the mcu only needing 2 io for CIC comms.</div><br />So I no longer see this as viable.  I see in segher's disassembly (@ $007 below) where the lock appears to be setting PORT0.0 (Lock Dout, Key Din) shortly after reset, but before initializing the data stream.  I was operating off of corrupt brain memory when I thought I had seen this in my logic analyzer captures.  Lock Dout never goes high during this time, the first time it goes high after reset is during the stream ID nibble exchange.  <br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;;; LOCK START<br />05f: 75&nbsp; &nbsp; &nbsp; lbmi 1&nbsp; &nbsp;; H := 1<br /><br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;; forever {<br />06f: 55&nbsp; &nbsp; &nbsp; in&nbsp; &nbsp;&nbsp; &nbsp;;&nbsp; &nbsp;A := P0<br />077: 66&nbsp; &nbsp; &nbsp; ska 2&nbsp; &nbsp;;&nbsp; &nbsp;if A.2 = 0<br />07b: f3&nbsp; &nbsp; &nbsp; t 073&nbsp; &nbsp;;&nbsp; &nbsp;&nbsp; &nbsp;last<br />07d: 21&nbsp; &nbsp; &nbsp; lbli 1<br />03e: 31&nbsp; &nbsp; &nbsp; ldi 1<br />01f: 70&nbsp; &nbsp; &nbsp; ad<br />04f: 43&nbsp; &nbsp; &nbsp; xd&nbsp; &nbsp;&nbsp; &nbsp;;&nbsp; &nbsp;&#91;1:1&#93;++<br />067: ef&nbsp; &nbsp; &nbsp; t 06f&nbsp; &nbsp;; }<br /><br />073: 30&nbsp; &nbsp; &nbsp; ldi 0<br />079: 20&nbsp; &nbsp; &nbsp; lbli 0<br />03c: 4a&nbsp; &nbsp; &nbsp; s&nbsp; &nbsp;&nbsp; &nbsp;; &#91;1:0&#93; := 0<br />05e: 32&nbsp; &nbsp; &nbsp; ldi 2<br />02f: 21&nbsp; &nbsp; &nbsp; lbli 1<br />057: 46&nbsp; &nbsp; &nbsp; out&nbsp; &nbsp;; P1 := 2&nbsp; &nbsp;// reset host and key<br />06b: 00&nbsp; &nbsp; &nbsp; nop<br />075: 30&nbsp; &nbsp; &nbsp; ldi 0<br />03a: 46&nbsp; &nbsp; &nbsp; out&nbsp; &nbsp;; P1 := 0&nbsp; &nbsp;// run key<br />01d: 20&nbsp; &nbsp; &nbsp; lbli 0&nbsp; &nbsp;; L := 0<br />00e: 31&nbsp; &nbsp; &nbsp; ldi 1<br />007: 46&nbsp; &nbsp; &nbsp; out&nbsp; &nbsp;; P0 = 1&nbsp; &nbsp;// *** SHOULD BE SETTING LOCK Dout high (Key Din)<br />043: 3e&nbsp; &nbsp; &nbsp; ldi e&nbsp; &nbsp;; A := e<br /><br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;; while A &lt;&gt; 0 {<br />061: 01&nbsp; &nbsp; &nbsp; adi 1&nbsp; &nbsp;;&nbsp; &nbsp;A++<br />030: e1&nbsp; &nbsp; &nbsp; t 061&nbsp; &nbsp;; }<br />058: 00&nbsp; &nbsp; &nbsp; nop<br />06c: ae&nbsp; &nbsp; &nbsp; t 02e&nbsp; &nbsp;; goto 02e<br /><br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;;; KEY START<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;; (L = 0, A = P0)<br />076: 65&nbsp; &nbsp; &nbsp; ska 1&nbsp; &nbsp;; if A.1 = 0&nbsp; &nbsp;// if not test mode<br />03b: 8c&nbsp; &nbsp; &nbsp; t 00c&nbsp; &nbsp;;&nbsp; &nbsp;goto 00c<br />05d: 00&nbsp; &nbsp; &nbsp; nop<br /><br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;;; INIT LOCK, OR KEY IN TEST MODE<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;; (L = 0)<br />02e: 47&nbsp; &nbsp; &nbsp; out0&nbsp; &nbsp;; P0 := 0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; //&nbsp; *** Here it appears to clear PORT.0 which looks to be set @007<br />017: 7d 00&nbsp; &nbsp;tml 200&nbsp; &nbsp;; call 200&nbsp; &nbsp;// init stream<br />065: 7d a0&nbsp; &nbsp;tml 320&nbsp; &nbsp;; call 320&nbsp; &nbsp;// magic<br />019: d1&nbsp; &nbsp; &nbsp; t 051&nbsp; &nbsp;; goto 051</div><br /><br />What I had seen in the analyzer captures was Din and Dout being held high prior to the reset signal.  I had assumed that the Lock was setting it's Dout prior to resetting the key, but it's actually the key setting both Din and Dout prior to being reset as it ends up in panic/die on initial boot prior to being reset by the lock.  I removed the key from the circuit completely and confirmed the Lock was holding Din &amp; Dout low prior to resetting the Key.  So it appears the CIC's Din/Dout pins are unidirectional.<br /><br />Does anyone know or have a good guess as to what type of drivers are on these PORT pins?  I had assumed they were unidirectional push-pull.  But this apparently isn't the case.  The lock and key both clear their PORT0.1 &quot;data input&quot; pins during normal transactions.  And when they set their PORT0.0 pin, the logic 1 beats out the other chip's logic 0.  So my guess is outputting a logic 0 is effectively a pull-down, and outputting logic 1 is pushed sourcing current to override the other chip's logic 0 pull-down.  <br /><br />This makes sense when considering PORT0.2 for the lock's seed capacitor.  The lock will set the seed pin whenever it sets it's data out pin during transactions, and then read the seed pin if it ends up getting reset.  So I guess it's aiding in getting a random seed on a warm reset utilizing bidirectionality on the PORT0.2 pin.<br /><br />So CIC reset appears to be a vital input.  I thought other ways to get around requiring the CIC reset signal, but there's no way to log data in and determine proper timing in adequate time as the key must output it's interpretation of the stream ID being even/odd as the first bit transaction post stream ID transfer.  You could figure it out in time if there were always at least two bits set in the stream ID, but that obviously won't work..  [EDIT: too bad the CIC reset signal is active high otherwise could just route it to NRESET on stm8, guess one could still do this to save an i/o but you'd need to add an inverter.]<br /><br />Anyway, I've got a firm enough grasp on the mangle algorithm and timing of everything so I'm going to start working on my own implementation targeting the stm8s003.  I'll start by taking the easy way out and clocking the mcu core with the 4Mhz CIC clock and ensure timing by cycle counting.<br /><br />One thing I didn't realize until working through segher's disassembly and looking over my analyzer captures is that the CIC cpu core is actually running at 1Mhz.  Appears to be 4 clock cycles per machine cycle.  I haven't seen this mentioned anywhere else in all my research.  Although I should have gathered this when peeking at Krikzz's solution, but I didn't have a good enough grasp on all the timing at that time.  My discussion below uses usec and cycles interchangeably.<br /><br /><br /><strong><span style="text-decoration: underline">The Skinny on CIC transactions and timing</span></strong><br />I'll share my little breakdown of the timing and transactions for anyone curious.  thefox's tengen translated to C is the best high level reference, but it took awhile looking at segher's disassembly before I could fully understand what's happening and wrap my head around the timing of everything.<br /><br />Negative time: Lock determines 4bit seed value &quot;steam ID&quot; 0-15 prior to resetting key<br />Time 0 usec:  Lock resets Key<br />Time 33 usec: Lock outputs bit3 of stream ID<br />Time 48 usec: Lock outputs bit0 of stream ID<br />Time 63 usec: Lock outputs bit1 of stream ID<br />Time 78 usec: Lock outputs bit2 of stream ID<br />-This 4bit stream ID becomes the first nibble of the key's table nibble 1.<br /><br />Time 201usec:<br /><strong>main loop starts:</strong>  first task is to transfer 1-15 bits of current table's least significant bits, final task is to perform mangle on tables, repeat..<br /><br />First transaction is always transfers all 15bits, subsequent transactions are 1-15 bits and determined by nibble 7's value on re-entry of main loop.<br />&quot;effective main loop time 0&quot;: lock and key transfer their table's least significant bit of nibble 1.<br />-Check what the other chip sent and confirm it matched expected value<br /><br />Every 79 cycles the next LSbit of ram is transferred and checked, if doesn't match expected value die/panic.<br /><br />Once all bits are transferred perform mangle of both the chip's own ram table, and the table it's calculating for the other chip to know what to expect.<br />-Number of mangles to be performed on the table is based on nibble 15 on entry of mangle calculation plus 1.  So each table will get mangled 1-15 times.<br />-The time it takes to perform a table mangle calculation is either 78 or 84 cycles/usec depending on if the sum of nibble 2 + nibble 3 + 1 is &gt; 16 or not on entry of mangle calculation.<br />-Each table also takes another 29 cycles/usec to process separate from the mangle calc loop. 2 tables = 58 cycles/usec.<br /><br />The mangle calculation time varies based on ram values on entry.  The theoretic minimum would be if both tables only performed one mangle calc @ 78usec + 29usec for table = 107usec * 2 tables = 214 usec.  I would estimate the average mangle calculation time to be ~80usec * 15 + 58 = ~1250usec.<br /><br />Now that the new value of each table is calculated the main loop restarts.<br /><br /><br /><strong><span style="text-decoration: underline">My thoughts out loud:</span></strong><br />What follows is a bit of me thinking out loud on this whole idea of multitasking the CIC.  So at least my idea is publicly documented so someone else can seek this out further if they'd like to in the event I don't end up doing so myself..  So in a solution where the CIC is being multitasked, and we're allowed to output the next bit early instead of a precise 3usec pulse, this is my general plan after initialization and first transaction is complete:<br /><br />1) Set a timer for mangle calculation time.  We can quickly determine how many mangles will be performed by looking at nibble 15 of each table.  We just don't know how long each mangle will take without performing each iteration of calculations.  Each mangle will be 78 or 84 usec, so let's assume all calcs take the min 78usec and set our timer based on that, plus the 2x 29cycle table time.<br /><br />2) Perform the mangle calculations on both tables tallying up each calc that was 84 cycles instead of 78.  Once all mangles are done, increment the timer by 6cycles times our tally.  Now we'll get an interrupt from the timer when it's the right time to start transacting data.  <br /><br />3) We can now work ahead a little to try and make the transactions easier/faster.  Perhaps it would be helpful to transfer the upcoming data transaction into a temporary condensed location separate from the lock/key tables' LSbits.  This would also allow us to perform the mangle calculations for the next iteration early.  This improves upon my thought above as we could figure out the mangle time and perform all the mangle calculations one iteration in advance.<br /><br />4) Perform next transaction getting interrupt every 79cycles to output the next bit in the stream.  Once transaction is complete load counter with predetermined mangle calculation time which we've already calculated in advance from the step prior. Go back to step 2 and repeat forever...<br /><br />The above is time referenced for the time that the lock will latch the key's bit.  However we want to give ourselves some slack time.  Since we can output the next bit early, it's better for to reference our time 'zero' to 79usec *before* the lock latches the key's bit.  So we need a 79usec timer to interrupt us just *after* the lock has retrieved it's data.  So long as the timer automatically reloads and is setup to interrupt us again exactly 79 cycles later, we don't need this &quot;CIC transaction timer&quot; interrupt to have the highest priority.  The idea is for the timer to simply be keeping time for us.  The NES CPU can have higher interrupt priority than the CIC, so long as the NES CPU doesn't take more than ~77usec of our time in one burst.<br /><br />Well that's enough rambling for now...  Time to start writing some code!</div>

					
						<div class="postbody"><br />_________________<br />If you're gonna play the Game Boy, you gotta learn to play it right.  -Kenny Rogers</div>
					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=4832"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row2">

			<td align="center" valign="middle">
				<a name="p191774"></a>
				<b class="postauthor">lidnariq</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p191774">Re: Adding features to discrete mapper with multipurposed CI</a></div><div style="float: right;"><a href="./viewtopic.php?p=191774#p191774"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Thu Mar 23, 2017 10:26 pm&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Sun Apr 13, 2008 11:12 am<br /><b>Posts:</b> 7391<br /><b>Location:</b> Seattle
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody"><div class="quotetitle">infiniteneslives wrote:</div><div class="quotecontent">Does anyone know or have a good guess as to what type of drivers are on these PORT pins?  I had assumed they were unidirectional push-pull.  But this apparently isn't the case.  The lock and key both clear their PORT0.1 &quot;data input&quot; pins during normal transactions.  And when they set their PORT0.0 pin, the logic 1 beats out the other chip's logic 0.  So my guess is outputting a logic 0 is effectively a pull-down, and outputting logic 1 is pushed sourcing current to override the other chip's logic 0 pull-down.<br /></div>I could have sworn that the lock/key were properly crossed over?<br /><br />I just re-tested with a continuity meter and it certainly seems to be the case that pins 1/2 connect to pins 2/1 ...</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=3512"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row1">

			<td align="center" valign="middle">
				<a name="p191778"></a>
				<b class="postauthor">infiniteneslives</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p191778">Re: Adding features to discrete mapper with multipurposed CI</a></div><div style="float: right;"><a href="./viewtopic.php?p=191778#p191778"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Thu Mar 23, 2017 11:14 pm&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				<tr>
					<td><img src="./download/file.php?avatar=4832_1403414291.jpg" width="100" height="52" alt="User avatar" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Mon Apr 04, 2011 11:49 am<br /><b>Posts:</b> 2082<br /><b>Location:</b> WhereverIparkIt, USA
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody"><div class="quotetitle">lidnariq wrote:</div><div class="quotecontent"><div class="quotetitle">infiniteneslives wrote:</div><div class="quotecontent">Does anyone know or have a good guess as to what type of drivers are on these PORT pins?  I had assumed they were unidirectional push-pull.  But this apparently isn't the case.  The lock and key both clear their PORT0.1 &quot;data input&quot; pins during normal transactions.  And when they set their PORT0.0 pin, the logic 1 beats out the other chip's logic 0.  So my guess is outputting a logic 0 is effectively a pull-down, and outputting logic 1 is pushed sourcing current to override the other chip's logic 0 pull-down.<br /></div>I could have sworn that the lock/key were properly crossed over?<br /><br />I just re-tested with a continuity meter and it certainly seems to be the case that pins 1/2 connect to pins 2/1 ...</div><br /><br />Yes of course, I wasn't questioning that.  Sorry not sure what you think I meant, or where I'm not being clear.  <br /><br />My point was that the CIC chip can drive an output logic 1 on both PORT0.0 (data out pin 1) &amp; PORT0.1 (data in pin 2).  And it can read them as inputs as well.  So it seems all (or ones of concern anyway) pins are bidirectional. But there's no sort of direction register as you would find on a modern mcu like a DDR port on an AVR.  The CIC can simply always read the input and set the output.  Each CIC writes a logic 0 to its data input (pin2 PORT0.0), in the same instruction that it's setting logic 0/1 to its data output (PORT0.1 pin1).<br /><br />Since the data in/out are crossed over as you pointed out, it would appear the CIC always outputs a logic 0 on its input pin, and the other CIC is free to &quot;also drive&quot; that same line to a logic 1 without causing conflicts.  Since this doesn't create an issue I'm left to conclude that a logic 0 doesn't actually sink current, and instead is just a pulldown.  Presumably the other chip sources current when driving a logic 1 which overcomes the other chips weak pulldown.  So kinda resembles opposite of open drain, so open source I guess?  Like I2C but inverted..?<br /><br />It just doesn't seem familiar to me, it doesn't appear to be a traditional RTL, TTL, or CMOS driver.  Maybe I'm missing something though. [EDIT: unless RTL with a pulldown instead of a pull-up resistor was common place?]<br /><br />My primary curiousity is some confusion on my part about the I/O drivers might explain why the lock isn't driving its data output pin high as it would seem to be trying to do in the code as I pointed out shortly after it resets the key.  It clearly has no problems driving a logic 1 on that same pin only a few cycles later when transmitting the stream ID.  But I'm also not convinced that segher's disassembly is 100% accurate, it's not like we have a legit data sheet for the sharp mcu.</div>

					
						<div class="postbody"><br />_________________<br />If you're gonna play the Game Boy, you gotta learn to play it right.  -Kenny Rogers</div>
					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=4832"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table width="100%" cellspacing="1" class="tablebg">
	<tr align="center">
		<td class="cat"><form name="viewtopic" method="post" action="./viewtopic.php?f=9&amp;t=15633"><span class="gensmall">Display posts from previous:</span> <select name="st" id="st"><option value="0" selected="selected">All posts</option><option value="1">1 day</option><option value="7">7 days</option><option value="14">2 weeks</option><option value="30">1 month</option><option value="90">3 months</option><option value="180">6 months</option><option value="365">1 year</option></select>&nbsp;<span class="gensmall">Sort by</span> <select name="sk" id="sk"><option value="a">Author</option><option value="t" selected="selected">Post time</option><option value="s">Subject</option></select> <select name="sd" id="sd"><option value="a" selected="selected">Ascending</option><option value="d">Descending</option></select>&nbsp;<input class="btnlite" type="submit" value="Go" name="sort" /></form></td>
	</tr>
	</table>
	

	<table width="100%" cellspacing="1">
	<tr>
		<td align="left" valign="middle" nowrap="nowrap">
		<a href="./posting.php?mode=post&amp;f=9"><img src="./styles/subsilver2/imageset/en/button_topic_new.gif" alt="Post new topic" title="Post new topic" /></a>&nbsp;<a href="./posting.php?mode=reply&amp;f=9&amp;t=15633"><img src="./styles/subsilver2/imageset/en/button_topic_reply.gif" alt="Reply to topic" title="Reply to topic" /></a>
		</td>
		
			<td class="nav" valign="middle" nowrap="nowrap">&nbsp;Page <strong>1</strong> of <strong>7</strong><br /></td>
			<td class="gensmall" nowrap="nowrap">&nbsp;[ 97 posts ]&nbsp;</td>
			<td class="gensmall" width="100%" align="right" nowrap="nowrap"><b><a href="#" onclick="jumpto(); return false;" title="Click to jump to pageâ€¦">Go to page</a> <strong>1</strong><span class="page-sep">, </span><a href="./viewtopic.php?f=9&amp;t=15633&amp;start=15">2</a><span class="page-sep">, </span><a href="./viewtopic.php?f=9&amp;t=15633&amp;start=30">3</a><span class="page-sep">, </span><a href="./viewtopic.php?f=9&amp;t=15633&amp;start=45">4</a><span class="page-sep">, </span><a href="./viewtopic.php?f=9&amp;t=15633&amp;start=60">5</a><span class="page-dots"> ... </span><a href="./viewtopic.php?f=9&amp;t=15633&amp;start=90">7</a> &nbsp;<a href="./viewtopic.php?f=9&amp;t=15633&amp;start=15">Next</a></b></td>
		
	</tr>
	</table>

</div>

<div id="pagefooter"></div>

<br clear="all" />
<table class="tablebg" width="100%" cellspacing="1" cellpadding="0" style="margin-top: 5px;">
	<tr>
		<td class="row1">
			<p class="breadcrumbs"><a href="./index.php">Board index</a> &#187; <a href="./viewforum.php?f=24">NES / Famicom</a> &#187; <a href="./viewforum.php?f=9">NES Hardware and Flash Equipment</a></p>
			<p class="datetime">All times are UTC - 7 hours </p>
		</td>
	</tr>
	</table>
	<br clear="all" />

	<table class="tablebg" width="100%" cellspacing="1">
	<tr>
		<td class="cat"><h4>Who is online</h4></td>
	</tr>
	<tr>
		<td class="row1"><p class="gensmall">Users browsing this forum: <span style="color: #9E8DA7;" class="username-coloured">Google Feedfetcher</span> and 10 guests</p></td>
	</tr>
	</table>


<br clear="all" />

<table width="100%" cellspacing="1">
<tr>
	<td width="40%" valign="top" nowrap="nowrap" align="left"></td>
	<td align="right" valign="top" nowrap="nowrap"><span class="gensmall">You <strong>cannot</strong> post new topics in this forum<br />You <strong>cannot</strong> reply to topics in this forum<br />You <strong>cannot</strong> edit your posts in this forum<br />You <strong>cannot</strong> delete your posts in this forum<br />You <strong>cannot</strong> post attachments in this forum<br /></span></td>
</tr>
</table>

<br clear="all" />

<table width="100%" cellspacing="0">
<tr>
	<td><form method="get" name="search" action="./search.php"><span class="gensmall">Search for:</span> <input class="post" type="text" name="keywords" size="20" /> <input class="btnlite" type="submit" value="Go" /><input type="hidden" name="t" value="15633" />
<input type="hidden" name="sf" value="msgonly" />
</form></td>
	<td align="right">
	<form method="post" name="jumpbox" action="./viewforum.php" onsubmit="if(document.jumpbox.f.value == -1){return false;}">

	<table cellspacing="0" cellpadding="0" border="0">
	<tr>
		<td nowrap="nowrap"><span class="gensmall">Jump to:</span>&nbsp;<select name="f" onchange="if(this.options[this.selectedIndex].value != -1){ document.forms['jumpbox'].submit() }">

		
			<option value="-1">Select a forum</option>
		<option value="-1">------------------</option>
			<option value="24">NES / Famicom</option>
		
			<option value="2">&nbsp; &nbsp;NESdev</option>
		
			<option value="3">&nbsp; &nbsp;NESemdev</option>
		
			<option value="21">&nbsp; &nbsp;NES Graphics</option>
		
			<option value="6">&nbsp; &nbsp;NES Music</option>
		
			<option value="22">&nbsp; &nbsp;Homebrew Projects</option>
		
			<option value="34">&nbsp; &nbsp;&nbsp; &nbsp;2018 NESdev Competition</option>
		
			<option value="33">&nbsp; &nbsp;&nbsp; &nbsp;2017 NESdev Competition</option>
		
			<option value="32">&nbsp; &nbsp;&nbsp; &nbsp;2016 NESdev Competition</option>
		
			<option value="31">&nbsp; &nbsp;&nbsp; &nbsp;2014 NESdev Competition</option>
		
			<option value="30">&nbsp; &nbsp;&nbsp; &nbsp;2011 NESdev Competition</option>
		
			<option value="10">&nbsp; &nbsp;Newbie Help Center</option>
		
			<option value="9" selected="selected">&nbsp; &nbsp;NES Hardware and Flash Equipment</option>
		
			<option value="28">&nbsp; &nbsp;&nbsp; &nbsp;Reproduction</option>
		
			<option value="19">&nbsp; &nbsp;NESdev International</option>
		
			<option value="11">&nbsp; &nbsp;&nbsp; &nbsp;FCdev</option>
		
			<option value="18">&nbsp; &nbsp;&nbsp; &nbsp;NESdev China</option>
		
			<option value="27">&nbsp; &nbsp;&nbsp; &nbsp;NESdev Middle East</option>
		
			<option value="25">Other</option>
		
			<option value="5">&nbsp; &nbsp;General Stuff</option>
		
			<option value="4">&nbsp; &nbsp;Membler Industries</option>
		
			<option value="23">&nbsp; &nbsp;Other Retro Dev</option>
		
			<option value="12">&nbsp; &nbsp;&nbsp; &nbsp;SNESdev</option>
		
			<option value="20">&nbsp; &nbsp;&nbsp; &nbsp;GBDev</option>
		
			<option value="15">&nbsp; &nbsp;Test Forum</option>
		
			<option value="26">Site Issues</option>
		
			<option value="13">&nbsp; &nbsp;phpBB Issues</option>
		
			<option value="14">&nbsp; &nbsp;Web Issues</option>
		
			<option value="16">&nbsp; &nbsp;nesdevWiki</option>
		

		</select>&nbsp;<input class="btnlite" type="submit" value="Go" /></td>
	</tr>
	</table>

	</form>
</td>
</tr>
</table>


</div>


<div id="wrapfooter">
	
	<span class="copyright">Powered by <a href="http://www.phpbb.com/">phpBB</a>&reg; Forum Software &copy; phpBB Group
	</span>
</div>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-61452025-2', 'auto');
  ga('send', 'pageview');

</script>
</body>
</html>