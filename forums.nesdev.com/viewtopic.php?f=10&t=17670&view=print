<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html dir="ltr" lang="en-gb">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta http-equiv="Content-Style-Type" content="text/css">
<meta http-equiv="Content-Language" content="en-gb">
<title>nesdev.com :: View topic - Black screen but debugger shows nametable</title>

<style type="text/css">
<!--

body {
	font-family: Verdana,serif;
	font-size: 10pt;
}

img {
	border: 0;
}

td {
	font-family: Verdana,serif;
	font-size: 10pt;
	line-height: 150%;
}

.code, .codecontent, 
.quote, .quotecontent {
	margin: 0 5px 0 5px;
	padding: 5px;
	font-size: smaller;
	border: black solid 1px;
}

.quotetitle {
	color: black;
	display : block;
	font-weight: bold;
}

.forum {
	font-family: Arial,Helvetica,sans-serif;
	font-weight: bold;
	font-size: 18pt;
}

.topic {
	font-family: Arial,Helvetica,sans-serif;
	font-size: 14pt;
	font-weight: bold;
}

.gensmall {
	font-size: 8pt;
}

hr {
	color: #888;
	height: 3px;
	border-style: solid;
}

hr.sep {
	color: #aaa;
	height: 1px;
	border-style: dashed;
}
//-->
</style>

</head>
<body>

<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
<tr>
	<td colspan="2" align="center"><span class="Forum">nesdev.com</span><br /><span class="gensmall"><a href="http://forums.nesdev.com/">http://forums.nesdev.com/</a></span></td>
</tr>
<tr>
	<td colspan="2"><br /></td>
</tr>
<tr>
	<td><span class="topic">Black screen but debugger shows nametable</span><br /><span class="gensmall"><a href="http://forums.nesdev.com/viewtopic.php?f=10&amp;t=17670">http://forums.nesdev.com/viewtopic.php?f=10&amp;t=17670</a></span></td>
	<td align="right" valign="bottom"><span class="gensmall">Page <strong>1</strong> of <strong>1</strong></span></td>
</tr>
</table>



	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>casprog</b> [ Thu Aug 16, 2018 9:51 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Black screen but debugger shows nametable</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Hi all, <br /><br />so everything was working fine with my project until I decided to use some RAM for a collision map (basically an array to hold a 0 for empty space, 1 for occupied space).<br /><br />After creating the collision map I lose my picture, however the debugger shows my nametable is all there and looks fine on the PPU. <br /><br />First question is, is there a common denominator to help debug through when the screen is black but the nametable looks fine?<br /><br />Second question is, does anything in the code stand out as obvious? By the way, prior to updating the nametable I wait for vblank, turn off rendering, write to the PPU, then try to update my collision map. I wait for vblank again, then turn rendering back on.<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">nt_collision_ptr .rs 2 ; pointer to nametable collision map<br /></div><br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">Reset_nt_collision_ptr:<br />&nbsp; &nbsp;; set collision pointer to page 2 in RAM<br />&nbsp; &nbsp;LDA #$00 ; low byte<br />&nbsp; &nbsp;STA nt_collision_ptr<br />&nbsp; &nbsp;LDA #$01 ; high byte<br />&nbsp; &nbsp;STA nt_collision_ptr + 1<br />&nbsp; &nbsp;;done, $0100<br />&nbsp; &nbsp;RTS<br /></div><br /><br />Full disclosure on this next bit, originally I added the collision update logic in my nametable loader code but this was also giving me a black screen, so to test I broke it out into its own subroutine but I'm getting the same result. And I know this loop will read an extra 64 bytes from the attribute table but I planned on making this work first (I can save the 64 bytes after this works). What is very weird is, if I remove the STA command under the solid_tile label then my picture comes back..<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">Update_collision_map:<br />&nbsp; &nbsp;JSR Reset_nt_collision_ptr<br />&nbsp; &nbsp;<br />&nbsp; &nbsp;LDX #$00<br />&nbsp; &nbsp;LDY #$00<br />update_collision_loop:<br />&nbsp; &nbsp;LDA &#91;nametable_ptr&#93;, y<br />&nbsp; &nbsp;CMP #TILE_CLEAR<br />&nbsp; &nbsp;BNE solid_tile<br />&nbsp; &nbsp;; empty space<br />&nbsp; &nbsp;LDA #$00<br />&nbsp; &nbsp;STA &#91;nt_collision_ptr&#93;, y<br />&nbsp; &nbsp;JMP resume_collision_load<br />solid_tile:<br />&nbsp; &nbsp;LDA #$01<br />&nbsp; &nbsp;STA &#91;nt_collision_ptr&#93;, y<br />resume_collision_load:<br />&nbsp; &nbsp;INY<br />&nbsp; &nbsp;CPY #$00 ; wrap around = 256 tiles <br />&nbsp; &nbsp;BNE update_collision_loop<br />&nbsp; &nbsp;; see if next set needs to be processed<br />&nbsp; &nbsp;INC nt_collision_ptr + 1<br />&nbsp; &nbsp;LDY #$00<br />&nbsp; &nbsp;INX<br />&nbsp; &nbsp;CPX #$04<br />&nbsp; &nbsp;BNE update_collision_loop<br />&nbsp; &nbsp;RTS<br /></div>

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>rainwarrior</b> [ Thu Aug 16, 2018 10:13 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: Black screen but debugger shows nametable</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />If your nametables and palettes are showing up in the debugger, but the screen is black, there are a few possibilities:<br /><br />1. Rendering is not turned back on, maybe the write to $2001 never happened?<br /><br />2. The scroll position is pointing at the second nametable, which might be an empty black page? (When you've finished uploading all 1024 bytes of nametable, the scroll pointer will actually be currently pointed at 0,0 on the subsequent nametable.)<br /><br />For #1, a possible cause is failing to enable the NMI again (via $2000), your NMI handler will never be able to do that write to $2001.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>glutock</b> [ Thu Aug 16, 2018 10:30 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: Black screen but debugger shows nametable</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Be careful when using page $0100 in RAM, that's where the stack lives. Try to use another area like $0300 for example.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>dougeff</b> [ Thu Aug 16, 2018 10:41 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: Black screen but debugger shows nametable</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Unrelated, you could make this loop more efficient.<br /><br />For example<br /><br />LDA #$00<br />STA [nt_collision_ptr], y<br />JMP resume_collision_load<br /><br />Lda #0 sets the zero flag<br />sta changes no flags<br />so we could do...<br />beq resume_collision_load<br />and save a byte.<br /><br />both options do<br />STA [nt_collision_ptr], y<br /><br />so you could throw both after resume_collision_load: and save a few bytes.<br /><br />INY<br />CPY #$00 ; wrap around = 256 tiles <br />BNE update_collision_loop<br /><br />the CPY #0 is redundant.<br />INY sets the zero flag if its result is zero, so all you need is...<br /><br />INY<br />BNE update_collision_loop<br /><br />and you don't need the LDY #0 below that. It's already zero.<br /><br />And lastly, if X isn't doing anything but counting, you could start it at #4 and count down to zero, and remove the CPX.<br /><br />LDX #4<br />loop:<br />...<br />DEX<br />BNE loop<br /><br /><br />So, let's optimize it...<br /><br /><br />   <br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">&nbsp; &nbsp;LDX #$04<br />&nbsp; &nbsp;LDY #$00<br />update_collision_loop:<br />&nbsp; &nbsp;LDA &#91;nametable_ptr&#93;, y<br />&nbsp; &nbsp;CMP #TILE_CLEAR<br />&nbsp; &nbsp;BNE solid_tile<br />&nbsp; &nbsp;; empty space<br />&nbsp; &nbsp;LDA #$00<br />&nbsp; &nbsp;BEQ resume_collision_load<br />solid_tile:<br />&nbsp; &nbsp;LDA #$01<br />resume_collision_load:<br />&nbsp; &nbsp;STA &#91;nt_collision_ptr&#93;, y<br />&nbsp; &nbsp;INY<br />&nbsp; &nbsp;BNE update_collision_loop<br />&nbsp; &nbsp;; see if next set needs to be processed<br />&nbsp; &nbsp;INC nt_collision_ptr + 1<br />&nbsp; &nbsp;DEX<br />&nbsp; &nbsp;BNE update_collision_loop<br />&nbsp; &nbsp;RTS</div>

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>casprog</b> [ Thu Aug 16, 2018 10:48 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: Black screen but debugger shows nametable</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">Be careful when using page $0100 in RAM, that's where the stack lives. Try to use another area like $0300 for example.</div><br /><br />I'm such a noob  <img src="./images/smilies/icon_rolleyes.gif" alt=":roll:" title="Rolling Eyes" /> , this resolved the issue glutock.. thank you!<br /><br /><br />Thanks rainwarrior, I wanted to address your points in case I'm doing these things incorrectly;<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">1. Rendering is not turned back on, maybe the write to $2001 never happened?</div><br /><br />Here is the heart of it. By the way I also swap the background palette when I change my nametables, so I'm setting a flag and doing that part in NMI. The code below is outside of my NMI.<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">; turn off rendering<br />&nbsp; &nbsp;JSR Wait_vblank<br />&nbsp; &nbsp;JSR Disable_rendering<br />&nbsp; &nbsp;<br />&nbsp; &nbsp;; update palette<br />&nbsp; &nbsp;LDA #LOW(select_palette)<br />&nbsp; &nbsp;STA palette_ptr<br />&nbsp; &nbsp;LDA #HIGH(select_palette)<br />&nbsp; &nbsp;STA palette_ptr + 1<br />&nbsp; &nbsp;LDA #$01<br />&nbsp; &nbsp;STA swap_palette<br />&nbsp; &nbsp;JSR Wait_vblank<br />&nbsp; &nbsp;<br />&nbsp; &nbsp;; load starting nametable<br />&nbsp; &nbsp;LDA #LOW(select_nametable)<br />&nbsp; &nbsp;STA nametable_ptr&nbsp; &nbsp;<br />&nbsp; &nbsp;LDA #HIGH(select_nametable)<br />&nbsp; &nbsp;STA nametable_ptr + 1<br />&nbsp; &nbsp;JSR Load_nametable&nbsp; &nbsp;; this now also updates the collision map so I read from the nametable pointer once<br />&nbsp; &nbsp;<br />&nbsp; &nbsp;; turn rendering back on<br />&nbsp; &nbsp;JSR Wait_vblank<br />&nbsp; &nbsp;JSR Enable_rendering&nbsp; &nbsp;</div><br /><br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">; only call this during vblank<br />Disable_rendering:<br />&nbsp; &nbsp;; turn off ppu<br />&nbsp; &nbsp;LDA #%00000000<br />&nbsp; &nbsp;STA PPUMASK<br />&nbsp; &nbsp;RTS<br /><br />; only call this during vblank&nbsp; &nbsp;<br />Enable_rendering:<br />&nbsp; &nbsp;; turn on ppu on<br />&nbsp; &nbsp;LDA #%00011110<br />&nbsp; &nbsp;STA PPUMASK<br />&nbsp; &nbsp;RTS</div><br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">The scroll position is pointing at the second nametable, which might be an empty black page? (When you've finished uploading all 1024 bytes of nametable, the scroll pointer will actually be currently pointed at 0,0 on the subsequent nametable.)</div><br /><br />I have this at the end of my NMI, right before I pop the stack<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">&nbsp; &nbsp;; scroll pos<br />&nbsp; &nbsp;LDA #$00<br />&nbsp; &nbsp;STA $2005<br />&nbsp; &nbsp;STA $2005</div><br /><br /><br />And thanks for those tips doug! I'm new to assembly, it's interesting to see how the zero flag can work to save some opcodes.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>rainwarrior</b> [ Thu Aug 16, 2018 10:58 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: Black screen but debugger shows nametable</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">casprog wrote:</div><div class="quotecontent">I have this at the end of my NMI, right before I pop the stack<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">&nbsp; &nbsp;; scroll pos<br />&nbsp; &nbsp;LDA #$00<br />&nbsp; &nbsp;STA $2005<br />&nbsp; &nbsp;STA $2005</div></div><br />So, going back to one of my earlier suggestions, did you remember to turn the NMI itself back on so that this scroll code can take effect? ($2000 / PPUCTRL)

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>casprog</b> [ Thu Aug 16, 2018 11:03 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: Black screen but debugger shows nametable</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">So, going back to one of my earlier suggestions, did you remember to turn the NMI itself back on so that this scroll code can take effect? ($2000 / PPUCTRL)</div><br /><br />Well I leave my NMI running, I never turn it off anymore, I just disable / enable rendering now.<br /><br />EDIT:: do I need to update $2000 again even if I don't turn it off explicitly?

		

		</td>
	</tr>
	</table>


<hr width="85%" />

<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
<tr>
	<td><span class="gensmall">Page <strong>1</strong> of <strong>1</strong></span></td>
	<td align="right"><span class="gensmall">All times are UTC - 7 hours </span></td>
</tr>
<tr>
	<td colspan="2" align="center"><span class="gensmall">Powered by phpBB&reg; Forum Software &copy; phpBB Group<br />http://www.phpbb.com/</span></td>
</tr>
</table>

</body>
</html>