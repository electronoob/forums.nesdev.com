<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en-gb" xml:lang="en-gb">
<head>

<link rel="icon" href="/favicon.ico" type="image/x-icon" />
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
<meta http-equiv="content-language" content="en-gb" />
<meta http-equiv="content-style-type" content="text/css" />
<meta http-equiv="imagetoolbar" content="no" />
<meta name="resource-type" content="document" />
<meta name="distribution" content="global" />
<meta name="keywords" content="" />
<meta name="description" content="" />

<title>nesdev.com &bull; View topic - &quot;The frame and NMIs&quot; - buffering issues</title>

<link rel="alternate" type="application/atom+xml" title="Feed - nesdev.com" href="http://forums.nesdev.com/feed.php" /><link rel="alternate" type="application/atom+xml" title="Feed - News" href="http://forums.nesdev.com/feed.php?mode=news" /><link rel="alternate" type="application/atom+xml" title="Feed - All forums" href="http://forums.nesdev.com/feed.php?mode=forums" /><link rel="alternate" type="application/atom+xml" title="Feed - New Topics" href="http://forums.nesdev.com/feed.php?mode=topics" /><link rel="alternate" type="application/atom+xml" title="Feed - Active Topics" href="http://forums.nesdev.com/feed.php?mode=topics_active" /><link rel="alternate" type="application/atom+xml" title="Feed - Forum - Newbie Help Center" href="http://forums.nesdev.com/feed.php?f=10" /><link rel="alternate" type="application/atom+xml" title="Feed - Topic - &quot;The frame and NMIs&quot; - buffering issues" href="http://forums.nesdev.com/feed.php?f=10&amp;t=15619" />

<link rel="stylesheet" href="./style.php?id=1&amp;lang=en" type="text/css" />

<script type="text/javascript">
// <![CDATA[


function popup(url, width, height, name)
{
	if (!name)
	{
		name = '_popup';
	}

	window.open(url.replace(/&amp;/g, '&'), name, 'height=' + height + ',resizable=yes,scrollbars=yes,width=' + width);
	return false;
}

function jumpto()
{
	var page = prompt('Enter the page number you wish to go to:', '1');
	var per_page = '';
	var base_url = '';

	if (page !== null && !isNaN(page) && page == Math.floor(page) && page > 0)
	{
		if (base_url.indexOf('?') == -1)
		{
			document.location.href = base_url + '?start=' + ((page - 1) * per_page);
		}
		else
		{
			document.location.href = base_url.replace(/&amp;/g, '&') + '&start=' + ((page - 1) * per_page);
		}
	}
}

/**
* Find a member
*/
function find_username(url)
{
	popup(url, 760, 570, '_usersearch');
	return false;
}

/**
* Mark/unmark checklist
* id = ID of parent container, name = name prefix, state = state [true/false]
*/
function marklist(id, name, state)
{
	var parent = document.getElementById(id);
	if (!parent)
	{
		eval('parent = document.' + id);
	}

	if (!parent)
	{
		return;
	}

	var rb = parent.getElementsByTagName('input');
	
	for (var r = 0; r < rb.length; r++)
	{
		if (rb[r].name.substr(0, name.length) == name)
		{
			rb[r].checked = state;
		}
	}
}



// ]]>
</script>
</head>
<body class="ltr">

<a name="top"></a>

<div id="wrapheader">

	<div id="logodesc">
	</div>

	<div id="menubar">

		<table width="100%" cellspacing="0">
		<tr>
			<td rowspan="2"><a href="./index.php"><img src="./styles/subsilver2/imageset/site_logo.gif" alt="" title="" /></a></td>
			<td width="100%" align="center"><h1>nesdev.com</h1><span class="gen">NES Development and Strangulation Records message boards</span></td>
		</tr>
		<tr>
			<td align="center">
				<!--<div style="float: right;">
					<form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_top">
					<input type="hidden" name="cmd" value="_s-xclick">
					<input type="hidden" name="hosted_button_id" value="X2HM4WNR5YT8S">
					<input type="image" src="https://www.paypalobjects.com/en_US/i/btn/btn_donateCC_LG.gif" border="0" name="submit" alt="PayPal - The safer, easier way to pay online!">
					<img alt="" border="0" src="https://www.paypalobjects.com/en_US/i/scr/pixel.gif" width="1" height="1">
					</form>
				</div>-->
				<a href="./faq.php"><img src="./styles/prosilver/theme/images/icon_mini_faq.gif" width="12" height="13" alt="*" /> FAQ</a>
				&nbsp; &nbsp;<a href="./search.php"><img src="./styles/prosilver/theme/images/icon_mini_search.gif" width="12" height="13" alt="*" /> Search</a>
				<br />	
				 &nbsp;<a href="./ucp.php?mode=minion"><img src="./styles/prosilver/theme/images/icon_mini_register.gif" width="12" height="13" alt="*" /> Register</a>
					&nbsp; &nbsp;<a href="./ucp.php?mode=login"><img src="./styles/prosilver/theme/images/icon_mini_login.gif" width="12" height="13" alt="*" /> Login</a>&nbsp;
			</td>
		</tr>
		</table>
	</div>

	<div id="datebar">
		<table width="100%" cellspacing="0">
		<tr>
			<td class="gensmall"></td>
			<td class="gensmall" align="right">It is currently Fri Aug 17, 2018 12:45 am<br /></td>
		</tr>
		</table>
	</div>

</div>

<div id="wrapcentre">

	
	<p class="searchbar">
		<span style="float: left;"><a href="./search.php?search_id=unanswered">View unanswered posts</a> | <a href="./search.php?search_id=active_topics">View active topics</a></span>
		
	</p>
	

	<br style="clear: both;" />

	<table class="tablebg" width="100%" cellspacing="1" cellpadding="0" style="margin-top: 5px;">
	<tr>
		<td class="row1">
			<p class="breadcrumbs"><a href="./index.php">Board index</a> &#187; <a href="./viewforum.php?f=24">NES / Famicom</a> &#187; <a href="./viewforum.php?f=10">Newbie Help Center</a></p>
			<p class="datetime">All times are UTC - 7 hours </p>
		</td>
	</tr>
	</table>

	<br />
	

					<center>
					<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
					<!-- NesDev Forums -->
					<ins class="adsbygoogle"
						 style="display:block"
						 data-ad-client="ca-pub-7801010229099644"
						 data-ad-slot="7979066809"
						 data-ad-format="auto"></ins>
					<script>
					(adsbygoogle = window.adsbygoogle || []).push({});
					</script>
					</center>
	<br />


<div id="pageheader">
	<h2><a class="titles" href="./viewtopic.php?f=10&amp;t=15619">&quot;The frame and NMIs&quot; - buffering issues</a></h2>


	<p class="moderators">Moderator: <a href="./memberlist.php?mode=group&amp;g=320">Moderators</a></p>

</div>

<br clear="all" /><br />

<div id="pagecontent">

	<table width="100%" cellspacing="1">
	<tr>
		<td align="left" valign="middle" nowrap="nowrap">
		<a href="./posting.php?mode=post&amp;f=10"><img src="./styles/subsilver2/imageset/en/button_topic_new.gif" alt="Post new topic" title="Post new topic" /></a>&nbsp;<a href="./posting.php?mode=reply&amp;f=10&amp;t=15619"><img src="./styles/subsilver2/imageset/en/button_topic_reply.gif" alt="Reply to topic" title="Reply to topic" /></a>
		</td>
		
			<td class="nav" valign="middle" nowrap="nowrap">&nbsp;Page <strong>1</strong> of <strong>1</strong><br /></td>
			<td class="gensmall" nowrap="nowrap">&nbsp;[ 10 posts ]&nbsp;</td>
			<td class="gensmall" width="100%" align="right" nowrap="nowrap"></td>
		
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr>
		<td class="cat">
			<table width="100%" cellspacing="0">
			<tr>
				<td class="nav" nowrap="nowrap">&nbsp;
				<a href="./viewtopic.php?f=10&amp;t=15619&amp;view=print" title="Print view">Print view</a>
				</td>
				<td class="nav" align="right" nowrap="nowrap"><a href="./viewtopic.php?f=10&amp;t=15619&amp;view=previous">Previous topic</a> | <a href="./viewtopic.php?f=10&amp;t=15619&amp;view=next">Next topic</a>&nbsp;</td>
			</tr>
			</table>
		</td>
	</tr>

	</table>


	<table class="tablebg" width="100%" cellspacing="1">
	
		<tr>
			<th>Author</th>
			<th>Message</th>
		</tr>
	<tr class="row1">

			<td align="center" valign="middle">
				<a name="p190604"></a>
				<b class="postauthor">sav</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p190604">&quot;The frame and NMIs&quot; - buffering issues</a></div><div style="float: right;"><a href="./viewtopic.php?p=190604#p190604"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Mon Mar 06, 2017 10:19 pm&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Fri Dec 04, 2015 7:26 pm<br /><b>Posts:</b> 7
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">Hey everyone,<br /><br />I was wondering if someone could help me out with an issue I'm seeing.<br />I'm trying to implement a horizontal-scrolling platformer. I've followed  <a href="http://wiki.nesdev.com/w/index.php/The_frame_and_NMIs" class="postlink">&quot;The frame and NMIs&quot;</a> and kept the game logic and NMI logic separate. I implemented the scrolling the following way:<br /> - Every 16 times the scroll is incremented I buffer two columns of background sprites (i.e. one column of 16x16 &quot;metatiles&quot;)<br /> - Every 32 times the scroll is incremented I buffer one column of attribute data<br /><br />When I run my implementation, the screen glitches out - it kind of &quot;jumps&quot; up and down every now and then. It doesn't happen when I turn the PAL emulation on, so it makes me think that I'm doing too much during NMI and it causes these issues. Pretty much every 32 times the scroll is incremented I have to write 30 + 30 + 8 = 68 bytes. I should be able to do that, right? &quot;The frame and NMIs&quot; mentions it should be possible to write 160 bytes?<br /><br />Maybe my drawing routine is too complicated, but I've really tried to make it as simple as possible (not an expert on assembly though). Here's my code:<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent"><br />; Input data has the following format:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br />;&nbsp; &nbsp;Byte 0&nbsp; = length&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br />;&nbsp; &nbsp;Byte 1&nbsp; = high byte of the PPU address&nbsp; &nbsp; &nbsp; &nbsp;<br />;&nbsp; &nbsp;Byte 2&nbsp; = low byte of the PPU address&nbsp; &nbsp; &nbsp; &nbsp; <br />;&nbsp; &nbsp;Byte 3&nbsp; = reserved for now<br />;&nbsp; &nbsp;Byte 4+ = {length} bytes&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br />;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />; Repeat until length == 0 is found.&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br />;<br />; Buffer starts at $0100, drawBuffer is declared as<br />;<br />;&nbsp; .rsset $0100<br />; drawBuffer .rs 160<br /><br />DoDrawing:<br /><br />&nbsp; LDX #$00 <br />&nbsp; LDA $2002&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;; read PPU status to reset the high/low latch&nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; <br />&nbsp; .drawLoop:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; <br />&nbsp; &nbsp; LDY drawBuffer, x&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;; load the length of the data to the Y register<br />&nbsp; &nbsp; BEQ ResetBuffer&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;; length equal 0 means that the drawing is done&nbsp; <br />&nbsp; &nbsp; <br />&nbsp; &nbsp; INX&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;; X = 1<br />&nbsp; &nbsp; LDA drawBuffer, x&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;; load the high byte of the target address<br />&nbsp; &nbsp; STA $2006&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;; write the high byte to PPU<br />&nbsp; &nbsp; <br />&nbsp; &nbsp; INX&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;; X = 2<br />&nbsp; &nbsp; LDA drawBuffer, x&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;; load the low byte of the target address<br />&nbsp; &nbsp; STA $2006&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;; write the low byte to PPU<br />&nbsp; &nbsp; <br />&nbsp; &nbsp; INX&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;; X = 3 (reserved for now)<br />&nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; .setLoop:<br />&nbsp; &nbsp; &nbsp; INX&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;; increment X so it points to the next byte<br />&nbsp; &nbsp; &nbsp; LDA drawBuffer, x&nbsp; &nbsp; &nbsp; &nbsp;; load a byte of the data<br />&nbsp; &nbsp; &nbsp; STA $2007&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;; write it to PPU<br />&nbsp; &nbsp; &nbsp; DEY&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;; decrement Y<br />&nbsp; &nbsp; &nbsp; BNE .setLoop&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; if Y != 0 jump to .setLoop<br />&nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; INX&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;; increment X so it points to the next segment&nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; JMP .drawLoop&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;; jump back to .drawLoop<br />&nbsp;<br />ResetBuffer:<br /><br />&nbsp; CPX #$00<br />&nbsp; BEQ DoDrawingDone&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;; there was no data buffered<br />&nbsp;<br />&nbsp; LDA #$00 <br />&nbsp; .resetBufferLoop:<br />&nbsp; &nbsp; DEX&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;; decrement X so it points on the previous byte<br />&nbsp; &nbsp; STA drawBuffer, x&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;; reset to 0<br />&nbsp; &nbsp; BNE .resetBufferLoop&nbsp; &nbsp; &nbsp; ; X &gt; 0 means there's more resetting to do<br /><br />DoDrawingDone:&nbsp; <br />&nbsp; RTS<br /></div><br /><br />One thing that's not that great is that when buffering a column of attributes, I have to buffer them as 8 separate segments (since the address increments by 8). So in the case when I'm buffering two columns of sprites and one column of attributes, the buffer holds 108 bytes (34 bytes for sprite column 1, 34 bytes for sprite column 2, 8*5=40 bytes for attributes). But I don't know if that matters, or how it can be resolved.<br /><br />I could probably fix this by buffering less stuff at one time - I could buffer one column of sprites when &quot;scroll == (multiple of 16)&quot;, second column of sprites a frame before that, and the attributes a frame before that - but before I make it too complicated I just wanted to make sure I'm not missing anything obvious.<br /><br />Any help is appreciated! <img src="./images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=7332"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row2">

			<td align="center" valign="middle">
				<a name="p190605"></a>
				<b class="postauthor">dougeff</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p190605">Re: &quot;The frame and NMIs&quot; - buffering issues</a></div><div style="float: right;"><a href="./viewtopic.php?p=190605#p190605"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Mon Mar 06, 2017 11:01 pm&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				<tr>
					<td><img src="./download/file.php?avatar=7008_1483937093.png" width="86" height="90" alt="User avatar" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Fri May 08, 2015 7:17 pm<br /><b>Posts:</b> 2200<br /><b>Location:</b> DIGDUG
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">I believe you should be able to transfer 100-130 ish bytes per vblank with this code. Yes.<br /><br />Are you remembering to set the scroll after PPU updates, as PPU address and scroll affect each other.<br /><br />Also, are you aware that the hardware stack is also in the $100 page? I've seen more than one official NES games where the stack fills / overflows from time to time.</div>

					
						<div class="postbody"><br />_________________<br /><a href="http://nesdoug.com" class="postlink">nesdoug.com</a> -- blog/tutorial on programming for the NES</div>
					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=7008"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row1">

			<td align="center" valign="middle">
				<a name="p190606"></a>
				<b class="postauthor">sav</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p190606">Re: &quot;The frame and NMIs&quot; - buffering issues</a></div><div style="float: right;"><a href="./viewtopic.php?p=190606#p190606"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Mon Mar 06, 2017 11:33 pm&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Fri Dec 04, 2015 7:26 pm<br /><b>Posts:</b> 7
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">I've tried moving the buffer to $0600, didn't help.<br />As for updating PPU before the scroll - I believe I'm doing that. This is my NMI handler (it's basically the same as the one on the &quot;The frame and NMIs&quot; wiki page):<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">NMI:<br />&nbsp; PHA&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;; back up registers<br />&nbsp; TXA&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br />&nbsp; PHA&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br />&nbsp; TYA&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br />&nbsp; PHA&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; LDA needDma&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br />&nbsp; BEQ DmaDone&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br />&nbsp; &nbsp; LDA #SPRITES_LOW_BYTE&nbsp; &nbsp;; do sprite DMA<br />&nbsp; &nbsp; STA $2003&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;; conditional via the 'needDma' flag<br />&nbsp; &nbsp; LDA #SPRITES_HIGH_BYTE&nbsp; <br />&nbsp; &nbsp; STA $4014&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br />&nbsp; &nbsp; DEC needDma&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br />&nbsp; DmaDone:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; LDA needDraw&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; do other PPU drawing<br />&nbsp; BEQ DrawDone&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; conditional via the 'needDraw' flag<br />&nbsp; &nbsp; BIT $2002&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;; clear VBl flag, reset $2005/$2006 toggle<br />&nbsp; &nbsp; JSR DoDrawing&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;; draw the stuff from the drawing buffer<br />&nbsp; &nbsp; DEC needDraw&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; DrawDone:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; LDA needPpuReg&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; PPU register updates<br />&nbsp; BEQ PpuRegDone&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; conditional via the 'needPpuReg' flag<br />&nbsp; &nbsp; LDA soft2001&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; copy buffered $2000/$2001<br />&nbsp; &nbsp; STA $2001&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br />&nbsp; &nbsp; LDA soft2000&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; STA $2000&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; BIT $2002&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;; set the scroll<br />&nbsp; &nbsp; LDA scroll&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; set horizontal scroll<br />&nbsp; &nbsp; STA $2005&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; LDA #$00&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; no vertical scroll<br />&nbsp; &nbsp; STA $2005&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br />&nbsp; &nbsp; DEC needPpuReg&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; PpuRegDone:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br />&nbsp; LDA #$00&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; clear the sleeping flag so that WaitForFrame will exit<br />&nbsp; STA sleeping&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; PLA&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;; restore regs and exit<br />&nbsp; TAY&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br />&nbsp; PLA<br />&nbsp; TAX<br />&nbsp; PLA<br />&nbsp; RTI<br /><br />&nbsp; RTI<br /></div><br /><br />I guess the easiest way to fix would be to draw columns on &quot;scroll == multiple of 8&quot; - should fix it and won't be a huge code change. But still, I'm wondering why it doesn't work currently. I've noticed that if I only write 6 bytes of attributes instead of 8, it works (except for the fact that the colors on the bottom of the screen are wrong, obviously) - so it seems NMI is taking too long, but just a little bit <img src="./images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=7332"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row2">

			<td align="center" valign="middle">
				<a name="p190608"></a>
				<b class="postauthor">rainwarrior</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p190608">Re: &quot;The frame and NMIs&quot; - buffering issues</a></div><div style="float: right;"><a href="./viewtopic.php?p=190608#p190608"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Tue Mar 07, 2017 12:13 am&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				<tr>
					<td><img src="./download/file.php?avatar=5165_1471663472.jpg" width="100" height="100" alt="User avatar" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Sun Jan 22, 2012 12:03 pm<br /><b>Posts:</b> 6592<br /><b>Location:</b> Canada
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody"><div class="codetitle"><b>Code:</b></div><div class="codecontent">&nbsp; &nbsp; .setLoop:<br />&nbsp; &nbsp; &nbsp; INX&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;; increment X so it points to the next byte<br />&nbsp; &nbsp; &nbsp; LDA drawBuffer, x&nbsp; &nbsp; &nbsp; &nbsp;; load a byte of the data<br />&nbsp; &nbsp; &nbsp; STA $2007&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;; write it to PPU<br />&nbsp; &nbsp; &nbsp; DEY&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;; decrement Y<br />&nbsp; &nbsp; &nbsp; BNE .setLoop&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; if Y != 0 jump to .setLoop<br /></div><br />This takes 13 cycles (or 14 if the BNE is unfortunate enough to cross a page-- you might want to verify this with an assert).<br />68 x 13 = 884 cycles. You have about 2200 total in NMI. OAM DMA also eats 512 on its own, and there's a bunch of other overhead in there. If you want to know exactly when $2005l gets set, just put a breakpoint on it in FCEUX or some other debugger that can display the current scanline etc.<br /><br />After the &quot;DoDrawing&quot; routine you must always set the scroll, so I think it should bypass that test for &quot;needPpuReg&quot; (it's always needed) with a JMP, maybe? Are you certain the needPpuReg flag is always getting set whenever needDraw is set?<br /><br />By the way &quot;LDA #0, STA zp&quot; takes the same number of cycles as &quot;DEC zp&quot;, though it does save two bytes of code. I'm only mentioning it because they look more like booleans than counters, and it makes me wonder what happens if needDraw ended up getting incremented an extra time or something?</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=5165"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row1">

			<td align="center" valign="middle">
				<a name="p190609"></a>
				<b class="postauthor">nostromo</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p190609">Re: &quot;The frame and NMIs&quot; - buffering issues</a></div><div style="float: right;"><a href="./viewtopic.php?p=190609#p190609"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Tue Mar 07, 2017 12:27 am&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Tue Aug 12, 2014 11:25 pm<br /><b>Posts:</b> 9<br /><b>Location:</b> Sonora, Mexico
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">I think the resetbuffer rutine is something you could do after updating the ppu.</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=6645"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row2">

			<td align="center" valign="middle">
				<a name="p190611"></a>
				<b class="postauthor">rainwarrior</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p190611">Re: &quot;The frame and NMIs&quot; - buffering issues</a></div><div style="float: right;"><a href="./viewtopic.php?p=190611#p190611"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Tue Mar 07, 2017 12:42 am&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				<tr>
					<td><img src="./download/file.php?avatar=5165_1471663472.jpg" width="100" height="100" alt="User avatar" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Sun Jan 22, 2012 12:03 pm<br /><b>Posts:</b> 6592<br /><b>Location:</b> Canada
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody"><div class="quotetitle">nostromo wrote:</div><div class="quotecontent">I think the resetbuffer rutine is something you could do after updating the ppu.</div><br />Or do not at all. Why do you need to &quot;reset&quot; the buffer? It shouldn't be used again until needsDraw is set, right?</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=5165"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row1">

			<td align="center" valign="middle">
				<a name="p190627"></a>
				<b class="postauthor">dougeff</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p190627">Re: &quot;The frame and NMIs&quot; - buffering issues</a></div><div style="float: right;"><a href="./viewtopic.php?p=190627#p190627"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Tue Mar 07, 2017 6:45 am&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				<tr>
					<td><img src="./download/file.php?avatar=7008_1483937093.png" width="86" height="90" alt="User avatar" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Fri May 08, 2015 7:17 pm<br /><b>Posts:</b> 2200<br /><b>Location:</b> DIGDUG
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody"><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">I've tried moving the buffer to $0600, didn't help.</div><br /><br />When I was talking about the $100 page, my worry isn't about a short term fix to your current problem. It's a potential existential threat to the long term integrity of the game.<br /><br />Imaging, a small hidden bug causes the stack to start growing, but only after playing the game for a long period of time. It won't show up in short testing sessions. When it grows enough...colliding with your buffer, it will crash your game. Just be aware of that potential before you put something in the $100 page. Not that this is forbidden.</div>

					
						<div class="postbody"><br />_________________<br /><a href="http://nesdoug.com" class="postlink">nesdoug.com</a> -- blog/tutorial on programming for the NES</div>
					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=7008"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row2">

			<td align="center" valign="middle">
				<a name="p190629"></a>
				<b class="postauthor" style="color: #FF3300">tepples</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p190629">Re: &quot;The frame and NMIs&quot; - buffering issues</a></div><div style="float: right;"><a href="./viewtopic.php?p=190629#p190629"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Tue Mar 07, 2017 7:07 am&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Sun Sep 19, 2004 11:12 pm<br /><b>Posts:</b> 20409<br /><b>Location:</b> NE Indiana, USA (NTSC)
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">I too put my buffers in $0100-$01BF or thereabouts. The only way I know to have a &quot;silent&quot; stack overflow like the one seen in <em>Solar Wars</em> (which had to be fixed for <a href="http://forums.nesdev.com/viewtopic.php?p=135550#p135550" class="postlink">a mapper hack thereof to UNROM</a>) is to try to JSR from your main loop into a subroutine but JMP back out without removing the return address from the stack. Otherwise, if you're just leaving values pushed with PHA,  your game will <a href="https://en.wikipedia.org/wiki/Fail-fast" class="postlink">fail fast</a> when it tries to return to a garbage address.<br /><br />But there are a couple defenses to that. One is to wrap your main loop inside a scoping structure, such as ca65's <tt style="margin-left: 2px; margin-right: 2px; padding:3px; background-color: #3355aa; color: white;">.proc</tt>, so that you're not tempted to JMP to internal labels. Another is to play-test your game in a debugging emulator with a write breakpoint on the stack's high water mark, such as $01C0. Watch $0100-$01FF in a debugging emulator's memory viewer (such as Debug &gt; Hex Editor in FCEUX for Windows) to find the appropriate high water mark for your game.</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=9"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row1">

			<td align="center" valign="middle">
				<a name="p190669"></a>
				<b class="postauthor">sav</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p190669">Re: &quot;The frame and NMIs&quot; - buffering issues</a></div><div style="float: right;"><a href="./viewtopic.php?p=190669#p190669"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Tue Mar 07, 2017 8:52 pm&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Fri Dec 04, 2015 7:26 pm<br /><b>Posts:</b> 7
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">Thanks everyone for replying! To sum up:<br /><br />1) So the scroll must always be set after nametable updates? Didn't know that. I've updated my code to do just that - however, now I'm also always writing $2000 and $2001 in that case, even if they haven't changed - that shouldn't be an issue, right (it could be easily fixed, but I'm not sure if it's worth it)? Here's the new NMI code (without pushing registers to the stack):<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">&nbsp; LDA needDma&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br />&nbsp; BEQ DmaDone&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br />&nbsp; &nbsp; LDA #SPRITES_LOW_BYTE&nbsp; &nbsp;; do sprite DMA<br />&nbsp; &nbsp; STA $2003&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;; conditional via the 'needDma' flag<br />&nbsp; &nbsp; LDA #SPRITES_HIGH_BYTE&nbsp; <br />&nbsp; &nbsp; STA $4014<br />&nbsp; DmaDone:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; LDA needDraw&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; do other PPU drawing<br />&nbsp; BEQ DrawDone&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; conditional via the 'needDraw' flag<br />&nbsp; &nbsp; BIT $2002&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;; clear VBl flag, reset $2005/$2006 toggle<br />&nbsp; &nbsp; JSR DoDrawing&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;; draw the stuff from the drawing buffer<br />&nbsp; &nbsp; JMP DoPpuReg&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; after drawing PPU reg is required<br />&nbsp; DrawDone:<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; LDA needPpuReg&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; PPU register updates<br />&nbsp; BEQ PpuRegDone&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; conditional via the 'needPpuReg' flag<br />&nbsp; DoPpuReg:<br />&nbsp; &nbsp; LDA soft2001&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; copy buffered $2000/$2001<br />&nbsp; &nbsp; STA $2001&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br />&nbsp; &nbsp; LDA soft2000&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; STA $2000&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; BIT $2002&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;; set the scroll<br />&nbsp; &nbsp; LDA scroll&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; set horizontal scroll<br />&nbsp; &nbsp; STA $2005&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; LDA #$00&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; no vertical scroll<br />&nbsp; &nbsp; STA $2005&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br />&nbsp; PpuRegDone:<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br />&nbsp; LDA #$00&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; clear the sleeping flag so that WaitForFrame will exit, also clear all conditional flags<br />&nbsp; STA needDma<br />&nbsp; STA needDraw<br />&nbsp; STA needPpuReg<br />&nbsp; STA sleeping<br /></div><br /><br />2) Right, I don't need to zero-out the buffer. Duh. After removing that, the glitching is gone! Awesome. I guess that whole loop executed 68 times must have used like 600-700 cycles? That explains why it took too long. I'll still change it to draw a single column of background tiles every 8 times the scroll is incremented though (I guess it's better to do less, but more often).<br />3) About the stack - I guess I'll worry about overflows when they happen <img src="./images/smilies/icon_smile.gif" alt=":)" title="Smile" /> I don't know how much memory my game will be using, I may be able to move the buffer to a different place anyway<br /><br />Thanks again for the help!</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=7332"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row2">

			<td align="center" valign="middle">
				<a name="p190672"></a>
				<b class="postauthor">rainwarrior</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p190672">Re: &quot;The frame and NMIs&quot; - buffering issues</a></div><div style="float: right;"><a href="./viewtopic.php?p=190672#p190672"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Tue Mar 07, 2017 9:10 pm&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				<tr>
					<td><img src="./download/file.php?avatar=5165_1471663472.jpg" width="100" height="100" alt="User avatar" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Sun Jan 22, 2012 12:03 pm<br /><b>Posts:</b> 6592<br /><b>Location:</b> Canada
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody"><div class="quotetitle">sav wrote:</div><div class="quotecontent">1) So the scroll must always be set after nametable updates? Didn't know that. I've updated my code to do just that - however, now I'm also always writing $2000 and $2001 in that case, even if they haven't changed - that shouldn't be an issue, right (it could be easily fixed, but I'm not sure if it's worth it)? Here's the new NMI code (without pushing registers to the stack):</div><br />You need to write $2000 and 2 x $2005 to completely set the scroll. The two $2005 writes are not enough to select the current nametable on their own.<br /><br />Writing $2001 is irrelevant to scroll, but it's not like you need to optimize away one redundant write.<br /><br /><div class="quotetitle">sav wrote:</div><div class="quotecontent">3) About the stack - I guess I'll worry about overflows when they happen <img src="./images/smilies/icon_smile.gif" alt=":)" title="Smile" /> I don't know how much memory my game will be using, I may be able to move the buffer to a different place anyway</div><br />For most NES games probably ~32 bytes of stack space is plenty. Every nested JSR is just 2 bytes. An IRQ just 3 (+3 more if you save A/X/Y). Unless you have very deep subroutine calls, or perhaps rely on some recursive structure for your game (e.g. a binary tree) your stack probably doesn't get very deep at all.<br /><br />So, using the $100 page for extra storage can help if you're short on RAM, but also some people like to put NMI update data on the $100 page because you can temporarily swap out the stack pointer and use PHA instead of LDA $100, X + INX.</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=5165"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table width="100%" cellspacing="1" class="tablebg">
	<tr align="center">
		<td class="cat"><form name="viewtopic" method="post" action="./viewtopic.php?f=10&amp;t=15619"><span class="gensmall">Display posts from previous:</span> <select name="st" id="st"><option value="0" selected="selected">All posts</option><option value="1">1 day</option><option value="7">7 days</option><option value="14">2 weeks</option><option value="30">1 month</option><option value="90">3 months</option><option value="180">6 months</option><option value="365">1 year</option></select>&nbsp;<span class="gensmall">Sort by</span> <select name="sk" id="sk"><option value="a">Author</option><option value="t" selected="selected">Post time</option><option value="s">Subject</option></select> <select name="sd" id="sd"><option value="a" selected="selected">Ascending</option><option value="d">Descending</option></select>&nbsp;<input class="btnlite" type="submit" value="Go" name="sort" /></form></td>
	</tr>
	</table>
	

	<table width="100%" cellspacing="1">
	<tr>
		<td align="left" valign="middle" nowrap="nowrap">
		<a href="./posting.php?mode=post&amp;f=10"><img src="./styles/subsilver2/imageset/en/button_topic_new.gif" alt="Post new topic" title="Post new topic" /></a>&nbsp;<a href="./posting.php?mode=reply&amp;f=10&amp;t=15619"><img src="./styles/subsilver2/imageset/en/button_topic_reply.gif" alt="Reply to topic" title="Reply to topic" /></a>
		</td>
		
			<td class="nav" valign="middle" nowrap="nowrap">&nbsp;Page <strong>1</strong> of <strong>1</strong><br /></td>
			<td class="gensmall" nowrap="nowrap">&nbsp;[ 10 posts ]&nbsp;</td>
			<td class="gensmall" width="100%" align="right" nowrap="nowrap"></td>
		
	</tr>
	</table>

</div>

<div id="pagefooter"></div>

<br clear="all" />
<table class="tablebg" width="100%" cellspacing="1" cellpadding="0" style="margin-top: 5px;">
	<tr>
		<td class="row1">
			<p class="breadcrumbs"><a href="./index.php">Board index</a> &#187; <a href="./viewforum.php?f=24">NES / Famicom</a> &#187; <a href="./viewforum.php?f=10">Newbie Help Center</a></p>
			<p class="datetime">All times are UTC - 7 hours </p>
		</td>
	</tr>
	</table>
	<br clear="all" />

	<table class="tablebg" width="100%" cellspacing="1">
	<tr>
		<td class="cat"><h4>Who is online</h4></td>
	</tr>
	<tr>
		<td class="row1"><p class="gensmall">Users browsing this forum: No registered users and 8 guests</p></td>
	</tr>
	</table>


<br clear="all" />

<table width="100%" cellspacing="1">
<tr>
	<td width="40%" valign="top" nowrap="nowrap" align="left"></td>
	<td align="right" valign="top" nowrap="nowrap"><span class="gensmall">You <strong>cannot</strong> post new topics in this forum<br />You <strong>cannot</strong> reply to topics in this forum<br />You <strong>cannot</strong> edit your posts in this forum<br />You <strong>cannot</strong> delete your posts in this forum<br />You <strong>cannot</strong> post attachments in this forum<br /></span></td>
</tr>
</table>

<br clear="all" />

<table width="100%" cellspacing="0">
<tr>
	<td><form method="get" name="search" action="./search.php"><span class="gensmall">Search for:</span> <input class="post" type="text" name="keywords" size="20" /> <input class="btnlite" type="submit" value="Go" /><input type="hidden" name="t" value="15619" />
<input type="hidden" name="sf" value="msgonly" />
</form></td>
	<td align="right">
	<form method="post" name="jumpbox" action="./viewforum.php" onsubmit="if(document.jumpbox.f.value == -1){return false;}">

	<table cellspacing="0" cellpadding="0" border="0">
	<tr>
		<td nowrap="nowrap"><span class="gensmall">Jump to:</span>&nbsp;<select name="f" onchange="if(this.options[this.selectedIndex].value != -1){ document.forms['jumpbox'].submit() }">

		
			<option value="-1">Select a forum</option>
		<option value="-1">------------------</option>
			<option value="24">NES / Famicom</option>
		
			<option value="2">&nbsp; &nbsp;NESdev</option>
		
			<option value="3">&nbsp; &nbsp;NESemdev</option>
		
			<option value="21">&nbsp; &nbsp;NES Graphics</option>
		
			<option value="6">&nbsp; &nbsp;NES Music</option>
		
			<option value="22">&nbsp; &nbsp;Homebrew Projects</option>
		
			<option value="34">&nbsp; &nbsp;&nbsp; &nbsp;2018 NESdev Competition</option>
		
			<option value="33">&nbsp; &nbsp;&nbsp; &nbsp;2017 NESdev Competition</option>
		
			<option value="32">&nbsp; &nbsp;&nbsp; &nbsp;2016 NESdev Competition</option>
		
			<option value="31">&nbsp; &nbsp;&nbsp; &nbsp;2014 NESdev Competition</option>
		
			<option value="30">&nbsp; &nbsp;&nbsp; &nbsp;2011 NESdev Competition</option>
		
			<option value="10" selected="selected">&nbsp; &nbsp;Newbie Help Center</option>
		
			<option value="9">&nbsp; &nbsp;NES Hardware and Flash Equipment</option>
		
			<option value="28">&nbsp; &nbsp;&nbsp; &nbsp;Reproduction</option>
		
			<option value="19">&nbsp; &nbsp;NESdev International</option>
		
			<option value="11">&nbsp; &nbsp;&nbsp; &nbsp;FCdev</option>
		
			<option value="18">&nbsp; &nbsp;&nbsp; &nbsp;NESdev China</option>
		
			<option value="27">&nbsp; &nbsp;&nbsp; &nbsp;NESdev Middle East</option>
		
			<option value="25">Other</option>
		
			<option value="5">&nbsp; &nbsp;General Stuff</option>
		
			<option value="4">&nbsp; &nbsp;Membler Industries</option>
		
			<option value="23">&nbsp; &nbsp;Other Retro Dev</option>
		
			<option value="12">&nbsp; &nbsp;&nbsp; &nbsp;SNESdev</option>
		
			<option value="20">&nbsp; &nbsp;&nbsp; &nbsp;GBDev</option>
		
			<option value="15">&nbsp; &nbsp;Test Forum</option>
		
			<option value="26">Site Issues</option>
		
			<option value="13">&nbsp; &nbsp;phpBB Issues</option>
		
			<option value="14">&nbsp; &nbsp;Web Issues</option>
		
			<option value="16">&nbsp; &nbsp;nesdevWiki</option>
		

		</select>&nbsp;<input class="btnlite" type="submit" value="Go" /></td>
	</tr>
	</table>

	</form>
</td>
</tr>
</table>


</div>


<div id="wrapfooter">
	
	<span class="copyright">Powered by <a href="http://www.phpbb.com/">phpBB</a>&reg; Forum Software &copy; phpBB Group
	</span>
</div>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-61452025-2', 'auto');
  ga('send', 'pageview');

</script>
</body>
</html>