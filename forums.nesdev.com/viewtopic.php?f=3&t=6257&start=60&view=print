<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html dir="ltr" lang="en-gb">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta http-equiv="Content-Style-Type" content="text/css">
<meta http-equiv="Content-Language" content="en-gb">
<title>nesdev.com :: View topic - Nintendulator,Nestopia?</title>

<style type="text/css">
<!--

body {
	font-family: Verdana,serif;
	font-size: 10pt;
}

img {
	border: 0;
}

td {
	font-family: Verdana,serif;
	font-size: 10pt;
	line-height: 150%;
}

.code, .codecontent, 
.quote, .quotecontent {
	margin: 0 5px 0 5px;
	padding: 5px;
	font-size: smaller;
	border: black solid 1px;
}

.quotetitle {
	color: black;
	display : block;
	font-weight: bold;
}

.forum {
	font-family: Arial,Helvetica,sans-serif;
	font-weight: bold;
	font-size: 18pt;
}

.topic {
	font-family: Arial,Helvetica,sans-serif;
	font-size: 14pt;
	font-weight: bold;
}

.gensmall {
	font-size: 8pt;
}

hr {
	color: #888;
	height: 3px;
	border-style: solid;
}

hr.sep {
	color: #aaa;
	height: 1px;
	border-style: dashed;
}
//-->
</style>

</head>
<body>

<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
<tr>
	<td colspan="2" align="center"><span class="Forum">nesdev.com</span><br /><span class="gensmall"><a href="http://forums.nesdev.com/">http://forums.nesdev.com/</a></span></td>
</tr>
<tr>
	<td colspan="2"><br /></td>
</tr>
<tr>
	<td><span class="topic">Nintendulator,Nestopia?</span><br /><span class="gensmall"><a href="http://forums.nesdev.com/viewtopic.php?f=3&amp;t=6257">http://forums.nesdev.com/viewtopic.php?f=3&amp;t=6257</a></span></td>
	<td align="right" valign="bottom"><span class="gensmall">Page <strong>5</strong> of <strong>6</strong></span></td>
</tr>
</table>



	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Disch</b> [ Thu Apr 08, 2010 4:07 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">I really fail to see what the complexity is.</div>
<br />
<br />Same.  It's as simple as you described... just point the memory to a different buffer, and set a flag to indicate it's writable.
<br />
<br />Lots of mappers have swappable CHR-RAM
<br />Lots of mappers have CHR-ROM + CHR-RAM
<br />
<br />Emulators should be dynamic enough to handle the above situations.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Zepper</b> [ Thu Apr 08, 2010 6:28 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><img src="http://godknowswhat.files.wordpress.com/2009/05/objection2.jpg" alt="Image" />
<br /><img src="./images/smilies/icon_smile.gif" alt=":)" title="Smile" />

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>tokumaru</b> [ Thu Apr 08, 2010 8:36 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Zepper, maybe you have used an architecture for your emulator that is not very dynamic. You say this would require a major code rewrite... Maybe fixing this single ROM is not worth the trouble, but making your emulator more dynamic and able to handle such changes more easily in the future might be. Don't you think?

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Dwedit</b> [ Thu Apr 08, 2010 9:34 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />For PocketNES, it was a big deal to work in bankable CHR-RAM or mappers with mixed CHR RAM and CHR ROM, mainly because of the way it uses the GBA hardware.  But other emulators with software renderers should have a much easier time.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Zepper</b> [ Fri Apr 09, 2010 8:24 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />- Can we put CHR ROM in mapper 2, for example? Or even in mapper 7? What about the value written, how would it be handled? I'm curious.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>tepples</b> [ Fri Apr 09, 2010 8:59 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />When figuring out how your emulator should behave under some configuration, figure out how you would build that configuration on a circuit board and ask yourself how that board would react. CHR ROM in mappers that ordinarily use RAM <span style="font-size: 84%; line-height: normal"><strong>SHOULD</strong></span> be handled the same way as if I had desoldered the RAM chip and rewired a socket to take a mask ROM or an EPROM. It would ignore pattern table writes, and the ROM would be switchable the same way that the RAM is. For example, UNROM (#2) and AOROM (#7) would have a fixed 8 KiB bank just like NROM, and CPROM (#13) would have a fixed 4 KiB bank and a switchable 4 KiB bank.
<br />
<br />
<br />(<a href="http://tools.ietf.org/html/rfc2119" class="postlink">What's a <span style="font-size: 84%; line-height: normal"><strong>SHOULD</strong></span></a>?)

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Dwedit</b> [ Fri Apr 09, 2010 9:56 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />If you put CHR ROM in Mapper 2 or Mapper 7, it would just act like nonbankable NROM CHR that is read only.  Of course, also with bankable PRG, and one screen mirroring (on mapper 7).

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Denine</b> [ Sat Apr 17, 2010 11:13 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />HI,So I'm back <img src="./images/smilies/icon_smile.gif" alt=":)" title="Smile" /> 
<br />I cleared my code,and learned some things.
<br />But there's some things I don't understand:
<br />Title Screen:
<br /><img src="http://img353.imageshack.us/img353/5148/test1.png" alt="Image" />
<br />OK...after pressing A,turn PPU OFF:
<br /><img src="http://img580.imageshack.us/img580/1599/test2p.png" alt="Image" />
<br />Fine,Load palette,Name table..wait what?:
<br /><img src="http://img709.imageshack.us/img709/5970/test3m.png" alt="Image" />
<br />Turn PPU ON...
<br /><img src="http://img208.imageshack.us/img208/7944/test4h.png" alt="Image" />
<br />After that everything is normally,but always when I'll try to use this "trick" problem is always repeating...
<br />I was reading about 2 name table PPU update possibilities...One is to use method mentioned earlier,second is about "buffering" what have to be draw,but i don't really understand it,unfortunelly.
<br />Here's some code in case you need it:
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;lda #%00000000<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;sta $2000&nbsp; &nbsp; &nbsp; &nbsp;;Clean PPU<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;sta $2001<br /><br />**Here's Palette loading code**<br />**Here's Name Table loading code**<br /><br />&nbsp; LDA #$00<br /><br />&nbsp; STA $2005<br />&nbsp; STA $2005<br /><br />&nbsp; lda #%10001000&nbsp; &nbsp;;enable NMI,Sprites from VRAM1<br />&nbsp; sta $2000<br />&nbsp; lda #%00011000&nbsp; &nbsp;;Turn PPU ON and show sprites.<br />&nbsp; sta $2001<br /></div>

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Dwedit</b> [ Sat Apr 17, 2010 12:23 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Whenever you disable NMI, then re-enable it, read from PPUSTAT so you don't end up calling your NMI code halfway through vblank.  But I don't that that's whats going on here.
<br />
<br />Whenever you turn the screen back on, wait for VBLANK first.  I put the screen turning-on code inside NMI personally, but you don't have to do that.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Denine</b> [ Sat Apr 17, 2010 12:56 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Thanks,it worked!I noticed one thing-I don't have to read PPUSTAT before turning PPU OFF,If I do then there's 2 black screen frames.
<br />I would have some more questions,My friend has played My game on real hardware,but it seems that sprites isn't displayed correctly.(They are blinking...)But any emulator can produce that effect.I mean,game is working fine evenon Nestopia and Nintendulator.
<br />Maybe I'm wrong...but maybe i should place sprite updates into NMI?At the other hand,it doesn't work and it'll waste lot of Vblank... <img src="./images/smilies/icon_confused.gif" alt=":?" title="Confused" />

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Disch</b> [ Sat Apr 17, 2010 1:37 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />writes to $4014 (and $2004, but there's little point in using $2004 directly) must be done in VBlank or when the PPU is off.
<br />
<br />You can't update onscreen sprites during rendering.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Dwedit</b> [ Sat Apr 17, 2010 2:17 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />The code to MAKE the data for the sprite table does not need to run during vblank.  The code to COPY the data (write to 4014) does.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>tepples</b> [ Sat Apr 17, 2010 4:05 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />while not done:
<br /><ol style="list-style-type: decimal"><li>Read controllers. </li><li>Run game rules. </li><li>Based on the new positions of game tokens, prepare buffers to be copied to OAM and VRAM. </li><li>Wait for vertical blank. </li><li>Copy buffers to OAM and VRAM. </li><li>Set the scroll position. </li><li>Run sound code. </li></ol>
<br />Pretty much every NES game loop looks like this, except that many games do steps 5-7 in the NMI handler. Dwedit is talking about the difference between steps 3 and 5.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Denine</b> [ Sun Apr 18, 2010 12:55 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />So,if I assume correctly...in step 3 (NOT inside NMI) I prepare sprites to be written.
<br />In step 5 (inside NMI) I gather that data and write it into OAM.
<br />Hmm...not sure about it though...
<br />I have sprites data in $600-$6FF in RAM.
<br />OK,my NMI:
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">vector_nmi:<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; PHA<br />&nbsp; &nbsp; &nbsp; &nbsp; TXA<br />&nbsp; &nbsp; &nbsp; &nbsp; PHA<br />&nbsp; &nbsp; &nbsp; &nbsp; TYA<br />&nbsp; &nbsp; &nbsp; &nbsp; PHA&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;;backup registers<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; lda #$00&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;Set 00 for sprites-bytes counter&#40;if there's 1 <br />&nbsp; &nbsp; &nbsp; &nbsp; sta $7F2&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;;sprite then counter is 0x04&#41;<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; ldx #$00&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;Start loading sprites data from 600<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; jsr Rys.Sprity&nbsp; &nbsp; &nbsp; &nbsp;;Drawing sprites function<br />&nbsp; &nbsp; &nbsp; &nbsp; jsr ft_music_play&nbsp; ;play music<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; PLA&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;;restore registers<br />&nbsp; &nbsp; &nbsp; &nbsp; TAY<br />&nbsp; &nbsp; &nbsp; &nbsp; PLA<br />&nbsp; &nbsp; &nbsp; &nbsp; TAX<br />&nbsp; &nbsp; &nbsp; &nbsp; PLA<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; RTI&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br /></div><br />And Sprites drawing function:<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">Rys.Sprity:<br />&nbsp; &nbsp; &nbsp; &nbsp; lda $600,x&nbsp; &nbsp; &nbsp; &nbsp;; load Y value<br />&nbsp; &nbsp;sta $2004 <br /><br />&nbsp; &nbsp; &nbsp; &nbsp; lda $601,x<br />&nbsp; &nbsp; &nbsp; &nbsp; sta $2004&nbsp; &nbsp; &nbsp; &nbsp; ; store tile number<br /><br />&nbsp; &nbsp;lda $602,x&nbsp; &nbsp; &nbsp; &nbsp;; Atrybuty<br />&nbsp; &nbsp;sta $2004&nbsp; <br /><br />&nbsp; &nbsp;lda $603,x&nbsp; &nbsp; &nbsp; &nbsp;; load X value<br />&nbsp; &nbsp;sta $2004 <br />&nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; inx<br />&nbsp; &nbsp; &nbsp; &nbsp; inx<br />&nbsp; &nbsp; &nbsp; &nbsp; inx<br />&nbsp; &nbsp; &nbsp; &nbsp; inx<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; cpx $7F2&nbsp; &nbsp; &nbsp;;check number of sprites<br />&nbsp; &nbsp; &nbsp; &nbsp; bne Rys.Sprity_Petla<br />&nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; rts<br /></div>

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Bregalad</b> [ Sun Apr 18, 2010 12:59 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />You should write nothing to $2004 and write the sprite page (here #$06) to $4014 once instead. Reason for this is that it will be WAY to slow to update sprites like you're doing.
<br />
<br />If you're worried about the later sprites being unused you don't want to display, you should put their Y coordinate (first byte) to 240 ($f0), so that they're unused. Not updating them is not going to hide them.

		

		</td>
	</tr>
	</table>


<hr width="85%" />

<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
<tr>
	<td><span class="gensmall">Page <strong>5</strong> of <strong>6</strong></span></td>
	<td align="right"><span class="gensmall">All times are UTC - 7 hours </span></td>
</tr>
<tr>
	<td colspan="2" align="center"><span class="gensmall">Powered by phpBB&reg; Forum Software &copy; phpBB Group<br />http://www.phpbb.com/</span></td>
</tr>
</table>

</body>
</html>