<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html dir="ltr" lang="en-gb">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta http-equiv="Content-Style-Type" content="text/css">
<meta http-equiv="Content-Language" content="en-gb">
<title>nesdev.com :: View topic - Fixing ROMs for EMS 64 GB Smart Card USB</title>

<style type="text/css">
<!--

body {
	font-family: Verdana,serif;
	font-size: 10pt;
}

img {
	border: 0;
}

td {
	font-family: Verdana,serif;
	font-size: 10pt;
	line-height: 150%;
}

.code, .codecontent, 
.quote, .quotecontent {
	margin: 0 5px 0 5px;
	padding: 5px;
	font-size: smaller;
	border: black solid 1px;
}

.quotetitle {
	color: black;
	display : block;
	font-weight: bold;
}

.forum {
	font-family: Arial,Helvetica,sans-serif;
	font-weight: bold;
	font-size: 18pt;
}

.topic {
	font-family: Arial,Helvetica,sans-serif;
	font-size: 14pt;
	font-weight: bold;
}

.gensmall {
	font-size: 8pt;
}

hr {
	color: #888;
	height: 3px;
	border-style: solid;
}

hr.sep {
	color: #aaa;
	height: 1px;
	border-style: dashed;
}
//-->
</style>

</head>
<body>

<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
<tr>
	<td colspan="2" align="center"><span class="Forum">nesdev.com</span><br /><span class="gensmall"><a href="http://forums.nesdev.com/">http://forums.nesdev.com/</a></span></td>
</tr>
<tr>
	<td colspan="2"><br /></td>
</tr>
<tr>
	<td><span class="topic">Fixing ROMs for EMS 64 GB Smart Card USB</span><br /><span class="gensmall"><a href="http://forums.nesdev.com/viewtopic.php?f=20&amp;t=5804">http://forums.nesdev.com/viewtopic.php?f=20&amp;t=5804</a></span></td>
	<td align="right" valign="bottom"><span class="gensmall">Page <strong>10</strong> of <strong>19</strong></span></td>
</tr>
</table>



	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>MottZilla</b> [ Sun Jan 27, 2013 12:36 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: Fixing ROMs for EMS 64 GB Smart Card USB</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />How many levels into the game do I have to go to save or get to the water level? I will check it out if I can. Is the Mole Mania game fixed with my patch? I never saw where it would crash or have problems without the patch.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>TheVlad1mir</b> [ Mon Jan 28, 2013 12:15 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: Fixing ROMs for EMS 64 GB Smart Card USB</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />In order to saves, necessary to pass 3 levels. Water level is 4.<br /><br />At the moment I not tested fix for Mole Mania.<br />i Need to reach the third level boss. I will test and accomplish your goal <img src="./images/smilies/icon_smile.gif" alt=":)" title="Smile" />

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>MottZilla</b> [ Mon Jan 28, 2013 2:17 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: Fixing ROMs for EMS 64 GB Smart Card USB</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />DKL2 might be messing up some registers at startup causing the save problems. It may be alot of places that it trashes so it may be a difficult fix. I'll take a look later today on real the actual cartridge.<br /><br />Update: Well I didn't have time to look at it yet, but I haven't forgotten about it.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>TheVlad1mir</b> [ Wed Jan 30, 2013 8:39 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: Fixing ROMs for EMS 64 GB Smart Card USB</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Sincerely thank you MottZilla! <img src="./images/smilies/icon_smile.gif" alt=":)" title="Smile" />

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>MottZilla</b> [ Wed Jan 30, 2013 2:42 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: Fixing ROMs for EMS 64 GB Smart Card USB</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />I tried DKL2 and I see the glitches in the first water level. The game never crashed on me, but the level became so glitched that I could not complete it and eventually got stuck. I will investigate what is going on exactly.<br /><br />update: What appears to be happening is when you turn left or right while swimming in the water (or if you switch characters) it writes to the $5Axx range by use of a res nn,(hl) opcode. I think what ends up happening is it messes up the SmartCard's register, depending on where the game is stored on your card I guess glitches or a complete crash can happen. Again the bad thing with this game is that it has the fixed ROM bank packed to the max. This makes adding a patch harder.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Greatmetal</b> [ Wed Jan 30, 2013 3:56 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: Fixing ROMs for EMS 64 GB Smart Card USB</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />First I would like to thank Mottzilla, The Great Heirophant, and others for your hard work making these patches, and the new menu for the ems cartridge. This is in regards to the Pokemon Red and Blue patches by The Great Heirophant; I applied the patches to Pokemon - Red Version [UE] [S]! (MD5 3d45c1ee9abd5738df46d2bdda8b57d) and Pokemon - Blue Version [UE] [S]! (MD5 50927e843568814f7ed45ec4f944bd8b) rom dumps yet the save file functionality seems to be broken still, at least using Mottzilla's multi-save menu for the EMS smartcard. I go to start the game, yet if there are any other save files on the cart, or if I reboot, it complains of &quot;The file data is corrupted&quot;. I was not sure if this was an issue with the patch by The Great Heirophant, or an issue with the menu. Yellow does the same thing but it does not have a patch so I did not expect it to work. Any info would be greatly appreciated.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>MottZilla</b> [ Wed Jan 30, 2013 5:16 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: Fixing ROMs for EMS 64 GB Smart Card USB</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Pokemon Blue (and likely Red and Yellow) appear to write both $4000 and $6000 when selecting a RAM bank. The problem might be that it's affecting the SmartCard register. There really is no reason for either game to write $6000. So it may just need those patched out, I don't know for sure. I didn't check GH's patched version. If I get a chance maybe I'll be able to take a look at the games.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Greatmetal</b> [ Wed Jan 30, 2013 10:44 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: Fixing ROMs for EMS 64 GB Smart Card USB</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />I did some snooping just to see the nature of the fix. The fix is a basic MBC5 emulation bug fix it looks like, found patched throughout the rom.<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">ld (ff00+B8), a<br />ld (2000), a - replaced with call 00DC<br /></div><br />$00CD - $00E7<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">push af<br />cp a, 00<br />jp nz, 00E3<br />inc a<br />ld (2000), a<br />pop af<br />ret<br /></div><br />I don't think it would impact the save functionality, but it is a valid fix! I'm thinking you're right about the registers becoming overwritten. Originally I thought it could be pokemon trying to read other sram data, but its just speculation.<br /><br />Edit: Later after some first attempts at hacking I may have some progress. I noticed that in your Megaman Xtreme [U] savefix you put the new cart checksum for the first edit, turned 6 <em>ld (4000), a</em> into nop operations, one I couldnt verify in the debugger but in a hex editor. I tried turning the operations <em>ld (4000), a</em> to nop sleds for Pokemon Blue, and on the cart and in emulator it doesn't seem to write the save file anymore, cant continue the save and just says new game on every load, though it appears in the save management menu on the cart. I am going to tweak more since I feel this is the right path. Maybe a problem with faulty bank switching again?

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>MottZilla</b> [ Thu Jan 31, 2013 2:07 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: Fixing ROMs for EMS 64 GB Smart Card USB</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />If you're handy with a debugger, use GH's fix, but patch the ld (6000),a to NOP,NOP,NOP. This might fix it. The games writes to this address but they have no reason to. However $4000 is actually the RAM Bank register, Pokemon *must* be able to write this because it uses 32kb of RAM, which is 4 banks. Let me know if after patching out all the writes to $6000 and using GH's fix/patch if it works.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Greatmetal</b> [ Thu Jan 31, 2013 5:24 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: Fixing ROMs for EMS 64 GB Smart Card USB</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Try as I might I cannot find any <em>ld (6000), a</em> operations in the pokemon blue rom, unless its not explicit or loaded into static memory when I'm running it? I'm using BGB if that means anything. Also trying things in regards to the ram bank enable (<em>ld (0000), a</em>) instruction in the $2509 - $250D area. I pulled the save off my card and it complains of &quot;The file data is destroyed&quot; in the emulator, but there is also a Great Greed save on the sram image as I was testing multisave on the cart.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>MottZilla</b> [ Thu Jan 31, 2013 7:10 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: Fixing ROMs for EMS 64 GB Smart Card USB</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Try to look again. Trap writes to $6000. It happens as soon as you press start on the title screen. At execution address $609E:<br /><br />ld a,0a<br />ld (0000),a<br />ld a,01<br />ld (6000),a<br />ld (4000),a<br /><br />The ld (6000),a should be removed. It is *possible* GH's fix already removed this write. However it is also possible the menu might possibly have a bug in the 32K save loading or saving, but it shouldn't. You could try testing another game that has a 32K save size, I think Wario Land 2 or maybe 3 does.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Greatmetal</b> [ Thu Jan 31, 2013 8:24 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: Fixing ROMs for EMS 64 GB Smart Card USB</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Ah, I see. The reason I could not find it was it was already patched by TGH. Warioland 2 does use a 32kb save file and it seems to be working fine, I was able to continue without trouble. I suppose Pokemon must have a certain save mechanism discrepancy with the card or information thats being overwritten by the EMS card.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>MottZilla</b> [ Thu Jan 31, 2013 9:54 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: Fixing ROMs for EMS 64 GB Smart Card USB</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />I'm not sure, it's possible Pokemon trashes the SmartCard's registers or does something else strange. One possibility is if it expects SRAM Disable to work and then writes to that area it will trash SRAM where as on a real cart SRAM disable actually works. I don't think it works on the SC. I guess you could try checking if the SRAM area is ever written to while SRAM is supposed to be disabled. <br /><br />One way to do this would be to patch the normal ROM so any writes of 00 to $0000-$1FFF are NOPed. By doing this, it won't disable SRAM so once it is enabled for the first time it stays enabled. Then just play the game and see if the save file gets corrupted like on the SmartCard. If it does, then it may be related to SRAM disable, or the lack of it more accurately. But it could be other things.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Greatmetal</b> [ Thu Jan 31, 2013 10:36 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: Fixing ROMs for EMS 64 GB Smart Card USB</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />I went through and nop'd out <em>ld (0000), a</em> operations preceded by <em>xor, a</em> and left ones preceded by <em>ld a,0A</em> which should be the disabling and enabling writes. The rom still worked fine in the emulator but failed (&quot;File data is corrupted&quot;) on the card. I was monitoring the SRAM enable and disable cycle and noticed that when the title screen is up with the scrolling pokemon the SRAM is complete garbage. Each pokemon image seems to be loaded into SRAM? I think this effectively kills your save. I guess making sure that the SRAM is not written to would be the way to fix this.<br /><br />Edit: Just did a test on the sprite SRAM loading on the card and it worked! turned the <em>ld a,0A</em> at $2507 into a <em>nop</em> and <em>xor a</em> operation and in the emulator the sprites were &quot;broken&quot; (just black squares), but on the card they worked! This shows that the SRAM is being written for each image I think. The data appears in the SRAM in the emulator at $36E3 (<em>ldi (hl),a</em> the entire call at $36E0) and hl has a value of $A188 (<em>ld hl,A188</em> at $251A).<br /><br /><s>Did some reading, and writing a value to $6000-$7FFF deals with ROM/RAM Mode Select and that functionality &#40;<em>ld &#40;6000&#41;, a</em>&#41; is removed in the patch around at $60A5 where I am getting this abnormality.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">This 1bit Register selects whether the two bits of the above register should be used as upper two bits of the ROM Bank, or as RAM Bank Number.<br /><br />00h = ROM Banking Mode &#40;up to 8KByte RAM, 2MByte ROM&#41; &#40;default&#41;<br />01h = RAM Banking Mode &#40;up to 32KByte RAM, 512KByte ROM&#41;<br /></div><br />Which determines the functionality of $4000-$5FFF<br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">This 2bit register can be used to select a RAM Bank in range from 00-03h, or to specify the upper two bits &#40;Bit 5-6&#41; of the ROM Bank number, depending on the current ROM/RAM Mode. &#40;See above.&#41;<br /></div><br /><br />Default its in ROM Banking mode, which it shows in the unpatched rom it needs to be in RAM Banking mode &#40;$60A3 is <em>ld a,01</em>&#41;. Does the smartcard compensate for this, or is it a superfluous feature?</s><br /><br />Ignore that, it should be unnecessary on MBC3 carts I guess. Just shows how much I know.<br /><br /><br />2/1/2012: Well I tried the default smart card menu and I am able to load the save! No corruption, but it only handles one at a time. I am still looking to see if I can patch the rom to fix this but it looks like it is the menu this time, but a new abnormality I see is some errors rendering character tiles with the default menu. This is not much of an issue compared to the other one, and I don't experience it with your menu. $5AF2-$5B04 is the save file verification calls and routines. Verified if you look up  &quot;MainMenu:&quot; <!-- m --><a class="postlink" href="https://bitbucket.org/iimarckus/pokered/src/5f2a62871addefc7e6b845a9bb601caa26e0d237/main.asm?at=master">https://bitbucket.org/iimarckus/pokered ... ?at=master</a><!-- m --> in this disassembled version.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>nitro2k01</b> [ Sat Feb 02, 2013 4:17 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: Fixing ROMs for EMS 64 GB Smart Card USB</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">Greatmetal wrote:</div><div class="quotecontent">I went through and nop'd out <em>ld (0000), a</em> operations preceded by <em>xor, a</em> and left ones preceded by <em>ld a,0A</em> which should be the disabling and enabling writes. The rom still worked fine in the emulator but failed (&quot;File data is corrupted&quot;) on the card. I was monitoring the SRAM enable and disable cycle and noticed that when the title screen is up with the scrolling pokemon the SRAM is complete garbage. Each pokemon image seems to be loaded into SRAM? I think this effectively kills your save. I guess making sure that the SRAM is not written to would be the way to fix this.</div><br />Let me explain what's happening. Writing to 0A to $0000 will unprotect SRAM so you can read or write to it. Writing 00 will turn on the protection again. Why this matters is because the CPU will crash on power down and spray the value 00 39 over the whole memory map. If the SRAM is unprotected at this time, it (the currently open bank) would get overwritten.

		

		</td>
	</tr>
	</table>


<hr width="85%" />

<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
<tr>
	<td><span class="gensmall">Page <strong>10</strong> of <strong>19</strong></span></td>
	<td align="right"><span class="gensmall">All times are UTC - 7 hours </span></td>
</tr>
<tr>
	<td colspan="2" align="center"><span class="gensmall">Powered by phpBB&reg; Forum Software &copy; phpBB Group<br />http://www.phpbb.com/</span></td>
</tr>
</table>

</body>
</html>