<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html dir="ltr" lang="en-gb">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta http-equiv="Content-Style-Type" content="text/css">
<meta http-equiv="Content-Language" content="en-gb">
<title>nesdev.com :: View topic - APU Triangle Popping Question</title>

<style type="text/css">
<!--

body {
	font-family: Verdana,serif;
	font-size: 10pt;
}

img {
	border: 0;
}

td {
	font-family: Verdana,serif;
	font-size: 10pt;
	line-height: 150%;
}

.code, .codecontent, 
.quote, .quotecontent {
	margin: 0 5px 0 5px;
	padding: 5px;
	font-size: smaller;
	border: black solid 1px;
}

.quotetitle {
	color: black;
	display : block;
	font-weight: bold;
}

.forum {
	font-family: Arial,Helvetica,sans-serif;
	font-weight: bold;
	font-size: 18pt;
}

.topic {
	font-family: Arial,Helvetica,sans-serif;
	font-size: 14pt;
	font-weight: bold;
}

.gensmall {
	font-size: 8pt;
}

hr {
	color: #888;
	height: 3px;
	border-style: solid;
}

hr.sep {
	color: #aaa;
	height: 1px;
	border-style: dashed;
}
//-->
</style>

</head>
<body>

<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
<tr>
	<td colspan="2" align="center"><span class="Forum">nesdev.com</span><br /><span class="gensmall"><a href="http://forums.nesdev.com/">http://forums.nesdev.com/</a></span></td>
</tr>
<tr>
	<td colspan="2"><br /></td>
</tr>
<tr>
	<td><span class="topic">APU Triangle Popping Question</span><br /><span class="gensmall"><a href="http://forums.nesdev.com/viewtopic.php?f=3&amp;t=7957">http://forums.nesdev.com/viewtopic.php?f=3&amp;t=7957</a></span></td>
	<td align="right" valign="bottom"><span class="gensmall">Page <strong>2</strong> of <strong>3</strong></span></td>
</tr>
</table>



	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>jwdonal</b> [ Sat Jul 09, 2011 7:44 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">Banshaku wrote:</div><div class="quotecontent">Is it only me or the SMB1 jump sound doesn't seems quite right?  I don't know the reason, just my ears feels that it's wrong.</div>
<br />Yes, it was wrong, as Dwedit confirmed. Here is the before and after version of the SMB1 jump (pulse channel 1 only).
<br />
<br /><a href="http://dl.dropbox.com/u/36237540/2011_07_09_smb1_jump_pulse1_duty_cycle_update_bad.wav" class="postlink">http://dl.dropbox.com/u/36237540/2011_07_09_smb1_jump_pulse1_duty_cycle_update_bad.wav</a>
<br /><a href="http://dl.dropbox.com/u/36237540/2011_07_09_smb1_jump_pulse1_duty_cycle_update_good.wav" class="postlink">http://dl.dropbox.com/u/36237540/2011_07_09_smb1_jump_pulse1_duty_cycle_update_good.wav</a>
<br />
<br />I can't thank you guys enough for your help.  If you notice anything else at all that sounds messed up please let me know.  Show no mercy!! <img src="./images/smilies/icon_wink.gif" alt=";)" title="Wink" />

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Dwedit</b> [ Sat Jul 09, 2011 8:05 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />If you want some good testcases for frequency sweeps, try Zelda 2 (sword beam sound effect, and hitting a rock with the sword), and Mike Tyson's Punch Out's sound effects.  FCEUX even gets those wrong.
<br />
<br />Also, Dr. Mario will reveal whether you are correctly shutting off the channel when the sound period gets too low.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>jwdonal</b> [ Sat Jul 09, 2011 9:27 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Thanks for the tip!  How do these sound?
<br />
<br />Zelda 2 Sword Beam Effect (Pulse Channel 1 Only):
<br /><a href="http://dl.dropbox.com/u/36237540/2011_07_09_zelda2_sword_beam_pulse1.wav" class="postlink">http://dl.dropbox.com/u/36237540/2011_07_09_zelda2_sword_beam_pulse1.wav</a>
<br />
<br />Mike Tyson's Punch-Out SFX (Pulse Channels 1&amp;2):
<br /><a href="http://dl.dropbox.com/u/36237540/2011_07_09_punchout_sfx_pulse12.wav" class="postlink">http://dl.dropbox.com/u/36237540/2011_07_09_punchout_sfx_pulse12.wav</a>
<br />
<br />Dr. Mario (All Channels):
<br /><a href="http://dl.dropbox.com/u/36237540/2011_07_09_drmario_all_channels.wav" class="postlink">http://dl.dropbox.com/u/36237540/2011_07_09_drmario_all_channels.wav</a>

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>tepples</b> [ Sat Jul 09, 2011 9:42 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Dr. Mario seems to sound OK, except for what might be a problem with channel balance: noise is a bit louder than I remember it. How are you handling the case where the output level of a channel changes multiple times during one output sample period? Are you using a box filter or something else to smooth out fast changes, or are you just sampling once every 1/44100 of a second? On the NES, noise periods 3, 2, 1, and especially 0 sound noticeably quieter than 4 because more of their energy is shifted out of the &lt;20 kHz audible band.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>jwdonal</b> [ Sun Jul 10, 2011 12:43 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Hey tepples! Hmm...so my audio codec (which is an AC'97 chip on my Xilinx board, and the board that I used for generating these WAV files) is configured for 48kHz.  It also supports 44.1kHz.  I just arbitrarily chose 48kHz. I don't know which is better, I'm not an audio expert, but if someone could tell me that would be much appreciated. <img src="./images/smilies/icon_smile.gif" alt=":)" title="Smile" />
<br />
<br />For the mixer I use the LUT method described on the wiki: (<a href="http://wiki.nesdev.com/w/index.php/APU_Mixer_Emulation" class="postlink">http://wiki.nesdev.com/w/index.php/APU_Mixer_Emulation</a>)
<br />
<br />The 16-bit data output of the mixer is then sent straight to the AC'97 codec.  I have no low/high-pass filters between the mixer and the AC'97 data buffer.  Although Kevtris mentioned on mIRC a couple days ago that I should think about adding a low-pass filter.
<br />
<br />Does that answer your question?  Sorry, I'm kind of lacking in my comprehension of filters and sampling rates and such. <img src="./images/smilies/icon_sad.gif" alt=":(" title="Sad" />  Hopefully my reply wasn't too dumb. <img src="./images/smilies/icon_smile.gif" alt=":)" title="Smile" />

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>tepples</b> [ Sun Jul 10, 2011 5:40 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Let me rephrase: The APU generates a sample on every CPU cycle, or 315/176*1000000 = 1789773 Hz. This means at a 48000 Hz output, the APU generates 315/176*1000000/48000 = 37.3 samples. How do you turn the 37.3 samples that the APU makes into one sample that you send to the AC'97 codec?

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>cpow</b> [ Sun Jul 10, 2011 7:56 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">tepples wrote:</div><div class="quotecontent">Let me rephrase: The APU generates a sample on every CPU cycle, or 315/176*1000000 = 1789773 Hz. This means at a 48000 Hz output, the APU generates 315/176*1000000/48000 = 37.3 samples. How do you turn the 37.3 samples that the APU makes into one sample that you send to the AC'97 codec?</div>
<br />
<br />I'm not trying to hijack this thread, but my method is just to keep track of the APU-generated samples between each sound-card-needed sample and do a simple average of the APU-generated samples to get the sound-card-needed sample.  That's probably not the best way, but it sounds alright.  What is "the best way"?

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>tepples</b> [ Sun Jul 10, 2011 9:10 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">cpow wrote:</div><div class="quotecontent">my method is just to keep track of the APU-generated samples between each sound-card-needed sample and do a simple average of the APU-generated samples to get the sound-card-needed sample.</div><br />That's a box filter or mean filter, and it's an OK first approximation. I suspect jwdonal is just point-sampling, which will produce noticeable artifacts with high square or noise frequencies.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">That's probably not the best way, but it sounds alright.  What is "the best way"?</div>
<br />Probably blargg's blip-buf library, which resamples stepwise functions like those generated by the APU using "band-limited synthesis".

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Jarhmander</b> [ Sun Jul 10, 2011 10:14 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">tepples wrote:</div><div class="quotecontent"> I suspect jwdonal is just point-sampling, which will produce noticeable artifacts with high square or noise frequencies.</div>
<br />That's nearest neighbor interpolation, isn't it?

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>jwdonal</b> [ Sun Jul 10, 2011 5:33 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">tepples wrote:</div><div class="quotecontent">Let me rephrase: The APU generates a sample on every CPU cycle, or 315/176*1000000 = 1789773 Hz. This means at a 48000 Hz output, the APU generates 315/176*1000000/48000 = 37.3 samples. How do you turn the 37.3 samples that the APU makes into one sample that you send to the AC'97 codec?</div><br />(Apologies for the lateness of my reply.)<br /><br />I honestly never really thought about this before because what I have now always just "seemed" to work/sound OK.  But now that I've actually taken a few minutes to think about how I have it set up - it's pretty kludgy. Haha.<br /><br /><strong>Hardware Layout</strong><br />------------------------------------------------------------------------------------<br />In order for my APU to write samples out to the AC97 codec I need to cross a clock domain.  That is, I need to transfer data from the 1.79MHz clock domain to the 12.288MHz AC97 domain.  Since these two clock domains are completely asynchronous from one another the typical solution in FPGA design is to insert a bisynchronous FIFO/RAM in between the 2 clock domains (otherwise you will get all sorts of insane timing errors).  I use the RAM method.<br /><br />The RAM block is a simple dual-port, that is, one side of the RAM is write-only (the APU side), while the other side is read-only (the AC97 side).  The write-side is synchronous to the 1.79MHz clock while the read-side is sync to the 12.288MHz clock.  Additionally, I simply tie the RAM's address lines to all zeros and only ever read/write from/to a single RAM address (this is not as big a waste as it seems because these internal FPGA RAMs are very small and plentiful).  Essentially, I create a single bisynchronous register to use between the APU and AC97 clock domains.<br /><br /><br /><strong>Sampling Control</strong><br />------------------------------------------------------------------------------------<br />On each CPU cycle the current 16-bit value on the output of the APU's mixer is written into the bisync RAM register.  There is no handshaking/waiting or communication to the AC97 controller.  The bisync register is just updated every CPU cycle with the current mixer output without fail.<br /><br />On the AC97 side of the bisync register (i.e. the read side) it is a bit more complex. The AC97 codec (i.e. the actual chip on the board) has a serial data input interface to receive audio samples.  The 16-bit audio samples are shifted out 1 bit at a time by the AC97 *controller* (i.e. the HDL AC97 control module that resides in the FPGA and sends data to the codec chip).<br /><br />However, it's actually much more complex than that because AC97 codecs utilize a communication protocol based on "slots" and "frames".  That is to say, you can't just shift out the 16-bit audio sample all by itself and then move on to shifting out the next sample.  What really happens is for every two 16-bit samples (2 samples needed for stereo audio) that is sent to the codec you must send 13 "slots".  These 13 slots make up one frame (one stereo sample) including all codec control overhead.<br /><br />Each AC97 "frame" is 256 clock cycles and is organized as follows:<br /><br />- 16 cycles for Slot 0 (16 bits)<br />- 20 cycles each for slots 1-12 (20 bits each)<br /><br />(Just FYI, slots 2&amp;3 hold the left/right 16-bit audio samples with 4 bits of 0 appended to the end in order to fill up the 20-bit slot. Also, I simply copy the mono APU mixer output to both the left/right channels.  All other slots are just codec control overhead.)<br /><br />The total frame time is therefore [16 + 12*20 = 256 cycles]. With a bit-clock frequency of 12.288 MHz, the frame frequency is 48,000Hz (12.288MHz/256). This results in a frame period of 20.83us (48kHz^-1).<br />------------------------------------------------------------------------------------<br /><br />Well, that was probably more than you ever wanted to know about my APU works. Haha.  But it did help me to actually type out how it all works.  I can already see where there are some issues.<br /><br />So to answer tepples question about how I turn 37.3 (i.e. 20.83us/(1.79MHz^-1)) samples into 1 AC97 sample...the answer is...uh, I don't do anything.  LMAO.  And, yes, I know that's very bad and stupid, but when I originally wrote my codec interface I just implemented the absolute simplest method possible to get data out to the codec without consider what havoc I might be causing.  <img src="./images/smilies/icon_razz.gif" alt=":-P" title="Razz" />  Hehe. I was much too eager to get working on the fun stuff!<br /><br />Would like to hear anybody's thoughts on this implementation and how I might make it better.  Tepples, I think your sample averaging would be helpful, along with an APU-to-AC97 "handshake" in between each audio sample...or something like that.  I really appreciate your post. You really made me stop and think about the mess I'm actually making in my audio output.  LOL<br /><br /><div class="quotetitle">cpow wrote:</div><div class="quotecontent">I'm not trying to hijack this thread, but my method is just to keep track of the APU-generated samples between each sound-card-needed sample and do a simple average of the APU-generated samples to get the sound-card-needed sample. That's probably not the best way, but it sounds alright. What is "the best way"?</div>
<br />You aren't hijacking the thread - what you said was completely on-topic.  In fact, I think I might just implement what you have implemented (basically what tepples suggested) in software and recreate it in hardware.  Should be pretty easy and it's about a 100x better than what I have now. <img src="./images/smilies/icon_razz.gif" alt=":-P" title="Razz" />

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>jwdonal</b> [ Sun Jul 10, 2011 9:49 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />So how about a running average of the mixer output?  Would that make sense?  I tested it out and here are two recordings from SMB1 (triangle channel only).
<br />
<br />No averaging (original implemenation described in previous post):
<br /><a href="http://dl.dropbox.com/u/36237540/2011_07_10_smb1_level1song_triangle_noavg.wav" class="postlink">http://dl.dropbox.com/u/36237540/2011_07_10_smb1_level1song_triangle_noavg.wav</a>
<br />
<br />Running average of last 32 samples:
<br /><a href="http://dl.dropbox.com/u/36237540/2011_07_10_smb1_level1song_triangle_runavg.wav" class="postlink">http://dl.dropbox.com/u/36237540/2011_07_10_smb1_level1song_triangle_runavg.wav</a>
<br />
<br />Which one do you guys think sounds better?  Personally, the running average sounds less "buzzier" than the non-averaged, which I think is a positive improvement.
<br />
<br />Pz!

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>tepples</b> [ Mon Jul 11, 2011 5:38 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Yeah, much of the aliasing is gone in the average-filtered version. Good job.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>jwdonal</b> [ Mon Jul 11, 2011 9:07 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Awesome! Thanks tepples! <img src="./images/smilies/icon_smile.gif" alt=":)" title="Smile" />

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>kyuusaku</b> [ Mon Jul 11, 2011 9:56 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />So has anybody calculated the response of this filter? It's a 32-tap FIR where every coefficient is 0.03125?

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>jwdonal</b> [ Mon Jul 11, 2011 10:13 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Here is a re-recording of Dr.Mario, but now with the 32-sample, running average.
<br />
<br />&gt;&gt; 0:00-2:13 = intro music and demo playing (all channels)
<br />&gt;&gt; 2:13-2:36 = new game menu (all channels)
<br />&gt;&gt; 2:39-2:50 = new game menu (pulse 1 only)
<br />&gt;&gt; 2:50-3:04 = new game menu (pulse 2 only)
<br />&gt;&gt; 3:04-3:19 = new game menu (triangle only)
<br />&gt;&gt; 3:20-3:35 = new game menu (noise only)
<br />&gt;&gt; 3:35-3:53 = new game menu (dmc only)
<br />&gt;&gt; 3:54-4:58 = game play (all channels)
<br />
<br /><a href="http://dl.dropbox.com/u/36237540/2011_07_11_drmario_various_channels.wav" class="postlink">http://dl.dropbox.com/u/36237540/2011_07_11_drmario_various_channels.wav</a>
<br />
<br />Tepples, does the noise problem you mentioned sound any better in this version than the previous version?

		

		</td>
	</tr>
	</table>


<hr width="85%" />

<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
<tr>
	<td><span class="gensmall">Page <strong>2</strong> of <strong>3</strong></span></td>
	<td align="right"><span class="gensmall">All times are UTC - 7 hours </span></td>
</tr>
<tr>
	<td colspan="2" align="center"><span class="gensmall">Powered by phpBB&reg; Forum Software &copy; phpBB Group<br />http://www.phpbb.com/</span></td>
</tr>
</table>

</body>
</html>