<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html dir="ltr" lang="en-gb">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta http-equiv="Content-Style-Type" content="text/css">
<meta http-equiv="Content-Language" content="en-gb">
<title>nesdev.com :: View topic - CopyNES (parallel version) in Linux</title>

<style type="text/css">
<!--

body {
	font-family: Verdana,serif;
	font-size: 10pt;
}

img {
	border: 0;
}

td {
	font-family: Verdana,serif;
	font-size: 10pt;
	line-height: 150%;
}

.code, .codecontent, 
.quote, .quotecontent {
	margin: 0 5px 0 5px;
	padding: 5px;
	font-size: smaller;
	border: black solid 1px;
}

.quotetitle {
	color: black;
	display : block;
	font-weight: bold;
}

.forum {
	font-family: Arial,Helvetica,sans-serif;
	font-weight: bold;
	font-size: 18pt;
}

.topic {
	font-family: Arial,Helvetica,sans-serif;
	font-size: 14pt;
	font-weight: bold;
}

.gensmall {
	font-size: 8pt;
}

hr {
	color: #888;
	height: 3px;
	border-style: solid;
}

hr.sep {
	color: #aaa;
	height: 1px;
	border-style: dashed;
}
//-->
</style>

</head>
<body>

<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
<tr>
	<td colspan="2" align="center"><span class="Forum">nesdev.com</span><br /><span class="gensmall"><a href="http://forums.nesdev.com/">http://forums.nesdev.com/</a></span></td>
</tr>
<tr>
	<td colspan="2"><br /></td>
</tr>
<tr>
	<td><span class="topic">CopyNES (parallel version) in Linux</span><br /><span class="gensmall"><a href="http://forums.nesdev.com/viewtopic.php?f=9&amp;t=4393">http://forums.nesdev.com/viewtopic.php?f=9&amp;t=4393</a></span></td>
	<td align="right" valign="bottom"><span class="gensmall">Page <strong>2</strong> of <strong>4</strong></span></td>
</tr>
</table>



	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Wookie</b> [ Mon Mar 02, 2009 5:07 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Will you post your code?  I had to do the soldering of the CopyNES myself and I may have screwed something up (e.g. cold solder joint, etc).

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Wookie</b> [ Mon Mar 02, 2009 5:09 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />NOTE: I've never run my CopyNES using a windows machine.  Do I have to upload an EEPROM image to it or anything?  Basically, I followed the desoldering/soldering instructions to install the thing and then hooked it up to my Linux box.  Do I need to go through the full install process on a windows box to initialize my CopyNES?

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>crade</b> [ Mon Mar 02, 2009 7:00 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />As far as I know there is no special initialization required first on the copynes side.  It should run immediately when you plug it in to the linux box.
<br />
<br />Here is the code:
<br /><!-- m --><a class="postlink" href="http://pastebin.com/meaf9cec">http://pastebin.com/meaf9cec</a><!-- m -->
<br />
<br />Now, I know the first character always gets screwed up in this sample (don't know why yet, but it could be a quirk in the actual unit)
<br />
<br />the code should basically output a version string read from the copynes.
<br />
<br />I am working on an actual program, but you know.. I'm slow <img src="./images/smilies/icon_smile.gif" alt=":)" title="Smile" />

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>crade</b> [ Mon Mar 02, 2009 7:02 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Sorry I meant to add that:
<br />even though only the data port is being used here, the program will fail if you don't open both ports.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Wookie</b> [ Tue Mar 03, 2009 11:39 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />So that's what I was doing wrong!  Two things:
<br /><ul>1. I wasn't opening both devices.<br />2. I wasn't using the O_NDELAY option.<br /></ul>
<br />Well, I took your code and tweaked it a little and now it works perfectly.  Here's <a href="http://pastebin.com/f495deb07" class="postlink">the code</a>
<br />
<br />So now that we know how to talk to this thing.  The next big hurdle is to be able to toggle the RTS and DTS lines properly on the second serial port so that we can execute the reset functions properly.  Every other command seems to require resetting the CopyNES into various modes (e.g. play mode, copy mode, etc).
<br />
<br />As soon as we get that down, we'll have all the initialization and control stuff working.  At that point, I say we go ahead and start a proper open source libCopyNES project on google code or sourceforge.
<br />
<br />I started looking at the whole plugin loading stuff and the protocols used for various functions.  If you look at the USBBIOS4.ASM file, it describes the whole protocol used for read/write to CPU/PPU memory and executing code.  Knowing that, the commands for dump cart start to make sense.  First it loads the "clear" plugin into CPU memory which sets the RAM to 0xFF.  It then resets the CopyNES into copy mode, loads the plugin specified by the user (this is cart specific) and then it runs the plugin which is just a fragment of 6502 code that dumps out all of the data stored in the cart out over the data channel.  When the dump is done, it resets the CopyNES again.
<br />
<br />Getting all of this code up and running in a cross platform lib/tool should not be hard.  I'm thinking a libCopyNES C library that handles all of the functions and a front end tool written in C# (mono gtk#) would be the best approach.
<br />
<br />It looks like there are virtual com port (VCP) drivers for Windows, Linux (ftdi_sio that we're using), and Mac OS X.  So if we can get everything working using the serial port, then libCopyNES combined with the VCP drivers should work on all systems.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>crade</b> [ Tue Mar 03, 2009 12:29 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />toggling the control lines works fine as well using the standard POSIX functions:
<br />(i have built this part):
<br />
<br /><!-- m --><a class="postlink" href="http://pastebin.com/mc4b978a">http://pastebin.com/mc4b978a</a><!-- m -->
<br />
<br />I have been working on a proper program.. but I'm slow.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Wookie</b> [ Tue Mar 03, 2009 12:33 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />New version of <a href="http://pastebin.com/fb9005fe" class="postlink">the code</a>.  
<br />
<br />It's a sample command line app that supports two commands: "version" and "play".  If you run it with the "version" option, it gets the version string from the CopyNES and writes it out to the console.  
<br />
<br />If you run it with the "play" option, it correctly fiddles with the RTS/DTS lines on the second serial port to reset the CopyNES into play mode which plays whatever cart you have in your NES.  It then waits for you to press enter.  When you do, it resets the CopyNES back into copy mode.
<br />
<br />So I now have the reset function working perfectly.  I think it is time to create a proper libCopyNES project now.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>crade</b> [ Tue Mar 03, 2009 12:33 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />I have actually started on this project, but I made it unneccessarily complicated (as I always do) 
<br />
<br />I am trying to do asynchronous communication rather than the sleep() junk that the current source does.
<br />
<br />so I'm currently stuck on some standard C problems.  
<br />
<br />I am certainly willing to share / post what I have so far.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Wookie</b> [ Tue Mar 03, 2009 12:47 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Sure, post it.  I know how to use fd sets and signals to do async I/O.  If you post the whole thing, I can clean it up into a proper automake type package (i.e. ./configure, make, make install) and see if I can help you with the async I/O.
<br />
<br />We need a project page.  Sourceforge?

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Wookie</b> [ Tue Mar 03, 2009 12:48 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Here's <a href="http://pastebin.com/f2b8efa08" class="postlink">new code</a>.  Same as before except that it correctly detects whether the NES is on in the init_port function.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>crade</b> [ Tue Mar 03, 2009 1:19 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Hey, I tried to create a new sourceforge project for it, but it will take awhile before it gets approved.  If you want, pm me and I will email you the package.  It already has autoconf stuff built in.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Wookie</b> [ Tue Mar 03, 2009 1:22 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />sweet.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>crade</b> [ Tue Mar 03, 2009 1:28 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />You are so much faster at this than I am lol, I have been working on this thing for a while but I didn't think it was far enough along to create a project yet.
<br />
<br />It is currently not in a working state.  I The current problem is that the change_recv_size function doesn't switch the receiving mode from size based to terminator based receiving (like I said it's unneccessrily complicated)
<br />
<br />feel free to hack the heck out of it and pull out all the asynchronous junk if you like, it's kinda a waste anyway considering it's serial communication <img src="./images/smilies/icon_smile.gif" alt=":)" title="Smile" />

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Wookie</b> [ Tue Mar 03, 2009 1:51 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />I'll see what I can do.  I think the simplest solution is to just use FD sets to implement async communication.  That way, the code that I've been publishing here doesn't change all that much.  The read loops are transformed into signal callbacks and FD set tests to see which fd woke up the application and then reading the data back.
<br />
<br />I honestly don't think that async really buys you much.  It's more complicated and this application is very synchronous in nature.  You click a button to execute a command and it does it.  Async is really only useful when you get random events you have to handle or if you have really long jobs that you're waiting on and you don't want to poll.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Wookie</b> [ Tue Mar 03, 2009 1:58 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />I'm most interested in getting this to work because I hate how all of these hacker tools are windows only.  Also because I'm working on an ethernet adapter that plugs into the NES expansion port and I need a tool like this to explore the expansion port stuff.
<br />
<br />I'm 99% sure I have a workable ethernet adapter design using the Microchip ENC28J60 chip.  The plan is to use the controller port bits that go to/from the expansion port to send/receive data over the SPI interface to the ethernet chip.  It won't be crazy fast, but it will be fast enough to make networked games.  I'm hoping to write the world's first 8-bit MMORPG <img src="./images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" />
<br />
<br />I'm now in the ethernet adapter driver writing phase and need to get this CopyNES working.  I haven't used Windows in over 5 years so I'm dedicated to making this work on Linux.

		

		</td>
	</tr>
	</table>


<hr width="85%" />

<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
<tr>
	<td><span class="gensmall">Page <strong>2</strong> of <strong>4</strong></span></td>
	<td align="right"><span class="gensmall">All times are UTC - 7 hours </span></td>
</tr>
<tr>
	<td colspan="2" align="center"><span class="gensmall">Powered by phpBB&reg; Forum Software &copy; phpBB Group<br />http://www.phpbb.com/</span></td>
</tr>
</table>

</body>
</html>