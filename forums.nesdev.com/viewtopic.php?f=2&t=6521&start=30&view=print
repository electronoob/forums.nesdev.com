<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html dir="ltr" lang="en-gb">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta http-equiv="Content-Style-Type" content="text/css">
<meta http-equiv="Content-Language" content="en-gb">
<title>nesdev.com :: View topic - DMC IRQs</title>

<style type="text/css">
<!--

body {
	font-family: Verdana,serif;
	font-size: 10pt;
}

img {
	border: 0;
}

td {
	font-family: Verdana,serif;
	font-size: 10pt;
	line-height: 150%;
}

.code, .codecontent, 
.quote, .quotecontent {
	margin: 0 5px 0 5px;
	padding: 5px;
	font-size: smaller;
	border: black solid 1px;
}

.quotetitle {
	color: black;
	display : block;
	font-weight: bold;
}

.forum {
	font-family: Arial,Helvetica,sans-serif;
	font-weight: bold;
	font-size: 18pt;
}

.topic {
	font-family: Arial,Helvetica,sans-serif;
	font-size: 14pt;
	font-weight: bold;
}

.gensmall {
	font-size: 8pt;
}

hr {
	color: #888;
	height: 3px;
	border-style: solid;
}

hr.sep {
	color: #aaa;
	height: 1px;
	border-style: dashed;
}
//-->
</style>

</head>
<body>

<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
<tr>
	<td colspan="2" align="center"><span class="Forum">nesdev.com</span><br /><span class="gensmall"><a href="http://forums.nesdev.com/">http://forums.nesdev.com/</a></span></td>
</tr>
<tr>
	<td colspan="2"><br /></td>
</tr>
<tr>
	<td><span class="topic">DMC IRQs</span><br /><span class="gensmall"><a href="http://forums.nesdev.com/viewtopic.php?f=2&amp;t=6521">http://forums.nesdev.com/viewtopic.php?f=2&amp;t=6521</a></span></td>
	<td align="right" valign="bottom"><span class="gensmall">Page <strong>3</strong> of <strong>7</strong></span></td>
</tr>
</table>



	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Bregalad</b> [ Sat Aug 14, 2010 1:43 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />From the info on the wiki I guess the IRQ is triggered after the last sample is fetched, in the case of a 1-sample byte it is shortly after you start the sample, but randomly placed in some range of time.
<br />Unless you can provide test ROMs I can't test this in hardware easily.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>tepples</b> [ Sat Aug 14, 2010 4:47 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">tokumaru wrote:</div><div class="quotecontent">Also, tepples, did you test your demo on hardware?</div>
<br />I tested only on 1. the ancient version of FCEU in Ubuntu's repo and 2. my NES + PowerPak. Now that I have some spare time to test it on a Windows machine, I see that FCEU and Nestopia have it right and Nintendulator has it wrong. And now that you mention it, I think I may have had my TV on mute for some other reason, and my laptop's internal speaker has never been good at reproducing low frequencies.
<br />
<br />As for the IRQ triggering immediately after starting playback, by the time it gets to the measure loop, either 1 or 2 IRQs have elapsed. The code around "cmp #2" below the measuring loop compensates for the extra time when two IRQs happen between enabling and measuring.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>tokumaru</b> [ Sat Aug 14, 2010 11:30 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />I just tested on my top loader and it seems that there always is an IRQ as soon as the DMC is started.
<br />
<br />I also tested your demo, tepples, and at least for me it's not as rock solid as it should. From time to time the text section appears out of place for a frame or so. Sometimes there are also glitches at the far right of the scanlines where the scroll changes, but that's hard to debug because each TV hides a different amount of pixels.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>tepples</b> [ Sat Aug 14, 2010 12:39 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">tokumaru wrote:</div><div class="quotecontent">I also tested your demo, tepples, and at least for me it's not as rock solid as it should. From time to time the text section appears out of place for a frame or so.</div><br />I'm testing on a PowerPak. That might have caused some difference in the power-up state, which in turn might have caused the noise (or lack thereof). But even after a few presses of reset to randomize the PPU-CPU alignment, I can't get the window to blink.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">Sometimes there are also glitches at the far right of the scanlines where the scroll changes, but that's hard to debug because each TV hides a different amount of pixels.</div>
<br />My HDTV underscans a bit when zoomed out. I can see both the left and right border, and on my NES + PowerPak, all the artifacts are inside the border area.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>blargg</b> [ Sat Aug 14, 2010 12:57 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />If the sample buffer is empty, then starting a one-byte DMC sample will result in an immediate IRQ. One way of avoiding this is to start it twice in a row, clear the IRQ flag, then enable IRQ.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>tokumaru</b> [ Sat Aug 14, 2010 1:05 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">tepples wrote:</div><div class="quotecontent">I'm testing on a PowerPak.</div><br />So am I. It must be the boot ROM version or something else then (does the top loader use a different CPU revision?). It doesn't blink gray like it does on Nintendulator though, the text just appears in the wrong place for a frame.<br /><br /><div class="quotetitle">blargg wrote:</div><div class="quotecontent">If the sample buffer is empty, then starting a one-byte DMC sample will result in an immediate IRQ. One way of avoiding this is to start it twice in a row, clear the IRQ flag, then enable IRQ.</div>
<br />Ah, good to know this is documented behavior. Thanks for the tip.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>blargg</b> [ Sat Aug 14, 2010 1:48 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />I'm getting occasional glitches on my NTSC frontloader, with a devcart that acts like NROM. Powered up and after a few seconds, some glitches. Taking a look at the technique, since it's pretty slick.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Bregalad</b> [ Sat Aug 14, 2010 2:10 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent"> 	 <br /><br />If the sample buffer is empty, then starting a one-byte DMC sample will result in an immediate IRQ. One way of avoiding this is to start it twice in a row, clear the IRQ flag, then enable IRQ.</div>
<br />If that is true, then the sample fetch happens as soon as you enable the DMC, then I see no purpose in counting the cycles until the first IRQ (that should be compensated later), if this happens always immediately.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>tepples</b> [ Sat Aug 14, 2010 2:15 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">Bregalad wrote:</div><div class="quotecontent">If that is true, then the sample fetch happens as soon as you enable the DMC, then I see no purpose in counting the cycles until the first IRQ (that should be compensated later), if this happens always immediately.</div>
<br />It actually counts the cycles until the <em>second</em> IRQ. Even if the first is immediate, the second isn't because the sample buffer isn't empty.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>tokumaru</b> [ Sat Aug 14, 2010 3:42 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Yeah, the first one fires right away, but the time between it and the second one varies.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Bregalad</b> [ Sun Aug 15, 2010 12:36 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />I don't get it at all. If you play ONE sample, why is there TWO IRQs ?

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>blargg</b> [ Sun Aug 15, 2010 4:36 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />I take it that the IRQ itself starts a sample. So if you start a one-byte sample outside IRQ when the sample buffer is empty, it immediatley reads that one byte, then finds it's done so it fires the IRQ immediately. Then the IRQ starts another one-byte sample. The sample buffer is already full, so this second sample has to wait until the buffer becomes empty, thus the second IRQ is delayed.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Bregalad</b> [ Sun Aug 15, 2010 5:28 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Then why play multiple samples at all if the first sample is immediate ? Just play a sample and the IRQ will be sync'ed with the video (that is with the 7-cycle interrupt jittering + the jitter you could possibly have at the time of setting up the DMC sample)

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>tepples</b> [ Sun Aug 15, 2010 5:43 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Because the sample buffer starts out empty, the first sample immediately finishes (from the memory reader's point of view) and thus immediately causes an IRQ. Because this is immediate, it is useless for synchronizing to the internal clock of the DMC. The time between the first IRQ and the second IRQ varies based on the phase of the clock of the DMC, and this is what the measuring loop measures. When I get time in front of an NES, I plan to experiment with starting the first two samples from the NMI handler, the first with no IRQ (to fill the sample buffer) and the second with an IRQ (to start measuring).
<br />
<br />None of this measuring would be necessary if it were possible to restart the clock of the DMC, but this is not possible on the NES.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Bregalad</b> [ Sun Aug 15, 2010 6:37 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Well then play a sample longer than 1 byte (17 or 33 bytes for example) for a delay before the IRQ.

		

		</td>
	</tr>
	</table>


<hr width="85%" />

<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
<tr>
	<td><span class="gensmall">Page <strong>3</strong> of <strong>7</strong></span></td>
	<td align="right"><span class="gensmall">All times are UTC - 7 hours </span></td>
</tr>
<tr>
	<td colspan="2" align="center"><span class="gensmall">Powered by phpBB&reg; Forum Software &copy; phpBB Group<br />http://www.phpbb.com/</span></td>
</tr>
</table>

</body>
</html>