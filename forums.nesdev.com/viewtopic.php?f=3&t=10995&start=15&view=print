<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html dir="ltr" lang="en-gb">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta http-equiv="Content-Style-Type" content="text/css">
<meta http-equiv="Content-Language" content="en-gb">
<title>nesdev.com :: View topic - MMC5 problems...</title>

<style type="text/css">
<!--

body {
	font-family: Verdana,serif;
	font-size: 10pt;
}

img {
	border: 0;
}

td {
	font-family: Verdana,serif;
	font-size: 10pt;
	line-height: 150%;
}

.code, .codecontent, 
.quote, .quotecontent {
	margin: 0 5px 0 5px;
	padding: 5px;
	font-size: smaller;
	border: black solid 1px;
}

.quotetitle {
	color: black;
	display : block;
	font-weight: bold;
}

.forum {
	font-family: Arial,Helvetica,sans-serif;
	font-weight: bold;
	font-size: 18pt;
}

.topic {
	font-family: Arial,Helvetica,sans-serif;
	font-size: 14pt;
	font-weight: bold;
}

.gensmall {
	font-size: 8pt;
}

hr {
	color: #888;
	height: 3px;
	border-style: solid;
}

hr.sep {
	color: #aaa;
	height: 1px;
	border-style: dashed;
}
//-->
</style>

</head>
<body>

<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
<tr>
	<td colspan="2" align="center"><span class="Forum">nesdev.com</span><br /><span class="gensmall"><a href="http://forums.nesdev.com/">http://forums.nesdev.com/</a></span></td>
</tr>
<tr>
	<td colspan="2"><br /></td>
</tr>
<tr>
	<td><span class="topic">MMC5 problems...</span><br /><span class="gensmall"><a href="http://forums.nesdev.com/viewtopic.php?f=3&amp;t=10995">http://forums.nesdev.com/viewtopic.php?f=3&amp;t=10995</a></span></td>
	<td align="right" valign="bottom"><span class="gensmall">Page <strong>2</strong> of <strong>4</strong></span></td>
</tr>
</table>



	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Anes</b> [ Fri Feb 21, 2014 1:18 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: MMC5 problems...</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">Disch wrote:</div><div class="quotecontent">$6000-7FFF will have RAM, never ROM.  So you are correct there.<br /><br />Uncharted Waters will not jump to $7xxx without first writing necessary PRG data to RAM.  Though I don't think it does that (it wouldn't have any reason to).<br /><br />Are you sure UW is actually supposed to be jumping to $7xxx?  Maybe you have some other PRG swapping mistake that's making it erroneously jump to a bad address?</div><br /><br />I have checked and re-checked and fixed some problems so, it's not jumping to $7xxx.<br />What it does now is a JSR to $8000 where i get 0x5C Unofficial Opcode.<br /><br />Anyway the game IS writing to registers $5114-5116 to do prg-rom swapping but it sticks prg-mode to &quot;0&quot;! so it doesn't swap anything!!

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Disch</b> [ Sat Feb 22, 2014 11:29 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: MMC5 problems...</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />After doing a quick check, it doesn't look like UW ever writes to $5100.  So your emu should be defaulting to mode 3 (8k mode) on Reset.<br /><br />I clearly remember having this problem with some games... and thought I put that in the doc, but I can't seem to find it there. Whoops.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Anes</b> [ Sat Feb 22, 2014 6:46 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: MMC5 problems...</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">Disch wrote:</div><div class="quotecontent">After doing a quick check, it doesn't look like UW ever writes to $5100.  So your emu should be defaulting to mode 3 (8k mode) on Reset.<br /><br />I clearly remember having this problem with some games... and thought I put that in the doc, but I can't seem to find it there. Whoops.</div><br /><br />Yes, you are right. I changed to &quot;3&quot; and now i can hear some music. My target now is ex1 mode, such a big thing.<br />Thnks.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Anes</b> [ Sun Feb 23, 2014 1:12 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: MMC5 problems...</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Disch you wrote:<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">Extended Attribute Mode:<br />&nbsp;---------------------------<br />&nbsp;When in Ex1 mode (see $5104 above), ordinary attribute tables and BG CHR regs are ignored, and instead, each<br />&nbsp;byte in ExRAM coresponds with an onscreen tile, and assigns that tile a 4k CHR page (allowing you to choose<br />&nbsp;from 16k tiles instead of 256) and its own attribute bits (allowing each 8x8 tile to have its own palette,<br />&nbsp;rather than having the normal 16x16 blocks).<br />&nbsp;<br />&nbsp;Bytes in ExRAM:<br />&nbsp; &nbsp;&#91;AACC CCCC&#93;<br />&nbsp; &nbsp; &nbsp;A = Attribute bits<br />&nbsp; &nbsp; &nbsp;C = 4k CHR Page<br /></div><br /><br />How is this &quot;assigns that tile to a 4K CHR page&quot;?<br />Do i have to read from CHR-ROM i mean something like: <br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">tile = g_pChrRom&#91;(data &amp; 0x3F) * 4096&#93;<br /></div><br /><br />Where g_pChrRom is all CART CHR-ROM.<br />Of course is my emu is Reading from 1024 bytes extra-ram. But how can it address 16K if extra-ram is 1024?<br />Im confused, need some explanation. i cannot make it to work.<br />Help!!

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>natt</b> [ Sun Feb 23, 2014 9:21 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: MMC5 problems...</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Looking at it from the perspective of the fetch pattern, here is roughly what should be done:<br /><br />1. PPU fetches an NT byte; that is, (addr &gt;= 0x2000 &amp;&amp; (addr &amp; 0x3ff) &lt; 0x3c0)<br />Return the NT fetched byte as requested from whatever nametable is in context.  Let N = addr &amp; 0x3ff; that will be your index into ExRAM for the next fetch.<br /><br />2. PPU fetches the corresponding AT byte.<br />Do not return anything from normal PPU space here.  Instead, return the two top bits of exram[N] as the attribute (they will need to be shifted into the correct bit position).  Let B = exram[N] &amp; 0x3F; this will give you the block to get pattern tables from.<br /><br />3. PPU fetches the low pattern byte (first bitplane).<br />The bottom 12 bits of the address for this should be passed through as is from the PPU.  The next 6 bits are B.  The top two bits are from the register at 0x5130.  This gives a total of 20 bits of address into a 1MiB CHR ROM; remove top bits for smaller CHR ROMs as appropriate.<br /><br />4. PPU fetches the high pattern byte (second bitplane)<br />Do exactly as in #3.  PPU A3 will be high this time, where it was low last time.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Disch</b> [ Sun Feb 23, 2014 4:29 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: MMC5 problems...</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Assuming you want a bit of a higher level explanation.<br /><br />In ExAttribute mode, the normal CHR swapping regs for the BG are ignored completely (except for $5130).  So instead of doing normal CHR swapping.. you can think of it where each 8x8 tile swaps in its own 4K page just for that one tile.<br /><br />So for each bg tile... the page you swap in is:  ExBits | (reg5130 &lt;&lt; 6)

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Anes</b> [ Sun Feb 23, 2014 10:51 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: MMC5 problems...</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">natt wrote:</div><div class="quotecontent">3. PPU fetches the low pattern byte (first bitplane).<br />The bottom 12 bits of the address for this should be passed through as is from the PPU.  The next 6 bits are B.  The top two bits are from the register at 0x5130.  This gives a total of 20 bits of address into a 1MiB CHR ROM; remove top bits for smaller CHR ROMs as appropriate.<br /></div><br /><br />With &quot;The bottom 12 bits of the address for this should be passed through as is from the PPU&quot; do you refer to PPU ADDR i mean the addr that can be changed with $2006?<br /><br />Sorry, but sometimes is difficult to me to understand.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Disch</b> [ Sun Feb 23, 2014 11:08 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: MMC5 problems...</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />When the PPU fetches a CHR byte it'll put $0xxx or $1xxx on the PPU address bus.  When in ExAttr mode, the MMC5 takes the low 12 bits of that... the 6 bits from ExRAM... and the 2 bits from $5130 to form a 20 bit address from which it will fetch the CHR data.<br /><br />The address is:<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">FFXX XXXXAAAA AAAAAAAA<br /><br />F=bits from $5130<br />X=ExRAM 'chr page' bits<br />A=low bits from PPU address (Loopy_V)<br /></div><br /><br /><br />Or.. if you want more detail as to bits:<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">FFXX XXXXTTTT TTTTPYYY<br /><br />F=bits from $5130<br />X=ExRAM 'chr page' bits<br />T=Tile number<br />P=bitplane (0 for low, 1 for high)<br />Y=pixel row (fine vertical scroll)<br /></div><br /><br /><br />Though really... this is probably thinking of it as more complex than it needs to be.  Conceptually the ExRAM bits just select a 4K page.  You use that instead of the normal CHR swapping regs.  The rest is the same as normal.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Anes</b> [ Mon Feb 24, 2014 2:44 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: MMC5 problems...</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />ok i got it now. But still have problems. Graphics not looking good.<br />Is it supposed this 20 bit addr is absolute to CHR-ROM?<br />I mean, for simplicity say i have an unsigned byte * that holds all the CHR data.<br />I have trying making something like:<br />I build the 20 bit addr like so:<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">addr = Mmc5.upper_chr &lt;&lt; 18;<br />addr |= (ex1 &amp; 0x3F) &lt;&lt; 12;<br />addr |= (Ppu.addr &amp; 0xFFF);<br /></div><br /><br />Where Mmc5.upper_chr is reg5130, ex1 is the byte read from extra-ram and Ppu.addr is PPU ADDR reg.<br /><br />For step 3 as natt says i do:<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">biteplane_0 = chrmem&#91;addr&#93;;<br /></div><br />For step 4:<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">biteplane_1 = chrmem&#91;addr | 8&#93;;<br /></div><br />Where chrmem is the whole chr-rom.<br />Is that wrong?

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>natt</b> [ Mon Feb 24, 2014 7:02 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: MMC5 problems...</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">Anes wrote:</div><div class="quotecontent">ok i got it now. But still have problems. Graphics not looking good.<br /></div><br /><br />That all looks correct.  If it's not working right, it's probably a silly transcription error somewhere.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Disch</b> [ Mon Feb 24, 2014 7:57 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: MMC5 problems...</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Are you updating the PPU addr to reflect the tile number?  Or is it still the scroll?  You should be doing the former.<br /><br />Normally the PPU addr has the scroll value in it, but to fetch CHR, it puts the tile number on the bus instead.<br /><br />I was mistaken when I said that was Loopy_V.  I'm kind of rusty.  Loopy_V would be the scroll and that's not correct.  It's actually just the normal address of the CHR to fetch.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Anes</b> [ Mon Feb 24, 2014 7:53 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: MMC5 problems...</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">Disch wrote:</div><div class="quotecontent">Are you updating the PPU addr to reflect the tile number?  Or is it still the scroll?  You should be doing the former.<br /><br />Normally the PPU addr has the scroll value in it, but to fetch CHR, it puts the tile number on the bus instead.<br /><br />I was mistaken when I said that was Loopy_V.  I'm kind of rusty.  Loopy_V would be the scroll and that's not correct.  It's actually just the normal address of the CHR to fetch.</div><br /><br />I don't have a tile_number var i do it all with ppu ADDR.<br />So if i have a tile_number var how is it supposed to be clocked?

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Disch</b> [ Mon Feb 24, 2014 7:59 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: MMC5 problems...</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Nevermind I think I might be confusing you more  =X<br /><br />Check natt's previous post with the fetch pattern again.  That covers it as well as I can.<br /><br />Though again... I really think we might be making this more complicated than it needs to be.  You fetch the CHR the same way as with any other game.  The only difference is the CHR page is selected by the ExRAM byte rather than the CHR swapping regs.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>natt</b> [ Mon Feb 24, 2014 8:11 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: MMC5 problems...</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Post a screenshot of Just Breed?  Might be able to tell something from it.<br /><br />Might not.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Anes</b> [ Tue Feb 25, 2014 3:46 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: MMC5 problems...</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Thanks to Disch and natt now i have:<br /><img src="http://yaneseland.com.ar/temp/uwcrop.png" alt="Image" /><br />Do you see the image cropped in its upper part. It's about four tiles cropped.<br />I suppouse its a scrolling thing, but i cannot find the error.<br />Any Idea??<br /><br />Edit: It seems to be in KOEI games only.

		

		</td>
	</tr>
	</table>


<hr width="85%" />

<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
<tr>
	<td><span class="gensmall">Page <strong>2</strong> of <strong>4</strong></span></td>
	<td align="right"><span class="gensmall">All times are UTC - 7 hours </span></td>
</tr>
<tr>
	<td colspan="2" align="center"><span class="gensmall">Powered by phpBB&reg; Forum Software &copy; phpBB Group<br />http://www.phpbb.com/</span></td>
</tr>
</table>

</body>
</html>