<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html dir="ltr" lang="en-gb">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta http-equiv="Content-Style-Type" content="text/css">
<meta http-equiv="Content-Language" content="en-gb">
<title>nesdev.com :: View topic - puNES Emulator (ex Fnes)</title>

<style type="text/css">
<!--

body {
	font-family: Verdana,serif;
	font-size: 10pt;
}

img {
	border: 0;
}

td {
	font-family: Verdana,serif;
	font-size: 10pt;
	line-height: 150%;
}

.code, .codecontent, 
.quote, .quotecontent {
	margin: 0 5px 0 5px;
	padding: 5px;
	font-size: smaller;
	border: black solid 1px;
}

.quotetitle {
	color: black;
	display : block;
	font-weight: bold;
}

.forum {
	font-family: Arial,Helvetica,sans-serif;
	font-weight: bold;
	font-size: 18pt;
}

.topic {
	font-family: Arial,Helvetica,sans-serif;
	font-size: 14pt;
	font-weight: bold;
}

.gensmall {
	font-size: 8pt;
}

hr {
	color: #888;
	height: 3px;
	border-style: solid;
}

hr.sep {
	color: #aaa;
	height: 1px;
	border-style: dashed;
}
//-->
</style>

</head>
<body>

<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
<tr>
	<td colspan="2" align="center"><span class="Forum">nesdev.com</span><br /><span class="gensmall"><a href="http://forums.nesdev.com/">http://forums.nesdev.com/</a></span></td>
</tr>
<tr>
	<td colspan="2"><br /></td>
</tr>
<tr>
	<td><span class="topic">puNES Emulator (ex Fnes)</span><br /><span class="gensmall"><a href="http://forums.nesdev.com/viewtopic.php?f=3&amp;t=6928">http://forums.nesdev.com/viewtopic.php?f=3&amp;t=6928</a></span></td>
	<td align="right" valign="bottom"><span class="gensmall">Page <strong>21</strong> of <strong>29</strong></span></td>
</tr>
</table>



	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>James</b> [ Mon Jan 13, 2014 7:46 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: Version 0.78</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">FHorse wrote:</div><div class="quotecontent">Improved handling of IRQ in the mapper 64 (&quot;Hard Drivin.nes&quot; now works correctly).<br /></div><br />What do you have to do for this?  I briefly looked into this a few months ago but wasn't able to come up with something that worked for Hard Drivin without breaking other mapper 64 games.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>FHorse</b> [ Mon Jan 13, 2014 8:26 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: Version 0.78</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">James wrote:</div><div class="quotecontent">What do you have to do for this?  I briefly looked into this a few months ago but wasn't able to come up with something that worked for Hard Drivin without breaking other mapper 64 games.</div>Now I'm in the office, I'll answer when I'm back home.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Zepper</b> [ Mon Jan 13, 2014 8:55 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: puNES Emulator (ex Fnes)</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />@James<br /><br />Read <a href="http://wiki.nesdev.com/w/index.php/Talk:RAMBO-1" class="postlink">here</a>. I recently did it for RockNES.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Mezada</b> [ Mon Jan 13, 2014 6:19 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: puNES Emulator (ex Fnes)</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />I think there may be a memory leak in the windows 64 bit version.  First I was noticing this with version 0.72  but then upgraded to 0.77 and still see the memory continue to creek up.<br /><br />I downloaded the windows 32 bit version and there doesn't seem to a leak there. <br /><br />I just thought I'd check and let you know that there may be a problem.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>FHorse</b> [ Tue Jan 14, 2014 1:47 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: puNES Emulator (ex Fnes)</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">Mezada wrote:</div><div class="quotecontent">I think there may be a memory leak in the windows 64 bit version.  First I was noticing this with version 0.72  but then upgraded to 0.77 and still see the memory continue to creek up.<br /><br />I downloaded the windows 32 bit version and there doesn't seem to a leak there. <br /><br />I just thought I'd check and let you know that there may be a problem.</div>Could you be more specific please? I did some test but I have not encountered any problems. If you told me exactly what you noticed and what condition occurs would help me a lot. From now on, I'll write you via private message.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>FHorse</b> [ Tue Jan 14, 2014 3:57 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: Version 0.78</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">James wrote:</div><div class="quotecontent"><div class="quotetitle">FHorse wrote:</div><div class="quotecontent">Improved handling of IRQ in the mapper 64 (&quot;Hard Drivin.nes&quot; now works correctly).<br /></div><br />What do you have to do for this?  I briefly looked into this a few months ago but wasn't able to come up with something that worked for Hard Drivin without breaking other mapper 64 games.</div>after looking at the implementation of Zepper (thx for the link <img src="./images/smilies/icon_smile.gif" alt=":)" title="Smile" />) and was not convinced of my implementation, I continued to experiment with the IRQ of the mapper 64. The solution I found that works regularly with all the roms (Klanx, Skull &amp; Crossbones, Shinobi etc.) is:<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">static void INLINE irq_clock_Tengen_Rambo(void) {<br />&nbsp; &nbsp;/* irqA12.reload = TRUE when something is written in reg $C001 */<br />&nbsp; &nbsp;if (irqA12.reload == TRUE)&nbsp; {<br />&nbsp; &nbsp;&nbsp; &nbsp;if (irqA12.latch &lt;= 1) {<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;irqA12.counter = irqA12.latch + 1;<br />&nbsp; &nbsp;&nbsp; &nbsp;} else {<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;irqA12.counter = irqA12.latch + 2;<br />&nbsp; &nbsp;&nbsp; &nbsp;}<br />&nbsp; &nbsp;&nbsp; &nbsp;irqA12.reload = FALSE;<br />&nbsp; &nbsp;} else if (!irqA12.counter) {<br />&nbsp; &nbsp;&nbsp; &nbsp;irqA12.counter = irqA12.latch + 1;<br />&nbsp; &nbsp;}<br /><br />&nbsp; &nbsp;irqA12.counter--;<br />&nbsp; &nbsp;if (!irqA12.counter &amp;&amp; irqA12.enable) {<br />&nbsp; &nbsp;&nbsp; &nbsp;/* wait one M2 cycle, then trigger IRQ */<br />&nbsp; &nbsp;}<br />}</div>I said, it's just an experiment, but this way everything seems to work fine.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Zepper</b> [ Tue Jan 14, 2014 4:55 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: puNES Emulator (ex Fnes)</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />So, I have to ask: what's the problem with my IRQ suggestion? What's glitched if compared with yours? As I said, I tested the games and see no problems.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>breaker1976</b> [ Tue Jan 14, 2014 6:02 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: puNES Emulator (ex Fnes)</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />game &quot;Trog&quot; - does not work on the emulator.<br />please fix it.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>FHorse</b> [ Tue Jan 14, 2014 7:02 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: puNES Emulator (ex Fnes)</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">Zepper wrote:</div><div class="quotecontent">So, I have to ask: what's the problem with my IRQ suggestion? What's glitched if compared with yours? As I said, I tested the games and see no problems.</div>When I started experimenting I did not know your suggestions, I read your post just after. I just wanted to continue what I had started. Now also try your implementation before but could you explain something that I did not understand:<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">Next CPU clock:<br /><br />&nbsp; &nbsp; IF $C001 was written to after previous clock<br />&nbsp; &nbsp; &nbsp; &nbsp; reload IRQ counter with IRQ Reload value PLUS ONE <br />&nbsp; &nbsp; ELSE IF IRQ counter is 0<br />&nbsp; &nbsp; &nbsp; &nbsp; reload IRQ counter with IRQ Reload value <br /></div>What do you mean with &quot;Next CPU clock&quot;?<br /><div class="quotetitle">breaker1976 wrote:</div><div class="quotecontent">game &quot;Trog&quot; - does not work on the emulator.<br />please fix it.</div> &quot;Trog&quot; works fine in puNES, probably the problem is with some roms on the network that have a dirty iNES header (&quot;!DISKDUDE!&quot;) that contains information about the mapper wrong (66 instead of 2). In the next release will add an entry in the database to automatically set the correct mapper. Thanks for the report.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Zepper</b> [ Tue Jan 14, 2014 7:15 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: puNES Emulator (ex Fnes)</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Hmm... terminology problem. <img src="./images/smilies/icon_smile.gif" alt=":)" title="Smile" /> <br /><br />- Next CPU cycle (or next instruction).

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>thefox</b> [ Tue Jan 14, 2014 7:31 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: puNES Emulator (ex Fnes)</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">Zepper wrote:</div><div class="quotecontent">Hmm... terminology problem. <img src="./images/smilies/icon_smile.gif" alt=":)" title="Smile" /> <br /><br />- Next CPU cycle (or next instruction).</div><br />No, ambiguity problem. &quot;Next CPU clock&quot; is ambiguous unless you specify a reference point (e.g. &quot;the next CPU clock after a write to $1234&quot;).<br /><br />Also, why do you equate &quot;next CPU cycle&quot; with &quot;next instruction&quot;?

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Zepper</b> [ Tue Jan 14, 2014 8:09 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: puNES Emulator (ex Fnes)</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />*shrugs*<br />Yeah, my bad. Sorry for the confusion of &quot;cycle&quot; with &quot;next instruction&quot;. <img src="./images/smilies/icon_sad.gif" alt=":(" title="Sad" /><br /><br />Well, every cycle on 6502 is either a read or a write cycle. So, you update the IRQ counter in the next CPU cycle.<br /><br />Got it?

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>James</b> [ Tue Jan 14, 2014 9:31 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: Version 0.78</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">FHorse wrote:</div><div class="quotecontent"><div class="codetitle"><b>Code:</b></div><div class="codecontent">&nbsp; &nbsp;&nbsp; &nbsp;if (irqA12.latch &lt;= 1) {<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;irqA12.counter = irqA12.latch + 1;<br />&nbsp; &nbsp;&nbsp; &nbsp;} else {<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;irqA12.counter = irqA12.latch + 2;<br />&nbsp; &nbsp;&nbsp; &nbsp;}<br /></div>I said, it's just an experiment, but this way everything seems to work fine.</div><br />Cool.  I saw similar behavior with my hardware tests (i.e., counter sometimes being incremented by latch + 1, sometimes by latch + 2), but I wasn't able to reliably reproduce it/nail down the precise behavior.  I'll give this a try soon.  Thanks!

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>James</b> [ Sat Jan 18, 2014 11:01 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: Version 0.78</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">FHorse wrote:</div><div class="quotecontent">I said, it's just an experiment, but this way everything seems to work fine.</div><br />It's close, but something still isn't quite right.  This line doesn't appear on real hardware (my emulator has the same problem).  Hard Drivin' definitely looks better, but still a little glitchy (I have no idea how it looks on real hardware, though).<br /><br /><img src="http://i.imgur.com/wYVWWkm.png" alt="Image" />

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>FHorse</b> [ Sat Jan 18, 2014 12:55 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: Version 0.78</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">James wrote:</div><div class="quotecontent"><div class="quotetitle">FHorse wrote:</div><div class="quotecontent">I said, it's just an experiment, but this way everything seems to work fine.</div><br />It's close, but something still isn't quite right.  This line doesn't appear on real hardware (my emulator has the same problem).</div>I lost a bit of time studying the problem and I noticed one thing, the only game that uses, during the phases of the game, both IRQ modes (SCANLINE and CPU mode) is just &quot;Skull &amp; Crossbones&quot;. I also noticed that the problem (in &quot;SCANLINE&quot; mode there are a &quot;delay&quot; of one scanline) occurs precisely in the transition between the &quot;CPU mode&quot; to &quot;SCANLINE mode&quot;. Understanding this, I did an experiment assuming that this transition from one mode to another can take place after ANOTHER CLOCK of IRQ in the &quot;previous&quot; mode (&quot;CPU mode&quot;) perhaps for a delay of some sort. To be clear, after the write in the reg $C001, are needed more than four CPU clock cycles before the switch takes place, allowing another clock of irq running the reload. Simulated this, the problem is gone. Unfortunately I have no chance to experiment with hardware this conjecture.<br /><div class="quotetitle">James wrote:</div><div class="quotecontent">Hard Drivin' definitely looks better, but still a little glitchy (I have no idea how it looks on real hardware, though).</div><a href="http://www.lostlevels.org/hard-drivin/" class="postlink">http://www.lostlevels.org/hard-drivin/</a> I think that the video in this page are recorder from a real NES but I'm not sure.

		

		</td>
	</tr>
	</table>


<hr width="85%" />

<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
<tr>
	<td><span class="gensmall">Page <strong>21</strong> of <strong>29</strong></span></td>
	<td align="right"><span class="gensmall">All times are UTC - 7 hours </span></td>
</tr>
<tr>
	<td colspan="2" align="center"><span class="gensmall">Powered by phpBB&reg; Forum Software &copy; phpBB Group<br />http://www.phpbb.com/</span></td>
</tr>
</table>

</body>
</html>