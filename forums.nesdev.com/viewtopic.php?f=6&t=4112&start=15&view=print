<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html dir="ltr" lang="en-gb">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta http-equiv="Content-Style-Type" content="text/css">
<meta http-equiv="Content-Language" content="en-gb">
<title>nesdev.com :: View topic - Modding an Emu to Play Custom Soundtrack for MM2, need help</title>

<style type="text/css">
<!--

body {
	font-family: Verdana,serif;
	font-size: 10pt;
}

img {
	border: 0;
}

td {
	font-family: Verdana,serif;
	font-size: 10pt;
	line-height: 150%;
}

.code, .codecontent, 
.quote, .quotecontent {
	margin: 0 5px 0 5px;
	padding: 5px;
	font-size: smaller;
	border: black solid 1px;
}

.quotetitle {
	color: black;
	display : block;
	font-weight: bold;
}

.forum {
	font-family: Arial,Helvetica,sans-serif;
	font-weight: bold;
	font-size: 18pt;
}

.topic {
	font-family: Arial,Helvetica,sans-serif;
	font-size: 14pt;
	font-weight: bold;
}

.gensmall {
	font-size: 8pt;
}

hr {
	color: #888;
	height: 3px;
	border-style: solid;
}

hr.sep {
	color: #aaa;
	height: 1px;
	border-style: dashed;
}
//-->
</style>

</head>
<body>

<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
<tr>
	<td colspan="2" align="center"><span class="Forum">nesdev.com</span><br /><span class="gensmall"><a href="http://forums.nesdev.com/">http://forums.nesdev.com/</a></span></td>
</tr>
<tr>
	<td colspan="2"><br /></td>
</tr>
<tr>
	<td><span class="topic">Modding an Emu to Play Custom Soundtrack for MM2, need help</span><br /><span class="gensmall"><a href="http://forums.nesdev.com/viewtopic.php?f=6&amp;t=4112">http://forums.nesdev.com/viewtopic.php?f=6&amp;t=4112</a></span></td>
	<td align="right" valign="bottom"><span class="gensmall">Page <strong>2</strong> of <strong>3</strong></span></td>
</tr>
</table>



	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>ugetab</b> [ Sat May 17, 2008 2:20 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Take a look at the coding for NSFs. That has custom addresses in action. 5FF8-5FFF control standard channels. If you have reads return 00 or 01 depending on external music availability, you can have writes to this address affect the music being played.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>kalzone</b> [ Sun May 18, 2008 2:31 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Well, it's finished up and packaged with all the necessary files to make it work properly (except the rom and some of the music)...but I have a kind of unrelated question.  What's a good site I can use to host it?  I'm a little iffy about posting it one of these normal hosting sites like Filefactory/Fileshack etc. based on the content..

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>tepples</b> [ Sun May 18, 2008 6:05 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">kalzone wrote:</div><div class="quotecontent">What's a good site I can use to host it?</div>
<br />Go Daddy hosting costs money per year, but at least I think it's worth it.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>kalzone</b> [ Sun May 18, 2008 6:06 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />That's all right, I just stuck it on Rapidshare, should be good enough.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>tepples</b> [ Sun May 18, 2008 6:39 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Anything but Rapidshare!</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><a href="http://www.tetrisconcept.com/forum/viewtopic.php?p=20663#20663" class="postlink">Lately, Rapidshare has been next to impossible to download from</a>. Either you have to solve what might be the hardest <a href="http://en.wikipedia.org/wiki/CAPTCHA" class="postlink">CAPTCHA</a> on the Internet, or you have to pay. The members of tetrisconcept.com appear to recommend Mediafire or Sendspace or Zshare.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Zepper</b> [ Fri May 23, 2008 8:16 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />- Did you take care about *stopping the music*? If mind is good, the code is FEh or FFh. ^_^;; Just wondering since you mentioned "things ready".
<br />
<br />- I can't wait to give a try. <img src="./images/smilies/icon_wink.gif" alt=";)" title="Wink" />

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>kalzone</b> [ Fri May 23, 2008 8:52 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />There's no need to stop the music (except possibly when the emulator is paused, but I didn't bother to add that in)...every time the music is "stopped" it's only because something else is about to be played, so that handles itself.
<br />
<br />Anyway, for anyone who <em>does</em> want to give a try, you can download it <a href="http://rapidshare.com/files/115903911/VirtualNES_-_MM2Custom.rar" class="postlink">here</a>.  It's still on Rapidshare though, so be careful with that CAPTCHA, it's a doozy, apparently.  The rom and some of the MP3's aren't included for legal issues, though, so I'm not sure how much use you'll get out of it unless you find all that.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Hamtaro126</b> [ Sat May 24, 2008 3:06 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">kalzone wrote:</div><div class="quotecontent">There's no need to stop the music (except possibly when the emulator is paused, but I didn't bother to add that in)...every time the music is "stopped" it's only because something else is about to be played, so that handles itself.<br /><br />Anyway, for anyone who <em>does</em> want to give a try, you can download it <a href="http://rapidshare.com/files/115903911/VirtualNES_-_MM2Custom.rar" class="postlink">here</a>.  It's still on Rapidshare though, so be careful with that CAPTCHA, it's a doozy, apparently.  The rom and some of the MP3's aren't included for legal issues, though, so I'm not sure how much use you'll get out of it unless you find all that.</div>
<br />
<br />Can I please have permission to use a Windows (32bit EXE) Disassembler to privately use your code to make it handle the Mario Series, And only release it in EXEcutable form? Mario Hackers really need it too, I give credit for the permissive use of disassembled code

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Zepper</b> [ Sat May 24, 2008 8:04 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Heh, under the condition YOU know how to handle Mario's music playback, okay? <img src="./images/smilies/icon_wink.gif" alt=";)" title="Wink" />

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>kalzone</b> [ Sat May 24, 2008 8:46 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><em>My</em> code?   Whoa...let's take a step back here...the original emulator is under the GNU public license; you and everyone else here has full rights to the source...I just figured it was too sloppy for it to be particularly useful to anyone.  If there's actually a demand I'll go ahead and post the source.  I need to switch to my other computer but give me a few minutes and I'll have it up.  Fair warning: the sections I added are not commented at all.
<br />
<br />In the same vein though...if you use this code for your Mario hack, you're basically obligated to release the source.
<br />
<br />The thing is...my code is really designed to be generalized, for the most part.  The MP3 playing code is fully self-contained (and mostly ripped from Metal MAME, actually)...but the code that triggers it is based on a specific sequence of instructions in the MM2 code.  I'm not really sure how similar this sequence may be to that of other games, but I'm sure someone here could help.[/i]

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>kalzone</b> [ Sat May 24, 2008 9:04 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Here it is: <!-- m --><a class="postlink" href="http://rapidshare.com/files/117415759/virtualnes.rar.html">http://rapidshare.com/files/117415759/v ... s.rar.html</a><!-- m -->

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Hamtaro126</b> [ Sat May 24, 2008 10:04 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">Fx3 wrote:</div><div class="quotecontent">Heh, under the condition YOU know how to handle Mario's music playback, okay? <img src="./images/smilies/icon_wink.gif" alt=";)" title="Wink" /></div>
<br />
<br />Yea, I know how to delete mario's music data. But also know to see if the music is playing
<br />
<br />Kalzone: Thank you for distributing the code, I will give you credit for using it.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>kalzone</b> [ Sat May 24, 2008 10:07 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />If you already know all that, I'm not sure my code will really be any help, but good luck either way.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Hamtaro126</b> [ Sat May 24, 2008 10:42 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">kalzone wrote:</div><div class="quotecontent">If you already know all that, I'm not sure my code will really be any help, but good luck either way.</div>
<br />
<br />I do not know how to make music, Just know how to delete music in SMB1.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>kalzone</b> [ Sat May 24, 2008 11:11 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Oh, I was referring more to the "know if music is playing" part.  The major difficulty I had with this project was just figuring out when exactly to play to the music...if you've got that down, then most of your work is already finished.
<br />
<br />Anyway, because I hardly commented at all on the portions I edited, here's a few pointers:
<br />-MP3play.h/MP3play.cpp is where all of the MP3 playback capabilities are
<br />-The PlayFile function takes 4 arguments:
<br />     File path/name (and make sure to start that with a '/')
<br />     Whether the file loops or not (1 if it does, 0 if it doesn't)
<br />     Sample to begin the loop (int)
<br />     Sample to end the loop (int)
<br />-The code that actually calls MP3play::PlayFile() is in Cpu.cpp
<br />-This was briefly mentioned in a previous post, but the basic design is as follows:
<br />
<br />There are two distinct blocks of instructions that mark the playing of a new sound effect or song in MM2:
<br />
<br />LDA $XX ($XX = song/sfx identifier)
<br />JSR $C051
<br />
<br />...and...
<br />
<br />LDA $XXXX, $XX ($XX = song/sfx identifier)
<br />JSR $C051
<br />
<br />The implentations of all of these instructions are located in the CPU.cpp source file.  So, in MR_AX() and MR_IM(), which are called as part of the LDA opcodes (which one is called is dependent on whether the instruction is LDA $XXXX, $XX or LDA $XX), a BYTE variable named songCounter is set to whatever the current value of DT (the BYTE data being used with the instruction) is.
<br />
<br />Then, whenever JSR is called, EA (the WORD used in the instruction) is checked against $C051.  If EA==0xC051, then a switch statement just calls PlayFile according to the current value of songCounter.  With this implementation, theoretically all sound effects could be replaced as well.
<br />
<br />There is one exception, however.  Through testing, it became apparent that Heat Man's weapon sfx had the same "sound effect number" as the "stage selected" music, so firing his weapon just causes that music to play over and over.  The boolean value stageSelected was introduced to prevent this particular case.  By default, stageSelected is false.  When a call is made to play the "stage selection" music, it is assumed that the "stage selected" music will follow before Heat Man's weapon would be fired.  Therefore, stageSelected is set to true whenever the "stage selection" music plays, and reset to false afterward.
<br />
<br />So there you have it, a more thorough description of my modifications.  Hopefully that'll help a bit, as much of what I described is specific to MM2, and now you have a better idea of what needs tweaking and what can be outright removed when working with another game.

		

		</td>
	</tr>
	</table>


<hr width="85%" />

<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
<tr>
	<td><span class="gensmall">Page <strong>2</strong> of <strong>3</strong></span></td>
	<td align="right"><span class="gensmall">All times are UTC - 7 hours </span></td>
</tr>
<tr>
	<td colspan="2" align="center"><span class="gensmall">Powered by phpBB&reg; Forum Software &copy; phpBB Group<br />http://www.phpbb.com/</span></td>
</tr>
</table>

</body>
</html>