<?xml version="1.0" encoding="UTF-8"?>
<feed xmlns="http://www.w3.org/2005/Atom" xml:lang="en-gb">
<link rel="self" type="application/atom+xml" href="http://forums.nesdev.com/feed.php?f=10&amp;t=12048" />

<title>nesdev.com</title>
<subtitle>NES Development and Strangulation Records message boards</subtitle>
<link href="http://forums.nesdev.com/index.php" />
<updated>2014-11-22T22:03:00-07:00</updated>

<author><name><![CDATA[nesdev.com]]></name></author>
<id>http://forums.nesdev.com/feed.php?f=10&amp;t=12048</id>
<entry>
<author><name><![CDATA[deltnis]]></name></author>
<updated>2014-11-22T22:03:00-07:00</updated>
<published>2014-11-22T22:03:00-07:00</published>
<id>http://forums.nesdev.com/viewtopic.php?t=12048&amp;p=136792#p136792</id>
<link href="http://forums.nesdev.com/viewtopic.php?t=12048&amp;p=136792#p136792"/>
<title type="html"><![CDATA[Re: How to make FamiTone2 to work with NESASM]]></title>

<content type="html" xml:base="http://forums.nesdev.com/viewtopic.php?t=12048&amp;p=136792#p136792"><![CDATA[
Thanks for your replying again!<br /><br />I didn't noticed that I updated to many times...<br />In this time, BGM is played completely correctly.<br /><br />I'm going to study about NES more from now on.<br /><br />Thank you a lot!<br /><br /><br />P.S. I think this song is nice too. So I covered this music, and I'm glad to play this song<br />on NES  <img src="http://forums.nesdev.com/images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /><p>Statistics: Posted by <a href="http://forums.nesdev.com/memberlist.php?mode=viewprofile&amp;u=6783">deltnis</a> — Sat Nov 22, 2014 10:03 pm</p><hr />
]]></content>
</entry>
<entry>
<author><name><![CDATA[Kasumi]]></name></author>
<updated>2014-11-22T15:40:15-07:00</updated>
<published>2014-11-22T15:40:15-07:00</published>
<id>http://forums.nesdev.com/viewtopic.php?t=12048&amp;p=136780#p136780</id>
<link href="http://forums.nesdev.com/viewtopic.php?t=12048&amp;p=136780#p136780"/>
<title type="html"><![CDATA[Re: How to make FamiTone2 to work with NESASM]]></title>

<content type="html" xml:base="http://forums.nesdev.com/viewtopic.php?t=12048&amp;p=136780#p136780"><![CDATA[
The only thing in the way of the music is that you have two instances of jsr FamiToneUpdate. You only want one.<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">infinityLoop:               ; waiting for VBlank interruption<br />   ;jsr FamiToneUpdate;You don't want this here.<br />   jmp infinityLoop<br /></div><br />The clear RAM was also added incorrectly. It lacks the ldx #$00, and the lda #$FF and sta $0300,x were moved outside the loop.<br /><br />The whole clearram should look like this if you uncomment everything:<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">   ldx #$00<br />clearram:<br />   lda #$00<br />   sta $0000,x<br />   sta $0100,x<br />   sta $0200,x<br /><br />   lda #$FF<br />   sta $0300,x<br />   <br />   lda #$00<br />   sta $0400,x<br />   sta $0500,x<br />   sta $0600,x<br />   sta $0700,x<br />   inx<br />    bne clearram<br /></div><br />That's all. If for some reason it still doesn't work, let me know what emulator you're using. Tested on (oldish versions of) FCEUX, Nestopia, VirtuaNES and Nintendulator and it works as expected with those changes.<p>Statistics: Posted by <a href="http://forums.nesdev.com/memberlist.php?mode=viewprofile&amp;u=3504">Kasumi</a> — Sat Nov 22, 2014 3:40 pm</p><hr />
]]></content>
</entry>
<entry>
<author><name><![CDATA[deltnis]]></name></author>
<updated>2014-11-22T12:07:56-07:00</updated>
<published>2014-11-22T12:07:56-07:00</published>
<id>http://forums.nesdev.com/viewtopic.php?t=12048&amp;p=136775#p136775</id>
<link href="http://forums.nesdev.com/viewtopic.php?t=12048&amp;p=136775#p136775"/>
<title type="html"><![CDATA[Re: How to make FamiTone2 to work with NESASM]]></title>

<content type="html" xml:base="http://forums.nesdev.com/viewtopic.php?t=12048&amp;p=136775#p136775"><![CDATA[
Thank you for your replying !<br /><br />I didn't know that I had to enable volume effect and gain the volume level.<br /><br />So I enabled volume effect, but still BGM is not played...<br />Bankswitching, address pointing, position of FamiTone2-related parts in my code are wrong?<br /><br />I upload the code and materials. This time, the code includes FamiTone2-related parts.<br />What parts in my code are wrong?(It is clear that my code is badly awful)<br /><br />I know my knowledge of NES's structure and others is lacked, and I'm asking dumb questions.<br />I also know I have to study about them sufficiently at first, but I'm eager to play BGM for the time being.<br /><br />thank you.<p>Statistics: Posted by <a href="http://forums.nesdev.com/memberlist.php?mode=viewprofile&amp;u=6783">deltnis</a> — Sat Nov 22, 2014 12:07 pm</p><hr />
]]></content>
</entry>
<entry>
<author><name><![CDATA[Kasumi]]></name></author>
<updated>2014-11-22T09:04:26-07:00</updated>
<published>2014-11-22T09:04:26-07:00</published>
<id>http://forums.nesdev.com/viewtopic.php?t=12048&amp;p=136770#p136770</id>
<link href="http://forums.nesdev.com/viewtopic.php?t=12048&amp;p=136770#p136770"/>
<title type="html"><![CDATA[Re: How to make FamiTone2 to work with NESASM]]></title>

<content type="html" xml:base="http://forums.nesdev.com/viewtopic.php?t=12048&amp;p=136770#p136770"><![CDATA[
Welcome, deltnis.<br /><br />I am reluctant to just upload fixed files. But I will show what to do. You were probably adding the correct code to your program to make a song play. But the only instrument you are using does not have a volume effect attached to it. Famitone seems to play instruments without a volume effect as silent. Here is an image showing how to add this:<br /><br />add volume effect.gif<br />Then export the text, and use text2data.exe as you did before to create a new ShanghaiTea.asm.<br /><br /><br />After that, add the following code somewhere in bank 0.<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">   .include &quot;famitone2.asm&quot;<br />   .include &quot;ShanghaiTea.asm&quot;<br /></div><br /><br />Add these lines before you allow NMIs and enable the display of sprites and the BG.<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">   ldx #LOW(ShanghaiTea_music_data)<br />   ldy #HIGH(ShanghaiTea_music_data)<br />   lda #$80;This sets Famitone to use NTSC mode.<br />   jsr FamiToneInit<br /><br />   lda #0;Play first subsong<br />   jsr FamiToneMusicPlay<br /><br />   ;The below lines are already there. Here for context.<br />   ; Initialize PPU controling register<br />   lda #%00011110   ; enable the display of sprite and BG<br />   sta $2001<br /></div><br /><br />In your NMI routine (VBlank interrupting handler), add this:<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">NOTHINGdown:<br />   jsr setSprite2<br />   ;This needs to be run every frame to play the song.<br />   ;It is best to do it last<br />   jsr FamiToneUpdate;Other lines here for context<br /><br />   rti<br /></div><br /><br /><br />Now, in famitone2.asm, uncomment these lines at the top:<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent"><br />FT_BASE_ADR      = $0400   ;page in the RAM used for FT2 variables, should be $xx00<br /><br />;-------------------------------------<br />;Note that FT_BASE_ADR has been changed from <br />;$0300 to $0400. Your sprites use $0300 so you<br />;must change this to make Famitone use<br />;different RAM<br />'----------------------------------<br />FT_TEMP         = $00   ;3 bytes in zeropage used by the library as a scratchpad<br /><br />;-----------------------------------------<br />;FT_TEMP has not been changed, since<br />;you are not using any zero page ($0000-$00FF) RAM <br />;in your program. If you were, you would need<br />;to make sure Famitone did not conflict with it<br />;by changing FT_TEMP.<br />;-----------------------------------------<br /><br />FT_DPCM_OFF      = $c000   ;$c000..$ffc0, 64-byte steps<br />; FT_SFX_STREAMS   = 4      ;number of sound effects played at once, 1..4<br /><br />; FT_DPCM_ENABLE         ;undefine to exclude all DMC code<br />; FT_SFX_ENABLE         ;undefine to exclude all sound effects code<br />; FT_THREAD            ;undefine if you are calling sound effects from the same thread as the sound update call<br /><br />; FT_PAL_SUPPORT         ;undefine to exclude PAL support<br />FT_NTSC_SUPPORT         ;undefine to exclude NTSC support<br /></div><br /><br /><strong>With those changes your program will play your song in any emulator that ran the program before. The rest of the post recommends things that will make your game run better on real hardware.</strong><br /><br /><br />Your program does not do much initialization, and may behave strangely on real hardware.<br /><br />You are already waiting one frame before you start your program. It is good to wait at least two, because the PPU needs to warm up.<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">   lda $2002;These makes sure the 7th bit of $2002 is<br />   ;clear for the loop below<br /><br />waitVSync:<br />   lda $2002<br />   bpl waitVSync  ; wait while 7th bit of $2002 is 1 (VBlank occuring)<br /><br /><br />waitVSync2:<br />   lda $2002<br />   bpl waitVSync2  ; wait once more for safety<br /></div><br /><br />I am not sure how familiar you are with the stack (It uses $0100-$01FF going backwards), but setting it up is a good idea. It is actually not <em>required</em>, but it allows you to safely use some of the bottom of the RAM reserved for the stack for your program.<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">waitVSync2:<br />   lda $2002<br />   bpl waitVSync2  ; wait once more for safety<br /><br />   ldx #$FF<br />   txs;Set up stack<br /></div><br /><br />NES does not begin with all RAM set to zero like many emulators do. Your sprites are drawn from RAM, so you may have random sprites on screen if you don't initialize it. Adding the code below will avoid that.<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">   cpx #32;These lines are already in your program<br />   bne loadPal;They are here for context<br /><br />   ldx #$00<br />clearram:<br />   ;lda #$00<br />   ;sta $0000,x<br />   ;sta $0100,x<br />   ;sta $0200,x<br />   <br /><br />   lda #$FF;#$FF is a Y position below the screen<br />   ;So writing it to every value in your sprite RAM<br />   ;at the beginning ensures no sprites you do not<br />   ;want are on screen.<br />   sta $0300,x;Store #$FF to sprite page.<br />   <br />   ;lda #$00<br />   ;sta $0400,x<br />   ;sta $0500,x<br />   ;sta $0600,x<br />   ;sta $0700,x<br />   inx<br />   bne clearram<br /></div><br />In addition, uncommenting the other ldas and stas will set all RAM that is not the sprite RAM to zero. This is not <em>required</em>, as long as you always initialize RAM before you use it. Note that you are not initializing Sprite1_T, Sprite1_S, and Sprite2_T. So after doing the above, you will need to add some code so the sprites you have will display correctly:<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">   lda X_Pos_Init<br />   sta Sprite1_X<br />   lda Y_Pos_Init<br />   sta Sprite1_Y<br />   <br />   lda #%00000000<br />   sta Sprite1_S;<br />   lda #$00<br />   sta Sprite1_T<br /><br />   jsr setSprite2<br /><br />   lda #%01000000<br />   sta Sprite2_S<br />   lda #$00<br />   sta Sprite2_T<br /></div><br />As it was, your sprites were unlikely to work on real hardware. <br /><br />The NES also does not initialize the background before power on, so whatever random things were there before power on will still be there unless you change them. You do not have different background tiles yet, but the below will set all of the background to zero.<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">   lda #$00;This line was recommended above<br />   sta Sprite2_T;Here for context.<br />   <br />clearnametables:   <br />   lda #$20;The first nametable (background) begins at $2000<br />   sta $2006<br />   lda #$00<br />   sta $2006<br />   <br />   ldy #$00;This loops through all background data<br />   ;writing tile zero and palette zero to it<br />   ldx #$0C<br />clearnext:<br />   sta $2007<br />   iny<br />   bne clearnext<br />   dex<br />   bne clearnext<br /></div><br /><br />With all of those changes, your game is also very likely to work on the real console. Good luck! Also, your song is very catchy. <br /><br />Edit: I totally had to look up the song. <a href="http://www16.big.or.jp/~zun/html/mcdtop.html" class="postlink">A cover of a thing from here.</a> Neat!<p>Statistics: Posted by <a href="http://forums.nesdev.com/memberlist.php?mode=viewprofile&amp;u=3504">Kasumi</a> — Sat Nov 22, 2014 9:04 am</p><hr />
]]></content>
</entry>
<entry>
<author><name><![CDATA[deltnis]]></name></author>
<updated>2014-11-22T00:37:59-07:00</updated>
<published>2014-11-22T00:37:59-07:00</published>
<id>http://forums.nesdev.com/viewtopic.php?t=12048&amp;p=136768#p136768</id>
<link href="http://forums.nesdev.com/viewtopic.php?t=12048&amp;p=136768#p136768"/>
<title type="html"><![CDATA[How to make FamiTone2 to work with NESASM]]></title>

<content type="html" xml:base="http://forums.nesdev.com/viewtopic.php?t=12048&amp;p=136768#p136768"><![CDATA[
I'd like to use FamiTone2 library in my homebrew NES game. I'm using NESASM for making NES.<br />So I write made music, output data, and wrote the code as the explanation(readme.txt) says.<br /><br />But the NES I made do not work as I want to do (music is not played).<br /><br />Although I read FamiTone 2's explanation, and was going to write as explanation says,<br />I do not think I was able to write approrpiate code.<br /><br />So I tried to find some solution from demo.asm, but it is wrote for ASM6, so I cannot make sense<br />how to do from the demo code.<br /><br />I attach the source code which is without FamiTone2-related code(only BGM, no SE or DPCM data), sprite and BG chr file, pallet data,<br />and music data (for including). <br /><br />And if you do not mind, I'd be glad if you rewrite my code to work FamiTracker 2's libraries.<br />I'd like to just add BGM playing to uploaded game. Please do not change other parts(sprite displaying, sprite movement following to input of pad, etc.).<br />It is better that BGM starts playing with the game launched.<br /><br />I'm Jap and noob, so my English and questions are awful, but please forgive.<br /><br /><br />Thank you.<p>Statistics: Posted by <a href="http://forums.nesdev.com/memberlist.php?mode=viewprofile&amp;u=6783">deltnis</a> — Sat Nov 22, 2014 12:37 am</p><hr />
]]></content>
</entry>
</feed>