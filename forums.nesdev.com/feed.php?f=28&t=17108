<?xml version="1.0" encoding="UTF-8"?>
<feed xmlns="http://www.w3.org/2005/Atom" xml:lang="en-gb">
<link rel="self" type="application/atom+xml" href="http://forums.nesdev.com/feed.php?f=28&amp;t=17108" />

<title>nesdev.com</title>
<subtitle>NES Development and Strangulation Records message boards</subtitle>
<link href="http://forums.nesdev.com/index.php" />
<updated>2018-03-03T19:39:42-07:00</updated>

<author><name><![CDATA[nesdev.com]]></name></author>
<id>http://forums.nesdev.com/feed.php?f=28&amp;t=17108</id>
<entry>
<author><name><![CDATA[krzysiobal]]></name></author>
<updated>2018-03-03T19:39:42-07:00</updated>
<published>2018-03-03T19:39:42-07:00</published>
<id>http://forums.nesdev.com/viewtopic.php?t=17108&amp;p=214559#p214559</id>
<link href="http://forums.nesdev.com/viewtopic.php?t=17108&amp;p=214559#p214559"/>
<title type="html"><![CDATA[SMB2J Repro]]></title>

<content type="html" xml:base="http://forums.nesdev.com/viewtopic.php?t=17108&amp;p=214559#p214559"><![CDATA[
Super Mario Bros 2 JAPANESE (a'ka Lost Levels) is quite interesting game. It was officially released only on Famicom Disk System floppy disk and those cartridge versions that exists are pirate ports from FDS. There exists many ports which are using different hardware solutions and thus - are emulated under different mapper numbers, like<br /><!-- m --><a class="postlink" href="http://wiki.nesdev.com/w/index.php/INES_Mapper_040">http://wiki.nesdev.com/w/index.php/INES_Mapper_040</a><!-- m --><br /><!-- m --><a class="postlink" href="http://wiki.nesdev.com/w/index.php/INES_Mapper_050">http://wiki.nesdev.com/w/index.php/INES_Mapper_050</a><!-- m --><br />and probably many others.<br /><br />There are some examples of actual cartridges:<br /><a href="https://obrazki.elektroda.pl/7740474900_1520128401.jpg" class="postlink"><img src="https://obrazki.elektroda.pl/7740474900_1520128401_thumb.jpg" alt="Image" /></a> <a href="https://obrazki.elektroda.pl/6482488700_1520128403.png" class="postlink"><img src="https://obrazki.elektroda.pl/6482488700_1520128403_thumb.jpg" alt="Image" /></a> <br /><br /><a href="https://obrazki.elektroda.pl/3941191500_1520128615.png" class="postlink"><img src="https://obrazki.elektroda.pl/3941191500_1520128615_thumb.jpg" alt="Image" /></a> <a href="https://obrazki.elektroda.pl/4260358200_1520128619.png" class="postlink"><img src="https://obrazki.elektroda.pl/4260358200_1520128619_thumb.jpg" alt="Image" /></a> <a href="https://obrazki.elektroda.pl/9374459900_1520128619.jpg" class="postlink"><img src="https://obrazki.elektroda.pl/9374459900_1520128619_thumb.jpg" alt="Image" /></a> <a href="https://obrazki.elektroda.pl/2434736900_1520128620.png" class="postlink"><img src="https://obrazki.elektroda.pl/2434736900_1520128620_thumb.jpg" alt="Image" /></a> <br /><br /><a href="https://obrazki.elektroda.pl/8527241900_1520128677.png" class="postlink"><img src="https://obrazki.elektroda.pl/8527241900_1520128677_thumb.jpg" alt="Image" /></a> <a href="https://obrazki.elektroda.pl/3385491800_1520128677.png" class="postlink"><img src="https://obrazki.elektroda.pl/3385491800_1520128677_thumb.jpg" alt="Image" /></a> <a href="https://obrazki.elektroda.pl/8292460400_1520128718.png" class="postlink"><img src="https://obrazki.elektroda.pl/8292460400_1520128718_thumb.jpg" alt="Image" /></a> <br /><br />Quite interesting fact is that even the total size of memories used on such cartridges differ. Probably it consists of FDS Bios (modified) and dumped PRG/CHR from floppy.<br /><br />I was asked to make reproduction of Super Mario Bros. 4 (FDS Conversion)(Unl)[!] (which is hack of SMB2J that runs on mapper 40). The mapper is quite simple and as a good exercise I did not want to make it on FPGA, but use as little discrete discrete chips as possible.<br /><br /><strong>Mapper overview:</strong><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">Range,Mask:   $8000-FFFF, $E000<br /><br />   $8000:  Disable and acknowledge IRQ<br />   $A000:  Enable IRQ<br />   $E000:  8 KiB bank mapped at $C000<br /> <br /> PRG Setup:<br /> ---------------------------<br /> <br />       $6000   $8000   $A000   $C000   $E000  <br />     +-------+-------+-------+-------+-------+<br />     | { 6 } | { 4 } | { 5 } | $E000 | { 7 } |<br />     +-------+-------+-------+-------+-------+<br /></div><br /><br />Ok, so here is my brief thoughts how I would do that with a list of chips that I would probably need:<br />* 4020 + 1/2 7474 -&gt; IRQ counter + IRQ ack &amp; en/dis<br />* 1/2 74139 -&gt; decoding $8000/$a000/$c000/$e000 for writes<br />* 74670 -&gt; register to store PRG bank (I needed one with three state outputs)<br />* and probably one/two gates as glue logic<br /><br />But how to make this fancy fixed-banks? Well, let's look at it in the binary:<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">BANK   /ROMSEL CPU CPU | PRG PRG PRG<br />               A14 A13 | A15 A14 A13<br />-----------------------+------------            <br />$6000     1    1   1   |  1   1   0<br />$8000     0    0   0   |  1   0   0<br />$a000     0    0   1   |  1   0   1<br />$c000     0    1   0   |  *   *   *<br />$e000     0    1   1   |  1   1   1<br /></div><br /><br />Now it reveals why I wanted three state outputs register - if we are not in $c000, we can use pullup resistor to force value of PRG lines to:<br />PRG A15 &lt;- 1<br />PRG A14 &lt;- CPU A14<br />PRG A13 &lt;- CPU A13 when /ROMSEL = 0 else 0<br /><br />What about the `else` part of PRG A13? Diode can be used as a second branch of `if`:<br /><img src="https://obrazki.elektroda.pl/1267170200_1520129880.png" alt="Image" /><br /><br />There are some minor things to do:<br />* Activate PRG-ROM at $6000-$FFFF + prevent bus conflict <br />* Activte register outputs only at $c000-$dfff<br />All of this I did using only 2/4 of 7400 + some dide logic<br /><br />Here is final schematics + photos of final version of cartridge:<br /><a href="https://obrazki.elektroda.pl/1038600900_1520130866.jpg" class="postlink"><img src="https://obrazki.elektroda.pl/1038600900_1520130866_thumb.jpg" alt="Image" /></a> <a href="https://obrazki.elektroda.pl/8612433200_1520130867.jpg" class="postlink"><img src="https://obrazki.elektroda.pl/8612433200_1520130867_thumb.jpg" alt="Image" /></a> <a href="https://obrazki.elektroda.pl/6018369900_1520130867.jpg" class="postlink"><img src="https://obrazki.elektroda.pl/6018369900_1520130867_thumb.jpg" alt="Image" /></a> <a href="https://obrazki.elektroda.pl/4183392300_1520131121.png" class="postlink"><img src="https://obrazki.elektroda.pl/4183392300_1520131121_thumb.jpg" alt="Image" /></a> <br /><br />I still have 1/2 of 7474 not used, which can be used as.. poor man's NOT gate ;D <br /><br />---<br /><br />Cartridge has not started since first run, because:<br />* I forgot to solder some of the ICs pins at TOP layer (when making double side PCB, i prefer to trace it that way so all chips are soldered only at bottom side. Other connections are made by wires acting as vias), but this time I wanted to make as little vias as possible and use chip leg's as vias<br />* I forgot to add inverted between 4020's output and /IRQ<br />* I connected 4020's Q12, instead of Q13,<br />* Those diode AND/NOT are not the best use. Firstly, I used 1k resistors, but voltage drop on diode for 0 logic level was too much (~0.8V). After switching to 3.3k it is ~0.7V (which should be sufficient),<br />* The 2764 EPROM used as CHR-ROM caused troubles during programming (I had to program it many times to change all bytes into correct values). But it still gives inconsistent reads, I need to replace it.<p>Statistics: Posted by <a href="http://forums.nesdev.com/memberlist.php?mode=viewprofile&amp;u=4898">krzysiobal</a> — Sat Mar 03, 2018 7:39 pm</p><hr />
]]></content>
</entry>
</feed>