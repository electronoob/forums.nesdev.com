<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en-gb" xml:lang="en-gb">
<head>

<link rel="icon" href="/favicon.ico" type="image/x-icon" />
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
<meta http-equiv="content-language" content="en-gb" />
<meta http-equiv="content-style-type" content="text/css" />
<meta http-equiv="imagetoolbar" content="no" />
<meta name="resource-type" content="document" />
<meta name="distribution" content="global" />
<meta name="keywords" content="" />
<meta name="description" content="" />

<title>nesdev.com &bull; View topic - Sprite Overlapping Problem</title>

<link rel="alternate" type="application/atom+xml" title="Feed - nesdev.com" href="http://forums.nesdev.com/feed.php" /><link rel="alternate" type="application/atom+xml" title="Feed - News" href="http://forums.nesdev.com/feed.php?mode=news" /><link rel="alternate" type="application/atom+xml" title="Feed - All forums" href="http://forums.nesdev.com/feed.php?mode=forums" /><link rel="alternate" type="application/atom+xml" title="Feed - New Topics" href="http://forums.nesdev.com/feed.php?mode=topics" /><link rel="alternate" type="application/atom+xml" title="Feed - Active Topics" href="http://forums.nesdev.com/feed.php?mode=topics_active" /><link rel="alternate" type="application/atom+xml" title="Feed - Forum - NESemdev" href="http://forums.nesdev.com/feed.php?f=3" /><link rel="alternate" type="application/atom+xml" title="Feed - Topic - Sprite Overlapping Problem" href="http://forums.nesdev.com/feed.php?f=3&amp;t=3402" />

<link rel="stylesheet" href="./style.php?id=1&amp;lang=en" type="text/css" />

<script type="text/javascript">
// <![CDATA[


function popup(url, width, height, name)
{
	if (!name)
	{
		name = '_popup';
	}

	window.open(url.replace(/&amp;/g, '&'), name, 'height=' + height + ',resizable=yes,scrollbars=yes,width=' + width);
	return false;
}

function jumpto()
{
	var page = prompt('Enter the page number you wish to go to:', '1');
	var per_page = '';
	var base_url = '';

	if (page !== null && !isNaN(page) && page == Math.floor(page) && page > 0)
	{
		if (base_url.indexOf('?') == -1)
		{
			document.location.href = base_url + '?start=' + ((page - 1) * per_page);
		}
		else
		{
			document.location.href = base_url.replace(/&amp;/g, '&') + '&start=' + ((page - 1) * per_page);
		}
	}
}

/**
* Find a member
*/
function find_username(url)
{
	popup(url, 760, 570, '_usersearch');
	return false;
}

/**
* Mark/unmark checklist
* id = ID of parent container, name = name prefix, state = state [true/false]
*/
function marklist(id, name, state)
{
	var parent = document.getElementById(id);
	if (!parent)
	{
		eval('parent = document.' + id);
	}

	if (!parent)
	{
		return;
	}

	var rb = parent.getElementsByTagName('input');
	
	for (var r = 0; r < rb.length; r++)
	{
		if (rb[r].name.substr(0, name.length) == name)
		{
			rb[r].checked = state;
		}
	}
}



// ]]>
</script>
</head>
<body class="ltr">

<a name="top"></a>

<div id="wrapheader">

	<div id="logodesc">
	</div>

	<div id="menubar">

		<table width="100%" cellspacing="0">
		<tr>
			<td rowspan="2"><a href="./index.php"><img src="./styles/subsilver2/imageset/site_logo.gif" alt="" title="" /></a></td>
			<td width="100%" align="center"><h1>nesdev.com</h1><span class="gen">NES Development and Strangulation Records message boards</span></td>
		</tr>
		<tr>
			<td align="center">
				<a href="./faq.php"><img src="./styles/prosilver/theme/images/icon_mini_faq.gif" width="12" height="13" alt="*" /> FAQ</a>
				&nbsp; &nbsp;<a href="./search.php"><img src="./styles/prosilver/theme/images/icon_mini_search.gif" width="12" height="13" alt="*" /> Search</a>
				<br />	
				 &nbsp;<a href="./ucp.php?mode=register"><img src="./styles/prosilver/theme/images/icon_mini_register.gif" width="12" height="13" alt="*" /> Register</a>
					&nbsp; &nbsp;<a href="./ucp.php?mode=login"><img src="./styles/prosilver/theme/images/icon_mini_login.gif" width="12" height="13" alt="*" /> Login</a>&nbsp;
			</td>
		</tr>
		</table>
	</div>

	<div id="datebar">
		<table width="100%" cellspacing="0">
		<tr>
			<td class="gensmall"></td>
			<td class="gensmall" align="right">It is currently Thu Aug 30, 2012 9:57 pm<br /></td>
		</tr>
		</table>
	</div>

</div>

<div id="wrapcentre">

	
	<p class="searchbar">
		<span style="float: left;"><a href="./search.php?search_id=unanswered">View unanswered posts</a> | <a href="./search.php?search_id=active_topics">View active topics</a></span>
		
	</p>
	

	<br style="clear: both;" />

	<table class="tablebg" width="100%" cellspacing="1" cellpadding="0" style="margin-top: 5px;">
	<tr>
		<td class="row1">
			<p class="breadcrumbs"><a href="./index.php">Board index</a> &#187; <a href="./viewforum.php?f=24">NES / Famicom</a> &#187; <a href="./viewforum.php?f=3">NESemdev</a></p>
			<p class="datetime">All times are UTC - 7 hours </p>
		</td>
	</tr>
	</table>

	<br />

<div id="pageheader">
	<h2><a class="titles" href="./viewtopic.php?f=3&amp;t=3402">Sprite Overlapping Problem</a></h2>


	<p class="moderators">Moderator: <a href="./memberlist.php?mode=group&amp;g=320">Moderators</a></p>

</div>

<br clear="all" /><br />

<div id="pagecontent">

	<table width="100%" cellspacing="1">
	<tr>
		<td align="left" valign="middle" nowrap="nowrap">
		<a href="./posting.php?mode=post&amp;f=3"><img src="./styles/subsilver2/imageset/en/button_topic_new.gif" alt="Post new topic" title="Post new topic" /></a>&nbsp;<a href="./posting.php?mode=reply&amp;f=3&amp;t=3402"><img src="./styles/subsilver2/imageset/en/button_topic_reply.gif" alt="Reply to topic" title="Reply to topic" /></a>
		</td>
		
			<td class="nav" valign="middle" nowrap="nowrap">&nbsp;Page <strong>1</strong> of <strong>1</strong><br /></td>
			<td class="gensmall" nowrap="nowrap">&nbsp;[ 8 posts ]&nbsp;</td>
			<td class="gensmall" width="100%" align="right" nowrap="nowrap"></td>
		
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr>
		<td class="cat">
			<table width="100%" cellspacing="0">
			<tr>
				<td class="nav" nowrap="nowrap">&nbsp;
				<a href="./viewtopic.php?f=3&amp;t=3402&amp;view=print" title="Print view">Print view</a>
				</td>
				<td class="nav" align="right" nowrap="nowrap"><a href="./viewtopic.php?f=3&amp;t=3402&amp;view=previous">Previous topic</a> | <a href="./viewtopic.php?f=3&amp;t=3402&amp;view=next">Next topic</a>&nbsp;</td>
			</tr>
			</table>
		</td>
	</tr>

	</table>


	<table class="tablebg" width="100%" cellspacing="1">
	
		<tr>
			<th>Author</th>
			<th>Message</th>
		</tr>
	<tr class="row1">

			<td align="center" valign="middle">
				<a name="p24810"></a>
				<b class="postauthor">ZeroFusion</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p24810">Sprite Overlapping Problem</a></div><div style="float: right;"><a href="./viewtopic.php?p=24810#p24810"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Sat Jun 09, 2007 8:33 am&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				<tr>
					<td><img src="./download/file.php?avatar=3351.gif" width="40" height="50" alt="User avatar" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Sat Jun 09, 2007 2:29 am<br /><b>Posts:</b> 6
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">Hi, I'm trying to get my NES emulator to work, but I found big problem. In Duck Hunt, everything seems all right until the duck flies out. When it hides behind the tree on the left or the bushes on the right, it's weirdly clipped. Also, when the dog laughs out loud on me for having missed the duck, the grass behind which he is is NOT transparent (as it should be). See the screenshot:
<br />
<br /><img src="http://img167.imageshack.us/img167/4480/dh2ko1.gif" alt="Image" />
<br />
<br />I'm using per scanline engine (I know it's less accurate than per pixel engine, but just right now, I need at least some of the mapper 0 games working and I can switch to per pixel engine later).
<br />
<br />Here's what do I do during drawing a scanline:
<br />
<br />1. Draw any pixels of the background tiles being on the current scanline (non-transparent and transparent). I keep a flag of which pixel is transparent and which is not.
<br />
<br />2. Draw non-transparant sprite pixels on the current scanline (from sprite 0 to sprite 63):
<br />a) If the sprite is in the foreground, i simply draw it's pixels
<br />b) If the sprite is in the background, i draw all it's pixels where BG is transparent
<br />Anytime I draw a sprite pixel, I set appropriate flag that background is no longer transparent there.
<br />
<br />Here's the code:
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if &#40;&#40;colorAddressOffset &amp; 0x0003&#41; &amp;&amp; &#40;&#40;!&#40;ppu.sprRAM&#91;k+2&#93; &amp; 0x20&#41;&#41; || &#40;transparencyMap&#91;ppu.sprRAM&#91;k + 3&#93; + j&#93;&#41;&#41;&#41; &#123; // Not transparent<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; colorIndex = ppu.readMemory&#40;0x3f10 + colorAddressOffset&#41;;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; SDL_LockSurface&#40;ppu.scanline&#41;;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; putPixel&#40;ppu.scanline, ppu.sprRAM&#91;k + 3&#93; + j, 0, SDL_MapRGB&#40;ppu.scanline-&gt;format, NES_PALETTE&#91;colorIndex&#93;.r, NES_PALETTE&#91;colorIndex&#93;.g, NES_PALETTE&#91;colorIndex&#93;.b&#41;&#41;;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; SDL_UnlockSurface&#40;ppu.scanline&#41;;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; transparencyMap&#91;ppu.sprRAM&#91;k + 3&#93; + j&#93; = false;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#125;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br /></div>
<br />
<br />Can anyone tell me what do I do wrong? I want to implement scrolling in my emulator, but no sooner than the sprites are drawn correctly.
<br />
<br />Thanks.</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=3351"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row2">

			<td align="center" valign="middle">
				<a name="p24814"></a>
				<b class="postauthor">dvdmth</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p24814"></a></div><div style="float: right;"><a href="./viewtopic.php?p=24814#p24814"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Sat Jun 09, 2007 9:49 am&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Wed Mar 22, 2006 8:00 am<br /><b>Posts:</b> 354
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">I suggest drawing sprites first, then the background second.
<br />
<br />When drawing sprites, be sure to draw only the first eight sprites that exist on the scanline.  Also, sprite 0 has highest priority and should be drawn over top of all other sprites.  Sprite 63 has lowest priority.  Even if sprite 0 is background and sprite 1 is foreground, sprite 0 will still cover sprite 1.
<br />
<br />When drawing the background, draw only where a foreground sprite pixel doesn't already exist.  Background sprites should be covered only by non-transparent background pixels.
<br />
<br />Sprite vs. sprite priority MUST be done before sprite vs. background priority.  Suppose sprite 0 is background, sprite 1 is foreground, and the two overlap at a point where the background is not transparent.  Because sprite 0 has priority over sprite 1, it will be drawn over top of sprite 1.  However, since sprite 0 is a background sprite, it will be covered by the background, causing the background to be visible at that location.  (This "priority quirk" causes some graphical glitches in certain games, by the way.  Other games take advantage of it, however, so you have to emulate it.)</div>

					
						<div class="postbody"><br />_________________<br />"Last version was better," says Floyd. "More bugs. Bugs make game fun."</div>
					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=360"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row1">

			<td align="center" valign="middle">
				<a name="p24831"></a>
				<b class="postauthor">ZeroFusion</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p24831"></a></div><div style="float: right;"><a href="./viewtopic.php?p=24831#p24831"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Sat Jun 09, 2007 2:42 pm&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				<tr>
					<td><img src="./download/file.php?avatar=3351.gif" width="40" height="50" alt="User avatar" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Sat Jun 09, 2007 2:29 am<br /><b>Posts:</b> 6
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">Thanks very much, dvdmth, I tried what you suggested, but with no luck. I tried to solve it whole afternoon a now I found out that my emulator behaves very strangely: 
<br />
<br />After drawing all apropriate sprites on current scanline, I do this to determine the color of current BG pixel:
<br />
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">&nbsp; &nbsp; &nbsp; &nbsp; if &#40;!&#40;pixels0 || pixels1&#41;&#41; &#123;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; colorIndex = ppu.readMemory&#40;0x3f00&#41;;<br />&nbsp; &nbsp; &nbsp; &nbsp; &#125; else &#123;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; colorIndex = ppu.readMemory&#40;0x3f00 + &#40;pixels32 | &#40;&#40;&#40;pixels1 &amp; pixelTileOffset&#41; &gt;&gt; &#40;7 - j&#41;&#41; &lt;&lt; 1&#41; | &#40;&#40;pixels0 &amp; pixelTileOffset&#41; &gt;&gt; &#40;7 - j&#41;&#41;&#41;&#41;;<br />&nbsp; &nbsp; &nbsp; &nbsp; &#125;<br /></div><br /><br />So far it seems no problem to me. Then I tried to draw all BG pixels where there was no foreground pixel and (there wasn't background pixel or the current color wasn't the transparent one) - just like you suggested. I looked like this:<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">&nbsp; &nbsp; &nbsp; &nbsp; if &#40;!frontSprites&#91;i * 8 + j&#93; &amp;&amp; &#40;!backSprites&#91;i * 8 + j&#93; || &#40;pixels0 || pixels1&#41;&#41;&#41; &#123;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; SDL_LockSurface&#40;ppu.scanline&#41;;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; putPixel&#40;ppu.scanline, i * 8 + j, 0, SDL_MapRGB&#40;ppu.scanline-&gt;format, NES_PALETTE&#91;colorIndex&#93;.r, NES_PALETTE&#91;colorIndex&#93;.g, NES_PALETTE&#91;colorIndex&#93;.b&#41;&#41;;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; SDL_UnlockSurface&#40;ppu.scanline&#41;;<br />&nbsp; &nbsp; &nbsp; &nbsp; &#125;<br /></div><br /><br />The funny thing is (and I don't know why it behaves this way) that only solution that worked for me was to exchange the condition when to draw BG pixel like this (where bgColorIndex = ppu.readMemory[0x3f00]):<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">&nbsp; &nbsp; &nbsp; &nbsp; if &#40;!frontSprites&#91;i * 8 + j&#93; &amp;&amp; &#40;!backSprites&#91;i * 8 + j&#93; || &#40;colorIndex != bgColorIndex&#41;&#41;&#41; &#123;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; SDL_LockSurface&#40;ppu.scanline&#41;;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; putPixel&#40;ppu.scanline, i * 8 + j, 0, SDL_MapRGB&#40;ppu.scanline-&gt;format, NES_PALETTE&#91;colorIndex&#93;.r, NES_PALETTE&#91;colorIndex&#93;.g, NES_PALETTE&#91;colorIndex&#93;.b&#41;&#41;;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; SDL_UnlockSurface&#40;ppu.scanline&#41;;<br />&nbsp; &nbsp; &nbsp; &nbsp; &#125;<br /></div>
<br />
<br />My palette mirroring seems to be working correctly, so I don't understand why if-and-only-if operation (pixels0 || pixels1) &lt;=&gt; (colorIndex != bgColorIndex) fails  <img src="./images/smilies/icon_question.gif" alt=":?:" title="Question" />
<br />
<br />EDIT: I forgot to say that between code 1 and code 2, there're NO addtional lines in my emulator source (ie. there's absolutely no change of pixels0, pixels1 or colorIndex being changed). Really strange
<br />
<br />And I would like to ask one more question: which sprites count to the total of 8 per scanline? Do I have to count every sprite, that spans current scanline, or just those sprites where at least one of the (non-transparent?) pixels is on the current scanline?</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=3351"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row2">

			<td align="center" valign="middle">
				<a name="p24836"></a>
				<b class="postauthor" style="color: #AA0000">tepples</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p24836"></a></div><div style="float: right;"><a href="./viewtopic.php?p=24836#p24836"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Sat Jun 09, 2007 4:48 pm&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				<tr>
					<td><img src="http://pineight.com/nes/terrible/PSRFX.png" width="100" height="56" alt="User avatar" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Sun Sep 19, 2004 11:12 pm<br /><b>Posts:</b> 9048<br /><b>Location:</b> NE Indiana, USA (NTSC)
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody"><div class="quotetitle">ZeroFusion wrote:</div><div class="quotecontent">And I would like to ask one more question: which sprites count to the total of 8 per scanline? Do I have to count every sprite, that spans current scanline, or just those sprites where at least one of the (non-transparent?) pixels is on the current scanline?</div>
<br />There are 8 sprite sliver registers in the PPU. In order for the PPU to determine that there are no nontransparent pixels in an 8x1 pixel sprite sliver, it still has to fetch that sprite sliver from CHR memory. So yes, you count all sprites that span this scanline.</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=9"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row1">

			<td align="center" valign="middle">
				<a name="p24841"></a>
				<b class="postauthor">blargg</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p24841"></a></div><div style="float: right;"><a href="./viewtopic.php?p=24841#p24841"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Sat Jun 09, 2007 7:58 pm&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				<tr>
					<td><img src="./download/file.php?avatar=17.gif" width="60" height="69" alt="User avatar" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Mon Sep 27, 2004 8:33 am<br /><b>Posts:</b> 2802
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">In my NES emulator I draw the background scanline first, then sprites in order. For each pixel I have an extra flag. When set, it prevents further modification of that pixel. The background clears this flag, and sprite drawing sets it for non-transparent sprite pixels. Sprites that are behind the background set the flag and modify the pixel itself only if it was transparent, causing the correct behavior of forcing the background pixels in <em>front</em> of other sprites after the current one. Just wanted to note that you can draw the background first, and that it can still be efficient (I'm able to process four sprite pixels at a time, using some bit manipulation to replace only non-transparent pixels appropriately).</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=17"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row2">

			<td align="center" valign="middle">
				<a name="p24846"></a>
				<b class="postauthor">ZeroFusion</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p24846"></a></div><div style="float: right;"><a href="./viewtopic.php?p=24846#p24846"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Sun Jun 10, 2007 1:35 am&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				<tr>
					<td><img src="./download/file.php?avatar=3351.gif" width="40" height="50" alt="User avatar" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Sat Jun 09, 2007 2:29 am<br /><b>Posts:</b> 6
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">Thanks, tepples.
<br />
<br /><div class="quotetitle">blargg wrote:</div><div class="quotecontent">Just wanted to note that you can draw the background first, and that it can still be efficient (I'm able to process four sprite pixels at a time, using some bit manipulation to replace only non-transparent pixels appropriately).</div>
<br />
<br />Yeah I thought so, but I was absolutely desperate and could not find any mistake, so I tried to render sprites first as dvdmth suggested.
<br />
<br />Anyway, I've made a further investigation into Duck Hunt. FceUXD's debug shows me that there aren't any entries in the sprite or image palette that match background color and aren't on address dividable by 4. In my opion, this can only mean that the grass BG tile behind wich the dog's hidden, really has transparent pixels and my palette mirroring has to be wrong somewhere (otherwise the (pixels0 || pixels1) condition would pass).</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=3351"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row1">

			<td align="center" valign="middle">
				<a name="p24851"></a>
				<b class="postauthor">Disch</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p24851"></a></div><div style="float: right;"><a href="./viewtopic.php?p=24851#p24851"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Sun Jun 10, 2007 7:53 am&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				<tr>
					<td><img src="./download/file.php?avatar=33.png" width="65" height="75" alt="User avatar" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Wed Nov 10, 2004 6:47 pm<br /><b>Posts:</b> 1670
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">you shouldn't be matching background colors to anything.  The actual color used anywhere is completely irrelevent as far as transparency goes.
<br />
<br />"Color 0" on the 4-color CHR is <em>always</em> transparent, regardless of what is in the palette, or what palette the current sprite/bg is using.  That is to say -- opacity can be determined by doing a simple check:
<br />
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">if&#40; pixel &amp; 3 &#41;<br />&#123;<br />&nbsp; // pixel is opaque<br />&#125;<br />else<br />&#123;<br />&nbsp;// pixel is transparent<br />&#125;<br /></div><br /><br />Where 'pixel' is the pixel <em>before</em> any palette lookup.<br /><br />Absolutely nothing else matters when determining opacity/transparency.  opaque pixels can still be opaque even if their color matches the BG color.  And transparent colors are still transparent even if their respective entry in the palette does not match $3F00.<br /><br /><br />EDIT<br />---------------------<br /><br />To elaborate on my approach... I actually do a 2-stage rendering process.  While slower overall (since it essentially involves rendering everything twice), it's quite easy to work with, and allows for emulation of the pipelining effect of fetching BG tiles (not really applicable in your case though... since you're doing scanline based rendering)<br /><br />The idea involves having 2 intermediate buffers -- one for BG pixels and one for sprite pixels.  The sprite buffer would be flushed and refilled with <em>sprite pixels only</em> during HBlank on each scanline.  The BG buffer would be filled as tiles are fetched (and the end of the previous scanline, and during rendering) during the scanline.<br /><br />The gimmick here is that these intermediate buffers would only have the palette index of the color to render ($00-$0F for BG, and $00-$1F for sprites ... see below).  Because of this, I can use the high bits of the sprite render buffer for some flags to hold additional properties of the pixel.  For example -- $80 would indicate the sprite pixel has background priority.. and $40 would indicate the pixel belongs to sprite 0 (so you can do sprite-0 hit checks later, when the pixel is rendered).<br /><br />Note that I reserve $00 as a fully transparent pixel in the intermediate buffers.  Therefore, $10 would never be in the sprite intermediate buffer, since $10 would be transparent.<br /><br />Actual factual last-stage rendering would then simply have to examine the appropriate sprite and BG pixels from the intermediate buffers, and choose whichever one takes priority (if any).  This makes priorty checks during rendering pretty simple:<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">u8 a, b;<br /><br />a = bg_intermediate_buffer&#91; current_x + fine_h_scroll &#93;;<br />b = spr_intermediate_buffer&#91; current_x &#93;;<br /><br />// this is a neat trick to handle BG/Spr disabling, as well as clipping<br />//&nbsp; in the left 8-pixel column.&nbsp; I'll discuss this more later<br />if&#40;current_x &lt; bg_clip&#41;&nbsp; &nbsp; &nbsp; &nbsp; a = 0;<br />if&#40;current_x &lt; sprite_clip&#41;&nbsp; &nbsp;b = 0;<br /><br />if&#40;a &amp;&amp; &#40;b &amp; 0x40&#41; &amp;&amp; &#40;current_x != 255&#41;&#41;<br />&nbsp; ppu_status_2002 |= 0x80;&nbsp; &nbsp; //&nbsp; sprite 0 hit!<br /><br />if&#40;b &amp; 0x80&#41;&nbsp; &nbsp;// low sprite prio<br />&#123;<br />&nbsp; if&#40;!a&#41;&nbsp; // if BG pixel transparent<br />&nbsp; &nbsp; a = b &amp; 0x1F;&nbsp; &nbsp; // use sprite pixel instead &#40;mask out unwanted flags&#41;<br />&#125;<br />else if&#40;b&#41;&nbsp; &nbsp; // high sprite prio and opaque sprite pixel<br />&nbsp; a = b &amp; 0x1F; // use sprite pixel<br /><br />lookup_palette_and_output_pixel&#40; a &#41;;<br /></div>
<br />
<br />A note about my clipping:
<br />
<br />$2001 can enable/disable clipping of the left 8-pixel column for sprites and BG independently.  It can also disable BG or sprite rendering in full.  All this clipping or disabling does is replace the output BG/sprite pixel with transparency where appropriate (note that this is done before sprite-0 hit checks).  Also note theis does not include the special case where BG and sprite rendering are both disabled -- in which case the PPU enters an "off" state and operates quite differently.
<br />
<br />I emulate this simply by keeping two variables, labelled above as 'bg_clip' and 'sprite_clip'.  These would either be set to 256 (disabled), 8 (enabled with clip), or 0 (enabled, no clip) during my $2001 write handler.
<br />
<br />&lt; /rambling&gt;</div>

					
							<br /><br />
							<span class="gensmall">Last edited by <a href="./memberlist.php?mode=viewprofile&amp;u=33">Disch</a> on Mon Jun 11, 2007 9:20 am, edited 1 time in total.</span>
						<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=33"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row2">

			<td align="center" valign="middle">
				<a name="p24859"></a>
				<b class="postauthor">ZeroFusion</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p24859"></a></div><div style="float: right;"><a href="./viewtopic.php?p=24859#p24859"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Sun Jun 10, 2007 11:29 am&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				<tr>
					<td><img src="./download/file.php?avatar=3351.gif" width="40" height="50" alt="User avatar" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Sat Jun 09, 2007 2:29 am<br /><b>Posts:</b> 6
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody"><div class="quotetitle">Disch wrote:</div><div class="quotecontent"> And transparent colors are still transparent even if their respective entry in the palette does not match $3F00.<br /></div>
<br />
<br />Thanks a lot, this seems to explain my problem with conditions: while (pixels0 || pixels1) condition tests only if the pixel is or isn't transparent by checking whether it's pallete entry is dividable by 4, the (colorIndexOffset != bgColorIndex) checkes whether current pixels color index isn't same as the "transparent's" color index.
<br />
<br />According to what you've just written, the first condition could never possibly give good result - it would never prevent from drawing those pixels whose colorIndex was same as transparent color index (having palette offset dividable by 4) and offset of those pixel's color was not dividable by 4 (ie. there's color entry in the palette on the position not dividable by 4, and the color is still the same as the transparent one).</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=3351"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table width="100%" cellspacing="1" class="tablebg">
	<tr align="center">
		<td class="cat"><form name="viewtopic" method="post" action="./viewtopic.php?f=3&amp;t=3402"><span class="gensmall">Display posts from previous:</span> <select name="st" id="st"><option value="0" selected="selected">All posts</option><option value="1">1 day</option><option value="7">7 days</option><option value="14">2 weeks</option><option value="30">1 month</option><option value="90">3 months</option><option value="180">6 months</option><option value="365">1 year</option></select>&nbsp;<span class="gensmall">Sort by</span> <select name="sk" id="sk"><option value="a">Author</option><option value="t" selected="selected">Post time</option><option value="s">Subject</option></select> <select name="sd" id="sd"><option value="a" selected="selected">Ascending</option><option value="d">Descending</option></select>&nbsp;<input class="btnlite" type="submit" value="Go" name="sort" /></form></td>
	</tr>
	</table>
	

	<table width="100%" cellspacing="1">
	<tr>
		<td align="left" valign="middle" nowrap="nowrap">
		<a href="./posting.php?mode=post&amp;f=3"><img src="./styles/subsilver2/imageset/en/button_topic_new.gif" alt="Post new topic" title="Post new topic" /></a>&nbsp;<a href="./posting.php?mode=reply&amp;f=3&amp;t=3402"><img src="./styles/subsilver2/imageset/en/button_topic_reply.gif" alt="Reply to topic" title="Reply to topic" /></a>
		</td>
		
			<td class="nav" valign="middle" nowrap="nowrap">&nbsp;Page <strong>1</strong> of <strong>1</strong><br /></td>
			<td class="gensmall" nowrap="nowrap">&nbsp;[ 8 posts ]&nbsp;</td>
			<td class="gensmall" width="100%" align="right" nowrap="nowrap"></td>
		
	</tr>
	</table>

</div>

<div id="pagefooter"></div>

<br clear="all" />
<table class="tablebg" width="100%" cellspacing="1" cellpadding="0" style="margin-top: 5px;">
	<tr>
		<td class="row1">
			<p class="breadcrumbs"><a href="./index.php">Board index</a> &#187; <a href="./viewforum.php?f=24">NES / Famicom</a> &#187; <a href="./viewforum.php?f=3">NESemdev</a></p>
			<p class="datetime">All times are UTC - 7 hours </p>
		</td>
	</tr>
	</table>
	<br clear="all" />

	<table class="tablebg" width="100%" cellspacing="1">
	<tr>
		<td class="cat"><h4>Who is online</h4></td>
	</tr>
	<tr>
		<td class="row1"><p class="gensmall">Users browsing this forum: No registered users and 0 guests</p></td>
	</tr>
	</table>


<br clear="all" />

<table width="100%" cellspacing="1">
<tr>
	<td width="40%" valign="top" nowrap="nowrap" align="left"></td>
	<td align="right" valign="top" nowrap="nowrap"><span class="gensmall">You <strong>cannot</strong> post new topics in this forum<br />You <strong>cannot</strong> reply to topics in this forum<br />You <strong>cannot</strong> edit your posts in this forum<br />You <strong>cannot</strong> delete your posts in this forum<br />You <strong>cannot</strong> post attachments in this forum<br /></span></td>
</tr>
</table>

<br clear="all" />

<table width="100%" cellspacing="0">
<tr>
	<td><form method="get" name="search" action="./search.php"><span class="gensmall">Search for:</span> <input class="post" type="text" name="keywords" size="20" /> <input class="btnlite" type="submit" value="Go" /><input type="hidden" name="t" value="3402" />
<input type="hidden" name="sf" value="msgonly" />
</form></td>
	<td align="right">
	<form method="post" name="jumpbox" action="./viewforum.php" onsubmit="if(document.jumpbox.f.value == -1){return false;}">

	<table cellspacing="0" cellpadding="0" border="0">
	<tr>
		<td nowrap="nowrap"><span class="gensmall">Jump to:</span>&nbsp;<select name="f" onchange="if(this.options[this.selectedIndex].value != -1){ document.forms['jumpbox'].submit() }">

		
			<option value="-1">Select a forum</option>
		<option value="-1">------------------</option>
			<option value="24">NES / Famicom</option>
		
			<option value="2">&nbsp; &nbsp;NESdev</option>
		
			<option value="3" selected="selected">&nbsp; &nbsp;NESemdev</option>
		
			<option value="21">&nbsp; &nbsp;NES Graphics</option>
		
			<option value="6">&nbsp; &nbsp;NES Music</option>
		
			<option value="9">&nbsp; &nbsp;NES Hardware and Flash Equipment</option>
		
			<option value="22">&nbsp; &nbsp;Homebrew Projects</option>
		
			<option value="10">&nbsp; &nbsp;Newbie Help Center</option>
		
			<option value="11">&nbsp; &nbsp;FCdev</option>
		
			<option value="18">&nbsp; &nbsp;NESdev China</option>
		
			<option value="19">&nbsp; &nbsp;NESdev International</option>
		
			<option value="25">Other</option>
		
			<option value="5">&nbsp; &nbsp;General Stuff</option>
		
			<option value="4">&nbsp; &nbsp;Membler Industries</option>
		
			<option value="12">&nbsp; &nbsp;SNESdev</option>
		
			<option value="20">&nbsp; &nbsp;GBDev</option>
		
			<option value="23">&nbsp; &nbsp;Other Retro Dev</option>
		
			<option value="15">&nbsp; &nbsp;Test Forum</option>
		
			<option value="26">Site Issues</option>
		
			<option value="13">&nbsp; &nbsp;phpBB Issues</option>
		
			<option value="14">&nbsp; &nbsp;Web Issues</option>
		
			<option value="16">&nbsp; &nbsp;nesdevWiki</option>
		

		</select>&nbsp;<input class="btnlite" type="submit" value="Go" /></td>
	</tr>
	</table>

	</form>
</td>
</tr>
</table>


</div>

<div id="wrapfooter">
	
	<span class="copyright">Powered by <a href="http://www.phpbb.com/">phpBB</a>&reg; Forum Software &copy; phpBB Group
	</span>
</div>

</body>
</html>