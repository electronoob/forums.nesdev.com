<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en-gb" xml:lang="en-gb">
<head>

<link rel="icon" href="/favicon.ico" type="image/x-icon" />
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
<meta http-equiv="content-language" content="en-gb" />
<meta http-equiv="content-style-type" content="text/css" />
<meta http-equiv="imagetoolbar" content="no" />
<meta name="resource-type" content="document" />
<meta name="distribution" content="global" />
<meta name="keywords" content="" />
<meta name="description" content="" />

<title>nesdev.com &bull; View topic - NMI/BRK timing and such</title>

<link rel="alternate" type="application/atom+xml" title="Feed - nesdev.com" href="http://forums.nesdev.com/feed.php" /><link rel="alternate" type="application/atom+xml" title="Feed - News" href="http://forums.nesdev.com/feed.php?mode=news" /><link rel="alternate" type="application/atom+xml" title="Feed - All forums" href="http://forums.nesdev.com/feed.php?mode=forums" /><link rel="alternate" type="application/atom+xml" title="Feed - New Topics" href="http://forums.nesdev.com/feed.php?mode=topics" /><link rel="alternate" type="application/atom+xml" title="Feed - Active Topics" href="http://forums.nesdev.com/feed.php?mode=topics_active" /><link rel="alternate" type="application/atom+xml" title="Feed - Forum - NESemdev" href="http://forums.nesdev.com/feed.php?f=3" /><link rel="alternate" type="application/atom+xml" title="Feed - Topic - NMI/BRK timing and such" href="http://forums.nesdev.com/feed.php?f=3&amp;t=10006" />

<link rel="stylesheet" href="./style.php?id=1&amp;lang=en" type="text/css" />

<script type="text/javascript">
// <![CDATA[


function popup(url, width, height, name)
{
	if (!name)
	{
		name = '_popup';
	}

	window.open(url.replace(/&amp;/g, '&'), name, 'height=' + height + ',resizable=yes,scrollbars=yes,width=' + width);
	return false;
}

function jumpto()
{
	var page = prompt('Enter the page number you wish to go to:', '1');
	var per_page = '15';
	var base_url = './viewtopic.php?f=3&amp;t=10006';

	if (page !== null && !isNaN(page) && page == Math.floor(page) && page > 0)
	{
		if (base_url.indexOf('?') == -1)
		{
			document.location.href = base_url + '?start=' + ((page - 1) * per_page);
		}
		else
		{
			document.location.href = base_url.replace(/&amp;/g, '&') + '&start=' + ((page - 1) * per_page);
		}
	}
}

/**
* Find a member
*/
function find_username(url)
{
	popup(url, 760, 570, '_usersearch');
	return false;
}

/**
* Mark/unmark checklist
* id = ID of parent container, name = name prefix, state = state [true/false]
*/
function marklist(id, name, state)
{
	var parent = document.getElementById(id);
	if (!parent)
	{
		eval('parent = document.' + id);
	}

	if (!parent)
	{
		return;
	}

	var rb = parent.getElementsByTagName('input');
	
	for (var r = 0; r < rb.length; r++)
	{
		if (rb[r].name.substr(0, name.length) == name)
		{
			rb[r].checked = state;
		}
	}
}



// ]]>
</script>
</head>
<body class="ltr">

<a name="top"></a>

<div id="wrapheader">

	<div id="logodesc">
	</div>

	<div id="menubar">

		<table width="100%" cellspacing="0">
		<tr>
			<td rowspan="2"><a href="./index.php"><img src="./styles/subsilver2/imageset/site_logo.gif" alt="" title="" /></a></td>
			<td width="100%" align="center"><h1>nesdev.com</h1><span class="gen">NES Development and Strangulation Records message boards</span></td>
		</tr>
		<tr>
			<td align="center">
				<a href="./faq.php"><img src="./styles/prosilver/theme/images/icon_mini_faq.gif" width="12" height="13" alt="*" /> FAQ</a>
				&nbsp; &nbsp;<a href="./search.php"><img src="./styles/prosilver/theme/images/icon_mini_search.gif" width="12" height="13" alt="*" /> Search</a>
				<br />	
				 &nbsp;<a href="./ucp.php?mode=register"><img src="./styles/prosilver/theme/images/icon_mini_register.gif" width="12" height="13" alt="*" /> Register</a>
					&nbsp; &nbsp;<a href="./ucp.php?mode=login"><img src="./styles/prosilver/theme/images/icon_mini_login.gif" width="12" height="13" alt="*" /> Login</a>&nbsp;
			</td>
		</tr>
		</table>
	</div>

	<div id="datebar">
		<table width="100%" cellspacing="0">
		<tr>
			<td class="gensmall"></td>
			<td class="gensmall" align="right">It is currently Sat Sep 20, 2014 3:50 pm<br /></td>
		</tr>
		</table>
	</div>

</div>

<div id="wrapcentre">

	
	<p class="searchbar">
		<span style="float: left;"><a href="./search.php?search_id=unanswered">View unanswered posts</a> | <a href="./search.php?search_id=active_topics">View active topics</a></span>
		
	</p>
	

	<br style="clear: both;" />

	<table class="tablebg" width="100%" cellspacing="1" cellpadding="0" style="margin-top: 5px;">
	<tr>
		<td class="row1">
			<p class="breadcrumbs"><a href="./index.php">Board index</a> &#187; <a href="./viewforum.php?f=24">NES / Famicom</a> &#187; <a href="./viewforum.php?f=3">NESemdev</a></p>
			<p class="datetime">All times are UTC - 7 hours </p>
		</td>
	</tr>
	</table>

	<br />

<div id="pageheader">
	<h2><a class="titles" href="./viewtopic.php?f=3&amp;t=10006">NMI/BRK timing and such</a></h2>


	<p class="moderators">Moderator: <a href="./memberlist.php?mode=group&amp;g=320">Moderators</a></p>

</div>

<br clear="all" /><br />

<div id="pagecontent">

	<table width="100%" cellspacing="1">
	<tr>
		<td align="left" valign="middle" nowrap="nowrap">
		<a href="./posting.php?mode=post&amp;f=3"><img src="./styles/subsilver2/imageset/en/button_topic_new.gif" alt="Post new topic" title="Post new topic" /></a>&nbsp;<a href="./posting.php?mode=reply&amp;f=3&amp;t=10006"><img src="./styles/subsilver2/imageset/en/button_topic_reply.gif" alt="Reply to topic" title="Reply to topic" /></a>
		</td>
		
			<td class="nav" valign="middle" nowrap="nowrap">&nbsp;Page <strong>1</strong> of <strong>3</strong><br /></td>
			<td class="gensmall" nowrap="nowrap">&nbsp;[ 43 posts ]&nbsp;</td>
			<td class="gensmall" width="100%" align="right" nowrap="nowrap"><b><a href="#" onclick="jumpto(); return false;" title="Click to jump to page…">Go to page</a> <strong>1</strong><span class="page-sep">, </span><a href="./viewtopic.php?f=3&amp;t=10006&amp;start=15">2</a><span class="page-sep">, </span><a href="./viewtopic.php?f=3&amp;t=10006&amp;start=30">3</a> &nbsp;<a href="./viewtopic.php?f=3&amp;t=10006&amp;start=15">Next</a></b></td>
		
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr>
		<td class="cat">
			<table width="100%" cellspacing="0">
			<tr>
				<td class="nav" nowrap="nowrap">&nbsp;
				<a href="./viewtopic.php?f=3&amp;t=10006&amp;view=print" title="Print view">Print view</a>
				</td>
				<td class="nav" align="right" nowrap="nowrap"><a href="./viewtopic.php?f=3&amp;t=10006&amp;view=previous">Previous topic</a> | <a href="./viewtopic.php?f=3&amp;t=10006&amp;view=next">Next topic</a>&nbsp;</td>
			</tr>
			</table>
		</td>
	</tr>

	</table>


	<table class="tablebg" width="100%" cellspacing="1">
	
		<tr>
			<th>Author</th>
			<th>Message</th>
		</tr>
	<tr class="row1">

			<td align="center" valign="middle">
				<a name="p110785"></a>
				<b class="postauthor">proxy</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p110785">NMI/BRK timing and such</a></div><div style="float: right;"><a href="./viewtopic.php?p=110785#p110785"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Wed Apr 10, 2013 1:46 pm&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Tue Mar 08, 2011 9:45 am<br /><b>Posts:</b> 61
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">I have been trying to get my NMI/BRK timing just right and am a bit stumped (it always seems just a hair off, not matter what I do), so I have a few questions, the first I think is the easiest:<br /><br />1. Since IRQ/NMI/RESET are basically special cases of BRK. Does they still check if an interrupt should happen during the last cycle? I would assume yes. I doubt it matters much since Interrupts will be disabled by that time, but perhaps NMI could do something weird there? I dunno.<br /><br />2. The normal operation of execution always has the first cycle do a read from PC and then increment PC. During an IRQ/NMI/RESET, the CPU will force the IR to be $00 in order to trigger the interrupt dispatch logic. That's fine. My question is **Does the CPU still do the read from PC like normal, skip incrementing PC and THEN force the IR to $00. Or is forcing the IR to $00 pretty much the only thing it does during that cycle if an interrupt is pending?<br /><br />4. At the moment I assume that the forcing of the IR to $00 is just about the only real thing that happens during that cycle (it obviously does some other stuff to make the BRK act like an IRQ/NMI, but I'm keeping it simple). Based on that assumption, here's my core execution logic for executing 1 cycle of the CPU. Is there any obvious flaw? NOTE: instructions $100, $101, $102 are special indexes for RST/NMI/IRQ:<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void clock() {<br />&nbsp; &nbsp;if(current_cycle == 0) {<br />&nbsp; &nbsp;&nbsp; &nbsp;if(rst_executing) {<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;instruction = 0x100;<br />&nbsp; &nbsp;&nbsp; &nbsp;} else if(nmi_executing) {<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;instruction = 0x101;<br />&nbsp; &nbsp;&nbsp; &nbsp;} else if(irq_executing) {<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;instruction = 0x102;<br />&nbsp; &nbsp;&nbsp; &nbsp;} else {<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;instruction = read_byte(PC++);<br />&nbsp; &nbsp;&nbsp; &nbsp;}<br />&nbsp; &nbsp;} else {<br />&nbsp; &nbsp;&nbsp; &nbsp;// execute the current part of the instruction<br />&nbsp; &nbsp;&nbsp; &nbsp;execute_opcode();<br />&nbsp; &nbsp;}<br /><br />&nbsp; &nbsp;++current_cycle;<br />}<br /></div><br /><br />Thanks guys.</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=4806"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row2">

			<td align="center" valign="middle">
				<a name="p110786"></a>
				<b class="postauthor">beannaich</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p110786">Re: NMI/BRK timing and such</a></div><div style="float: right;"><a href="./viewtopic.php?p=110786#p110786"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Wed Apr 10, 2013 1:56 pm&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Wed Mar 31, 2010 12:40 pm<br /><b>Posts:</b> 185
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">Here is my interrupt service routine, that passes all the IRQ tests:<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">private void IsrIrq()<br />{<br />&nbsp; &nbsp; PeekByte(pc.uw0); // 2 wait states at the beginning of irq<br />&nbsp; &nbsp; PeekByte(pc.uw0);<br />&nbsp; &nbsp; PokeByte(sp.uw0, pc.ub1); sp.ub0--;<br />&nbsp; &nbsp; PokeByte(sp.uw0, pc.ub0); sp.ub0--;<br />&nbsp; &nbsp; PokeByte(sp.uw0, sr); sp.ub0--;<br /><br />&nbsp; &nbsp; sr.i = !nmi; // todo: make sure i isn't set on nmi<br /><br />&nbsp; &nbsp; var vector = nmi ? 0xFFFAU : 0xFFFEU;<br />&nbsp; &nbsp; nmi = false;<br /><br />&nbsp; &nbsp; pc.ub0 = PeekByte(&nbsp; vector);<br />&nbsp; &nbsp; pc.ub1 = PeekByte(++vector, true);<br />}</div><br /><br />that method is called if the variable &quot;interrupt&quot; is true. interrupt is set on the last cycle as: &quot;interrupt = nmi || (irq &amp;&amp; !sr.i);&quot;. BRK has a similar vectoring scheme where the vector can be replaced by 0xFFFA if nmi occurred. In the code above PeekByte(addr, true); will do the last cycle interrupt flag polling. So in my code the ISR does poll at the last cycle.</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=4320"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row1">

			<td align="center" valign="middle">
				<a name="p110789"></a>
				<b class="postauthor">proxy</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p110789">Re: NMI/BRK timing and such</a></div><div style="float: right;"><a href="./viewtopic.php?p=110789#p110789"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Wed Apr 10, 2013 2:16 pm&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Tue Mar 08, 2011 9:45 am<br /><b>Posts:</b> 61
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">I just want to make sure we are testing the same stuff. Which IRQ tests do you pass?<br /><br />I am specifically looking at the ones which deal with NMI and BRK happing at the same time and the BRK vectoring to NMI instead. Likewise, this is what my BRK routine looks like at the moment (but doesn't quite pass, it's off by a cycle or 2):<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void op_brk() {<br />&nbsp; &nbsp;static uint16_t vector_address;<br /><br />&nbsp; &nbsp;switch(current_cycle) {<br />&nbsp; &nbsp;case 1:<br />&nbsp; &nbsp;&nbsp; &nbsp;// read next instruction byte (and throw it away),<br />&nbsp; &nbsp;&nbsp; &nbsp;// increment PC<br />&nbsp; &nbsp;&nbsp; &nbsp;vector_address = IRQ_VECTOR_ADDRESS;<br />&nbsp; &nbsp;&nbsp; &nbsp;read_byte(PC++);<br />&nbsp; &nbsp;&nbsp; &nbsp;break;<br />&nbsp; &nbsp;case 2:<br />&nbsp; &nbsp;&nbsp; &nbsp;// push PCH on stack, decrement S<br />&nbsp; &nbsp;&nbsp; &nbsp;write_byte(S-- + STACK_ADDRESS, pc_hi());<br />&nbsp; &nbsp;&nbsp; &nbsp;break;<br />&nbsp; &nbsp;case 3:<br />&nbsp; &nbsp;&nbsp; &nbsp;// push PCL on stack, decrement S<br />&nbsp; &nbsp;&nbsp; &nbsp;write_byte(S-- + STACK_ADDRESS, pc_lo());<br />&nbsp; &nbsp;&nbsp; &nbsp;break;<br />&nbsp; &nbsp;case 4:<br />&nbsp; &nbsp;&nbsp; &nbsp;// push P on stack, decrement S<br />&nbsp; &nbsp;&nbsp; &nbsp;write_byte(S-- + STACK_ADDRESS, P | B_MASK);<br />&nbsp; &nbsp;&nbsp; &nbsp;set_flag(I_MASK);<br />&nbsp; &nbsp;&nbsp; &nbsp;break;<br />&nbsp; &nbsp;case 5:<br />&nbsp; &nbsp;&nbsp; &nbsp;// fetch PCL<br />&nbsp; &nbsp;&nbsp; &nbsp;set_pc_lo(read_byte(vector_address + 0));<br />&nbsp; &nbsp;&nbsp; &nbsp;break;<br />&nbsp; &nbsp;case 6:<br />&nbsp; &nbsp;&nbsp; &nbsp;LAST_CYCLE; // this macro updates the various &quot;nmi_pending/irq_pending/rst_pending&quot; flags<br />&nbsp; &nbsp;&nbsp; &nbsp;// fetch PCH<br />&nbsp; &nbsp;&nbsp; &nbsp;set_pc_hi(read_byte(vector_address + 1));<br />&nbsp; &nbsp;&nbsp; &nbsp;return;<br />&nbsp; &nbsp;default:<br />&nbsp; &nbsp;&nbsp; &nbsp;abort();<br />&nbsp; &nbsp;}<br />&nbsp; &nbsp;<br />&nbsp; &nbsp;if(nmi_pending) {<br />&nbsp; &nbsp;&nbsp; &nbsp;if(current_cycle &lt; 5 &amp;&amp; current_cycle &gt; 1) {<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;vector_address = NMI_VECTOR_ADDRESS;<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;nmi_pending = false;<br />&nbsp; &nbsp;&nbsp; &nbsp;}<br />&nbsp; &nbsp;}<br />}<br /></div></div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=4806"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row2">

			<td align="center" valign="middle">
				<a name="p110791"></a>
				<b class="postauthor">beannaich</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p110791">Re: NMI/BRK timing and such</a></div><div style="float: right;"><a href="./viewtopic.php?p=110791#p110791"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Wed Apr 10, 2013 2:38 pm&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Wed Mar 31, 2010 12:40 pm<br /><b>Posts:</b> 185
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody"><div class="quotetitle">proxy wrote:</div><div class="quotecontent">I just want to make sure we are testing the same stuff. Which IRQ tests do you pass?</div><br /><br />blargg's cpu interrupts tests, which contains the nmi/brk test.<br /><br />Your brk function looks okay, are you sure that your nmi timing is correct?</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=4320"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row1">

			<td align="center" valign="middle">
				<a name="p110793"></a>
				<b class="postauthor">proxy</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p110793">Re: NMI/BRK timing and such</a></div><div style="float: right;"><a href="./viewtopic.php?p=110793#p110793"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Wed Apr 10, 2013 4:09 pm&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Tue Mar 08, 2011 9:45 am<br /><b>Posts:</b> 61
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">heh, no I'm not sure that my NMI timing is correct. But I'm not sure where it could be wrong. Is there any particulars that I should know of besides:<br /><br />1. At cycle 0 if an NMI has been determined to be pending, IR is forced to $00 instead of a normal instruction fetch.<br />2. The NMI process is more or less the same as BRK (except it doesn't increment PC and vectors differently)<br />3. An NMI is pending if at the start of the last cycle of an instruction the NMI line is asserted.<br /><br /><br />Anything I'm missing timing wise?<br /><br />I do pass the CLI latency tests, so I believe that point 3 is done correctly.<br /><br />I currently Pass:<br />IRQ Flag Timing Test by Shay Green (30 Jun 2005) (PD).nes<br />IRQ Handler Test by Shay Green (30 Jun 2005) (PD).nes<br />IRQ Flag Operation Test by Shay Green (30 Jun 2005) (PD).nes<br /><br /> I fail:<br />NMI Suppression Timing Test by Shay Green (6 Nov 2005) (PD).nes (#3)<br />Disable NMI Timing Test by Shay Green (6 Nov 2005) (PD).nes (#2)<br />NMI Timing Test by Shay Green (6 Nov 2005) (PD).nes (#3)</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=4806"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row2">

			<td align="center" valign="middle">
				<a name="p110795"></a>
				<b class="postauthor">beannaich</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p110795">Re: NMI/BRK timing and such</a></div><div style="float: right;"><a href="./viewtopic.php?p=110795#p110795"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Wed Apr 10, 2013 4:49 pm&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Wed Mar 31, 2010 12:40 pm<br /><b>Posts:</b> 185
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">Until your NMI timing is right I wouldn't expect to pass the BRK/NMI test.<br /><br />NOTE: The following is conjecture, but seems to go along with observations.<br /><br />All interrupts use the same logic, with a few differences depending on the type of interrupt. For example RST forces /RW high during the pushes (This is why SP is decremented by 3, but nothing is written to the stack, and also why the i flag is set on resets). I believe the decision for which vector to use isn't made until after the return address and flags are pushed, which is why NMI can beat an IRQ or BRK. There are 4 actions that can trigger this logic, IRQ, NMI, RST, and a BRK (Software interrupt) instruction. The logic doesn't increment the PC, so there is some difference between IRQ/NMI/RST and BRK as far as that is concerned. So I suppose a &quot;universal&quot; interrupt service routine logic could look something like this (pseudocode):<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void isr(bool brk = false)<br />{<br />&nbsp; &nbsp; // 2 wait states would be consumed by BRK opcode, so the caller of this function for NMI/IRQ/RST would have to do the same before calling<br />&nbsp; &nbsp; rw = rst ? 1 : 0;<br /><br />&nbsp; &nbsp; put_addr_on_bus( ( sp-- ) | 0x100 );<br />&nbsp; &nbsp; put_data_on_bus( pch ); // not sure if the real hardware has this data on the bus with RW set to 1, just makes for cleaner code.<br />&nbsp; &nbsp; put_addr_on_bus( ( sp-- ) | 0x100 );<br />&nbsp; &nbsp; put_data_on_bus( pcl );<br />&nbsp; &nbsp; put_addr_on_bus( ( sp-- ) | 0x100 );<br />&nbsp; &nbsp; put_data_on_bus( sr | ( brk ? 0x10 : 0x00 ) );<br /><br />&nbsp; &nbsp; sr.i = true; // not sure whether i gets set on nmi or not<br /><br />&nbsp; &nbsp; u16_t vector = rst ? 0xFFFC : nmi ? 0xFFFA : 0xFFFE; // simulate vector priority<br />&nbsp; &nbsp; rst = false;<br />&nbsp; &nbsp; nmi = false;<br />&nbsp; &nbsp; irq = false; // for devices with persistent logic, IRQ will be held high until acknowledged, this is partly why the i flag matters :)<br /><br />&nbsp; &nbsp; rw = 1; // read<br /><br />&nbsp; &nbsp; put_addr_on_bus( vector + 0 );<br />&nbsp; &nbsp; pcl = get_data_from_bus( );<br />&nbsp; &nbsp; put_addr_on_bus( vector + 1 );<br />&nbsp; &nbsp; pch = get_data_from_bus( );<br />}</div><br /><br />That SHOULD emulate all the quirks observed in the IRQ logic as long as you do the polling correctly on the last cycle. BRK would just do opcode fetch, data fetch, then call that as &quot;isr( true );&quot;, your actual interrupt check would do two reads from the PC before calling the above as &quot;isr( );&quot;. If anyone has any problems with what I just said, please let me know <img src="./images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=4320"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row1">

			<td align="center" valign="middle">
				<a name="p110804"></a>
				<b class="postauthor">ulfalizer</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p110804">Re: NMI/BRK timing and such</a></div><div style="float: right;"><a href="./viewtopic.php?p=110804#p110804"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Wed Apr 10, 2013 9:14 pm&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				<tr>
					<td><img src="./download/file.php?avatar=5911_1363098840.png" width="80" height="52" alt="User avatar" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Fri Mar 08, 2013 9:55 pm<br /><b>Posts:</b> 347<br /><b>Location:</b> Linköping, Sweden
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">I did some tracing in Visual 6502. With a CLI+BRK, asserting NMI (which is active low btw) within the interval denoted by &quot;----&quot; below causes the BRK to be missed (each [] is a CPU tick):<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">&nbsp; &nbsp; &nbsp;--------------------<br />&#91;CLI&#93;&#91;CLI&#93;&#91;BRK&#93;&#91;BRK&#93;&#91;BRK&#93;&#91;BRK&#93;&#91;BRK&#93;&#91;BRK&#93;&#91;BRK&#93;</div><br /><br />When the BRK is missed, you also get a weird mix of NMI and BRK that's exactly like a BRK only it branches to the NMI vector instead. Here's a tick-by-tick breakdown of BRK from <!-- m --><a class="postlink" href="http://nesdev.com/6502_cpu.txt">http://nesdev.com/6502_cpu.txt</a><!-- m --> along with what seems to be going on:<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">&nbsp;#&nbsp; address R/W description<br />--- ------- --- -----------------------------------------------<br />&nbsp;1&nbsp; &nbsp; PC&nbsp; &nbsp; &nbsp;R&nbsp; fetch opcode, increment PC<br />&nbsp;2&nbsp; &nbsp; PC&nbsp; &nbsp; &nbsp;R&nbsp; read next instruction byte (and throw it away),<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; increment PC<br />&nbsp;3&nbsp; $0100,S&nbsp; W&nbsp; push PCH on stack, decrement S<br />*** At this point, the signal status is queried to determine which interrupt vector to use ***<br />&nbsp;4&nbsp; $0100,S&nbsp; W&nbsp; push PCL on stack, decrement S<br />&nbsp;5&nbsp; $0100,S&nbsp; W&nbsp; push P on stack (with B flag set), decrement S<br />&nbsp;6&nbsp; &nbsp;$FFFE&nbsp; &nbsp;R&nbsp; fetch PCL<br />&nbsp;7&nbsp; &nbsp;$FFFF&nbsp; &nbsp;R&nbsp; fetch PCH</div><br /><br />The BRK-specific behavior (incrementing of PC and pushing B -- NMI doesn't do that) seems to be triggered when NMI occurs within the interval above.<br /><em><br />Is this information available anywhere on the wiki btw?</em></div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=5911"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row2">

			<td align="center" valign="middle">
				<a name="p110808"></a>
				<b class="postauthor">ulfalizer</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p110808">Re: NMI/BRK timing and such</a></div><div style="float: right;"><a href="./viewtopic.php?p=110808#p110808"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Wed Apr 10, 2013 9:19 pm&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				<tr>
					<td><img src="./download/file.php?avatar=5911_1363098840.png" width="80" height="52" alt="User avatar" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Fri Mar 08, 2013 9:55 pm<br /><b>Posts:</b> 347<br /><b>Location:</b> Linköping, Sweden
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">To clarify, the BRK isn't really &quot;skipped&quot; - it's just hijacked by the NMI so that it uses the NMI interrupt vector instead of the BRK one.</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=5911"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row1">

			<td align="center" valign="middle">
				<a name="p110810"></a>
				<b class="postauthor">lidnariq</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p110810">Re: NMI/BRK timing and such</a></div><div style="float: right;"><a href="./viewtopic.php?p=110810#p110810"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Wed Apr 10, 2013 9:30 pm&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Sun Apr 13, 2008 11:12 am<br /><b>Posts:</b> 2348<br /><b>Location:</b> seattle
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">Just for another verification: Are you saying that it begins execution at the NMI vector, but in the flags pushed on the stack, the B bit is set?</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=3512"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row2">

			<td align="center" valign="middle">
				<a name="p110811"></a>
				<b class="postauthor">ulfalizer</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p110811">Re: NMI/BRK timing and such</a></div><div style="float: right;"><a href="./viewtopic.php?p=110811#p110811"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Wed Apr 10, 2013 9:34 pm&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				<tr>
					<td><img src="./download/file.php?avatar=5911_1363098840.png" width="80" height="52" alt="User avatar" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Fri Mar 08, 2013 9:55 pm<br /><b>Posts:</b> 347<br /><b>Location:</b> Linköping, Sweden
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody"><div class="quotetitle">lidnariq wrote:</div><div class="quotecontent">Just for another verification: Are you saying that it begins execution at the NMI vector, but in the flags pushed on the stack, the B bit is set?</div><br /><br />Yup - the BRKy behavior extends to the point where it pushes with the B bit set even though it branches to the NMI vector.</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=5911"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row1">

			<td align="center" valign="middle">
				<a name="p110814"></a>
				<b class="postauthor">ulfalizer</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p110814">Re: NMI/BRK timing and such</a></div><div style="float: right;"><a href="./viewtopic.php?p=110814#p110814"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Wed Apr 10, 2013 9:50 pm&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				<tr>
					<td><img src="./download/file.php?avatar=5911_1363098840.png" width="80" height="52" alt="User avatar" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Fri Mar 08, 2013 9:55 pm<br /><b>Posts:</b> 347<br /><b>Location:</b> Linköping, Sweden
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">I experimented with some slower instructions before the BRK, and the condition for getting the glitchy behavior seems to be that NMI is asserted at or after the last tick of the previous instructions (or put another way, at or after the BRK opcode is fetched).<br /><br />With LDX zero,y, which takes 4 cycles, you get this interval for example:<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ---------------------------<br />&#91;LDX zero,y&#93;&#91;LDX zero,y&#93;&#91;LDX zero,y&#93;&#91;LDX zero,y&#93;&#91;BRK&#93;&#91;BRK&#93;&#91;BRK&#93;&#91;BRK&#93;&#91;BRK&#93;&#91;BRK&#93;&#91;BRK&#93;<br /></div></div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=5911"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row2">

			<td align="center" valign="middle">
				<a name="p110815"></a>
				<b class="postauthor">beannaich</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p110815">Re: NMI/BRK timing and such</a></div><div style="float: right;"><a href="./viewtopic.php?p=110815#p110815"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Wed Apr 10, 2013 10:00 pm&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Wed Mar 31, 2010 12:40 pm<br /><b>Posts:</b> 185
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">It may be more accurate to say the the flags are polled in each cycle except for the last cycle due to the 2-stage pipeline the CPU has.<br /><br />Example:<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">and #$nn takes &#91;b&#93;3&#91;/b&#93; cycles<br />1. opcode fetch<br />2. data fetch<br />3. perform and<br /></div><br /><br />While cycle 3 is occurring, the next instruction is being fetched, since the accumulator will never be important during that cycle. Now imagine that the cpu was allowed to be interrupted during that opcode fetch (AND's last cycle), and an interrupt indeed occurred. The PC would now no longer point to the next opcode (unless you got lucky and it was an implied instruction, but even then it'd be skipped outright). So the CPU doesn't allow interrupts to occur during that cycle. Instead if an interrupt was detected in the first 2 cycles (Or for ease of emulating, the cycle before the last), it forces the instruction register to 0, inhibits pc increments and executes a BRK instruction (The reason for the 2 reads at the beginning of the ISR i noted earlier). <img src="./images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /><br /><br />edit: typos</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=4320"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row1">

			<td align="center" valign="middle">
				<a name="p110818"></a>
				<b class="postauthor">blargg</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p110818">Re: NMI/BRK timing and such</a></div><div style="float: right;"><a href="./viewtopic.php?p=110818#p110818"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Wed Apr 10, 2013 10:35 pm&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				<tr>
					<td><img src="./download/file.php?avatar=17.gif" width="60" height="69" alt="User avatar" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Mon Sep 27, 2004 8:33 am<br /><b>Posts:</b> 3711<br /><b>Location:</b> Central Texas, USA
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">I'm pretty sure there's a test ROM for this hijacking behavior as well, in case you want to emulate it properly.</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=17"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row2">

			<td align="center" valign="middle">
				<a name="p110819"></a>
				<b class="postauthor">ulfalizer</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p110819">Re: NMI/BRK timing and such</a></div><div style="float: right;"><a href="./viewtopic.php?p=110819#p110819"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Wed Apr 10, 2013 10:46 pm&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				<tr>
					<td><img src="./download/file.php?avatar=5911_1363098840.png" width="80" height="52" alt="User avatar" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Fri Mar 08, 2013 9:55 pm<br /><b>Posts:</b> 347<br /><b>Location:</b> Linköping, Sweden
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody"><div class="quotetitle">blargg wrote:</div><div class="quotecontent">I'm pretty sure there's a test ROM for this hijacking behavior as well, in case you want to emulate it properly.</div><br /><br />Would be nice to have on the wiki too, in case it isn't already there and I'm not blind. I'm assuming NMI can hijack IRQ in a similar way too, and that IRQ can hijack BRK (though it wouldn't be as visible since they use the same interrupt vector. Might cause you to &quot;miss&quot; the IRQ perhaps...).</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=5911"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row1">

			<td align="center" valign="middle">
				<a name="p110820"></a>
				<b class="postauthor">blargg</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p110820">Re: NMI/BRK timing and such</a></div><div style="float: right;"><a href="./viewtopic.php?p=110820#p110820"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Wed Apr 10, 2013 10:56 pm&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				<tr>
					<td><img src="./download/file.php?avatar=17.gif" width="60" height="69" alt="User avatar" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Mon Sep 27, 2004 8:33 am<br /><b>Posts:</b> 3711<br /><b>Location:</b> Central Texas, USA
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody"><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">I'm assuming NMI can hijack IRQ in a similar way too, and that IRQ can hijack BRK (though it wouldn't be as visible since they use the same interrupt vector. Might cause you to &quot;miss&quot; the IRQ perhaps...).</div><br />Wouldn't matter with BRK and IRQ, since BRK hijacking IRQ would just mean that it would just delay the real IRQ vectoring until the BRK returned. IRQ hijacking BRK would be nasty, since it would be as if the CPU skipped the BRK. I believe this is what happens, though looks like ROM doesn't test it.<br /><br /><a href="http://wiki.nesdev.com/w/index.php/Emulator_tests#CPU" class="postlink">cpu_interrupts_v2</a><br /><br />It even checks an NMI occurring during each cycle of an IRQ. And even checks the interrupt-delaying effect of the last cycle of a taken branch. Crazy.</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=17"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table width="100%" cellspacing="1" class="tablebg">
	<tr align="center">
		<td class="cat"><form name="viewtopic" method="post" action="./viewtopic.php?f=3&amp;t=10006"><span class="gensmall">Display posts from previous:</span> <select name="st" id="st"><option value="0" selected="selected">All posts</option><option value="1">1 day</option><option value="7">7 days</option><option value="14">2 weeks</option><option value="30">1 month</option><option value="90">3 months</option><option value="180">6 months</option><option value="365">1 year</option></select>&nbsp;<span class="gensmall">Sort by</span> <select name="sk" id="sk"><option value="a">Author</option><option value="t" selected="selected">Post time</option><option value="s">Subject</option></select> <select name="sd" id="sd"><option value="a" selected="selected">Ascending</option><option value="d">Descending</option></select>&nbsp;<input class="btnlite" type="submit" value="Go" name="sort" /></form></td>
	</tr>
	</table>
	

	<table width="100%" cellspacing="1">
	<tr>
		<td align="left" valign="middle" nowrap="nowrap">
		<a href="./posting.php?mode=post&amp;f=3"><img src="./styles/subsilver2/imageset/en/button_topic_new.gif" alt="Post new topic" title="Post new topic" /></a>&nbsp;<a href="./posting.php?mode=reply&amp;f=3&amp;t=10006"><img src="./styles/subsilver2/imageset/en/button_topic_reply.gif" alt="Reply to topic" title="Reply to topic" /></a>
		</td>
		
			<td class="nav" valign="middle" nowrap="nowrap">&nbsp;Page <strong>1</strong> of <strong>3</strong><br /></td>
			<td class="gensmall" nowrap="nowrap">&nbsp;[ 43 posts ]&nbsp;</td>
			<td class="gensmall" width="100%" align="right" nowrap="nowrap"><b><a href="#" onclick="jumpto(); return false;" title="Click to jump to page…">Go to page</a> <strong>1</strong><span class="page-sep">, </span><a href="./viewtopic.php?f=3&amp;t=10006&amp;start=15">2</a><span class="page-sep">, </span><a href="./viewtopic.php?f=3&amp;t=10006&amp;start=30">3</a> &nbsp;<a href="./viewtopic.php?f=3&amp;t=10006&amp;start=15">Next</a></b></td>
		
	</tr>
	</table>

</div>

<div id="pagefooter"></div>

<br clear="all" />
<table class="tablebg" width="100%" cellspacing="1" cellpadding="0" style="margin-top: 5px;">
	<tr>
		<td class="row1">
			<p class="breadcrumbs"><a href="./index.php">Board index</a> &#187; <a href="./viewforum.php?f=24">NES / Famicom</a> &#187; <a href="./viewforum.php?f=3">NESemdev</a></p>
			<p class="datetime">All times are UTC - 7 hours </p>
		</td>
	</tr>
	</table>
	<br clear="all" />

	<table class="tablebg" width="100%" cellspacing="1">
	<tr>
		<td class="cat"><h4>Who is online</h4></td>
	</tr>
	<tr>
		<td class="row1"><p class="gensmall">Users browsing this forum: <a href="./memberlist.php?mode=viewprofile&amp;u=4526">Sik</a> and 2 guests</p></td>
	</tr>
	</table>


<br clear="all" />

<table width="100%" cellspacing="1">
<tr>
	<td width="40%" valign="top" nowrap="nowrap" align="left"></td>
	<td align="right" valign="top" nowrap="nowrap"><span class="gensmall">You <strong>cannot</strong> post new topics in this forum<br />You <strong>cannot</strong> reply to topics in this forum<br />You <strong>cannot</strong> edit your posts in this forum<br />You <strong>cannot</strong> delete your posts in this forum<br />You <strong>cannot</strong> post attachments in this forum<br /></span></td>
</tr>
</table>

<br clear="all" />

<table width="100%" cellspacing="0">
<tr>
	<td><form method="get" name="search" action="./search.php"><span class="gensmall">Search for:</span> <input class="post" type="text" name="keywords" size="20" /> <input class="btnlite" type="submit" value="Go" /><input type="hidden" name="t" value="10006" />
<input type="hidden" name="sf" value="msgonly" />
</form></td>
	<td align="right">
	<form method="post" name="jumpbox" action="./viewforum.php" onsubmit="if(document.jumpbox.f.value == -1){return false;}">

	<table cellspacing="0" cellpadding="0" border="0">
	<tr>
		<td nowrap="nowrap"><span class="gensmall">Jump to:</span>&nbsp;<select name="f" onchange="if(this.options[this.selectedIndex].value != -1){ document.forms['jumpbox'].submit() }">

		
			<option value="-1">Select a forum</option>
		<option value="-1">------------------</option>
			<option value="24">NES / Famicom</option>
		
			<option value="2">&nbsp; &nbsp;NESdev</option>
		
			<option value="3" selected="selected">&nbsp; &nbsp;NESemdev</option>
		
			<option value="21">&nbsp; &nbsp;NES Graphics</option>
		
			<option value="6">&nbsp; &nbsp;NES Music</option>
		
			<option value="9">&nbsp; &nbsp;NES Hardware and Flash Equipment</option>
		
			<option value="22">&nbsp; &nbsp;Homebrew Projects</option>
		
			<option value="10">&nbsp; &nbsp;Newbie Help Center</option>
		
			<option value="11">&nbsp; &nbsp;FCdev</option>
		
			<option value="18">&nbsp; &nbsp;NESdev China</option>
		
			<option value="27">&nbsp; &nbsp;NESdev Middle East</option>
		
			<option value="19">&nbsp; &nbsp;NESdev International</option>
		
			<option value="25">Other</option>
		
			<option value="5">&nbsp; &nbsp;General Stuff</option>
		
			<option value="4">&nbsp; &nbsp;Membler Industries</option>
		
			<option value="12">&nbsp; &nbsp;SNESdev</option>
		
			<option value="20">&nbsp; &nbsp;GBDev</option>
		
			<option value="23">&nbsp; &nbsp;Other Retro Dev</option>
		
			<option value="15">&nbsp; &nbsp;Test Forum</option>
		
			<option value="26">Site Issues</option>
		
			<option value="13">&nbsp; &nbsp;phpBB Issues</option>
		
			<option value="14">&nbsp; &nbsp;Web Issues</option>
		
			<option value="16">&nbsp; &nbsp;nesdevWiki</option>
		

		</select>&nbsp;<input class="btnlite" type="submit" value="Go" /></td>
	</tr>
	</table>

	</form>
</td>
</tr>
</table>


</div>

<div id="wrapfooter">
	
	<span class="copyright">Powered by <a href="http://www.phpbb.com/">phpBB</a>&reg; Forum Software &copy; phpBB Group
	</span>
</div>

</body>
</html>