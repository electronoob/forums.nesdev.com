<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html dir="ltr" lang="en-gb">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta http-equiv="Content-Style-Type" content="text/css">
<meta http-equiv="Content-Language" content="en-gb">
<title>nesdev.com :: View topic - Nestopia and Ninja Gaiden/Burai Fighter</title>

<style type="text/css">
<!--

body {
	font-family: Verdana,serif;
	font-size: 10pt;
}

img {
	border: 0;
}

td {
	font-family: Verdana,serif;
	font-size: 10pt;
	line-height: 150%;
}

.code, .codecontent, 
.quote, .quotecontent {
	margin: 0 5px 0 5px;
	padding: 5px;
	font-size: smaller;
	border: black solid 1px;
}

.quotetitle {
	color: black;
	display : block;
	font-weight: bold;
}

.forum {
	font-family: Arial,Helvetica,sans-serif;
	font-weight: bold;
	font-size: 18pt;
}

.topic {
	font-family: Arial,Helvetica,sans-serif;
	font-size: 14pt;
	font-weight: bold;
}

.gensmall {
	font-size: 8pt;
}

hr {
	color: #888;
	height: 3px;
	border-style: solid;
}

hr.sep {
	color: #aaa;
	height: 1px;
	border-style: dashed;
}
//-->
</style>

</head>
<body>

<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
<tr>
	<td colspan="2" align="center"><span class="Forum">nesdev.com</span><br /><span class="gensmall"><a href="http://forums.nesdev.com/">http://forums.nesdev.com/</a></span></td>
</tr>
<tr>
	<td colspan="2"><br /></td>
</tr>
<tr>
	<td><span class="topic">Nestopia and Ninja Gaiden/Burai Fighter</span><br /><span class="gensmall"><a href="http://forums.nesdev.com/viewtopic.php?f=3&amp;t=11361">http://forums.nesdev.com/viewtopic.php?f=3&amp;t=11361</a></span></td>
	<td align="right" valign="bottom"><span class="gensmall">Page <strong>5</strong> of <strong>7</strong></span></td>
</tr>
</table>



	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Zepper</b> [ Sat Jul 26, 2014 9:31 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: Nestopia and Ninja Gaiden/Burai Fighter</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">James wrote:</div><div class="quotecontent">This is not the right way to fix it. You will break other games.</div><br /><br />Obviously. <img src="./images/smilies/icon_smile.gif" alt=":)" title="Smile" /> Well, I don't know what's wrong with Burai Fighter, and that was the only &quot;hint&quot; I could get for the problem.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>James</b> [ Sat Jul 26, 2014 11:13 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: Nestopia and Ninja Gaiden/Burai Fighter</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />MMC3 IRQ counter should not be clocked by accesses &gt;$2FFF. Filter those in your mapper or ppu code and burai fighter should work correctly.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Zepper</b> [ Sat Jul 26, 2014 1:52 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: Nestopia and Ninja Gaiden/Burai Fighter</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />I already did without success.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>*Spitfire_NES*</b> [ Sat Jul 26, 2014 5:52 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: Nestopia and Ninja Gaiden/Burai Fighter</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">zxbdragon wrote:</div><div class="quotecontent">Ninja Gaiden .....<br />FetchAttribute?</div><br /><br />yes but how to fix is very hard to pinpoint. <br /><br />@James<br /><br />Interesting, i never knew about that. After checking im sure nestopia is doing that too. So it seems like this is potential solution or problem. lol. Is there no way to add an exception for this without breaking the other games? Obviously i want to do this the right way if i can and im sure the same for zepper too. <br /><br />I just find it amusing both emus have the same issue. zxbdragon id like to add the source change you tried to fix burai fighter if you dont mind posting it just to see what breaks other games. As for ninja gaiden i dont know how to track the ppu bug in the table.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>zxbdragon</b> [ Sat Jul 26, 2014 11:22 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: Nestopia and Ninja Gaiden/Burai Fighter</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">*Spitfire_NES* wrote:</div><div class="quotecontent"><div class="quotetitle">zxbdragon wrote:</div><div class="quotecontent">Ninja Gaiden .....<br />FetchAttribute?</div><br /><br />yes but how to fix is very hard to pinpoint. <br /><br />@James<br /><br />Interesting, i never knew about that. After checking im sure nestopia is doing that too. So it seems like this is potential solution or problem. lol. Is there no way to add an exception for this without breaking the other games? Obviously i want to do this the right way if i can and im sure the same for zepper too. <br /><br />I just find it amusing both emus have the same issue. zxbdragon id like to add the source change you tried to fix burai fighter if you dont mind posting it just to see what breaks other games. As for ninja gaiden i dont know how to track the ppu bug in the table.</div><br /><br /><br />Both BUG, I have not corrected the problem only preliminary know , they did not know where the solutions in nestiopia!

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Zepper</b> [ Sun Jul 27, 2014 12:57 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: Nestopia and Ninja Gaiden/Burai Fighter</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">James wrote:</div><div class="quotecontent">MMC3 IRQ counter should not be clocked by accesses &gt;$2FFF. Filter those in your mapper or ppu code and burai fighter should work correctly.</div><br /><br />This fix <strong><em>on PPU $2006 second write</em></strong> makes Mickey in Letterland to work correctly, its scorebar has the correct position now. Even puNES has a bad scorebar for that game.<br />About Burai Fighter, I have no clue - I already did what you said, but nothing happened. The IRQ is clocked like blargg explains in his test ROMs - during the HBlank on cycles 260,268... when BG is at $0000 and sprites at $1000 (standard). Any other setting I put on IRQs to try a fix for Burai Fighter messes up the game.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>*Spitfire_NES*</b> [ Sun Aug 03, 2014 10:24 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: Nestopia and Ninja Gaiden/Burai Fighter</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">Zepper wrote:</div><div class="quotecontent"><div class="quotetitle">James wrote:</div><div class="quotecontent">MMC3 IRQ counter should not be clocked by accesses &gt;$2FFF. Filter those in your mapper or ppu code and burai fighter should work correctly.</div><br /><br />This fix <strong><em>on PPU $2006 second write</em></strong> makes Mickey in Letterland to work correctly, its scorebar has the correct position now. Even puNES has a bad scorebar for that game.<br />About Burai Fighter, I have no clue - I already did what you said, but nothing happened. The IRQ is clocked like blargg explains in his test ROMs - during the HBlank on cycles 260,268... when BG is at $0000 and sprites at $1000 (standard). Any other setting I put on IRQs to try a fix for Burai Fighter messes up the game.</div><br /><br />hey james, with this being said, is there something else the both of us could be missing here you think? Seems like it would and should work. Very odd to say the least...

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>James</b> [ Sun Aug 03, 2014 1:03 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: Nestopia and Ninja Gaiden/Burai Fighter</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />You're going to have to get your hands dirty.  Run it in a debugger and break on any PPU accesses &gt;= 0x3000 then trace it out from there.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Zepper</b> [ Mon Aug 04, 2014 5:19 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: Nestopia and Ninja Gaiden/Burai Fighter</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Let me recap the IRQ thing (assuming the standard PPU setup):<br /><br />- the standard setup is background tiles at PPU $0000 and sprites at PPU $1000;<br />- this makes A12 rising during the HBlank at every 8 cycles, starting at 260th;<br />- according to the test ROMs, A12 should rise at PPU dot 260.<br /><br />Also, the IRQ counter is clocked when $2006/2007 is accessed.<br /><br />Well, my emu uses a different gfx engine - that's might be the problem, but I dunno.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>James</b> [ Tue Aug 05, 2014 9:46 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: Nestopia and Ninja Gaiden/Burai Fighter</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />You should use the following logic:  clock the IRQ counter when A12 transitions from low to high after being low for a sufficient period of time (I use 5 CPU cycles).  This will generally happen at PPU cycle 260, but it's easier to deal with the edge cases by simplifying the conditions for clocking the counter.<br /><br />This means, of course, that you need to make sure that you're accessing PPU memory at all of the right times: PPU fetches during rendering (especially sprite fetches starting at cycle 260) and accesses via $2006/$2007.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Zepper</b> [ Tue Aug 05, 2014 6:46 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: Nestopia and Ninja Gaiden/Burai Fighter</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Blocking the IRQ if the PPU address is &gt;= 0x3000 breaks all the games here in my emu.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>tepples</b> [ Tue Aug 05, 2014 9:05 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: Nestopia and Ninja Gaiden/Burai Fighter</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Perhaps the MMC3 can see accesses to $3000-$3EFF (mirror of nametables) but not $3F00 through $3FFF (palette, in internal CGRAM)

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>perilsensitive</b> [ Wed Aug 06, 2014 3:34 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: Nestopia and Ninja Gaiden/Burai Fighter</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />I've been lurking on this thread a while due to having these same issues in my emulator.  I've resolved the glitch in Burai Fighter (using a completely different fix than the one described previously) and Ninja Gaiden, but I'm still having trouble with Safari in Letterland and Goal! Two, which also has a shaky status bar that seems to be dependant on the last fine vertical scroll value when vblank starts.<br /><br /><div class="quotetitle">tepples wrote:</div><div class="quotecontent">Perhaps the MMC3 can see accesses to $3000-$3EFF (mirror of nametables) but not $3F00 through $3FFF (palette, in internal CGRAM)</div><br />I tested this in Visual 2C02, and it puts bits 0-13 of loopy_v (or vramaddr_v as Visual 2C02 calls it) on the address bus for any read or write via $2007 when not rendering no matter what the value of loopy_v is (while rendering the bus is controlled by the rendering logic, and therefore not directly affected by the change to loopy_v).  This also happens when setting loopy_v via $2006 (again, only when not rendering), when rendering is disabled via $2001, and after rendering ends (cycle 0 of scanline 240).  If this reflects the PPU's actual behavior, then palette accesses can clock the IRQ counter.<br /><br />I had to fix my code so that $2006 and $2007 only touched the address bus when the PPU wasn't rendering (Nestopia doesn't do this correctly either).  I also had to change the behavior of $2007 accesses while rendering so that the horizontal and vertical scroll were both always incremented (Nestopia UE increments one or the other based on bit 2 of $2000).  ulfalizer traced Visual 2C02 and figured out why this happens <a href="http://forums.nesdev.com/viewtopic.php?p=114182#p114182" class="postlink">here</a> and documented it in the <a href="http://wiki.nesdev.com/w/index.php/The_skinny_on_NES_scrolling" class="postlink">wiki</a>.<br /><br />I've modified Nestopia UE to address the above issues and Burai Fighter works correctly.  You can see the diff of my changes in my <a href="https://github.com/perilsensitive/nestopia/commit/43a831caadb7a192ec95542a824ceb316fbdd4bc" class="postlink">github fork</a>.<br /><br />The glitch in Ninja Gaiden's intro is caused by <a href="http://forums.nesdev.com/viewtopic.php?t=4116" class="postlink">extra $2007 reads due to DPCM DMA</a>.  I had this exact same glitch in my emulator, and disabling the extra reads for $2007 &quot;fixed&quot; it.  I got the same results in Nestopia with a similar change to Apu::Dmc::DoDMA() in NstApu.cpp.  I haven't dug any further into this one yet.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>zxbdragon</b> [ Wed Aug 06, 2014 4:43 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: Nestopia and Ninja Gaiden/Burai Fighter</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">perilsensitive wrote:</div><div class="quotecontent">I've been lurking on this thread a while due to having these same issues in my emulator.  I've resolved the glitch in Burai Fighter (using a completely different fix than the one described previously) and Ninja Gaiden, but I'm still having trouble with Safari in Letterland and Goal! Two, which also has a shaky status bar that seems to be dependant on the last fine vertical scroll value when vblank starts.<br /><br /><div class="quotetitle">tepples wrote:</div><div class="quotecontent">Perhaps the MMC3 can see accesses to $3000-$3EFF (mirror of nametables) but not $3F00 through $3FFF (palette, in internal CGRAM)</div><br />I tested this in Visual 2C02, and it puts bits 0-13 of loopy_v (or vramaddr_v as Visual 2C02 calls it) on the address bus for any read or write via $2007 when not rendering no matter what the value of loopy_v is (while rendering the bus is controlled by the rendering logic, and therefore not directly affected by the change to loopy_v).  This also happens when setting loopy_v via $2006 (again, only when not rendering), when rendering is disabled via $2001, and after rendering ends (cycle 0 of scanline 240).  If this reflects the PPU's actual behavior, then palette accesses can clock the IRQ counter.<br /><br />I had to fix my code so that $2006 and $2007 only touched the address bus when the PPU wasn't rendering (Nestopia doesn't do this correctly either).  I also had to change the behavior of $2007 accesses while rendering so that the horizontal and vertical scroll were both always incremented (Nestopia UE increments one or the other based on bit 2 of $2000).  ulfalizer traced Visual 2C02 and figured out why this happens <a href="http://forums.nesdev.com/viewtopic.php?p=114182#p114182" class="postlink">here</a> and documented it in the <a href="http://wiki.nesdev.com/w/index.php/The_skinny_on_NES_scrolling" class="postlink">wiki</a>.<br /><br />I've modified Nestopia UE to address the above issues and Burai Fighter works correctly.  You can see the diff of my changes in my <a href="https://github.com/perilsensitive/nestopia/commit/43a831caadb7a192ec95542a824ceb316fbdd4bc" class="postlink">github fork</a>.<br /><br />The glitch in Ninja Gaiden's intro is caused by <a href="http://forums.nesdev.com/viewtopic.php?t=4116" class="postlink">extra $2007 reads due to DPCM DMA</a>.  I had this exact same glitch in my emulator, and disabling the extra reads for $2007 &quot;fixed&quot; it.  I got the same results in Nestopia with a similar change to Apu::Dmc::DoDMA() in NstApu.cpp.  I haven't dug any further into this one yet.</div><br />Great , so you are nestopia

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>perilsensitive</b> [ Wed Aug 06, 2014 5:30 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: Nestopia and Ninja Gaiden/Burai Fighter</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">zxbdragon wrote:</div><div class="quotecontent">Great , so you are nestopia</div><br />rdanbrook maintains Nestopia UE, not me. I do use it on occasion however, so I created a github fork for sharing any fixes to bugs I might find.  I don't do any real development on it.  The main repository is at <!-- m --><a class="postlink" href="https://github.com/rdanbrook/nestopia">https://github.com/rdanbrook/nestopia</a><!-- m -->.  My own emulator is currently unnamed and unreleased, although I expect that to change Real Soon Now. <img src="./images/smilies/icon_smile.gif" alt=":-)" title="Smile" />

		

		</td>
	</tr>
	</table>


<hr width="85%" />

<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
<tr>
	<td><span class="gensmall">Page <strong>5</strong> of <strong>7</strong></span></td>
	<td align="right"><span class="gensmall">All times are UTC - 7 hours </span></td>
</tr>
<tr>
	<td colspan="2" align="center"><span class="gensmall">Powered by phpBB&reg; Forum Software &copy; phpBB Group<br />http://www.phpbb.com/</span></td>
</tr>
</table>

</body>
</html>