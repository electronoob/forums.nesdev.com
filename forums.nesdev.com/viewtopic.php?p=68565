<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en-gb" xml:lang="en-gb">
<head>

<link rel="icon" href="/favicon.ico" type="image/x-icon" />
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
<meta http-equiv="content-language" content="en-gb" />
<meta http-equiv="content-style-type" content="text/css" />
<meta http-equiv="imagetoolbar" content="no" />
<meta name="resource-type" content="document" />
<meta name="distribution" content="global" />
<meta name="keywords" content="" />
<meta name="description" content="" />

<title>nesdev.com &bull; View topic - split/wrapping backgrounds in Marble Madness and Battletoads</title>

<link rel="alternate" type="application/atom+xml" title="Feed - nesdev.com" href="http://forums.nesdev.com/feed.php" /><link rel="alternate" type="application/atom+xml" title="Feed - News" href="http://forums.nesdev.com/feed.php?mode=news" /><link rel="alternate" type="application/atom+xml" title="Feed - All forums" href="http://forums.nesdev.com/feed.php?mode=forums" /><link rel="alternate" type="application/atom+xml" title="Feed - New Topics" href="http://forums.nesdev.com/feed.php?mode=topics" /><link rel="alternate" type="application/atom+xml" title="Feed - Active Topics" href="http://forums.nesdev.com/feed.php?mode=topics_active" /><link rel="alternate" type="application/atom+xml" title="Feed - Forum - NESemdev" href="http://forums.nesdev.com/feed.php?f=3" /><link rel="alternate" type="application/atom+xml" title="Feed - Topic - split/wrapping backgrounds in Marble Madness and Battletoads" href="http://forums.nesdev.com/feed.php?f=3&amp;t=7028" />

<link rel="stylesheet" href="./style.php?id=1&amp;lang=en" type="text/css" />

<script type="text/javascript">
// <![CDATA[


function popup(url, width, height, name)
{
	if (!name)
	{
		name = '_popup';
	}

	window.open(url.replace(/&amp;/g, '&'), name, 'height=' + height + ',resizable=yes,scrollbars=yes,width=' + width);
	return false;
}

function jumpto()
{
	var page = prompt('Enter the page number you wish to go to:', '2');
	var per_page = '15';
	var base_url = './viewtopic.php?f=3&amp;t=7028';

	if (page !== null && !isNaN(page) && page == Math.floor(page) && page > 0)
	{
		if (base_url.indexOf('?') == -1)
		{
			document.location.href = base_url + '?start=' + ((page - 1) * per_page);
		}
		else
		{
			document.location.href = base_url.replace(/&amp;/g, '&') + '&start=' + ((page - 1) * per_page);
		}
	}
}

/**
* Find a member
*/
function find_username(url)
{
	popup(url, 760, 570, '_usersearch');
	return false;
}

/**
* Mark/unmark checklist
* id = ID of parent container, name = name prefix, state = state [true/false]
*/
function marklist(id, name, state)
{
	var parent = document.getElementById(id);
	if (!parent)
	{
		eval('parent = document.' + id);
	}

	if (!parent)
	{
		return;
	}

	var rb = parent.getElementsByTagName('input');
	
	for (var r = 0; r < rb.length; r++)
	{
		if (rb[r].name.substr(0, name.length) == name)
		{
			rb[r].checked = state;
		}
	}
}



// ]]>
</script>
</head>
<body class="ltr">

<a name="top"></a>

<div id="wrapheader">

	<div id="logodesc">
	</div>

	<div id="menubar">

		<table width="100%" cellspacing="0">
		<tr>
			<td rowspan="2"><a href="./index.php"><img src="./styles/subsilver2/imageset/site_logo.gif" alt="" title="" /></a></td>
			<td width="100%" align="center"><h1>nesdev.com</h1><span class="gen">NES Development and Strangulation Records message boards</span></td>
		</tr>
		<tr>
			<td align="center">
				<a href="./faq.php"><img src="./styles/prosilver/theme/images/icon_mini_faq.gif" width="12" height="13" alt="*" /> FAQ</a>
				&nbsp; &nbsp;<a href="./search.php"><img src="./styles/prosilver/theme/images/icon_mini_search.gif" width="12" height="13" alt="*" /> Search</a>
				<br />	
				 &nbsp;<a href="./ucp.php?mode=register"><img src="./styles/prosilver/theme/images/icon_mini_register.gif" width="12" height="13" alt="*" /> Register</a>
					&nbsp; &nbsp;<a href="./ucp.php?mode=login"><img src="./styles/prosilver/theme/images/icon_mini_login.gif" width="12" height="13" alt="*" /> Login</a>&nbsp;
			</td>
		</tr>
		</table>
	</div>

	<div id="datebar">
		<table width="100%" cellspacing="0">
		<tr>
			<td class="gensmall"></td>
			<td class="gensmall" align="right">It is currently Thu Aug 30, 2012 3:46 pm<br /></td>
		</tr>
		</table>
	</div>

</div>

<div id="wrapcentre">

	
	<p class="searchbar">
		<span style="float: left;"><a href="./search.php?search_id=unanswered">View unanswered posts</a> | <a href="./search.php?search_id=active_topics">View active topics</a></span>
		
	</p>
	

	<br style="clear: both;" />

	<table class="tablebg" width="100%" cellspacing="1" cellpadding="0" style="margin-top: 5px;">
	<tr>
		<td class="row1">
			<p class="breadcrumbs"><a href="./index.php">Board index</a> &#187; <a href="./viewforum.php?f=24">NES / Famicom</a> &#187; <a href="./viewforum.php?f=3">NESemdev</a></p>
			<p class="datetime">All times are UTC - 7 hours </p>
		</td>
	</tr>
	</table>

	<br />

<div id="pageheader">
	<h2><a class="titles" href="./viewtopic.php?f=3&amp;t=7028&amp;start=15">split/wrapping backgrounds in Marble Madness and Battletoads</a></h2>


	<p class="moderators">Moderator: <a href="./memberlist.php?mode=group&amp;g=320">Moderators</a></p>

</div>

<br clear="all" /><br />

<div id="pagecontent">

	<table width="100%" cellspacing="1">
	<tr>
		<td align="left" valign="middle" nowrap="nowrap">
		<a href="./posting.php?mode=post&amp;f=3"><img src="./styles/subsilver2/imageset/en/button_topic_new.gif" alt="Post new topic" title="Post new topic" /></a>&nbsp;<a href="./posting.php?mode=reply&amp;f=3&amp;t=7028"><img src="./styles/subsilver2/imageset/en/button_topic_reply.gif" alt="Reply to topic" title="Reply to topic" /></a>
		</td>
		
			<td class="nav" valign="middle" nowrap="nowrap">&nbsp;Page <strong>2</strong> of <strong>2</strong><br /></td>
			<td class="gensmall" nowrap="nowrap">&nbsp;[ 28 posts ]&nbsp;</td>
			<td class="gensmall" width="100%" align="right" nowrap="nowrap"><b><a href="#" onclick="jumpto(); return false;" title="Click to jump to pageâ€¦">Go to page</a> <a href="./viewtopic.php?f=3&amp;t=7028&amp;start=0">Previous</a>&nbsp;&nbsp;<a href="./viewtopic.php?f=3&amp;t=7028">1</a><span class="page-sep">, </span><strong>2</strong></b></td>
		
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr>
		<td class="cat">
			<table width="100%" cellspacing="0">
			<tr>
				<td class="nav" nowrap="nowrap">&nbsp;
				<a href="./viewtopic.php?f=3&amp;t=7028&amp;start=15&amp;view=print" title="Print view">Print view</a>
				</td>
				<td class="nav" align="right" nowrap="nowrap"><a href="./viewtopic.php?f=3&amp;t=7028&amp;view=previous">Previous topic</a> | <a href="./viewtopic.php?f=3&amp;t=7028&amp;view=next">Next topic</a>&nbsp;</td>
			</tr>
			</table>
		</td>
	</tr>

	</table>


	<table class="tablebg" width="100%" cellspacing="1">
	
		<tr>
			<th>Author</th>
			<th>Message</th>
		</tr>
	<tr class="row1">

			<td align="center" valign="middle">
				<a name="p68472"></a>
				<b class="postauthor">tokumaru</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p68472"></a></div><div style="float: right;"><a href="./viewtopic.php?p=68472#p68472"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Sun Oct 10, 2010 9:20 pm&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				<tr>
					<td><img src="./download/file.php?avatar=95.png" width="80" height="80" alt="User avatar" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Sat Feb 12, 2005 9:43 pm<br /><b>Posts:</b> 5251<br /><b>Location:</b> Rio de Janeiro - Brazil
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody"><a href="http://bootgod.dyndns.org:7777/profile.php?id=23" class="postlink">Yup, Battletoads is AOROM</a>. If you read about this mapper <a href="http://kevtris.org/mappers/nes_discrete/NES_AOROM.html" class="postlink">here</a>, you'll see that it has a bit that selects which name table gets displayed. 
<br />
<br />The mirroring information in the iNES header doesn't mean anything for games with mapper-controlled mirroring, just ignore it.</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=95"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row2">

			<td align="center" valign="middle">
				<a name="p68473"></a>
				<b class="postauthor">miker00lz</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p68473"></a></div><div style="float: right;"><a href="./viewtopic.php?p=68473#p68473"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Sun Oct 10, 2010 9:49 pm&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				<tr>
					<td><img src="./download/file.php?avatar=4572.png" width="100" height="100" alt="User avatar" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Thu Sep 23, 2010 7:28 pm<br /><b>Posts:</b> 145
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody"><div class="quotetitle">tokumaru wrote:</div><div class="quotecontent"><div class="quotetitle">miker00lz wrote:</div><div class="quotecontent">it uses horizontal</div><br />If you got that from the header, don't trust it. That information is useless in games with mapper controlled mirroring.</div>
<br />
<br />ah, you're right. this is the register for mapper 7:
<br />
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">&nbsp; $8000-FFFF:&nbsp; &#91;...M .PPP&#93;<br />&nbsp; &nbsp; M = Mirroring:<br />&nbsp; &nbsp; &nbsp; &nbsp; 0 = 1ScA<br />&nbsp; &nbsp; &nbsp; &nbsp; 1 = 1ScB<br /><br />&nbsp; &nbsp; P = PRG Reg&nbsp; &#40;only 2 bits wide on AMROM/ANROM&#41;</div><br /><br />the other mapper 7 doc i read when putting my code together i must have not understood properly. i thought it was saying if the bit is on, it's 1-screen at 0x2000, otherwise i should use the mirroring layout specified by the header.<br /><br />it now looks like this:<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">&nbsp; &nbsp; &nbsp; &nbsp;case 7:<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if &#40;addr&gt;=0x8000&#41; &#123;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; prgbank1 = &#40;value&amp;0xF&#41;&lt;&lt;2;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; prgbank2 = prgbank1 + 1;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; prgbank3 = prgbank1 + 2;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; prgbank4 = prgbank1 + 3;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if &#40;&#40;value&gt;&gt;4&#41;&amp;1&#41; &#123;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; nametablemap&#91;0&#93; = 0x2400;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; nametablemap&#91;1&#93; = 0x2400;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; nametablemap&#91;2&#93; = 0x2400;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; nametablemap&#91;3&#93; = 0x2400;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#125; else &#123;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; nametablemap&#91;0&#93; = 0x2000;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; nametablemap&#91;1&#93; = 0x2000;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; nametablemap&#91;2&#93; = 0x2000;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; nametablemap&#91;3&#93; = 0x2000;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#125;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </div>
<br />
<br />but it's still doing the same, ALTHOUGH it did fix the glitch on the screen where their ship is flying down to the planet in the intro. that part looks right now. the rest? still glitched the same.
<br />
<br />is that code not correct?</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=4572"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row1">

			<td align="center" valign="middle">
				<a name="p68479"></a>
				<b class="postauthor" style="color: #AA0000">tepples</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p68479"></a></div><div style="float: right;"><a href="./viewtopic.php?p=68479#p68479"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Mon Oct 11, 2010 4:24 am&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				<tr>
					<td><img src="http://pineight.com/nes/terrible/PSRFX.png" width="100" height="56" alt="User avatar" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Sun Sep 19, 2004 11:12 pm<br /><b>Posts:</b> 9047<br /><b>Location:</b> NE Indiana, USA (NTSC)
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">How are you handling nametablemap in whatever handles writes to $2007?</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=9"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row2">

			<td align="center" valign="middle">
				<a name="p68485"></a>
				<b class="postauthor">Zepper</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p68485"></a></div><div style="float: right;"><a href="./viewtopic.php?p=68485#p68485"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Mon Oct 11, 2010 7:29 am&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				<tr>
					<td class="postdetails">Formerly Fx3</td>
				</tr>
			
				<tr>
					<td><img src="./download/file.php?avatar=39.jpg" width="100" height="100" alt="User avatar" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Fri Nov 12, 2004 4:59 pm<br /><b>Posts:</b> 1965<br /><b>Location:</b> Brazil
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody"><div class="quotetitle">miker00lz wrote:</div><div class="quotecontent">also, blargg's 01-vbl_basics.nes ROM still reports "VBL period is way off" even though this is what the frame CPU cycle count along with what tick in the frame the VBI occured at:<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">Frame #0: 29831 &#40;VBI at 27281&#41;<br />Frame #1: 29829 &#40;VBI at 27282&#41;<br />Frame #2: 29828 &#40;VBI at 27280&#41;<br />Frame #3: 29836 &#40;VBI at 27279&#41;<br />Frame #4: 29828 &#40;VBI at 27282&#41;<br />Frame #5: 29830 &#40;VBI at 27280&#41;<br />Frame #6: 29834 &#40;VBI at 27278&#41;<br />Frame #7: 29832 &#40;VBI at 27280&#41;<br />Frame #8: 29837 &#40;VBI at 27278&#41;<br />Frame #9: 29828 &#40;VBI at 27282&#41;<br />Frame #10: 29835 &#40;VBI at 27278&#41;</div><br /><br />is the VBI trigger point wrong?</div>
<br />
<br />- It's not a matter of cycles, but where in the current instruction (or one before) the VBlank flag has raised. AFAIK, your frame timings aren't much helpful though.</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=39"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row1">

			<td align="center" valign="middle">
				<a name="p68499"></a>
				<b class="postauthor">miker00lz</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p68499"></a></div><div style="float: right;"><a href="./viewtopic.php?p=68499#p68499"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Mon Oct 11, 2010 12:57 pm&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				<tr>
					<td><img src="./download/file.php?avatar=4572.png" width="100" height="100" alt="User avatar" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Thu Sep 23, 2010 7:28 pm<br /><b>Posts:</b> 145
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody"><div class="quotetitle">tepples wrote:</div><div class="quotecontent">How are you handling nametablemap in whatever handles writes to $2007?</div>
<br />
<br />well, this is my code to handle PPU reg writes:
<br />
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void PPUwritereg&#40;WORD addr, WORD value&#41; &#123;<br />&nbsp; &nbsp; &nbsp;value = value % 256;<br />&nbsp; &nbsp; &nbsp;#ifdef DEBUGMODE<br />&nbsp; &nbsp; &nbsp; &nbsp;printf&#40;&quot;PPU register write: %x &lt;- %u\n&quot;, addr, value&#41;;<br />&nbsp; &nbsp; &nbsp;#endif<br />&nbsp; &nbsp; &nbsp;PPUregs&#91;addr-0x2000&#93; = value;<br />&nbsp; &nbsp; &nbsp;switch &#40;addr&#41; &#123;<br />&nbsp; &nbsp; &nbsp; &nbsp;case 0x2000:<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if &#40;value&amp;128&#41; PPUdata.nmivblank = 1; else PPUdata.nmivblank = 0;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if &#40;value&amp;32&#41; PPUdata.sprsize = 16; else PPUdata.sprsize = 8;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if &#40;value&amp;16&#41; PPUdata.bgtable = 0x1000; else PPUdata.bgtable = 0x0000;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if &#40;value&amp;8&#41; PPUdata.sprtable = 0x1000; else PPUdata.sprtable = 0x0000;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if &#40;value&amp;4&#41; PPUdata.addrinc = 32; else PPUdata.addrinc = 1;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PPUdata.nametable = value&amp;3;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;<br />&nbsp; &nbsp; &nbsp; &nbsp;case 0x2001:<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if &#40;value&amp;16&#41; PPUdata.sprvisible = 1; else PPUdata.sprvisible = 0;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if &#40;value&amp;8&#41; PPUdata.bgvisible = 1; else PPUdata.bgvisible = 0;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if &#40;value&amp;4&#41; PPUdata.sprclip = 1; else PPUdata.sprclip = 0;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if &#40;value&amp;2&#41; PPUdata.bgclip = 1; else PPUdata.bgclip = 0;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;<br />&nbsp; &nbsp; &nbsp; &nbsp;case 0x2002:<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;PPUwrite&#40;VRAMaddr, value&#41;;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;<br />&nbsp; &nbsp; &nbsp; &nbsp;case 0x2003:<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; SpriteAddr = value;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;<br />&nbsp; &nbsp; &nbsp; &nbsp;case 0x2004:<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; SpriteRAM&#91;SpriteAddr&#93; = value;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; SpriteAddr = &#40;SpriteAddr+1&#41; % 256;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;<br />&nbsp; &nbsp; &nbsp; &nbsp;case 0x2005:<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if &#40;ScrollLatch&#41; &#123;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; hscroll = value;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ScrollLatch = 0;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#125; else &#123;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; vscroll = value;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ScrollLatch = 1;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#125;<br />&nbsp; &nbsp; &nbsp; &nbsp;case 0x2006:<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if &#40;PPULatch&#41; &#123;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; VRAMaddr = &#40;VRAMaddr &amp; 0xFF&#41; + &#40;value&lt;&lt;8&#41;;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PPULatch = 0;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#125; else &#123;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; VRAMaddr = &#40;VRAMaddr &amp; 0xFF00&#41; + value;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PPULatch = 1;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#125;<br />&nbsp; &nbsp; &nbsp; &nbsp;case 0x2007:<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PPUwrite&#40;VRAMaddr, value&#41;;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; VRAMaddr = &#40;VRAMaddr + PPUdata.addrinc&#41; % 16384;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;<br />&nbsp; &nbsp; &nbsp;&#125;<br />&#125;</div><br /><br /><br /><br />and reg reads:<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">WORD PPUreadreg&#40;WORD addr&#41; &#123;<br />&nbsp; &nbsp; &nbsp;WORD tmpword;<br />&nbsp; &nbsp; &nbsp;switch &#40;addr&#41; &#123;<br />&nbsp; &nbsp; &nbsp; &nbsp;case 0x2002:<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tmpword = &#40;PPUdata.vblank*128&#41;+&#40;PPUdata.spr0hit*64&#41;+&#40;PPUdata.sprcount*32&#41;+&#40;PPUdata.vramwrite*16&#41;+&#40;PPUregs&#91;2&#93;&amp;15&#41;;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PPUdata.vblank = 0;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PPULatch = 1;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ScrollLatch = 1;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if &#40;tracelog==1&#41; printf&#40;&quot;PPU register read: %x &#40;value is %x&#41;\n&quot;, addr, tmpword&#41;;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return tmpword;<br />&nbsp; &nbsp; &nbsp; &nbsp;case 0x2004:<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return SpriteRAM&#91;SpriteAddr&#93;;<br />&nbsp; &nbsp; &nbsp; &nbsp;case 0x2007:<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tmpword = PPUread&#40;VRAMaddr&#41;;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; VRAMaddr = &#40;VRAMaddr + PPUdata.addrinc&#41; % 16384;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return tmpword;<br />&nbsp; &nbsp; &nbsp;&#125;<br />&nbsp; &nbsp; &nbsp;return PPUregs&#91;addr-0x2000&#93;;<br />&#125;</div><br /><br /><br />the name table address mapping is taken care of in the general PPU write function:<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void PPUwrite&#40;WORD addr, WORD value&#41;&#123;<br />&nbsp; value = value % 256;<br />&nbsp; if &#40;addr&gt;=0x3F00 &amp;&amp; addr&lt;=0x3FFF&#41; addr = &#40;addr&amp;0x3F&#41;+0x3F00;<br />&nbsp; if &#40;addr==0x3F00 || addr==0x3F10&#41; &#123; VRAM&#91;0x3F00&#93; = value; VRAM&#91;0x3F10&#93; = value; return; &#125;<br />&nbsp; if &#40;addr==0x3F04 || addr==0x3F14&#41; &#123; VRAM&#91;0x3F04&#93; = value; VRAM&#91;0x3F14&#93; = value; return; &#125;<br />&nbsp; if &#40;addr==0x3F08 || addr==0x3F18&#41; &#123; VRAM&#91;0x3F08&#93; = value; VRAM&#91;0x3F18&#93; = value; return; &#125;<br />&nbsp; if &#40;addr==0x3F0C || addr==0x3F1C&#41; &#123; VRAM&#91;0x3F0C&#93; = value; VRAM&#91;0x3F1C&#93; = value; return; &#125;<br />&nbsp; if &#40;addr&gt;0x2FFF &amp;&amp; addr&lt;0x3F00&#41; addr = &#40;addr&amp;0xEFF&#41; + 0x3000;<br />&nbsp; if &#40;addr&gt;0x3FFF&#41; addr = addr - 0x4000;<br />&nbsp; if &#40;addr&gt;=0x2000 &amp;&amp; addr&lt;0x2400&#41; addr = &#40;addr - 0x2000&#41; + nametablemap&#91;0&#93;;<br />&nbsp; &nbsp; else if &#40;addr&gt;=0x2400 &amp;&amp; addr&lt;0x2800&#41; addr = &#40;addr - 0x2400&#41; + nametablemap&#91;1&#93;;<br />&nbsp; &nbsp; &nbsp; else if &#40;addr&gt;=0x2800 &amp;&amp; addr&lt;0x2C00&#41; addr = &#40;addr - 0x2800&#41; + nametablemap&#91;2&#93;;<br />&nbsp; &nbsp; &nbsp; &nbsp; else if &#40;addr&gt;=0x2C00 &amp;&amp; addr&lt;0x3000&#41; addr = &#40;addr - 0x2C00&#41; + nametablemap&#91;3&#93;;<br />&nbsp; VRAM&#91;addr&#93; = value;<br />&nbsp; if &#40;addr&lt;0x2000 &amp;&amp; ROM.chrcount==0&#41; makeCHRcache&#40;addr&gt;&gt;4&#41;;<br />&#125;</div><br /><br /><br />and here's the how the background rendering function reads the NT data:<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">&nbsp; &nbsp; &nbsp; &nbsp; if &#40;x&gt;=st&#41; &#123;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;switch &#40;PPUdata.nametable&#41; &#123;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;case 0: calcx = x; calcy = scanline; break;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;case 1: calcx = x + 256; calcy = scanline; break;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;case 2: calcx = x; calcy = scanline + 240; break;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;case 3: calcx = x + 256; calcy = scanline + 240; break;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&#125;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;calcx = &#40;calcx + hscroll&#41; % 512;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;calcy = &#40;calcy + vscroll&#41; % 480;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; attribbyte = attriblookup&#91;calcx&gt;&gt;5&#93;&#91;calcy&gt;&gt;5&#93;;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if &#40;calcx&lt;256 &amp;&amp; calcy&lt;240&#41; usent = 0;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if &#40;calcx&gt;255 &amp;&amp; calcy&lt;240&#41; usent = 1;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if &#40;calcx&lt;256 &amp;&amp; calcy&gt;239&#41; usent = 2;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if &#40;calcx&gt;255 &amp;&amp; calcy&gt;239&#41; usent = 3;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;calcx = calcx % 256; calcy = calcy % 240;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ntval = nametablemap&#91;usent&#93; + &#40;&#40;calcy&gt;&gt;3&#41;&lt;&lt;5&#41; + &#40;calcx&gt;&gt;3&#41;;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if &#40;PPUdata.bgtable==0&#41; ntval = PPUread&#40;ntval&#41;; else ntval = PPUread&#40;ntval&#41; + 256;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;curpixel = CHRcache&#91;ntval&#93;&#91;calcx%8&#93;&#91;calcy%8&#93;;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if &#40;&#40;curpixel&amp;3&#41;&gt;0&#41; &#123;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;attribx = calcx&gt;&gt;5; attriby = calcy&gt;&gt;5;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;attriboffset = &#40;attriby&lt;&lt;3&#41; + attribx;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;attribbyte = PPUread&#40;nametablemap&#91;usent&#93; + 0x3C0 + attriboffset&#41;;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;xmod = &#40;calcx%32&#41;; ymod = &#40;calcy%32&#41;;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if &#40;xmod&lt;=15 &amp;&amp; ymod&lt;=15&#41; attribbyte = attribbyte&amp;0x3;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if &#40;xmod&gt;=16 &amp;&amp; ymod&lt;=15&#41; attribbyte = &#40;attribbyte&amp;0xC&#41;&gt;&gt;2;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if &#40;xmod&lt;=15 &amp;&amp; ymod&gt;=16&#41; attribbyte = &#40;attribbyte&amp;0x30&#41;&gt;&gt;4;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if &#40;xmod&gt;=16 &amp;&amp; ymod&gt;=16&#41; attribbyte = &#40;attribbyte&amp;0xC0&#41;&gt;&gt;6;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;backgnd&#91;x&#93; = 0x3F00 + curpixel + &#40;attribbyte&lt;&lt;2&#41;;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#125;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&#125;</div></div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=4572"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row2">

			<td align="center" valign="middle">
				<a name="p68505"></a>
				<b class="postauthor">MottZilla</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p68505"></a></div><div style="float: right;"><a href="./viewtopic.php?p=68505#p68505"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Mon Oct 11, 2010 5:10 pm&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				<tr>
					<td><img src="./download/file.php?avatar=1726.jpg" width="100" height="100" alt="User avatar" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Wed Dec 06, 2006 8:18 pm<br /><b>Posts:</b> 1799
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">Your "PPULatch" and "ScrollLatch" should be the same variable. There isn't two of them operating independently.
<br />
<br />As stated, Battletoads uses "One Screen Mirroring". This means all 4 nametables in PPU space point to the same memory. Battletoads can and does change which nametable its drawing from and will do so mid-frame. So you need to have your "Latch" behavior correct.
<br />
<br />Also, your implementation of $2000 and $2005 doesn't look accurate. It should work for alot of games or most depending on how you render, but it won't work for all. Refer to Loopy's document on scrolling for why.</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=1726"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row1">

			<td align="center" valign="middle">
				<a name="p68506"></a>
				<b class="postauthor">cpow</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p68506"></a></div><div style="float: right;"><a href="./viewtopic.php?p=68506#p68506"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Mon Oct 11, 2010 6:32 pm&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				<tr>
					<td class="postdetails">NESICIDE developer</td>
				</tr>
			
				<tr>
					<td><img src="./download/file.php?avatar=3705.png" width="100" height="60" alt="User avatar" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Mon Oct 13, 2008 7:55 pm<br /><b>Posts:</b> 697<br /><b>Location:</b> Minneapolis, MN
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody"><div class="quotetitle">Zepper wrote:</div><div class="quotecontent"><div class="quotetitle">miker00lz wrote:</div><div class="quotecontent">also, blargg's 01-vbl_basics.nes ROM still reports "VBL period is way off" even though this is what the frame CPU cycle count along with what tick in the frame the VBI occured at:<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">Frame #0: 29831 &#40;VBI at 27281&#41;<br />Frame #1: 29829 &#40;VBI at 27282&#41;<br />Frame #2: 29828 &#40;VBI at 27280&#41;<br />Frame #3: 29836 &#40;VBI at 27279&#41;<br />Frame #4: 29828 &#40;VBI at 27282&#41;<br />Frame #5: 29830 &#40;VBI at 27280&#41;<br />Frame #6: 29834 &#40;VBI at 27278&#41;<br />Frame #7: 29832 &#40;VBI at 27280&#41;<br />Frame #8: 29837 &#40;VBI at 27278&#41;<br />Frame #9: 29828 &#40;VBI at 27282&#41;<br />Frame #10: 29835 &#40;VBI at 27278&#41;</div><br /><br />is the VBI trigger point wrong?</div><br /><br />- It's not a matter of cycles, but where in the current instruction (or one before) the VBlank flag has raised. AFAIK, your frame timings aren't much helpful though.</div>
<br />
<br />mikeroolz, it seems to me that what is being tested is the period where VBLANK is high.  If I interpret your (useful...not sure why zepper finds them unhelpful?) cycle logs above I see that you're VBLANK is ~2550 cycles long instead of the expected 6820/3 [for NTSC] which is 2273.3333.  So, blargg's test rom is telling you your VBLANK is active too long.
<br />
<br />However, I don't seem to have 01_vbl_timing.nes in my repository.  I'll look for it.</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=3705"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row2">

			<td align="center" valign="middle">
				<a name="p68508"></a>
				<b class="postauthor">tokumaru</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p68508"></a></div><div style="float: right;"><a href="./viewtopic.php?p=68508#p68508"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Mon Oct 11, 2010 6:58 pm&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				<tr>
					<td><img src="./download/file.php?avatar=95.png" width="80" height="80" alt="User avatar" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Sat Feb 12, 2005 9:43 pm<br /><b>Posts:</b> 5251<br /><b>Location:</b> Rio de Janeiro - Brazil
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">It seems to me like you're too attached to the conceptual way in which the PPU appears to work, rather than the actual hardware implementation.
<br />
<br />Like MottZilla said, there's only one latch, shared by $2005 and $2006. Also, writes to $2000 (the lower 2 bits), $2005 and $2006 all affect the internal VRAM address, but it looks like you are keeping things separated. You have a set of variables for VRAM access and another for name table rendering, but the NES has actually only one pointer it uses for PPU accesses. To better emulate the PPU you should be using VRAMaddr for that, and letting writes to $2000 and $2005 affect VRAMaddr. So take a look at <a href="http://nesdev.com/loopyppu.zip" class="postlink">loopy's document</a> so you know how the VRAM address is affected by writes to those 3 registers.
<br />
<br />IIRC, Batletoads keeps rendering disabled for a few scanlines after VBlank ends in order to write more data to VRAM, so it most likely uses tricks (mixed writes to $2005 and $2006) in order to set the scroll, and since you are not handling these registers correctly the scroll gets messed up.</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=95"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row1">

			<td align="center" valign="middle">
				<a name="p68529"></a>
				<b class="postauthor">miker00lz</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p68529"></a></div><div style="float: right;"><a href="./viewtopic.php?p=68529#p68529"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Tue Oct 12, 2010 1:03 pm&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				<tr>
					<td><img src="./download/file.php?avatar=4572.png" width="100" height="100" alt="User avatar" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Thu Sep 23, 2010 7:28 pm<br /><b>Posts:</b> 145
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">thanks for all the clarification, that explains a lot. micro machines has pretty glitchy graphics as well during the menus. during actual gameplay, it looks great though. that might also be related to these problems.
<br />
<br />other than those 3 games, everything else i've tried to play seems to work pretty much flawlessly. i'm going to get to work fixing these bugs.
<br />
<br />as long as i'm fixing bugs, i also have an unrelated question about mapper 1. i've read multiple docs on it, including on the wiki, on kevtris.org, and a few on zophar's domain but i just can't ever seem to get my mapper 1 code working at all.
<br />
<br />some games seem to enable the background, as the screen goes black from the initial grey but then they stop exection in it's tracks and PC sits at 0 until i quit the emulator.
<br />
<br />other mapper 1 games keep the grey screen on, but appear to go into a short infinite loop until execution is stopped. hopefully somebody can point out the error(s?) in this code for me, because i've i've been struggling with this one for a while.
<br />
<br />keep in mind, when parsing the iNES header, i multiply the PRG count by 16 so any ROM.prgcount&gt;&gt;4 isn't a mistake.
<br />
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">&nbsp; &nbsp; &nbsp; &nbsp;case 1:<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if &#40;prgramenabled==0 &amp;&amp; addr&gt;0x4017 &amp;&amp; addr&lt;0x8000&#41; return;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if &#40;addr&gt;=0x8000&#41; &#123;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if &#40;value&amp;128&#41; &#123;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; map1reg&#91;0&#93; = &#40;map1reg&#91;0&#93;&amp;0xF3&#41;+0xC; //bits 2, 3 set - others unchanged<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; map1bitpos = 0; map1accum = 0;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; SwapPRG&#40;1, &#40;ROM.prgcount&gt;&gt;1&#41;-1, 16384&#41;;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#125;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; map1accum = &#40;map1accum&lt;&lt;1&#41; + value&amp;1; //&#40;map1accum&gt;&gt;1&#41; + &#40;value&amp;1&#41;&lt;&lt;4;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if &#40;map1bitpos==4&#41; &#123;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if &#40;addr&gt;=0xE000&#41; &#123;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; map1reg&#91;3&#93; = map1accum;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#125; else if &#40;addr&gt;=0xC000&#41; &#123;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; map1reg&#91;2&#93; = map1accum;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#125; else if &#40;addr&gt;=0xA000&#41; &#123;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; map1reg&#91;1&#93; = map1accum;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#125; else map1reg&#91;0&#93; = map1accum;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; map1calc&#40;&#41;;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; map1bitpos = 0; map1accum = 0;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#125;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; map1bitpos = &#40;map1bitpos + 1&#41; % 5;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#125;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;<br /></div><br /><br /><br /><br />and here is the map1calc() routine that it calls after getting all 5 bits:<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void map1calc&#40;&#41; &#123;<br />&nbsp; WORD prgval, chrval;<br />&nbsp; switch &#40;map1reg&#91;0&#93;&amp;3&#41; &#123;<br />&nbsp; &nbsp; case 0:<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;nametablemap&#91;0&#93; = 0x2000;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;nametablemap&#91;1&#93; = 0x2000;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;nametablemap&#91;2&#93; = 0x2000;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;nametablemap&#91;3&#93; = 0x2000; break;<br />&nbsp; &nbsp; case 1:<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;nametablemap&#91;0&#93; = 0x2400;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;nametablemap&#91;1&#93; = 0x2400;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;nametablemap&#91;2&#93; = 0x2400;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;nametablemap&#91;3&#93; = 0x2400; break;<br />&nbsp; &nbsp; case 2:<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;nametablemap&#91;0&#93; = 0x2000;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;nametablemap&#91;1&#93; = 0x2400;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;nametablemap&#91;2&#93; = 0x2000;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;nametablemap&#91;3&#93; = 0x2400; break;<br />&nbsp; &nbsp; case 3:<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;nametablemap&#91;0&#93; = 0x2000;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;nametablemap&#91;1&#93; = 0x2000;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;nametablemap&#91;2&#93; = 0x2400;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;nametablemap&#91;3&#93; = 0x2400; break;<br />&nbsp; &#125;<br />&nbsp; if &#40;map1reg&#91;0&#93;&amp;8&#41; &#123;<br />&nbsp; &nbsp; if &#40;map1reg&#91;0&#93;&amp;4&#41; &#123; SwapPRG&#40;0, map1reg&#91;3&#93;&amp;0xF, 16384&#41;; SwapPRG&#40;1, &#40;ROM.prgcount&gt;&gt;4&#41;-1, 16384&#41;; &#125;<br />&nbsp; &nbsp; &nbsp; else &#123; SwapPRG&#40;0, 0, 16384&#41;; SwapPRG&#40;1, map1reg&#91;3&#93;&amp;0xF, 16384&#41;; &#125;<br />&nbsp; &#125; else &#123;<br />&nbsp; &nbsp; SwapPRG&#40;0, &#40;map1reg&#91;3&#93;&amp;0xF&#41;&gt;&gt;1, 32768&#41;;<br />&nbsp; &#125;<br />&nbsp; if &#40;map1reg&#91;0&#93;&amp;16&#41; &#123;<br />&nbsp; &nbsp; SwapCHR&#40;0, map1reg&#91;1&#93;&amp;1, 4096&#41;;<br />&nbsp; &nbsp; SwapCHR&#40;1, map1reg&#91;2&#93;&amp;1, 4096&#41;;&nbsp; &nbsp; <br />&nbsp; &#125; else &#123;<br />&nbsp; &nbsp; SwapCHR&#40;0, &#40;map1reg&#91;1&#93;&gt;&gt;1&#41;&amp;1, 8192&#41;;<br />&nbsp; &#125;<br />&#125;</div><br /><br /><br /><br /><br />and for completeness, here are the PRG/CHR bank swap functions - but those 100% perfectly, no problems with mapper 2 and 7 using them.<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void SwapPRG&#40;BYTE banknum, WORD newchunk, WORD banksize&#41; &#123;<br />&nbsp; &nbsp; &nbsp;WORD tmpstart, tmplen, tmpcur, tmpcur2;<br />&nbsp; &nbsp; &nbsp;tmpstart = &#40;newchunk*banksize&#41;&gt;&gt;10;<br />&nbsp; &nbsp; &nbsp;tmplen = banksize&gt;&gt;10;<br />&nbsp; &nbsp; &nbsp;tmpcur2 = &#40;banknum*banksize&#41;&gt;&gt;10;<br />&nbsp; &nbsp; &nbsp;for &#40;tmpcur=0; tmpcur&lt;tmplen; tmpcur++&#41; PRGbank&#91;tmpcur2++&#93; = tmpstart++;<br />&#125;<br /><br />void SwapCHR&#40;BYTE banknum, WORD newchunk, WORD banksize&#41; &#123;<br />&nbsp; &nbsp; &nbsp;WORD tmpstart, tmplen, tmpcur, tmpcur2;<br />&nbsp; &nbsp; &nbsp;tmpstart = &#40;newchunk*banksize&#41;&gt;&gt;10;<br />&nbsp; &nbsp; &nbsp;tmplen = banksize&gt;&gt;10;<br />&nbsp; &nbsp; &nbsp;tmpcur2 = &#40;banknum*banksize&#41;&gt;&gt;10;<br />&nbsp; &nbsp; &nbsp;for &#40;tmpcur=0; tmpcur&lt;tmplen; tmpcur++&#41; CHRbank&#91;tmpcur2++&#93; = tmpstart++;<br />&#125;</div><br /><br /><br /><br />yesterday i went through and modified the way my emu stores PRG and CHR ROM data to 32 1KB bank chunks for PRG, and 8 1KB bank chunks for CHR, and then wrote those two routines. i thought this would make implementing the various mappers a much simpler task without having to worry about varying bank sizes. just call the function supplying the bank size and have it do the math automatically.<br /><br /><br />EDIT: i forgot to mention, after loading the ROM into memory i have this code run before emulation begins if it's a mapper 1 ROM:<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">SwapPRG&#40;0, 0, 16384&#41;; SwapPRG&#40;1, &#40;ROM.prgcount&gt;&gt;4&#41;-1, 16384&#41;;</div></div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=4572"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row2">

			<td align="center" valign="middle">
				<a name="p68559"></a>
				<b class="postauthor">miker00lz</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p68559"></a></div><div style="float: right;"><a href="./viewtopic.php?p=68559#p68559"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Tue Oct 12, 2010 10:04 pm&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				<tr>
					<td><img src="./download/file.php?avatar=4572.png" width="100" height="100" alt="User avatar" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Thu Sep 23, 2010 7:28 pm<br /><b>Posts:</b> 145
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">ah never mind i finally got mapper 1 going.
<br />
<br />this line in the first chunk of pasted code:
<br />SwapPRG(1, (ROM.prgcount&gt;&gt;1)-1, 16384);
<br />
<br />should have:
<br />A) been &gt;&gt;4 not &gt;&gt;1
<br />and more importantly
<br />B) shouldn't have been in there at all in the first place heh.
<br />
<br />
<br />and i changed the shift register code to:
<br />map1accum |= (value&amp;1) &lt;&lt; map1bitpos;
<br />
<br />all is good now. a couple dumb mistakes.</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=4572"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row1">

			<td align="center" valign="middle">
				<a name="p68562"></a>
				<b class="postauthor">Zepper</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p68562"></a></div><div style="float: right;"><a href="./viewtopic.php?p=68562#p68562"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Wed Oct 13, 2010 5:12 am&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				<tr>
					<td class="postdetails">Formerly Fx3</td>
				</tr>
			
				<tr>
					<td><img src="./download/file.php?avatar=39.jpg" width="100" height="100" alt="User avatar" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Fri Nov 12, 2004 4:59 pm<br /><b>Posts:</b> 1965<br /><b>Location:</b> Brazil
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">- This is a way of masking the PRG page value written. Switching banks <em>should</em> use the following:
<br />
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">* if PRG pages is a power of 2:<br /><br />08k: &#40;PRG &gt;&gt; 1&#41; - 1<br />16k: PRG - 1<br />32k: &#40;PRG &lt;&lt; 1&#41; - 1</div>
<br />
<br />- You're messing up the things I suppose. The PRG page value for mapper 1 is composed of 4 bits. Masking the value isn't really required. If you got the mapper working, perhaps it was lucky only.
<br />
<br />- Regarding the number of cycles per frame, perhaps I was trying to imply a finetunning in the timing, as I had to do a lot of times.</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=39"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row2">

			<td align="center" valign="middle">
				<a name="p68565"></a>
				<b class="postauthor" style="color: #AA0000">tepples</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p68565"></a></div><div style="float: right;"><a href="./viewtopic.php?p=68565#p68565"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Wed Oct 13, 2010 7:37 am&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				<tr>
					<td><img src="http://pineight.com/nes/terrible/PSRFX.png" width="100" height="56" alt="User avatar" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Sun Sep 19, 2004 11:12 pm<br /><b>Posts:</b> 9047<br /><b>Location:</b> NE Indiana, USA (NTSC)
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody"><div class="quotetitle">Zepper wrote:</div><div class="quotecontent">The PRG page value for mapper 1 is composed of 4 bits. Masking the value isn't really required.</div>
<br />For one thing, the PRG ROM bank number shares a register address with a PRG RAM enable. For another, in the SUROM board (MMC1, 512 KiB PRG ROM, 0 byte CHR ROM), the bits from this register are combined with a bit from another register to form the effective PRG RAM address.</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=9"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row1">

			<td align="center" valign="middle">
				<a name="p68603"></a>
				<b class="postauthor">miker00lz</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p68603"></a></div><div style="float: right;"><a href="./viewtopic.php?p=68603#p68603"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Thu Oct 14, 2010 1:26 am&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				<tr>
					<td><img src="./download/file.php?avatar=4572.png" width="100" height="100" alt="User avatar" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Thu Sep 23, 2010 7:28 pm<br /><b>Posts:</b> 145
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody"><div class="quotetitle">Zepper wrote:</div><div class="quotecontent">- This is a way of masking the PRG page value written. Switching banks <em>should</em> use the following:<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">* if PRG pages is a power of 2:<br /><br />08k: &#40;PRG &gt;&gt; 1&#41; - 1<br />16k: PRG - 1<br />32k: &#40;PRG &lt;&lt; 1&#41; - 1</div><br /><br />- You're messing up the things I suppose. The PRG page value for mapper 1 is composed of 4 bits. Masking the value isn't really required. If you got the mapper working, perhaps it was lucky only.<br /><br />- Regarding the number of cycles per frame, perhaps I was trying to imply a finetunning in the timing, as I had to do a lot of times.</div>
<br />
<br />- 1? i thought the values in registers were already base zero. ROMs seem to run fine when switching banks. megaman 2 for example, runs perfectly. ninja gaiden doesn't have any PRG switching problems, although it seems to choose the wrong CHR banks for some screens. (title and cut scenes)
<br />
<br />metroid does the same thing. i think i might need to AND the CHR banks to ensure only up to a 4-bit value. megaman 2 uses no CHR ROM, so that would explain it running perfectly.
<br />
<br />
<br />EDIT: oh, i see what you meant. but no, i have the PRG banks divided up into 1 KB chunks, and i multiply the PRG bank total count by 16 to match. when i load the ROM. that might have been confusing if you didn't realize that.
<br />
<br />don't worry i do know basic math. <img src="./images/smilies/icon_wink.gif" alt=";)" title="Wink" />
<br />
<br />my SwapPRG and SwapCHR functions take care of any conversions necessary when i give it the bank size it needs to deal with in bytes. i thought this would be the simplest way to implement other matters later that would work in all kinds of various swap sizes.</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=4572"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table width="100%" cellspacing="1" class="tablebg">
	<tr align="center">
		<td class="cat"><form name="viewtopic" method="post" action="./viewtopic.php?f=3&amp;t=7028&amp;start=15"><span class="gensmall">Display posts from previous:</span> <select name="st" id="st"><option value="0" selected="selected">All posts</option><option value="1">1 day</option><option value="7">7 days</option><option value="14">2 weeks</option><option value="30">1 month</option><option value="90">3 months</option><option value="180">6 months</option><option value="365">1 year</option></select>&nbsp;<span class="gensmall">Sort by</span> <select name="sk" id="sk"><option value="a">Author</option><option value="t" selected="selected">Post time</option><option value="s">Subject</option></select> <select name="sd" id="sd"><option value="a" selected="selected">Ascending</option><option value="d">Descending</option></select>&nbsp;<input class="btnlite" type="submit" value="Go" name="sort" /></form></td>
	</tr>
	</table>
	

	<table width="100%" cellspacing="1">
	<tr>
		<td align="left" valign="middle" nowrap="nowrap">
		<a href="./posting.php?mode=post&amp;f=3"><img src="./styles/subsilver2/imageset/en/button_topic_new.gif" alt="Post new topic" title="Post new topic" /></a>&nbsp;<a href="./posting.php?mode=reply&amp;f=3&amp;t=7028"><img src="./styles/subsilver2/imageset/en/button_topic_reply.gif" alt="Reply to topic" title="Reply to topic" /></a>
		</td>
		
			<td class="nav" valign="middle" nowrap="nowrap">&nbsp;Page <strong>2</strong> of <strong>2</strong><br /></td>
			<td class="gensmall" nowrap="nowrap">&nbsp;[ 28 posts ]&nbsp;</td>
			<td class="gensmall" width="100%" align="right" nowrap="nowrap"><b><a href="#" onclick="jumpto(); return false;" title="Click to jump to pageâ€¦">Go to page</a> <a href="./viewtopic.php?f=3&amp;t=7028&amp;start=0">Previous</a>&nbsp;&nbsp;<a href="./viewtopic.php?f=3&amp;t=7028">1</a><span class="page-sep">, </span><strong>2</strong></b></td>
		
	</tr>
	</table>

</div>

<div id="pagefooter"></div>

<br clear="all" />
<table class="tablebg" width="100%" cellspacing="1" cellpadding="0" style="margin-top: 5px;">
	<tr>
		<td class="row1">
			<p class="breadcrumbs"><a href="./index.php">Board index</a> &#187; <a href="./viewforum.php?f=24">NES / Famicom</a> &#187; <a href="./viewforum.php?f=3">NESemdev</a></p>
			<p class="datetime">All times are UTC - 7 hours </p>
		</td>
	</tr>
	</table>
	<br clear="all" />

	<table class="tablebg" width="100%" cellspacing="1">
	<tr>
		<td class="cat"><h4>Who is online</h4></td>
	</tr>
	<tr>
		<td class="row1"><p class="gensmall">Users browsing this forum: No registered users and 2 guests</p></td>
	</tr>
	</table>


<br clear="all" />

<table width="100%" cellspacing="1">
<tr>
	<td width="40%" valign="top" nowrap="nowrap" align="left"></td>
	<td align="right" valign="top" nowrap="nowrap"><span class="gensmall">You <strong>cannot</strong> post new topics in this forum<br />You <strong>cannot</strong> reply to topics in this forum<br />You <strong>cannot</strong> edit your posts in this forum<br />You <strong>cannot</strong> delete your posts in this forum<br />You <strong>cannot</strong> post attachments in this forum<br /></span></td>
</tr>
</table>

<br clear="all" />

<table width="100%" cellspacing="0">
<tr>
	<td><form method="get" name="search" action="./search.php"><span class="gensmall">Search for:</span> <input class="post" type="text" name="keywords" size="20" /> <input class="btnlite" type="submit" value="Go" /><input type="hidden" name="t" value="7028" />
<input type="hidden" name="sf" value="msgonly" />
</form></td>
	<td align="right">
	<form method="post" name="jumpbox" action="./viewforum.php" onsubmit="if(document.jumpbox.f.value == -1){return false;}">

	<table cellspacing="0" cellpadding="0" border="0">
	<tr>
		<td nowrap="nowrap"><span class="gensmall">Jump to:</span>&nbsp;<select name="f" onchange="if(this.options[this.selectedIndex].value != -1){ document.forms['jumpbox'].submit() }">

		
			<option value="-1">Select a forum</option>
		<option value="-1">------------------</option>
			<option value="24">NES / Famicom</option>
		
			<option value="2">&nbsp; &nbsp;NESdev</option>
		
			<option value="3" selected="selected">&nbsp; &nbsp;NESemdev</option>
		
			<option value="21">&nbsp; &nbsp;NES Graphics</option>
		
			<option value="6">&nbsp; &nbsp;NES Music</option>
		
			<option value="9">&nbsp; &nbsp;NES Hardware and Flash Equipment</option>
		
			<option value="22">&nbsp; &nbsp;Homebrew Projects</option>
		
			<option value="10">&nbsp; &nbsp;Newbie Help Center</option>
		
			<option value="11">&nbsp; &nbsp;FCdev</option>
		
			<option value="18">&nbsp; &nbsp;NESdev China</option>
		
			<option value="19">&nbsp; &nbsp;NESdev International</option>
		
			<option value="25">Other</option>
		
			<option value="5">&nbsp; &nbsp;General Stuff</option>
		
			<option value="4">&nbsp; &nbsp;Membler Industries</option>
		
			<option value="12">&nbsp; &nbsp;SNESdev</option>
		
			<option value="20">&nbsp; &nbsp;GBDev</option>
		
			<option value="23">&nbsp; &nbsp;Other Retro Dev</option>
		
			<option value="15">&nbsp; &nbsp;Test Forum</option>
		
			<option value="26">Site Issues</option>
		
			<option value="13">&nbsp; &nbsp;phpBB Issues</option>
		
			<option value="14">&nbsp; &nbsp;Web Issues</option>
		
			<option value="16">&nbsp; &nbsp;nesdevWiki</option>
		

		</select>&nbsp;<input class="btnlite" type="submit" value="Go" /></td>
	</tr>
	</table>

	</form>
</td>
</tr>
</table>


</div>

<div id="wrapfooter">
	
	<span class="copyright">Powered by <a href="http://www.phpbb.com/">phpBB</a>&reg; Forum Software &copy; phpBB Group
	</span>
</div>

</body>
</html>