<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en-gb" xml:lang="en-gb">
<head>

<link rel="icon" href="/favicon.ico" type="image/x-icon" />
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
<meta http-equiv="content-language" content="en-gb" />
<meta http-equiv="content-style-type" content="text/css" />
<meta http-equiv="imagetoolbar" content="no" />
<meta name="resource-type" content="document" />
<meta name="distribution" content="global" />
<meta name="keywords" content="" />
<meta name="description" content="" />

<title>nesdev.com &bull; View topic - higan CPU emulation mode bug? (attn: byuu or any 65816 guru)</title>

<link rel="alternate" type="application/atom+xml" title="Feed - nesdev.com" href="http://forums.nesdev.com/feed.php" /><link rel="alternate" type="application/atom+xml" title="Feed - News" href="http://forums.nesdev.com/feed.php?mode=news" /><link rel="alternate" type="application/atom+xml" title="Feed - All forums" href="http://forums.nesdev.com/feed.php?mode=forums" /><link rel="alternate" type="application/atom+xml" title="Feed - New Topics" href="http://forums.nesdev.com/feed.php?mode=topics" /><link rel="alternate" type="application/atom+xml" title="Feed - Active Topics" href="http://forums.nesdev.com/feed.php?mode=topics_active" /><link rel="alternate" type="application/atom+xml" title="Feed - Forum - SNESdev" href="http://forums.nesdev.com/feed.php?f=12" /><link rel="alternate" type="application/atom+xml" title="Feed - Topic - higan CPU emulation mode bug? (attn: byuu or any 65816 guru)" href="http://forums.nesdev.com/feed.php?f=12&amp;t=14281" />

<link rel="stylesheet" href="./style.php?id=1&amp;lang=en" type="text/css" />

<script type="text/javascript">
// <![CDATA[


function popup(url, width, height, name)
{
	if (!name)
	{
		name = '_popup';
	}

	window.open(url.replace(/&amp;/g, '&'), name, 'height=' + height + ',resizable=yes,scrollbars=yes,width=' + width);
	return false;
}

function jumpto()
{
	var page = prompt('Enter the page number you wish to go to:', '8');
	var per_page = '15';
	var base_url = './viewtopic.php?f=12&amp;t=14281';

	if (page !== null && !isNaN(page) && page == Math.floor(page) && page > 0)
	{
		if (base_url.indexOf('?') == -1)
		{
			document.location.href = base_url + '?start=' + ((page - 1) * per_page);
		}
		else
		{
			document.location.href = base_url.replace(/&amp;/g, '&') + '&start=' + ((page - 1) * per_page);
		}
	}
}

/**
* Find a member
*/
function find_username(url)
{
	popup(url, 760, 570, '_usersearch');
	return false;
}

/**
* Mark/unmark checklist
* id = ID of parent container, name = name prefix, state = state [true/false]
*/
function marklist(id, name, state)
{
	var parent = document.getElementById(id);
	if (!parent)
	{
		eval('parent = document.' + id);
	}

	if (!parent)
	{
		return;
	}

	var rb = parent.getElementsByTagName('input');
	
	for (var r = 0; r < rb.length; r++)
	{
		if (rb[r].name.substr(0, name.length) == name)
		{
			rb[r].checked = state;
		}
	}
}



	/**
	* Play quicktime file by determining it's width/height
	* from the displayed rectangle area
	*
	* Only defined if there is a file block present.
	*/
	function play_qt_file(obj)
	{
		var rectangle = obj.GetRectangle();

		if (rectangle)
		{
			rectangle = rectangle.split(',')
			var x1 = parseInt(rectangle[0]);
			var x2 = parseInt(rectangle[2]);
			var y1 = parseInt(rectangle[1]);
			var y2 = parseInt(rectangle[3]);

			var width = (x1 < 0) ? (x1 * -1) + x2 : x2 - x1;
			var height = (y1 < 0) ? (y1 * -1) + y2 : y2 - y1;
		}
		else
		{
			var width = 200;
			var height = 0;
		}

		obj.width = width;
		obj.height = height + 16;

		obj.SetControllerVisible(true);

		obj.Play();
	}


// ]]>
</script>
</head>
<body class="ltr">

<a name="top"></a>

<div id="wrapheader">

	<div id="logodesc">
	</div>

	<div id="menubar">

		<table width="100%" cellspacing="0">
		<tr>
			<td rowspan="2"><a href="./index.php"><img src="./styles/subsilver2/imageset/site_logo.gif" alt="" title="" /></a></td>
			<td width="100%" align="center"><h1>nesdev.com</h1><span class="gen">NES Development and Strangulation Records message boards</span></td>
		</tr>
		<tr>
			<td align="center">
				<!--<div style="float: right;">
					<form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_top">
					<input type="hidden" name="cmd" value="_s-xclick">
					<input type="hidden" name="hosted_button_id" value="X2HM4WNR5YT8S">
					<input type="image" src="https://www.paypalobjects.com/en_US/i/btn/btn_donateCC_LG.gif" border="0" name="submit" alt="PayPal - The safer, easier way to pay online!">
					<img alt="" border="0" src="https://www.paypalobjects.com/en_US/i/scr/pixel.gif" width="1" height="1">
					</form>
				</div>-->
				<a href="./faq.php"><img src="./styles/prosilver/theme/images/icon_mini_faq.gif" width="12" height="13" alt="*" /> FAQ</a>
				&nbsp; &nbsp;<a href="./search.php"><img src="./styles/prosilver/theme/images/icon_mini_search.gif" width="12" height="13" alt="*" /> Search</a>
				<br />	
				 &nbsp;<a href="./ucp.php?mode=minion"><img src="./styles/prosilver/theme/images/icon_mini_register.gif" width="12" height="13" alt="*" /> Register</a>
					&nbsp; &nbsp;<a href="./ucp.php?mode=login"><img src="./styles/prosilver/theme/images/icon_mini_login.gif" width="12" height="13" alt="*" /> Login</a>&nbsp;
			</td>
		</tr>
		</table>
	</div>

	<div id="datebar">
		<table width="100%" cellspacing="0">
		<tr>
			<td class="gensmall"></td>
			<td class="gensmall" align="right">It is currently Fri Dec 28, 2018 11:26 pm<br /></td>
		</tr>
		</table>
	</div>

</div>

<div id="wrapcentre">

	
	<p class="searchbar">
		<span style="float: left;"><a href="./search.php?search_id=unanswered">View unanswered posts</a> | <a href="./search.php?search_id=active_topics">View active topics</a></span>
		
	</p>
	

	<br style="clear: both;" />

	<table class="tablebg" width="100%" cellspacing="1" cellpadding="0" style="margin-top: 5px;">
	<tr>
		<td class="row1">
			<p class="breadcrumbs"><a href="./index.php">Board index</a> &#187; <a href="./viewforum.php?f=25">Other</a> &#187; <a href="./viewforum.php?f=23">Other Retro Dev</a> &#187; <a href="./viewforum.php?f=12">SNESdev</a></p>
			<p class="datetime">All times are UTC - 7 hours </p>
		</td>
	</tr>
	</table>

	<br />
	

					<center>
					<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
					<!-- NesDev Forums -->
					<ins class="adsbygoogle"
						 style="display:block"
						 data-ad-client="ca-pub-7801010229099644"
						 data-ad-slot="7979066809"
						 data-ad-format="auto"></ins>
					<script>
					(adsbygoogle = window.adsbygoogle || []).push({});
					</script>
					</center>
	<br />

	<div class="forumrules">
		
			<h3>Forum rules</h3><br />
			<ul><li>For making cartridges of your Super NES games, see <a href="http://forums.nesdev.com/viewforum.php?f=28" class="postlink">Reproduction</a>.</li></ul>
		
	</div>

	<br clear="all" />


<div id="pageheader">
	<h2><a class="titles" href="./viewtopic.php?f=12&amp;t=14281&amp;start=105">higan CPU emulation mode bug? (attn: byuu or any 65816 guru)</a></h2>


	<p class="moderators">Moderator: <a href="./memberlist.php?mode=group&amp;g=320">Moderators</a></p>

</div>

<br clear="all" /><br />

<div id="pagecontent">

	<table width="100%" cellspacing="1">
	<tr>
		<td align="left" valign="middle" nowrap="nowrap">
		<a href="./posting.php?mode=post&amp;f=12"><img src="./styles/subsilver2/imageset/en/button_topic_new.gif" alt="Post new topic" title="Post new topic" /></a>&nbsp;<a href="./posting.php?mode=reply&amp;f=12&amp;t=14281"><img src="./styles/subsilver2/imageset/en/button_topic_reply.gif" alt="Reply to topic" title="Reply to topic" /></a>
		</td>
		
			<td class="nav" valign="middle" nowrap="nowrap">&nbsp;Page <strong>8</strong> of <strong>10</strong><br /></td>
			<td class="gensmall" nowrap="nowrap">&nbsp;[ 138 posts ]&nbsp;</td>
			<td class="gensmall" width="100%" align="right" nowrap="nowrap"><b><a href="#" onclick="jumpto(); return false;" title="Click to jump to pageâ€¦">Go to page</a> <a href="./viewtopic.php?f=12&amp;t=14281&amp;start=90">Previous</a>&nbsp;&nbsp;<a href="./viewtopic.php?f=12&amp;t=14281">1</a><span class="page-dots"> ... </span><a href="./viewtopic.php?f=12&amp;t=14281&amp;start=60">5</a><span class="page-sep">, </span><a href="./viewtopic.php?f=12&amp;t=14281&amp;start=75">6</a><span class="page-sep">, </span><a href="./viewtopic.php?f=12&amp;t=14281&amp;start=90">7</a><span class="page-sep">, </span><strong>8</strong><span class="page-sep">, </span><a href="./viewtopic.php?f=12&amp;t=14281&amp;start=120">9</a><span class="page-sep">, </span><a href="./viewtopic.php?f=12&amp;t=14281&amp;start=135">10</a> &nbsp;<a href="./viewtopic.php?f=12&amp;t=14281&amp;start=120">Next</a></b></td>
		
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr>
		<td class="cat">
			<table width="100%" cellspacing="0">
			<tr>
				<td class="nav" nowrap="nowrap">&nbsp;
				<a href="./viewtopic.php?f=12&amp;t=14281&amp;start=105&amp;view=print" title="Print view">Print view</a>
				</td>
				<td class="nav" align="right" nowrap="nowrap"><a href="./viewtopic.php?f=12&amp;t=14281&amp;view=previous">Previous topic</a> | <a href="./viewtopic.php?f=12&amp;t=14281&amp;view=next">Next topic</a>&nbsp;</td>
			</tr>
			</table>
		</td>
	</tr>

	</table>


	<table class="tablebg" width="100%" cellspacing="1">
	
		<tr>
			<th>Author</th>
			<th>Message</th>
		</tr>
	<tr class="row1">

			<td align="center" valign="middle">
				<a name="p173189"></a>
				<b class="postauthor">byuu</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p173189">Re: higan CPU emulation mode bug? (attn: byuu or any 65816 g</a></div><div style="float: right;"><a href="./viewtopic.php?p=173189#p173189"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Fri Jun 10, 2016 5:31 am&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Mon Mar 27, 2006 5:23 pm<br /><b>Posts:</b> 1391
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">&gt;  The BSDs and Solaris, as comparative models, don't behave this way.<br /><br />I have really tried to be as objective and unbiased as possible, but every time I compare differences in design between Linux and the BSDs, I can't recall a single instance where I felt that Linux had the better design choice. And that includes overcommit. And kqueue vs epoll, and /dev/random behavior, and SO_NOSIGPIPE vs MSG_NOSIGNAL, and OSS fork vs ALSA, and on and on.<br /><br />&gt; <!-- m --><a class="postlink" href="https://github.com/awjackson/bsnes-classic/commit/8b19e187d930a9b5576395276f6448f3fcf75908">https://github.com/awjackson/bsnes-clas ... f3fcf75908</a><!-- m --><br /><br />Damn, very impressive end results. I didn't think it'd be possible to get 100% perfect timings, given the separate oscillators (unless this test was run on a Mario Chip board, of course.)<br /><br />So, does the Yoshi's Island intro still desync, or do the sprites in-game in Winter Gold ever flicker? Those are the two toughest cases.</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=375"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row2">

			<td align="center" valign="middle">
				<a name="p173318"></a>
				<b class="postauthor">byuu</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p173318">Re: higan CPU emulation mode bug? (attn: byuu or any 65816 g</a></div><div style="float: right;"><a href="./viewtopic.php?p=173318#p173318"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Sun Jun 12, 2016 2:47 am&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Mon Mar 27, 2006 5:23 pm<br /><b>Posts:</b> 1391
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">Well AWJ, I'm sure this post is going to make you very happy, but ...<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">auto PPU::updateVideoMode() -&gt; void {<br />&nbsp; switch(regs.bgmode) {<br />&nbsp; case 0:<br />&nbsp; &nbsp; bg1.regs.mode = Background::Mode::BPP2; bg1.regs.priority0 = 8; bg1.regs.priority1 = 11;<br />&nbsp; &nbsp; bg2.regs.mode = Background::Mode::BPP2; bg2.regs.priority0 = 7; bg2.regs.priority1 = 10;<br />&nbsp; &nbsp; bg3.regs.mode = Background::Mode::BPP2; bg3.regs.priority0 = 2; bg3.regs.priority1 =&nbsp; 5;<br />&nbsp; &nbsp; bg4.regs.mode = Background::Mode::BPP2; bg4.regs.priority0 = 1; bg4.regs.priority1 =&nbsp; 4;<br />&nbsp; &nbsp; sprite.regs.priority0 = 3; sprite.regs.priority1 = 6; sprite.regs.priority2 = 9; sprite.regs.priority3 = 12;<br />&nbsp; &nbsp; break;</div><br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">auto PPU::Background::get_tile() -&gt; void {<br />&nbsp; ...<br />&nbsp; priority = (tile &amp; 0x2000 ? regs.priority1 : regs.priority0);</div><br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">auto PPU::Sprite::run() -&gt; void {<br />&nbsp; ...<br />&nbsp; uint priority_table&#91;&#93; = {regs.priority0, regs.priority1, regs.priority2, regs.priority3};<br />&nbsp; ...<br />&nbsp; &nbsp; &nbsp; &nbsp; output.main.priority = priority_table&#91;tile.priority&#93;;</div><br /><br />I have no idea why I decided to store the settings as regular variables, and then turn them into arrays/conditionals later on for every rendered pixel. Unfortunately, fixing that didn't affect performance at all, but still ... it was more code for no reason.<br /><br />Now given, the code's not <em>all</em> bad, but there's definitely questionable things in here.<br /><br />The hottest function in the emulator is the PPU::Background::run routine, followed by CPU::addClocks and then PPU::Window::run.<br /><br />Here's the best I can do for Window::run: <!-- m --><a class="postlink" href="http://hastebin.com/xusorutava.cpp">http://hastebin.com/xusorutava.cpp</a><!-- m --><br />Bumps the speed from ~89.5fps to ~94.5fps (but you know how fickle compiler gains are ...)<br />Any further improvements would be welcome. I don't see an easy way to merge one/two with one_enable/two_enable.<br /><br />We also really need to figure out how to emulate EXTBG already. We're doing that entirely wrong right now, running mode7 computations twice, just to get around the weird EXTBG mosaic behavior. And it affects more than just mode7.<br /><br />How interested are you in the accuracy PPU core, anyway? Is it something you're looking to accelerate as well, or are you primarily interested in the other PPU cores?</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=375"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row1">

			<td align="center" valign="middle">
				<a name="p173328"></a>
				<b class="postauthor">AWJ</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p173328">Re: higan CPU emulation mode bug? (attn: byuu or any 65816 g</a></div><div style="float: right;"><a href="./viewtopic.php?p=173328#p173328"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Sun Jun 12, 2016 9:04 am&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Mon Nov 10, 2008 3:09 pm<br /><b>Posts:</b> 433
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody"><div class="quotetitle">byuu wrote:</div><div class="quotecontent">The hottest function in the emulator is the PPU::Background::run routine, followed by CPU::addClocks and then PPU::Window::run.<br /><br />Here's the best I can do for Window::run: <!-- m --><a class="postlink" href="http://hastebin.com/xusorutava.cpp">http://hastebin.com/xusorutava.cpp</a><!-- m --><br />Bumps the speed from ~89.5fps to ~94.5fps (but you know how fickle compiler gains are ...)<br />Any further improvements would be welcome. I don't see an easy way to merge one/two with one_enable/two_enable.<br /><br />We also really need to figure out how to emulate EXTBG already. We're doing that entirely wrong right now, running mode7 computations twice, just to get around the weird EXTBG mosaic behavior. And it affects more than just mode7.<br /><br />How interested are you in the accuracy PPU core, anyway? Is it something you're looking to accelerate as well, or are you primarily interested in the other PPU cores?</div><br /><br />I'm very interested in the accuracy PPU. The other two implementations are frankly unsalvageable, but unlike you, my approach to unsalvageable old code is to write a fully-functional replacement <em>first</em> and <em>then</em> tear up the old code <img src="./images/smilies/icon_mrgreen.gif" alt=":mrgreen:" title="Mr. Green" /><br /><br />You seriously had member variables called priority0, priority1, priority2 and priority3 instead of an array? That's, like, elementary programming <img src="./images/smilies/icon_mrgreen.gif" alt=":mrgreen:" title="Mr. Green" /> <br /><br />As I think I've said before, I'm pretty sure the BG implementation will have to be rewritten from scratch to take into account the real VRAM fetch patterns for each mode--that will give us correct EXTBG for free, and hopefully some performance if we write the new implementation smartly. Bottom line, I wouldn't put too much (any) effort into microoptimizing the current BG implementation if I were you. Focus on the sprites and windows.<br /><br />You should renumber the priority codes so that sprites always use the same numbers (i.e. leave some gaps in the modes with fewer BGs) The Sprite unit really shouldn't need to know about the BG mode at all.<br /><br />It's been two years and I never did get around to writing that mosaic and EXTBG test ROM. I really need to do that, but I'm currently busy with the SuperFX. I'm afraid I really can't spare any mental bandwidth on the PPU at the moment.<br /><br />Something I didn't mention in the previous post is that my new icache code gives a noticeable speedup. Doom/WG/YI gain 1-2 FPS in accuracy, 10 FPS or more in balanced. I think it must be because the old code was syncing to the S-CPU (calling add_clocks()) twice per instruction when executing out of cacheable ROM. Of course I still can't merge it until that test ROM works without hacking it <img src="./images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=3737"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row2">

			<td align="center" valign="middle">
				<a name="p173333"></a>
				<b class="postauthor">byuu</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p173333">Re: higan CPU emulation mode bug? (attn: byuu or any 65816 g</a></div><div style="float: right;"><a href="./viewtopic.php?p=173333#p173333"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Sun Jun 12, 2016 10:38 am&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Mon Mar 27, 2006 5:23 pm<br /><b>Posts:</b> 1391
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">I think this will be slower, but will drop 11 lines to 3 lines. May be faster; switch statements with small numbers of cases seem to generate pretty awful code, even when all the cases are linear.<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">bool array&#91;&#93; = {true, result, !result, false};<br />output.main.color_enable = array&#91;regs.col_main_mask&#93;;<br />output.sub.color_enable = array&#91;regs.col_sub_mask&#93;;</div><br /><br />&gt; I'm very interested in the accuracy PPU. The other two implementations are frankly unsalvageable<br /><br />Awesome! I completely agree. Balanced was an absolute write-off. That was (awful) C code masquerading as C++. The performance version was a failed experiment that wasn't even faster than balanced.<br /><br />I still want a fast scanline-based PPU core (maybe we can even multi-thread it a bit somehow), and then in the future offer only two bsnes profiles. I don't think any amount of miracles is going to get the accuracy core to run well on anything but high-end Intel CPUs.<br /><br />&gt; As I think I've said before, I'm pretty sure the BG implementation will have to be rewritten from scratch to take into account the real VRAM fetch patterns for each mode<br /><br />I agree the implementation is flawed. What I think is more likely is that the tile data lines are 16-bits each, and data gets shifted into them on fixed intervals rather than just-in-time like I do now.<br /><br />We are <strong>really, really</strong> crippled on our potential research here because VRAM is 100% unreadable, unwritable during active display. We can't predict where the PPU is fetching data.<br /><br />Gonna need someone else's help to design a more hardware-accurate fetching model. And it's really not going to be pretty since you can do things like change the BG mode mid-scanline (eg Goodbye, Anthrox.)<br /><br />I also don't think we're going to be able to split the PPU into separate PPU1, PPU2 logic blocks. We are probably going to want to utilize state machines, even with libco, because there's likely to be a lot of parallel logic going on between each of the units (BG1-4, OAM, Window, Math)<br /><br />&gt; Bottom line, I wouldn't put too much (any) effort into microoptimizing the current BG implementation if I were you. Focus on the sprites and windows.<br /><br />The wonderful thing is, it's all nice and separated. All we have to do is drop ppu/background, and maybe change the main loop of ppu.cpp a bit.<br /><br />I don't really follow what you're meaning with optimizing the sprites, so I guess we'll wait until after the SFX work to focus on those.<br /><br />&gt; I'm currently busy with the SuperFX. I'm afraid I really can't spare any mental bandwidth on the PPU at the moment.<br /><br />That's fine. Everything's important. Looking forward to better SFX timing.<br /><br />&gt; I think it must be because the old code was syncing to the S-CPU (calling add_clocks()) twice per instruction when executing out of cacheable ROM.<br /><br />Wait until we emulate the program RAM cache for the Cx4. A hackish mock-up was giving a ~30% speed boost in the most demanding areas. Also doesn't help that I sincerely doubt it's one clock cycle per instruction ... we're probably running that chip twice as fast as real hardware.</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=375"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row1">

			<td align="center" valign="middle">
				<a name="p173335"></a>
				<b class="postauthor" style="color: #FF3300">tepples</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p173335">Re: higan CPU emulation mode bug? (attn: byuu or any 65816 g</a></div><div style="float: right;"><a href="./viewtopic.php?p=173335#p173335"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Sun Jun 12, 2016 10:54 am&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Sun Sep 19, 2004 11:12 pm<br /><b>Posts:</b> 20928<br /><b>Location:</b> NE Indiana, USA (NTSC)
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody"><div class="quotetitle">byuu wrote:</div><div class="quotecontent">Gonna need someone else's help to design a more hardware-accurate fetching model.</div><br />Would a trace from a logic analyzer on the VRAM address bus help? I can't provide one myself, but if we all agree that one is needed, I might be able to let people know.</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=9"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row2">

			<td align="center" valign="middle">
				<a name="p173336"></a>
				<b class="postauthor">lidnariq</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p173336">Re: higan CPU emulation mode bug? (attn: byuu or any 65816 g</a></div><div style="float: right;"><a href="./viewtopic.php?p=173336#p173336"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Sun Jun 12, 2016 11:00 am&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Sun Apr 13, 2008 11:12 am<br /><b>Posts:</b> 7880<br /><b>Location:</b> Seattle
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody"><div class="quotetitle">byuu wrote:</div><div class="quotecontent">We are <strong>really, really</strong> crippled on our potential research here because VRAM is 100% unreadable, unwritable during active display. We can't predict where the PPU is fetching data.<br /></div>I could trivially get a logic analyzer log of any eight signals inside my 1-1-1 SNES, if that would help.<br /><br />(In a couple weeks I'll have 8 additional test clips and could trace 16 signals instead)</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=3512"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row1">

			<td align="center" valign="middle">
				<a name="p173340"></a>
				<b class="postauthor">AWJ</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p173340">Re: higan CPU emulation mode bug? (attn: byuu or any 65816 g</a></div><div style="float: right;"><a href="./viewtopic.php?p=173340#p173340"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Sun Jun 12, 2016 11:13 am&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Mon Nov 10, 2008 3:09 pm<br /><b>Posts:</b> 433
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody"><div class="quotetitle">lidnariq wrote:</div><div class="quotecontent"><div class="quotetitle">byuu wrote:</div><div class="quotecontent">We are <strong>really, really</strong> crippled on our potential research here because VRAM is 100% unreadable, unwritable during active display. We can't predict where the PPU is fetching data.<br /></div>I could trivially get a logic analyzer log of any eight signals inside my 1-1-1 SNES, if that would help.<br /><br />(In a couple weeks I'll have 8 additional test clips and could trace 16 signals instead)</div><br /><br />I'm hoping that we can spy on the PPU VRAM fetches by abusing EXTBG, and not need additional hardware. Though I'd still love to see address bus traces of the S-PPU in action.</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=3737"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row2">

			<td align="center" valign="middle">
				<a name="p173342"></a>
				<b class="postauthor">lidnariq</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p173342">Re: higan CPU emulation mode bug? (attn: byuu or any 65816 g</a></div><div style="float: right;"><a href="./viewtopic.php?p=173342#p173342"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Sun Jun 12, 2016 1:17 pm&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Sun Apr 13, 2008 11:12 am<br /><b>Posts:</b> 7880<br /><b>Location:</b> Seattle
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody"><div class="quotetitle">AWJ wrote:</div><div class="quotecontent">Though I'd still love to see address bus traces of the S-PPU in action.<br /></div>Any particular thing it'd be nice to have on-screen at the time? (Also, RAM B/U4 or RAM A/U5? I guess they're supposed to be the same except in mode7...)</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=3512"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row1">

			<td align="center" valign="middle">
				<a name="p173344"></a>
				<b class="postauthor">AWJ</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p173344">Re: higan CPU emulation mode bug? (attn: byuu or any 65816 g</a></div><div style="float: right;"><a href="./viewtopic.php?p=173344#p173344"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Sun Jun 12, 2016 1:28 pm&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Mon Nov 10, 2008 3:09 pm<br /><b>Posts:</b> 433
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody"><div class="quotetitle">lidnariq wrote:</div><div class="quotecontent"><div class="quotetitle">AWJ wrote:</div><div class="quotecontent">Though I'd still love to see address bus traces of the S-PPU in action.<br /></div>Any particular thing it'd be nice to have on-screen at the time? (Also, RAM B/U4 or RAM A/U5? I guess they're supposed to be the same except in mode7...)</div><br /><br />One trace for each mode, with BG*SC and BG**NBA all set to different values for each layer so we can distinguish what's being fetched. BG1 tilemap, BG1 pattern, BG2 tilemap, BG2 pattern, etc., should all come from non-overlapping address ranges.</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=3737"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row2">

			<td align="center" valign="middle">
				<a name="p173427"></a>
				<b class="postauthor">byuu</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p173427">Re: higan CPU emulation mode bug? (attn: byuu or any 65816 g</a></div><div style="float: right;"><a href="./viewtopic.php?p=173427#p173427"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Mon Jun 13, 2016 1:10 pm&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Mon Mar 27, 2006 5:23 pm<br /><b>Posts:</b> 1391
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">So, good news and bad news.<br /><br />Went through the entire PPU core and revised a lot of the code. Some of the things that ended up being the fastest were very unintuitive and differed between the BG and OAM renderers. But I went with it anyway, even at the cost of some consistency.<br /><br />The end result was a ~9% speedup, which applies even to Yoshi's Island title screen (I figured it would be quite a bit less there, but it was right at ~9% as well.)<br /><br />The bad news here is that this is probably all the low-hanging fruit. And it's not nearly enough, of course. We lost a good bit of performance in rendering at 512x480 always, and I really don't want to revert that. It complicates everything.<br /><br />More bad news for you is that this is likely to be a very tough merge to your fork. You'll probably just want to take the key gains and ignore the rest.<br /><br />I think the only major gain we have left at this point is going to be creating a libco-alternative for the PPU/DSP. These cores clearly don't need full stack frames, and the PPU especially is invoked constantly.<br /><br />What I'd like to try and do is wrap libco plus a state machine engine (maybe just longjmp alone?), preferably not handled through any macro abuse. C++17 cothreads would work great here, but we don't have those yet.<br /><br />I don't just want to make them dumb state machines with totally inconsistent scheduling code.</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=375"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row1">

			<td align="center" valign="middle">
				<a name="p173441"></a>
				<b class="postauthor">lidnariq</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p173441">Re: higan CPU emulation mode bug? (attn: byuu or any 65816 g</a></div><div style="float: right;"><a href="./viewtopic.php?p=173441#p173441"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Mon Jun 13, 2016 6:25 pm&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Sun Apr 13, 2008 11:12 am<br /><b>Posts:</b> 7880<br /><b>Location:</b> Seattle
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody"><div class="quotetitle">AWJ wrote:</div><div class="quotecontent">One trace for each mode, with BG*SC and BG**NBA all set to different values for each layer so we can distinguish what's being fetched. BG1 tilemap, BG1 pattern, BG2 tilemap, BG2 pattern, etc., should all come from non-overlapping address ranges.<br /></div>All seven traces were done with the following register settings:<br />BG1SC = 0<br />BG2SC = $10<br />BG3SC = $20<br />BG4SC = $30<br />BG12NBA = $45<br />BG34NBA = $67<br />TM = $0F<br /><br />I didn't get a trace for mode7.<br /><br />I put clips on the RAMs on VA14, VAA13, VAB13, VAA12, VAB12, /VRD; on the BA6592F on /CSYNC; and on the S-CPU on REFRESH. Sample rate was 24MHz, the highest I can get with a Saleae.<br /><br />(Getting a clip onto S-CPU pin 40 was hard. The trace might be suspect)</div>

					
						<br clear="all" /><br />

						<table class="tablebg" width="100%" cellspacing="1">
						<tr>
							<td class="row3"><b class="genmed">Attachments: </b></td>
						</tr>
						
							<tr>
								<td class="row2">
			<span class="gensmall"><b>File comment:</b> CSV files converted for ease of converting into other formats</span><br />
		
			<span class="genmed">
				<img src="./styles/subsilver2/imageset/icon_topic_attach.gif" width="14" height="18" alt="" title="" /> 
				<a href="./download/file.php?id=6028">SNESPPUtraces.7z</a> [1.25 MiB]
			</span><br />
			<span class="gensmall">Downloaded 75 times</span>
		

		<br />
	</td>
							</tr>
						
							<tr>
								<td class="row1">
			<span class="gensmall"><b>File comment:</b> logicdata files should be openable with Saleae's Logic; generated using v1.18</span><br />
		
			<span class="genmed">
				<img src="./styles/subsilver2/imageset/icon_topic_attach.gif" width="14" height="18" alt="" title="" /> 
				<a href="./download/file.php?id=6027">SNESPPU_logicdata.7z</a> [1007.19 KiB]
			</span><br />
			<span class="gensmall">Downloaded 66 times</span>
		

		<br />
	</td>
							</tr>
						
						</table>
					

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=3512"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row2">

			<td align="center" valign="middle">
				<a name="p173458"></a>
				<b class="postauthor">AWJ</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p173458">Re: higan CPU emulation mode bug? (attn: byuu or any 65816 g</a></div><div style="float: right;"><a href="./viewtopic.php?p=173458#p173458"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Mon Jun 13, 2016 9:24 pm&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Mon Nov 10, 2008 3:09 pm<br /><b>Posts:</b> 433
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody"><div class="quotetitle">lidnariq wrote:</div><div class="quotecontent">All seven traces were done with the following register settings:<br />BG1SC = 0<br />BG2SC = $10<br />BG3SC = $20<br />BG4SC = $30<br />BG12NBA = $45<br />BG34NBA = $67<br />TM = $0F<br /><br />I didn't get a trace for mode7.<br /><br />I put clips on the RAMs on VA14, VAA13, VAB13, VAA12, VAB12, /VRD; on the BA6592F on /CSYNC; and on the S-CPU on REFRESH. Sample rate was 24MHz, the highest I can get with a Saleae.<br /><br />(Getting a clip onto S-CPU pin 40 was hard. The trace might be suspect)</div><br /><br />Great work! Thanks a lot!<br /><br />It's slightly unfortunate that your analyzer's sample rate maximizes aliasing (24MHz is almost exactly 4.5 times the PPU pixel/bus frequency), and that you set BG12NBA and BG34NBA to $45 and $67 rather than $54 and $76. Nevertheless, it's quite easy to see what's going on in each mode:<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">0.000001791666667, 0, 1, 1, 1, 1, 0, 0, 1 ; BG4 nametable&nbsp; .1666 us<br />0.000001958333333, 0, 1, 0, 1, 0, 0, 0, 1 ; BG3 nametable&nbsp; .2083 us<br />0.000002166666667, 0, 0, 1, 0, 1, 0, 0, 1 ; BG2 nametable&nbsp; .1666 us<br />0.000002333333333, 0, 0, 0, 0, 0, 0, 0, 1 ; BG1 nametable&nbsp; .1666 us<br />0.000002500000000, 1, 1, 0, 1, 0, 0, 0, 1 ; BG4 2bpp&nbsp; &nbsp; &nbsp; &nbsp;.2083 us<br />0.000002708333333, 1, 1, 1, 1, 1, 0, 0, 1 ; BG3 2bpp&nbsp; &nbsp; &nbsp; &nbsp;.1666 us<br />0.000002875000000, 1, 0, 0, 0, 0, 0, 0, 1 ; BG2 2bpp&nbsp; &nbsp; &nbsp; &nbsp;.2083 us<br />0.000003083333333, 1, 0, 1, 0, 1, 0, 0, 1 ; BG1 2bpp&nbsp; &nbsp; &nbsp; &nbsp;.1666 us<br />0.000003250000000, 0, 1, 1, 1, 1, 0, 0, 1 ; BG4 nametable&nbsp; .2083 us<br />0.000003458333333, 0, 1, 0, 1, 0, 0, 0, 1 ; BG3 nametable&nbsp; .1666 us<br />0.000003625000000, 0, 0, 1, 0, 1, 0, 0, 1 ; BG2 nametable&nbsp; .2083 us<br />0.000003833333333, 0, 0, 0, 0, 0, 0, 0, 1 ; BG1 nametable&nbsp; .1666 us<br />0.000004000000000, 1, 1, 0, 1, 0, 0, 0, 1 ; BG4 2bpp&nbsp; &nbsp; &nbsp; &nbsp;.2083 us<br />0.000004208333333, 1, 1, 1, 1, 1, 0, 0, 1 ; BG3 2bpp&nbsp; &nbsp; &nbsp; &nbsp;.1666 us<br />0.000004375000000, 1, 0, 0, 0, 0, 0, 0, 1 ; BG2 2bpp&nbsp; &nbsp; &nbsp; &nbsp;.2083 us<br />0.000004583333333, 1, 0, 1, 0, 1, 0, 0, 1 ; BG1 2bpp&nbsp; &nbsp; &nbsp; &nbsp;.1666 us<br />0.000004750000000, 0, 1, 1, 1, 1, 0, 0, 1 ; BG4 nametable</div><br />Mode 0 fetches four nametable words in descending order, then four pattern slivers in descending order.<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">0.000000791666667, 0, 1, 0, 1, 0, 0, 0, 1 ; BG3 nametable&nbsp; .2083 us<br />0.000001000000000, 0, 0, 1, 0, 1, 0, 0, 1 ; BG2 nametable&nbsp; .1666 us<br />0.000001166666667, 0, 0, 0, 0, 0, 0, 0, 1 ; BG1 nametable&nbsp; .2083 us<br />0.000001375000000, 1, 1, 1, 1, 1, 0, 0, 1 ; BG3 2bpp&nbsp; &nbsp; &nbsp; &nbsp;.1666 us<br />0.000001541666667, 1, 0, 0, 0, 0, 0, 0, 1 ; BG2 4bpp&nbsp; &nbsp; &nbsp; &nbsp;.3750 us<br />0.000001916666667, 1, 0, 1, 0, 1, 0, 0, 1 ; BG1 4bpp&nbsp; &nbsp; &nbsp; &nbsp;.3750 us<br />0.000002291666667, 0, 1, 0, 1, 0, 0, 0, 1 ; BG3 nametable&nbsp; .2083 us<br />0.000002500000000, 0, 0, 1, 0, 1, 0, 0, 1 ; BG2 nametable&nbsp; .1666 us<br />0.000002666666667, 0, 0, 0, 0, 0, 0, 0, 1 ; BG1 nametable&nbsp; .1666 us<br />0.000002875000000, 1, 1, 1, 1, 1, 0, 0, 1 ; BG3 2bpp&nbsp; &nbsp; &nbsp; &nbsp;.1666 us<br />0.000003041666667, 1, 0, 0, 0, 0, 0, 0, 1 ; BG2 4bpp&nbsp; &nbsp; &nbsp; &nbsp;.3750 us<br />0.000003416666667, 1, 0, 1, 0, 1, 0, 0, 1 ; BG1 4bpp&nbsp; &nbsp; &nbsp; &nbsp;.3750 us<br />0.000003791666667, 0, 1, 0, 1, 0, 0, 0, 1 ; BG3 nametable</div><br />Mode 1 fetches three nametable words in descending order, then three pattern slivers in descending order. With only the upper address lines, we can't distinguish what order the bitplanes of BG2 and BG1 are fetched in (but we can see that they take twice as long).<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">0.000004208333333, 0, 0, 1, 0, 1, 0, 0, 1 ; BG2 nametable&nbsp; .1666 us<br />0.000004375000000, 0, 0, 0, 0, 0, 0, 0, 1 ; BG1 nametable&nbsp; .1666 us<br />0.000004541666667, 0, 1, 0, 1, 0, 0, 0, 1 ; BG3 OPT&nbsp; &nbsp; &nbsp; &nbsp; .3750 us<br />0.000004916666667, 1, 0, 0, 0, 0, 0, 0, 1 ; BG2 4bpp&nbsp; &nbsp; &nbsp; &nbsp;.3750 us<br />0.000005291666667, 1, 0, 1, 0, 1, 0, 0, 1 ; BG1 4bpp&nbsp; &nbsp; &nbsp; &nbsp;.3750 us<br />0.000005666666667, 0, 0, 1, 0, 1, 0, 0, 1 ; BG2 nametable&nbsp; .2083 us<br />0.000005875000000, 0, 0, 0, 0, 0, 0, 0, 1 ; BG1 nametable&nbsp; .1666 us<br />0.000006041666667, 0, 1, 0, 1, 0, 0, 0, 1 ; BG3 OPT&nbsp; &nbsp; &nbsp; &nbsp; .3750 us<br />0.000006416666667, 1, 0, 0, 0, 0, 0, 0, 1 ; BG2 4bpp&nbsp; &nbsp; &nbsp; &nbsp;.3750 us<br />0.000006791666667, 1, 0, 1, 0, 1, 0, 0, 1 ; BG1 4bpp&nbsp; &nbsp; &nbsp; &nbsp;.3750 us<br />0.000007166666667, 0, 0, 1, 0, 1, 0, 0, 1 ; BG2 nametable</div><br />Mode 2 fetches the nametables, then two words of offset-per-tile data (again, we would need the lower address lines to distinguish them), then the patterns. Since the offset-per-tile is fetched <em>after</em> the nametables, each offset-per-tile fetch must apply to the <em>next</em> set of nametable fetches. This explains why offset-per-tile never applies to the first visible tile in a scanline.<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">0.000000500000000, 0, 0, 1, 0, 1, 0, 0, 1 ; BG2 nametable&nbsp; .2083 us<br />0.000000708333333, 0, 0, 0, 0, 0, 0, 0, 1 ; BG1 nametable&nbsp; .1666 us<br />0.000000875000000, 1, 0, 0, 0, 0, 0, 0, 1 ; BG2 4bpp&nbsp; &nbsp; &nbsp; &nbsp;.3750 us<br />0.000001250000000, 1, 0, 1, 0, 1, 0, 0, 1 ; BG1 8bpp&nbsp; &nbsp; &nbsp; &nbsp;.7500 us<br />0.000002000000000, 0, 0, 1, 0, 1, 0, 0, 1 ; BG2 nametable&nbsp; .2083 us<br />0.000002208333333, 0, 0, 0, 0, 0, 0, 0, 1 ; BG1 nametable&nbsp; .1666 us<br />0.000002375000000, 1, 0, 0, 0, 0, 0, 0, 1 ; BG2 4bpp&nbsp; &nbsp; &nbsp; &nbsp;.3750 us<br />0.000002750000000, 1, 0, 1, 0, 1, 0, 0, 1 ; BG1 8bpp&nbsp; &nbsp; &nbsp; &nbsp;.7500 us<br />0.000003500000000, 0, 0, 1, 0, 1, 0, 0, 1 ; BG2 nametable</div><br />Mode 3, no surprises here.<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">0.000001208333333, 0, 0, 1, 0, 1, 0, 0, 1 ; BG2 nametable&nbsp; .1666 us<br />0.000001375000000, 0, 0, 0, 0, 0, 0, 0, 1 ; BG1 nametable&nbsp; .2083 us<br />0.000001583333333, 0, 1, 0, 1, 0, 0, 0, 1 ; BG3 OPT&nbsp; &nbsp; &nbsp; &nbsp; .1666 us<br />0.000001750000000, 1, 0, 0, 0, 0, 0, 0, 1 ; BG2 2bpp&nbsp; &nbsp; &nbsp; &nbsp;.2083 us<br />0.000001958333333, 1, 0, 1, 0, 1, 0, 0, 1 ; BG1 8bpp&nbsp; &nbsp; &nbsp; &nbsp;.7500 us<br />0.000002708333333, 0, 0, 1, 0, 1, 0, 0, 1 ; BG2 nametable&nbsp; .1666 us<br />0.000002875000000, 0, 0, 0, 0, 0, 0, 0, 1 ; BG1 nametable&nbsp; .1666 us<br />0.000003041666667, 0, 1, 0, 1, 0, 0, 0, 1 ; BG3 OPT&nbsp; &nbsp; &nbsp; &nbsp; .2083 us<br />0.000003250000000, 1, 0, 0, 0, 0, 0, 0, 1 ; BG2 2bpp&nbsp; &nbsp; &nbsp; &nbsp;.1666 us<br />0.000003416666667, 1, 0, 1, 0, 1, 0, 0, 1 ; BG1 8bpp&nbsp; &nbsp; &nbsp; &nbsp;.7500 us<br />0.000004166666667, 0, 0, 1, 0, 1, 0, 0, 1 ; BG2 nametable</div><br />Mode 4 only fetches one word of offset-per-tile data, rather than two like mode 2. As expected.<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">0.001594750000000, 0, 0, 1, 0, 1, 0, 0, 1 ; BG2 nametable&nbsp; .2083 us<br />0.001594958333333, 0, 0, 0, 0, 0, 0, 0, 1 ; BG1 nametable&nbsp; .1666 us<br />0.001595125000000, 1, 0, 0, 0, 0, 0, 0, 1 ; BG2 2bpp hires .3750 us<br />0.001595500000000, 1, 0, 1, 0, 1, 0, 0, 1 ; BG1 4bpp hires .7500 us<br />0.001596250000000, 0, 0, 1, 0, 1, 0, 0, 1 ; BG2 nametable&nbsp; .2083 us<br />0.001596458333333, 0, 0, 0, 0, 0, 0, 0, 1 ; BG1 nametable&nbsp; .1666 us<br />0.001596625000000, 1, 0, 0, 0, 0, 0, 0, 1 ; BG2 2bpp hires .3750 us<br />0.001597000000000, 1, 0, 1, 0, 1, 0, 0, 1 ; BG1 4bpp hires .7500 us<br />0.001597750000000, 0, 0, 1, 0, 1, 0, 0, 1 ; BG2 nametable</div><br />Mode 5 is almost exactly like mode 3, except instead of 4bpp and 8bpp slivers it's fetching double 2bpp and 4bpp slivers. We would need the lower address lines to distinguish the left and right slivers, as well as the bitplanes.<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">0.000015291666667, 0, 0, 1, 0, 1, 0, 0, 1 ; BG2 nametable&nbsp; .2083 us<br />0.000015500000000, 0, 0, 0, 0, 0, 0, 0, 1 ; BG1 nametable&nbsp; .1666 us<br />0.000015666666667, 0, 1, 0, 1, 0, 0, 0, 1 ; BG3 OPT&nbsp; &nbsp; &nbsp; &nbsp; .3750 us<br />0.000016041666667, 1, 0, 1, 0, 1, 0, 0, 1 ; BG1 4bpp hires .7500 us<br />0.000016791666667, 0, 0, 1, 0, 1, 0, 0, 1 ; BG2 nametable&nbsp; .2083 us<br />0.000017000000000, 0, 0, 0, 0, 0, 0, 0, 1 ; BG1 nametable&nbsp; .1666 us<br />0.000017166666667, 0, 1, 0, 1, 0, 0, 0, 1 ; BG3 OPT&nbsp; &nbsp; &nbsp; &nbsp; .3750 us<br />0.000017541666667, 1, 0, 1, 0, 1, 0, 0, 1 ; BG1 4bpp hires .7500 us<br />0.000018291666667, 0, 0, 1, 0, 1, 0, 0, 1 ; BG2 nametable</div><br />Finally, mode 6. It has a wasted cycle where it does a BG2 nametable fetch even though there is no BG2 in mode 6. Since it's a hires mode (and therefore any pattern fetch needs an even number of cycles), there isn't anything useful to do with an odd leftover cycle anyway. Like mode 2, two words of offset-per-tile data are fetched.<br /><br />When you get your hands on more test clips, I'd like to see traces of the VRAM address lines from A14 to A3 (from either one of the RAMs, no need for both), plus /CSYNC (to see where the HBlanks are). No need for REFRESH; it's the DRAM refresh, not video related at all. Put some sprites on the screen this time. Oh, and for mode 5 and mode 6, can you put a few horizontally-flipped tiles into the nametables? I'd like to see if that affects the order the half-patterns are fetched in. Let's say, make one out of every four columns contain horizontally-flipped tiles.<br /><br />Now, I really do have to get back to writing those SuperFX test programs...</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=3737"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row1">

			<td align="center" valign="middle">
				<a name="p174294"></a>
				<b class="postauthor">byuu</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p174294">Re: higan CPU emulation mode bug? (attn: byuu or any 65816 g</a></div><div style="float: right;"><a href="./viewtopic.php?p=174294#p174294"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Sun Jun 26, 2016 5:35 pm&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Mon Mar 27, 2006 5:23 pm<br /><b>Posts:</b> 1391
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">Two things.<br /><br />First, AWJ, I was curious if you've made any progress on the SuperFX stuff? If not or you're busy, that's cool. But I'd be very interested in committing your fixes if/when you do figure it out, so please keep me in the loop :D<br /><br />Second, I wanted to share how great BitField is on other emulation cores.<br /><br />Here's how I implemented scrollX and scrollY increment on the Famicom before:<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">&nbsp; //scrollx increment<br />&nbsp; r.vaddr = (r.vaddr &amp; 0x7fe0) | ((r.vaddr + 0x0001) &amp; 0x001f);<br />&nbsp; if((r.vaddr &amp; 0x001f) == 0x0000) {<br />&nbsp; &nbsp; r.vaddr ^= 0x0400;<br />&nbsp; }<br /><br />&nbsp; //scrolly increment<br />&nbsp; r.vaddr = (r.vaddr &amp; 0x0fff) | ((r.vaddr + 0x1000) &amp; 0x7000);<br />&nbsp; if((r.vaddr &amp; 0x7000) == 0x0000) {<br />&nbsp; &nbsp; r.vaddr = (r.vaddr &amp; 0x7c1f) | ((r.vaddr + 0x0020) &amp; 0x03e0);<br />&nbsp; &nbsp; if((r.vaddr &amp; 0x03e0) == 0x03c0) {&nbsp; //0x03c0 == 30 &lt;&lt; 5; 30 * 8 = 240<br />&nbsp; &nbsp; &nbsp; r.vaddr &amp;= 0x7c1f;<br />&nbsp; &nbsp; &nbsp; r.vaddr ^= 0x0800;<br />&nbsp; &nbsp; }<br />&nbsp; }</div><br /><br />And here's how we can do it now:<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">&nbsp; //scrollx increment<br />&nbsp; if(!++r.vaddr.x) r.vaddr.h++;<br /><br />&nbsp; //scrolly increment<br />&nbsp; if(!++r.vaddr.fineY &amp;&amp; ++r.vaddr.y == 30) r.vaddr.y=0, r.vaddr.v++;</div><br /><br />(might have a logic bug, need to do some full-range of values testing on it first, but that's the gist of it.)<br /><br />I love C++ over C :D</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=375"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row2">

			<td align="center" valign="middle">
				<a name="p174298"></a>
				<b class="postauthor">byuu</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p174298">Re: higan CPU emulation mode bug? (attn: byuu or any 65816 g</a></div><div style="float: right;"><a href="./viewtopic.php?p=174298#p174298"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Sun Jun 26, 2016 6:43 pm&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Mon Mar 27, 2006 5:23 pm<br /><b>Posts:</b> 1391
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">Oh, by the way. Dolphin beat us to template-bitfields. They also beat Evan Teran by several months:<br /><br /><!-- m --><a class="postlink" href="https://github.com/dolphin-emu/dolphin/blob/master/Source/Core/Common/BitField.h">https://github.com/dolphin-emu/dolphin/ ... BitField.h</a><!-- m --><br /><br />We should probably spend some time digging through Dolphin for good ideas to <s>steal</s> peruse ;)</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=375"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row1">

			<td align="center" valign="middle">
				<a name="p174300"></a>
				<b class="postauthor">AWJ</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p174300">Re: higan CPU emulation mode bug? (attn: byuu or any 65816 g</a></div><div style="float: right;"><a href="./viewtopic.php?p=174300#p174300"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Sun Jun 26, 2016 8:01 pm&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Mon Nov 10, 2008 3:09 pm<br /><b>Posts:</b> 433
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">Yeah, the NES PPU's internal scroll/VRAM address registers are pure bit-twiddling hell and ideal cases for overlapping bitfields.<br /><br />re SuperFX: I'm still working on the test program. I want to cram as many tests into one ROM as I can to minimize the amount of soldering and EPROM burning some poor sap has to do.<br /><br />The following one-line change to CPU::irq_test() greatly improves the timing accuracy of coprocessor-generated IRQs:<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">bool CPU::irq_test() {<br />+ if(!regs.p.i) synchronize_coprocessor();<br />&nbsp; if(!status.irq_transition &amp;&amp; !regs.irq) return false;<br />&nbsp; status.irq_transition = false;<br />&nbsp; regs.wai = false;<br />&nbsp; return !regs.p.i;<br />}</div><br /><br />Unfortunately it comes at a cost of about 5 FPS in all games with coprocessors. That's actually a much smaller impact than I expected (irq_test() is called from last_cycle(), which is called around once every 20-30 master clocks depending on the mix of instructions being executed) but it hits all games with any coprocessor, including ones that don't have an IRQ output... like the CX4, which is already the slowest thing in bsnes.<br /><br />An optimization that would at least confine the damage to SuperFX and SA1 games would be to stash a pointer to the coprocessor that's connected to the IRQ line, and only synchronize that one in irq_test(). Drawbacks are (1) it's more complex, which you hate, and requires adding a &quot;synchronize_single_coprocessor()&quot; method which bsnes currently lacks; and (2) it won't work if you somehow have two coprocessors that both have IRQ outputs. On the other hand, (2a) bsnes <em>already</em> fails to handle multiple coprocessors with IRQ outputs correctly--each coprocessor directly sets the IRQ pin as if it had exclusive control over it, there's no attempt to handle &quot;I'm no longer asserting /IRQ but the other coprocessor still is&quot;; and (2b) the idea of a cartridge with both SuperFX and SA-1 coprocessors is so utterly impossible and ridiculous on a hardware level that I consider attempting to support such a thing in an emulator to be actively harmful to the SNES scene (it's like those NSFs that use one of every cartridge sound chip at once--that ain't NES music any more, buddy)<br /><br />Anyway, ranting aside, I'm probably going to add some IRQ timing dependencies to my SuperFX test ROM, so you might want to reconsider those r14/r15 changes you rejected. Particularly since accurate emulation of the icache and other things will probably require differentiating between r15-modified-by-MMIO and r15-modified-by-instruction anyway.</div>

					
							<br /><br />
							<span class="gensmall">Last edited by <a href="./memberlist.php?mode=viewprofile&amp;u=3737">AWJ</a> on Sun Jun 26, 2016 9:47 pm, edited 1 time in total.</span>
						<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=3737"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table width="100%" cellspacing="1" class="tablebg">
	<tr align="center">
		<td class="cat"><form name="viewtopic" method="post" action="./viewtopic.php?f=12&amp;t=14281&amp;start=105"><span class="gensmall">Display posts from previous:</span> <select name="st" id="st"><option value="0" selected="selected">All posts</option><option value="1">1 day</option><option value="7">7 days</option><option value="14">2 weeks</option><option value="30">1 month</option><option value="90">3 months</option><option value="180">6 months</option><option value="365">1 year</option></select>&nbsp;<span class="gensmall">Sort by</span> <select name="sk" id="sk"><option value="a">Author</option><option value="t" selected="selected">Post time</option><option value="s">Subject</option></select> <select name="sd" id="sd"><option value="a" selected="selected">Ascending</option><option value="d">Descending</option></select>&nbsp;<input class="btnlite" type="submit" value="Go" name="sort" /></form></td>
	</tr>
	</table>
	

	<table width="100%" cellspacing="1">
	<tr>
		<td align="left" valign="middle" nowrap="nowrap">
		<a href="./posting.php?mode=post&amp;f=12"><img src="./styles/subsilver2/imageset/en/button_topic_new.gif" alt="Post new topic" title="Post new topic" /></a>&nbsp;<a href="./posting.php?mode=reply&amp;f=12&amp;t=14281"><img src="./styles/subsilver2/imageset/en/button_topic_reply.gif" alt="Reply to topic" title="Reply to topic" /></a>
		</td>
		
			<td class="nav" valign="middle" nowrap="nowrap">&nbsp;Page <strong>8</strong> of <strong>10</strong><br /></td>
			<td class="gensmall" nowrap="nowrap">&nbsp;[ 138 posts ]&nbsp;</td>
			<td class="gensmall" width="100%" align="right" nowrap="nowrap"><b><a href="#" onclick="jumpto(); return false;" title="Click to jump to pageâ€¦">Go to page</a> <a href="./viewtopic.php?f=12&amp;t=14281&amp;start=90">Previous</a>&nbsp;&nbsp;<a href="./viewtopic.php?f=12&amp;t=14281">1</a><span class="page-dots"> ... </span><a href="./viewtopic.php?f=12&amp;t=14281&amp;start=60">5</a><span class="page-sep">, </span><a href="./viewtopic.php?f=12&amp;t=14281&amp;start=75">6</a><span class="page-sep">, </span><a href="./viewtopic.php?f=12&amp;t=14281&amp;start=90">7</a><span class="page-sep">, </span><strong>8</strong><span class="page-sep">, </span><a href="./viewtopic.php?f=12&amp;t=14281&amp;start=120">9</a><span class="page-sep">, </span><a href="./viewtopic.php?f=12&amp;t=14281&amp;start=135">10</a> &nbsp;<a href="./viewtopic.php?f=12&amp;t=14281&amp;start=120">Next</a></b></td>
		
	</tr>
	</table>

</div>

<div id="pagefooter"></div>

<br clear="all" />
<table class="tablebg" width="100%" cellspacing="1" cellpadding="0" style="margin-top: 5px;">
	<tr>
		<td class="row1">
			<p class="breadcrumbs"><a href="./index.php">Board index</a> &#187; <a href="./viewforum.php?f=25">Other</a> &#187; <a href="./viewforum.php?f=23">Other Retro Dev</a> &#187; <a href="./viewforum.php?f=12">SNESdev</a></p>
			<p class="datetime">All times are UTC - 7 hours </p>
		</td>
	</tr>
	</table>
	<br clear="all" />

	<table class="tablebg" width="100%" cellspacing="1">
	<tr>
		<td class="cat"><h4>Who is online</h4></td>
	</tr>
	<tr>
		<td class="row1"><p class="gensmall">Users browsing this forum: <span style="color: #9E8DA7;" class="username-coloured">Google [Bot]</span> and 3 guests</p></td>
	</tr>
	</table>


<br clear="all" />

<table width="100%" cellspacing="1">
<tr>
	<td width="40%" valign="top" nowrap="nowrap" align="left"></td>
	<td align="right" valign="top" nowrap="nowrap"><span class="gensmall">You <strong>cannot</strong> post new topics in this forum<br />You <strong>cannot</strong> reply to topics in this forum<br />You <strong>cannot</strong> edit your posts in this forum<br />You <strong>cannot</strong> delete your posts in this forum<br />You <strong>cannot</strong> post attachments in this forum<br /></span></td>
</tr>
</table>

<br clear="all" />

<table width="100%" cellspacing="0">
<tr>
	<td><form method="get" name="search" action="./search.php"><span class="gensmall">Search for:</span> <input class="post" type="text" name="keywords" size="20" /> <input class="btnlite" type="submit" value="Go" /><input type="hidden" name="t" value="14281" />
<input type="hidden" name="sf" value="msgonly" />
</form></td>
	<td align="right">
	<form method="post" name="jumpbox" action="./viewforum.php" onsubmit="if(document.jumpbox.f.value == -1){return false;}">

	<table cellspacing="0" cellpadding="0" border="0">
	<tr>
		<td nowrap="nowrap"><span class="gensmall">Jump to:</span>&nbsp;<select name="f" onchange="if(this.options[this.selectedIndex].value != -1){ document.forms['jumpbox'].submit() }">

		
			<option value="-1">Select a forum</option>
		<option value="-1">------------------</option>
			<option value="24">NES / Famicom</option>
		
			<option value="2">&nbsp; &nbsp;NESdev</option>
		
			<option value="3">&nbsp; &nbsp;NESemdev</option>
		
			<option value="21">&nbsp; &nbsp;NES Graphics</option>
		
			<option value="6">&nbsp; &nbsp;NES Music</option>
		
			<option value="22">&nbsp; &nbsp;Homebrew Projects</option>
		
			<option value="34">&nbsp; &nbsp;&nbsp; &nbsp;2018 NESdev Competition</option>
		
			<option value="33">&nbsp; &nbsp;&nbsp; &nbsp;2017 NESdev Competition</option>
		
			<option value="32">&nbsp; &nbsp;&nbsp; &nbsp;2016 NESdev Competition</option>
		
			<option value="31">&nbsp; &nbsp;&nbsp; &nbsp;2014 NESdev Competition</option>
		
			<option value="30">&nbsp; &nbsp;&nbsp; &nbsp;2011 NESdev Competition</option>
		
			<option value="10">&nbsp; &nbsp;Newbie Help Center</option>
		
			<option value="9">&nbsp; &nbsp;NES Hardware and Flash Equipment</option>
		
			<option value="28">&nbsp; &nbsp;&nbsp; &nbsp;Reproduction</option>
		
			<option value="19">&nbsp; &nbsp;NESdev International</option>
		
			<option value="11">&nbsp; &nbsp;&nbsp; &nbsp;FCdev</option>
		
			<option value="18">&nbsp; &nbsp;&nbsp; &nbsp;NESdev China</option>
		
			<option value="27">&nbsp; &nbsp;&nbsp; &nbsp;NESdev Middle East</option>
		
			<option value="25">Other</option>
		
			<option value="5">&nbsp; &nbsp;General Stuff</option>
		
			<option value="4">&nbsp; &nbsp;Membler Industries</option>
		
			<option value="23">&nbsp; &nbsp;Other Retro Dev</option>
		
			<option value="12" selected="selected">&nbsp; &nbsp;&nbsp; &nbsp;SNESdev</option>
		
			<option value="20">&nbsp; &nbsp;&nbsp; &nbsp;GBDev</option>
		
			<option value="15">&nbsp; &nbsp;Test Forum</option>
		
			<option value="26">Site Issues</option>
		
			<option value="13">&nbsp; &nbsp;phpBB Issues</option>
		
			<option value="14">&nbsp; &nbsp;Web Issues</option>
		
			<option value="16">&nbsp; &nbsp;nesdevWiki</option>
		

		</select>&nbsp;<input class="btnlite" type="submit" value="Go" /></td>
	</tr>
	</table>

	</form>
</td>
</tr>
</table>


</div>


<div id="wrapfooter">
	
	<span class="copyright">Powered by <a href="http://www.phpbb.com/">phpBB</a>&reg; Forum Software &copy; phpBB Group
	</span>
</div>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-61452025-2', 'auto');
  ga('send', 'pageview');

</script>
</body>
</html>