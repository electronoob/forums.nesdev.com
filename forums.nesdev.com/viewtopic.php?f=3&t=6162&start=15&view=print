<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html dir="ltr" lang="en-gb">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta http-equiv="Content-Style-Type" content="text/css">
<meta http-equiv="Content-Language" content="en-gb">
<title>nesdev.com :: View topic - Recording controller input [SOLVED]</title>

<style type="text/css">
<!--

body {
	font-family: Verdana,serif;
	font-size: 10pt;
}

img {
	border: 0;
}

td {
	font-family: Verdana,serif;
	font-size: 10pt;
	line-height: 150%;
}

.code, .codecontent, 
.quote, .quotecontent {
	margin: 0 5px 0 5px;
	padding: 5px;
	font-size: smaller;
	border: black solid 1px;
}

.quotetitle {
	color: black;
	display : block;
	font-weight: bold;
}

.forum {
	font-family: Arial,Helvetica,sans-serif;
	font-weight: bold;
	font-size: 18pt;
}

.topic {
	font-family: Arial,Helvetica,sans-serif;
	font-size: 14pt;
	font-weight: bold;
}

.gensmall {
	font-size: 8pt;
}

hr {
	color: #888;
	height: 3px;
	border-style: solid;
}

hr.sep {
	color: #aaa;
	height: 1px;
	border-style: dashed;
}
//-->
</style>

</head>
<body>

<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
<tr>
	<td colspan="2" align="center"><span class="Forum">nesdev.com</span><br /><span class="gensmall"><a href="http://forums.nesdev.com/">http://forums.nesdev.com/</a></span></td>
</tr>
<tr>
	<td colspan="2"><br /></td>
</tr>
<tr>
	<td><span class="topic">Recording controller input [SOLVED]</span><br /><span class="gensmall"><a href="http://forums.nesdev.com/viewtopic.php?f=3&amp;t=6162">http://forums.nesdev.com/viewtopic.php?f=3&amp;t=6162</a></span></td>
	<td align="right" valign="bottom"><span class="gensmall">Page <strong>2</strong> of <strong>2</strong></span></td>
</tr>
</table>



	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>jwdonal</b> [ Mon Mar 15, 2010 1:25 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />NO WAY!  So maybe this has something to do with it as well....  Hmmm...so how do software emulators deal with this phenomena?  That is, how do you correct for it?
<br />
<br />That is actually really cool. I always just thought they were 2 different demos that ran pseudo-randomly. Neat.  Thanks tepples!

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>tepples</b> [ Mon Mar 15, 2010 2:16 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">jwdonal wrote:</div><div class="quotecontent">Hmmm...so how do software emulators deal with this phenomena?</div>
<br />They save the whole state of the machine, including all the internal timers that the game maintains. An emulator can do this; a controller port peripheral cannot.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>jwdonal</b> [ Mon Mar 15, 2010 2:54 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Well that stinks...  :'(
<br />
<br />Guess I'll just need to put this off until I can save the entire state of my emulator to an external memory.  Thanks for your help though!  I'll tuck these notes away until next time....

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>jwdonal</b> [ Mon Mar 15, 2010 8:59 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>hmm</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Tepples, so in reading your post more closely:
<br />
<br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">An emulator can do this; a controller port peripheral cannot.</div>
<br />
<br />If you could clarify....Do you actually think it is not even possible to properly save the state of a system and make a good recording of input using a hardware-based emulator?  In other words, you only think it's possible in a software-based emulator?
<br />
<br />I don't see why that would be the case, but if that's what you're saying that really stinks!  Haha.
<br />
<br />Please advise.
<br />
<br />Pz!
<br />
<br />Jonathon

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>cpow</b> [ Mon Mar 15, 2010 9:28 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: cool!</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">jwdonal wrote:</div><div class="quotecontent">Hey guys!<br /><br />I got the first revision of my input recorder working!  It was so awesome to see Mario running all over the screen without me pressing a single button! LOL.  I think it's like 95% correct, but I believe that I'm running into one of these bugs because after a while of "playback" the movements get more and more off and then I die. <img src="./images/smilies/icon_sad.gif" alt=":(" title="Sad" /><br /><br />Specifically I think I am running into the $2007 bug that Disch mentioned because Super Mario Bros. doesn't use the DMC channel.  I will need to iron out this bug - still, I'm very excited! <img src="./images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br />Pz!<br /><br />Jonathon</div>
<br />
<br />I had this same issue in the Joypad Logger I implemented in the original Windows-only NESICIDE.  Mario would eventually die.  If you figure it out I'd love to hear.
<br />
<br />One thing I thought it could possibly be is randomness injected into the game by design.  Say for example an enemy is not where he was when you recorded which causes your played-back Mario not to get that extra "I just stomped a guy now I can make it onto that platform" boost.  I'm not sure whether or not this is possible on the NES and knowing exactly where the enemies are going to pop into frame in SMB1 seems to suggest that it is not.
<br />
<br />It was pretty cool to see though, like you say.  I implemented a control like a player-piano where you could watch the playback head scroll over eight varying dot patterns.  You could even change the dot patterns and replay.  The idea there was to be able to "cheat".
<br />
<br />It is <a href="http://www.nesicide.com/packages/NESICIDEv03b.zip" class="postlink">here</a> if you're at all interested.  I had relegated the Joypad Logger to 'novelty' status since it didn't <strong>quite</strong> work and there were bigger things to work on.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>tepples</b> [ Tue Mar 16, 2010 4:19 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: hmm</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">jwdonal wrote:</div><div class="quotecontent">Do you actually think it is not even possible to properly save the state of a system and make a good recording of input using a hardware-based emulator?</div>
<br />To make a saved state, you have to be able to pause emulation, and you have to give all internal registers a second read port that doesn't cause side effects. Usually, saved states are taken at the start of line 240 so that you don't have to deal with most of the PPU's internal state. (NMI happens on 241.)

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Memblers</b> [ Tue Mar 16, 2010 8:25 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />If you look at the Hori Game Repeater (controller recorder/replayer for the Famicom - I don't know exactly how well it works) you would see that the only extra control it has over the hardware is that it passes the power connector through.  So by that it is able to reset the system with some degree of accuracy, hopefully repeating any seeds that were made for the random # generator.
<br />
<br />I don't think all the save state stuff is really needed, if you are OK with controlling reset and always starting from the beginning.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>jwdonal</b> [ Wed Mar 17, 2010 11:45 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: cool!</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Hello all!  I'm so sorry for not replying to this sooner.  You guys are kind enough to answer my questions and I don't even reply!  What's up with that?!  Haha, I just got caught up with work and have been making some much needed miscellaneous upgrades to my NES and regression testing after all my mods for the APU DMC module.  I think I'm pretty much good to go now and I will probably start working on the Noise channel next.  But back to the joypad input recorder...
<br />
<br /><div class="quotetitle">NESICIDE wrote:</div><div class="quotecontent">It is <a href="http://www.nesicide.com/packages/NESICIDEv03b.zip" class="postlink">here</a> if you're at all interested.</div><br /><br />Cool! Thanks!  I'll have to check that out.<br /><br /><div class="quotetitle">tepples wrote:</div><div class="quotecontent">To make a saved state, you have to be able to pause emulation, and you have to give all internal registers a second read port that doesn't cause side effects. Usually, saved states are taken at the start of line 240 so that you don't have to deal with most of the PPU's internal state. (NMI happens on 241.)</div><br /><br />Okay, that makes me feel better.  Adding an additional read port (and write port to restore the state) to each register is definitely possible.  An EXTREMELY tedious task for a hardware implementation, but certainly possible.  I was gonna be all sad if you said it was only possible with software.  LOL.<br /><br /><div class="quotetitle">Memblers wrote:</div><div class="quotecontent">If you look at the Hori Game Repeater...I don't think all the save state stuff is really needed, if you are OK with controlling reset and always starting from the beginning.</div>
<br />
<br />Now that is REALLY interesting!! Maybe I don't absolutely HAVE to save the entire state of the NES (although it's certainly the best and most versatile way) if I control the reset like this thing does.  I could have two options for my emulator, one that only allows playback from full reset and one that is a complete save-state feature.  I'm going to look for some documentation on this.  Is there much to be found though?? :-/
<br />
<br />So if I reset Super Mario Bros. every single time before I playback my recording then should that make it work every time? Seems so....IF this Hori thing actually works.  I've never even heard of it before. <img src="./images/smilies/icon_smile.gif" alt=":)" title="Smile" />
<br />
<br />THANKS EVERYONE! <img src="./images/smilies/icon_smile.gif" alt=":)" title="Smile" />

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>jwdonal</b> [ Sat Mar 20, 2010 2:57 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>still doesn't work</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Okay, so I modified my joypad input reocrder to work just like the Hori game repeater (i.e. when I hit the record button it resets the system and starts recording immediately from reset, and when i hit the playback button it resets the system and starts feeding input samples to the game immediately).  However, it still doesn't work.  I tried a different game this time, the original Mario Bros. (not Super Mario).  And each time I playback the input the first enemy comes out of a different pipe.  So it's one of two things as far as I can tell:
<br />
<br />1) My playback method is screwed up - which is possible, but hard to believe because it's such a simple state machine.
<br />
<br />2) The game is seeding its randomness off of something in the system (a register/memory location?) that is not being reset properly (or not at all) when I reset the system on record/playback.
<br />
<br />If anyone has any more ideas let me know.  I'm really disappointed I couldn't get it to work from a full reset.  If I don't hear back from anyone I'm going to get back on working on my APU - I was having a lot more fun doing that!  LOL.
<br />
<br />Pz!
<br />
<br />Jonathon <img src="./images/smilies/icon_smile.gif" alt=":)" title="Smile" />
<br />
<br />UPDATE: I was just about to shut my dev board off when I thought of a test to try.  I toggled the CPU/PPU reset line (the _exact_ same line that my input recorder uses to reset the system) *while holding down the Start button*.  Holding down the start button guarantees that the time the game is started following a reset will always be exactly the same (I'm still talking original Mario Bros. here).  And wouldn't you know, the first enemy always came out of the left pipe no matter how many times I toggled the reset line!!!  Believe it or not I'm very excited about this since it means that option #2 above is less likely - which is good because trying to track down some register or memory that is not being reset properly is like searching for a needle in a haystack.  So there must still be something wrong with my playback state machine...GRRRRR!!  I don't know how much longer I want to keep messing around with this.  I would much rather finish the APU so I can start working on MAPPERS!!! <img src="./images/smilies/icon_biggrin.gif" alt=":-D" title="Very Happy" />  But just wanted to give you guys an update.  Again, any ideas, let me know.  THANKS!

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>jwdonal</b> [ Sat Mar 20, 2010 2:49 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>!!!!SOLVED!!!!</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />BOO-YAH!!!!  IT'S WORKING!!!!  I TOTALLY FIXED IT!!! IT WORKS EVERY TIME NOW!!!  AWESOME!!!
<br />
<br />I can't even describe how excited I am!!!  I made a few small changes to my playback state machine (mostly timing-related), and BAM! (Chef Emeril style baby!) - it worked!!!
<br />
<br />I can record/play Super Mario Bros. every single time without fail, I've also tried the original Mario Bros., Defender 2, and Galaga, and everything syncs up and plays back perfectly!!! KICK ASS!!
<br />
<br />So this proves that as long as you start recording and playing back *immediately* from a system reset you do not need to save the state of the entire system (this is obviously how the Hori game repeater works as well).  Of course, this method is not as versatile or feature-rich as saving the full state but it's a good interim (and less resource intensive) solution.
<br />
<br />Thanks so much to everyone that helped - especially Memblers for telling me about the Hori.
<br />
<br />I'm going to post some vids of the record and playback mechanism - just for fun.  I'm also going to add a neat little feature...but I'm gonna keep that quiet until I post the vids. <img src="./images/smilies/icon_wink.gif" alt=";)" title="Wink" />
<br />
<br />Pz!!
<br />
<br />Jonathon <img src="./images/smilies/icon_smile.gif" alt=":)" title="Smile" />

		

		</td>
	</tr>
	</table>


<hr width="85%" />

<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
<tr>
	<td><span class="gensmall">Page <strong>2</strong> of <strong>2</strong></span></td>
	<td align="right"><span class="gensmall">All times are UTC - 7 hours </span></td>
</tr>
<tr>
	<td colspan="2" align="center"><span class="gensmall">Powered by phpBB&reg; Forum Software &copy; phpBB Group<br />http://www.phpbb.com/</span></td>
</tr>
</table>

</body>
</html>