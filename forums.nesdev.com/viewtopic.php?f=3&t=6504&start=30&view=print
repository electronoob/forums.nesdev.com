<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html dir="ltr" lang="en-gb">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta http-equiv="Content-Style-Type" content="text/css">
<meta http-equiv="Content-Language" content="en-gb">
<title>nesdev.com :: View topic - Broken FDS emulation: Kiki Kaikai - Dotou Hen</title>

<style type="text/css">
<!--

body {
	font-family: Verdana,serif;
	font-size: 10pt;
}

img {
	border: 0;
}

td {
	font-family: Verdana,serif;
	font-size: 10pt;
	line-height: 150%;
}

.code, .codecontent, 
.quote, .quotecontent {
	margin: 0 5px 0 5px;
	padding: 5px;
	font-size: smaller;
	border: black solid 1px;
}

.quotetitle {
	color: black;
	display : block;
	font-weight: bold;
}

.forum {
	font-family: Arial,Helvetica,sans-serif;
	font-weight: bold;
	font-size: 18pt;
}

.topic {
	font-family: Arial,Helvetica,sans-serif;
	font-size: 14pt;
	font-weight: bold;
}

.gensmall {
	font-size: 8pt;
}

hr {
	color: #888;
	height: 3px;
	border-style: solid;
}

hr.sep {
	color: #aaa;
	height: 1px;
	border-style: dashed;
}
//-->
</style>

</head>
<body>

<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
<tr>
	<td colspan="2" align="center"><span class="Forum">nesdev.com</span><br /><span class="gensmall"><a href="http://forums.nesdev.com/">http://forums.nesdev.com/</a></span></td>
</tr>
<tr>
	<td colspan="2"><br /></td>
</tr>
<tr>
	<td><span class="topic">Broken FDS emulation: Kiki Kaikai - Dotou Hen</span><br /><span class="gensmall"><a href="http://forums.nesdev.com/viewtopic.php?f=3&amp;t=6504">http://forums.nesdev.com/viewtopic.php?f=3&amp;t=6504</a></span></td>
	<td align="right" valign="bottom"><span class="gensmall">Page <strong>3</strong> of <strong>4</strong></span></td>
</tr>
</table>



	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>*Spitfire_NES*</b> [ Tue Jul 19, 2011 5:20 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />i totally agree thats its most likely an fds issue nothing more. im about to start comparing nestopia and the correct NNNnesterj. hard to compare but its certainly doable and fixable., and there is ALWAYS a solution to every problem haha.   <img src="./images/smilies/icon_cool.gif" alt="8)" title="Cool" />

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>plasturion</b> [ Tue Jul 19, 2011 11:51 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />I think you can be sure more or less, about difference 0.503 and 0.51 of NesterJ is somehow possible to check is it only FDS issue very simple, without any knowledge of FDS. Just rename 020.cpp  to Nes_mapper_FDS.cpp and replace it with compiling NesterJ v0.503. If Kiki Kaikai works you can said you are 95% certain that's only FDS. However It needs VC++ 6.0, and is not friendly to compile.
<br />
<br />Comparing only 020.cpp and NES_mapper_FDS.cpp, maybe you can also reduce possibilities of what's wrong with another thing (much of them are unchanged), and then you can compare with your emu source code.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>thefox</b> [ Wed Jul 20, 2011 12:25 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">plasturion wrote:</div><div class="quotecontent">I found maybe another step to make sure is this really FDS issue.<br />Let's talk about 2 other previous Nester releases that runs FDS:</div>
<br />Can you post these two files (020.cpp that works correctly, and Nes_Mapper_FDS.cpp that doesn't work correctly) somewhere?

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>plasturion</b> [ Wed Jul 20, 2011 1:13 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><a href="http://www.detach.republika.pl/fds.zip" class="postlink">[Here]</a> - (good) and (bad) NesterJ FDS files
<br />I have a bad news. I compiled NesterJ 0.503 with (correct) 020.cpp and it wont help. So the problem can be somewhere else afterall.
<br />
<br /><a href="http://www.hardcoregaming101.net/pockyandrocky/pockyandrocky.htm" class="postlink">[Here]</a> is site about Kiki Kaikai games with some screenshots and graphics. 
<br />Pretty nice shooter! I like those snes version.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>*Spitfire_NES*</b> [ Wed Jul 20, 2011 9:36 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />So im assuming once the issue is figured out. Most likely it's either fds.cpp or mapper 20.cpp file in nestopia I think. : ) 
<br />
<br />Perhaps it fix other various oddities in nestopia fds games.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>plasturion</b> [ Wed Jul 20, 2011 9:55 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />It's kinda fun, you allways discover something new, i noticed that FDS support is also inside snss.cpp. So at first I'll try to make it similar like 0.51.
<br />...it's done and nothing happen, ok i give up now, let's hear other oddities.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>*Spitfire_NES*</b> [ Wed Jul 20, 2011 12:54 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">plasturion wrote:</div><div class="quotecontent">It's kinda fun, you allways discover something new, i noticed that FDS support is also inside snss.cpp. So at first I'll try to make it similar like 0.51.<br />...it's done and nothing happen, ok i give up now, let's hear other oddities.</div>
<br />
<br />you mean you added the 2 together to compile for nester? or you added to nestopia?
<br />
<br />oddities...hmmm ill have some soon <img src="./images/smilies/icon_smile.gif" alt=":)" title="Smile" /> LOL

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>plasturion</b> [ Wed Jul 20, 2011 1:13 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />I working only with both version of NesterJ 0.51 and 0.503 to find some clue of correct FDS emulate.
<br />
<br />For now I can make only three things to do:
<br />- make NesterJ 0.51 the same problem like FCEUX putting (bad) 0.503 files
<br />- brick NesterJ 0.51 somehow to works bad like FCEUX.
<br />- fix NesterJ 0.503 giving, modify (good) 0.51 files (snss.cpp, 020.cpp, maybe other)
<br />
<br />If you made only one of that, it would be nice.
<br />There's no sense trying to put this to Nestopia if you don't know what, but good luck if you find something, let me and others know.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>*Spitfire_NES*</b> [ Wed Jul 20, 2011 1:24 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">plasturion wrote:</div><div class="quotecontent">I working only with both version of NesterJ 0.51 and 0.503 to find some clue of correct FDS emulate.<br /><br />For now I can make only three things to do:<br />- make NesterJ 0.51 the same problem like FCEUX putting (bad) 0.503 files<br />- brick NesterJ 0.51 somehow to works bad like FCEUX.<br />- fix NesterJ 0.503 giving, modify (good) 0.51 files (snss.cpp, 020.cpp, maybe other)<br /><br />If you made only one of that, it would be nice.<br />There's no sense trying to put this to Nestopia if you don't know what, but good luck if you find something, let me and others know.</div>
<br />
<br />gotcha. <img src="./images/smilies/icon_smile.gif" alt=":)" title="Smile" /> im looking at all the sources too. ill update as things progress as well my friend. <img src="./images/smilies/icon_smile.gif" alt=":)" title="Smile" /> ive also been taking classes since im not the best at this stuff.  im using other code as ways to help learn how things link together and reading up on nes documents and what fds sources i can find.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>plasturion</b> [ Fri Jul 22, 2011 8:39 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />I think i've got it...
<br />
<br />I've removed some code of NesterJ 0.51 and now works incorrect like FCEUX (and all other emus), and fixed 0.503 adding that new little part of code removed from 0.51.
<br />In that case now we can be certain, that only this part of code is responsible for correct work of Kiki Kaikai. (look at Nes_rom.cpp)
<br />
<br />What do you think about this?
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">&nbsp; &nbsp;if&#40;image_type == 1&#41;<br />&nbsp; &nbsp;&#123;<br />&nbsp; &nbsp;&nbsp; &nbsp;screen_mode = 1;<br />&nbsp; &nbsp;&nbsp; &nbsp;mapper = 20;<br /><br />&nbsp; &nbsp;&nbsp; &nbsp;fds = &#40;ROM_banks&#91;0x1f&#93; &lt;&lt; 24&#41; | &#40;ROM_banks&#91;0x20&#93; &lt;&lt; 16&#41; |<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&#40;ROM_banks&#91;0x21&#93; &lt;&lt;&nbsp; 8&#41; | &#40;ROM_banks&#91;0x22&#93; &lt;&lt;&nbsp; 0&#41;;<br /><br />&nbsp; &nbsp;&nbsp; &nbsp; for&#40;i = 0; i &lt; ROM_banks&#91;4&#93;; i++&#41;<br />&nbsp; &nbsp;&nbsp; &nbsp; &#123;<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;uint8 file_num = 0;<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;uint32 pt = 16+65500*i+0x3a;<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;while&#40;ROM_banks&#91;pt&#93; == 0x03&#41;<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&#123;<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;pt += 0x0d;<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;pt += ROM_banks&#91;pt&#93; + ROM_banks&#91;pt+1&#93; * 256 + 4;<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;file_num++;<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&#125;<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;ROM_banks&#91;16+65500*i+0x39&#93; = file_num;<br />&nbsp; &nbsp;&nbsp; &nbsp;&#125;<br />&nbsp; &nbsp;&#125;<br /></div>

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>*Spitfire_NES*</b> [ Fri Jul 22, 2011 11:28 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Great work plasturion! <img src="./images/smilies/icon_wink.gif" alt=";)" title="Wink" />. This might be of huge help to other emus that want to make the kiki update. Lol. U deserve a round of brew lol. <img src="./images/smilies/icon_lol.gif" alt=":lol:" title="Laughing" />
<br />
<br />Seriously though that's awesome that something new is always to be learned.
<br />
<br />Since you have become the nestopia saviour would it be easier to put this in or is that a diff thing from the others? So u got fceultra to run it right? I just wanted to make sure that's what u were saying. I myself have been studying the Nes ppu and the nestopia ppu code. This emu is pretty advanced coding work.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>tokumaru</b> [ Fri Jul 22, 2011 11:31 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Wait, are you guys just trying to get the game to run or actually looking for the emulation inaccuracy that prevents it from running?

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>plasturion</b> [ Fri Jul 22, 2011 12:38 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">*Spitfire_NES* wrote:</div><div class="quotecontent">So u got fceultra to run it right? I just wanted to make sure that's what u were saying. I myself have been studying the Nes ppu and the nestopia ppu code. This emu is pretty advanced coding work.</div><br />like fceu means like all other emus... I compiled only NesterJ 0.51 to make works like 0.503, and 0.503 to works like 0.51, only to make ensure where's the problem.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">Wait, are you guys just trying to get the game to run or actually looking for the emulation inaccuracy that prevents it from running?</div>
<br />And that's a good question. But what can be inaccurate? Emulation of NesterJ or all the other emus, so maybe there's something in known FDS docs, that can be incorrect, or something missing? Or this code might be helpful only to emulate Kiki, but is wrong and it can broke other FDS games? We need an expert opinion.
<br />
<br />...about trying to put this to Nestopia, maybe now it's a good idea... It has high compatibility and we need some test.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>thefox</b> [ Fri Jul 22, 2011 11:21 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">plasturion wrote:</div><div class="quotecontent">What do you think about this?<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">&nbsp; &nbsp;if&#40;image_type == 1&#41;<br />&nbsp; &nbsp;&#123;<br />&nbsp; &nbsp;&nbsp; &nbsp;screen_mode = 1;<br />&nbsp; &nbsp;&nbsp; &nbsp;mapper = 20;<br /><br />&nbsp; &nbsp;&nbsp; &nbsp;fds = &#40;ROM_banks&#91;0x1f&#93; &lt;&lt; 24&#41; | &#40;ROM_banks&#91;0x20&#93; &lt;&lt; 16&#41; |<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&#40;ROM_banks&#91;0x21&#93; &lt;&lt;&nbsp; 8&#41; | &#40;ROM_banks&#91;0x22&#93; &lt;&lt;&nbsp; 0&#41;;<br /><br />&nbsp; &nbsp;&nbsp; &nbsp; for&#40;i = 0; i &lt; ROM_banks&#91;4&#93;; i++&#41;<br />&nbsp; &nbsp;&nbsp; &nbsp; &#123;<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;uint8 file_num = 0;<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;uint32 pt = 16+65500*i+0x3a;<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;while&#40;ROM_banks&#91;pt&#93; == 0x03&#41;<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&#123;<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;pt += 0x0d;<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;pt += ROM_banks&#91;pt&#93; + ROM_banks&#91;pt+1&#93; * 256 + 4;<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;file_num++;<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&#125;<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;ROM_banks&#91;16+65500*i+0x39&#93; = file_num;<br />&nbsp; &nbsp;&nbsp; &nbsp;&#125;<br />&nbsp; &nbsp;&#125;<br /></div></div>
<br />As far as I can tell, this code scans through all disk sides, calculates number of files on that side, and then patches the <a href="http://wiki.nesdev.com/w/index.php/Family_Computer_Disk_System#File_amount_block_.28block_2.29" class="postlink">file amount block</a> with the correct number. What would this accomplish, I don't know. Seems like a hack, since FDS can't really be doing the same.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>BMF54123</b> [ Fri Jul 22, 2011 11:49 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />This "throw chunks of mystery code around and see if they stick" mentality to fixing emulation problems is kinda disappointing.
<br />
<br /><div class="quotetitle">*Spitfire_NES* wrote:</div><div class="quotecontent">I wonder what that all means....lol :p</div>
<br />Your enthusiasm is commendable, but...if you don't actually know what the code is doing, perhaps you shouldn't be trying to "fix" the problem, lest you introduce even more somewhere down the road.

		

		</td>
	</tr>
	</table>


<hr width="85%" />

<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
<tr>
	<td><span class="gensmall">Page <strong>3</strong> of <strong>4</strong></span></td>
	<td align="right"><span class="gensmall">All times are UTC - 7 hours </span></td>
</tr>
<tr>
	<td colspan="2" align="center"><span class="gensmall">Powered by phpBB&reg; Forum Software &copy; phpBB Group<br />http://www.phpbb.com/</span></td>
</tr>
</table>

</body>
</html>