<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html dir="ltr" lang="en-gb">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta http-equiv="Content-Style-Type" content="text/css">
<meta http-equiv="Content-Language" content="en-gb">
<title>nesdev.com :: View topic - Mega Man 4 and MMC3</title>

<style type="text/css">
<!--

body {
	font-family: Verdana,serif;
	font-size: 10pt;
}

img {
	border: 0;
}

td {
	font-family: Verdana,serif;
	font-size: 10pt;
	line-height: 150%;
}

.code, .codecontent, 
.quote, .quotecontent {
	margin: 0 5px 0 5px;
	padding: 5px;
	font-size: smaller;
	border: black solid 1px;
}

.quotetitle {
	color: black;
	display : block;
	font-weight: bold;
}

.forum {
	font-family: Arial,Helvetica,sans-serif;
	font-weight: bold;
	font-size: 18pt;
}

.topic {
	font-family: Arial,Helvetica,sans-serif;
	font-size: 14pt;
	font-weight: bold;
}

.gensmall {
	font-size: 8pt;
}

hr {
	color: #888;
	height: 3px;
	border-style: solid;
}

hr.sep {
	color: #aaa;
	height: 1px;
	border-style: dashed;
}
//-->
</style>

</head>
<body>

<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
<tr>
	<td colspan="2" align="center"><span class="Forum">nesdev.com</span><br /><span class="gensmall"><a href="http://forums.nesdev.com/">http://forums.nesdev.com/</a></span></td>
</tr>
<tr>
	<td colspan="2"><br /></td>
</tr>
<tr>
	<td><span class="topic">Mega Man 4 and MMC3</span><br /><span class="gensmall"><a href="http://forums.nesdev.com/viewtopic.php?f=2&amp;t=6505">http://forums.nesdev.com/viewtopic.php?f=2&amp;t=6505</a></span></td>
	<td align="right" valign="bottom"><span class="gensmall">Page <strong>1</strong> of <strong>5</strong></span></td>
</tr>
</table>



	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>anwerman</b> [ Thu Jun 17, 2010 9:35 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Mega Man 4 and MMC3</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Hello everyone,
<br />
<br />I joined up because I've been researching up on how the NES works.  I never really appreciated the hardware before, but now that I've been reading up on the system, I'm really impressed by how it works.
<br />
<br />Anyway, I know that with various mappers, you can extend the capabilities of the Nintendo.  And I'm really stumped at how Capcom implemented the scrolling features found in Mega Man 4, specifically Dustman's stage.
<br />
<br /><!-- m --><a class="postlink" href="http://www.youtube.com/watch?v=VRVSWJsKsck">http://www.youtube.com/watch?v=VRVSWJsKsck</a><!-- m -->  (Starts around 1:45)
<br />
<br />Looking at the nametable viewers in FCEUX, I can see that the moving pillars is just the background being scrolled.  However, the bottom of the screen is fixed.
<br />
<br />From what I've read up, I'm assuming that an IRQ interrupt is being called and thus is causing the CPU/PPU to draw a different part of the nametable. 
<br />
<br />What I don't get is how the collision detection works.   So, my best guess is that up until the IRQ interrupt, Mega Man's collision detection hitpoints look up X + OffsetX, Y + OffsetY, and after the IRQ interrupt, OffsetX and OffsetY change to different locations within the nametable.  OffsetX and Y would also be used to determine what tiles to draw onto the screen.
<br />
<br />In a dumbed down sense, is this how Mega Man 4 with the MMC3 mapper work?

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>tokumaru</b> [ Thu Jun 17, 2010 9:49 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />I haven't studied this game in particular, but ideally, collision detection should not be directly related to graphics. Well coded games have a clear separation between the simulated world and what's displayed on the screen, the latter being a mere visual representation of the former.
<br />
<br />The graphical part is probably done, like you said, through an IRQ firing right before the scanline where the floor must be, at which point the vertical scroll is modified to display the proper name table section. This is a common technique used in several games, not only for effects like this but also for status bars and such.
<br />
<br />About the logical part, it would make sense if the moving pillars and blocks were treated as objects in the code, and like any game object they can move around. But I can't know for sure since I haven't studied the game's code.
<br />
<br />What I mean is that the name table is not (or shouldn't be) used for collision detection. The name tables are only used to display graphical representations of levels and/or objects that are modeled as the game's programmer sees fit somewhere else in ROM and/or RAM.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>anwerman</b> [ Thu Jun 17, 2010 10:20 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />"What I mean is that the name table is not (or shouldn't be) used for collision detection. "
<br />
<br />Ok, I was reading up on the article on "Making M.C. Kids"
<br /><!-- m --><a class="postlink" href="http://games.greggman.com/game/programming_m_c__kids/">http://games.greggman.com/game/programming_m_c__kids/</a><!-- m -->
<br />
<br />The data in that game specifically is based off of 16x16 blocks, of 4 tiles each, and block holding a number that contains data about which tile is which and the collision detection routine.
<br />
<br />So that although the nametables only display what should be drawn, that data that determines what goes on the nametable needs to come from somewere.  Wouldn't there be linked memory banks that would hold block/tile data (e.g., solid, nonsolid, which tiles, etc.)   And much like nametables, the game would stream in level data into approperiate level table as necessary?  E.g., whenever a column gets updated in the nametable, a similar table gets updated with new pieces of level data that reference whehter a block/tile is solid, an enemy, etc.  That the game only interacts with a screenful of objects and tile data at a time?
<br />
<br />Like I said, I'm a novice on the NES and the system.  But from what I've noticed, it seems that the nametables is just a graphical representation of what data the game is interacting with behind the scenes.  And I could be way wrong on this hahaha.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Dwedit</b> [ Thu Jun 17, 2010 10:26 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />The crushing ceiling that moves up and down is just vertical scrolling, then after a certain point, it changes a nonscrolling floor.
<br />
<br />It uses the IRQ feature of the MMC3 so it knows at what time to change the scrolling location to the floor.  It's not absolutely necessary to have an MMC3 to do this effect, but that chip makes it a lot easier.
<br />It's basically the same as any other game with a status bar positioned on the bottom that scrolls independently of the playfield.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>tokumaru</b> [ Thu Jun 17, 2010 10:31 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />How games store their maps internally varies greatly from game to game, but to me it seems unlikely that any programmer would make a moving area (pillars) and a static area (floor) parts of the same map.
<br />
<br />I know that I, as a programmer, would treat them as different things, even though both get rendered to the same name tables (because the NES has only 1 background plane), in order to facilitate interaction of the player with both, which would otherwise be tricky as you detailed in your first post.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>anwerman</b> [ Thu Jun 17, 2010 10:59 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Ok, that makes sense.  Different things.
<br />I've just always wondered how old games just did this type of stuff, as I too am a programmer.
<br />
<br />I'm actually just working within C# on an 'emulator' type system where I can develop a game that would marginally look like an NES game and I'm just tryin to figure out how the old games did stuff.
<br />
<br />... and as a programmer I hate 'special cases' when it comes to programming hahahaha.
<br />
<br />So your best bet is that this stage is actually two maps layered ontop of each other then, with one just being offset from the other?   The only thing that I can think of that could argue this point would be that when Mega Man scrolls onto and off of the screen, the pillars move to the top of the screen in a fixed position .e.g, no IRQ offset being used at that point.
<br />
<br />Who knows.  All I can really say is that I need to experiment with this; Capcom's programmers were paid to screw around with this stuff, I'm just doin it for free <img src="./images/smilies/icon_razz.gif" alt=":P" title="Razz" />
<br />
<br />And thank you for your help.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>tokumaru</b> [ Fri Jun 18, 2010 12:39 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">anwerman wrote:</div><div class="quotecontent">I'm actually just working within C# on an 'emulator' type system where I can develop a game that would marginally look like an NES game and I'm just tryin to figure out how the old games did stuff.</div><br />I see... You have a framework with graphical limitations similar to those of the NES, right? These kinds of raster effects might not translate well from the NES to such an environment, because they require perfect synchronization to the screen's refresh rate, so that modifications to PPU parameters are made as specific scanlines are rendered. So for this kind of effect you'd probably have to simulate this scanline-by-scanline rendering (no need to work pixel-by-pixel I guess).<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">So your best bet is that this stage is actually two maps layered ontop of each other then, with one just being offset from the other?</div><br />Without looking at the game's code, that would be my best guess, and how I would implement it myself. The NES has only 1 background plane, but if I cleanly split it in the middle I can pretend I have 2 and use raster effects to move them independently. In the code, the maps would be separate entities and the main character would be offset differently to each map, and I'd test for collisions with both of them.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">The only thing that I can think of that could argue this point would be that when Mega Man scrolls onto and off of the screen, the pillars move to the top of the screen in a fixed position .e.g, no IRQ offset being used at that point.</div><br />I don't see how that invalidates the idea... When Mega Man enters and exits the "special effects" area there seems to be some "snapping" of the pillars, so there most likely is something going on to properly position them.<br /><br />IIRC, MM4 tries to simulate single-screen mirroring (meaning that all the action happens in a single name table at a time) by constantly switching mirroring types, so maybe it's using one of the name tables for the "special effects" section and the other for regular sections, and switching between the two at will. There are a number of ways to deal with this.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">And thank you for your help.</div>
<br />Don't mention it. I'm just sharing my opinions. =)

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Wave</b> [ Fri Jun 18, 2010 2:51 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Megaman 3-6 uses 1 nametable for the "playfield" and another for the menu.
<br />When you scroll vertically, it changes mirroring and uses the same nametable to do scrolling, then resets mirroring again.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Bregalad</b> [ Fri Jun 18, 2010 3:18 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />If I were to implement this in my game, I'd do the pillar as an object, and have it's collision detection routine crush anything that would contact with them (since no object will ever be above the pillars).
<br />Of course the routine would "tell" the main engine to handle the IRQ and vertical scroll split.
<br />
<br />The hard part is where they have destroyable blocks that scrolls with the pillar. I don't know how they implemented this, but it sounds like a headache ! Handling each block as an individual object sounds like it would be slow as hell, and I can't come with anything else in my mind.
<br />
<br />Anyways you're sure that the collision detection doesn't "change on a scanline based timing" like vertical scrolling does, it doesn't make any sense.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>tepples</b> [ Fri Jun 18, 2010 4:26 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">tokumaru wrote:</div><div class="quotecontent">So for this kind of effect you'd probably have to simulate this scanline-by-scanline rendering (no need to work pixel-by-pixel I guess).</div>
<br />Likewise, for <a href="http://www.pineight.com/pc/#tod" class="postlink">one of my PC games</a>, I simulated something similar to Mode 7 of Super NES with HDMA (automatic raster effect system that the Super NES provides). The framework came in handy when I <a href="http://www.pineight.com/gba/#tod" class="postlink">revamped it on Game Boy Advance</a>, as I could just reimplement that framework to fix the screen height to 160 and use the GBA's counterpart to Mode 7 and HDMA. (It only looks like a total rewrite because I changed the menu entirely and carefully used lower-precision math for speed on a 16 MHz CPU.)
<br />
<br />That said, in the Mega Man level, I'd represent the plane with the pillars and debris blocks as The Level, and the floor as a platform that moves up and down. Compare the <a href="http://www.youtube.com/watch?v=eYsWViP-nHA" class="postlink">Boss Bass levels of Super Mario Bros. 3</a>.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>tokumaru</b> [ Fri Jun 18, 2010 6:20 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">tepples wrote:</div><div class="quotecontent">I'd represent the plane with the pillars and debris blocks as The Level, and the floor as a platform that moves up and down.</div>
<br />Indeed, that would be much simpler, seeing as the floor is just a flat surface. You would have to be careful to not screw up things on the physics side though... jumping  from a moving platform usually isn't the same as jumping from a static surface.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>tepples</b> [ Fri Jun 18, 2010 6:40 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">tokumaru wrote:</div><div class="quotecontent">You would have to be careful to not screw up things on the physics side though... jumping  from a moving platform usually isn't the same as jumping from a static surface.</div>
<br />Yes. Way too many games get this wrong: the initial velocity should be based on that of the platform that a character is standing on.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Dwedit</b> [ Fri Jun 18, 2010 7:35 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Reminds me of two games that really contrast as how they did moving platforms.
<br />
<br />In Castlevania 2, there are blocks which bob up and down.  If you jump while they are moving down, you jump much lower than if you jump while they move upward.
<br />
<br />In Megaman 1, your Y veolcity keeps increasing as you stand on a moving platform, and you are just repositioned onto the platform each frame.  Just watch how in gutsman's stage, you instantly fall down at a very high speed when you fall off the platforms.  Compare how fast you fall if you've recently jumped or not.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>psycopathicteen</b> [ Fri Jun 18, 2010 8:06 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />If the Snes had more than 2 hardware background layers, why was 2nd layer collision used way more on the Nes?

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>anwerman</b> [ Fri Jun 18, 2010 3:20 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />I just looked at the nametable viewer for the Big Bass levels of SMB3 and they did the same trick that Capcom did as well.    The Y offset of the nametables moves, causing it to appear like the stage is moving up and down.
<br />
<br />For the Mega Man scenario, the only solution I could come up with is that if there's a collision detection point above the scaline, add to it the Y' value's offset and have it test with the map for a collision.  If the point isn't keep it the same.
<br />
<br />Egad.  These people were geniouses who did this

		

		</td>
	</tr>
	</table>


<hr width="85%" />

<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
<tr>
	<td><span class="gensmall">Page <strong>1</strong> of <strong>5</strong></span></td>
	<td align="right"><span class="gensmall">All times are UTC - 7 hours </span></td>
</tr>
<tr>
	<td colspan="2" align="center"><span class="gensmall">Powered by phpBB&reg; Forum Software &copy; phpBB Group<br />http://www.phpbb.com/</span></td>
</tr>
</table>

</body>
</html>