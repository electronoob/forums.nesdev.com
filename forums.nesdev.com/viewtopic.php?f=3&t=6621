<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en-gb" xml:lang="en-gb">
<head>

<link rel="icon" href="/favicon.ico" type="image/x-icon" />
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
<meta http-equiv="content-language" content="en-gb" />
<meta http-equiv="content-style-type" content="text/css" />
<meta http-equiv="imagetoolbar" content="no" />
<meta name="resource-type" content="document" />
<meta name="distribution" content="global" />
<meta name="keywords" content="" />
<meta name="description" content="" />

<title>nesdev.com &bull; View topic - Fixing Nestest failiures</title>

<link rel="alternate" type="application/atom+xml" title="Feed - nesdev.com" href="http://forums.nesdev.com/feed.php" /><link rel="alternate" type="application/atom+xml" title="Feed - News" href="http://forums.nesdev.com/feed.php?mode=news" /><link rel="alternate" type="application/atom+xml" title="Feed - All forums" href="http://forums.nesdev.com/feed.php?mode=forums" /><link rel="alternate" type="application/atom+xml" title="Feed - New Topics" href="http://forums.nesdev.com/feed.php?mode=topics" /><link rel="alternate" type="application/atom+xml" title="Feed - Active Topics" href="http://forums.nesdev.com/feed.php?mode=topics_active" /><link rel="alternate" type="application/atom+xml" title="Feed - Forum - NESemdev" href="http://forums.nesdev.com/feed.php?f=3" /><link rel="alternate" type="application/atom+xml" title="Feed - Topic - Fixing Nestest failiures" href="http://forums.nesdev.com/feed.php?f=3&amp;t=6621" />

<link rel="stylesheet" href="./style.php?id=1&amp;lang=en" type="text/css" />

<script type="text/javascript">
// <![CDATA[


function popup(url, width, height, name)
{
	if (!name)
	{
		name = '_popup';
	}

	window.open(url.replace(/&amp;/g, '&'), name, 'height=' + height + ',resizable=yes,scrollbars=yes,width=' + width);
	return false;
}

function jumpto()
{
	var page = prompt('Enter the page number you wish to go to:', '1');
	var per_page = '15';
	var base_url = './viewtopic.php?f=3&amp;t=6621';

	if (page !== null && !isNaN(page) && page == Math.floor(page) && page > 0)
	{
		if (base_url.indexOf('?') == -1)
		{
			document.location.href = base_url + '?start=' + ((page - 1) * per_page);
		}
		else
		{
			document.location.href = base_url.replace(/&amp;/g, '&') + '&start=' + ((page - 1) * per_page);
		}
	}
}

/**
* Find a member
*/
function find_username(url)
{
	popup(url, 760, 570, '_usersearch');
	return false;
}

/**
* Mark/unmark checklist
* id = ID of parent container, name = name prefix, state = state [true/false]
*/
function marklist(id, name, state)
{
	var parent = document.getElementById(id);
	if (!parent)
	{
		eval('parent = document.' + id);
	}

	if (!parent)
	{
		return;
	}

	var rb = parent.getElementsByTagName('input');
	
	for (var r = 0; r < rb.length; r++)
	{
		if (rb[r].name.substr(0, name.length) == name)
		{
			rb[r].checked = state;
		}
	}
}



// ]]>
</script>
</head>
<body class="ltr">

<a name="top"></a>

<div id="wrapheader">

	<div id="logodesc">
	</div>

	<div id="menubar">

		<table width="100%" cellspacing="0">
		<tr>
			<td rowspan="2"><a href="./index.php"><img src="./styles/subsilver2/imageset/site_logo.gif" alt="" title="" /></a></td>
			<td width="100%" align="center"><h1>nesdev.com</h1><span class="gen">NES Development and Strangulation Records message boards</span></td>
		</tr>
		<tr>
			<td align="center">
				<a href="./faq.php"><img src="./styles/prosilver/theme/images/icon_mini_faq.gif" width="12" height="13" alt="*" /> FAQ</a>
				&nbsp; &nbsp;<a href="./search.php"><img src="./styles/prosilver/theme/images/icon_mini_search.gif" width="12" height="13" alt="*" /> Search</a>
				<br />	
				 &nbsp;<a href="./ucp.php?mode=register"><img src="./styles/prosilver/theme/images/icon_mini_register.gif" width="12" height="13" alt="*" /> Register</a>
					&nbsp; &nbsp;<a href="./ucp.php?mode=login"><img src="./styles/prosilver/theme/images/icon_mini_login.gif" width="12" height="13" alt="*" /> Login</a>&nbsp;
			</td>
		</tr>
		</table>
	</div>

	<div id="datebar">
		<table width="100%" cellspacing="0">
		<tr>
			<td class="gensmall"></td>
			<td class="gensmall" align="right">It is currently Sun Sep 21, 2014 8:50 am<br /></td>
		</tr>
		</table>
	</div>

</div>

<div id="wrapcentre">

	
	<p class="searchbar">
		<span style="float: left;"><a href="./search.php?search_id=unanswered">View unanswered posts</a> | <a href="./search.php?search_id=active_topics">View active topics</a></span>
		
	</p>
	

	<br style="clear: both;" />

	<table class="tablebg" width="100%" cellspacing="1" cellpadding="0" style="margin-top: 5px;">
	<tr>
		<td class="row1">
			<p class="breadcrumbs"><a href="./index.php">Board index</a> &#187; <a href="./viewforum.php?f=24">NES / Famicom</a> &#187; <a href="./viewforum.php?f=3">NESemdev</a></p>
			<p class="datetime">All times are UTC - 7 hours </p>
		</td>
	</tr>
	</table>

	<br />

<div id="pageheader">
	<h2><a class="titles" href="./viewtopic.php?f=3&amp;t=6621">Fixing Nestest failiures</a></h2>


	<p class="moderators">Moderator: <a href="./memberlist.php?mode=group&amp;g=320">Moderators</a></p>

</div>

<br clear="all" /><br />

<div id="pagecontent">

	<table width="100%" cellspacing="1">
	<tr>
		<td align="left" valign="middle" nowrap="nowrap">
		<a href="./posting.php?mode=post&amp;f=3"><img src="./styles/subsilver2/imageset/en/button_topic_new.gif" alt="Post new topic" title="Post new topic" /></a>&nbsp;<a href="./posting.php?mode=reply&amp;f=3&amp;t=6621"><img src="./styles/subsilver2/imageset/en/button_topic_reply.gif" alt="Reply to topic" title="Reply to topic" /></a>
		</td>
		
			<td class="nav" valign="middle" nowrap="nowrap">&nbsp;Page <strong>1</strong> of <strong>2</strong><br /></td>
			<td class="gensmall" nowrap="nowrap">&nbsp;[ 23 posts ]&nbsp;</td>
			<td class="gensmall" width="100%" align="right" nowrap="nowrap"><b><a href="#" onclick="jumpto(); return false;" title="Click to jump to page…">Go to page</a> <strong>1</strong><span class="page-sep">, </span><a href="./viewtopic.php?f=3&amp;t=6621&amp;start=15">2</a> &nbsp;<a href="./viewtopic.php?f=3&amp;t=6621&amp;start=15">Next</a></b></td>
		
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr>
		<td class="cat">
			<table width="100%" cellspacing="0">
			<tr>
				<td class="nav" nowrap="nowrap">&nbsp;
				<a href="./viewtopic.php?f=3&amp;t=6621&amp;view=print" title="Print view">Print view</a>
				</td>
				<td class="nav" align="right" nowrap="nowrap"><a href="./viewtopic.php?f=3&amp;t=6621&amp;view=previous">Previous topic</a> | <a href="./viewtopic.php?f=3&amp;t=6621&amp;view=next">Next topic</a>&nbsp;</td>
			</tr>
			</table>
		</td>
	</tr>

	</table>


	<table class="tablebg" width="100%" cellspacing="1">
	
		<tr>
			<th>Author</th>
			<th>Message</th>
		</tr>
	<tr class="row1">

			<td align="center" valign="middle">
				<a name="p64505"></a>
				<b class="postauthor">aphex</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p64505">Fixing Nestest failiures</a></div><div style="float: right;"><a href="./viewtopic.php?p=64505#p64505"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Tue Jul 20, 2010 7:34 am&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Thu Apr 22, 2010 1:35 pm<br /><b>Posts:</b> 25<br /><b>Location:</b> England
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">Hi everyone
<br />Here is a screenshot of the nestest.nes rom completed in my emulator 
<br />
<br /><img src="http://img44.imageshack.us/img44/7392/55517763.png" alt="Image" />
<br />
<br />As you can see, many of the tests fail, but the test numbers that are indicated are mostly all just general failiures, such as "SBC # Failiure", so it's difficult to track down exactly what is wrong. I'll start with the first error, 73. This is listed <a href="http://www.qmtpro.com/~nes/misc/nestest.txt" class="postlink">here</a> as an SBC # Faliure. Here is my SBC instruction as it stands at the moment. 
<br />
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void NesMainClass::_SBC&#40;u8 toSub, int cycles&#41; <br />&#123;<br />&nbsp; &nbsp;cpuCycles += cycles;<br /><br />&nbsp; &nbsp;// Store the A register <br />&nbsp; &nbsp;u8 beforeSub = regs-&gt;A;&nbsp; &nbsp;<br /><br />&nbsp; &nbsp;// Do the subtraction<br />&nbsp; &nbsp;regs-&gt;A -= toSub;<br /><br />&nbsp; &nbsp;// Subtract one more if carry is clear<br />&nbsp; &nbsp;if &#40;!TestBit&#40;regs-&gt;P, FLAG_C&#41;&#41;<br />&nbsp; &nbsp;&nbsp; &nbsp;regs-&gt;A--;<br /><br />&nbsp; &nbsp;// Is the Negative/Sign bit set?<br />&nbsp; &nbsp;regs-&gt;P = &#40;TestBit&#40;regs-&gt;A, 7&#41;&#41; ? <br />&nbsp; &nbsp;&nbsp; &nbsp;SET_N_FLAG : CLR_N_FLAG;<br /><br />&nbsp; &nbsp;// Is the result zero?<br />&nbsp; &nbsp;regs-&gt;P = &#40;regs-&gt;A == 0&#41; ? <br />&nbsp; &nbsp;&nbsp; &nbsp;SET_Z_FLAG : CLR_Z_FLAG;<br /><br />&nbsp; &nbsp;// Was there a borrow<br />&nbsp; &nbsp;regs-&gt;P = &#40;beforeSub - toSub &gt;= 0&#41; ? <br />&nbsp; &nbsp;&nbsp; &nbsp;SET_C_FLAG : CLR_C_FLAG;<br /><br />&nbsp; &nbsp;// The Overflow flag works by indicating whether there was a sign overflow<br />&nbsp; &nbsp;// i.e The result was outside the range of -128 to 127 <br />&nbsp; &nbsp;regs-&gt;P = &#40;regs-&gt;A &gt; 127 || &#40;s8&#41;beforeSub + TestBit&#40;regs-&gt;P, FLAG_C&#41; -1 - &#40;s8&#41;toSub &lt; -128&#41; ?<br />&nbsp; &nbsp;&nbsp; &nbsp;SET_V_FLAG : CLR_V_FLAG;<br />&#125;&nbsp; &nbsp;</div>
<br />
<br />Assuming all the various addressing modes are correct, the only problem i can think of is that the overflow being set for a signed underflow as well. (ie should only be set if the result is more that 127 and not less than -128 as well? Im not sure...). I really can't see the problem here, can anyone else spot any problems with this code?
<br />
<br />thanks <img src="./images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=4348"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row2">

			<td align="center" valign="middle">
				<a name="p64516"></a>
				<b class="postauthor">pdq</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p64516"></a></div><div style="float: right;"><a href="./viewtopic.php?p=64516#p64516"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Tue Jul 20, 2010 11:35 am&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Fri Jun 25, 2010 6:15 am<br /><b>Posts:</b> 6
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">It's much easier if you grab the golden nestest log from here and compare your CPU state against it, instruction by instruction.  
<br />
<br />NOTE: you will need to set your PC to $C000 (ie bypass the reset/power interrupt vectors).
<br />
<br /><!-- m --><a class="postlink" href="http://wiki.nesdev.com/w/index.php/Emulator_tests">http://wiki.nesdev.com/w/index.php/Emulator_tests</a><!-- m --></div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=4437"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row1">

			<td align="center" valign="middle">
				<a name="p64524"></a>
				<b class="postauthor">James</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p64524"></a></div><div style="float: right;"><a href="./viewtopic.php?p=64524#p64524"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Tue Jul 20, 2010 12:38 pm&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				<tr>
					<td><img src="./download/file.php?avatar=88_1370398059.png" width="100" height="100" alt="User avatar" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Sat Jan 22, 2005 8:51 am<br /><b>Posts:</b> 358<br /><b>Location:</b> Chicago, IL
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">This topic comes up every once in a while and I'm always tempted to reply with my take on it.  Here goes:
<br />
<br />First of all, I don't understand how you're setting the processor flags (looks like regs-&gt;P can be overwritten by subsequent tests).  In any event, I think your overflow logic is off.
<br />
<br />The overflow flag is set when the result is outside of the signed char range (i.e., &gt; 127 or &lt; -128).  With SBC, an overflow can only happen when the signs, and hence the high bit, of the operands differ.  A positive number subtracted from a positive number, or a negative number subtracted from a negative number, will never overflow.  Examples:
<br />
<br />5 - 127 = -122 (no overflow)
<br />-5 - -128 = 123 (no overflow)
<br />5 - -128 = 133 (overflow -- signed result is -123, so high bit is 1)
<br />-5 - 127 = -132 (overflow -- signed result is 124, so high bit is 0)
<br />
<br />Plug in various numbers and you'll see that you can't make 2 same-signed numbers overflow.
<br />
<br />With this knowledge, you can implement the following logic: SBC performs A - M - (carry ? 0 : 1).  If the signs (high bit) of A and M differ <span style="text-decoration: underline">and</span> the signs of A and the result differ, then overflow has occurred:
<br />
<br />overflow = (A^M) &amp; (A^result) &amp; 0x80 ? true : false;
<br />
<br />For ADC (A + M + (carry ? 1 : 0)), only 2 positive, or 2 negative, numbers can result in overflow.  Therefore, you need to test that the signs of <span style="text-decoration: underline">both</span> A and M differ from sign of the result:
<br />
<br />overflow = (A^result) &amp; (M^result) &amp; 0x80 ? true : false;
<br />
<br />Hope this helps,
<br />James</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=88"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row2">

			<td align="center" valign="middle">
				<a name="p64533"></a>
				<b class="postauthor">aphex</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p64533"></a></div><div style="float: right;"><a href="./viewtopic.php?p=64533#p64533"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Tue Jul 20, 2010 5:19 pm&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Thu Apr 22, 2010 1:35 pm<br /><b>Posts:</b> 25<br /><b>Location:</b> England
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">@pdq
<br />
<br />I have already done this, and I actually have programmed my emulator to output an identicaly formatted log file to the nestest.log file. Although, the contents is different at this point obviously.
<br />
<br />@James
<br />
<br />To make things clearer, take this for example (but you're right lol)
<br />
<br />
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">regs-&gt;P = &#40;TestBit&#40;regs-&gt;A, 7&#41;&#41; ? SET_N_FLAG : CLR_N_FLAG;</div><br /><br />SET_N_FLAG is a macro which is defined like so.<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">&#40;regs-&gt;P |= 0x80&#41;</div><br /><br />CLR_N_FLAG is a macro which is defined like so.<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">&#40;regs-&gt;P &amp;= 0x7F&#41;</div><br /><br />So, to put another way, i'm simply saying. <br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">if &#40;TestBit&#40;regs-&gt;A, 7&#41;&#41; <br />&#123;<br />&nbsp; &nbsp; regs-&gt;P = &#40;regs-&gt;P |= 0x80&#41;;<br />&#125;<br />else<br />&#123;<br />&nbsp; &nbsp; regs-&gt;P = &#40;regs-&gt;P &amp;= 0x7F&#41;;<br />&#125;</div><br /><br />...and you know what? You just made me realise that I am not setting the flags wrong, but i am doing something pointless. The most logical way to do this would be like this.<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">&#40;TestBit&#40;regs-&gt;A, 7&#41;&#41; ? SET_N_FLAG : CLR_N_FLAG;</div><br /><br />Sorry about that (and for going on about it), I just recently re-wrote all the flag logic so i missed that, thanks for pointing it out. I was basically assigning regs-&gt;P to itself for no reason... <img src="./images/smilies/icon_redface.gif" alt=":oops:" title="Embarassed" /> <br /><br />Anyway, as for my SBC problem, thanks alot, that seemed to fix my problem. Here is my new flag test in SBC<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">&nbsp; &nbsp;&#40;&#40;beforeSub^toSub&#41; &amp; &#40;beforeSub^regs-&gt;A&#41; &amp; 0x80&#41; ? <br />&nbsp; &nbsp;&nbsp; &nbsp;SET_V_FLAG : CLR_V_FLAG;</div><br /><br />Although, now its replaced with another problem, "035h - CPX # failure (messed up flags)". <br /><br />Any ideas? I can't figure it out. My flags seem fine, here is my CMP instruction.<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void NesMainClass::_CMP&#40;u8 cmpReg, u8 toCmp, int cycles&#41;<br />&#123;<br />&nbsp; &nbsp;cpuCycles += cycles;&nbsp; &nbsp;<br /><br />&nbsp; &nbsp;cmpReg -= toCmp;<br /><br />&nbsp; &nbsp;// Is the Negative/Sign bit set?<br />&nbsp; &nbsp;&#40;TestBit&#40;cmpReg, 7&#41;&#41; ? <br />&nbsp; &nbsp;&nbsp; &nbsp;SET_N_FLAG : CLR_N_FLAG;<br /><br />&nbsp; &nbsp;// Is the result zero?<br />&nbsp; &nbsp;&#40;cmpReg == 0&#41; ? <br />&nbsp; &nbsp;&nbsp; &nbsp;SET_Z_FLAG : CLR_Z_FLAG;<br /><br />&nbsp; &nbsp;// Should we set the carry?<br />&nbsp; &nbsp;&#40;&#40;s8&#41;cmpReg &gt;= 0&#41; ? <br />&nbsp; &nbsp;&nbsp; &nbsp;SET_C_FLAG : CLR_C_FLAG;<br />&#125;</div><br /><br />Here is where the immediate CPX is called. <br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">case 0xE0: _CMP&#40;regs-&gt;X, readMem&#40;regs-&gt;PC&#41;, 2&#41;; regs-&gt;PC++; break;</div>
<br />
<br />Any ideas? Im sure my flags are correct in my cmp instruction, ill keep checking.
<br />
<br />Thanks alot for your help <img src="./images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=4348"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row1">

			<td align="center" valign="middle">
				<a name="p64534"></a>
				<b class="postauthor">aphex</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p64534"></a></div><div style="float: right;"><a href="./viewtopic.php?p=64534#p64534"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Tue Jul 20, 2010 5:26 pm&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Thu Apr 22, 2010 1:35 pm<br /><b>Posts:</b> 25<br /><b>Location:</b> England
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">Ok, i think i got the CPX flags problem fixed.
<br />
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void NesMainClass::_CMP&#40;u8 cmpReg, u8 toCmp, int cycles&#41;<br />&#123;<br />&nbsp; &nbsp;cpuCycles += cycles;&nbsp; &nbsp;<br /><br />&nbsp; &nbsp;// Is the Negative/Sign bit set?<br />&nbsp; &nbsp;&#40;TestBit&#40;cmpReg-toCmp, 7&#41;&#41; ? <br />&nbsp; &nbsp;&nbsp; &nbsp;SET_N_FLAG : CLR_N_FLAG;<br /><br />&nbsp; &nbsp;// Is the result zero?<br />&nbsp; &nbsp;&#40;cmpReg-toCmp == 0&#41; ? <br />&nbsp; &nbsp;&nbsp; &nbsp;SET_Z_FLAG : CLR_Z_FLAG;<br /><br />&nbsp; &nbsp;// Should we set the carry?<br />&nbsp; &nbsp;&#40;cmpReg-toCmp &gt;= 0&#41; ? <br />&nbsp; &nbsp;&nbsp; &nbsp;SET_C_FLAG : CLR_C_FLAG;<br />&#125;<br /></div><br /><br />Now im getting an ADC error (my emulator is so buggy lol). Im getting "022h - ADC # failure". Here is my ADC instruction<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void NesMainClass::_ADC&#40;u8 toAdd, int cycles&#41; <br />&#123;<br />&nbsp; &nbsp;cpuCycles += cycles;<br /><br />&nbsp; &nbsp;// Store the A register so we can check if there was a carry <br />&nbsp; &nbsp;u8 beforeAdd = regs-&gt;A;<br /><br />&nbsp; &nbsp;// A reg = A reg&nbsp; &nbsp;+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Carry&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;+ some value<br />&nbsp; &nbsp;regs-&gt;A = &#40;regs-&gt;A + TestBit&#40;regs-&gt;P, FLAG_C&#41; + toAdd&#41;;<br /><br />&nbsp; &nbsp;// Is the Negative/Sign bit set?<br />&nbsp; &nbsp;&#40;TestBit&#40;regs-&gt;A, 7&#41;&#41; ? <br />&nbsp; &nbsp;&nbsp; &nbsp;SET_N_FLAG : CLR_N_FLAG;<br /><br />&nbsp; &nbsp;// Is the result zero?<br />&nbsp; &nbsp;&#40;regs-&gt;A == 0&#41; ? <br />&nbsp; &nbsp;&nbsp; &nbsp;SET_Z_FLAG : CLR_Z_FLAG;<br /><br />&nbsp; &nbsp;// Was there a carry<br />&nbsp; &nbsp;&#40;&#40;beforeAdd + toAdd&#41; &gt; 255&#41; ? <br />&nbsp; &nbsp;&nbsp; &nbsp;SET_C_FLAG : CLR_C_FLAG;<br /><br />&nbsp; &nbsp;// Set overflow?<br />&nbsp; &nbsp;&#40;&#40;beforeAdd^regs-&gt;A&#41; &amp; &#40;toAdd^regs-&gt;A&#41; &amp; 0x80&#41; ?<br />&nbsp; &nbsp;&nbsp; &nbsp;SET_V_FLAG : CLR_V_FLAG;<br />&#125;</div>
<br />
<br />I'll keep seeing if i can fix it, but open to any ideas. Thanks <img src="./images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=4348"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row2">

			<td align="center" valign="middle">
				<a name="p64537"></a>
				<b class="postauthor">pdq</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p64537"></a></div><div style="float: right;"><a href="./viewtopic.php?p=64537#p64537"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Tue Jul 20, 2010 5:38 pm&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Fri Jun 25, 2010 6:15 am<br /><b>Posts:</b> 6
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">If you have your nestest log, then you should just post the failing instruction along with the golden one here.  It's much more obvious as to exactly what you got wrong.
<br />
<br />Your carry seems borked because a u8 - u8 is always &gt;= 0.  Have you tried this instead?
<br />
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">&#40;cmpReg&gt;=toCmp&#41; ? <br />&nbsp; &nbsp; &nbsp; SET_C_FLAG : CLR_C_FLAG;</div></div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=4437"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row1">

			<td align="center" valign="middle">
				<a name="p64540"></a>
				<b class="postauthor">aphex</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p64540"></a></div><div style="float: right;"><a href="./viewtopic.php?p=64540#p64540"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Tue Jul 20, 2010 6:44 pm&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Thu Apr 22, 2010 1:35 pm<br /><b>Posts:</b> 25<br /><b>Location:</b> England
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody"><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">a u8 - u8 is always &gt;= 0</div>
<br />
<br />I beg to differ, in C++ if you to the sum 10 - 15, you will get -5, unless you typecast the result of course. For example, this will evaluate as true. 
<br />
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">if &#40;10-15 &lt; 0&#41;</div><br /><br />As for the nestest log, I will show you the first part that isn't the same. (ignoring scanline and small cycle differences)<br /><br />Golden nestest.log, Starting at line 102<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">C824&nbsp; 48&nbsp; &nbsp; &nbsp; &nbsp; PHA&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;A:FF X:00 Y:00 P:AD SP:FB CYC: 86 SL:243<br />C825&nbsp; 28&nbsp; &nbsp; &nbsp; &nbsp; PLP&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;A:FF X:00 Y:00 P:AD SP:FA CYC: 95 SL:243<br />C826&nbsp; D0 09&nbsp; &nbsp; &nbsp;BNE $C831&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;A:FF X:00 Y:00 P:EF SP:FB CYC:107 SL:243</div><br /><br />My nestest log, starting at line 102<br /><br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">C824&nbsp; 48&nbsp; &nbsp; &nbsp; &nbsp; PHA&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;A:FF X:00 Y:00 P:AD SP:FB CYC:90 SL:1<br />C825&nbsp; 28&nbsp; &nbsp; &nbsp; &nbsp; PLP&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;A:FF X:00 Y:00 P:AD SP:FA CYC:102 SL:1<br />C826&nbsp; D0 09&nbsp; &nbsp; &nbsp;BNE $C831&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;A:FF X:00 Y:00 P:FF SP:FB CYC:108 SL:1</div>
<br />
<br />As you can see, A is pushed on to the stack (which contains FF), then it is pulled from the stack in to the flags register, (which should now = FF right?). In the golden nestest log, even though FF is pushed on to the stack (PHA) and that byte is pulled back in to the flags register, EF appears in the flags register. ie the brk flag is unset.
<br />
<br />Is this just my incompitance in not handling the brk flag correctly? Should the brk flag only be set by the brk instruction and never be set b any other instruction?</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=4348"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row2">

			<td align="center" valign="middle">
				<a name="p64545"></a>
				<b class="postauthor">pdq</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p64545"></a></div><div style="float: right;"><a href="./viewtopic.php?p=64545#p64545"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Tue Jul 20, 2010 7:22 pm&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Fri Jun 25, 2010 6:15 am<br /><b>Posts:</b> 6
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody"><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">Is this just my incompitance in not handling the brk flag correctly? Should the brk flag only be set by the brk instruction and never be set b any other instruction?<br /></div>
<br />
<br />Yes, in fact you shouldn't even implement the B flag in your P reg (it's always zero).  However, when P is pushed onto the stack for BRK or PHP, the byte is ORed so that B is set.</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=4437"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row1">

			<td align="center" valign="middle">
				<a name="p64546"></a>
				<b class="postauthor">blargg</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p64546"></a></div><div style="float: right;"><a href="./viewtopic.php?p=64546#p64546"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Tue Jul 20, 2010 8:31 pm&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				<tr>
					<td><img src="./download/file.php?avatar=17.gif" width="60" height="69" alt="User avatar" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Mon Sep 27, 2004 8:33 am<br /><b>Posts:</b> 3711<br /><b>Location:</b> Central Texas, USA
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">First thing you need to do is put your log and the nestest log in the same format. In your case, I'd strip off all the timing information after the registers. Then use a text file comparison tool that shows mismatching lines. Doing it manually is a very bad idea. You'll miss differences and spend lots of time doing something humans aren't suited for.
<br />
<br /><strong>EDIT:</strong> whoops, they are in the same format. The wrapped lines threw me off. <img src="./images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>

					
							<br /><br />
							<span class="gensmall">Last edited by <a href="./memberlist.php?mode=viewprofile&amp;u=17">blargg</a> on Tue Jul 20, 2010 10:37 pm, edited 1 time in total.</span>
						<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=17"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row2">

			<td align="center" valign="middle">
				<a name="p64547"></a>
				<b class="postauthor">aphex</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p64547"></a></div><div style="float: right;"><a href="./viewtopic.php?p=64547#p64547"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Tue Jul 20, 2010 9:32 pm&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Thu Apr 22, 2010 1:35 pm<br /><b>Posts:</b> 25<br /><b>Location:</b> England
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">Hi Blargg
<br />Both logs are basically in the exact same format now, and I'm actually making some great progress since my first post, I now pass 10 of the 13 tests and lots of games that didn't boot before are starting to work. 
<br />
<br /><img src="http://img822.imageshack.us/img822/7799/39851074.png" alt="Image" />
<br />
<br />Something I realised is that the Indirect Indexed instructions such as LDA (nn,X), suffers from the same bug as JMP Indirect when fetching the high byte of the word addres from past a page boundry. This isn't documented anywhere as far as I'm aware, maybe it should be put on the nesdev wiki? 
<br />
<br />Anyway, your advice is good and has come to mind to me too, but will be more useful when I have ironed out more bugs as the differences in the two files are fairly easy to track down at the moment. This is mainly due to the fact that they are "fairly" small in size and that the errors are pretty much contiguous at the moment. 
<br />
<br />I will likely find more issues with my instruction set so i'll keep posting in this thread if need be. 
<br />
<br />Thanks for all your help everyone</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=4348"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row1">

			<td align="center" valign="middle">
				<a name="p64548"></a>
				<b class="postauthor">blargg</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p64548"></a></div><div style="float: right;"><a href="./viewtopic.php?p=64548#p64548"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Tue Jul 20, 2010 10:41 pm&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				<tr>
					<td><img src="./download/file.php?avatar=17.gif" width="60" height="69" alt="User avatar" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Mon Sep 27, 2004 8:33 am<br /><b>Posts:</b> 3711<br /><b>Location:</b> Central Texas, USA
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">Whoops, you're right. The line-wrapping of the logs threw me off.
<br />
<br />It's documented in most 6502 references that zero-page addressing wraps around. LDX #1 : LDA $FF,X will load from $0000, not $0100, for example.
<br />
<br />Once you pass nestest, be sure to run my instruction tests as well (the other ones on the Wiki page).</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=17"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row2">

			<td align="center" valign="middle">
				<a name="p64582"></a>
				<b class="postauthor">aphex</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p64582"></a></div><div style="float: right;"><a href="./viewtopic.php?p=64582#p64582"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Wed Jul 21, 2010 11:53 am&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Thu Apr 22, 2010 1:35 pm<br /><b>Posts:</b> 25<br /><b>Location:</b> England
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">Blargg, I tried your instruction tests as well, but something is going very wrong in my emulator. Here is a screenshot of the rom single "01-implied.nes", rom. (same story for all the rom singles)
<br />
<br />
<br /><img src="http://img829.imageshack.us/img829/4381/60638956.png" alt="Image" />
<br />
<br />After a short time, I hit an illegal instruction. I'm positive it's some memory writes to the nametables that are going wrong here and not my scanline rendering routine. I'll have to resolve my final two errors in your nestest.nes rom first, but have you got any ideas about which instruction(s) might be causing this, as this is a common problem with a fair few games. On the bright side, I passed 11 out of the 13 tests now.
<br />
<br />
<br /><img src="http://img641.imageshack.us/img641/4763/79855364.png" alt="Image" /></div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=4348"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row1">

			<td align="center" valign="middle">
				<a name="p64607"></a>
				<b class="postauthor">blargg</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p64607"></a></div><div style="float: right;"><a href="./viewtopic.php?p=64607#p64607"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Wed Jul 21, 2010 8:40 pm&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				<tr>
					<td><img src="./download/file.php?avatar=17.gif" width="60" height="69" alt="User avatar" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Mon Sep 27, 2004 8:33 am<br /><b>Posts:</b> 3711<br /><b>Location:</b> Central Texas, USA
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">As stated on the <a href="http://wiki.nesdev.com/w/index.php/Emulator_Tests#CPU" class="postlink">Wiki</a>, it's best to get nestest passing first. Since you have an instruction log, it's easy to figure out why it's failing. After that's passing all the official instructions at least, then move on to mine. If your PPU isn't working, take a look at the readme, which explains other ways you can read the result. For one, there's audio beeps. If your APU doesn't work, then you can examine $6000-$7FFF to obtain an ASCII version of the output, that lists failed instructions.</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=17"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row2">

			<td align="center" valign="middle">
				<a name="p64612"></a>
				<b class="postauthor">aphex</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p64612"></a></div><div style="float: right;"><a href="./viewtopic.php?p=64612#p64612"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Wed Jul 21, 2010 8:57 pm&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Thu Apr 22, 2010 1:35 pm<br /><b>Posts:</b> 25<br /><b>Location:</b> England
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody"><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">As stated on the Wiki, it's best to get nestest passing first.</div>
<br />
<br />Yes, I will get the last two tests fixed (hopefully) first before I move on to other test roms.
<br />
<br />As for my PPU emulation, the only problem (optimistically) is that incorrect data is been written to the nametables. As you said though, i would need to make sure that I'm passing all the basic instruction tests before I should go any deeper in to these more specific problems. 
<br />
<br />I'm just getting into APU emulation, so I'll probably be asking some questions on this soon, although sound emulation isn't as scary as I once thought it was <img src="./images/smilies/icon_confused.gif" alt=":?" title="Confused" /> 
<br />
<br />Thanks Blargg</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=4348"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row1">

			<td align="center" valign="middle">
				<a name="p64630"></a>
				<b class="postauthor">aphex</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p64630"></a></div><div style="float: right;"><a href="./viewtopic.php?p=64630#p64630"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Thu Jul 22, 2010 2:55 am&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Thu Apr 22, 2010 1:35 pm<br /><b>Posts:</b> 25<br /><b>Location:</b> England
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">My emu finally passed all the tests <img src="./images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" />
<br />
<br /><img src="http://img31.imageshack.us/img31/3746/36322957.png" alt="Image" />
<br />
<br />Thanks so much for all the help, this is a major mile stone for me as alot of the games are booting and playing fine, and of course, thanks for writing the nestest Blargg.
<br />
<br />Now, the other instruction tests are running ok, although, I am getting lots of errors. for example, here is the rom single, "01-implied.nes"
<br />
<br /><img src="http://img828.imageshack.us/img828/8319/71557521.png" alt="Image" />
<br />
<br />Now all these are showing that there is some sort of problem with those instructions, correct?</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=4348"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table width="100%" cellspacing="1" class="tablebg">
	<tr align="center">
		<td class="cat"><form name="viewtopic" method="post" action="./viewtopic.php?f=3&amp;t=6621"><span class="gensmall">Display posts from previous:</span> <select name="st" id="st"><option value="0" selected="selected">All posts</option><option value="1">1 day</option><option value="7">7 days</option><option value="14">2 weeks</option><option value="30">1 month</option><option value="90">3 months</option><option value="180">6 months</option><option value="365">1 year</option></select>&nbsp;<span class="gensmall">Sort by</span> <select name="sk" id="sk"><option value="a">Author</option><option value="t" selected="selected">Post time</option><option value="s">Subject</option></select> <select name="sd" id="sd"><option value="a" selected="selected">Ascending</option><option value="d">Descending</option></select>&nbsp;<input class="btnlite" type="submit" value="Go" name="sort" /></form></td>
	</tr>
	</table>
	

	<table width="100%" cellspacing="1">
	<tr>
		<td align="left" valign="middle" nowrap="nowrap">
		<a href="./posting.php?mode=post&amp;f=3"><img src="./styles/subsilver2/imageset/en/button_topic_new.gif" alt="Post new topic" title="Post new topic" /></a>&nbsp;<a href="./posting.php?mode=reply&amp;f=3&amp;t=6621"><img src="./styles/subsilver2/imageset/en/button_topic_reply.gif" alt="Reply to topic" title="Reply to topic" /></a>
		</td>
		
			<td class="nav" valign="middle" nowrap="nowrap">&nbsp;Page <strong>1</strong> of <strong>2</strong><br /></td>
			<td class="gensmall" nowrap="nowrap">&nbsp;[ 23 posts ]&nbsp;</td>
			<td class="gensmall" width="100%" align="right" nowrap="nowrap"><b><a href="#" onclick="jumpto(); return false;" title="Click to jump to page…">Go to page</a> <strong>1</strong><span class="page-sep">, </span><a href="./viewtopic.php?f=3&amp;t=6621&amp;start=15">2</a> &nbsp;<a href="./viewtopic.php?f=3&amp;t=6621&amp;start=15">Next</a></b></td>
		
	</tr>
	</table>

</div>

<div id="pagefooter"></div>

<br clear="all" />
<table class="tablebg" width="100%" cellspacing="1" cellpadding="0" style="margin-top: 5px;">
	<tr>
		<td class="row1">
			<p class="breadcrumbs"><a href="./index.php">Board index</a> &#187; <a href="./viewforum.php?f=24">NES / Famicom</a> &#187; <a href="./viewforum.php?f=3">NESemdev</a></p>
			<p class="datetime">All times are UTC - 7 hours </p>
		</td>
	</tr>
	</table>
	<br clear="all" />

	<table class="tablebg" width="100%" cellspacing="1">
	<tr>
		<td class="cat"><h4>Who is online</h4></td>
	</tr>
	<tr>
		<td class="row1"><p class="gensmall">Users browsing this forum: No registered users and 3 guests</p></td>
	</tr>
	</table>


<br clear="all" />

<table width="100%" cellspacing="1">
<tr>
	<td width="40%" valign="top" nowrap="nowrap" align="left"></td>
	<td align="right" valign="top" nowrap="nowrap"><span class="gensmall">You <strong>cannot</strong> post new topics in this forum<br />You <strong>cannot</strong> reply to topics in this forum<br />You <strong>cannot</strong> edit your posts in this forum<br />You <strong>cannot</strong> delete your posts in this forum<br />You <strong>cannot</strong> post attachments in this forum<br /></span></td>
</tr>
</table>

<br clear="all" />

<table width="100%" cellspacing="0">
<tr>
	<td><form method="get" name="search" action="./search.php"><span class="gensmall">Search for:</span> <input class="post" type="text" name="keywords" size="20" /> <input class="btnlite" type="submit" value="Go" /><input type="hidden" name="t" value="6621" />
<input type="hidden" name="sf" value="msgonly" />
</form></td>
	<td align="right">
	<form method="post" name="jumpbox" action="./viewforum.php" onsubmit="if(document.jumpbox.f.value == -1){return false;}">

	<table cellspacing="0" cellpadding="0" border="0">
	<tr>
		<td nowrap="nowrap"><span class="gensmall">Jump to:</span>&nbsp;<select name="f" onchange="if(this.options[this.selectedIndex].value != -1){ document.forms['jumpbox'].submit() }">

		
			<option value="-1">Select a forum</option>
		<option value="-1">------------------</option>
			<option value="24">NES / Famicom</option>
		
			<option value="2">&nbsp; &nbsp;NESdev</option>
		
			<option value="3" selected="selected">&nbsp; &nbsp;NESemdev</option>
		
			<option value="21">&nbsp; &nbsp;NES Graphics</option>
		
			<option value="6">&nbsp; &nbsp;NES Music</option>
		
			<option value="9">&nbsp; &nbsp;NES Hardware and Flash Equipment</option>
		
			<option value="22">&nbsp; &nbsp;Homebrew Projects</option>
		
			<option value="10">&nbsp; &nbsp;Newbie Help Center</option>
		
			<option value="11">&nbsp; &nbsp;FCdev</option>
		
			<option value="18">&nbsp; &nbsp;NESdev China</option>
		
			<option value="27">&nbsp; &nbsp;NESdev Middle East</option>
		
			<option value="19">&nbsp; &nbsp;NESdev International</option>
		
			<option value="25">Other</option>
		
			<option value="5">&nbsp; &nbsp;General Stuff</option>
		
			<option value="4">&nbsp; &nbsp;Membler Industries</option>
		
			<option value="12">&nbsp; &nbsp;SNESdev</option>
		
			<option value="20">&nbsp; &nbsp;GBDev</option>
		
			<option value="23">&nbsp; &nbsp;Other Retro Dev</option>
		
			<option value="15">&nbsp; &nbsp;Test Forum</option>
		
			<option value="26">Site Issues</option>
		
			<option value="13">&nbsp; &nbsp;phpBB Issues</option>
		
			<option value="14">&nbsp; &nbsp;Web Issues</option>
		
			<option value="16">&nbsp; &nbsp;nesdevWiki</option>
		

		</select>&nbsp;<input class="btnlite" type="submit" value="Go" /></td>
	</tr>
	</table>

	</form>
</td>
</tr>
</table>


</div>

<div id="wrapfooter">
	
	<span class="copyright">Powered by <a href="http://www.phpbb.com/">phpBB</a>&reg; Forum Software &copy; phpBB Group
	</span>
</div>

</body>
</html>