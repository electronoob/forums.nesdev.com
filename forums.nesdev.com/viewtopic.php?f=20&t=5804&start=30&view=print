<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html dir="ltr" lang="en-gb">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta http-equiv="Content-Style-Type" content="text/css">
<meta http-equiv="Content-Language" content="en-gb">
<title>nesdev.com :: View topic - Fixing ROMs for EMS 64 GB Smart Card USB</title>

<style type="text/css">
<!--

body {
	font-family: Verdana,serif;
	font-size: 10pt;
}

img {
	border: 0;
}

td {
	font-family: Verdana,serif;
	font-size: 10pt;
	line-height: 150%;
}

.code, .codecontent, 
.quote, .quotecontent {
	margin: 0 5px 0 5px;
	padding: 5px;
	font-size: smaller;
	border: black solid 1px;
}

.quotetitle {
	color: black;
	display : block;
	font-weight: bold;
}

.forum {
	font-family: Arial,Helvetica,sans-serif;
	font-weight: bold;
	font-size: 18pt;
}

.topic {
	font-family: Arial,Helvetica,sans-serif;
	font-size: 14pt;
	font-weight: bold;
}

.gensmall {
	font-size: 8pt;
}

hr {
	color: #888;
	height: 3px;
	border-style: solid;
}

hr.sep {
	color: #aaa;
	height: 1px;
	border-style: dashed;
}
//-->
</style>

</head>
<body>

<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
<tr>
	<td colspan="2" align="center"><span class="Forum">nesdev.com</span><br /><span class="gensmall"><a href="http://forums.nesdev.com/">http://forums.nesdev.com/</a></span></td>
</tr>
<tr>
	<td colspan="2"><br /></td>
</tr>
<tr>
	<td><span class="topic">Fixing ROMs for EMS 64 GB Smart Card USB</span><br /><span class="gensmall"><a href="http://forums.nesdev.com/viewtopic.php?f=20&amp;t=5804">http://forums.nesdev.com/viewtopic.php?f=20&amp;t=5804</a></span></td>
	<td align="right" valign="bottom"><span class="gensmall">Page <strong>3</strong> of <strong>19</strong></span></td>
</tr>
</table>



	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>MottZilla</b> [ Sun Feb 14, 2010 10:10 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Well we are talking about a GB/GBC card, not GBA.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>tepples</b> [ Mon Feb 15, 2010 5:56 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />I guess my post was unclear. I should have added the following: "I am not aware of whether this feature existed on the GBC carts or was new to the GBA carts."

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>MottZilla</b> [ Mon Feb 15, 2010 12:18 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />I see what you mean. Personally I never found such features useful. And with this GB/GBC flash cartridge, trashing the master registers seems to be uncommon but does happen. Thankfully the BGB emulator and the debugger can usually spot the source of these writes so you can make a fix.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Great Hierophant</b> [ Mon Feb 15, 2010 11:15 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />This device was apparently marketed towards the 8-bit portable music crowd; game compatibility was not among the highest concerns.  In order to assure that every game worked with the device, you have to play through them all it would seem.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Great Hierophant</b> [ Sat Feb 20, 2010 10:29 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />The most compatible flash carts are those that are custom made from a donor cart and replace a game ROM with some kind of rewritable memory.  
<br />
<br />Apparently there seems to be more issues with carts writing, whether intentionally or not, in areas of the memory map that will crash the flash cart than in a mismatched MBC emulation.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>mugenmidget</b> [ Mon Jan 03, 2011 6:42 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Are your IPS patches still available anywhere, Hierophant?  The Mediafire link appears to be dead.  Thanks in advance and best wishes.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>MottZilla</b> [ Sat Mar 19, 2011 10:31 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />I was notified my fixes were offline, I didn't realize it. I uploaded them to a mirror and they also include some or all of GH's that were available.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>mugenmidget</b> [ Sat Mar 26, 2011 5:47 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Awesome!  <img src="./images/smilies/icon_smile.gif" alt=":)" title="Smile" /> Thank you so much, MottZilla.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>adam_smasher</b> [ Sun Mar 27, 2011 11:45 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Hi,
<br />
<br />I've patched Link's Awakening so that it no longer crashes when saving on an MBC5 (i.e. on these USB carts). Untested on a real GB, but it fixes the crash on emulators, anyway.
<br />
<br /><a href="http://www.nottheeconomist.com/zeldambc5fix.zip" class="postlink">DOWNLOAD</a>
<br />
<br />Apply to a Link's Awakening 1.0 [!] ROM.
<br />
<br />Technical details, for the curious:
<br />The game maintains a "current bank" variable in RAM at $DBAF. At $07C0 is a procedure that writes this variable to $2100, switching the bank. Normally when switching to the first bank, LA is always a good little game and writes $01. However, during the reset procedure that the save routine calls, RAM is zeroed out - including $DBAF, the current bank variable. One of the programmer's thought they were being clever, I'm sure, by not setting it to $01 before switching banks afterwards, relying on the zeroing out and the behaviour of the MBC1. This of course causes a crash when running on an MBC5, which actually switches bank 0 in.
<br />
<br />This patch replaces the write in the bank switch procedure with a call to a new procedure at $29A1. This procedure verifies that the bank to be written isn't 0 and adjusts it accordingly if it is. The code is basically the same as that suggested earlier in this thread by tokumaru/Dwedit, although I don't bother pushing/popping A (because the routine at $07C0 does this anyway - 2 bytes saved!). The area at $29A1 appeared to be unused space - hopefully it wasn't anything important.
<br />
<br />I realize this probably isn't all that helpful for most people, since the DX version apparently works fine. Mostly a curiosity/practice thing.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>MottZilla</b> [ Sun Mar 27, 2011 7:50 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />It's always good to have another fix available.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Great Hierophant</b> [ Tue Mar 29, 2011 12:40 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">MottZilla wrote:</div><div class="quotecontent">I was notified my fixes were offline, I didn't realize it. I uploaded them to a mirror and they also include some or all of GH's that were available.</div><br /><br />I lost all my fixes, could someone upload mine and MottZilla's?<br /><br /><div class="quotetitle">adam_smasher wrote:</div><div class="quotecontent">Hi,<br /><br />I've patched Link's Awakening so that it no longer crashes when saving on an MBC5 (i.e. on these USB carts). Untested on a real GB, but it fixes the crash on emulators, anyway.<br /><br /><a href="http://www.nottheeconomist.com/zeldambc5fix.zip" class="postlink">DOWNLOAD</a><br /><br />Apply to a Link's Awakening 1.0 [!] ROM.<br /><br />Technical details, for the curious:<br />The game maintains a "current bank" variable in RAM at $DBAF. At $07C0 is a procedure that writes this variable to $2100, switching the bank. Normally when switching to the first bank, LA is always a good little game and writes $01. However, during the reset procedure that the save routine calls, RAM is zeroed out - including $DBAF, the current bank variable. One of the programmer's thought they were being clever, I'm sure, by not setting it to $01 before switching banks afterwards, relying on the zeroing out and the behaviour of the MBC1. This of course causes a crash when running on an MBC5, which actually switches bank 0 in.<br /><br />This patch replaces the write in the bank switch procedure with a call to a new procedure at $29A1. This procedure verifies that the bank to be written isn't 0 and adjusts it accordingly if it is. The code is basically the same as that suggested earlier in this thread by tokumaru/Dwedit, although I don't bother pushing/popping A (because the routine at $07C0 does this anyway - 2 bytes saved!). The area at $29A1 appeared to be unused space - hopefully it wasn't anything important.<br /><br />I realize this probably isn't all that helpful for most people, since the DX version apparently works fine. Mostly a curiosity/practice thing.</div>
<br />
<br />Awesome, I always wanted to play straight Link's Awakening again on a real DMG.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>MottZilla</b> [ Tue Mar 29, 2011 2:20 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />They are here. h..<!-- m --><a class="postlink" href="p://www.megaupload.com/?d=2FV7QTGY">p://www.megaupload.com/?d=2FV7QTGY</a><!-- m -->
<br />
<br />Both of ours though I don't know that they are all there.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>praedo</b> [ Wed May 04, 2011 5:41 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />I tested on real GB and I can confirm it works fine. Thanks a lot, adam_smasher for your good job! <img src="./images/smilies/icon_smile.gif" alt=":)" title="Smile" />
<br />
<br />Would you be able to do the same for Mario Land 2? Map is garbled, you know. In that case, what are the technical details of the reason why it happens?
<br />
<br />Regards,
<br />Josep M.
<br />
<br />
<br /><div class="quotetitle">adam_smasher wrote:</div><div class="quotecontent">Hi,<br /><br />I've patched Link's Awakening so that it no longer crashes when saving on an MBC5 (i.e. on these USB carts). Untested on a real GB, but it fixes the crash on emulators, anyway.<br /><br /><a href="http://www.nottheeconomist.com/zeldambc5fix.zip" class="postlink">DOWNLOAD</a><br /><br />Apply to a Link's Awakening 1.0 [!] ROM.<br /><br />Technical details, for the curious:<br />The game maintains a "current bank" variable in RAM at $DBAF. At $07C0 is a procedure that writes this variable to $2100, switching the bank. Normally when switching to the first bank, LA is always a good little game and writes $01. However, during the reset procedure that the save routine calls, RAM is zeroed out - including $DBAF, the current bank variable. One of the programmer's thought they were being clever, I'm sure, by not setting it to $01 before switching banks afterwards, relying on the zeroing out and the behaviour of the MBC1. This of course causes a crash when running on an MBC5, which actually switches bank 0 in.<br /><br />This patch replaces the write in the bank switch procedure with a call to a new procedure at $29A1. This procedure verifies that the bank to be written isn't 0 and adjusts it accordingly if it is. The code is basically the same as that suggested earlier in this thread by tokumaru/Dwedit, although I don't bother pushing/popping A (because the routine at $07C0 does this anyway - 2 bytes saved!). The area at $29A1 appeared to be unused space - hopefully it wasn't anything important.<br /><br />I realize this probably isn't all that helpful for most people, since the DX version apparently works fine. Mostly a curiosity/practice thing.</div>

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>adam_smasher</b> [ Thu May 05, 2011 9:19 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />According to the first post in this thread, the "Bung Fix" solves the garbled map.
<br />
<br /><div class="quotetitle">Great Hierophant wrote:</div><div class="quotecontent">The Bung Fixes solve the Super Mario Land 2 problem (garbled map screen)</div><br /><br /><div class="quotetitle">Great Hierophant wrote:</div><div class="quotecontent">...there are three instances where the problem can occur: <br />1. Game writes to 3000-3FFF to perform a bankswitch<br />[...]<br />The Bung Fixes are supposed to address #1</div>
<br />
<br />Presuming GH is correct (and I see no reason to believe he isn't), there's the problem. Mario Land 2 apparently writes to $3000-$3FFF to bankswitch (curiously, only when fetching the map screen graphics?), which, according to <a href="http://www.reinerziegler.de/bungcart.txt" class="postlink">this document</a>, on a Bung cart will not switch the bank at all, and on an MBC5, like in the EMS carts, will use the lo-bit of the write as the hi-bit of the bank number.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>praedo</b> [ Thu May 05, 2011 5:43 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Thanks for your reply, adam_smasher. I did read the 1st post where you mention "Bung Fixes" but I didn't understand if "fixes" is a verb or not. At first I understood it as a name and I thought there were some bung fixes available somewhere. I search bung gameboy fixes and I didn't find anything. So now with your new post I understand that you meant that Bung fixes (verb) this problem with their carts sold. Unfortunately I don't have any of those (only the GB Smart Card).
<br />Best regards,
<br />Josep M.

		

		</td>
	</tr>
	</table>


<hr width="85%" />

<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
<tr>
	<td><span class="gensmall">Page <strong>3</strong> of <strong>19</strong></span></td>
	<td align="right"><span class="gensmall">All times are UTC - 7 hours </span></td>
</tr>
<tr>
	<td colspan="2" align="center"><span class="gensmall">Powered by phpBB&reg; Forum Software &copy; phpBB Group<br />http://www.phpbb.com/</span></td>
</tr>
</table>

</body>
</html>