<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en-gb" xml:lang="en-gb">
<head>

<link rel="icon" href="/favicon.ico" type="image/x-icon" />
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
<meta http-equiv="content-language" content="en-gb" />
<meta http-equiv="content-style-type" content="text/css" />
<meta http-equiv="imagetoolbar" content="no" />
<meta name="resource-type" content="document" />
<meta name="distribution" content="global" />
<meta name="keywords" content="" />
<meta name="description" content="" />

<title>nesdev.com &bull; View topic - Super Cars / $2004 reads</title>

<link rel="alternate" type="application/atom+xml" title="Feed - nesdev.com" href="http://forums.nesdev.com/feed.php" /><link rel="alternate" type="application/atom+xml" title="Feed - News" href="http://forums.nesdev.com/feed.php?mode=news" /><link rel="alternate" type="application/atom+xml" title="Feed - All forums" href="http://forums.nesdev.com/feed.php?mode=forums" /><link rel="alternate" type="application/atom+xml" title="Feed - New Topics" href="http://forums.nesdev.com/feed.php?mode=topics" /><link rel="alternate" type="application/atom+xml" title="Feed - Active Topics" href="http://forums.nesdev.com/feed.php?mode=topics_active" /><link rel="alternate" type="application/atom+xml" title="Feed - Forum - NESdev" href="http://forums.nesdev.com/feed.php?f=2" /><link rel="alternate" type="application/atom+xml" title="Feed - Topic - Super Cars / $2004 reads" href="http://forums.nesdev.com/feed.php?f=2&amp;t=4052" />

<link rel="stylesheet" href="./style.php?id=1&amp;lang=en" type="text/css" />

<script type="text/javascript">
// <![CDATA[


function popup(url, width, height, name)
{
	if (!name)
	{
		name = '_popup';
	}

	window.open(url.replace(/&amp;/g, '&'), name, 'height=' + height + ',resizable=yes,scrollbars=yes,width=' + width);
	return false;
}

function jumpto()
{
	var page = prompt('Enter the page number you wish to go to:', '1');
	var per_page = '15';
	var base_url = './viewtopic.php?f=2&amp;t=4052';

	if (page !== null && !isNaN(page) && page == Math.floor(page) && page > 0)
	{
		if (base_url.indexOf('?') == -1)
		{
			document.location.href = base_url + '?start=' + ((page - 1) * per_page);
		}
		else
		{
			document.location.href = base_url.replace(/&amp;/g, '&') + '&start=' + ((page - 1) * per_page);
		}
	}
}

/**
* Find a member
*/
function find_username(url)
{
	popup(url, 760, 570, '_usersearch');
	return false;
}

/**
* Mark/unmark checklist
* id = ID of parent container, name = name prefix, state = state [true/false]
*/
function marklist(id, name, state)
{
	var parent = document.getElementById(id);
	if (!parent)
	{
		eval('parent = document.' + id);
	}

	if (!parent)
	{
		return;
	}

	var rb = parent.getElementsByTagName('input');
	
	for (var r = 0; r < rb.length; r++)
	{
		if (rb[r].name.substr(0, name.length) == name)
		{
			rb[r].checked = state;
		}
	}
}



// ]]>
</script>
</head>
<body class="ltr">

<a name="top"></a>

<div id="wrapheader">

	<div id="logodesc">
	</div>

	<div id="menubar">

		<table width="100%" cellspacing="0">
		<tr>
			<td rowspan="2"><a href="./index.php"><img src="./styles/subsilver2/imageset/site_logo.gif" alt="" title="" /></a></td>
			<td width="100%" align="center"><h1>nesdev.com</h1><span class="gen">NES Development and Strangulation Records message boards</span></td>
		</tr>
		<tr>
			<td align="center">
				<a href="./faq.php"><img src="./styles/prosilver/theme/images/icon_mini_faq.gif" width="12" height="13" alt="*" /> FAQ</a>
				&nbsp; &nbsp;<a href="./search.php"><img src="./styles/prosilver/theme/images/icon_mini_search.gif" width="12" height="13" alt="*" /> Search</a>
				<br />	
				 &nbsp;<a href="./ucp.php?mode=register"><img src="./styles/prosilver/theme/images/icon_mini_register.gif" width="12" height="13" alt="*" /> Register</a>
					&nbsp; &nbsp;<a href="./ucp.php?mode=login"><img src="./styles/prosilver/theme/images/icon_mini_login.gif" width="12" height="13" alt="*" /> Login</a>&nbsp;
			</td>
		</tr>
		</table>
	</div>

	<div id="datebar">
		<table width="100%" cellspacing="0">
		<tr>
			<td class="gensmall"></td>
			<td class="gensmall" align="right">It is currently Thu Aug 30, 2012 9:24 pm<br /></td>
		</tr>
		</table>
	</div>

</div>

<div id="wrapcentre">

	
	<p class="searchbar">
		<span style="float: left;"><a href="./search.php?search_id=unanswered">View unanswered posts</a> | <a href="./search.php?search_id=active_topics">View active topics</a></span>
		
	</p>
	

	<br style="clear: both;" />

	<table class="tablebg" width="100%" cellspacing="1" cellpadding="0" style="margin-top: 5px;">
	<tr>
		<td class="row1">
			<p class="breadcrumbs"><a href="./index.php">Board index</a> &#187; <a href="./viewforum.php?f=24">NES / Famicom</a> &#187; <a href="./viewforum.php?f=2">NESdev</a></p>
			<p class="datetime">All times are UTC - 7 hours </p>
		</td>
	</tr>
	</table>

	<br />

<div id="pageheader">
	<h2><a class="titles" href="./viewtopic.php?f=2&amp;t=4052">Super Cars / $2004 reads</a></h2>


	<p class="moderators">Moderator: <a href="./memberlist.php?mode=group&amp;g=320">Moderators</a></p>

</div>

<br clear="all" /><br />

<div id="pagecontent">

	<table width="100%" cellspacing="1">
	<tr>
		<td align="left" valign="middle" nowrap="nowrap">
		<a href="./posting.php?mode=post&amp;f=2"><img src="./styles/subsilver2/imageset/en/button_topic_new.gif" alt="Post new topic" title="Post new topic" /></a>&nbsp;<a href="./posting.php?mode=reply&amp;f=2&amp;t=4052"><img src="./styles/subsilver2/imageset/en/button_topic_reply.gif" alt="Reply to topic" title="Reply to topic" /></a>
		</td>
		
			<td class="nav" valign="middle" nowrap="nowrap">&nbsp;Page <strong>1</strong> of <strong>2</strong><br /></td>
			<td class="gensmall" nowrap="nowrap">&nbsp;[ 21 posts ]&nbsp;</td>
			<td class="gensmall" width="100%" align="right" nowrap="nowrap"><b><a href="#" onclick="jumpto(); return false;" title="Click to jump to pageâ€¦">Go to page</a> <strong>1</strong><span class="page-sep">, </span><a href="./viewtopic.php?f=2&amp;t=4052&amp;start=15">2</a> &nbsp;<a href="./viewtopic.php?f=2&amp;t=4052&amp;start=15">Next</a></b></td>
		
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr>
		<td class="cat">
			<table width="100%" cellspacing="0">
			<tr>
				<td class="nav" nowrap="nowrap">&nbsp;
				<a href="./viewtopic.php?f=2&amp;t=4052&amp;view=print" title="Print view">Print view</a>
				</td>
				<td class="nav" align="right" nowrap="nowrap"><a href="./viewtopic.php?f=2&amp;t=4052&amp;view=previous">Previous topic</a> | <a href="./viewtopic.php?f=2&amp;t=4052&amp;view=next">Next topic</a>&nbsp;</td>
			</tr>
			</table>
		</td>
	</tr>

	</table>


	<table class="tablebg" width="100%" cellspacing="1">
	
		<tr>
			<th>Author</th>
			<th>Message</th>
		</tr>
	<tr class="row1">

			<td align="center" valign="middle">
				<a name="p32778"></a>
				<b class="postauthor">Bregalad</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p32778">Super Cars / $2004 reads</a></div><div style="float: right;"><a href="./viewtopic.php?p=32778#p32778"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Fri Apr 18, 2008 9:30 am&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				<tr>
					<td><img src="./download/file.php?avatar=38.jpg" width="60" height="60" alt="User avatar" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Fri Nov 12, 2004 2:49 pm<br /><b>Posts:</b> 5143<br /><b>Location:</b> Jongny, VD, Switzerland
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">Super Cars relies on $2004 reads to time its code. As if this wasn't enough, it also uses the $B3 illegal opcode (seems like it's LAX ($xx),Y). Is this game the more insane licenced NES game ?
<br />
<br />What especially interest me is how it reads $2004. As far I know, acessing $2007 during rendering is really bad because not only it screws the counters up, but also it can possibly make the PPU try to read and write at the same time and things like that.
<br />However, reading $2004 seems to do nothing special : It doesn't increase any counter, so it's possible to read it during rendering without affecting anything badly, right ? At least Super Cars and Micro Machines do this.
<br />
<br />What I'm more curious to know if how do we know what is read back. Super cars seems to load the first byte of the SPR-RAM buffer, and stuck in a loop until it differs from the value of $2004. After Sprite DMA, it make sense that you read the first OAM byte again since you wrote all 256 of them from 0 up to 255, so you read the first back. Adress in $2003 is changed during rendering, so reading $2004 will likely output a different byte, and then that's how Super Cars time its code to know when VBlank stopped. As far I know it's also possible to wait sprite-zero hit flag to be cleared for a similar effect.
<br />
<br />I ask myself if it wouldn't be possible to abuse this $2004 trick to do much better tricks than this. More specifically, you would put a dummy sprite somewhere in the screen, and it doesn't have to be sprite zero, any number would do. By repeately reading $2004 and wait for it to match your dummy's sprite Y position, is it possible to reliably wait for that Y position in question ? I guess it should be possible.
<br />
<br />That would allow simple cartridges to time their code without relying only on sprite zero hits anymore, so if that works then it's possible to do "pseudo-sprite zero hits" more than once per frame, with a totally transparent sprite and/or with no background enabled.
<br />
<br />Also, if $2003 modifies itself a way so that you can also read OAM in non-multiples of 4 indexes, this would be much more tricky, as you could read a X pos, palette byte or tile byte as well, so you have to be sure that your "hit sprite" have a Y pos smaller than all sprites that potentially have a X Pos, palette byte or tile number that matches its Y pos. Sounds like a headache.</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=38"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row2">

			<td align="center" valign="middle">
				<a name="p32779"></a>
				<b class="postauthor">Disch</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p32779">Re: Super Cars / $2004 reads</a></div><div style="float: right;"><a href="./viewtopic.php?p=32779#p32779"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Fri Apr 18, 2008 10:09 am&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				<tr>
					<td><img src="./download/file.php?avatar=33.png" width="65" height="75" alt="User avatar" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Wed Nov 10, 2004 6:47 pm<br /><b>Posts:</b> 1670
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody"><div class="quotetitle">Bregalad wrote:</div><div class="quotecontent">More specifically, you would put a dummy sprite somewhere in the screen, and it doesn't have to be sprite zero, any number would do. By repeately reading $2004 and wait for it to match your dummy's sprite Y position, is it possible to reliably wait for that Y position in question ? I guess it should be possible.</div>
<br />
<br />Not really... because:
<br />
<br />1)  Every sprite's Y position is examined every scanline (at least until 8 sprites are found -- then things get weirder).  So <em>at best</em> you could time to a certain point within a scanline... but would not be able to pick which scanline (at least not without Sprite-0 hit or something like that -- but if you're doing that then you don't really need any more timing mechanisms)
<br />
<br />2)  Things besides Y coords are examined when sprites are found to be in range.  Attributes, tile numbers, and X positions can all be read back from $2004 acting as potential false positives for your dummy sprite.
<br />
<br />3)  The PPU moves <em>much</em> faster than the CPU, making catching a single sprite value every frame pretty much impossible.  LDA $2004 takes 4 CPU cycles -- in that time the PPU has already passed through 4*3/2 = 6 OAM fetches.  So even if you get around the above 2 problems somehow, you'd still only have a 1/6 chance of actually connecting with your dummy sprite value (it doesn't stay on the bus very long)</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=33"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row1">

			<td align="center" valign="middle">
				<a name="p32789"></a>
				<b class="postauthor">dvdmth</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p32789"></a></div><div style="float: right;"><a href="./viewtopic.php?p=32789#p32789"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Fri Apr 18, 2008 12:30 pm&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Wed Mar 22, 2006 8:00 am<br /><b>Posts:</b> 354
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">Reading $2004 to detect the end of V-Blank can be useful if you're in a situation where the sprite 0 hit flag isn't always available as an indicator (either because sprite 0 isn't guaranteed to hit or because you have the sprite and/or BG layer disabled on the previous frame).  Reading $2004 will return the value $FF on the first 64 PPU cycles of every active scanline (including the dummy line), so unless OAM[0] contains the value $FF, this will provide a very reliable way to tell when rendering starts.
<br />
<br />If conditions are right, you can also detect H-Blank by looking for $FF starting in the middle of a scanline (after the initial 64 cycles).  If there are no sprites on the following line, and assuming there are no $FF values as Y coordinates, you will see $FF starting at cycle 257 of each line and will continue to see it until cycle 319.  If I recall, this is how Micro Machines depends on $2004 reads during active display.
<br />
<br />Writes to $2007 during display cause major problems, but reading from $2007 will only corrupt the remainder of the current scanline.  Some of Nintendo's own titles, including Zelda and SMB3, read from $2007 during raster effects (apparently the developers thought you had to read $2007 to get the scroll registers to latch, which isn't true).</div>

					
						<div class="postbody"><br />_________________<br />"Last version was better," says Floyd. "More bugs. Bugs make game fun."</div>
					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=360"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row2">

			<td align="center" valign="middle">
				<a name="p32791"></a>
				<b class="postauthor">Bregalad</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p32791"></a></div><div style="float: right;"><a href="./viewtopic.php?p=32791#p32791"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Fri Apr 18, 2008 1:26 pm&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				<tr>
					<td><img src="./download/file.php?avatar=38.jpg" width="60" height="60" alt="User avatar" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Fri Nov 12, 2004 2:49 pm<br /><b>Posts:</b> 5143<br /><b>Location:</b> Jongny, VD, Switzerland
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">Oh, thanks for pointing that out. So yeah reading $2004 can be usefull for detecting start of frame, but during the frame there isn't much use of it. Detect HBlank maybe, but anyway this isn't really needed, as you usually position sprite 0 hit and/or adjust timing of the code so that writes to PPU regusters are done at a correct time.
<br />
<br />However, you could count scanlines without the use of any timed code like that. A loop that wait for $2004 to be $ff for 2 consecutive reads, and then wait it to be different than $ff, and repeat while increasing a counter can reliably cout the scanlines (under the condition no Y-Pos if $ff, which isn't hard to do since $ff isn't on screen anyway). The probabitily that 2 sprites both use tile $ff and both are output via the $2004 buffer on 2 consecutive reads is really low.</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=38"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row1">

			<td align="center" valign="middle">
				<a name="p32794"></a>
				<b class="postauthor">tokumaru</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p32794"></a></div><div style="float: right;"><a href="./viewtopic.php?p=32794#p32794"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Fri Apr 18, 2008 1:56 pm&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				<tr>
					<td><img src="./download/file.php?avatar=95.png" width="80" height="80" alt="User avatar" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Sat Feb 12, 2005 9:43 pm<br /><b>Posts:</b> 5251<br /><b>Location:</b> Rio de Janeiro - Brazil
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">I thought the same thing, about the scanline counting I mean. This might be easier and more reliable than timed code if all you're doing is raster effects. Not really useful in an actual game though.
<br />
<br />I'm still trying to think of a possible way to use $2004 to detect scanlines... that would be really useful!</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=95"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row2">

			<td align="center" valign="middle">
				<a name="p32798"></a>
				<b class="postauthor">blargg</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p32798"></a></div><div style="float: right;"><a href="./viewtopic.php?p=32798#p32798"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Fri Apr 18, 2008 5:19 pm&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				<tr>
					<td><img src="./download/file.php?avatar=17.gif" width="60" height="69" alt="User avatar" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Mon Sep 27, 2004 8:33 am<br /><b>Posts:</b> 2802
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">Right, scanline counting wouldn't be of any practical use since it would require timed code between the start of VBL or sprite hit, and the time you started counting scanlines. If you have timed code, you can just time the scanlines as well. Maybe if your timed code varied by a small number of clocks, it would be helpful.</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=17"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row1">

			<td align="center" valign="middle">
				<a name="p32802"></a>
				<b class="postauthor">Disch</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p32802"></a></div><div style="float: right;"><a href="./viewtopic.php?p=32802#p32802"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Fri Apr 18, 2008 6:53 pm&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				<tr>
					<td><img src="./download/file.php?avatar=33.png" width="65" height="75" alt="User avatar" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Wed Nov 10, 2004 6:47 pm<br /><b>Posts:</b> 1670
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">I just thought of a way to make this work.
<br />
<br />Rather than hooking the Y coord, which is next to impossible, perhaps you could hook the X+attribute+tile fetches.
<br />
<br />Consider the following:
<br />
<br />1)  OAM Y coords are fetched
<br />2)  If Y coord is in range, tile, attribute and X coord are fetched successively
<br />3)  Next Sprite's Y coord is fetched afterward
<br />4)  Process repeats
<br />
<br />
<br />Since tile+X+attribute fetches are all consecutive, this gives you a 6 dot window instead of a 2 dot window to catch the desired value.  Not much of an improvement on its own, but if you have 8 identical sprites on the same line, this gives you about a 6*8=48 dot window (with 16 of those dots being the Y coord -- so not quite 48 dots)
<br />
<br />If the tile ID, X coord, and attribute fetches are all the same key value -- catching this window is a good possibility.  Finding HBlank from here could involve the Micromachines style "look for FF" or whatever it does, but I don't know how reliable that'd be.
<br />
<br />
<br />Blah... I'm not organizing my thoughts very well in this post... but basically here's my idea
<br />
<br />- reserve a key value in OAM.  "$E3" is probably good because this is something the attribute byte can represent (doesn't use any unimplimented bits)
<br />
<br />- reserve 8 sprites (not just 1) to be the marker sprites
<br />
<br />- make sure these sprites are stored consectutively in OAM (like reserve the last 8 sprites or something)
<br />
<br />- give all these sprites an X position of $E3, set their attributes to $E3, and set them to draw tile $E3, and put them all on the same Y coord (note:  Y cannot be $E3!)
<br />
<br />- don't let ANY OTHER sprite have any value of E3.  This means you can't let sprites have X coords of E3.. nor can they use tile E3, etc, etc.  Doing so may allow false positives.
<br />
<br />
<br />Then... at any time $2004 returns $E3, you know it's fetching one of your key tiles, which means you found the desired scanline.  And since there's multiples sprites, the window is bigger, so you'll be able to reliably catch the sprite every time.
<br />
<br />Note that you can't use the Y coord as the key value.  It may seem like a good idea since this would have the window be gap-less, but since Y is fetched on every scanline, it would lead to false positives.  You also can't use values the attribute bits can't represent.  $E4 is no good, for example, since this would be stored in OAM (and read back) as $E0.
<br />
<br />
<br />
<br />Actually I don't even think you'd need 8 marker sprites...
<br />
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">LDA #$E3<br />loop:<br />&nbsp; CMP $2004&nbsp; &nbsp; ; 4 cycles &#40;6 fetches&#41;<br />&nbsp; BNE loop&nbsp; &nbsp; &nbsp; &nbsp;; 3 cycles &#40;4.5 fetches&#41;<br /></div>
<br />
<br />So you'd be polling every 10.5 fetches -- which means you would only need 3 marker sprites to ensure you don't skip over the window.
<br />
<br />
<br />
<br />I'm too lazy to write a test ROM to try it out ... but in theory it should work.  I don't think it'd be any better than sprite-0 hit for most things, though.  The only way I can see this being a good option is for turning the PPU on late (to extend VBlank).
<br />
<br />You could do that by putting the marker sprites near the top of the screen, then after you finish VBlank, enable sprite rendering only (leave BG rendering disabled) -- then poll $2004 to find the scanline and once it's found, turn BG rendering on.
<br />
<br />It's also repeatable.  That is, you can put marker tiles on multple scanlines and do the check several times (but they would have to be at least 9+ scanlines apart, or 17+ if you're using 8x16 sprites).</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=33"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row2">

			<td align="center" valign="middle">
				<a name="p32807"></a>
				<b class="postauthor">Bregalad</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p32807"></a></div><div style="float: right;"><a href="./viewtopic.php?p=32807#p32807"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Sat Apr 19, 2008 12:51 am&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				<tr>
					<td><img src="./download/file.php?avatar=38.jpg" width="60" height="60" alt="User avatar" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Fri Nov 12, 2004 2:49 pm<br /><b>Posts:</b> 5143<br /><b>Location:</b> Jongny, VD, Switzerland
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">Oh yeah. This is interesting, but terribly impratical. Even if it worked, the limitations are horrible. Cannot use tile $e3 is okay since it would most likely be transparent, but cannot use attributes $e3 and X-Pos $e3 for real sprites seems like a real limitation. Okay, you could cheaply substitute X-Pos $e3 for $e4, hoping nobody notices it. But for attributes, that's more a pain. However, you could just made all your sprites always in front of BG no matter what (most games does this), so the attribute will never be $e3 because that's back of background.
<br />
<br />So we can kind of work arround those limitations, but then if you reserve the last n sprites (4 or 8 ?) for this, then they can be bypassed by normal sprites on the same scanline, and wouldn't be fetched. So they have to be front priority, and if there is 8 of them "hide" other sprites (this could actually be usefull in some cases).
<br />
<br />So yeah if that works it could be usefull in a case or two, but is really hard to work on, since it imposes limitations on valid sprites.
<br />
<br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">You could do that by putting the marker sprites near the top of the screen, then after you finish VBlank, enable sprite rendering only (leave BG rendering disabled) -- then poll $2004 to find the scanline and once it's found, turn BG rendering on. </div>
<br />Yeah but then you couldn't write to $2007 during that time, which is as far I know the only real reason to "extend VBlank". Hide scrolling glitches maybe ? Bleh, not worth the trouble mentionned above.</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=38"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row1">

			<td align="center" valign="middle">
				<a name="p32814"></a>
				<b class="postauthor">tokumaru</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p32814"></a></div><div style="float: right;"><a href="./viewtopic.php?p=32814#p32814"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Sat Apr 19, 2008 4:06 am&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				<tr>
					<td><img src="./download/file.php?avatar=95.png" width="80" height="80" alt="User avatar" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Sat Feb 12, 2005 9:43 pm<br /><b>Posts:</b> 5251<br /><b>Location:</b> Rio de Janeiro - Brazil
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">In my opinion, these limitations are no worse than, say, the ones MMC3's scanline counter imposes you. I think this idea has potential, specially if it's possible with only 3 sprites. Meaning you can still have some sprite action at the same point.
<br />
<br />Any tile could be made transparent, so the number usued shouldn't matter for the tile index. And since the tile is transparent anyway, the ettributes do not matter either. The only serious limitation is the X coordinate. If it was possible to pick an unlikely attribute combination that placed the sprites near the left or roght edges of the screen, that would be great.
<br />
<br />A value of 0 would be ideal for the X coordinate, but preventing the use of unflipped sprites in front of the background using palette 0 could be a problem... On the other hand, since it's just one of the palettes, there might be a way to avoid a situation like this, through careful use of that palette. It could, for example, be used for a HUD or such things, but not be available for general use by game objects.</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=95"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row2">

			<td align="center" valign="middle">
				<a name="p32816"></a>
				<b class="postauthor">Disch</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p32816"></a></div><div style="float: right;"><a href="./viewtopic.php?p=32816#p32816"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Sat Apr 19, 2008 8:01 am&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				<tr>
					<td><img src="./download/file.php?avatar=33.png" width="65" height="75" alt="User avatar" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Wed Nov 10, 2004 6:47 pm<br /><b>Posts:</b> 1670
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody"><div class="quotetitle">Bregalad wrote:</div><div class="quotecontent">Yeah but then you couldn't write to $2007 during that time, which is as far I know the only real reason to "extend VBlank". Hide scrolling glitches maybe ? Bleh, not worth the trouble mentionned above.</div>
<br />
<br />The thing that makes turning the PPU on late hard is that the scroll gets funked up unless you set it explicitily with crafty $2006 writes and turn it on at a very specific scanline.  This can't normally be done without timed code because you have no way of knowing what scanline the PPU is on, and thus can't adjust your scroll appropriately.
<br />
<br />However with this method, you can use the sprite trick to find the desired scanline, then fix the scroll and turn on the BG, letting you turn the PPU on late without any scroll glitches.
<br />
<br />Example:  You want to turn the PPU on 20 scanlines late.  If you give yourself 2 scanlines padding, this means you can leave the PPU off for 18 extra scanlines:
<br />
<br />- turn PPU off in VBlank
<br />- allow your writes to spill out past end of VBlank (but don't go past scanline 18)
<br />- once your writes are complete, turn on sprite rendering (but not BG rendering)
<br />- begin looking for marker sprites
<br />- once marker sprites are found, you know what scanline you're on... so you can now adjust your scroll and turn BG rendering on.
<br />
<br />
<br />To elaborate further, you <em>would</em> be able to use $E3 for X/attributes for sprites below your marker sprites (kind of like how you can break the MMC3 rules once you're no longer using the IRQ counter -- once you already found your marker tiles, you can break the "can't use $E3 rule").
<br />
<br />$E3 would still be a forbidden Y coord for any sprite, though, simply because all the Y coords are fetched every scanline
<br />
<br />
<br />You might be able to use an attribute un-friendly value like $FE as the marker value.  This would leave more gaps in your window since you'd only be able to catch X coord and tile fetches, so to compensate you'd have to have more marker sprites (probably all 8).  I don't feel like doing the math to figure out the minimum though.
<br />
<br />Also I'm not so sure about the 3 sprite thing anymore -- you might need more.  I may have been tired when I came up with those numbers.  I'll double-check my math and repost later.
<br />
<br />EDIT:
<br />
<br />I was right -- 3 sprites isn't enough.  I must've been tired.
<br />
<br />Here is some crap I did in notepad:
<br />
<br />--------------------------------------------------
<br />
<br />Y = Y coord fetch
<br />A = attribute fetch
<br />T = tile fetch
<br />X = X coord fetch
<br />- = bad/unimportant fetch
<br />O = OK to catch here
<br />u = OK to catch here only if attribute friendly value used
<br />
<br />
<br />CMP $2004
<br />BNE loop    = 7 cycles = 21 dots
<br />
<br />
<br />Trying to catch marker during sprite evaluation (dots 64-255):
<br />
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">YYTTAAXXYYTTAAXXYYTTAAXXYYTTAAXXYYTTAAXXYYTTAAXXYYTTAAXXYYTTAAXX &lt;-- fetches<br />--OOuuOO--OOuuOO--OOuuOO--OOuuOO--OOuuOO--OOuuOO--OOuuOO--OOuuOO<br />-&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; u&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; O&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;-- check every 21 dots<br />&nbsp;-&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; O&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; O&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &lt;--&nbsp; and every possible sync sequence<br />&nbsp; O&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; O&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; u<br />&nbsp; &nbsp;O&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; u<br />&nbsp; &nbsp; u&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; O<br />&nbsp; &nbsp; &nbsp;u&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; O&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; O<br />&nbsp; &nbsp; &nbsp; O&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; O&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -<br />&nbsp; &nbsp; &nbsp; &nbsp;O&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; u&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -<br />&nbsp; &nbsp; &nbsp; &nbsp; -&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; u&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; O<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; O&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; O<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; O&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; O&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; u<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;O&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; u<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; u&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; O<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;u&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; O&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; O<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; O&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; O&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;O&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; u&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; u&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; O<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; O&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; O<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; O&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; O&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; u<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;O&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; u<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; u&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; O<br /></div><br /><br />This means:<br />- would need minimum of 5 marker sprites for attribute friendly key values ($E3).  This is true because there is always an 'O' or 'u' in the first two checks.  And the first two checks examine 5 sprites.<br /><br />- would need all 8 marker sprites for attribute unfriendly key values ($FE).  This is true because all three checks are needed (sometimes an 'O' isn't found until the 3rd check), and the third check requires all 8 sprites.<br /><br /><br />---------------------------------------------------<br /><br />Trying to catch marker during sprite fetches (dots 256-319):<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">YTAXXXXXYTAXXXXXYTAXXXXXYTAXXXXXYTAXXXXXYTAXXXXXYTAXXXXXYTAXXXXX<br />-OuOOOOO-OuOOOOO-OuOOOOO-OuOOOOO-OuOOOOO-OuOOOOO-OuOOOOO-OuOOOOO<br />-&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; O&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; u<br />&nbsp;O&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; O&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; O<br />&nbsp; u&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; O&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; O<br />&nbsp; &nbsp;O&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; O<br />&nbsp; &nbsp; O&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; O&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; O<br />&nbsp; &nbsp; &nbsp;O&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; u&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; O<br />&nbsp; &nbsp; &nbsp; O&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; O&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -<br />&nbsp; &nbsp; &nbsp; &nbsp;O&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; O&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; O<br />&nbsp; &nbsp; &nbsp; &nbsp; -&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; O&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; u<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;O&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; O&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; O<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; u&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; O&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; O<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;O&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; O<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; O&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; O&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; O<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;O&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; u&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; O<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; O&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; O&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;O&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; O&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; O<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; O&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; u<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;O&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; O&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; O<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; u&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; O&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; O<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;O&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; O<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; O&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; O&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; O<br /></div><br /><br />This means:<br />  - Only 5 marker sprites needed, even with attribute unfriendly value!<br />  - Additionally, the X coord is always caught!  So don't need to rely on a tile or attribute fetch!<br /><br /><br />The problem with catching during this part of the scanline is that the other part is run first, so you may catch your desired value there rather than here, which would make finding HBlank more difficult with timed code alone -- you'd need another method.<br /><br />-----------------------------------------------<br /><br /><br /><br />Once you find your scanline, you can sync to HBlank by looking for two consecutive $FF values read from $2004 (since the first 64 dots in a scanline will give $FF).  Time wasted between these checks should be minimalized to avoid muckups.  So something like the following code could be used:<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">LDA #$FE&nbsp; ; marker value<br />LDX #$FF&nbsp; ; FF to sync with HBlank<br /><br />find_marker:<br />&nbsp; &nbsp;CMP $2004<br />&nbsp; &nbsp;BNE find_marker<br /><br />find_hblank:<br />&nbsp; &nbsp;CPX $2004<br />&nbsp; &nbsp;BNE find_hblank<br />&nbsp; &nbsp;CPX $2004<br />&nbsp; &nbsp;BNE find_hblank<br /><br />; here, you are between dots 36 and 57 on your desired scanline.<br />;&nbsp; you can then use some timed code to find HBlank, where you'd reset your scroll<br />;&nbsp; and turn BG rendering on<br /></div>
<br />
<br />Since catching marker during sprite fetches doesn't require the key value to be attribute friendly, $FE seems like the ideal choice, since it won't conflict with attributes, it's not a good X coord (sprites that would have that coord would be mostly invisible anyway), and it will never be a Y coord ($F0 or $F8 are just as good to hide off-screen sprites)
<br />
<br />One thing to note about this HBlank sync method is that $FF can be read back during dots 256-319 if less than 8 sprites are found to be in range on the scanline.  Since this increases the sync window, I would recommend you have 8 marker sprites just to fill this out so that you won't ever get $FF until the start of the next scanline.  This will make HBlank syncing easier.
<br />
<br />
<br />Just remember the rules:
<br />
<br />1)  you need 5 marker sprites (though I recommend 8 to make HBlank syncing more reliable)
<br />2)  All marker sprites must be consecutive in OAM*
<br />3)  All marker sprites must be found to be in-range.  Don't let them get bumped off by visible sprites with higher priority!
<br />4)  Use $FE as a key value -- give all your marker sprites an X coord of $FE
<br />5)  Marker sprites attribute and tile can be anything (but you might as well use $FE as the tile and have it be transparent)
<br />6)  Never use $FE as a Y coord for any sprite
<br />7)  Don't use $FE as a Tile number or X coord of any sprite until you're done with all these checks for the frame
<br />8)  Refrain from using $FF as a Y coord to hide off-screen sprites to make HBlank syncing more reliable (don't want Y coords to be read back as false positives).  $F0 or $F8 are just as good (in fact... better!)
<br />9)  Marker sprites should be relatively high priorty (low sprite numbers).  Sprites 1-9 are good.
<br />
<br />
<br />*rule 2 isn't really true.  As long as all marker sprites are found to be in range consecutively (that is, you can have sprites 1,2,3,4,6 be marker sprites, as long as sprite 5 is not in-range on the scanline).  But that's a hypertechnicality.  It's best to just have them consecutive... so I would say treat that like a rule.
<br />
<br />
<br />
<br />With this new info -- the restrictions don't seem nearly as bad.  Attribute conflicts were the biggest problem, IMO, and now that that's out of the way, the biggest problem is making sure sprites don't end up with an X coord of $FE.  If this actually <em>works</em> (read:  I didn't test any of this, it's all still theoretical at this point... until someone actually makes a ROM to try this) I could see this being <em>very</em> useful.
<br />
<br />
<br />EDIT AGAIN:
<br />
<br />Crap -- just realized that you could get false positives if marker sprites are found to be in range as a 9th+ sprite (which could happen because the PPU gets funky after 8 sprites are found).  To avoid this... I added rule 9 above.
<br />
<br />
<br />ONE LAST EDIT:
<br />
<br />I figured this is given, but I should mention it anyway.
<br />
<br />This stuff would be applicable to NTSC only.  You could do a similer thing on PAL, but due to the slower CPU clock you'd probably need more thank 5 marker sprites and some other timing stuff would be different.</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=33"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row1">

			<td align="center" valign="middle">
				<a name="p32818"></a>
				<b class="postauthor">blargg</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p32818"></a></div><div style="float: right;"><a href="./viewtopic.php?p=32818#p32818"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Sat Apr 19, 2008 10:06 am&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				<tr>
					<td><img src="./download/file.php?avatar=17.gif" width="60" height="69" alt="User avatar" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Mon Sep 27, 2004 8:33 am<br /><b>Posts:</b> 2802
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">Disch, very nifty scheme. Seems to work with only 3 sprites set aside for it. Plus, a "key" of $00 instead of $E3 seems to work just as well. With the last 3 sprites at line Y, I'm able to have all the other sprites at Y+1; the other 3 bytes of all 256 sprites are filled with the key value. I haven't written a thorough test, but this one at least runs for 255 frames and adjusts the delay before starting polling for each frame. It looks like for some values of Y, the timing can vary up to around 50 PPU clocks, probably when enabling sprite rendering at more pathological times during the scanline (my test waits a scanline after enabling sprite rendering, before polling, otherwise I get much worse glitches).
<br />
<br />Let's discuss this on #nesdev on EFNet, if anyone's around...</div>

					
							<br /><br />
							<span class="gensmall">Last edited by <a href="./memberlist.php?mode=viewprofile&amp;u=17">blargg</a> on Sat Apr 19, 2008 10:15 am, edited 1 time in total.</span>
						<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=17"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row2">

			<td align="center" valign="middle">
				<a name="p32819"></a>
				<b class="postauthor">Bregalad</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p32819"></a></div><div style="float: right;"><a href="./viewtopic.php?p=32819#p32819"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Sat Apr 19, 2008 10:11 am&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				<tr>
					<td><img src="./download/file.php?avatar=38.jpg" width="60" height="60" alt="User avatar" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Fri Nov 12, 2004 2:49 pm<br /><b>Posts:</b> 5143<br /><b>Location:</b> Jongny, VD, Switzerland
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody"><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">To elaborate further, you would be able to use $E3 for X/attributes for sprites below your marker sprites (kind of like how you can break the MMC3 rules once you're no longer using the IRQ counter -- once you already found your marker tiles, you can break the "can't use $E3 rule"). </div>
<br />I'm not that sure. All 256 sprites are fetched every scanline, no matter if you're reading $2004 or not. So any sprite below the marker ones would also be fetched.
<br />
<br />Also, your timings diagrams are great, you did an excellent job ! However, one sad thing is that they are only valable on NTSC, as PAL doesn't have 3 dots per cycle, but 3.2, or in other word while the CPU run 5 cycles the PPU run 16 pixels, and not 15 as in NTSC. So the 7 cycle loop would be a non integer number of PPU cycles (22 + 2/5), completely screwing the thing up. The only way to get integer number of pixels on PAL is to have a loop whose cycles in a multiple of 5, since a 5-cycle loop sound impossible we'd have to make a 10-cycle loop that reads $2004, and catch a value each 32 PPU cycles, which is each 16 fetches. I don't know if 8 sprites are enough at all in that case.
<br />
<br />Also I cannot try anything on hardware because I have no EPROM programmer nor EPROMs, something should test this with powerpak probably (since it's not mapper related it should be trustable).</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=38"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row1">

			<td align="center" valign="middle">
				<a name="p32823"></a>
				<b class="postauthor">tokumaru</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p32823"></a></div><div style="float: right;"><a href="./viewtopic.php?p=32823#p32823"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Sat Apr 19, 2008 1:23 pm&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				<tr>
					<td><img src="./download/file.php?avatar=95.png" width="80" height="80" alt="User avatar" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Sat Feb 12, 2005 9:43 pm<br /><b>Posts:</b> 5251<br /><b>Location:</b> Rio de Janeiro - Brazil
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody"><div class="quotetitle">Bregalad wrote:</div><div class="quotecontent">I'm not that sure. All 256 sprites are fetched every scanline, no matter if you're reading $2004 or not. So any sprite below the marker ones would also be fetched.</div>
<br />It's 64 sprites, not 256... =) Anyway, only the Y coordinate of every sprite is fetched every scanline, the other values are only fetched if the Y coordinate indicates it's in range for the next scanline. So it's safe to use the key value for X coordinates after the tricky spot.
<br />
<br />Anyway, I think this is great. It probably is just a matter of using a value that doesn't affect your X coordinates very much. In some aspects this is better than sprite 0 hits, such as reusability, but there's the big disadvantage of wasting up to 8 sprites, instead of only one.</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=95"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row2">

			<td align="center" valign="middle">
				<a name="p32827"></a>
				<b class="postauthor">blargg</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p32827"></a></div><div style="float: right;"><a href="./viewtopic.php?p=32827#p32827"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Sat Apr 19, 2008 2:29 pm&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				<tr>
					<td><img src="./download/file.php?avatar=17.gif" width="60" height="69" alt="User avatar" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Mon Sep 27, 2004 8:33 am<br /><b>Posts:</b> 2802
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">My tests focus on using this to delay enabling PPU rendering. For that, 3 sprites work very reliably, and 2 sprites work decently (a little more variance in timing). I haven't tried it for mid-rendered-frame switches yet.</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=17"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row1">

			<td align="center" valign="middle">
				<a name="p32877"></a>
				<b class="postauthor">lft</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p32877"></a></div><div style="float: right;"><a href="./viewtopic.php?p=32877#p32877"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Mon Apr 21, 2008 7:55 am&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Mon Apr 21, 2008 6:53 am<br /><b>Posts:</b> 2<br /><b>Location:</b> Sweden
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody"><div class="quotetitle">Bregalad wrote:</div><div class="quotecontent">However, one sad thing is that they are only valable on NTSC, as PAL doesn't have 3 dots per cycle, but 3.2, or in other word while the CPU run 5 cycles the PPU run 16 pixels, and not 15 as in NTSC. So the 7 cycle loop would be a non integer number of PPU cycles (22 + 2/5), completely screwing the thing up. The only way to get integer number of pixels on PAL is to have a loop whose cycles in a multiple of 5, since a 5-cycle loop sound impossible we'd have to make a 10-cycle loop that reads $2004, and catch a value each 32 PPU cycles, which is each 16 fetches. I don't know if 8 sprites are enough at all in that case.</div>
<br />
<br />But what if you write the loop like this:
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lda #$fe<br />find_marker:&nbsp; &nbsp; cmp $2004<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; nop<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; beq found<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cmp $2004<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bne find_marker<br />found:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ...<br /></div>
<br />
<br />The loop takes 15 cycles, which is divisible by 5, but the maximum delay between bus peeks is 8 cycles. This way, 8 sprites might be sufficient on a PAL system as well. Anyone feel like working out a new diagram? =)</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=3519"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table width="100%" cellspacing="1" class="tablebg">
	<tr align="center">
		<td class="cat"><form name="viewtopic" method="post" action="./viewtopic.php?f=2&amp;t=4052"><span class="gensmall">Display posts from previous:</span> <select name="st" id="st"><option value="0" selected="selected">All posts</option><option value="1">1 day</option><option value="7">7 days</option><option value="14">2 weeks</option><option value="30">1 month</option><option value="90">3 months</option><option value="180">6 months</option><option value="365">1 year</option></select>&nbsp;<span class="gensmall">Sort by</span> <select name="sk" id="sk"><option value="a">Author</option><option value="t" selected="selected">Post time</option><option value="s">Subject</option></select> <select name="sd" id="sd"><option value="a" selected="selected">Ascending</option><option value="d">Descending</option></select>&nbsp;<input class="btnlite" type="submit" value="Go" name="sort" /></form></td>
	</tr>
	</table>
	

	<table width="100%" cellspacing="1">
	<tr>
		<td align="left" valign="middle" nowrap="nowrap">
		<a href="./posting.php?mode=post&amp;f=2"><img src="./styles/subsilver2/imageset/en/button_topic_new.gif" alt="Post new topic" title="Post new topic" /></a>&nbsp;<a href="./posting.php?mode=reply&amp;f=2&amp;t=4052"><img src="./styles/subsilver2/imageset/en/button_topic_reply.gif" alt="Reply to topic" title="Reply to topic" /></a>
		</td>
		
			<td class="nav" valign="middle" nowrap="nowrap">&nbsp;Page <strong>1</strong> of <strong>2</strong><br /></td>
			<td class="gensmall" nowrap="nowrap">&nbsp;[ 21 posts ]&nbsp;</td>
			<td class="gensmall" width="100%" align="right" nowrap="nowrap"><b><a href="#" onclick="jumpto(); return false;" title="Click to jump to pageâ€¦">Go to page</a> <strong>1</strong><span class="page-sep">, </span><a href="./viewtopic.php?f=2&amp;t=4052&amp;start=15">2</a> &nbsp;<a href="./viewtopic.php?f=2&amp;t=4052&amp;start=15">Next</a></b></td>
		
	</tr>
	</table>

</div>

<div id="pagefooter"></div>

<br clear="all" />
<table class="tablebg" width="100%" cellspacing="1" cellpadding="0" style="margin-top: 5px;">
	<tr>
		<td class="row1">
			<p class="breadcrumbs"><a href="./index.php">Board index</a> &#187; <a href="./viewforum.php?f=24">NES / Famicom</a> &#187; <a href="./viewforum.php?f=2">NESdev</a></p>
			<p class="datetime">All times are UTC - 7 hours </p>
		</td>
	</tr>
	</table>
	<br clear="all" />

	<table class="tablebg" width="100%" cellspacing="1">
	<tr>
		<td class="cat"><h4>Who is online</h4></td>
	</tr>
	<tr>
		<td class="row1"><p class="gensmall">Users browsing this forum: No registered users and 0 guests</p></td>
	</tr>
	</table>


<br clear="all" />

<table width="100%" cellspacing="1">
<tr>
	<td width="40%" valign="top" nowrap="nowrap" align="left"></td>
	<td align="right" valign="top" nowrap="nowrap"><span class="gensmall">You <strong>cannot</strong> post new topics in this forum<br />You <strong>cannot</strong> reply to topics in this forum<br />You <strong>cannot</strong> edit your posts in this forum<br />You <strong>cannot</strong> delete your posts in this forum<br />You <strong>cannot</strong> post attachments in this forum<br /></span></td>
</tr>
</table>

<br clear="all" />

<table width="100%" cellspacing="0">
<tr>
	<td><form method="get" name="search" action="./search.php"><span class="gensmall">Search for:</span> <input class="post" type="text" name="keywords" size="20" /> <input class="btnlite" type="submit" value="Go" /><input type="hidden" name="t" value="4052" />
<input type="hidden" name="sf" value="msgonly" />
</form></td>
	<td align="right">
	<form method="post" name="jumpbox" action="./viewforum.php" onsubmit="if(document.jumpbox.f.value == -1){return false;}">

	<table cellspacing="0" cellpadding="0" border="0">
	<tr>
		<td nowrap="nowrap"><span class="gensmall">Jump to:</span>&nbsp;<select name="f" onchange="if(this.options[this.selectedIndex].value != -1){ document.forms['jumpbox'].submit() }">

		
			<option value="-1">Select a forum</option>
		<option value="-1">------------------</option>
			<option value="24">NES / Famicom</option>
		
			<option value="2" selected="selected">&nbsp; &nbsp;NESdev</option>
		
			<option value="3">&nbsp; &nbsp;NESemdev</option>
		
			<option value="21">&nbsp; &nbsp;NES Graphics</option>
		
			<option value="6">&nbsp; &nbsp;NES Music</option>
		
			<option value="9">&nbsp; &nbsp;NES Hardware and Flash Equipment</option>
		
			<option value="22">&nbsp; &nbsp;Homebrew Projects</option>
		
			<option value="10">&nbsp; &nbsp;Newbie Help Center</option>
		
			<option value="11">&nbsp; &nbsp;FCdev</option>
		
			<option value="18">&nbsp; &nbsp;NESdev China</option>
		
			<option value="19">&nbsp; &nbsp;NESdev International</option>
		
			<option value="25">Other</option>
		
			<option value="5">&nbsp; &nbsp;General Stuff</option>
		
			<option value="4">&nbsp; &nbsp;Membler Industries</option>
		
			<option value="12">&nbsp; &nbsp;SNESdev</option>
		
			<option value="20">&nbsp; &nbsp;GBDev</option>
		
			<option value="23">&nbsp; &nbsp;Other Retro Dev</option>
		
			<option value="15">&nbsp; &nbsp;Test Forum</option>
		
			<option value="26">Site Issues</option>
		
			<option value="13">&nbsp; &nbsp;phpBB Issues</option>
		
			<option value="14">&nbsp; &nbsp;Web Issues</option>
		
			<option value="16">&nbsp; &nbsp;nesdevWiki</option>
		

		</select>&nbsp;<input class="btnlite" type="submit" value="Go" /></td>
	</tr>
	</table>

	</form>
</td>
</tr>
</table>


</div>

<div id="wrapfooter">
	
	<span class="copyright">Powered by <a href="http://www.phpbb.com/">phpBB</a>&reg; Forum Software &copy; phpBB Group
	</span>
</div>

</body>
</html>