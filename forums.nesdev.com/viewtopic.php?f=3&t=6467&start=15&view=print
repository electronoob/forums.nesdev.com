<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html dir="ltr" lang="en-gb">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta http-equiv="Content-Style-Type" content="text/css">
<meta http-equiv="Content-Language" content="en-gb">
<title>nesdev.com :: View topic - MMC3 RevA vs. RevB IRQ question</title>

<style type="text/css">
<!--

body {
	font-family: Verdana,serif;
	font-size: 10pt;
}

img {
	border: 0;
}

td {
	font-family: Verdana,serif;
	font-size: 10pt;
	line-height: 150%;
}

.code, .codecontent, 
.quote, .quotecontent {
	margin: 0 5px 0 5px;
	padding: 5px;
	font-size: smaller;
	border: black solid 1px;
}

.quotetitle {
	color: black;
	display : block;
	font-weight: bold;
}

.forum {
	font-family: Arial,Helvetica,sans-serif;
	font-weight: bold;
	font-size: 18pt;
}

.topic {
	font-family: Arial,Helvetica,sans-serif;
	font-size: 14pt;
	font-weight: bold;
}

.gensmall {
	font-size: 8pt;
}

hr {
	color: #888;
	height: 3px;
	border-style: solid;
}

hr.sep {
	color: #aaa;
	height: 1px;
	border-style: dashed;
}
//-->
</style>

</head>
<body>

<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
<tr>
	<td colspan="2" align="center"><span class="Forum">nesdev.com</span><br /><span class="gensmall"><a href="http://forums.nesdev.com/">http://forums.nesdev.com/</a></span></td>
</tr>
<tr>
	<td colspan="2"><br /></td>
</tr>
<tr>
	<td><span class="topic">MMC3 RevA vs. RevB IRQ question</span><br /><span class="gensmall"><a href="http://forums.nesdev.com/viewtopic.php?f=3&amp;t=6467">http://forums.nesdev.com/viewtopic.php?f=3&amp;t=6467</a></span></td>
	<td align="right" valign="bottom"><span class="gensmall">Page <strong>2</strong> of <strong>2</strong></span></td>
</tr>
</table>



	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>BootGod</b> [ Tue Jun 08, 2010 10:07 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />CopyNES doesn't have any extra RAM and I'm pretty sure the IRQ vector can't be modified. There is a interactive debugger, you can step thru the program on the cart, modify RAM, trigger IRQ's, etc.
<br />
<br />I'll poke around with it a bit when I get a chance.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>blargg</b> [ Tue Jun 08, 2010 11:28 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />If you don't mind using the solution I have, and have a clip lead, I can describe how to set it up and write the test code you can run from internal RAM, though I wouldn't know how CopyNES is instructed to run test code. A Game Genie was another solution I considered, but didn't want to do all that swapping with it. The clip lead was much simpler.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>BootGod</b> [ Wed Jun 09, 2010 3:10 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Does the fact that a number of the games you mentioned use both types of MMC3B indiscriminately throw a wrench in this theory?
<br />
<br />Mega Man 3 and Super Mario Bros 3 have been profiled using both NEC and Sharp MMC3B
<br />
<br />Same goes for Batman and Crystalis in the alt list.
<br />
<br /><a href="http://bootgod.dyndns.org:7777/profile.php?id=2" class="postlink">Super Mario Bros. 3 w/ NEC MMC3B</a>
<br /><a href="http://bootgod.dyndns.org:7777/profile.php?id=870" class="postlink">Super Mario Bros. 3 w/ Sharp MMC3B</a>
<br />
<br /><a href="http://bootgod.dyndns.org:7777/profile.php?id=46" class="postlink">Mega Man 3 w/ NEC MMC3B</a>
<br /><a href="http://bootgod.dyndns.org:7777/profile.php?id=2869" class="postlink">Mega Man 3 w/ Sharp MMC3B</a>
<br />
<br /><a href="http://bootgod.dyndns.org:7777/profile.php?id=232" class="postlink">Batman w/ NEC MMC3B</a>
<br /><a href="http://bootgod.dyndns.org:7777/profile.php?id=223" class="postlink">Batman w/ Sharp MMC3B</a>
<br />
<br /><a href="http://bootgod.dyndns.org:7777/profile.php?id=2373" class="postlink">Crystalis w/ NEC MMC3B</a>
<br /><a href="http://bootgod.dyndns.org:7777/profile.php?id=1119" class="postlink">Crystalis w/ Sharp MMC3B</a>
<br />
<br />I'm willing to try your testing method granted I can scrounge up the parts to make a cable.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>ReaperSMS</b> [ Wed Jun 09, 2010 3:15 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />That probably just means that the games don't rely on the different behavior.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>jwdonal</b> [ Wed Jun 09, 2010 3:27 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">ReaperSMS wrote:</div><div class="quotecontent">That probably just means that the games don't rely on the different behavior.</div>
<br />Agreed. There are probably very few games that are silly enough to set the IRQ counter reload value to zero in the first place.  But of course....there's always that one....haha.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>blargg</b> [ Wed Jun 09, 2010 4:03 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Yeah, my point about the same game using different versions is that this behavior difference wasn't exploited by games. I was simply theorizing about which behavior is in which versions of the mappers, and that the behavior difference wasn't a bug in one of the masks, but corresponded to earlier/later MMC3 revisions, with the split occurring not between MMC3A and MMC3B, but between MMC3B NEC and MMC3B Sharp:
<br />
<br />MMC3A
<br />MMC3B NEC
<br />----------------
<br />MMC3B Sharp
<br />MMC3C
<br />
<br />I had an idea that would allow almost <em>anyone</em> to test their MMC3 cartridges: make a Game Genie patch for the particular game that causes it to write 0 to $C000. Apply patch to game in emulator and select between the two behaviors and see what the visual effect is, then compare with what a person gets on their cartridge to determine which version of the MMC3 is in it. Also have the person open the cart to see what the markings are. The point of testing cartridges isn't to determine what a game depends on, but whether the behavior corresponds to the NEC/Sharp maker.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>BootGod</b> [ Wed Jun 09, 2010 6:48 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Yep, I figured this was the case, just wanted to be sure we weren't chasing the wrong path.
<br />
<br />If you think the Game Genie test will work, I can try that out. So this is as simple as entering a GG code in an emulator and then comparing the result to the real thing?

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>blargg</b> [ Wed Jun 09, 2010 6:54 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Just to be sure, I'll describe again, making fewer assumptions. The idea is to determine whether all the Sharp MMC3B chips behave one way, and the NEC MMC3B chips behave the other way (and that all MMCA chips behave the way of the NEC MMC3B). To do this we need to have some code write 0 to $C000 and then see if the IRQ keeps occurring. Rather than use CopyNES or stop-n-swop, we can have the game itself do this, via a Game Genie code. But this first requires someone to run each game in an emulator, breakpoint on $C000 writes, then device a Genie code that patches it to write zero, and finally test the code in an emulator that allows selection of the MMC3 variant, to see the visual effect of each variant. Then we put that code on the real thing and observe, and open the cart to see the chip markings.
<br />
<br />I don't have access to any NES emulators with debuggers, so it'd be simplest if someone with a good one made the Game Genie codes for us.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>BootGod</b> [ Wed Jun 09, 2010 7:16 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Yeah I think I understand you. For instance, using Golgo 13 as example: at E343h it writes to C000h. Changing the write to 00 at this point makes the screen glitch.
<br />
<br />Only problem is I don't know how to generate a GG code out of the raw address / data. I thought I remember a utility to do this, but I'm not finding anything atm.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>BootGod</b> [ Wed Jun 09, 2010 7:33 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Ok, I found an encoder, but the problem I'm having now is the code can't be active until the intro starts, otherwise it locks up. Maybe I'll have better luck with a different game.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>BootGod</b> [ Wed Jun 09, 2010 8:10 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Well I found a couple games that don't lock up or at least let you see a bit before they do. Now just need an emulator that supports both types of IRQs...
<br />
<br />So far, the Sharp MMC3B glitched the same as Nestopia did, the NEC MMC3B glitched differently. That would be as expected I guess.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>etabeta</b> [ Sun Jun 20, 2010 6:20 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent"><div class="codetitle"><b>Code:</b></div><div class="codecontent">&nbsp; &nbsp; if &#40; &#40;!mmc3_alt_behavior || old != 0 || clear&#41; &amp;&amp; counter == 0 &amp;&amp; enabled &#41; <br />&nbsp; &nbsp; &nbsp; &nbsp; irq = true; </div></div>
<br /> 
<br />@Blargg: I'm not 100% sure if I read correctly your code (and I wasn't able to find any clear answer searching though old topics, even if probably it is somewhere), so I have a question. Assume that 'clear' is false and that 'latch' is 0 (because of a 0 write to c000). Now, when counter reaches 0 and the latch = 0 is loaded to the counter, is it correct that the IRQ is fired with the usual IRQ and not fired with the alt IRQ? can you confirm this?
<br />
<br />If so, I think that either Rampart (US) or Joe &amp; Mac (US) or both rely on the alt IRQ behavior [1], in case you need some more test case.
<br />
<br />OTOH, if I made any mistake while interpreting the code above, could you  please explain me where I got it wrong? I'd be interested in the exact IRQ behavior <img src="./images/smilies/icon_smile.gif" alt=":)" title="Smile" />
<br />
<br />[1] they glitch or don't show graphics if I use your code and I give them irq_alt_behavior = 0, while they are perfect with irq_alt_behavior = 1. And the glitches seem different enough to suggest the problem is IRQ-related and not due to remaining PPU bugs in MESS...
<br />
<br />EDIT: I originally mixed up my tests and I was using the wrong game as an example of alt IRQ behavior... I fixed the post and now the examples are correct <img src="./images/smilies/icon_wink.gif" alt=";)" title="Wink" />

		

		</td>
	</tr>
	</table>


<hr width="85%" />

<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
<tr>
	<td><span class="gensmall">Page <strong>2</strong> of <strong>2</strong></span></td>
	<td align="right"><span class="gensmall">All times are UTC - 7 hours </span></td>
</tr>
<tr>
	<td colspan="2" align="center"><span class="gensmall">Powered by phpBB&reg; Forum Software &copy; phpBB Group<br />http://www.phpbb.com/</span></td>
</tr>
</table>

</body>
</html>