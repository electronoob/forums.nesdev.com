<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html dir="ltr" lang="en-gb">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta http-equiv="Content-Style-Type" content="text/css">
<meta http-equiv="Content-Language" content="en-gb">
<title>nesdev.com :: View topic - Test ROM for TNROM/TQROM (MMC3) with 32KB CHR-RAM</title>

<style type="text/css">
<!--

body {
	font-family: Verdana,serif;
	font-size: 10pt;
}

img {
	border: 0;
}

td {
	font-family: Verdana,serif;
	font-size: 10pt;
	line-height: 150%;
}

.code, .codecontent, 
.quote, .quotecontent {
	margin: 0 5px 0 5px;
	padding: 5px;
	font-size: smaller;
	border: black solid 1px;
}

.quotetitle {
	color: black;
	display : block;
	font-weight: bold;
}

.forum {
	font-family: Arial,Helvetica,sans-serif;
	font-weight: bold;
	font-size: 18pt;
}

.topic {
	font-family: Arial,Helvetica,sans-serif;
	font-size: 14pt;
	font-weight: bold;
}

.gensmall {
	font-size: 8pt;
}

hr {
	color: #888;
	height: 3px;
	border-style: solid;
}

hr.sep {
	color: #aaa;
	height: 1px;
	border-style: dashed;
}
//-->
</style>

</head>
<body>

<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
<tr>
	<td colspan="2" align="center"><span class="Forum">nesdev.com</span><br /><span class="gensmall"><a href="http://forums.nesdev.com/">http://forums.nesdev.com/</a></span></td>
</tr>
<tr>
	<td colspan="2"><br /></td>
</tr>
<tr>
	<td><span class="topic">Test ROM for TNROM/TQROM (MMC3) with 32KB CHR-RAM</span><br /><span class="gensmall"><a href="http://forums.nesdev.com/viewtopic.php?f=3&amp;t=9465">http://forums.nesdev.com/viewtopic.php?f=3&amp;t=9465</a></span></td>
	<td align="right" valign="bottom"><span class="gensmall">Page <strong>1</strong> of <strong>2</strong></span></td>
</tr>
</table>



	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>qbradq</b> [ Tue Nov 06, 2012 9:10 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Test ROM for TNROM/TQROM (MMC3) with 32KB CHR-RAM</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />In case anyone cares, I've created a test ROM for TNROM or TGROM boards that have been retrofitted with 32KB of CHR-RAM and rerouted to allow all 32KBs to be bank-selected. This configuration is also possible with the development boards that Infinite NES Lives is planning to release soon, and I intend to use in a homebrew project.<br /><br />Currently the latest SVN version of Nintendulator's mapper pack supports this.<br /><br />Note that an iNES 2.0 header must be used for the ROM to describe this configuration.<br /><br /><a href="https://sites.google.com/site/qbradq/projects-1/tnrom32test" class="postlink">Link to Project Page</a>

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>miker00lz</b> [ Thu Nov 08, 2012 2:56 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: Test ROM for TNROM/TQROM (MMC3) with 32KB CHR-RAM</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Cool! Good stuff. It seems to work fine in MoarNES.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>thefox</b> [ Sat Nov 17, 2012 5:34 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: Test ROM for TNROM/TQROM (MMC3) with 32KB CHR-RAM</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Here's an another test for &gt;8KB CHR-RAM with iNES2 (I modified my image converter to use CHR-RAM):<br /><br /><!-- m --><a class="postlink" href="http://thefox.aspekt.fi/ines2-chr-ram-test.zip">http://thefox.aspekt.fi/ines2-chr-ram-test.zip</a><!-- m -->

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>byemu</b> [ Tue Apr 02, 2013 7:37 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: Test ROM for TNROM/TQROM (MMC3) with 32KB CHR-RAM</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">thefox wrote:</div><div class="quotecontent">Here's an another test for &gt;8KB CHR-RAM with iNES2 (I modified my image converter to use CHR-RAM):<br /><br /><!-- m --><a class="postlink" href="http://thefox.aspekt.fi/ines2-chr-ram-test.zip">http://thefox.aspekt.fi/ines2-chr-ram-test.zip</a><!-- m --></div><br /><br />Are you release the sourcecode?

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>thefox</b> [ Wed Apr 03, 2013 1:22 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: Test ROM for TNROM/TQROM (MMC3) with 32KB CHR-RAM</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">byemu wrote:</div><div class="quotecontent"><div class="quotetitle">thefox wrote:</div><div class="quotecontent">Here's an another test for &gt;8KB CHR-RAM with iNES2 (I modified my image converter to use CHR-RAM):<br /><br /><!-- m --><a class="postlink" href="http://thefox.aspekt.fi/ines2-chr-ram-test.zip">http://thefox.aspekt.fi/ines2-chr-ram-test.zip</a><!-- m --></div><br /><br />Are you release the sourcecode?</div><br />No.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>infiniteneslives</b> [ Sat Jul 27, 2013 9:29 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: Test ROM for TNROM/TQROM (MMC3) with 32KB CHR-RAM</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Finally getting around to testing this out on my boards. <img src="./images/smilies/icon_wink.gif" alt=";)" title="Wink" />  Trying to figure out if I'm getting the right output just to be sure of things here.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent"> If the emulator works correctly, you should see eight different images. Otherwise you'll only see two.</div><br />8 images?  I'm only seeing something like 4.  A boy, a girl, and some verbage inbetween the two.  I'm guessing that's right though since emus show me the boy and cut up verbage and that's it.  Correct?<br /><br /><br />thefox,<br /><br />I tested yours out too, I'm wondering if you might not be waiting long enough before writing to the PPU?  The image only loads up after reset for me (broke at power on) and when it's running there is some glitching.  It looks better than an improperly configured emu though as I can actually see a single woman.<br /><br />EDIT:  I can provide images/video of any of the above upon request.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>thefox</b> [ Sat Jul 27, 2013 11:50 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: Test ROM for TNROM/TQROM (MMC3) with 32KB CHR-RAM</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">infiniteneslives wrote:</div><div class="quotecontent">I tested yours out too, I'm wondering if you might not be waiting long enough before writing to the PPU?  The image only loads up after reset for me (broke at power on) and when it's running there is some glitching.  It looks better than an improperly configured emu though as I can actually see a single woman.<br /><br />EDIT:  I can provide images/video of any of the above upon request.</div><br />If you're talking about the 2 required PPU vblank waits, those should be there. As I remember it, the code should be the same as in my other CHR-ROM-based image conversions (except for the fact that these ones upload the tiles to CHR-RAM)... Of course it's possible that a bug or two crept in.<br /><br />BTW it requires 64KB of CHR-RAM, maybe that's part of the problem?

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>infiniteneslives</b> [ Sat Jul 27, 2013 11:56 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: Test ROM for TNROM/TQROM (MMC3) with 32KB CHR-RAM</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">thefox wrote:</div><div class="quotecontent"><br />BTW it requires 64KB of CHR-RAM, maybe that's part of the problem?</div><br /><br />Ahh...  Didn't pay that much attention, that would probably help. <img src="./images/smilies/icon_wink.gif" alt=";)" title="Wink" />  Although I've found 3 vblank waits to be better practice depending how you count them.  $2002 is unknown at startup so you have to toss out the 'first' one and then wait for two frames.  Some would count that as 3 vblanks.  Since I get nothing on power up and glitching on reset I'm guessing something like that might be going on too.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>tokumaru</b> [ Sun Jul 28, 2013 12:11 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: Test ROM for TNROM/TQROM (MMC3) with 32KB CHR-RAM</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">infiniteneslives wrote:</div><div class="quotecontent">$2002 is unknown at startup so you have to toss out the 'first' one and then wait for two frames.</div><br />Most people read $2002 (and throw out the result) before the 2 wait loops. I wouldn't say that counts as waiting 3 frames, since the first $2002 read isn't doing any waiting... =) I too in the past have waited more than 2 frames just to be sure, but I guess that 2 frames already provide more than enough breathing room, since last time I checked the PPU needed only 1 frame or so to become stable.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>infiniteneslives</b> [ Sun Jul 28, 2013 12:48 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: Test ROM for TNROM/TQROM (MMC3) with 32KB CHR-RAM</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">tokumaru wrote:</div><div class="quotecontent">last time I checked the PPU needed only 1 frame or so to become stable.</div><br /><br />Maybe my PPU is just slow and cranky, but 1 frame is certainly not enough for <a href="http://forums.nesdev.com/viewtopic.php?f=10&amp;t=8889" class="postlink">me</a>.  I'd say around half the homebrew roms I test out on my NES suffer from this issue...  Powerpak hides this issue.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>tokumaru</b> [ Sun Jul 28, 2013 1:37 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: Test ROM for TNROM/TQROM (MMC3) with 32KB CHR-RAM</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">infiniteneslives wrote:</div><div class="quotecontent">Maybe my PPU is just slow and cranky, but 1 frame is certainly not enough for <a href="http://forums.nesdev.com/viewtopic.php?f=10&amp;t=8889" class="postlink">me</a>.</div><br />I based my comment on <a href="http://forums.nesdev.com/viewtopic.php?f=9&amp;t=9440&amp;hilit=ppu+cycles#p101898" class="postlink">quietust's post about the visual 2C02</a> and <a href="http://wiki.nesdev.com/w/index.php/PPU_power_up_state" class="postlink">this wiki page</a> (both say the PPU needs about 1 frame to start functioning properly). I imagine that waiting a single frame in software might be too tight and might cause problems in some cases, which is precisely why 2 frames appears to be perfectly safe. I'm not suggesting that anyone waits less than 2 frames, but more than that shouldn't be necessary either.<br /><br />Also, the code you linked to isn't properly waiting 1 frame, as the VBlank flag could be set right on the first read and there'd be no waiting at all... the correct way to wait for *at least* 1 frame is this:<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">&nbsp; &nbsp;bit $2002 ;make sure the flag is clear before waiting<br />-&nbsp; &nbsp;bit $2002<br />&nbsp; &nbsp;bpl -</div><br />But like I said, I wouldn't recommend waiting only 1 frame even if it works (I haven't personally tried!), 2 frames is safer.<br /><br />EDIT: If you look at that wiki page, it's clear why waiting only 1 frame isn't enough: it seems that the Vblank flag is usually clear on power up (apparently there are exceptions), and gets set around cycle 27384, while the PPU is not fully functional until cycle 29658.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>thefox</b> [ Sun Jul 28, 2013 3:06 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: Test ROM for TNROM/TQROM (MMC3) with 32KB CHR-RAM</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">infiniteneslives wrote:</div><div class="quotecontent"><div class="quotetitle">thefox wrote:</div><div class="quotecontent"><br />BTW it requires 64KB of CHR-RAM, maybe that's part of the problem?</div><br /><br />Ahh...  Didn't pay that much attention, that would probably help. <img src="./images/smilies/icon_wink.gif" alt=";)" title="Wink" />  Although I've found 3 vblank waits to be better practice depending how you count them.  $2002 is unknown at startup so you have to toss out the 'first' one and then wait for two frames.  Some would count that as 3 vblanks.  Since I get nothing on power up and glitching on reset I'm guessing something like that might be going on too.</div><br />I noticed the code (probably copy&amp;pasted somewhere...) doesn't make sure the flag is cleared before the wait loops, so try this one with 3 wait loops if it makes a difference for the power-on behaviour: <!-- m --><a class="postlink" href="http://thefox.aspekt.fi/ines2-chr-ram-test-3-vbl-waits.nes">http://thefox.aspekt.fi/ines2-chr-ram-t ... -waits.nes</a><!-- m -->

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>ulfalizer</b> [ Sun Jul 28, 2013 3:13 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: Test ROM for TNROM/TQROM (MMC3) with 32KB CHR-RAM</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />The only &quot;digital&quot; thing that necessitates waiting is that there's an internal reset signal active before the point where the VBlank, sprite zero, and overflow flags are cleared (it's driven from a reg that's cleared by the same signal as those) - see <!-- m --><a class="postlink" href="http://wiki.nesdev.com/w/index.php/PPU_power_up_state">http://wiki.nesdev.com/w/index.php/PPU_power_up_state</a><!-- m --> . If additional waiting is needed, then that would have to come down to analog effects I think. Seems weird that it would take that long to settle though...<br /><br />I print a warning in my emu when regs are written during the reset period. You see lots of commercial games doing it (though they still work), so I suspect it wasn't widely known how it worked even back then. Emulating the write suppression does break some demos though (like the NY2011 one, which will still work on powerpak though since it starts running after the first frame there).

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>thefox</b> [ Sun Jul 28, 2013 4:00 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: Test ROM for TNROM/TQROM (MMC3) with 32KB CHR-RAM</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">ulfalizer wrote:</div><div class="quotecontent">I print a warning in my emu when regs are written during the reset period. You see lots of commercial games doing it (though they still work), so I suspect it wasn't widely known how it worked even back then.</div><br />I guess the reason you're seeing it in commercial games is that they are zeroing out $2000 and $2001 in their init code, which seemed to be the &quot;standard&quot; thing to do, regardless of whether it had any effect or not.<br /><br />Also remember that on Famicom the reset switch isn't connected to the PPU, so there these writes are significant!<br /><br />Out of curiosity, I checked couple of first-party games to see how they do their initialization:<br /><br />- Duck Hunt waits for vblank once, then zeroes $2000 and $2001<br />- Excitebike first zeroes out $2000, then waits for vblank twice<br />- Pinball waits for vblank once, then zeroes $2000 and $2001<br />- Soccer zeroes out $2000 and $2001, then waits for vblank once<br />- SMB writes $10 to $2000, then waits for vblank twice<br />- SMB3 zeroes $2001, writes $08 to $2000, then waits for vblank twice

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>ulfalizer</b> [ Sun Jul 28, 2013 5:20 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: Test ROM for TNROM/TQROM (MMC3) with 32KB CHR-RAM</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">thefox wrote:</div><div class="quotecontent">Also remember that on Famicom the reset switch isn't connected to the PPU, so there these writes are significant!</div><br /><br />Ah, yeah, had forgotten about that.

		

		</td>
	</tr>
	</table>


<hr width="85%" />

<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
<tr>
	<td><span class="gensmall">Page <strong>1</strong> of <strong>2</strong></span></td>
	<td align="right"><span class="gensmall">All times are UTC - 7 hours </span></td>
</tr>
<tr>
	<td colspan="2" align="center"><span class="gensmall">Powered by phpBB&reg; Forum Software &copy; phpBB Group<br />http://www.phpbb.com/</span></td>
</tr>
</table>

</body>
</html>