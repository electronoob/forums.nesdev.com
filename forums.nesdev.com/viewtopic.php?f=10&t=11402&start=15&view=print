<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html dir="ltr" lang="en-gb">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta http-equiv="Content-Style-Type" content="text/css">
<meta http-equiv="Content-Language" content="en-gb">
<title>nesdev.com :: View topic - ASM6 and trouble with nametables...</title>

<style type="text/css">
<!--

body {
	font-family: Verdana,serif;
	font-size: 10pt;
}

img {
	border: 0;
}

td {
	font-family: Verdana,serif;
	font-size: 10pt;
	line-height: 150%;
}

.code, .codecontent, 
.quote, .quotecontent {
	margin: 0 5px 0 5px;
	padding: 5px;
	font-size: smaller;
	border: black solid 1px;
}

.quotetitle {
	color: black;
	display : block;
	font-weight: bold;
}

.forum {
	font-family: Arial,Helvetica,sans-serif;
	font-weight: bold;
	font-size: 18pt;
}

.topic {
	font-family: Arial,Helvetica,sans-serif;
	font-size: 14pt;
	font-weight: bold;
}

.gensmall {
	font-size: 8pt;
}

hr {
	color: #888;
	height: 3px;
	border-style: solid;
}

hr.sep {
	color: #aaa;
	height: 1px;
	border-style: dashed;
}
//-->
</style>

</head>
<body>

<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
<tr>
	<td colspan="2" align="center"><span class="Forum">nesdev.com</span><br /><span class="gensmall"><a href="http://forums.nesdev.com/">http://forums.nesdev.com/</a></span></td>
</tr>
<tr>
	<td colspan="2"><br /></td>
</tr>
<tr>
	<td><span class="topic">ASM6 and trouble with nametables...</span><br /><span class="gensmall"><a href="http://forums.nesdev.com/viewtopic.php?f=10&amp;t=11402">http://forums.nesdev.com/viewtopic.php?f=10&amp;t=11402</a></span></td>
	<td align="right" valign="bottom"><span class="gensmall">Page <strong>2</strong> of <strong>3</strong></span></td>
</tr>
</table>



	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>JoeGtake2</b> [ Mon Jul 07, 2014 8:29 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: ASM6 and trouble with nametables...</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />The Fox - yup.  I landed on that one...thanks for the suggestion.  I managed to figure that out through trial and error.  <br /><br />Also, Memblers and Tokumaru - the solution was in a combination of what you two said.  I WAS doing the write to the PPU register correct to read from $1000, but that was never being seen because the NMI was never being reached!  I did a shadow register variable (though I'm sure I did it 'wrong'...even still it was enough for me to find the issue in the logic).  I did this early in the code (which is redundant, I know)...<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">&nbsp; &nbsp;<br />&nbsp; &nbsp;LDA #%10010000<br />&nbsp; &nbsp;STA v2000<br />&nbsp; &nbsp;STA $2000<br /></div><br /><br />Which ENABLED the NMI, and then made sure to write that value in the NMI as well.  And voila - everything looked the way that i expected it to. <br /><br />MAN that was a long day to do something so small!  Haha.  I feel like I've learned quite a bit of some of those quirky things that logic wouldn't dictate, though, so it's been worth it.<br /><br />Do me a favor - if you get the chance could one of you go into a little more detail (maybe with a simple code example) of how you use the shadow register for $2000 and $2001?  I get the general concept, but my brain is fried on this right now.<br /><br />You all rock, thanks so much for helping and pointing me in the right direction(s)!

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>rainwarrior</b> [ Mon Jul 07, 2014 10:18 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: ASM6 and trouble with nametables...</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />One of the reasons I wrote <a href="http://forums.nesdev.com/viewtopic.php?f=10&amp;t=11151" class="postlink">this example</a> was to demonstrate proper use of the PPU. It might be helpful. There are a lot of quirky issues to do with how to time turning the renderer on and off, and the steps to take when doing it, etc. It took me about two years of working with the NES to come to a point where I could write NES render code that doesn't have any strange 1-frame glitches somewhere.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>tokumaru</b> [ Mon Jul 07, 2014 11:10 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: ASM6 and trouble with nametables...</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">JoeGtake2 wrote:</div><div class="quotecontent">could one of you go into a little more detail (maybe with a simple code example) of how you use the shadow register for $2000 and $2001?</div><br />The shadow registers are just buffers... They aren't absolutely necessary, and should be the least of your problems for now. The only real advantage of buffering $2000/$2001 writes is that, since you're saving new $2000/$2001 values to RAM and only copying the values to the actual registers during VBlank, you don't get weird visual changes mid-screen, like a quick &quot;shake&quot; when rendering is turned on. All changes will happen during VBlank and will be invisible to the player. There's really no reason for you to worry about this now, since those small glitches are really quick and not permanent... once you have a better knowledge of the flow of an NES program, this will come naturally to you.<br /><br />The problem you faced was that you tried to buffer the very write that enables NMIs, which prevented NMIs from ever happening, so the shadow registers were never copied to the actual registers. The $2000 write that enables NMIs shouldn't be buffered (but you should do this write during VBlank). I believe most programs don't constantly enable and disable NMIs, in most cases NMIs are turned on from the very beginning, and a variable, which is checked by the NMI handler, is used to indicate what kind of task it's supposed to perform, if any.<br /><br />In my programs, I enable NMIs right after waiting the 2 PPU warm up frames, while I know the PPU is still in VBlank. The variable that controls what tasks will be done in the NMI should already be initialized by this time, as should the shadow registers if you are indeed copying them to the real registers in the NMI handler.<br /><br />EDIT: I just remembered that SMB1 is one game that keeps enabling/disabling NMIs, and this results in <a href="http://forums.nesdev.com/viewtopic.php?f=2&amp;t=10104" class="postlink">visual glitches</a> from time to time.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>JoeGtake2</b> [ Tue Jul 08, 2014 4:47 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: ASM6 and trouble with nametables...</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Wow - Rainwarrior, that example has a ton of great stuff in it!  Thanks so much for that, I'm really going to dissect it.  Most of it makes perfect sense to me as I read it sort of casually...which is good!  Haha.<br /><br />Tokumaru, thanks for clarifying.<br /><br />All in all, this problem is officially <span style="text-decoration: underline"><strong>solved </strong></span>thanks to your guys' help.  More importantly, I have some more foundational knowledge which I didn't have before and some more things to directly study!  Much appreciated.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>rainwarrior</b> [ Tue Jul 08, 2014 6:38 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: ASM6 and trouble with nametables...</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />In the project I'm working on, I set up the first screen, and then I enable NMI and never need to turn it off. Between screen transitions, I turn off rendering, but the NMI routine continues playing music, for example. As long as the NMI routine itself can be prevented from messing with $2005/2006/2007 while rendering is off, it's perfectly valid to have it running while you're updating the hidden screen.<br /><br />Another thing: it's good practice to only ever upload palette data in the NMI handler. If done at other times, the writes to the palette will manifest visually as a change of background colour and you'll get a scanline or two of &quot;rainbow&quot; glitch. I found this very counter-intuitive, but it's sort of because the background colour is still active when rendering is off. Pointing the PPU address at any of the palette bytes will cause it to display the colour at that address, for some reason.<br /><br />Similarly, but for a different reason, don't use the OAM DMA outside of the NMI routine either. Most emulators don't simulate this, but when sprite rendering is off the data in the OAM begins to decay after a short time (30 scanlines or so), so there's not much point to update the OAM while rendering is off, as the data would likely be corrupt by the time you get rendering back on.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>JoeGtake2</b> [ Tue Jul 08, 2014 6:59 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: ASM6 and trouble with nametables...</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Thanks Rainwarrior - later today, I'm going to attempt to iterate through a basic file structure and try to build it from scratch and referencing your link as little as possible.  If I have pressing questions while I do, would you mind if I PM you?  I appreciate the help and the lengthy explanation.  You're the third person on this forum to be simply awesome about that!  100% of people helping, 0% of people impatiently trolling.  I can't stress enough how amazing I find that.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>rainwarrior</b> [ Tue Jul 08, 2014 9:03 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: ASM6 and trouble with nametables...</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Sure, PM me if you'd like, no need to ask. It's usually better to ask questions in the open, though. You'll get better answers if more people see the question, and also other people with the same problem may come by to read this thread.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>tepples</b> [ Tue Jul 08, 2014 10:27 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: ASM6 and trouble with nametables...</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />That and if you post in public, then anyone else can use Google or Bing to search for the question and end up here, where (as you've noticed) we don't bite newcomers.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Kasumi</b> [ Tue Jul 08, 2014 12:48 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: ASM6 and trouble with nametables...</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">rainwarrior wrote:</div><div class="quotecontent">It's usually better to ask questions in the open, though. You'll get better answers if more people see the question, and also other people with the same problem may come by to read this thread.</div><br />This. Also because if the person you PM doesn't know the answer, you're out of luck until you get another set of eyes on the problem anyway.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>JoeGtake2</b> [ Tue Jul 08, 2014 2:42 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: ASM6 and trouble with nametables...</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Gotcha - will absolutely do that, then!  <br /><br />So last night, we fixed the issue I was having.  Today, I completely rewrote my code (to better align with what I'm understanding of a good file structure, and commenting things out to better help me understand what is happening).<br /><br /><span style="text-decoration: underline"><strong>Rainwarrior</strong></span>, you suggested putting palette updates in the NMI, and I noticed that your example file also put nametable updates in the NMI.  I thought I would also try this.  I got funky results, for sure.  If I put the nametable update in the NMI, everything is off as far as the scroll, however I HAVE to reset the scroll data in the NMI for it to not be wonky (explained in the code).<br /><br />Anyhow, this code works as it is.  Hoorah.  Before moving forward, I wanted you guys to take a glance and see if the file structure looks alright or if I'm heading for a cliff anywhere, and also help me figure out why the scroll data must be in the NMI like this for it to work correctly.  <br /><br />I feel like this post alone has taught me a lot, and hopefully it shows in this updated code / is evident in the comments.<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">;;AN ATTEMPT TO DEVELOP A GOOD FILE STRUCTURE <br />;;TO BE ASSEMBLED WITH ASM6.<br /><br />;; ======1. HEADER - taken care of in header file<br /><br />;; ======2. Establish variables and constants.<br />&nbsp; &nbsp;.enum $0000&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;; variabl section must open with this on ASM6<br />&nbsp; &nbsp;addrLo .dsb 1<br />&nbsp; &nbsp;addrHi .dsb 2<br />&nbsp; &nbsp;.ende&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;; variable section must close with this on ASM6<br />;; ======3. Where should the code start?<br />&nbsp; &nbsp;.org $c000<br /><br />;; ======4. RESET<br /><br />RESET:<br />&nbsp; &nbsp;SEI&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;; Ignore Interupts<br />&nbsp; &nbsp;LDA #$00&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;; Load zero.<br />&nbsp; &nbsp;STX $2000&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;; Store it to $2000 (PPU - graphics) - disable NMI<br />&nbsp; &nbsp;STX $2001&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;; Store it to $2001 (PPU - graphics) - disable rendering<br />&nbsp; &nbsp;STX $4010&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;; Store it to $4010 (DMC IRQ) - disable DMC IRQ<br />&nbsp; &nbsp;STX $4015&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;; Store it to $4015 (APU) - disable APU sound<br />&nbsp; &nbsp;LDA #$40&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;; Load 64<br />&nbsp; &nbsp;STA $4017&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;; Store it to $4017 - disables APU IRQ<br />&nbsp; &nbsp;CLD&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;; disable decimal mode<br />&nbsp; &nbsp;LDX #$FF&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;; Load 255<br />&nbsp; &nbsp;TXS&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;; Initialize the stack<br />&nbsp; &nbsp;<br />;; ======5. First vblank wait<br />&nbsp; &nbsp;bit $2002<br />vbwait1:&nbsp; &nbsp;<br />&nbsp; &nbsp;bit $2002<br />&nbsp; &nbsp;BPL vbwait1<br />&nbsp; &nbsp;<br />;; =====6. Clear all ram except stack ($100)<br />&nbsp; &nbsp;LDA #$00&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;; Load zero to A<br />&nbsp; &nbsp;LDX #$00&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;; Load zero to X<br />clrMem:<br />&nbsp; &nbsp;STA $0000,x<br />&nbsp; &nbsp;STA $0200,x<br />&nbsp; &nbsp;STA $0300,x<br />&nbsp; &nbsp;STA $0400,x<br />&nbsp; &nbsp;STA $0500,x<br />&nbsp; &nbsp;STA $0600,x<br />&nbsp; &nbsp;STA $0700,x&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;; if you want to clear on reset<br />&nbsp; &nbsp;INX<br />&nbsp; &nbsp;BNE clrMem<br />&nbsp; &nbsp;<br />;; =====7. Second vblank wait<br />vbwait2:<br />&nbsp; &nbsp;bit $2002<br />&nbsp; &nbsp;BPL vbwait2<br />&nbsp; &nbsp;<br />;; =====8. Enable NMI for graphics updates<br />&nbsp; &nbsp;LDA #%10010000&nbsp; &nbsp;&nbsp; &nbsp;; turn on NMI, set sprites to $0000/bkg to $1000<br />&nbsp; &nbsp;STA $2000&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;; write it to $2000<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;; load palette data<br />&nbsp; &nbsp;<br /><br />;; =====9. Load background/ nametable<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;;; load background<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;;; this does not work<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;;; inside NMI.&nbsp; Find out why(?)<br />&nbsp; &nbsp;LDA #$00<br />&nbsp; &nbsp;STA $2001<br />&nbsp; &nbsp;LDA $2002<br />&nbsp; &nbsp;LDA #$20<br />&nbsp; &nbsp;STA $2006<br />&nbsp; &nbsp;LDA #$00<br />&nbsp; &nbsp;STA $2006<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;;; load nametable<br />&nbsp; &nbsp;LDA #&lt;nametable0<br />&nbsp; &nbsp;STA addrLo<br />&nbsp; &nbsp;LDA #&gt;nametable0<br />&nbsp; &nbsp;STA addrHi<br />&nbsp; &nbsp;jsr LoadBkg&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;;; jump to LoadBkg, return below<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;;;IF I RESET SCROLL DATA HERE<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;;;SCROLL IS WRONG!<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;;; Only if I put the Scroll data<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;;;in NMI does it work.<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;;; End of Background code that does<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;;; not work in NMI.<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;<br /><br />&nbsp; &nbsp;JMP main<br />&nbsp; &nbsp;<br />;; =====10. Set up NMI - much to do with this section.<br />NMI:<br />&nbsp; &nbsp;PHA&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;; push accumulator values to the stack.<br />&nbsp; &nbsp;TXA<br />&nbsp; &nbsp;PHA<br />&nbsp; &nbsp;TYA<br />&nbsp; &nbsp;PHA<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;; set up PPU<br />&nbsp; &nbsp;LDA #%10010000<br />&nbsp; &nbsp;STA $2000<br />&nbsp; &nbsp;LDA #%00011110<br />&nbsp; &nbsp;STA $2001<br /><br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;;; set oal dma (?) - look into this<br />&nbsp; &nbsp;LDA #$00<br />&nbsp; &nbsp;STA $2003<br />&nbsp; &nbsp;LDA #$02<br />&nbsp; &nbsp;STA $4014<br /><br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;;; load palettes<br />&nbsp; &nbsp;LDA $2002<br />&nbsp; &nbsp;LDA #$3F<br />&nbsp; &nbsp;STA $2006<br />&nbsp; &nbsp;LDA #$00<br />&nbsp; &nbsp;STA $2006<br />&nbsp; &nbsp;LDX #$00<br />LoadPal:<br />&nbsp; &nbsp;LDA PaletteData,x<br />&nbsp; &nbsp;STA $2007<br />&nbsp; &nbsp;INX<br />&nbsp; &nbsp;CPX #$20<br />&nbsp; &nbsp;BNE LoadPal<br />&nbsp; &nbsp;<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;;;SCROLL DATA ONLY SEEMS TO GIVE<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;;;PREDICTABLE OUTCOME IF PUT<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;;;HERE.&nbsp; PUTTING IT AFTER THE<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;;;RETURN FROM LoadBkg SUB ROUTINE<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;;;ABOVE gives strange results,<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;;;as does making it the end of<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;;;the sub routine...<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;;;but putting the nametable stuff<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;;;here gives wonky results as well...<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;<br />&nbsp; &nbsp;LDA $2000<br />&nbsp; &nbsp;LDA #$00&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;;; load zero to accumulator<br />&nbsp; &nbsp;STA $2006&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;;;<br />&nbsp; &nbsp;STA $2006<br />&nbsp; &nbsp;STA $2005&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;;reset scroll<br />&nbsp; &nbsp;STA $2005&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;;reset scroll<br /><br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;; re-pull accumulator values from the stack.<br />&nbsp; &nbsp;PLA<br />&nbsp; &nbsp;TAY<br />&nbsp; &nbsp;PLA<br />&nbsp; &nbsp;TAX<br />&nbsp; &nbsp;PLA<br />&nbsp; &nbsp;<br />&nbsp; &nbsp;RTI&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;; Return from whence you came.<br /><br />;; ===== 11. Main Loop&nbsp; &nbsp;<br />main:<br />&nbsp; &nbsp;<br />&nbsp; &nbsp;JMP main<br /><br />;; ===== 12. Sub routines<br />&nbsp; &nbsp;<br />LoadBkg:<br />&nbsp; &nbsp;LDX #$04<br />&nbsp; &nbsp;LDY #$00<br />&nbsp; &nbsp;<br />LoadNametableLoop:<br />&nbsp; &nbsp;LDA #$00<br />&nbsp; &nbsp;STA $2001<br />&nbsp; &nbsp;LDA (addrLo),y<br />&nbsp; &nbsp;STA $2007<br />&nbsp; &nbsp;INY<br />&nbsp; &nbsp;BNE LoadNametableLoop<br />&nbsp; &nbsp;inc addrHi<br />&nbsp; &nbsp;DEX<br />&nbsp; &nbsp;BNE LoadNametableLoop<br />&nbsp; &nbsp;LDA #$00<br />&nbsp; &nbsp;STA $2005<br />&nbsp; &nbsp;LDA #%00011110<br />&nbsp; &nbsp;STA $2001<br />&nbsp; &nbsp;<br />&nbsp; &nbsp;RTS&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;;return to setting up nametables.<br />&nbsp; &nbsp;<br />;; ===== 13. Load binaries<br />PaletteData: <br />&nbsp; &nbsp;.incbin &quot;charPal.pal&quot;<br />&nbsp; &nbsp;.incbin &quot;bkgPal.pal&quot;<br />&nbsp; &nbsp;<br />nametable0: <br />&nbsp; &nbsp;.incbin &quot;mainBkg.nam&quot;<br />&nbsp; &nbsp;<br />;; ===== 14. Vectors<br />&nbsp; &nbsp;.org $fffa<br />&nbsp; &nbsp;.dw NMI<br />&nbsp; &nbsp;.dw RESET<br />&nbsp; &nbsp;.dw 0<br />&nbsp; &nbsp;<br />;; ===== 15. load Chr<br />&nbsp; &nbsp;.incbin &quot;main.chr&quot;<br />&nbsp; &nbsp;<br /></div>

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>rainwarrior</b> [ Tue Jul 08, 2014 4:21 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: ASM6 and trouble with nametables...</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Whenever you write to $2006 or $2007, you overwrite whatever is currently in the scroll registers, because $2005 and $2006 are accessing the same internal registers, just in different ways.<br /><br />This is why you must reset scroll (write $2000, $2005, $2005) after you are finished making any updates via $2007.<br /><br />It is not necessary to write 0 to both $2006 and $2005. This is redundant, as the writes go to the same place.<br /><br />See my example at &quot;@scroll:&quot; and note that this step that sets the scroll registers is always done after all the other PPU updates. It is critical that it happen after other PPU updates (i.e. $2006/2007 writes) and before the end of vblank, where the hardware will pick up the last scroll values written.<br /><br />If you want to know a lot more about it, there is detail here: <a href="http://wiki.nesdev.com/w/index.php/The_skinny_on_NES_scrolling" class="postlink">http://wiki.nesdev.com/w/index.php/The_skinny_on_NES_scrolling</a>

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Kasumi</b> [ Tue Jul 08, 2014 4:34 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: ASM6 and trouble with nametables...</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Be careful.<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">RESET:<br />&nbsp; &nbsp;SEI&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;; Ignore Interupts<br />&nbsp; &nbsp;LDA #$00&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;; Load zero.<br />&nbsp; &nbsp;STX $2000&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;; Store it to $2000 (PPU - graphics) - disable NMI<br />&nbsp; &nbsp;STX $2001&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;; Store it to $2001 (PPU - graphics) - disable rendering<br />&nbsp; &nbsp;STX $4010&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;; Store it to $4010 (DMC IRQ) - disable DMC IRQ<br />&nbsp; &nbsp;STX $4015&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;; Store it to $4015 (APU) - disable APU sound<br /></div><br />You're storing X which has an undefined value at this point. Replace those STXs with STA so you're storing zero and not whatever was in X before you reset the game.<br /><br />Don't mess with the scroll ($2005) outside of the NMI until you really know what you're doing.<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">BNE LoadNametableLoop<br />&nbsp; &nbsp;LDA #$00<br />&nbsp; &nbsp;STA $2005<br />&nbsp; &nbsp;LDA #%00011110<br />&nbsp; &nbsp;STA $2001<br /></div><br /><br />What's more $2005 (and $2006) are double-write registers. Typically if you stored the same value to the same location  (like... say RAM) twice in a row, it wouldn't be different than doing it once. This is not true for double write registers, where writing to them twice in a row will make the same value do different things. There's no real way to know which write will affect which thing unless you reset them, which you do by reading $2002.<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">lda #$00<br />sta $2005;This will affect either the X or Y scroll value.<br />lda #$20<br />sta $2005;This will affect which scroll value that the previous write DIDN'T. (If the first write changed X, this would change Y. If the first write changed Y, this would change X.)<br /></div><br /><br />So with the above code alone, you might end up with an X scroll value of $00 and a Y scroll value of $20, or you might end up with an X scroll value of $20 and a Y scroll value of $00. To avoid this Schrodinger's code, read $2002 first and always write to $2006/$2005 twice.<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">bit $2002;(This reads from $2002 without changing A. If you don't care if A is changed, LDA will work too)<br />lda #$00<br />sta $2005;This will set the X scroll to $00.<br />lda #$20<br />sta $2005;This will set the Y scroll to $20<br /></div><br /><br />You are doing this properly with your $2006 code in your NMI:<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">LDA $2002<br />&nbsp; &nbsp;LDA #$3F<br />&nbsp; &nbsp;STA $2006<br />&nbsp; &nbsp;LDA #$00<br />&nbsp; &nbsp;STA $2006<br /></div><br />You read $2002 which makes sure the first write will set the high byte of the address. Another interesting thing is that $2005 and $2006 share the same &quot;toggle&quot;. So if after the above code, you wrote a value to $2005, it would reliably write the X scroll. You would not need to read $2002 again to ensure this.<br /><br />Therefore, this would be fine:<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">&nbsp; &nbsp;LDA $2002<br />&nbsp; &nbsp;LDA #$3F<br />&nbsp; &nbsp;STA $2006<br />&nbsp; &nbsp;LDA #$00<br />&nbsp; &nbsp;STA $2006<br />&nbsp; &nbsp;LDX #$00<br />LoadPal:<br />&nbsp; &nbsp;LDA PaletteData,x<br />&nbsp; &nbsp;STA $2007<br />&nbsp; &nbsp;INX<br />&nbsp; &nbsp;CPX #$20<br />&nbsp; &nbsp;BNE LoadPal<br />&nbsp; &nbsp;<br /><br />&nbsp; &nbsp;lda (whatevervalue you need for $2000)<br />&nbsp; &nbsp;sta $2000<br />&nbsp; &nbsp;lda #$00 <br />&nbsp; &nbsp;STA $2005&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;;X scroll is zero<br />&nbsp; &nbsp;STA $2005&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;;Y scroll is zero<br /></div><br />As stated by rainwarrior, $2005/$2000 need to be rewritten after any writes to $2006/$2007 are made, and they need to be done after those writes are complete.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>JoeGtake2</b> [ Tue Jul 08, 2014 6:05 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: ASM6 and trouble with nametables...</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Thank you very much.  I have played with these ideas from the posts, but the result is exactly the same, unfortunately.<br /><br />Let me show you how I have essentially put the Nametable Load into the NMI and made the adjustments you all suggested:  The scroll is still off.  Now, all of this 'problem' is contained to the NMI - no more jump to a sub routine or anything.<br /><br />Any other thoughts?<br /><br />**NOTE: Still, with the new adjustments, if I load the nametable atthe end of the second vblank, use the subroutine, and do all the updates to $2000 and $2005 in the NMI, everything still works as expected, but when put into the NMI as shown below, there is still a strange scroll issue...**<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent"><br />NMI:<br />&nbsp; &nbsp;PHA&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;; push accumulator values to the stack.<br />&nbsp; &nbsp;TXA<br />&nbsp; &nbsp;PHA<br />&nbsp; &nbsp;TYA<br />&nbsp; &nbsp;PHA<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;; set oal dma (?) - look into this<br />&nbsp; &nbsp;LDA #$00<br />&nbsp; &nbsp;STA $2003<br />&nbsp; &nbsp;LDA #$02<br />&nbsp; &nbsp;STA $4014<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;; load palettes<br />&nbsp; &nbsp;LDA $2002<br />&nbsp; &nbsp;LDA #$3F<br />&nbsp; &nbsp;STA $2006<br />&nbsp; &nbsp;LDA #$00<br />&nbsp; &nbsp;STA $2006<br />&nbsp; &nbsp;LDX #$00<br />LoadPal:<br />&nbsp; &nbsp;LDA PaletteData,x<br />&nbsp; &nbsp;STA $2007<br />&nbsp; &nbsp;INX<br />&nbsp; &nbsp;CPX #$20<br />&nbsp; &nbsp;BNE LoadPal<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;;; end load palette - load background<br /><br />;;I HAVE ALSO TRIED PLACING A WRITE TO<br />;;$2000 and $2005 here thinking maybe<br />;;literally after every write to $2007<br />;;this would need to written to<br />;; but this did not help.<br /><br />&nbsp; &nbsp;LDA $2002<br />&nbsp; &nbsp;LDA #$20<br />&nbsp; &nbsp;STA $2006<br />&nbsp; &nbsp;LDA #$00<br />&nbsp; &nbsp;STA $2006<br />;;;;;; BOTH ABOVE AND BELOW HAVE<br />;;;;;; SAME RESULTS.<br />&nbsp; &nbsp;;LDA #$00<br />&nbsp; &nbsp;;STA $2001<br />&nbsp; &nbsp;;LDA $2002<br />&nbsp; &nbsp;;LDA #$20<br />&nbsp; &nbsp;;STA $2006<br />&nbsp; &nbsp;;LDA #$00<br />&nbsp; &nbsp;;STA $2006<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;; load nametable<br />&nbsp; &nbsp;LDA #&lt;nametable0<br />&nbsp; &nbsp;STA addrLo<br />&nbsp; &nbsp;LDA #&gt;nametable0<br />&nbsp; &nbsp;STA addrHi<br />&nbsp; &nbsp;<br />LoadBkg:<br />&nbsp; &nbsp;LDX #$04<br />&nbsp; &nbsp;LDY #$00<br />&nbsp; &nbsp;<br />LoadNametableLoop:<br />&nbsp; &nbsp;LDA #$00<br />&nbsp; &nbsp;STA $2001<br />&nbsp; &nbsp;LDA (addrLo),y<br />&nbsp; &nbsp;STA $2007<br />&nbsp; &nbsp;INY<br />&nbsp; &nbsp;BNE LoadNametableLoop<br />&nbsp; &nbsp;inc addrHi<br />&nbsp; &nbsp;DEX<br />&nbsp; &nbsp;BNE LoadNametableLoop<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;;; end load nametable<br />&nbsp; &nbsp;<br />&nbsp; &nbsp;LDA #%10010000&nbsp; &nbsp;;; after a write to $2007 like above<br />&nbsp; &nbsp;STA $2000&nbsp; &nbsp;&nbsp; &nbsp;;; must reanable &nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;<br />&nbsp; &nbsp;LDA #%00011110&nbsp; &nbsp;;;write to $2000<br />&nbsp; &nbsp;STA $2001&nbsp; &nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; <br />&nbsp; &nbsp;LDA #$00&nbsp; &nbsp;&nbsp; &nbsp;;; And set the<br />&nbsp; &nbsp;STA $2005&nbsp; &nbsp;&nbsp; &nbsp;;; x scroll data<br />&nbsp; &nbsp;STA $2005&nbsp; &nbsp;&nbsp; &nbsp;;; and y scroll data<br />&nbsp; &nbsp;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ; re-pull accumulator values from the stack.<br />&nbsp; &nbsp;PLA<br />&nbsp; &nbsp;TAY<br />&nbsp; &nbsp;PLA<br />&nbsp; &nbsp;TAX<br />&nbsp; &nbsp;PLA<br />&nbsp; &nbsp;<br />&nbsp; &nbsp;RTI&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;; Return from whence you came.<br /></div>

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Kasumi</b> [ Tue Jul 08, 2014 6:25 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: ASM6 and trouble with nametables...</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />That'd be because (unlike the code in your last post) you're trying to update the entire background in NMI. (In the code in your post before the one you're asking about, you did it below reset, before your main loop, and outside your NMI which is correct.)<br /><br />I said in a PM a while ago that you only have a very limited time to update the background after vblank happens, and if you write to $2006/$2007 after this period (and rendering is enabled), the game will crash. You seem to disable rendering before you write the backgrounds, which means it won't crash... BUT the code that updates the nametables is still taking up actual time. <br /><br />The scroll registers ($2005/$2000) need to be set before this window of time is over, or they'll only be set to the right values for the scanlines (a horizontal row of pixels) that haven't already been rendered. That is that $2005 is SAFE to write outside vblank time even when rendering is enabled, but it will only affect a portion of the screen UNLESS it is done during vblank time. (Which is why the Kirby's Adventure HUD never moves. The scroll for those scanlines is set after the rest are rendered with a different scroll value.)<br /><br />Edit: As well, writes to $2006/$2007 still affect the scroll even if done while rendering is disabled.<br /><br />There is only enough time to update about two rows and two columns of the screen in the tiny period you have between when rendering begins and your NMI. This is how games scroll without disabling rendering. They update only the new rows/columns that have been scrolled in while keeping rendering enabled. If you want to draw an entire new screen, you must disable rendering and draw it all then. You cannot do this every frame like you're trying to do without all kinds of weird stuff happening. Once the background is drawn, you only have to draw what's changed anyway, because the rest of it will stay on the PPU's memory map.<br /><br />Background updates are a tricky thing about NES dev.<br /><br />Edit: To fix it, move loadBKG back where it was. The rest of the post explains why that needs to happen.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>JoeGtake2</b> [ Tue Jul 08, 2014 6:40 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: ASM6 and trouble with nametables...</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Ah, thanks Kasumi!  In context now, that makes more sense (from previous PM).  <br /><br />I shall trudge ever forward.  Thanks all for the assistance!

		

		</td>
	</tr>
	</table>


<hr width="85%" />

<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
<tr>
	<td><span class="gensmall">Page <strong>2</strong> of <strong>3</strong></span></td>
	<td align="right"><span class="gensmall">All times are UTC - 7 hours </span></td>
</tr>
<tr>
	<td colspan="2" align="center"><span class="gensmall">Powered by phpBB&reg; Forum Software &copy; phpBB Group<br />http://www.phpbb.com/</span></td>
</tr>
</table>

</body>
</html>