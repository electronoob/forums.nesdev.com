<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html dir="ltr" lang="en-gb">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta http-equiv="Content-Style-Type" content="text/css">
<meta http-equiv="Content-Language" content="en-gb">
<title>nesdev.com :: View topic - Broken FDS emulation: Kiki Kaikai - Dotou Hen</title>

<style type="text/css">
<!--

body {
	font-family: Verdana,serif;
	font-size: 10pt;
}

img {
	border: 0;
}

td {
	font-family: Verdana,serif;
	font-size: 10pt;
	line-height: 150%;
}

.code, .codecontent, 
.quote, .quotecontent {
	margin: 0 5px 0 5px;
	padding: 5px;
	font-size: smaller;
	border: black solid 1px;
}

.quotetitle {
	color: black;
	display : block;
	font-weight: bold;
}

.forum {
	font-family: Arial,Helvetica,sans-serif;
	font-weight: bold;
	font-size: 18pt;
}

.topic {
	font-family: Arial,Helvetica,sans-serif;
	font-size: 14pt;
	font-weight: bold;
}

.gensmall {
	font-size: 8pt;
}

hr {
	color: #888;
	height: 3px;
	border-style: solid;
}

hr.sep {
	color: #aaa;
	height: 1px;
	border-style: dashed;
}
//-->
</style>

</head>
<body>

<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
<tr>
	<td colspan="2" align="center"><span class="Forum">nesdev.com</span><br /><span class="gensmall"><a href="http://forums.nesdev.com/">http://forums.nesdev.com/</a></span></td>
</tr>
<tr>
	<td colspan="2"><br /></td>
</tr>
<tr>
	<td><span class="topic">Broken FDS emulation: Kiki Kaikai - Dotou Hen</span><br /><span class="gensmall"><a href="http://forums.nesdev.com/viewtopic.php?f=3&amp;t=6504">http://forums.nesdev.com/viewtopic.php?f=3&amp;t=6504</a></span></td>
	<td align="right" valign="bottom"><span class="gensmall">Page <strong>1</strong> of <strong>4</strong></span></td>
</tr>
</table>



	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>procyon</b> [ Thu Jun 17, 2010 1:15 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Broken FDS emulation: Kiki Kaikai - Dotou Hen</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Hi everyone.  I began to write a guide on how to play this FDS port of the Taito arcade game Kiki Kaikai (the series that came to be known as Pocky &amp; Rocky on the SNES), but I have come across a strange problem.  There are two boss fights that crash just about every modern NES emulator that I have tried, including FCEUX, Nestopia, Nintendulator, Mednafen, and VirtuaNES.  The _only_ emulator that the game works properly on is the "old" emulator NNNesterJ.  It's very strange, where those five other emulators hang, NNNesterJ goes swimmingly right along.  (Interesting to note, for those of you who can read Japanese, a warning to this effect is present on this page: <!-- m --><a class="postlink" href="http://www25.atwiki.jp/famicomall/pages/244.html">http://www25.atwiki.jp/famicomall/pages/244.html</a><!-- m --> which you can run through Google Translator if need be.)
<br />
<br />It's not too hard to get to the crash point, although it takes a few minutes of walking (if you avoid all of the enemies.)  The ROM that I'm using (and the only one that seems to be available) is from the TOSEC set with a CRC of 4C791779.  From the start point, walk straight up.  Keep following the path north until you get the first chance to travel east (you'll cross a few bridges just before that point.)  Head east as soon as you are able, and then take the very next path south.  This will lead you down and around to the entrance of a cave.  You need 50 Ofuda cards to enter the cave, which is what you start with (you earn Ofuda cards by defeating enemies with your wand).  Once inside, the path to the boss never branches.  You travel north, then east, and the north.  At the top of the second north path is the boss room.  The expected result (and the one which NNNesterJ produces) is that the room scrolls into view, turns blue, and a large boss starts to attack you.  The actual result in the rest of the emulators I've tried is that they hang before the room turns blue, stuck playing one note.
<br />
<br />I know this is the sort of thing that is incredibly low priority in the grand scheme of things, but I thought it might be interesting for some of the more active emulator developers to look at and try to figure out what NNNesterJ is doing differently (correctly or perhaps incorrectly) that allows the game to play in this one particular emulator.  I would love to know myself.  Thanks for taking a look!
<br />
<br />Procyon

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>*Spitfire_NES*</b> [ Wed Jul 13, 2011 8:25 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />no to raise the dead but thats interesting. just tried this game out and i wonder what the problem could be....

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Drag</b> [ Thu Jul 14, 2011 7:39 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Does it actually crash the emulator into closing itself, or does the game just freeze?

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>*Spitfire_NES*</b> [ Thu Jul 14, 2011 7:59 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">Drag wrote:</div><div class="quotecontent">Does it actually crash the emulator into closing itself, or does the game just freeze?</div>
<br />
<br />the emulator neither freezes nor crashes, the game hangs when you enter the boss's room. Weird how nesterj could play this right but no others...seems like something blocks the boss from appearing or something...
<br />
<br />Give it a try in nestopia, when you reach one of the boss's rooms it just kinda hangs, and nothing happens, the music freezes on one note, i used rewind to leave the room, but i know the emu does not crash.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>3gengames</b> [ Thu Jul 14, 2011 8:05 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Illegal opcodes maybe? Maybe one not documented very well? Weird thing. And you can't track it down?

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>*Spitfire_NES*</b> [ Thu Jul 14, 2011 8:09 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">3gengames wrote:</div><div class="quotecontent">Illegal opcodes maybe? Maybe one not documented very well? Weird thing. And you can't track it down?</div>
<br />
<br />i have no clue whats causing it, i always thought fds was pretty much 100 percent working and great. i came across this thread yesterday and since then it has peaked my interest. comparing code from NNNnesterj to nestopia is hard to do lol,  <img src="./images/smilies/icon_eek.gif" alt=":shock:" title="Shocked" />
<br />
<br />
<br />***update. My mistake the game does in fact crash.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Gilbert</b> [ Fri Jul 15, 2011 9:48 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />The linked page indeed said that VirtuaNES reported an illegal opcode error.
<br />Maybe someone who have time would try to trace the code there with a debugger enabled emulator (Nintendulator, FCE*whatever* or even No$NES).

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>plasturion</b> [ Fri Jul 15, 2011 1:26 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />I walked to the 1st boss with Nestopia debug mode and it throws illegal opcodes BRK and JAM causing CPU JAM! At titlescreen throws Expression: modulator.writing with Fds::Sound::WriteReg7.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>*Spitfire_NES*</b> [ Fri Jul 15, 2011 1:31 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">plasturion wrote:</div><div class="quotecontent">I walked to the 1st boss with Nestopia debug mode and it throws illegal opcodes BRK and JAM causing CPU JAM! At titlescreen throws Expression: modulator.writing with Fds::Sound::WriteReg7.</div>
<br />
<br />so we need to erase/modify  the illegal opcodes then... so it threw an error with  sound, writereg7...hmm.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>plasturion</b> [ Fri Jul 15, 2011 3:05 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />I think maybe something cause that this opcodes appears. So best way is try to find out if WriteReg7 don't make any mess.
<br />
<br />Let's see what is doing - Nestopia  NstFds.cpp
<br />
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">&nbsp; &nbsp;&nbsp; &nbsp;NES_POKE_D&#40;Fds,4088&#41;<br />&nbsp; &nbsp;&nbsp; &nbsp;&#123;<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;sound.WriteReg7&#40; data &#41;;<br />&nbsp; &nbsp;&nbsp; &nbsp;&#125;<br />&nbsp; &nbsp;&nbsp; &nbsp;<br />&nbsp; &nbsp;&nbsp; &nbsp;void Fds::Sound::WriteReg7&#40;uint data&#41;<br />&nbsp; &nbsp;&nbsp; &nbsp;&#123;<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;NST_VERIFY&#40; modulator.writing &#41;;<br /><br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;if &#40;modulator.writing&#41;<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&#123;<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;Update&#40;&#41;;<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;std::memmove&#40; modulator.table, modulator.table + 1, Modulator::SIZE-1 &#41;;<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;modulator.table&#91;Modulator::SIZE-1&#93; = Modulator::steps&#91;data &amp; REG8_MOD_DATA&#93;;<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&#125;<br />&nbsp; &nbsp;&nbsp; &nbsp;&#125;</div><br /><br />and NNNesterJ 0.23 in fdssnd.c<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">static void FDSSoundWrite&#40;uint32 address, uint8 value&#41;<br />&#123;<br />&nbsp; &nbsp;if &#40;0x4040 &lt;= address &amp;&amp; address &lt;= 0x407F&#41;<br />&nbsp; &nbsp;&#123;<br />&nbsp; &nbsp;&nbsp; &nbsp;apu-&gt;fdssound.op&#91;1&#93;.wave&#91;address - 0x4040&#93; = LinearToLog&#40;&#40;&#40;int32&#41;value &amp; 0x3f&#41; - 0x20&#41;;<br />&nbsp; &nbsp;&#125;<br />&nbsp; &nbsp;else if &#40;0x4080 &lt;= address &amp;&amp; address &lt;= 0x408F&#41;<br />&nbsp; &nbsp;&#123;<br />&nbsp; &nbsp;&nbsp; &nbsp;int ch = &#40;address &lt; 0x4084&#41;;<br />&nbsp; &nbsp;&nbsp; &nbsp;FDS_FMOP *pop = &amp;apu-&gt;fdssound.op&#91;ch&#93;;<br />&nbsp; &nbsp;&nbsp; &nbsp;apu-&gt;fdssound.reg&#91;address - 0x4080&#93; = value;<br />&nbsp; &nbsp;&nbsp; &nbsp;switch &#40;address &amp; 15&#41;<br />&nbsp; &nbsp;&nbsp; &nbsp;&#123;<br />...<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;case 8:<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&#123;<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;static int8 lfotbl&#91;8&#93; = &#123; 0,1,2,3,-4,-3,-2,-1 &#125;;<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;uint32 v = LinearToLog&#40;lfotbl&#91;value &amp; 7&#93;&#41;;<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;apu-&gt;fdssound.op&#91;0&#93;.wave&#91;apu-&gt;fdssound.waveaddr++&#93; = v;<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;apu-&gt;fdssound.op&#91;0&#93;.wave&#91;apu-&gt;fdssound.waveaddr++&#93; = v;<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;if &#40;apu-&gt;fdssound.waveaddr == 0x40&#41;<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&#123;<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;apu-&gt;fdssound.waveaddr = 0;<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&#125;<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&#125;<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;break;<br /></div>
<br />that's only suggest, I'm not sure it can be somehow connected with this issue, however the soundtrack is changing while the boss appears. It takes only last hex digit of address, so we're looking case 8?
<br />
<br />Damn... I need to register if I want using VC++ express. The time trial has expired. Maybe this time someone else wants to have fun <img src="./images/smilies/icon_wink.gif" alt=";)" title="Wink" />.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>3gengames</b> [ Fri Jul 15, 2011 3:22 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Is it running code from RAM? Maybe your CPU is causing something in RAM to be changed wrong and crash?

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>*Spitfire_NES*</b> [ Fri Jul 15, 2011 3:36 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">3gengames wrote:</div><div class="quotecontent">Is it running code from RAM? Maybe your CPU is causing something in RAM to be changed wrong and crash?</div>
<br />
<br />whatever it is, 5 diff emus are all proving to do the same thing including nestopia, virtuanes and others....

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Drag</b> [ Sat Jul 16, 2011 1:24 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Perhaps the image really seriously <em>is</em> broken (bad "dump", I guess), and the fact that nesterj allowed the game to run was due to a bug?
<br />
<br />It could also be the result of copy protection of some kind; I know disk-based c64 software had some hardware-implemented copy protections, such as purposefully unreadable sectors.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>plasturion</b> [ Sat Jul 16, 2011 5:26 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />I've checked where fce ultra debug tool stuck when the boss seems to appear and...
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">00:803B:03&nbsp; &nbsp; &nbsp; &nbsp; UNDEFINED<br />00:803C:01 03&nbsp; &nbsp; &nbsp;ORA &#40;$03,X&#41; @ $02F3 = #$72<br />00:803E:61 62&nbsp; &nbsp; &nbsp;ADC &#40;$62,X&#41; @ $0000 = #$D3<br />00:8040:F0 00&nbsp; &nbsp; &nbsp;BEQ $8042<br />00:8042:00&nbsp; &nbsp; &nbsp; &nbsp; BRK<br />00:8043:00&nbsp; &nbsp; &nbsp; &nbsp; BRK<br />00:8044:92&nbsp; &nbsp; &nbsp; &nbsp; UNDEFINED // Here debug trace stuck <br />00:8045:24 49&nbsp; &nbsp; &nbsp;BIT $0049 = #$00<br />00:8047:92&nbsp; &nbsp; &nbsp; &nbsp; UNDEFINED<br />00:8048:24 49&nbsp; &nbsp; &nbsp;BIT $0049 = #$00<br />00:804A:DB&nbsp; &nbsp; &nbsp; &nbsp; UNDEFINED<br />00:804B:B6 6D&nbsp; &nbsp; &nbsp;LDX $006D,Y @ $0080 = #$FE<br />00:804D:DB&nbsp; &nbsp; &nbsp; &nbsp; UNDEFINED<br />00:804E:B6 6D&nbsp; &nbsp; &nbsp;LDX $006D,Y @ $0080 = #$FE<br />00:8050:04&nbsp; &nbsp; &nbsp; &nbsp; UNDEFINED<br /></div>
<br />looks like this is not so good place to code execute.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>*Spitfire_NES*</b> [ Sat Jul 16, 2011 8:37 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />So looks like something needs to be added or modified...maybe an exception to address while boss appears and music changing. Isn't fce issue the same as nestopia?

		

		</td>
	</tr>
	</table>


<hr width="85%" />

<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
<tr>
	<td><span class="gensmall">Page <strong>1</strong> of <strong>4</strong></span></td>
	<td align="right"><span class="gensmall">All times are UTC - 7 hours </span></td>
</tr>
<tr>
	<td colspan="2" align="center"><span class="gensmall">Powered by phpBB&reg; Forum Software &copy; phpBB Group<br />http://www.phpbb.com/</span></td>
</tr>
</table>

</body>
</html>