<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en-gb" xml:lang="en-gb">
<head>

<link rel="icon" href="/favicon.ico" type="image/x-icon" />
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
<meta http-equiv="content-language" content="en-gb" />
<meta http-equiv="content-style-type" content="text/css" />
<meta http-equiv="imagetoolbar" content="no" />
<meta name="resource-type" content="document" />
<meta name="distribution" content="global" />
<meta name="keywords" content="" />
<meta name="description" content="" />

<title>nesdev.com &bull; View topic - Got any tips for Early NES Emulator Development?</title>

<link rel="alternate" type="application/atom+xml" title="Feed - nesdev.com" href="http://forums.nesdev.com/feed.php" /><link rel="alternate" type="application/atom+xml" title="Feed - News" href="http://forums.nesdev.com/feed.php?mode=news" /><link rel="alternate" type="application/atom+xml" title="Feed - All forums" href="http://forums.nesdev.com/feed.php?mode=forums" /><link rel="alternate" type="application/atom+xml" title="Feed - New Topics" href="http://forums.nesdev.com/feed.php?mode=topics" /><link rel="alternate" type="application/atom+xml" title="Feed - Active Topics" href="http://forums.nesdev.com/feed.php?mode=topics_active" /><link rel="alternate" type="application/atom+xml" title="Feed - Forum - NESemdev" href="http://forums.nesdev.com/feed.php?f=3" /><link rel="alternate" type="application/atom+xml" title="Feed - Topic - Got any tips for Early NES Emulator Development?" href="http://forums.nesdev.com/feed.php?f=3&amp;t=3991" />

<link rel="stylesheet" href="./style.php?id=1&amp;lang=en" type="text/css" />

<script type="text/javascript">
// <![CDATA[


function popup(url, width, height, name)
{
	if (!name)
	{
		name = '_popup';
	}

	window.open(url.replace(/&amp;/g, '&'), name, 'height=' + height + ',resizable=yes,scrollbars=yes,width=' + width);
	return false;
}

function jumpto()
{
	var page = prompt('Enter the page number you wish to go to:', '1');
	var per_page = '15';
	var base_url = './viewtopic.php?f=3&amp;t=3964';

	if (page !== null && !isNaN(page) && page == Math.floor(page) && page > 0)
	{
		if (base_url.indexOf('?') == -1)
		{
			document.location.href = base_url + '?start=' + ((page - 1) * per_page);
		}
		else
		{
			document.location.href = base_url.replace(/&amp;/g, '&') + '&start=' + ((page - 1) * per_page);
		}
	}
}

/**
* Find a member
*/
function find_username(url)
{
	popup(url, 760, 570, '_usersearch');
	return false;
}

/**
* Mark/unmark checklist
* id = ID of parent container, name = name prefix, state = state [true/false]
*/
function marklist(id, name, state)
{
	var parent = document.getElementById(id);
	if (!parent)
	{
		eval('parent = document.' + id);
	}

	if (!parent)
	{
		return;
	}

	var rb = parent.getElementsByTagName('input');
	
	for (var r = 0; r < rb.length; r++)
	{
		if (rb[r].name.substr(0, name.length) == name)
		{
			rb[r].checked = state;
		}
	}
}



// ]]>
</script>
</head>
<body class="ltr">

<a name="top"></a>

<div id="wrapheader">

	<div id="logodesc">
	</div>

	<div id="menubar">

		<table width="100%" cellspacing="0">
		<tr>
			<td rowspan="2"><a href="./index.php"><img src="./styles/subsilver2/imageset/site_logo.gif" alt="" title="" /></a></td>
			<td width="100%" align="center"><h1>nesdev.com</h1><span class="gen">NES Development and Strangulation Records message boards</span></td>
		</tr>
		<tr>
			<td align="center">
				<a href="./faq.php"><img src="./styles/prosilver/theme/images/icon_mini_faq.gif" width="12" height="13" alt="*" /> FAQ</a>
				&nbsp; &nbsp;<a href="./search.php"><img src="./styles/prosilver/theme/images/icon_mini_search.gif" width="12" height="13" alt="*" /> Search</a>
				<br />	
				 &nbsp;<a href="./ucp.php?mode=register"><img src="./styles/prosilver/theme/images/icon_mini_register.gif" width="12" height="13" alt="*" /> Register</a>
					&nbsp; &nbsp;<a href="./ucp.php?mode=login"><img src="./styles/prosilver/theme/images/icon_mini_login.gif" width="12" height="13" alt="*" /> Login</a>&nbsp;
			</td>
		</tr>
		</table>
	</div>

	<div id="datebar">
		<table width="100%" cellspacing="0">
		<tr>
			<td class="gensmall"></td>
			<td class="gensmall" align="right">It is currently Thu Aug 30, 2012 9:45 pm<br /></td>
		</tr>
		</table>
	</div>

</div>

<div id="wrapcentre">

	
	<p class="searchbar">
		<span style="float: left;"><a href="./search.php?search_id=unanswered">View unanswered posts</a> | <a href="./search.php?search_id=active_topics">View active topics</a></span>
		
	</p>
	

	<br style="clear: both;" />

	<table class="tablebg" width="100%" cellspacing="1" cellpadding="0" style="margin-top: 5px;">
	<tr>
		<td class="row1">
			<p class="breadcrumbs"><a href="./index.php">Board index</a> &#187; <a href="./viewforum.php?f=24">NES / Famicom</a> &#187; <a href="./viewforum.php?f=3">NESemdev</a></p>
			<p class="datetime">All times are UTC - 7 hours </p>
		</td>
	</tr>
	</table>

	<br />

<div id="pageheader">
	<h2><a class="titles" href="./viewtopic.php?f=3&amp;t=3964">Got any tips for Early NES Emulator Development?</a></h2>


	<p class="moderators">Moderator: <a href="./memberlist.php?mode=group&amp;g=320">Moderators</a></p>

</div>

<br clear="all" /><br />

<div id="pagecontent">

	<table width="100%" cellspacing="1">
	<tr>
		<td align="left" valign="middle" nowrap="nowrap">
		<a href="./posting.php?mode=post&amp;f=3"><img src="./styles/subsilver2/imageset/en/button_topic_new.gif" alt="Post new topic" title="Post new topic" /></a>&nbsp;<a href="./posting.php?mode=reply&amp;f=3&amp;t=3964"><img src="./styles/subsilver2/imageset/en/button_topic_reply.gif" alt="Reply to topic" title="Reply to topic" /></a>
		</td>
		
			<td class="nav" valign="middle" nowrap="nowrap">&nbsp;Page <strong>1</strong> of <strong>8</strong><br /></td>
			<td class="gensmall" nowrap="nowrap">&nbsp;[ 109 posts ]&nbsp;</td>
			<td class="gensmall" width="100%" align="right" nowrap="nowrap"><b><a href="#" onclick="jumpto(); return false;" title="Click to jump to pageâ€¦">Go to page</a> <strong>1</strong><span class="page-sep">, </span><a href="./viewtopic.php?f=3&amp;t=3964&amp;start=15">2</a><span class="page-sep">, </span><a href="./viewtopic.php?f=3&amp;t=3964&amp;start=30">3</a><span class="page-sep">, </span><a href="./viewtopic.php?f=3&amp;t=3964&amp;start=45">4</a><span class="page-sep">, </span><a href="./viewtopic.php?f=3&amp;t=3964&amp;start=60">5</a><span class="page-dots"> ... </span><a href="./viewtopic.php?f=3&amp;t=3964&amp;start=105">8</a> &nbsp;<a href="./viewtopic.php?f=3&amp;t=3964&amp;start=15">Next</a></b></td>
		
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr>
		<td class="cat">
			<table width="100%" cellspacing="0">
			<tr>
				<td class="nav" nowrap="nowrap">&nbsp;
				<a href="./viewtopic.php?f=3&amp;t=3964&amp;view=print" title="Print view">Print view</a>
				</td>
				<td class="nav" align="right" nowrap="nowrap"><a href="./viewtopic.php?f=3&amp;t=3964&amp;view=previous">Previous topic</a> | <a href="./viewtopic.php?f=3&amp;t=3964&amp;view=next">Next topic</a>&nbsp;</td>
			</tr>
			</table>
		</td>
	</tr>

	</table>


	<table class="tablebg" width="100%" cellspacing="1">
	
		<tr>
			<th>Author</th>
			<th>Message</th>
		</tr>
	<tr class="row1">

			<td align="center" valign="middle">
				<a name="p31602"></a>
				<b class="postauthor">MottZilla</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p31602">Got any tips for Early NES Emulator Development?</a></div><div style="float: right;"><a href="./viewtopic.php?p=31602#p31602"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Tue Mar 11, 2008 5:01 pm&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				<tr>
					<td><img src="./download/file.php?avatar=1726.jpg" width="100" height="100" alt="User avatar" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Wed Dec 06, 2006 8:18 pm<br /><b>Posts:</b> 1799
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">Along time ago (something like 8 years ago) I thought it would be really cool to write an emulator. Ofcourse I didn't know anything back then, but now I actually have a decent understanding of both the NES and programming. 
<br />
<br />So I had made two previous attempts at writing a NES emulator which never went anywhere, which was before I'd ever written any ASM for the NES. But now I'm making another attempt. I understand the concept I believe and I've got a CPU interpreter partially written. By partially I mean not every opcode is there yet, and the ones that are there I can't be 100% sure they are all correct.
<br />
<br />But everything I've done so far was enough that I see some life. In my little "Pong" demo I wrote ages ago for the NES, it shows the name tables being written to with some hacky graphics emulation. I also can see the menu of that NESTEST rom. But I have some confusion as to what could be causing one issue.
<br />
<br />I started the CPU core pretty simple, made it reset to the vector and "fetch" an Opcode. It then would either do it if I supported it or tell me what it was if I didn't. So I used Donkey Kong (JU) as my test ROM. I would repeatedly load the game and let it run until it hit an opcode I hadn't supported yet, and then go to add suppotrt for that and kept doing this. I would "try" to verify the opcodes were working the way they should be comparing with other emulators. 
<br />
<br />I eventually got the thing to just loop forever as it wouldn't hit any unsupported opcodes. I figured out (I think so atleast) that the game was just waiting around now for NMI, or maybe for a nes register to return a value. After adding NMI I got to a bunch more opcodes. I verified the addresses it was executing are executed addresses and not errors by tracing in a completed emulator (FCEU). Eventually, I was back to the same thing, the game would run and never hit any unsuppotred opcodes. 
<br />
<br />I went to implement the "graphics" emulation if you want to call it that, but it's really just a function to draw what values in the NameTable 0 are on screen. I could see Donkey Kong and Donkey Kong Jr. both cleared the name table to all #$24, the "Blank" tile for the games. I also could see the nestest and my pong demo. This is the point I'm at now.
<br />
<br /><strong>My problem</strong> is that Donkey Kong and DK Jr never write anything else to the screen. And the program counter is looping in the same range. I'm going to investigate what its looping on to try to figure out what to do next. <em>Update:</em> It wasn't looping like I had thought at one point. For all I know the game is running, though I'm not sure why I cannot see anything plotted on the nametable other than the blank tiles.
<br />
<br />
<br />
<br />Now the point of this topic, what advice do you have for writing a NES emulator? Keep in mind I specifically mean advice for someone that is new to writing a NES emulator. Such as what games or NES programs do you suggest would be good targets to get working first? I have read on here before that many make the mistake of thinking getting Super Mario Brothers running is the easiest. I assume a game like Donkey Kong would be easier, no scrolling, no sprite 0 hit, no rom banking, etc. 
<br />
<br />So anyone got any tips?</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=1726"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row2">

			<td align="center" valign="middle">
				<a name="p31603"></a>
				<b class="postauthor">Disch</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p31603"></a></div><div style="float: right;"><a href="./viewtopic.php?p=31603#p31603"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Tue Mar 11, 2008 8:50 pm&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				<tr>
					<td><img src="./download/file.php?avatar=33.png" width="65" height="75" alt="User avatar" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Wed Nov 10, 2004 6:47 pm<br /><b>Posts:</b> 1670
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">1)  write a tracer (if you haven't already).  Bugs and timing issues are next to impossible to solve without one.
<br />
<br />2)  get and pass as many CPU test ROMs as you can.  nestest.nes is paticularly nice because it doesn't require a PPU to be emulated in order to run it.
<br />
<br />3)  This is in the same vein as #2 -- but <em>focus on the CPU first</em>.  CPU bugs will usually be the biggest reason for emu muckups.  PPU bugs will usually cause graphical glitches, APU bugs will cause sound glitches, but CPU bugs can and will cause every possible kind of glitch making them <em>very</em> hard to diagnose.
<br />
<br />4)  Pointers are your friend.  NT mirroring, CHR/PRG swapping, and tons of other things can be handled painlessly and easily with proper use of pointers.  Bulk memory copying is slow and cumbersome.
<br />
<br />that's about all I can think of.</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=33"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row1">

			<td align="center" valign="middle">
				<a name="p31605"></a>
				<b class="postauthor">MottZilla</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p31605"></a></div><div style="float: right;"><a href="./viewtopic.php?p=31605#p31605"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Wed Mar 12, 2008 12:58 am&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				<tr>
					<td><img src="./download/file.php?avatar=1726.jpg" width="100" height="100" alt="User avatar" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Wed Dec 06, 2006 8:18 pm<br /><b>Posts:</b> 1799
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">Well I'll be doing what you suggest, and adding a tracer of some kind so I can better understand what is going on. I agree that it's virtually impossible to understand what is going on without something more than a few values displayed on screen.</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=1726"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row2">

			<td align="center" valign="middle">
				<a name="p31610"></a>
				<b class="postauthor">MottZilla</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p31610"></a></div><div style="float: right;"><a href="./viewtopic.php?p=31610#p31610"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Wed Mar 12, 2008 6:55 pm&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				<tr>
					<td><img src="./download/file.php?avatar=1726.jpg" width="100" height="100" alt="User avatar" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Wed Dec 06, 2006 8:18 pm<br /><b>Posts:</b> 1799
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">And you were right Disch. After writing a disasembling/tracer output and reading the log, I found out two bugs that were preventing the title screen from appearing. For one, my NMI was not executing correctly. It was going to NMI Vector + 1, but the odd thing is I have no idea why. I ended up fixing it by deciding that if an NMI is triggered to do everything and then return from the function and not to proceed through the CPU core.
<br />
<br />The other bug, I forgot to update the flags on opcode B1, which meant it never took a branch and never loaded the title. Now I can read with my text output of the nametable "DONKEY KONG", with marked tiles where all the text and such would be. So ironing out my CPU certainly will be top priority.</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=1726"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row1">

			<td align="center" valign="middle">
				<a name="p31611"></a>
				<b class="postauthor">kyuusaku</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p31611"></a></div><div style="float: right;"><a href="./viewtopic.php?p=31611#p31611"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Wed Mar 12, 2008 7:49 pm&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				<tr>
					<td><img src="./download/file.php?avatar=20.png" width="75" height="100" alt="User avatar" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Mon Sep 27, 2004 2:13 pm<br /><b>Posts:</b> 1625<br /><b>Location:</b> .ma.us
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">Keep everything modular, flexible, and try to emulate at the lowest level you can manage; it will pay off later on in accuracy and probably speed after optimization.</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=20"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row2">

			<td align="center" valign="middle">
				<a name="p31612"></a>
				<b class="postauthor">Disch</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p31612"></a></div><div style="float: right;"><a href="./viewtopic.php?p=31612#p31612"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Wed Mar 12, 2008 8:12 pm&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				<tr>
					<td><img src="./download/file.php?avatar=33.png" width="65" height="75" alt="User avatar" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Wed Nov 10, 2004 6:47 pm<br /><b>Posts:</b> 1670
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">Some more advice:
<br />
<br />Don't copy/paste or have multiple copies of the same code.  You shouldn't be having a problem with a single opcode not setting flags, because that opcode probably should be sharing code with other similar opcodes.
<br />
<br />That is to say... if you have LDA immediate, and ADC absolute, LDA absolute should not require any additional code other than an additional 'case' statement to tie together your 'LDA' code and your 'absolute' code.  This way if you have a problem with LDA it will become visible much sooner and be much more obvious that you have a bug (meaning you can correct it sooner -- hidden bugs that you have to coax out are less preferable than bugs that stand up and shout at you)
<br />
<br />Plus if you find and fix a bug or make a technical correction -- if all opcodes share the same code you only have to make the change once, rather than updating a dozen opcodes.  Like if you found out you were wrapping Indirect,Y incorrectly -- it's much easier to just change your Indirect,Y code than it would be to update and fix every single opcode that uses Indirect,Y.
<br />
<br />This kind of thing can be accomplished pretty well by function inlining.  Here's a snippit of my ADC absolute code to give the idea:
<br />
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void NES_INLINE AdRdAb&#40;NESCPU&amp; cpu&#41;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;// Absolute<br />&#123;<br />&nbsp; &nbsp;cpu.adr = Rd&#40;cpu.PC&#41;; ++cpu.PC;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;// cycle 1<br />&nbsp; &nbsp;cpu.adr |= &#40;Rd&#40;cpu.PC&#41; &lt;&lt; 8&#41;; ++cpu.PC;&nbsp; &nbsp;&nbsp; &nbsp;// cycle 2<br />&nbsp; &nbsp;cpu.val = Rd&#40;cpu.adr&#41;;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;// cycle 3<br />&#125;<br /><br />...<br /><br />void NES_INLINE _ADC&#40;NESCPU&amp; cpu&#41;<br />&#123;<br />&nbsp; &nbsp;register u16 tmp = cpu.A + cpu.val + &#40;cpu.fC != 0&#41;;<br />&nbsp; &nbsp;cpu.fC = &#40;tmp &gt;= 0x0100&#41;;<br />&nbsp; &nbsp;cpu.fV = &#40;tmp ^ cpu.A&#41; &amp; &#40;tmp ^ cpu.val&#41; &amp; 0x80;<br />&nbsp; &nbsp;cpu.fN = cpu.fZ = cpu.A = &#40;u8&#41;tmp;<br />&#125;<br /><br />...<br /><br /><br />&nbsp; &nbsp;&nbsp; &nbsp;// the ops<br />&nbsp; &nbsp;&nbsp; &nbsp;op = Read&#40;mCPU-&gt;PC&#41;;<br />&nbsp; &nbsp;&nbsp; &nbsp;++mCPU-&gt;PC;<br /><br />&nbsp; &nbsp;&nbsp; &nbsp;switch&#40;op&#41;<br />&nbsp; &nbsp;&nbsp; &nbsp;&#123;<br />...<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;/* ADC&nbsp; &nbsp;*/<br />&nbsp; &nbsp;&nbsp; &nbsp;case 0x69:&nbsp; &nbsp;AdRdIm&#40;*mCPU&#41;;&nbsp; &nbsp;_ADC&#40;*mCPU&#41;;&nbsp; &nbsp;&nbsp; &nbsp;break;<br />&nbsp; &nbsp;&nbsp; &nbsp;case 0x65:&nbsp; &nbsp;AdRdZp&#40;*mCPU&#41;;&nbsp; &nbsp;_ADC&#40;*mCPU&#41;;&nbsp; &nbsp;&nbsp; &nbsp;break;<br />&nbsp; &nbsp;&nbsp; &nbsp;case 0x75:&nbsp; &nbsp;AdRdZx&#40;*mCPU&#41;;&nbsp; &nbsp;_ADC&#40;*mCPU&#41;;&nbsp; &nbsp;&nbsp; &nbsp;break;<br />&nbsp; &nbsp;&nbsp; &nbsp;case 0x6D:&nbsp; &nbsp;AdRdAb&#40;*mCPU&#41;;&nbsp; &nbsp;_ADC&#40;*mCPU&#41;;&nbsp; &nbsp;&nbsp; &nbsp;break;<br />&nbsp; &nbsp;&nbsp; &nbsp;case 0x7D:&nbsp; &nbsp;AdRdAx&#40;*mCPU&#41;;&nbsp; &nbsp;_ADC&#40;*mCPU&#41;;&nbsp; &nbsp;&nbsp; &nbsp;break;<br />&nbsp; &nbsp;&nbsp; &nbsp;case 0x79:&nbsp; &nbsp;AdRdAy&#40;*mCPU&#41;;&nbsp; &nbsp;_ADC&#40;*mCPU&#41;;&nbsp; &nbsp;&nbsp; &nbsp;break;<br />&nbsp; &nbsp;&nbsp; &nbsp;case 0x61:&nbsp; &nbsp;AdRdIx&#40;*mCPU&#41;;&nbsp; &nbsp;_ADC&#40;*mCPU&#41;;&nbsp; &nbsp;&nbsp; &nbsp;break;<br />&nbsp; &nbsp;&nbsp; &nbsp;case 0x71:&nbsp; &nbsp;AdRdIy&#40;*mCPU&#41;;&nbsp; &nbsp;_ADC&#40;*mCPU&#41;;&nbsp; &nbsp;&nbsp; &nbsp;break;<br />...<br /></div>
<br />
<br />
<br />
<br />A trick for cycle tallying:
<br />
<br />With the exception of stack opcodes like PHA, RTI, etc, and for one of two  oddball instructions (JMP) the addressing mode directly dictates the number of cycle any given instruction uses.  That is, Absolute always uses 4 cycles... Zero Page always uses 3...  Indirect,Y always uses 5+1 cycles, etc.
<br />
<br />Note this is true for read-only instructions like LDA, ADC, CMP, and for write instructions like STA, STX, STY.  Read/modify/write instructions like INC, ASL use different numbers, but are still just as predictable:  Absolute always uses 6 cycles, Zero Page always uses 5, etc.
<br />
<br />I have three sets of addressing mode fuctions.  One for read-only ops, one for write ops, and one for read/modify/write ops.  You can then use these functions to tally your CPU cycles rather than building and using a lookup table.
<br />
<br />
<br />Of course this method isn't really better or worse than using a lookup table.  I just found that building the lookup table is time consuming and dull.. and it's very easy to make an ever-so-subtle mistake that will be really hard to find.
<br />
<br />(In case you were wondering I don't tally cycles this way in my above code -- I actually just tally a cycle in my Rd() and Wr() functions -- and perform all the dummy reads and writes performed by instructions.  This works because the CPU either reads or writes a byte for every cycle an instruction takes)</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=33"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row1">

			<td align="center" valign="middle">
				<a name="p31614"></a>
				<b class="postauthor">MottZilla</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p31614"></a></div><div style="float: right;"><a href="./viewtopic.php?p=31614#p31614"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Wed Mar 12, 2008 10:10 pm&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				<tr>
					<td><img src="./download/file.php?avatar=1726.jpg" width="100" height="100" alt="User avatar" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Wed Dec 06, 2006 8:18 pm<br /><b>Posts:</b> 1799
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">I've gotten further with the CPU test ROM though I am getting some error codes. I'm planning on redoing alot of the CPU code as you suggested because as I was writing it, I found that I could probably make things alot neater and reuse the same code rather than copying and pasting it a million times. :p 
<br />
<br />As far as accuracy goes, I don't need or intend for it to be perfect or close to that. I think that'd be a prett big goal for a first try, and also when I'm not really looking to try to somehow top the great emulators others have created. 
<br />
<br />What I've been doing is not like you've suggested where CPU instructions are broken down into individual cycles. I've got it setup so it executes each instruction and increases the clock counter. And right now my biggest concern is a working CPU core anyway. So it doesn't have to be perfect, just has to work. And I'm thinking doing that will require or atleast go better if I change things so that I take advantage of Opcodes &amp; Addressing modes rather than to do each opcode number individually. 
<br />
<br />I'll probably have some questions about the CPU too. The Test rom has certainly raised some strange issues. Like saying something about overflow and carry and not being affected by INX and DEX. But in the 6502.txt document, it says those flags are unaffected anyway.</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=1726"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row2">

			<td align="center" valign="middle">
				<a name="p31615"></a>
				<b class="postauthor">Disch</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p31615"></a></div><div style="float: right;"><a href="./viewtopic.php?p=31615#p31615"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Thu Mar 13, 2008 8:52 am&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				<tr>
					<td><img src="./download/file.php?avatar=33.png" width="65" height="75" alt="User avatar" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Wed Nov 10, 2004 6:47 pm<br /><b>Posts:</b> 1670
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody"><div class="quotetitle">MottZilla wrote:</div><div class="quotecontent">As far as accuracy goes, I don't need or intend for it to be perfect or close to that. I think that'd be a prett big goal for a first try, and also when I'm not really looking to try to somehow top the great emulators others have created.</div><br /><br />I wouldn't recommend you try for a high level of accuracy on your first go, either.  I've rewritten my emu a few times now and each time I've made changes based on what I learned from my past attempts.<br /><br />There's no way you'll be able to plan for and work around every issue that comes up your first time out of the gate -- so I wouldn't worry too much about it.  But that being said... I would say try to get things as accurate as <em>you feel comfortable with</em>.  Details which might seem relatively insignificant can sometimes cause some games to go horribly wrong.  But at the same time, it's not worth killing yourself over every little detail until you have a better grasp on things.  You'll have to find some middle ground that you're happy with.<br /><br />In short:  keep doing what you're doing =P.  You may get the urge to go back and rewrite later... but when you do you'll be amazed at how much easier it is.<br /><br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">I've got it setup so it executes each instruction and increases the clock counter.</div><br /><br />That's totally fine.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">I'll probably have some questions about the CPU too. The Test rom has certainly raised some strange issues. Like saying something about overflow and carry and not being affected by INX and DEX. But in the 6502.txt document, it says those flags are unaffected anyway.</div>
<br />
<br />If the test ROM is yelling at you for that, it may be because you're changing C or V on INX/DEX when you shouldn't be (INX/DEX only change N and Z... other flags should not be changed from their previous state)
<br />
<br />Also -- for a quick reference, I would recommend obelisk over 6502.txt:
<br />
<br /><!-- m --><a class="postlink" href="http://www.obelisk.demon.co.uk/6502/reference.html">http://www.obelisk.demon.co.uk/6502/reference.html</a><!-- m -->
<br />
<br />6502.txt does a better job at giving details of what each instruction does... but when it comes to opcode listings and other reference stuff it has a few typos which can be a real pain.
<br />
<br />Still use 6502.txt if it's easier for you, but cross-check the info with that obelisk page to make sure you're not assigning an instruction to the wrong opcode or something like that.</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=33"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row1">

			<td align="center" valign="middle">
				<a name="p31625"></a>
				<b class="postauthor">MottZilla</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p31625"></a></div><div style="float: right;"><a href="./viewtopic.php?p=31625#p31625"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Thu Mar 13, 2008 12:15 pm&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				<tr>
					<td><img src="./download/file.php?avatar=1726.jpg" width="100" height="100" alt="User avatar" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Wed Dec 06, 2006 8:18 pm<br /><b>Posts:</b> 1799
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">Well the thing about INX and DEX, as far as I could tell I only was chagning N and Z. I didn't touch C or V. But I'm rewriting all the instructions now to use address mode functions which are then paired with instruction functions ex: LDA(AM_Immediate()). I don't think it's as fast as it could be in execution but I'm more concerned with readability of the code and maintaining it. 
<br />
<br />From what you say it sounds like I'm on the right track. And I'll start using the obelisk page to cross reference as before I relied solely on 6502.txt which has some typos that were probably generated by paper running through a machine to translate it into a text file. Things like capital Ds being 0s. 
<br />
<br />So far as I've been changing over from the code in the switch() case to functions I haven't broken anything. This approach seems much better than the initial one. You definitely learn as you go what works and what doesn't or what is better.
<br />
<br />
<br />Update: As I've gone converting my core into functions, I've fixed a number of instructions that were not working properly. As a result, Donkey Kong and Donkey Kong Jr. (my test games) now proceed past the title screen and I actually see the name table is loaded with their first levels. I'm still converting and verifying the instructions I've done and after they are all converted I believe I have a few more to add. I'm stil using the cpu test rom and I still get errors on certain things but I'm sure I'll iron that all out eventually. 
<br />
<br />I do have a question though. The CPU test error codes often have entrys that don't say much more than the instruction that failed. Like I think the last ADC Immediate fails on me for some reason it doesn't tell me what though.</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=1726"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row2">

			<td align="center" valign="middle">
				<a name="p31632"></a>
				<b class="postauthor">Disch</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p31632"></a></div><div style="float: right;"><a href="./viewtopic.php?p=31632#p31632"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Thu Mar 13, 2008 8:22 pm&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				<tr>
					<td><img src="./download/file.php?avatar=33.png" width="65" height="75" alt="User avatar" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Wed Nov 10, 2004 6:47 pm<br /><b>Posts:</b> 1670
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">yeah nestest doesn't really get into specifics.  All I can say is double check your ADC code and make sure you're setting flags properly.
<br />
<br />V, in paticular, tends to give people the most trouble.  For ADC, V is set when:
<br />
<br />positive + positive = negative
<br />or
<br />negative + negative = positive
<br />
<br />and is cleared on all other cases.  Another way to think of how V works is to look at the signed number range... V does for signed numbers what C does for unsigned:
<br />
<br />unsigned range = 0 to 255  ($00-$FF)
<br />signed range = -128 to 127 ($80-$7F)
<br />
<br />Just as C is set when the addition produces a number higher than 255 ($FF) -- V is set when the addition produces a number higher than 127 ($7F)</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=33"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row1">

			<td align="center" valign="middle">
				<a name="p31633"></a>
				<b class="postauthor">MottZilla</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p31633"></a></div><div style="float: right;"><a href="./viewtopic.php?p=31633#p31633"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Thu Mar 13, 2008 8:59 pm&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				<tr>
					<td><img src="./download/file.php?avatar=1726.jpg" width="100" height="100" alt="User avatar" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Wed Dec 06, 2006 8:18 pm<br /><b>Posts:</b> 1799
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">Can you spot anything wrong with this code?
<br />
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">fixed</div>
<br />
<br />When I replaced either one of the ADCs or the SBCs with the function call instead of the garbage I had in the case, Donkey Kong no longer shows the correct name table setup for the title and the level. I'm not sure why it broke.</div>

					
							<br /><br />
							<span class="gensmall">Last edited by <a href="./memberlist.php?mode=viewprofile&amp;u=1726">MottZilla</a> on Thu Mar 13, 2008 9:50 pm, edited 2 times in total.</span>
						<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=1726"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row2">

			<td align="center" valign="middle">
				<a name="p31635"></a>
				<b class="postauthor">Dwedit</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p31635"></a></div><div style="float: right;"><a href="./viewtopic.php?p=31635#p31635"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Thu Mar 13, 2008 9:14 pm&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				<tr>
					<td><img src="./download/file.php?avatar=53.png" width="68" height="100" alt="User avatar" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Fri Nov 19, 2004 7:35 pm<br /><b>Posts:</b> 2547
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody"><div class="codetitle"><b>Code:</b></div><div class="codecontent">&nbsp; &nbsp;if&#40; &#40;CPU_A + Value + Carry &#41; &lt; CPU_A&#41;&nbsp; &nbsp;// Check if Carry will Result <br /></div><br />WTF.  How is that supposed to work?<br />Shouldn't this be something like this?<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">if &#40;CPU_A + value + carry &gt;= 256&#41;<br /></div></div>

					
						<div class="postbody"><br />_________________<br />Here come the fortune cookies!  Here come the fortune cookies!  They're wearing paper hats!</div>
					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=53"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row1">

			<td align="center" valign="middle">
				<a name="p31636"></a>
				<b class="postauthor">MottZilla</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p31636"></a></div><div style="float: right;"><a href="./viewtopic.php?p=31636#p31636"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Thu Mar 13, 2008 9:19 pm&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				<tr>
					<td><img src="./download/file.php?avatar=1726.jpg" width="100" height="100" alt="User avatar" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Wed Dec 06, 2006 8:18 pm<br /><b>Posts:</b> 1799
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">I believe the idea was that, if you have an 8bit value and you are adding a number to it, if the number you end up with is less than wht you started with, then you wrapped around.  However when I went back to my original code which does it with an int and a &gt;0xff, it is working again. I guess I was thinking by adding a bunch of 8bit values together it would wrap and never be greater than 0xff. I dunno. I'm tired I guess. :p Thanks for pointing that out. Anyway, I took my newer code and fixed that fuckup. Everything is fine now.</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=1726"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row2">

			<td align="center" valign="middle">
				<a name="p31638"></a>
				<b class="postauthor">hap</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p31638"></a></div><div style="float: right;"><a href="./viewtopic.php?p=31638#p31638"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Fri Mar 14, 2008 6:38 am&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				<tr>
					<td><img src="./download/file.php?avatar=115.gif" width="48" height="48" alt="User avatar" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Thu Mar 24, 2005 3:17 pm<br /><b>Posts:</b> 354
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">It's ok, I made that thinking-error too once ;p. It would only work if you stored it into an 8 bit variable before the "if". Still though, it won't work that way, since if A=$FF, value=$FF, carry is set, result would be the same as A, but cause a carry anyway.</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=115"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row1">

			<td align="center" valign="middle">
				<a name="p31652"></a>
				<b class="postauthor">MottZilla</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p31652"></a></div><div style="float: right;"><a href="./viewtopic.php?p=31652#p31652"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Fri Mar 14, 2008 4:00 pm&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				<tr>
					<td><img src="./download/file.php?avatar=1726.jpg" width="100" height="100" alt="User avatar" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Wed Dec 06, 2006 8:18 pm<br /><b>Posts:</b> 1799
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">I believe I have all the opcodes implemented now. However I'm getting error codes with nestest. Most if not all, refer to the final SBC error code in their respective blocks. Does anyone know what that means? This is my ADC function and SBC function, if there's some error I've overlooked let me know.
<br />
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void ADC&#40;unsigned char Value&#41;<br />&#123;<br />&nbsp; &nbsp;unsigned char Carry=CPU_P&amp;0x01;<br />&nbsp; &nbsp;// Check for Carry<br />&nbsp; &nbsp;if&#40; &#40;CPU_A + Value + Carry &#41; &gt; 0xFF&#41;&nbsp; &nbsp;// Check if Carry will Result<br />&nbsp; &nbsp;&#123;<br />&nbsp; &nbsp;&nbsp; &nbsp;CPU_SETC=1;<br />&nbsp; &nbsp;&#125;<br />&nbsp; &nbsp;else<br />&nbsp; &nbsp;&#123;<br />&nbsp; &nbsp;&nbsp; &nbsp;CPU_SETC=0;<br />&nbsp; &nbsp;&#125;<br /><br />&nbsp; &nbsp;// Check for Zero<br />&nbsp; &nbsp;if&#40; &#40;CPU_A + Value + Carry&#41;==0 &#41;&nbsp; &nbsp;&nbsp; &nbsp;// Check if Zero will Result, Set Flag accordingly.<br />&nbsp; &nbsp;&#123;<br />&nbsp; &nbsp;&nbsp; &nbsp;SetZero&#40;&#41;;<br />&nbsp; &nbsp;&#125;<br />&nbsp; &nbsp;else<br />&nbsp; &nbsp;&#123;<br />&nbsp; &nbsp;&nbsp; &nbsp;ClearZero&#40;&#41;;<br />&nbsp; &nbsp;&#125;<br /><br />&nbsp; &nbsp;// Check for Overflow<br />&nbsp; &nbsp;CPU_TEMP=CPU_A + Value + Carry;<br />&nbsp; &nbsp;CPU_SETV=0;<br />&nbsp; &nbsp;if&#40;!&#40;&#40;CPU_A ^ Value&#41;&amp;0x80&#41; &amp;&amp; !&#40;&#40;CPU_A ^ CPU_TEMP&#41;&amp;0x80&#41;&#41;<br />&nbsp; &nbsp;&nbsp; &nbsp;CPU_SETV=1;<br />&nbsp; &nbsp;if&#40;CPU_SETV&#41;<br />&nbsp; &nbsp;&#123;<br />&nbsp; &nbsp;&nbsp; &nbsp;SetOverflow&#40;&#41;;<br />&nbsp; &nbsp;&#125;<br />&nbsp; &nbsp;else<br />&nbsp; &nbsp;&#123;<br />&nbsp; &nbsp;&nbsp; &nbsp;ClearOverflow&#40;&#41;;<br />&nbsp; &nbsp;&#125;<br /><br />&nbsp; &nbsp;// Do ADC Operation<br />&nbsp; &nbsp;CPU_A = CPU_A + Value + Carry;<br /><br />&nbsp; &nbsp;if&#40;CPU_SETC==1&#41;<br />&nbsp; &nbsp;&#123;<br />&nbsp; &nbsp;&nbsp; &nbsp;SetCarry&#40;&#41;;<br />&nbsp; &nbsp;&#125;<br />&nbsp; &nbsp;else<br />&nbsp; &nbsp;&#123;<br />&nbsp; &nbsp;&nbsp; &nbsp;ClearCarry&#40;&#41;;<br />&nbsp; &nbsp;&#125;<br /><br />&#125;<br /><br />void SBC&#40;unsigned char Value&#41;<br />&#123;<br />&nbsp; &nbsp;ADC&#40;Value ^ 0xFF&#41;;<br />&#125;<br /></div>
<br />
<br />Value is returned by the appropriate address mode function.</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=1726"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table width="100%" cellspacing="1" class="tablebg">
	<tr align="center">
		<td class="cat"><form name="viewtopic" method="post" action="./viewtopic.php?f=3&amp;t=3964"><span class="gensmall">Display posts from previous:</span> <select name="st" id="st"><option value="0" selected="selected">All posts</option><option value="1">1 day</option><option value="7">7 days</option><option value="14">2 weeks</option><option value="30">1 month</option><option value="90">3 months</option><option value="180">6 months</option><option value="365">1 year</option></select>&nbsp;<span class="gensmall">Sort by</span> <select name="sk" id="sk"><option value="a">Author</option><option value="t" selected="selected">Post time</option><option value="s">Subject</option></select> <select name="sd" id="sd"><option value="a" selected="selected">Ascending</option><option value="d">Descending</option></select>&nbsp;<input class="btnlite" type="submit" value="Go" name="sort" /></form></td>
	</tr>
	</table>
	

	<table width="100%" cellspacing="1">
	<tr>
		<td align="left" valign="middle" nowrap="nowrap">
		<a href="./posting.php?mode=post&amp;f=3"><img src="./styles/subsilver2/imageset/en/button_topic_new.gif" alt="Post new topic" title="Post new topic" /></a>&nbsp;<a href="./posting.php?mode=reply&amp;f=3&amp;t=3964"><img src="./styles/subsilver2/imageset/en/button_topic_reply.gif" alt="Reply to topic" title="Reply to topic" /></a>
		</td>
		
			<td class="nav" valign="middle" nowrap="nowrap">&nbsp;Page <strong>1</strong> of <strong>8</strong><br /></td>
			<td class="gensmall" nowrap="nowrap">&nbsp;[ 109 posts ]&nbsp;</td>
			<td class="gensmall" width="100%" align="right" nowrap="nowrap"><b><a href="#" onclick="jumpto(); return false;" title="Click to jump to pageâ€¦">Go to page</a> <strong>1</strong><span class="page-sep">, </span><a href="./viewtopic.php?f=3&amp;t=3964&amp;start=15">2</a><span class="page-sep">, </span><a href="./viewtopic.php?f=3&amp;t=3964&amp;start=30">3</a><span class="page-sep">, </span><a href="./viewtopic.php?f=3&amp;t=3964&amp;start=45">4</a><span class="page-sep">, </span><a href="./viewtopic.php?f=3&amp;t=3964&amp;start=60">5</a><span class="page-dots"> ... </span><a href="./viewtopic.php?f=3&amp;t=3964&amp;start=105">8</a> &nbsp;<a href="./viewtopic.php?f=3&amp;t=3964&amp;start=15">Next</a></b></td>
		
	</tr>
	</table>

</div>

<div id="pagefooter"></div>

<br clear="all" />
<table class="tablebg" width="100%" cellspacing="1" cellpadding="0" style="margin-top: 5px;">
	<tr>
		<td class="row1">
			<p class="breadcrumbs"><a href="./index.php">Board index</a> &#187; <a href="./viewforum.php?f=24">NES / Famicom</a> &#187; <a href="./viewforum.php?f=3">NESemdev</a></p>
			<p class="datetime">All times are UTC - 7 hours </p>
		</td>
	</tr>
	</table>
	<br clear="all" />

	<table class="tablebg" width="100%" cellspacing="1">
	<tr>
		<td class="cat"><h4>Who is online</h4></td>
	</tr>
	<tr>
		<td class="row1"><p class="gensmall">Users browsing this forum: No registered users and 1 guest</p></td>
	</tr>
	</table>


<br clear="all" />

<table width="100%" cellspacing="1">
<tr>
	<td width="40%" valign="top" nowrap="nowrap" align="left"></td>
	<td align="right" valign="top" nowrap="nowrap"><span class="gensmall">You <strong>cannot</strong> post new topics in this forum<br />You <strong>cannot</strong> reply to topics in this forum<br />You <strong>cannot</strong> edit your posts in this forum<br />You <strong>cannot</strong> delete your posts in this forum<br />You <strong>cannot</strong> post attachments in this forum<br /></span></td>
</tr>
</table>

<br clear="all" />

<table width="100%" cellspacing="0">
<tr>
	<td><form method="get" name="search" action="./search.php"><span class="gensmall">Search for:</span> <input class="post" type="text" name="keywords" size="20" /> <input class="btnlite" type="submit" value="Go" /><input type="hidden" name="t" value="3964" />
<input type="hidden" name="sf" value="msgonly" />
</form></td>
	<td align="right">
	<form method="post" name="jumpbox" action="./viewforum.php" onsubmit="if(document.jumpbox.f.value == -1){return false;}">

	<table cellspacing="0" cellpadding="0" border="0">
	<tr>
		<td nowrap="nowrap"><span class="gensmall">Jump to:</span>&nbsp;<select name="f" onchange="if(this.options[this.selectedIndex].value != -1){ document.forms['jumpbox'].submit() }">

		
			<option value="-1">Select a forum</option>
		<option value="-1">------------------</option>
			<option value="24">NES / Famicom</option>
		
			<option value="2">&nbsp; &nbsp;NESdev</option>
		
			<option value="3" selected="selected">&nbsp; &nbsp;NESemdev</option>
		
			<option value="21">&nbsp; &nbsp;NES Graphics</option>
		
			<option value="6">&nbsp; &nbsp;NES Music</option>
		
			<option value="9">&nbsp; &nbsp;NES Hardware and Flash Equipment</option>
		
			<option value="22">&nbsp; &nbsp;Homebrew Projects</option>
		
			<option value="10">&nbsp; &nbsp;Newbie Help Center</option>
		
			<option value="11">&nbsp; &nbsp;FCdev</option>
		
			<option value="18">&nbsp; &nbsp;NESdev China</option>
		
			<option value="19">&nbsp; &nbsp;NESdev International</option>
		
			<option value="25">Other</option>
		
			<option value="5">&nbsp; &nbsp;General Stuff</option>
		
			<option value="4">&nbsp; &nbsp;Membler Industries</option>
		
			<option value="12">&nbsp; &nbsp;SNESdev</option>
		
			<option value="20">&nbsp; &nbsp;GBDev</option>
		
			<option value="23">&nbsp; &nbsp;Other Retro Dev</option>
		
			<option value="15">&nbsp; &nbsp;Test Forum</option>
		
			<option value="26">Site Issues</option>
		
			<option value="13">&nbsp; &nbsp;phpBB Issues</option>
		
			<option value="14">&nbsp; &nbsp;Web Issues</option>
		
			<option value="16">&nbsp; &nbsp;nesdevWiki</option>
		

		</select>&nbsp;<input class="btnlite" type="submit" value="Go" /></td>
	</tr>
	</table>

	</form>
</td>
</tr>
</table>


</div>

<div id="wrapfooter">
	
	<span class="copyright">Powered by <a href="http://www.phpbb.com/">phpBB</a>&reg; Forum Software &copy; phpBB Group
	</span>
</div>

</body>
</html>