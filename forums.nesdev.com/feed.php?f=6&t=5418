<?xml version="1.0" encoding="UTF-8"?>
<feed xmlns="http://www.w3.org/2005/Atom" xml:lang="en-gb">
<link rel="self" type="application/atom+xml" href="http://forums.nesdev.com/feed.php?f=6&amp;t=5418" />

<title>nesdev.com</title>
<subtitle>NES Development and Strangulation Records message boards</subtitle>
<link href="http://forums.nesdev.com/index.php" />
<updated>2009-07-27T18:37:11-07:00</updated>

<author><name><![CDATA[nesdev.com]]></name></author>
<id>http://forums.nesdev.com/feed.php?f=6&amp;t=5418</id>
<entry>
<author><name><![CDATA[Gil-Galad]]></name></author>
<updated>2009-07-27T18:37:11-07:00</updated>
<published>2009-07-27T18:37:11-07:00</published>
<id>http://forums.nesdev.com/viewtopic.php?t=5418&amp;p=49266#p49266</id>
<link href="http://forums.nesdev.com/viewtopic.php?t=5418&amp;p=49266#p49266"/>
<title type="html"><![CDATA[Guerilla War NSF]]></title>

<content type="html" xml:base="http://forums.nesdev.com/viewtopic.php?t=5418&amp;p=49266#p49266"><![CDATA[
<div class="quotetitle">Fx3 wrote:</div><div class="quotecontent"><br /><div class="quotetitle">Gil-Galad wrote:</div><div class="quotecontent">I have up to date NSF players <strong>and emulators</strong> to test compatibility when I rip NSFs, even players that don't properly support $4017.<br /></div><br /><br />- <a href="http://rocknes.kinox.org" class="postlink">Of</a> course. ^_^;;</div><br /><br />I think that the circle visualization is pretty cool. Also that you can use a savestate with NSFs, that's interesting.<br /><br />How about adding support for the rest of the sound expansion channels if you can. A register viewer would be great, that doesn' t show FFh. Also more debugging tools.<p>Statistics: Posted by <a href="http://forums.nesdev.com/memberlist.php?mode=viewprofile&amp;u=43">Gil-Galad</a> — Mon Jul 27, 2009 6:37 pm</p><hr />
]]></content>
</entry>
<entry>
<author><name><![CDATA[Zepper]]></name></author>
<updated>2009-07-27T17:20:15-07:00</updated>
<published>2009-07-27T17:20:15-07:00</published>
<id>http://forums.nesdev.com/viewtopic.php?t=5418&amp;p=49261#p49261</id>
<link href="http://forums.nesdev.com/viewtopic.php?t=5418&amp;p=49261#p49261"/>
<title type="html"><![CDATA[Guerilla War NSF]]></title>

<content type="html" xml:base="http://forums.nesdev.com/viewtopic.php?t=5418&amp;p=49261#p49261"><![CDATA[
<div class="quotetitle">Gil-Galad wrote:</div><div class="quotecontent"><br />I have up to date NSF players <strong>and emulators</strong> to test compatibility when I rip NSFs, even players that don't properly support $4017.<br /></div><br /><br />- <a href="http://rocknes.kinox.org" class="postlink">Of</a> course. ^_^;;<p>Statistics: Posted by <a href="http://forums.nesdev.com/memberlist.php?mode=viewprofile&amp;u=39">Zepper</a> — Mon Jul 27, 2009 5:20 pm</p><hr />
]]></content>
</entry>
<entry>
<author><name><![CDATA[Gil-Galad]]></name></author>
<updated>2009-07-27T16:19:16-07:00</updated>
<published>2009-07-27T16:19:16-07:00</published>
<id>http://forums.nesdev.com/viewtopic.php?t=5418&amp;p=49259#p49259</id>
<link href="http://forums.nesdev.com/viewtopic.php?t=5418&amp;p=49259#p49259"/>
<title type="html"><![CDATA[Guerilla War NSF]]></title>

<content type="html" xml:base="http://forums.nesdev.com/viewtopic.php?t=5418&amp;p=49259#p49259"><![CDATA[
That's great that you figured out the real problem. I have up to date NSF players and emulators to test compatibility when I rip NSFs, even players that don't properly support $4017.<br /><br />Let us know if you try to fix Nestopia's $4017 problem.<p>Statistics: Posted by <a href="http://forums.nesdev.com/memberlist.php?mode=viewprofile&amp;u=43">Gil-Galad</a> — Mon Jul 27, 2009 4:19 pm</p><hr />
]]></content>
</entry>
<entry>
<author><name><![CDATA[koitsu]]></name></author>
<updated>2009-07-26T10:01:44-07:00</updated>
<published>2009-07-26T10:01:44-07:00</published>
<id>http://forums.nesdev.com/viewtopic.php?t=5418&amp;p=49228#p49228</id>
<link href="http://forums.nesdev.com/viewtopic.php?t=5418&amp;p=49228#p49228"/>
<title type="html"><![CDATA[Guerilla War NSF]]></title>

<content type="html" xml:base="http://forums.nesdev.com/viewtopic.php?t=5418&amp;p=49228#p49228"><![CDATA[
Thanks for the tip about the more-NSF-friendly version of FCEUXD SP!  This has shed some light on a couple of things.<br /><br />The most interesting of the bunch is that UGETAB's version of FCEUXD SP appears to play track 4 of the Guerilla War NSF correctly.  This would indicate the NSF itself is fine, but Notso Fatso and NEStopia have some kind of quirk/bug in their audio engine.  Then I saw this on <a href="http://www.angelfire.com/nc/ugetab/" class="postlink">UGETAB's page</a>:<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent"><br />NotSoFatso-UF's Version + Wave_Square.h update Simply UF's latest listed NotSoFatso source(09262007), with the Wave_Square.h file updated with some code that functions the way FCEUXDSP's sound code does. Makes 4017 inits work better.<br /></div><br /><br />I'll need to bust out Notso Fatso's code and get a diff, because the .rar on UGETAB's site only includes the modified .h, not the original, nor any comments in the code indicating what was changed...<br /><br />EDIT: It seems Drag's Notso Fatso version (labelled 0.86) also fixes this problem.  So yeah, it's a sound engine thing.  :-)  Seems Nestopia will need similar fixing...  <a href="http://nesdev.com/bbs/viewtopic.php?t=4653" class="postlink">http://nesdev.com/bbs/viewtopic.php?t=4653</a><p>Statistics: Posted by <a href="http://forums.nesdev.com/memberlist.php?mode=viewprofile&amp;u=3">koitsu</a> — Sun Jul 26, 2009 10:01 am</p><hr />
]]></content>
</entry>
<entry>
<author><name><![CDATA[Gil-Galad]]></name></author>
<updated>2009-07-25T18:28:03-07:00</updated>
<published>2009-07-25T18:28:03-07:00</published>
<id>http://forums.nesdev.com/viewtopic.php?t=5418&amp;p=49215#p49215</id>
<link href="http://forums.nesdev.com/viewtopic.php?t=5418&amp;p=49215#p49215"/>
<title type="html"><![CDATA[Guerilla War NSF]]></title>

<content type="html" xml:base="http://forums.nesdev.com/viewtopic.php?t=5418&amp;p=49215#p49215"><![CDATA[
That's some nice work there with the disassembly. I also suggest writing 0Fh to $4015 in your initialization code, just in case.<br /><br />Worst case scenario, I highly suggest to re-rip the NSF from the game. It's easy to isolate the music driver data from the ROM. You can dump in FCEU using the debugger in that version. Specify $8000 - $FFFF in the memory viewer and you're all set (after breaking on $4000 - $4008). Disassemble! You already know the init and play addresses. There is also the possibility that the rip you're working with has been over-optimized.<br /><br />UGETAB has made a NSF version of FCEUXDSP, where you can debug, use the hex editor and other features for NSFs. I don't really mess with FCEUX for NSF ripping. However, I have requested that they merge UGETAB's version with FCEUX.<p>Statistics: Posted by <a href="http://forums.nesdev.com/memberlist.php?mode=viewprofile&amp;u=43">Gil-Galad</a> — Sat Jul 25, 2009 6:28 pm</p><hr />
]]></content>
</entry>
<entry>
<author><name><![CDATA[koitsu]]></name></author>
<updated>2009-07-25T13:18:23-07:00</updated>
<published>2009-07-25T13:18:23-07:00</published>
<id>http://forums.nesdev.com/viewtopic.php?t=5418&amp;p=49203#p49203</id>
<link href="http://forums.nesdev.com/viewtopic.php?t=5418&amp;p=49203#p49203"/>
<title type="html"><![CDATA[Guerilla War NSF]]></title>

<content type="html" xml:base="http://forums.nesdev.com/viewtopic.php?t=5418&amp;p=49203#p49203"><![CDATA[
<div class="quotetitle">Gil-Galad wrote:</div><div class="quotecontent"><br />Try surfing the reset routine, often you'll find addresses being initialized for the sound driver.<br /></div><br /><br />What reset?  The NSF specification doesn't mention supporting the 6502 reset vector, but the docs are... well... I'm not going to go there.<br /><br />Maybe you mean the NSF INIT address?  If so: yeah, I've disassembled quite a lot (by hand) so far, starting with INIT -- that's what I meant by "this is proving to be a real bitch".  I haven't found any NES registers being adjusted at this point, this is all purely RAM setup ($01xx range).<br /><br />I can put up the 14KB of hand-disassembly I've done so far but it just continues on and on, and I've yet to find a single bit of code that touches a *any* NES register.  The decoded portion of the NSF header is below.  Sorry for the formatting mess, but the forum doesn't appear to translate literal tabs to 8 spaces.<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">Guerilla War.NSF &#40;from Zophar's NSF Archive&#41;<br /><br />0x0006 = $30      ; Total songs: $30<br />0x0007 = $01      ; Start with song #1<br />0x0008 = $0080      ; LOAD address = $8000  &#40;file offset 0x0080&#41;<br />0x000a = $00c0      ; INIT address = $C000  &#40;file offset 0x4080&#41;<br />0x000c = $2480      ; PLAY address = $8024  &#40;file offset 0x00a4&#41;<br />0x0070 = $00      ; no bankswitching used<br />......         ; no bankswitching used<br />0x0077 = $00      ; no bankswitching used<br /><br />0x0080 = Bank 0, located at $8000<br />0x1080 = Bank 1, located at $9000<br />0x2080 = Bank 2, located at $A000<br />0x3080 = Bank 3, located at $B000<br />0x4080 = Bank 4, located at $C000<br /><br />; !!! INIT address<br />; ORG $C000   &#40;file offset 0x4080&#41;<br />;<br />; 0x4080 = AA BD 0A C0 8D 00 01 4C 2B 80 0B 0F 19 08 17 03<br />; 0x4090 = 05 06 1B 13 10 1C 0D 15 04 01 20 21 22 23 24 25<br />; 0x40A0 = 26 27 28 29 2A 2B 2C 2D 2E 2F 30 31 32 33 34 35<br />; 0x40B0 = 36 37 38 39 3A 3B 3C 3D 3E 3F<br />;<br />; reg A = song #<br />; reg X = NTSC&#40;0&#41; or PAL&#40;1&#41;<br />;<br />0x4080   AA      tax      ; Song number --&gt; X index<br />0x4081   BD0AC0      lda $c00a,x   ; ...and load from table at $c00a &#40;file offset 0x408a&#41;<br />0x4084   8D0001      sta $0100<br />0x4087   4C2B80      jmp L802B   ; jump to label L802B<br /><br /></div><br /><br />Well I moved the original INIT address from $C000 to $BFF0 and changed the code from the above to:<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">0x4070   AA      tax      ; Song number --&gt; X index<br />0x4071   BD0AC0      lda $c00a,x   ; ...and load from table at $c00a &#40;file offset 0x408a&#41;<br />0x4074   8D0001      sta $0100<br />0x4077   A980      lda #$80<br />0x4079   8D1740      sta $4017<br />0x407c   4C2B80      jmp L802B   ; jump to label L802B<br /></div><br /><br />Sadly no difference.  It also seems that FXEUX 2.1.0's debugger is "weird" with NSFs; I added a breakpoint for r/w/x on $4017 and reloaded the NSF, but it never got triggered, indicating the emulator doesn't appear to utilise breakpoints for NSFs (INIT, PLAY, or LOAD).  I also tried a BP for $4000, same thing.  Awesome.<p>Statistics: Posted by <a href="http://forums.nesdev.com/memberlist.php?mode=viewprofile&amp;u=3">koitsu</a> — Sat Jul 25, 2009 1:18 pm</p><hr />
]]></content>
</entry>
<entry>
<author><name><![CDATA[Gil-Galad]]></name></author>
<updated>2009-07-24T10:58:36-07:00</updated>
<published>2009-07-24T10:58:36-07:00</published>
<id>http://forums.nesdev.com/viewtopic.php?t=5418&amp;p=49168#p49168</id>
<link href="http://forums.nesdev.com/viewtopic.php?t=5418&amp;p=49168#p49168"/>
<title type="html"><![CDATA[Guerilla War NSF]]></title>

<content type="html" xml:base="http://forums.nesdev.com/viewtopic.php?t=5418&amp;p=49168#p49168"><![CDATA[
<div class="quotetitle">koitsu wrote:</div><div class="quotecontent"><br />Wow, this is proving to be a real bitch.  I'm still digging for that routine.<br /></div><br /><br />Try surfing the reset routine, often you'll find addresses being initialized for the sound driver.<br /><br />When I rip NSFs, I run a test on the NSF to detect read without writing. Track those down as well.<p>Statistics: Posted by <a href="http://forums.nesdev.com/memberlist.php?mode=viewprofile&amp;u=43">Gil-Galad</a> — Fri Jul 24, 2009 10:58 am</p><hr />
]]></content>
</entry>
<entry>
<author><name><![CDATA[koitsu]]></name></author>
<updated>2009-07-17T14:15:44-07:00</updated>
<published>2009-07-17T14:15:44-07:00</published>
<id>http://forums.nesdev.com/viewtopic.php?t=5418&amp;p=49005#p49005</id>
<link href="http://forums.nesdev.com/viewtopic.php?t=5418&amp;p=49005#p49005"/>
<title type="html"><![CDATA[Guerilla War NSF]]></title>

<content type="html" xml:base="http://forums.nesdev.com/viewtopic.php?t=5418&amp;p=49005#p49005"><![CDATA[
Wow, this is proving to be a real bitch.  I'm still digging for that routine.<p>Statistics: Posted by <a href="http://forums.nesdev.com/memberlist.php?mode=viewprofile&amp;u=3">koitsu</a> — Fri Jul 17, 2009 2:15 pm</p><hr />
]]></content>
</entry>
<entry>
<author><name><![CDATA[Memblers]]></name></author>
<updated>2009-07-17T10:34:27-07:00</updated>
<published>2009-07-17T10:34:27-07:00</published>
<id>http://forums.nesdev.com/viewtopic.php?t=5418&amp;p=48992#p48992</id>
<link href="http://forums.nesdev.com/viewtopic.php?t=5418&amp;p=48992#p48992"/>
<title type="html"><![CDATA[Guerilla War NSF]]></title>

<content type="html" xml:base="http://forums.nesdev.com/viewtopic.php?t=5418&amp;p=48992#p48992"><![CDATA[
It may have to do with the $4017 register, "Frame Sequencer".  That'd be my guess.<br /><a href="http://nesdev.com/apu_ref.txt" class="postlink">http://nesdev.com/apu_ref.txt</a><br /><br />Could try changing what is written to $4017 (if anything) in the init routine.<p>Statistics: Posted by <a href="http://forums.nesdev.com/memberlist.php?mode=viewprofile&amp;u=10">Memblers</a> — Fri Jul 17, 2009 10:34 am</p><hr />
]]></content>
</entry>
<entry>
<author><name><![CDATA[koitsu]]></name></author>
<updated>2009-07-17T10:14:28-07:00</updated>
<published>2009-07-17T10:14:28-07:00</published>
<id>http://forums.nesdev.com/viewtopic.php?t=5418&amp;p=48991#p48991</id>
<link href="http://forums.nesdev.com/viewtopic.php?t=5418&amp;p=48991#p48991"/>
<title type="html"><![CDATA[Guerilla War NSF]]></title>

<content type="html" xml:base="http://forums.nesdev.com/viewtopic.php?t=5418&amp;p=48991#p48991"><![CDATA[
Seems the two Guerilla War NSFs floating around (Kevin Horton's version and the one on zophar.net) have some issues with Track 4 (stage 3 in the game).<br /><br />Nestopia, when playing the actual game/ROM, sounds correct.  But when playing the NSF, the square channels in Track 4 sound incorrect (durations are too short sometimes).  Notso Fatso sounds similar.<br /><br />Given that I haven't worked with the NSF format before, I'm grasping at straws here, but my guess is that there's some value in RAM which isn't being set correctly in the NSF, which the ripper(s) didn't notice because their ears aren't so great or because they just didn't listen close enough.  :-)  Here's the audio as played by Nestopia:<br /><br />Guerilla War (in game): <a href="http://www.malkavian.com/~jdc/gw_ingame.wav" class="postlink">http://www.malkavian.com/~jdc/gw_ingame.wav</a> (1.8MB)<br />Guerilla War (NSF): <a href="http://www.malkavian.com/~jdc/gw_nsf.wav" class="postlink">http://www.malkavian.com/~jdc/gw_nsf.wav</a> (1.8MB)<br /><br />I'm looking to fix it, but I'd like some pointers/advice from folks on how to go about doing this.<p>Statistics: Posted by <a href="http://forums.nesdev.com/memberlist.php?mode=viewprofile&amp;u=3">koitsu</a> — Fri Jul 17, 2009 10:14 am</p><hr />
]]></content>
</entry>
</feed>