<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html dir="ltr" lang="en-gb">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta http-equiv="Content-Style-Type" content="text/css">
<meta http-equiv="Content-Language" content="en-gb">
<title>nesdev.com :: View topic - About (Quietust's?) scanline demo..</title>

<style type="text/css">
<!--

body {
	font-family: Verdana,serif;
	font-size: 10pt;
}

img {
	border: 0;
}

td {
	font-family: Verdana,serif;
	font-size: 10pt;
	line-height: 150%;
}

.code, .codecontent, 
.quote, .quotecontent {
	margin: 0 5px 0 5px;
	padding: 5px;
	font-size: smaller;
	border: black solid 1px;
}

.quotetitle {
	color: black;
	display : block;
	font-weight: bold;
}

.forum {
	font-family: Arial,Helvetica,sans-serif;
	font-weight: bold;
	font-size: 18pt;
}

.topic {
	font-family: Arial,Helvetica,sans-serif;
	font-size: 14pt;
	font-weight: bold;
}

.gensmall {
	font-size: 8pt;
}

hr {
	color: #888;
	height: 3px;
	border-style: solid;
}

hr.sep {
	color: #aaa;
	height: 1px;
	border-style: dashed;
}
//-->
</style>

</head>
<body>

<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
<tr>
	<td colspan="2" align="center"><span class="Forum">nesdev.com</span><br /><span class="gensmall"><a href="http://forums.nesdev.com/">http://forums.nesdev.com/</a></span></td>
</tr>
<tr>
	<td colspan="2"><br /></td>
</tr>
<tr>
	<td><span class="topic">About (Quietust's?) scanline demo..</span><br /><span class="gensmall"><a href="http://forums.nesdev.com/viewtopic.php?f=3&amp;t=3189">http://forums.nesdev.com/viewtopic.php?f=3&amp;t=3189</a></span></td>
	<td align="right" valign="bottom"><span class="gensmall">Page <strong>1</strong> of <strong>1</strong></span></td>
</tr>
</table>



	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Muchaserres</b> [ Sun Apr 08, 2007 7:46 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>About (Quietust's?) scanline demo..</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Hi all,
<br />
<br />Some time ago someone posted on this forums a demo meant to be "a test for proper mid-scanline PPU write emulation", toggling D3 of $2001 and D4 of $2000 at different times.
<br />
<br />Does anyone know anything about its timing? Any source code available? Any emu running it properly?
<br />
<br />A photo of it running on the real thing was posted too. I still have a copy of it, in case someone needs it..
<br />
<br />Thx.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Kinopio</b> [ Mon Apr 09, 2007 10:15 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />I guess you mean scanline.nes?
<br />
<br />You can find it at quietust's homepage. The zip-archive also contains
<br />the source to it. Here is a link: <!-- m --><a class="postlink" href="http://qmt.ath.cx/~nes/demos/scanline.zip">http://qmt.ath.cx/~nes/demos/scanline.zip</a><!-- m -->
<br />
<br />I have always wondered how this demo looks like on a real nes.
<br />If you have a photo of it running I would really like to have it. <img src="./images/smilies/icon_smile.gif" alt=":)" title="Smile" />
<br />
<br />In my emu no stars are shown but the vertical lines between the text and
<br />stars flickers on test 2 and 3. Have not really looked into why it does that.
<br />Does anyone have a clue?
<br />
<br />Nestopia runs this demo without any flickering and in nintendulator the
<br />lines flicker sometimes between soft resets if I remember correctly.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Muchaserres</b> [ Mon Apr 09, 2007 10:54 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Uhm, it seems I have an older version of this demo. Anyway, even if this older version is buggy, an accurate emulator should reproduce exactly what a real NES outputs while running it. Quietust may put some light on this..
<br />
<br />I've uploaded both the version I have and a screenshot of (supposedly) its behaviour on the real thing (dunno its author).
<br />
<br /><a href="http://www.geocities.com/muchaserres/scanline.zip" class="postlink">http://www.geocities.com/muchaserres/scanline.zip</a>
<br /><a href="http://www.geocities.com/muchaserres/scanline.jpg" class="postlink">http://www.geocities.com/muchaserres/scanline.jpg</a>

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Hyde</b> [ Mon Apr 09, 2007 4:33 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Memblers took that picture for me a while back. That test's behavior varies from a reset state to another.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Kinopio</b> [ Mon Apr 09, 2007 4:43 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Sorry about that. I thought you were talking about the new version not the old buggy one.  <img src="./images/smilies/icon_redface.gif" alt=":oops:" title="Embarassed" /> 
<br />
<br /><div class="quotetitle">Muchaserres wrote:</div><div class="quotecontent">Anyway, even if this older version is buggy, an accurate emulator should reproduce exactly what a real NES outputs while running it. Quietust may put some light on this.. <br /></div>
<br />
<br />I agree, so the photo is still valuable for me. Thanks for sharing it.
<br />To bad Quietust has left (temporarily?) this forum.  <img src="./images/smilies/icon_cry.gif" alt=":cry:" title="Crying or Very sad" />

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Zepper</b> [ Mon Apr 09, 2007 7:03 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />No clues, but Q <em>probably</em> did run that demo in a NES, and after in his emulator, as a program coded by an human is never free of errors.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Hyde</b> [ Thu Apr 12, 2007 8:13 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Again, there is no room for speculation here. That demo actually works on an NES. I'm not too sure of which version it was that I sent Memblers, but he was the one that took that picture. That's how it looks. As I said, the output may vary from reset to reset.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Muchaserres</b> [ Fri Apr 13, 2007 5:11 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">Hyde wrote:</div><div class="quotecontent">As I said, the output may vary from reset to reset.</div>
<br />Why is that? Which are the conditionants?

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Kinopio</b> [ Fri Apr 13, 2007 6:36 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">Muchaserres wrote:</div><div class="quotecontent"><div class="quotetitle">Hyde wrote:</div><div class="quotecontent">As I said, the output may vary from reset to reset.</div><br />Why is that? Which are the conditionants?</div>
<br />
<br />I think it varys because the PPU runs at a different frequency than the CPU causing them to have different alignment between resets.
<br />You can read a little more about it here: <!-- m --><a class="postlink" href="http://nesdevwiki.ath.cx/wiki/index.php/PPU_Frame_Timing">http://nesdevwiki.ath.cx/wiki/index.php ... ame_Timing</a><!-- m -->
<br />in the "CPU-PPU Clock Alignment" section. I'm not sure though.  <img src="./images/smilies/icon_confused.gif" alt=":?" title="Confused" />
<br />
<br />How does one emulate this behaviour correctly?
<br />
<br />Does anyone now what is needed to emulate this demo correctly?

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>blargg</b> [ Sat Apr 14, 2007 8:56 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />One can simply emulate the unlikely situation where the NES powers up with the same PPU-CPU synchronization every time.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Kinopio</b> [ Sat Apr 14, 2007 10:06 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">blargg wrote:</div><div class="quotecontent">One can simply emulate the unlikely situation where the NES powers up with the same PPU-CPU synchronization every time.</div>
<br />
<br />Im not sure I understand this. I want to emulate the different alignments like the real NES. But after I got a night of sleep I think that this should be easy to emulate just by changing randomly (a few ppu clocks) where the PPU starts.
<br />
<br />Speaking of PPU power up and reset. Where does the PPU start (scanline and cycle) and what values does the PPU-registers and memory (nametable, palette and OAM) contains after power up and reset? I guess the memory parts are a bit random and probably differ between different hardware-versions.
<br />
<br />I have noticed that you can change the appearance off scanline.nes just by changing where the PPU starts with a few clocks. I also remember a thread here at nesdev mentioned a few games that needed correct PPU start up to work.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>dvdmth</b> [ Sat Apr 14, 2007 1:14 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Others likely know more precisely, but if I remember right the PPU starts somewhere in the dummy scanline (the one before the first on-screen one) after power-up and reset.  On power-up the V-Blank flag is set, a detail that must be emulated to prevent a frame IRQ from firing in a particular game (forget which game it was).  On reset the V-Blank flag is left unchanged (usually clear).
<br />
<br />In NTSC, the CPU and PPU both run at multiples of 4 of the master clock signal (a PPU cycle is 4 master clocks while a CPU cycle is 12).  Thus, there are four possible alignments between the CPU and PPU.  For PAL, there is no common denominator between the CPU and PPU clock speeds, so there is really only one alignment (although where within the alignment execution starts can vary).  Differences in alignment particularly show up with edge-case scenarios (e.g. reading $2002 right at the start of V-Blank).  Handling these scenarios can be tricky if multiple alignments are allowed to occur.  In short, just adding a random factor to the PPU start position isn't necessarily enough to ensure proper emulation of different alignments.
<br />
<br />The SNES is much cleaner here - it has been measured that the SNES powers up in exactly the same alignment and state every time, so there's no random factors to deal with at all.  It would've been nice if the NES were also that way, but alas it is not.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>blargg</b> [ Sat Apr 14, 2007 2:24 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">dvdmth wrote:</div><div class="quotecontent">Differences in alignment particularly show up with edge-case scenarios (e.g. reading $2002 right at the start of V-Blank). Handling these scenarios can be tricky if multiple alignments are allowed to occur. In short, just adding a random factor to the PPU start position isn't necessarily enough to ensure proper emulation of different alignments.</div><br />This is definitely true; it's not a matter of the CPU starting at different whole PPU clocks (though that might be occurring too), it's sub-PPU clock differences. As (should be) noted on the Wiki page, the timing only covers one of the power-up states (the one with the fewest special cases). As I remember, in another state you could get the special $2002 read case on two different PPU clocks instead of just one. Who knows how many other things behave differently based on this; someone with more than 24 hours a day might like to systematically check all this. :)<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">The SNES is much cleaner here - it has been measured that the SNES powers up in exactly the same alignment and state every time, so there's no random factors to deal with at all.</div>
<br />Unfortunately this doesn't apply to the SNES APU (internal timers and DSP can start up with different synchronization sometimes). But then again it runs on its own clock, so it's already asynchronous to the SNES and thus has varying synchronizations and clock ratios anyway.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Zepper</b> [ Sat Apr 14, 2007 3:44 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">dvdmth wrote:</div><div class="quotecontent">On power-up the V-Blank flag is set, a detail that must be emulated to prevent a frame IRQ from firing in a particular game (forget which game it was).  On reset the V-Blank flag is left unchanged (usually clear).</div>
<br />
<br />That's true, it's an 'old' issue I noticed during a few debugs, opposing to a few others, hehehehe <img src="./images/smilies/icon_razz.gif" alt=":P" title="Razz" />

		

		</td>
	</tr>
	</table>


<hr width="85%" />

<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
<tr>
	<td><span class="gensmall">Page <strong>1</strong> of <strong>1</strong></span></td>
	<td align="right"><span class="gensmall">All times are UTC - 7 hours </span></td>
</tr>
<tr>
	<td colspan="2" align="center"><span class="gensmall">Powered by phpBB&reg; Forum Software &copy; phpBB Group<br />http://www.phpbb.com/</span></td>
</tr>
</table>

</body>
</html>