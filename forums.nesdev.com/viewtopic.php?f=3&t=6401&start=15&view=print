<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html dir="ltr" lang="en-gb">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta http-equiv="Content-Style-Type" content="text/css">
<meta http-equiv="Content-Language" content="en-gb">
<title>nesdev.com :: View topic - young indiana jones new ppu discovery, nestopia help...</title>

<style type="text/css">
<!--

body {
	font-family: Verdana,serif;
	font-size: 10pt;
}

img {
	border: 0;
}

td {
	font-family: Verdana,serif;
	font-size: 10pt;
	line-height: 150%;
}

.code, .codecontent, 
.quote, .quotecontent {
	margin: 0 5px 0 5px;
	padding: 5px;
	font-size: smaller;
	border: black solid 1px;
}

.quotetitle {
	color: black;
	display : block;
	font-weight: bold;
}

.forum {
	font-family: Arial,Helvetica,sans-serif;
	font-weight: bold;
	font-size: 18pt;
}

.topic {
	font-family: Arial,Helvetica,sans-serif;
	font-size: 14pt;
	font-weight: bold;
}

.gensmall {
	font-size: 8pt;
}

hr {
	color: #888;
	height: 3px;
	border-style: solid;
}

hr.sep {
	color: #aaa;
	height: 1px;
	border-style: dashed;
}
//-->
</style>

</head>
<body>

<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
<tr>
	<td colspan="2" align="center"><span class="Forum">nesdev.com</span><br /><span class="gensmall"><a href="http://forums.nesdev.com/">http://forums.nesdev.com/</a></span></td>
</tr>
<tr>
	<td colspan="2"><br /></td>
</tr>
<tr>
	<td><span class="topic">young indiana jones new ppu discovery, nestopia help...</span><br /><span class="gensmall"><a href="http://forums.nesdev.com/viewtopic.php?f=3&amp;t=6401">http://forums.nesdev.com/viewtopic.php?f=3&amp;t=6401</a></span></td>
	<td align="right" valign="bottom"><span class="gensmall">Page <strong>2</strong> of <strong>14</strong></span></td>
</tr>
</table>



	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>jwdonal</b> [ Tue Jun 08, 2010 10:11 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />That is *extremely* odd since the game writes to a mapper register in order to set the appropriate mirroring.....I don't understand that at all!   <img src="./images/smilies/icon_eek.gif" alt=":shock:" title="Shocked" />
<br />
<br />And you even said you checked the CRC of multiple ROM dumps.  Why the heck would the game write the wrong mirroring value??  I mean, obviously it doesn't really since it works in the original NES.  But....I know that my H/V mirroring bit in my mapper is correct since it works for so many other games.  And obviously, the emus aren't going to have the H/V reversed since it would clearly break many other MMC3 games.  What the heck is going on here!?!?

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>jwdonal</b> [ Tue Jun 08, 2010 10:15 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">James wrote:</div><div class="quotecontent">I switched to vertical mirroring mode...</div>
<br />Wait, how did you switch the mirroring mode?  You would have to modify the ROM code of the game.  How did you know what hex data to change?

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>*Spitfire_NES*</b> [ Tue Jun 08, 2010 10:22 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />here is a link to JUST the ips patch. the scrolling is still GOD-AWFUL on level 2  but now tolerable. Also when the cannonball touches the ground on level 1 near the end it does not turn red. 
<br />
<br /><!-- m --><a class="postlink" href="http://www.detach.republika.pl/IndyVscrollOFF.ips">http://www.detach.republika.pl/IndyVscrollOFF.ips</a><!-- m --> 
<br />
<br />With this hex you did does that fix stuff? id love to know if you got something working correctly as this patch only turns off the vertical scrolling. enjoy!  <img src="./images/smilies/icon_smile.gif" alt=":)" title="Smile" />

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>James</b> [ Wed Jun 09, 2010 3:58 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">jwdonal wrote:</div><div class="quotecontent"><div class="quotetitle">James wrote:</div><div class="quotecontent">I switched to vertical mirroring mode...</div><br />Wait, how did you switch the mirroring mode?</div>
<br />I was running it in FCEUXD and just changed the mirroring mode in the name table viewer.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>James</b> [ Wed Jun 09, 2010 8:42 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />I think I've found the problem!  I'll post more details when I get home from work and have a chance to perform some more tests (the cannon ball section looks good, but I haven't tested level 2, nor have I verified that I haven't broken anything else in the process).
<br />
<br /><div class="quotetitle">*Spitfire_NES* wrote:</div><div class="quotecontent">maybe it has nothing to do with the mmc3 at all perhaps??<br /></div><br />nothing to do with mmc3<br /><br /><div class="quotetitle">jwdonal wrote:</div><div class="quotecontent">fixing this bug might lead to a new discovery of the inner workings of the NES, or correct an assumption or conclusion that was incorrectly made it the past<br /></div>
<br />maybe <img src="./images/smilies/icon_smile.gif" alt=":)" title="Smile" />

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>*Spitfire_NES*</b> [ Wed Jun 09, 2010 12:40 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />can't wait to hear it man do let us know when you get a chance! <img src="./images/smilies/icon_smile.gif" alt=":)" title="Smile" />

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>jwdonal</b> [ Wed Jun 09, 2010 12:44 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">James wrote:</div><div class="quotecontent"><div class="quotetitle">jwdonal wrote:</div><div class="quotecontent"><div class="quotetitle">James wrote:</div><div class="quotecontent">I switched to vertical mirroring mode...</div><br />Wait, how did you switch the mirroring mode?</div><br />I was running it in FCEUXD and just changed the mirroring mode in the name table viewer.</div>
<br />
<br />That's awesome.  I need to check out FCEUXD sometime soon.  I hear lots about it.
<br />
<br />I am eager to hear of your discovery as well.  Don't let us down now that you have us all psyched up!! <img src="./images/smilies/icon_surprised.gif" alt=":-o" title="Surprised" />

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>James</b> [ Wed Jun 09, 2010 11:42 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><a href="http://www.youtube.com/watch?v=U4YtfMI1pOY" class="postlink">Check out the video -- it looks good to me!</a>
<br />
<br />Long story short, incrementing the PPU's vram address by 1 or 32 on $2007 access is only correct when rendering is disabled.  The game, however, is reading $2007 mid-screen.  It seems that accesses to $2007 during rendering affect the vram address the same way that normal rendering does.  In other words, accessing $2007 mid-screen 'clocks' the counters as described in the 'VRAM access during rendering' section of Brad Taylor's 2C02 doc.
<br />
<br />Here's my fix.  This is called on reads/writes to $2007.
<br />
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">void c_nes::c_ppu::update_vram_address&#40;&#41;<br />&#123;<br />&nbsp; &nbsp;if &#40;rendering&#41;<br />&nbsp; &nbsp;&#123;<br />&nbsp; &nbsp;&nbsp; &nbsp;if &#40;address_increment == 32&#41;<br />&nbsp; &nbsp;&nbsp; &nbsp;&#123;<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;if &#40;&#40;vram_address &amp; 0x7000&#41; == 0x7000&#41;<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&#123;<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;vram_address &amp;= 0x0FFF;<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;switch &#40;vram_address &amp; 0x03E0&#41;<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&#123;<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;case 0x03A0:<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;vram_address ^= 0x0800;<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;case 0x03E0:<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;vram_address &amp;= 0xFC1F;<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;break;<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;default:<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;vram_address += 0x0020;<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&#125;<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&#125;<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;else<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;vram_address += 0x1000;<br />&nbsp; &nbsp;&nbsp; &nbsp;&#125;<br />&nbsp; &nbsp;&nbsp; &nbsp;else<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;//TODO: this is, more than likely, wrong.<br />&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;vram_address++;<br />&nbsp; &nbsp;&#125;<br />&nbsp; &nbsp;else<br />&nbsp; &nbsp;&nbsp; &nbsp;vram_address = &#40;vram_address + address_increment&#41; &amp; 0x7FFF;<br />&#125;<br /></div>
<br />
<br />I've put the fix in nemulator 2.1.4, which can be downloaded from <a href="http://nemulator.com" class="postlink">http://nemulator.com</a>, if you'd like to check it out.
<br />
<br />edit: fixed a typo in the code

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Disch</b> [ Thu Jun 10, 2010 10:36 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />That's interesting.  It kind of makes sense in a way.
<br />
<br />I wonder if inc-by-1 mode does the same wrapping around the nametable thing.
<br />
<br />Like...
<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">&nbsp; &nbsp; &nbsp; else&nbsp; &nbsp;// inc-by-1<br />&nbsp; &nbsp; &nbsp; &#123;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if&#40;&#40;vram_address &amp; 0x001F&#41; == 0x001F&#41;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; vram_address ^= 0x041F;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;else<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ++vram_address;<br />&nbsp; &nbsp; &nbsp; &#125;<br /></div>

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>James</b> [ Thu Jun 10, 2010 11:05 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">Disch wrote:</div><div class="quotecontent">I wonder if inc-by-1 mode does the same wrapping around the nametable thing.<br /></div>
<br />That's what I'm thinking as well.  I didn't bother with it yet, though, since I don't know how I'd test it.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>jwdonal</b> [ Thu Jun 10, 2010 11:11 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Is it just me or is this absolutely incredible?  James has actually made a new discovery on the inner workings of the NES PPU after all these years and after so many emulators.  And the chances of anyone discovering this were almost nil - I'm guessing that young indiana is one of extremely few games (the only game??) that would have this problem.  Who knows what other oddities this might fix in various games.  And Disch doesn't even have any beef with it - that's pretty much validation of your discovery right there.
<br />
<br />Nice work James!!   <img src="./images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" />
<br />
<br />EDIT: Should James make a new post for this discovery to grab peoples attention?  Something other than "young indiana jones..." - more like "New PPU Rendering Discovery" or whatever.  Just a thought.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>tepples</b> [ Thu Jun 10, 2010 12:17 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />So a read during rendering skips a scanline if inc by 32 or a column if inc by 1. Do I understand right? I wonder what sort of race condition this has with normal rendering.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>*Spitfire_NES*</b> [ Thu Jun 10, 2010 12:33 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />great work james! im gonna try to get this implemented into nestopia! i cannot for one, thank you enough my man! and it looks great in action too!
<br />
<br />i thank everyone for even responding in my thread and can't wait to see what else you guys can do. un-friggin believable!   <img src="./images/smilies/icon_lol.gif" alt=":lol:" title="Laughing" />  a round for everyone! lmao

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>James</b> [ Thu Jun 10, 2010 1:04 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">jwdonal wrote:</div><div class="quotecontent">Nice work James!!   <img src="./images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /><br /></div><br /><div class="quotetitle">*Spitfire_NES* wrote:</div><div class="quotecontent">great work james!<br /></div><br />Thanks, guys!<br /><br /><div class="quotetitle">tepples wrote:</div><div class="quotecontent">So a read during rendering skips a scanline if inc by 32 or a column if inc by 1<br /></div>
<br />Yeah, that sounds about right to me, though I haven't tested the latter behavior.
<br />
<br />edit: just a little clarification here.  Instead of saying 'skips a scanline' I might say that a read during rendering, if address_increment == 32, will point the vram address to the next scanline's data.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>tokumaru</b> [ Thu Jun 10, 2010 2:29 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />It's amazing that this community still makes discoveries like this. Nice work, James.

		

		</td>
	</tr>
	</table>


<hr width="85%" />

<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
<tr>
	<td><span class="gensmall">Page <strong>2</strong> of <strong>14</strong></span></td>
	<td align="right"><span class="gensmall">All times are UTC - 7 hours </span></td>
</tr>
<tr>
	<td colspan="2" align="center"><span class="gensmall">Powered by phpBB&reg; Forum Software &copy; phpBB Group<br />http://www.phpbb.com/</span></td>
</tr>
</table>

</body>
</html>