<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html dir="ltr" lang="en-gb">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta http-equiv="Content-Style-Type" content="text/css">
<meta http-equiv="Content-Language" content="en-gb">
<title>nesdev.com :: View topic - Super Mario Bros 1 Menu not working</title>

<style type="text/css">
<!--

body {
	font-family: Verdana,serif;
	font-size: 10pt;
}

img {
	border: 0;
}

td {
	font-family: Verdana,serif;
	font-size: 10pt;
	line-height: 150%;
}

.code, .codecontent, 
.quote, .quotecontent {
	margin: 0 5px 0 5px;
	padding: 5px;
	font-size: smaller;
	border: black solid 1px;
}

.quotetitle {
	color: black;
	display : block;
	font-weight: bold;
}

.forum {
	font-family: Arial,Helvetica,sans-serif;
	font-weight: bold;
	font-size: 18pt;
}

.topic {
	font-family: Arial,Helvetica,sans-serif;
	font-size: 14pt;
	font-weight: bold;
}

.gensmall {
	font-size: 8pt;
}

hr {
	color: #888;
	height: 3px;
	border-style: solid;
}

hr.sep {
	color: #aaa;
	height: 1px;
	border-style: dashed;
}
//-->
</style>

</head>
<body>

<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
<tr>
	<td colspan="2" align="center"><span class="Forum">nesdev.com</span><br /><span class="gensmall"><a href="http://forums.nesdev.com/">http://forums.nesdev.com/</a></span></td>
</tr>
<tr>
	<td colspan="2"><br /></td>
</tr>
<tr>
	<td><span class="topic">Super Mario Bros 1 Menu not working</span><br /><span class="gensmall"><a href="http://forums.nesdev.com/viewtopic.php?f=3&amp;t=9748">http://forums.nesdev.com/viewtopic.php?f=3&amp;t=9748</a></span></td>
	<td align="right" valign="bottom"><span class="gensmall">Page <strong>1</strong> of <strong>3</strong></span></td>
</tr>
</table>



	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>miguelfsp</b> [ Sun Jan 27, 2013 8:17 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Super Mario Bros 1 Menu not working</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Hello guys,<br /><br />After lots of work I now seem to be kind of stuck in trying to emulate Super Mario Bros. The problem is that I'm stuck at the menu. I can never enter the real game, it is not responding to  key presses! Now that I implemented sprite0 hit and scrolling, after waiting a while Mario starts &quot;moving by himself&quot;, like it should, but I can never really start a game to play by pressing start!<br /><br />I pass all the 11 Nestress first PPU tests. When I run a sprite0 hit basic test, it only fails with code &quot;4&quot; (4) Should miss when background rendering is off), but so fails JNes emulator... And it perfectly runs SMB1, so this shouldn't be related.<br /><br />Also, pacman's screen has a yellow &quot;something&quot; in the top-left part of the screen (please check out the screenshot). I don't know if there's some odd bug in scrolling/sprite0 but I just can't figure it out... Do you guys have any suggestions or something like that? I'm really stuck<br /><br />*<strong>Edit</strong>: All right, this pacman &quot;bug&quot; is ok, I was using JNes and it's JNes fault...*<br /><br />Thanks a lot for your patiente guys!

		
			<br clear="all" /><br />

			<table class="tablebg" width="100%" cellspacing="1">
			<tr>
				<td><b class="genmed">Attachments: </b></td>
			</tr>
			
				<tr>
					<td>
			<span class="gensmall"><b>File comment:</b> mario starts moving but can never enter the game itself, no matter what keys I press</span><br />
		
			<a href="./download/file.php?id=333&amp;mode=view"><img src="./download/file.php?id=333&amp;t=1" alt="smb.png" /></a><br />
			<span class="gensmall">smb.png [ 36.82 KiB | Viewed 535 times ]</span>
		

		<br />
	</td>
				</tr>
			
				<tr>
					<td>
			<span class="gensmall"><b>File comment:</b> pacman with that messy yellow stuff in top-left</span><br />
		
			<a href="./download/file.php?id=332&amp;mode=view"><img src="./download/file.php?id=332&amp;t=1" alt="pacmess.png" /></a><br />
			<span class="gensmall">pacmess.png [ 38.49 KiB | Viewed 535 times ]</span>
		

		<br />
	</td>
				</tr>
			
			</table>
		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>thefox</b> [ Sun Jan 27, 2013 9:05 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: Super Mario Bros 1 Menu not working</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">miguelfsp wrote:</div><div class="quotecontent">Also, pacman's screen has a yellow &quot;something&quot; in the top-left part of the screen (please check out the screenshot). I don't know if there's some odd bug in scrolling/sprite0 but I just can't figure it out... Do you guys have any suggestions or something like that? I'm really stuck</div><br />When you encounter something like that, the first thing you should try is to see if other &quot;good&quot; emulators behave the same way (in which case 99.995% of the time that behavior is correct). In this case the answer is yes.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>miguelfsp</b> [ Sun Jan 27, 2013 9:46 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: Super Mario Bros 1 Menu not working</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Oh, you're right, sorry! I was convinced that it was wrong. Just tried with nintendulator and works the same way... I guess my emulator is better than jnes then <img src="./images/smilies/icon_smile.gif" alt=":)" title="Smile" /><br /><br />But still can't figure out the SMB1 messed up menu... It simply does not respond to keys (and yes, the main standart controller is implemented and works fine in all the other games). You got any suggestions or something? :/

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>blargg</b> [ Sun Jan 27, 2013 10:58 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: Super Mario Bros 1 Menu not working</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />What are you returning when the game reads more than 8 bits from the controller?

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Drag</b> [ Sun Jan 27, 2013 11:05 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: Super Mario Bros 1 Menu not working</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />In most cases, if there's some garbage in the top left corner of the screen (usually hidden because NTSC doesn't show the top 8 to 16 scanlines), it's because the game initializes the sprite OAM with all 0s, which gets interpreted as &quot;put sprite tile 0 at x=0 y=0&quot;.<br /><br />(The correct way to &quot;disable&quot; a sprite is to set its Y position to F0 or beyond.)

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>miguelfsp</b> [ Sun Jan 27, 2013 11:23 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: Super Mario Bros 1 Menu not working</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />I'm returning &quot;1&quot;. Is this correct? I just made some experiments (returning 0, etc...) and still doesn't work.<br />Reading address 0x4016 (controller 2 at 0x4017 is &quot;unconnected&quot;).<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">&nbsp; &nbsp; &nbsp; &nbsp; private int n = 0;<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; public byte Read()<br />&nbsp; &nbsp; &nbsp; &nbsp; {<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; byte retval;<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; retval = (n &lt; 8) ? Convert.ToByte(state&#91;n&#93;) : (byte)1;<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n++;<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return retval;<br />&nbsp; &nbsp; &nbsp; &nbsp; }</div><br /><br />So I don't know... maybe the issue is somewhere else? NesStress menu didn't work, till I implemented sprite hit 0 detection and scrolling. Btw an ODD thing: I fully pass nestest BUT when I test the CPU with NESTRESS, in the last &quot;page&quot; of CPU tests.... my emulation <span style="text-decoration: underline">crashes </span>at some point (in STACK ADDR) it never writes anything, because it tries to read from address &quot;$5569&quot;, which raises an exception... I don't understand whats wrong here with the CPU AND I don't think that the problems are connected because this issue only happens in Nestress, but maybe you can associate both problems, I don't know.<br /><br />Thanks Drag, but this time it seems that pacman is really programmed like that (don't ask me why...). I was comparing with JNes and it seems that JNes is wrong.<br /><br />Thank you for your anwsers.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Alegend45</b> [ Sun Jan 27, 2013 11:38 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: Super Mario Bros 1 Menu not working</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Your controllers aren't implemented properly. That's all there is to it.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>miguelfsp</b> [ Sun Jan 27, 2013 11:41 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: Super Mario Bros 1 Menu not working</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Well... I beleive you... But what is wrong?<br /><br /><!-- m --><a class="postlink" href="http://wiki.nesdev.com/w/index.php/Standard_controller">http://wiki.nesdev.com/w/index.php/Standard_controller</a><!-- m --><br /><br />When reading from $4016, in the first 8 bytes I return the state of each key, then I return 1... Till I have a write in $4016 (=0), where I set n = 0 and in the next read everything starts again. Isn't it supposed to be like this?

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Alegend45</b> [ Sun Jan 27, 2013 1:17 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: Super Mario Bros 1 Menu not working</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Your writes to $4016 are wrong. You have to write 1 before writing 0.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>miguelfsp</b> [ Sun Jan 27, 2013 1:18 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: Super Mario Bros 1 Menu not working</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />I did!<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">&nbsp; &nbsp; &nbsp; &nbsp; public void Write(byte value)<br />&nbsp; &nbsp; &nbsp; &nbsp; {<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if ((value &amp; 1) == 0)<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; latch = false;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n = 0;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; latch = true;<br />&nbsp; &nbsp; &nbsp; &nbsp; }</div>

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Alegend45</b> [ Sun Jan 27, 2013 1:21 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: Super Mario Bros 1 Menu not working</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />It has to write 1 before 0.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>miguelfsp</b> [ Sun Jan 27, 2013 1:37 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: Super Mario Bros 1 Menu not working</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Still not working... <img src="./images/smilies/icon_sad.gif" alt=":(" title="Sad" /> I guess something really messed up is going on...<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">&nbsp; &nbsp; &nbsp; &nbsp; bool one = false;<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; public void Write(byte value)<br />&nbsp; &nbsp; &nbsp; &nbsp; {<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if ((value &amp; 1) == 0)<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (one)<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; latch = false;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; n = 0;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; one = false;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; latch = true;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; one = true;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br />&nbsp; &nbsp; &nbsp; &nbsp; }</div>

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>koitsu</b> [ Sun Jan 27, 2013 1:42 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: Super Mario Bros 1 Menu not working</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">miguelfsp wrote:</div><div class="quotecontent">Still not working... :( I guess something really messed up is going on...</div><br />I don't mean to dishearten you, but comments like &quot;I guess something really messed up is going on&quot; <strong>when <span style="text-decoration: underline">you're</span> the author of the emulator</strong> do not give the impression that you necessarily understand the code you're writing.  :-/<br /><br />Maybe step back and explain using pseudo-code how you're doing doing your controller stuff, from the main part of your emulator all the way down to the register emulation?  More often than not you can't just paste some arbitrary C/C++ code into a forum and have everyone understand how it's being used -- &quot;here's a function, what's wrong with it&quot;  &quot;Um, I dunno, why don't you tell us how you're using this function?&quot;  :-)

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>miguelfsp</b> [ Sun Jan 27, 2013 1:56 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: Super Mario Bros 1 Menu not working</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />koitsu, thing is, I don't know if it's not working because of the controller - because all the other games that I tested work great (Donkey Kong, Mario Bros, nestest menu, Nestress menu, etc...), only SMB doesn't work.<br /><br />When the CPU tries to read from $4016, I call the read function in the controller, when it tries to write to $4016, I call the write function.<br /><br />When a key is up/down, I change the state[8] array to reflect the state of the key press. When I read from $4016, I sequencially read that array, till I read 8 bytes. Then it will always return &quot;1&quot;. To &quot;restart&quot; and to return the key values again, you must write 1 to the controller, and then 0. Thats what the write function does.<br /><br />$4017 second controller IS NOT implemented<br /><br />I say there's something messed up going on, because of what I wrote about Nestress in my reply to blarggs a few posts above (please check it and tell me what you think :/), so perhaps, its possible that the issue is not exacly on the controller itself, but maybe, possible some other completely remote thing is affecting the correct behaviour of the game itself being emulator.<br /><br />Quoting myself:<br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent">So I don't know... maybe the issue is somewhere else? NesStress menu didn't work, till I implemented sprite hit 0 detection and scrolling. Btw an ODD thing: I fully pass nestest BUT when I test the CPU with NESTRESS, in the last &quot;page&quot; of CPU tests.... my emulation crashes at some point (in STACK ADDR) it never writes anything, because it tries to read from address &quot;$5569&quot;, which raises an exception... I don't understand whats wrong here with the CPU AND I don't think that the problems are connected because this issue only happens in Nestress, but maybe you can associate both problems, I don't know.</div><br />Thank you very much for your anwsers!

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>3gengames</b> [ Sun Jan 27, 2013 2:02 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: Super Mario Bros 1 Menu not working</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Mae sure all bits return 0 like they would if those data bits wouldn't be used. It OR's bits 0 and 1 together.<br /><br />From doppleganger's disassembly:<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">;$00 - temp joypad bit<br /><br />ReadJoypads: <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lda #$01&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;;reset and clear strobe of joypad ports<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sta JOYPAD_PORT<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lsr<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tax&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;start with joypad 1's port<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sta JOYPAD_PORT<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; jsr ReadPortBits<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inx&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;increment for joypad 2's port<br />ReadPortBits: ldy #$08<br />PortLoop:&nbsp; &nbsp; &nbsp;pha&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;push previous bit onto stack<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lda JOYPAD_PORT,x&nbsp; &nbsp; &nbsp; ;read current bit on joypad port<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sta $00&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;check d1 and d0 of port output<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lsr&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;this is necessary on the old<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ora $00&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;famicom systems in japan<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lsr<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pla&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;read bits from stack<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rol&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;rotate bit from carry flag<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dey<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bne PortLoop&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;;count down bits left<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sta SavedJoypadBits,x&nbsp; ;save controller status here always<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pha<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; and #%00110000&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;;check for select or start<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; and JoypadBitMask,x&nbsp; &nbsp; ;if neither saved state nor current state<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; beq Save8Bits&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ;have any of these two set, branch<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pla<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; and #%11001111&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;;otherwise store without select<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sta SavedJoypadBits,x&nbsp; ;or start bits and leave<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rts<br />Save8Bits:&nbsp; &nbsp; pla<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sta JoypadBitMask,x&nbsp; &nbsp; ;save with all bits in another place and leave<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rts<br /></div>

		

		</td>
	</tr>
	</table>


<hr width="85%" />

<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
<tr>
	<td><span class="gensmall">Page <strong>1</strong> of <strong>3</strong></span></td>
	<td align="right"><span class="gensmall">All times are UTC - 7 hours </span></td>
</tr>
<tr>
	<td colspan="2" align="center"><span class="gensmall">Powered by phpBB&reg; Forum Software &copy; phpBB Group<br />http://www.phpbb.com/</span></td>
</tr>
</table>

</body>
</html>