<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html dir="ltr" lang="en-gb">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta http-equiv="Content-Style-Type" content="text/css">
<meta http-equiv="Content-Language" content="en-gb">
<title>nesdev.com :: View topic - Micro Machines glitches</title>

<style type="text/css">
<!--

body {
	font-family: Verdana,serif;
	font-size: 10pt;
}

img {
	border: 0;
}

td {
	font-family: Verdana,serif;
	font-size: 10pt;
	line-height: 150%;
}

.code, .codecontent, 
.quote, .quotecontent {
	margin: 0 5px 0 5px;
	padding: 5px;
	font-size: smaller;
	border: black solid 1px;
}

.quotetitle {
	color: black;
	display : block;
	font-weight: bold;
}

.forum {
	font-family: Arial,Helvetica,sans-serif;
	font-weight: bold;
	font-size: 18pt;
}

.topic {
	font-family: Arial,Helvetica,sans-serif;
	font-size: 14pt;
	font-weight: bold;
}

.gensmall {
	font-size: 8pt;
}

hr {
	color: #888;
	height: 3px;
	border-style: solid;
}

hr.sep {
	color: #aaa;
	height: 1px;
	border-style: dashed;
}
//-->
</style>

</head>
<body>

<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
<tr>
	<td colspan="2" align="center"><span class="Forum">nesdev.com</span><br /><span class="gensmall"><a href="http://forums.nesdev.com/">http://forums.nesdev.com/</a></span></td>
</tr>
<tr>
	<td colspan="2"><br /></td>
</tr>
<tr>
	<td><span class="topic">Micro Machines glitches</span><br /><span class="gensmall"><a href="http://forums.nesdev.com/viewtopic.php?f=3&amp;t=12425">http://forums.nesdev.com/viewtopic.php?f=3&amp;t=12425</a></span></td>
	<td align="right" valign="bottom"><span class="gensmall">Page <strong>6</strong> of <strong>6</strong></span></td>
</tr>
</table>



	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>koitsu</b> [ Sun Apr 26, 2015 6:30 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: Micro Machines glitches</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Why is it nobody in this thread (from what I can discern) has taken the time to check this out on <strong><em><span style="text-decoration: underline">actual hardware</span></em></strong>?  Are people unaware of the fact that it looks glitchy even on the real thing?  Here's proof, a la kevtris:<br /><br /><!-- m --><a class="postlink" href="https://www.youtube.com/watch?v=oNkbuQx5v0E&amp;t=4m40s">https://www.youtube.com/watch?v=oNkbuQx5v0E&amp;t=4m40s</a><!-- m --><br /><br />You guys are trying to solve something that shouldn't need to be solved.  The level of obsession over this is amazing.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>rainwarrior</b> [ Sun Apr 26, 2015 8:36 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: Micro Machines glitches</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />koitsu, I posted a link to a real hardware video on <a href="http://forums.nesdev.com/viewtopic.php?f=3&amp;t=12425&amp;start=15#p142072" class="postlink">page 2</a> of this thread.<br /><br />It's <em>not</em> glitchy on a real NES (I have tested this, and so have others). Kevtris' video is demonstrating that Micro Machines isn't quite right on his HD recreation, but close. (He even says this a few seconds before the place in the video you linked.)<br /><br />It <em>is</em> very slightly glitchy on a Famicom, however. I verified this on <a href="http://forums.nesdev.com/viewtopic.php?f=3&amp;t=12425&amp;start=30#p142137" class="postlink">page 3</a> when I tested it there as well.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>krzysiobal</b> [ Wed Sep 14, 2016 3:32 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: Micro Machines glitches</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />There are 2 version of Micro Machines - one with 1991 on title screen (works better on PAL Famiclone, without any glitches, on NTSC there are minor glitches) and one with 1992 on title screen (works without any glitches on NTSC, hangs after codemasters logo on PAL).

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Alyosha_TAS</b> [ Sat Mar 04, 2017 5:49 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: Micro Machines glitches</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">zeroone wrote:</div><div class="quotecontent"><br />After:<br /><br /><img src="http://i.imgur.com/P3NhKYM.png" alt="Image" /></div><br /><br />Sorry for bumping an old thread, but I recently improved my emulators timings and I ended up with this same black line that flashes every other frame.<br /><br />I dug a little into the problem and this is what I found:<br /><br />That black line occurs at scanline 109. Right where it starts is where a $2006 write (the second one) occurs to change the VRAM address to $3F60.<br /><br />The problem actually occurs in scanline 108. On alternating frames , the horiz(v) increment at 328 is missed because rendering is turned off slightly too early. This causes a write to $2007 that should go to $3F10 (a mirror of $3F60) to go to $3F09 instead.  Then on the next scanline the wrong palette color is in the address so the black line appears.<br /><br />According to the emualator, rendering is disabled at either 326 or 328 in scanline 108. Presumably the 2 pixel difference is due NMI happening at 1 cpu cycle different timing between frames and 1 of the 3 pixels is used up due to the skipped pixel on alternating frames.<br /><br />So that is the cause of the black line. The question is, what is different between emulators that this line isn't showing up in others? What is the correct way to fix the problem?<br /><br />EDIT: Turns out I had an order of operations problem. I was incrememnting the cycle count of the PPU before executing the CPU read, so for the $2004 read code, I had to use '&lt;=' instead of '&lt;' when comparin to the cycle time. Simple fix and Micro Machines now looks perfect! However, in order for this to work I have to do the 'PPU on' check for the horiz(v) increment 2 cycles before it happens. This needs investigating.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>zeroone</b> [ Tue Mar 07, 2017 9:10 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: Micro Machines glitches</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">Alyosha_TAS wrote:</div><div class="quotecontent">Sorry for bumping an old thread, but I recently improved my emulators timings and I ended up with this same black line that flashes every other frame.<br /><br />I dug a little into the problem and this is what I found:<br /><br />That black line occurs at scanline 109. Right where it starts is where a $2006 write (the second one) occurs to change the VRAM address to $3F60.<br /><br />The problem actually occurs in scanline 108. On alternating frames , the horiz(v) increment at 328 is missed because rendering is turned off slightly too early. This causes a write to $2007 that should go to $3F10 (a mirror of $3F60) to go to $3F09 instead. Then on the next scanline the wrong palette color is in the address so the black line appears.<br /><br />According to the emualator, rendering is disabled at either 326 or 328 in scanline 108. Presumably the 2 pixel difference is due NMI happening at 1 cpu cycle different timing between frames and 1 of the 3 pixels is used up due to the skipped pixel on alternating frames.<br /><br />So that is the cause of the black line. The question is, what is different between emulators that this line isn't showing up in others? What is the correct way to fix the problem?<br /><br />EDIT: Turns out I had an order of operations problem. I was incrememnting the cycle count of the PPU before executing the CPU read, so for the $2004 read code, I had to use '&lt;=' instead of '&lt;' when comparin to the cycle time. Simple fix and Micro Machines now looks perfect! However, in order for this to work I have to do the 'PPU on' check for the horiz(v) increment 2 cycles before it happens. This needs investigating.</div><br /><br />The black line does not appear in Nintendulator 970, but it is present in the newer Nintendulator 975.  The older 970 contains a hack where the X/Y-increments occur 4 dots earlier than they should.  Nintendulator 975 attempted to be more accurate by moving the increments closer to where they should be; however, accuracy problems manifested itself, such as in this game.  <br /><br />Can you elaborate on your &quot;PPU on&quot; check?

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Alyosha_TAS</b> [ Tue Mar 07, 2017 6:41 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: Micro Machines glitches</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">zeroone wrote:</div><div class="quotecontent">The black line does not appear in Nintendulator 970, but it is present in the newer Nintendulator 975.  The older 970 contains a hack where the X/Y-increments occur 4 dots earlier than they should.  Nintendulator 975 attempted to be more accurate by moving the increments closer to where they should be; however, accuracy problems manifested itself, such as in this game.  <br /><br />Can you elaborate on your &quot;PPU on&quot; check?</div><br /><br /><br />Are there any emulators that contain no hacks, do $2004 reads correctly, and still emualte micro machines without graphical errors?<br /><br />By &quot;PPU on&quot; check I simply mean checking if the PPU is rendering before doing the increment, as the wiki says that increments only happen if this is the case. I did this check one tick earlier then usual and it removed the bug (obviously since rendering was being turned off early.) This caused other bugs though so I have reverted that back to the way it was and the black line remains.<br /><br />I implemented all the $2004 read characteristics documented by Quietust and others, so in my emulator read2004.nes now shows this:<br /><br /><img src="http://i1053.photobucket.com/albums/s468/daviomace/read2004_zpswiqeotxx.png" alt="Image" /><br /><br />This matches what Quietust posted with one extra FF at the beginning for some reason (the FF's at the end are just RAM initialized to FF.) Nothing I do can get me to exactly 4 starting FF's, so maybe that is a hint at the problem? Or are there just a variable number of FF's?<br /><br />This is enough to remove the black line on the title screen but not on the subsequent select one/two player screen.<br /><br />So yeah, I'm currently at a loss as to how fix the black line.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Quietust</b> [ Tue Mar 07, 2017 9:04 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: Micro Machines glitches</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">Alyosha_TAS wrote:</div><div class="quotecontent">This matches what Quietust posted with one extra FF at the beginning for some reason (the FF's at the end are just RAM initialized to FF.) Nothing I do can get me to exactly 4 starting FF's, so maybe that is a hint at the problem? Or are there just a variable number of FF's?</div><br />The number of FFs you get is <strong>timing-dependent</strong> - each number corresponds to a single PPU cycle (i.e. 1/3 of a CPU cycle), so clock alignment has a very noticeable effect.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Sour</b> [ Tue Mar 07, 2017 10:33 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: Micro Machines glitches</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Thanks for bringing up that test rom - I did not even know it existed!<br />This made me notice a few things that were wrong/broken about Mesen's sprite overflow bug &amp; $2004 reads.<br />I've managed to fix the result to be near-identical to the screen you posted (6 FFs on mine - I can alter this by changing the timing between the CPU/PPU, like Quietust said)<br /><br />Things that were wrong in Mesen:<br />1- Reads from $2004 during sprite evaluation (cycles 65 to 256) were completely wrong (never returned the correct result)<br />2- Fixing 1) made me notice I was also not returning the secondary OAM values on even cycles once the secondary oam was full.<br />3- The sprite overflow bug wasn't being emulated correctly - after the $00 read that &quot;fixes&quot; the bug in the test, my code did not read the next 3 bytes properly and didn't realign correctly after those 3 bytes.<br /><br />.. And yet none of these mattered.  Fixing them changed nothing to the result of all 225 test roms I test Mesen against, and Micro Machines still works correctly (like it did before).<br /><br />For Micro Machines to work properly, it's the $2004 reads outside sprite evaluation that matter (cycles &lt; 65 || cycle &gt; 256), if I remember correctly.  Those reads are based on the timing of sprite rendering (rather than sprite evaluation).<br /><br />Hopefully this at least lets you rule out some possibilities and helps you figure out what your issue is!

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Alyosha_TAS</b> [ Wed Mar 08, 2017 4:15 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: Micro Machines glitches</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />@sour: at what cycle is rendering disabled on scanline 108 on the micro machines title screen in mesen? This is really the heart of the problem. Some other test roms you might not be aware of are oam.nes and oam3.nes . They outright crash mesen  <img src="./images/smilies/icon_eek.gif" alt=":shock:" title="Shocked" />

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Sour</b> [ Wed Mar 08, 2017 5:35 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: Micro Machines glitches</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Ah, there we go.<br />The &quot;rendering enabled&quot; flag is delayed by 2 cycles in Mesen (I guess that's what you'd call a hack!)<br />If the CPU writes to $2000 on cycle 326 - cycles 327 &amp; 328 are both considered to have rendering still active.<br /><br />This is the only way I had found to fix Battleloads while passing all other tests a long time ago.<br />I wasn't aware it happened to have an impact on Micro Machines though.<br /><br />I wouldn't be surprised if something like this is actually a thing, considering the recent thread that discovered (still unconfirmed on hardware, though) that the video ram address update done after the 2nd write to $2006 seems to be delayed by 3-4 cycles.<br /><br />Whether or not a delay exists in the rendering flag's state would probably be fairly easy to figure out with the Visual 2C02/Visual NES, though I don't have time to check right now.<br /><br /><br />I actually found out about the oam3 tests a couple of weeks ago - the crash was a silly memory mapping issues due to the rom's unusual NES 2.0 headers if I recall correctly.  It's fixed in the code, but not in the latest release.  Thanks for mentioning it though!

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Alyosha_TAS</b> [ Wed Mar 08, 2017 10:42 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: Micro Machines glitches</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />I managed to get 4 FF's by adjusting the power up timing of the emulator. It now also matches the startup behaviour indicated in the wiki so I guess that solves that.<br /><br />Delaying the flag does indeed fix the black line (although Battletoads wasnt crashing for me before that so not sure what's happening there exactly.) Now Micro Machines runs without glitches, although that delay definitely needs confirmation.<br /><br />I can't help but wonder what other delays exist in the ppu, seems like a can of worms might be opening up here.  <img src="./images/smilies/icon_confused.gif" alt=":?" title="Confused" />

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>zeroone</b> [ Wed Mar 08, 2017 11:42 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: Micro Machines glitches</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />@Sour @Alyosha_TAS Do your emulators delay $2007 VRAM reads and writes like Nintendulator?

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Alyosha_TAS</b> [ Wed Mar 08, 2017 1:23 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: Micro Machines glitches</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">zeroone wrote:</div><div class="quotecontent">@Sour @Alyosha_TAS Do your emulators delay $2007 VRAM reads and writes like Nintendulator?</div><br /><br />No, mine doesn't, it seems plausible given what is known about $2006.<br /><br />What situation/game does this effect?

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Sour</b> [ Wed Mar 08, 2017 4:09 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: Micro Machines glitches</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />I'm not quite sure what you mean by VRAM read/writes delays, so I'll go ahead and assume I haven't implemented any.  I haven't looked at Nintendulator's source in a long time, either..<br /><br />I played a bit with the Visual NES, this might not be 100% accurate (especially since I did this in like 15 minutes), but nonetheless:<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">0A7960,55,F1,0819,19,18,FF,00,DF,2001,00,01,01,00,&nbsp; ;PPU rendering is disabled (01 in before-last column)<br />0A7961,55,F1,0819,19,18,FF,00,18,2001,00,00,01,00,&nbsp; ;CPU starts writing $18 to $2001, which will enable rendering <br />0A7961,56,F1,0819,19,18,FF,00,18,2001,00,00,01,00,&nbsp; ;PPU Cycle transitions from 85 to 86 ($55 -&gt; $56)<br />0A7962,56,F1,0819,19,18,FF,00,18,2001,00,00,01,00,<br />0A7962,56,F1,0819,19,18,FF,00,18,2001,00,00,01,00,<br />0A7963,56,F1,0819,19,18,FF,00,18,2001,00,00,01,00,<br />0A7963,56,F1,0819,19,18,FF,00,18,2001,00,00,01,00,<br />0A7964,56,F1,0819,19,18,FF,00,18,2001,00,00,01,00,<br />0A7964,56,F1,0819,19,18,FF,00,18,2001,00,00,01,00,<br />0A7965,56,F1,0819,19,18,FF,00,18,2001,00,00,01,00,<br />0A7965,57,F1,0819,19,18,FF,00,18,2001,00,00,01,00,&nbsp; ;PPU cycle transition from 86-&gt;87 ($56 -&gt; $57)<br />0A7966,57,F1,0819,19,18,FF,00,18,2001,00,00,01,00,<br />0A7966,57,F1,0819,19,18,FF,00,18,2001,00,01,00,01&nbsp; &nbsp;;Rendering is enabled (before-last column turns to 00), 1.5ish PPU cycles after the write</div>So there are 12 master clocks (1.5 ppu clocks) between the start of the write &amp; the rendering flag being enabled.<br />This assumes I'm tracing the right signals, obviously - but it is called &quot;rendering_disabled&quot;, so it's a pretty good bet.<br /><br />Again, though, testing with Visual NES is not enough to prove anything, would need a test rom of sorts (but I do not have the slightest clue how one could test this, so I'm definitely not going to be the one writing a test for it :p)

		

		</td>
	</tr>
	</table>


<hr width="85%" />

<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
<tr>
	<td><span class="gensmall">Page <strong>6</strong> of <strong>6</strong></span></td>
	<td align="right"><span class="gensmall">All times are UTC - 7 hours </span></td>
</tr>
<tr>
	<td colspan="2" align="center"><span class="gensmall">Powered by phpBB&reg; Forum Software &copy; phpBB Group<br />http://www.phpbb.com/</span></td>
</tr>
</table>

</body>
</html>