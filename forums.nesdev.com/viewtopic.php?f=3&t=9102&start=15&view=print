<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html dir="ltr" lang="en-gb">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta http-equiv="Content-Style-Type" content="text/css">
<meta http-equiv="Content-Language" content="en-gb">
<title>nesdev.com :: View topic - 085.txt updated with full VRC7 audio details</title>

<style type="text/css">
<!--

body {
	font-family: Verdana,serif;
	font-size: 10pt;
}

img {
	border: 0;
}

td {
	font-family: Verdana,serif;
	font-size: 10pt;
	line-height: 150%;
}

.code, .codecontent, 
.quote, .quotecontent {
	margin: 0 5px 0 5px;
	padding: 5px;
	font-size: smaller;
	border: black solid 1px;
}

.quotetitle {
	color: black;
	display : block;
	font-weight: bold;
}

.forum {
	font-family: Arial,Helvetica,sans-serif;
	font-weight: bold;
	font-size: 18pt;
}

.topic {
	font-family: Arial,Helvetica,sans-serif;
	font-size: 14pt;
	font-weight: bold;
}

.gensmall {
	font-size: 8pt;
}

hr {
	color: #888;
	height: 3px;
	border-style: solid;
}

hr.sep {
	color: #aaa;
	height: 1px;
	border-style: dashed;
}
//-->
</style>

</head>
<body>

<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
<tr>
	<td colspan="2" align="center"><span class="Forum">nesdev.com</span><br /><span class="gensmall"><a href="http://forums.nesdev.com/">http://forums.nesdev.com/</a></span></td>
</tr>
<tr>
	<td colspan="2"><br /></td>
</tr>
<tr>
	<td><span class="topic">085.txt updated with full VRC7 audio details</span><br /><span class="gensmall"><a href="http://forums.nesdev.com/viewtopic.php?f=3&amp;t=9102">http://forums.nesdev.com/viewtopic.php?f=3&amp;t=9102</a></span></td>
	<td align="right" valign="bottom"><span class="gensmall">Page <strong>2</strong> of <strong>2</strong></span></td>
</tr>
</table>



	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Bregalad</b> [ Wed Jul 18, 2012 2:13 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Oh this clear things up so they'll be running at <em>almost</em> the same frequency.
<br />
<br />I think a 5 cent detune between channels would not have any negative effects on music on the other side it could make it sound better.
<br />It's a very common method on the NES to detune slightly Square 1 and Square 2 channels.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Grapeshot</b> [ Wed Jul 18, 2012 3:10 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />I have a few VRC7 test roms if anyone wants to record them on real hardware. (They're Famitracker files exported to NSF and then compiled with the Vegaplay NSF engine with the actual menu disabled.) 
<br />
<br /><!-- m --><a class="postlink" href="https://dl.dropbox.com/u/26864173/vrc7.rar">https://dl.dropbox.com/u/26864173/vrc7.rar</a><!-- m -->
<br />
<br />None of these work in Nintendulator, probably banking issues.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>rainwarrior</b> [ Wed Jul 18, 2012 5:15 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Grapeshot, FYI, Famitracker had a bug (until yesterday) in the VRC7 driver code that prevents it from playing properly on hardware. The code that updates the instrument registers was failing to delay between writes.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>jrlepage</b> [ Thu Jul 19, 2012 11:07 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">Grapeshot wrote:</div><div class="quotecontent">I have a few VRC7 test roms if anyone wants to record them on real hardware. (They're Famitracker files exported to NSF and then compiled with the Vegaplay NSF engine with the actual menu disabled.) <br /><br /><!-- m --><a class="postlink" href="https://dl.dropbox.com/u/26864173/vrc7.rar">https://dl.dropbox.com/u/26864173/vrc7.rar</a><!-- m --><br /><br />None of these work in Nintendulator, probably banking issues.</div>
<br />I'd love to test those for you, but I have 2 problems:
<br />
<br />a) I can only play NSFs on hardware (with the TNS-HFC3),
<br />b) Those files won't play properly unless you re-export to NSF using the current 0.3.8 beta (as rainwarrior said),

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>rainwarrior</b> [ Tue Jul 24, 2012 7:46 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Alright, I've had some time to <a href="http://nesdev.com/bbs/viewtopic.php?t=8987" class="postlink">get my CopyNES</a> working, and I can now use the VRC7 tuner program with my Lagrange Point cart.
<br />
<br />I'm currently going over the patch set; probably in a week or two I'll have a slightly more refined version of the set by quietust that most emulators currently use.
<br />
<br />Update: did patch 1 so far, keeping a WIP version here: <a href="http://code.google.com/p/usbcopynesblue/source/browse/trunk/bin/PRG/rainwarrior.vrc7" class="postlink">http://code.google.com/p/usbcopynesblue/source/browse/trunk/bin/PRG/rainwarrior.vrc7</a>
<br />
<br />(Also there were bugs in the USB CopyNES VRC7 tuner; I almost lost my work on the patch when the save function didn't work! I wonder if anyone has actually used this program in the past few years...)
<br />
<br /><img src="https://dl.dropbox.com/u/883356/vrc7_testing_0.jpg" alt="Image" />
<br /><img src="https://dl.dropbox.com/u/883356/vrc7_testing_1.jpg" alt="Image" />

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>rainwarrior</b> [ Wed Aug 01, 2012 12:53 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />I've finished tweaking my patch set. My results are here:
<br />
<br /><a href="http://nesdev.com/bbs/viewtopic.php?p=97361" class="postlink">http://nesdev.com/bbs/viewtopic.php?p=97361</a>

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>rainwarrior</b> [ Thu Aug 02, 2012 11:56 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />I'm curious about the relationship between 1&lt;&lt;23 and 48db. By my reasoning, 48db = 10 ^ (48 / 10) = ~63096 which would suggest 16 bits of precision to me, not 23. Could you explain your reasoning?
<br />
<br />The channels are output in series, according to the Yamaha datasheet, though the diagram shows them unevenly clustered in groups of 3; it's kind of unclear about the actual timing output. As you said this is not significant if trying to emulate the audio, since the consequences are above the audible frequency range.
<br />
<br />A note about note-off for "percussive" envelopes; if the sustain flag is off for the envelope, note-off appears to generate a release equivalent to a release setting of 7. You mentioned this in your notes (based on emu2413.c?), and I had noticed/verified this independently when testing the hardware patches, but I can't seem to find this described in the YM2413 datasheet. The only thing I found was a little line on the percussive envelope diagram showing a faster release.
<br />
<br />One more note that I'm sure must be borne out by the formulae in your description, but I think is worth saying explicitly, is the relationship between the sustain level (4-bit value) and output level (6-bit value) of the modulator. These have an exact 4:1 ratio, i.e. ignoring the attack, +1 to the sustain level is equivalent to +4 to the modulator output level. This was an extremely important property to know when trying to tweak the patches, because if I need to increase the effect of the attack, I can put -1 on the sustain value and +4 on the modulator output, resulting in the exact same effective sustain level, but now the attack level goes higher because I increased the modulator output.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>tepples</b> [ Thu Aug 02, 2012 1:03 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Assuming constant impedance, doubling the voltage implies doubling the current, which quadruples the output power, and quadruple the power means about 6 dB more. Thus 48 dB is 48 / 6 = 8 doublings.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>rainwarrior</b> [ Thu Aug 02, 2012 1:55 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Hmm, actually that makes sense, since I'm used to 16-bit audio programs telling me it has a 96db noise floor. Thanks for straightening that out.
<br />
<br />So, does this mean the envelope only has 8 bits of precision? Even if they happen to distributed logarithmically during amplification, that seems low... but maybe not.
<br />
<br />I've got a fair bit of hardware testing ahead of me to figure these things out.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Grapeshot</b> [ Thu Aug 02, 2012 1:56 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />He's just using 23 bits for the envelope attenuation value because on the lowest envelope speed the envelope will change by one LSB every time it's clocked (so a separate divider isn't needed for low rates). 
<br />
<br />According to the SpritesMind forums, who have decapped and studied a YM2612, the envelope generator output is actually 9 bits which is then shifted to produce a 12 bit (plus sign bit) attenuation value. The actual attenuation value table in the chip, which has been extracted as well, works with 1&lt;&lt;12 = 48db of attenuation. So to be accurate, only the high 9 bits of the envelope generator output should be considered.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>rainwarrior</b> [ Thu Aug 02, 2012 9:16 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: 085.txt updated with full VRC7 audio details</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Grapeshot, that's very interesting. Do you have a link you could share where this information is gathered?

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Grapeshot</b> [ Thu Aug 02, 2012 9:36 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: 085.txt updated with full VRC7 audio details</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />I posted it on the previous page, actually, but I don't blame you for not wanting to read a <a href="http://gendev.spritesmind.net/forum/viewtopic.php?t=386&amp;postdays=0&amp;postorder=asc&amp;start=0" class="postlink">40 page thread</a> for relevant info.<br /><br />Here's the important diagram for the envelope bit widths.<br /><!-- m --><a class="postlink" href="http://nemesis.hacking-cult.org/MegaDrive/Documentation/YM2612%20Notes/ym2612%20operator.png">http://nemesis.hacking-cult.org/MegaDri ... erator.png</a><!-- m --><br /><br />The only thing about this image is that is probably not correct for the YM2413 or the VRC7 is the DAC at the end. Elsewhere in the thread it's determined that the DAC used on the YM2413 is an 8 bit linear resistor ladder which connects the output pin to VCC or GND depending on the sign bit. (Some variants of the Genesis sound chip use this DAC and some use a completely different design, which is one of the reasons Genesis sound quality varied so much between models.)<br /><br />e: Another thing that is missing in Disch's documentation is the fact that the attack portion of the envelope increases exponentially, not linearly. This is mentioned in the OPLL programmer's manual, but the actual method of calculating it is mentioned in a patent and discussed at <!-- m --><a class="postlink" href="http://gendev.spritesmind.net/forum/viewtopic.php?t=932&amp;highlight=envelope+attack">http://gendev.spritesmind.net/forum/vie ... ope+attack</a><!-- m --> as well as in that other thread.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>rainwarrior</b> [ Fri Aug 03, 2012 12:04 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: 085.txt updated with full VRC7 audio details</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Ah, I missed them on the first page. Thanks for the links; this will be good reading...

		

		</td>
	</tr>
	</table>


<hr width="85%" />

<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
<tr>
	<td><span class="gensmall">Page <strong>2</strong> of <strong>2</strong></span></td>
	<td align="right"><span class="gensmall">All times are UTC - 7 hours </span></td>
</tr>
<tr>
	<td colspan="2" align="center"><span class="gensmall">Powered by phpBB&reg; Forum Software &copy; phpBB Group<br />http://www.phpbb.com/</span></td>
</tr>
</table>

</body>
</html>