<?xml version="1.0" encoding="UTF-8"?>
<feed xmlns="http://www.w3.org/2005/Atom" xml:lang="en-gb">
<link rel="self" type="application/atom+xml" href="http://forums.nesdev.com/feed.php?f=3&amp;t=212" />

<title>nesdev.com</title>
<subtitle>NES Development and Strangulation Records message boards</subtitle>
<link href="http://forums.nesdev.com/index.php" />
<updated>2008-01-29T19:33:55-07:00</updated>

<author><name><![CDATA[nesdev.com]]></name></author>
<id>http://forums.nesdev.com/feed.php?f=3&amp;t=212</id>
<entry>
<author><name><![CDATA[Anonymous]]></name></author>
<updated>2006-01-14T01:22:55-07:00</updated>
<published>2006-01-14T01:22:55-07:00</published>
<id>http://forums.nesdev.com/viewtopic.php?t=212&amp;p=8235#p8235</id>
<link href="http://forums.nesdev.com/viewtopic.php?t=212&amp;p=8235#p8235"/>
<title type="html"><![CDATA[Mega Man 3 Scanline]]></title>

<content type="html" xml:base="http://forums.nesdev.com/viewtopic.php?t=212&amp;p=8235#p8235"><![CDATA[
If I didn't know any better, I'd think that I'm seeing PPU documentation approaching the level of the "VIC Article" for the VIC-II. Very impressive.<p>Statistics: Posted by Guest — Sat Jan 14, 2006 1:22 am</p><hr />
]]></content>
</entry>
<entry>
<author><name><![CDATA[Great Hierophant]]></name></author>
<updated>2006-01-13T21:33:16-07:00</updated>
<published>2006-01-13T21:33:16-07:00</published>
<id>http://forums.nesdev.com/viewtopic.php?t=212&amp;p=8233#p8233</id>
<link href="http://forums.nesdev.com/viewtopic.php?t=212&amp;p=8233#p8233"/>
<title type="html"><![CDATA[Mega Man 3 Scanline]]></title>

<content type="html" xml:base="http://forums.nesdev.com/viewtopic.php?t=212&amp;p=8233#p8233"><![CDATA[
While this is an old post to ressurect, the issue I describe below may be the same type of error that is displayed in MM3, a true glitch in the real NES:<br /><br />In the rather rare game Zombie Nation (and its japanese counterpart), every emulator I have ever used it on has the top scanline of the bottom screen shift about 8-16 pixels or so very rapidly.  I would ordinarily suppose this to be a glitch in the emulation, because the defect would be clearly noticeable on a TV.  Many shifting scanlines are covered by the TV's overscan or are so far on the sides of the screen as not to be noticeable.  The shifting scanlines as I see them on Zombie Nation cover the entire health meter heads.  Is this an emulation problem needed to be addressed or sloppy programming?<p>Statistics: Posted by <a href="http://forums.nesdev.com/memberlist.php?mode=viewprofile&amp;u=58">Great Hierophant</a> — Fri Jan 13, 2006 9:33 pm</p><hr />
]]></content>
</entry>
<entry>
<author><name><![CDATA[Great Hierophant]]></name></author>
<updated>2005-04-30T16:13:05-07:00</updated>
<published>2005-04-30T16:13:05-07:00</published>
<id>http://forums.nesdev.com/viewtopic.php?t=212&amp;p=1978#p1978</id>
<link href="http://forums.nesdev.com/viewtopic.php?t=212&amp;p=1978#p1978"/>
<title type="html"><![CDATA[Mega Man 3 Scanline]]></title>

<content type="html" xml:base="http://forums.nesdev.com/viewtopic.php?t=212&amp;p=1978#p1978"><![CDATA[
Micro Machines also displays another instance of unusual, difficult to emulate behavior.  (Which only Nintendulator seems to emulate correctly.)  If you press the reset button while it is running in a NES, it will reset just fine during the races but not in the menu screens.  In the Standalone Cartridge Version it frequently crashes the program, in the Aladdin Deck Enhancer Version it generally just cuts off the music until the next screen but still allows input.  On most emulators, using the "Soft Reset" option should be identical to pressing the reset button of a NES.  I wonder if this is related to the method Micro Machines uses to display its picture in these screens?<p>Statistics: Posted by <a href="http://forums.nesdev.com/memberlist.php?mode=viewprofile&amp;u=58">Great Hierophant</a> — Sat Apr 30, 2005 4:13 pm</p><hr />
]]></content>
</entry>
<entry>
<author><name><![CDATA[abonetochew]]></name></author>
<updated>2005-03-02T19:51:36-07:00</updated>
<published>2005-03-02T19:51:36-07:00</published>
<id>http://forums.nesdev.com/viewtopic.php?t=212&amp;p=1389#p1389</id>
<link href="http://forums.nesdev.com/viewtopic.php?t=212&amp;p=1389#p1389"/>
<title type="html"><![CDATA[Mega Man 3 Scanline]]></title>

<content type="html" xml:base="http://forums.nesdev.com/viewtopic.php?t=212&amp;p=1389#p1389"><![CDATA[
Just ... wow.  What kind of twisted circuitry exists in the PPU to cause that?<p>Statistics: Posted by <a href="http://forums.nesdev.com/memberlist.php?mode=viewprofile&amp;u=13">abonetochew</a> — Wed Mar 02, 2005 7:51 pm</p><hr />
]]></content>
</entry>
<entry>
<author><name><![CDATA[tepples]]></name></author>
<updated>2005-03-02T19:39:50-07:00</updated>
<published>2005-03-02T19:39:50-07:00</published>
<id>http://forums.nesdev.com/viewtopic.php?t=212&amp;p=1388#p1388</id>
<link href="http://forums.nesdev.com/viewtopic.php?t=212&amp;p=1388#p1388"/>
<title type="html"><![CDATA[Mega Man 3 Scanline]]></title>

<content type="html" xml:base="http://forums.nesdev.com/viewtopic.php?t=212&amp;p=1388#p1388"><![CDATA[
Gosh.<br /><br />Damn.<br /><br />I don't know which is more shocking: the complexity of the behavior of the PPU bug you describe, or that you managed to figure it out.<p>Statistics: Posted by <a href="http://forums.nesdev.com/memberlist.php?mode=viewprofile&amp;u=9">tepples</a> — Wed Mar 02, 2005 7:39 pm</p><hr />
]]></content>
</entry>
<entry>
<author><name><![CDATA[Quietust]]></name></author>
<updated>2005-03-02T19:18:38-07:00</updated>
<published>2005-03-02T19:18:38-07:00</published>
<id>http://forums.nesdev.com/viewtopic.php?t=212&amp;p=1387#p1387</id>
<link href="http://forums.nesdev.com/viewtopic.php?t=212&amp;p=1387#p1387"/>
<title type="html"><![CDATA[Mega Man 3 Scanline]]></title>

<content type="html" xml:base="http://forums.nesdev.com/viewtopic.php?t=212&amp;p=1387#p1387"><![CDATA[
That could be, but the overall time elapsed during an "STA $4014" is a total of 517 cycles.<br /><br />I've also discovered some startling information, which seems to explain the bizarre behavior we had noticed earlier with sprite overflow happening even when there were not 9 sprites on a scanline. Following is the sprite table used in my demo, evaluated cycle by cycle during scanlines 1-3. Fetches are shown in bold, and successful Y-evaluations are shown in italic.<br /><br /><strong>$AA</strong>,$00,$00,$00 - sprite not in range<br /><strong><em>$01</em>,$10,$01,$00</strong> - first sprite in range<br /><strong><em>$00</em>,$20,$01,$01</strong> - 2nd<br /><strong><em>$00</em>,$30,$01,$02</strong><br /><strong><em>$00</em>,$40,$02,$03</strong><br /><strong><em>$00</em>,$50,$02,$04</strong><br /><strong><em>$00</em>,$60,$02,$05</strong><br /><strong><em>$00</em>,$70,$03,$06</strong><br /><strong><em>$00</em>,$80,$03,$07</strong> - and 8th, after which it starts thrashing between the first sprite's Y-coordinate and the coordinate being evaluated<br /><strong>$05</strong>,$90,$03,$08 - but here's where it goes horribly wrong..<br />$05,<strong>$A0</strong>,$40,$09 - it starts fetching DIAGONALLY through the sprite table<br />$05,$B0,<strong>$41</strong>,$0A<br />$05,$C0,$42,<strong>$0B</strong><br /><strong>$05</strong>,$D0,$43,$0C<br />$05,<strong>$E0</strong>,$80,$0D<br />$05,$F0,<strong>$81</strong>,$0E<br />$05,$F1,$82,<strong>$0F</strong><br /><strong>$05</strong>,$F2,$83,$10<br />$05,<strong>$F3</strong>,$00,$11<br />$05,$F4,<strong><em>$00</em>,$12</strong> - managing to match sprite 19's FLAGS value as a valid Y coordinate<br /><strong>$05,$F5</strong>,$00,$13 - after it finishes "fetching" this sprite (and setting the overflow flag), it realigns back at the beginning of this line<br /><strong>$05</strong>,$F6,$00,$14 - and then continues here on the next sprite<br /><strong>$05</strong>,$F7,$00,$15<br /><strong>$05</strong>,$F8,$00,$16<br /><strong>$05</strong>,$F9,$00,$17<br />etc.<p>Statistics: Posted by <a href="http://forums.nesdev.com/memberlist.php?mode=viewprofile&amp;u=7">Quietust</a> — Wed Mar 02, 2005 7:18 pm</p><hr />
]]></content>
</entry>
<entry>
<author><name><![CDATA[tepples]]></name></author>
<updated>2005-03-02T19:13:35-07:00</updated>
<published>2005-03-02T19:13:35-07:00</published>
<id>http://forums.nesdev.com/viewtopic.php?t=212&amp;p=1386#p1386</id>
<link href="http://forums.nesdev.com/viewtopic.php?t=212&amp;p=1386#p1386"/>
<title type="html"><![CDATA[Mega Man 3 Scanline]]></title>

<content type="html" xml:base="http://forums.nesdev.com/viewtopic.php?t=212&amp;p=1386#p1386"><![CDATA[
The 2A03's DMA controller adds a couple cycles of overhead because it has to make sure that the 6502 core is completely halted before the DMA controller starts a transfer.<p>Statistics: Posted by <a href="http://forums.nesdev.com/memberlist.php?mode=viewprofile&amp;u=9">tepples</a> — Wed Mar 02, 2005 7:13 pm</p><hr />
]]></content>
</entry>
<entry>
<author><name><![CDATA[Anonymous]]></name></author>
<updated>2005-03-02T18:55:23-07:00</updated>
<published>2005-03-02T18:55:23-07:00</published>
<id>http://forums.nesdev.com/viewtopic.php?t=212&amp;p=1385#p1385</id>
<link href="http://forums.nesdev.com/viewtopic.php?t=212&amp;p=1385#p1385"/>
<title type="html"><![CDATA[Mega Man 3 Scanline]]></title>

<content type="html" xml:base="http://forums.nesdev.com/viewtopic.php?t=212&amp;p=1385#p1385"><![CDATA[
<div class="quotetitle">Quietust wrote:</div><div class="quotecontent"><br />In performing some additional tests, I ran into another minor catch - sprite DMA actually takes 513 cycles, rather than the expected 512 (note that this does not include the 4 cycles necessary for the 'STA $4014' instruction).<br /><br />I have subsequently updated my emulator to reflect this information.<br /></div><br /><br />Are you sure? Isn't it just because of the CPU instruction delay before the DMA kicks in merely giving the impression that it takes 513 cycles and not 512?<p>Statistics: Posted by Guest — Wed Mar 02, 2005 6:55 pm</p><hr />
]]></content>
</entry>
<entry>
<author><name><![CDATA[Quietust]]></name></author>
<updated>2005-03-02T18:28:42-07:00</updated>
<published>2005-03-02T18:28:42-07:00</published>
<id>http://forums.nesdev.com/viewtopic.php?t=212&amp;p=1383#p1383</id>
<link href="http://forums.nesdev.com/viewtopic.php?t=212&amp;p=1383#p1383"/>
<title type="html"><![CDATA[Mega Man 3 Scanline]]></title>

<content type="html" xml:base="http://forums.nesdev.com/viewtopic.php?t=212&amp;p=1383#p1383"><![CDATA[
In performing some additional tests, I ran into another minor catch - sprite DMA actually takes 513 cycles, rather than the expected 512 (note that this does not include the 4 cycles necessary for the 'STA $4014' instruction).<br /><br />I have subsequently updated my emulator to reflect this information.<p>Statistics: Posted by <a href="http://forums.nesdev.com/memberlist.php?mode=viewprofile&amp;u=7">Quietust</a> — Wed Mar 02, 2005 6:28 pm</p><hr />
]]></content>
</entry>
<entry>
<author><name><![CDATA[Disch]]></name></author>
<updated>2005-03-01T23:23:13-07:00</updated>
<published>2005-03-01T23:23:13-07:00</published>
<id>http://forums.nesdev.com/viewtopic.php?t=212&amp;p=1363#p1363</id>
<link href="http://forums.nesdev.com/viewtopic.php?t=212&amp;p=1363#p1363"/>
<title type="html"><![CDATA[Mega Man 3 Scanline]]></title>

<content type="html" xml:base="http://forums.nesdev.com/viewtopic.php?t=212&amp;p=1363#p1363"><![CDATA[
ah, so you're just returning S[00] when the cycle is above 320.<br /><br />From what I can tell... Micro Machines isn't exactly super strict about this behavior.  All it really expects is to have the high bit clear when the cycle is between 320-340 and the high bit set if earlier or later.<br /><br />It's good to know the details anyway.  I've implimented the info you've posted in my emu.  It's not very efficient though... if a game were to constantly read 2004 all frame my emu would eat CPU time like a mofo XD.  But ah well.<br /><br />Another milestone in NESemdev!<p>Statistics: Posted by <a href="http://forums.nesdev.com/memberlist.php?mode=viewprofile&amp;u=33">Disch</a> — Tue Mar 01, 2005 11:23 pm</p><hr />
]]></content>
</entry>
<entry>
<author><name><![CDATA[Quietust]]></name></author>
<updated>2005-03-01T23:05:10-07:00</updated>
<published>2005-03-01T23:05:10-07:00</published>
<id>http://forums.nesdev.com/viewtopic.php?t=212&amp;p=1362#p1362</id>
<link href="http://forums.nesdev.com/viewtopic.php?t=212&amp;p=1362#p1362"/>
<title type="html"><![CDATA[Mega Man 3 Scanline]]></title>

<content type="html" xml:base="http://forums.nesdev.com/viewtopic.php?t=212&amp;p=1362#p1362"><![CDATA[
This is the code I use, and it gets Micro Machines glitch-free. It doesn't yet produce valid data when there are sprites on the scanline, though I'll be adding that later.<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">static   int   __fastcall   Read4 &#40;void&#41;<br />&#123;<br />   if &#40;PPU.IsRendering&#41;<br />   &#123;<br />      if &#40;PPU.Clockticks &lt; 64&#41;<br />         PPU.ppuLatch = 0xFF;<br />      else if &#40;PPU.Clockticks &lt; 192&#41;<br />         PPU.ppuLatch = PPU.Sprite&#91;&#40;&#40;PPU.Clockticks - 64&#41; &lt;&lt; 1&#41; &amp; 0xFC&#93;;<br />      else if &#40;PPU.Clockticks &lt; 256&#41;<br />         PPU.ppuLatch = &#40;PPU.Clockticks &amp; 1&#41; ? PPU.Sprite&#91;0xFC&#93; : PPU.Sprite&#91;&#40;&#40;PPU.Clockticks - 192&#41; &lt;&lt; 1&#41; &amp; 0xFC&#93;;<br />      else if &#40;PPU.Clockticks &lt; 320&#41;<br />         PPU.ppuLatch = 0xFF;<br />      else   PPU.ppuLatch = PPU.Sprite&#91;0&#93;;<br />   &#125;<br />   else   PPU.ppuLatch = PPU.Sprite&#91;PPU.SprAddr&#93;;<br />   return PPU.ppuLatch;<br />&#125;<br /></div><p>Statistics: Posted by <a href="http://forums.nesdev.com/memberlist.php?mode=viewprofile&amp;u=7">Quietust</a> — Tue Mar 01, 2005 11:05 pm</p><hr />
]]></content>
</entry>
<entry>
<author><name><![CDATA[Disch]]></name></author>
<updated>2005-03-01T22:14:08-07:00</updated>
<published>2005-03-01T22:14:08-07:00</published>
<id>http://forums.nesdev.com/viewtopic.php?t=212&amp;p=1361#p1361</id>
<link href="http://forums.nesdev.com/viewtopic.php?t=212&amp;p=1361#p1361"/>
<title type="html"><![CDATA[Mega Man 3 Scanline]]></title>

<content type="html" xml:base="http://forums.nesdev.com/viewtopic.php?t=212&amp;p=1361#p1361"><![CDATA[
I tried implimenting this and I've <strong>almost</strong> got Micro Machines working... but I'm still having some jitteriness problems.  With my current implimentation, the "?" racer at the top and racer list at the bottom get displayed fine... but the text in between them still messes up.<br /><br />It seems to come down to the [320-340] range.  The game doesn't seem to be reading in any of the other ranges (except for [0-63], but that's simple enough to impliment) -- EDIT:  crap I was getting the cycle wrong... it does read from under 320 sometimes... but my problem still remains.<br /><br />My current implimentation of reads when the PPU is in that cycle:<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">else // nScanCyc is in the &#91;320-340&#93; range<br />&#123;<br />  // find first sprite on line<br />  for&#40;i = 0; i &lt; 256; i += 4&#41;<br />  &#123;<br />    if&#40;&#40;u8&#41;&#40;nScanline - nSprRam&#91;i&#93;&#41; &lt; &#40;bSpr16 ? 16 : 8&#41;&#41; break;<br />  &#125;<br />  if&#40;i &lt; 256&#41;<br />  &#123;<br />    return nSprRam&#91;nSprRam&#91;i&#93;&#93;;<br />  &#125;<br />  else   //no sprite on line<br />  &#123;<br />    //not sure if this is right?<br />    return nSprRam&#91;0xFC&#93;;<br />  &#125;<br />&#125;<br /></div><br /><br />Anything standing out as being wrong?  There always seems to be a sprite found on the line (sprite 0 -- every time)<br /><br /><br />EDIT #2:<br /><br />I cutoff the [320-340] region code and just had it return 0 in that range... and that seemed to have solved everything.  Micro Machines seems to run perfectly now.  Is that what I should be doing?  or is my above code flawed somehow?<br /><br />Hrm... nSprRam[i]  instead of nSprRam[nSprRam[i]]   also works.  Maybe I just misinterpretted what you said before.  Nevermind ^^<br /><br />Thanks a million Q, you are the NES master.<p>Statistics: Posted by <a href="http://forums.nesdev.com/memberlist.php?mode=viewprofile&amp;u=33">Disch</a> — Tue Mar 01, 2005 10:14 pm</p><hr />
]]></content>
</entry>
<entry>
<author><name><![CDATA[Quietust]]></name></author>
<updated>2005-03-01T20:31:54-07:00</updated>
<published>2005-03-01T20:31:54-07:00</published>
<id>http://forums.nesdev.com/viewtopic.php?t=212&amp;p=1360#p1360</id>
<link href="http://forums.nesdev.com/viewtopic.php?t=212&amp;p=1360#p1360"/>
<title type="html"><![CDATA[Mega Man 3 Scanline]]></title>

<content type="html" xml:base="http://forums.nesdev.com/viewtopic.php?t=212&amp;p=1360#p1360"><![CDATA[
After adding a bit of extra logic to my emulator (namely, to <strong>not</strong> return $FF during cycles 320-340), the glitches in Micro Machines are completely gone. My $2004 read behavior is now mostly consistent with the real hardware when there are no sprites on the scanline; adding proper behavior when there ARE visible sprites will be an interesting task, though I <em>will</em> attempt it.<br />As usual, the current build can be found at <!-- m --><a class="postlink" href="http://nintendulator.sf.net/">http://nintendulator.sf.net/</a><!-- m --><br /><br />I still need to perform a few more tests, though, to answer a few questions:<br />1. What happens during cycles [256-319] when there are no sprites on the given scanline? (very first read would be either SPR_RAM[FC] or literal $FF)<br />2. When there are more than 8 sprites on a scanline, what happens during the remaining cycles in [64-255]? (will it attempt to fetch additional sprite data?)<br />3. What happens during the remaining cycles in [64-255] when sprite #63 is in range? (most likely nothing happens)<p>Statistics: Posted by <a href="http://forums.nesdev.com/memberlist.php?mode=viewprofile&amp;u=7">Quietust</a> — Tue Mar 01, 2005 8:31 pm</p><hr />
]]></content>
</entry>
<entry>
<author><name><![CDATA[Zepper]]></name></author>
<updated>2008-01-29T19:33:55-07:00</updated>
<published>2005-03-01T17:30:30-07:00</published>
<id>http://forums.nesdev.com/viewtopic.php?t=212&amp;p=1358#p1358</id>
<link href="http://forums.nesdev.com/viewtopic.php?t=212&amp;p=1358#p1358"/>
<title type="html"><![CDATA[Mega Man 3 Scanline]]></title>

<content type="html" xml:base="http://forums.nesdev.com/viewtopic.php?t=212&amp;p=1358#p1358"><![CDATA[
-deleted-<p>Statistics: Posted by <a href="http://forums.nesdev.com/memberlist.php?mode=viewprofile&amp;u=39">Zepper</a> — Tue Mar 01, 2005 5:30 pm</p><hr />
]]></content>
</entry>
<entry>
<author><name><![CDATA[Quietust]]></name></author>
<updated>2005-03-01T17:21:37-07:00</updated>
<published>2005-03-01T17:21:37-07:00</published>
<id>http://forums.nesdev.com/viewtopic.php?t=212&amp;p=1357#p1357</id>
<link href="http://forums.nesdev.com/viewtopic.php?t=212&amp;p=1357#p1357"/>
<title type="html"><![CDATA[Mega Man 3 Scanline]]></title>

<content type="html" xml:base="http://forums.nesdev.com/viewtopic.php?t=212&amp;p=1357#p1357"><![CDATA[
<div class="quotetitle">Drag wrote:</div><div class="quotecontent"><br />If sprite 63's y-coordinate were to be in range, while the ppu is thrashing, would the ppu read the rest of the data for that sprite, as though it weren't in "thrash mode"?<br /></div><br /><br />I don't know, but I personally doubt it.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent"><br />I assume the S[foo] reads don't serve a purpose directly related to the rendering of the sprite, right?<br /></div><br /><br />Not that I'm aware.<br /><br /><div class="quotetitle"><b>Quote:</b></div><div class="quotecontent"><br />and the sprite fetches are just the sprites that were in range?<br /></div><br />Of course - they correspond directly to the sprites that get rendered on the next scanline.<p>Statistics: Posted by <a href="http://forums.nesdev.com/memberlist.php?mode=viewprofile&amp;u=7">Quietust</a> — Tue Mar 01, 2005 5:21 pm</p><hr />
]]></content>
</entry>
</feed>