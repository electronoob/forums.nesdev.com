<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html dir="ltr" lang="en-gb">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta http-equiv="Content-Style-Type" content="text/css">
<meta http-equiv="Content-Language" content="en-gb">
<title>nesdev.com :: View topic - mode7 like f-zero</title>

<style type="text/css">
<!--

body {
	font-family: Verdana,serif;
	font-size: 10pt;
}

img {
	border: 0;
}

td {
	font-family: Verdana,serif;
	font-size: 10pt;
	line-height: 150%;
}

.code, .codecontent, 
.quote, .quotecontent {
	margin: 0 5px 0 5px;
	padding: 5px;
	font-size: smaller;
	border: black solid 1px;
}

.quotetitle {
	color: black;
	display : block;
	font-weight: bold;
}

.forum {
	font-family: Arial,Helvetica,sans-serif;
	font-weight: bold;
	font-size: 18pt;
}

.topic {
	font-family: Arial,Helvetica,sans-serif;
	font-size: 14pt;
	font-weight: bold;
}

.gensmall {
	font-size: 8pt;
}

hr {
	color: #888;
	height: 3px;
	border-style: solid;
}

hr.sep {
	color: #aaa;
	height: 1px;
	border-style: dashed;
}
//-->
</style>

</head>
<body>

<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
<tr>
	<td colspan="2" align="center"><span class="Forum">nesdev.com</span><br /><span class="gensmall"><a href="http://forums.nesdev.com/">http://forums.nesdev.com/</a></span></td>
</tr>
<tr>
	<td colspan="2"><br /></td>
</tr>
<tr>
	<td><span class="topic">mode7 like f-zero</span><br /><span class="gensmall"><a href="http://forums.nesdev.com/viewtopic.php?f=12&amp;t=8842">http://forums.nesdev.com/viewtopic.php?f=12&amp;t=8842</a></span></td>
	<td align="right" valign="bottom"><span class="gensmall">Page <strong>1</strong> of <strong>2</strong></span></td>
</tr>
</table>



	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>alekmaul</b> [ Tue Apr 24, 2012 12:34 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>mode7 like f-zero</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Hello all,
<br />I'm new here but not new for gba/nds homebrews (<!-- m --><a class="postlink" href="http://www.portabledev.com">http://www.portabledev.com</a><!-- m -->).
<br />Very nice forum with lot's of information regarding SNES.
<br />Some times ago, a french friend wanted to test some snes programming with C source code, so i began to do a snes lib based on snes sdk.
<br />You can see my work here : <!-- m --><a class="postlink" href="http://www.portabledev.com/wiki/doku.php">http://www.portabledev.com/wiki/doku.php</a><!-- m -->
<br />Currently, it works fine with mode1/mode3, scrolling, input, sprite.
<br />Here is my question : I begin to work on mode7 and i can do rotation / scaling but I have no idea to do something like F-ZERO or Mario Kart ...
<br />It seems a little different than on GBA or SNES because I can't use HBL interrupt ...
<br />I did a VBL interrupt like I saw in SNES wiki (to manage A..D Matrix , and so on ..) but i really don't know how can I simulate a ground like in F-ZERO or Mario Kart (or like in Squaresoft Mode 7 Demo).
<br />Please, can someone help me doing such effect ?

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>tepples</b> [ Tue Apr 24, 2012 1:01 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />I'm pretty sure that what they use is HDMA to change the rotation matrix after each scanline. At least that's how the "mode 7" effect is done in GBA mode 1.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Bregalad</b> [ Tue Apr 24, 2012 1:08 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />There is a HBL interrupt on the SNES, but it's rarely used - HDMA is more commonly used, so that you can change the scaling factor each scanline, and make the map progressively larger as it goes down to the screen, for the amazing 3D effect.
<br />
<br />You just need to find doccumentation about HDMA - which is DMA that can be programmed to write to registers automatically at the end of the desired scanline (in our case, you'd want to write matrix coefficient).
<br />
<br />I'm not sure if the SNES is fast enough to handle interrupts every scan line - especially if programmed in C, so I really think HDMA is a better approach. Interrupt would be the way to go if you only change a register once in the middle of the screen, and it would waste a HDMA channel for only a signle write.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>alekmaul</b> [ Tue Apr 24, 2012 9:50 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />thanks for reply, didn't think that HDMA was for Horizontal DMA, so stupid am I  <img src="./images/smilies/icon_redface.gif" alt=":oops:" title="Embarassed" /> 
<br />Will see if <!-- m --><a class="postlink" href="http://wiki.superfamicom.org/snes/show/Grog%27s+Guide+to+DMA+and+HDMA+on+the+SNES">http://wiki.superfamicom.org/snes/show/ ... n+the+SNES</a><!-- m --> is useful for that.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>wiiqwertyuiop</b> [ Wed Apr 25, 2012 8:16 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Also I'm not sure about F-Zero, but Mario Kart used the DSP-1 for it's mode 7 effects.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>alekmaul</b> [ Wed Apr 25, 2012 9:37 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />yes, certainly, it required the specfici dsp1 rom with no$sns.
<br />But now, i begin to have something that works with HDMA <img src="./images/smilies/icon_smile.gif" alt=":)" title="Smile" />. 
<br />
<br /><img src="http://www.portabledev.com/media/SNES/PVSnesLib/Mode7_Try1.png" alt="Image" />
<br />
<br />Just need to know how to add background like sky in FZero, certainly also with HDMA and correct registers.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>MottZilla</b> [ Wed Apr 25, 2012 9:56 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />I think for that you change screen settings part way down the screen, perhaps the screen mode itself. You could always watch F-Zero in a debugger to find out.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>smkd</b> [ Thu Apr 26, 2012 12:40 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />That's right. You can set up a channel to write the BG modes you want to $2105 for different parts of the screen.  For a game like F-Zero with mode 1 at the top and mode 7 at the bottom, you only have to change $2105 once in the middle of the frame. The IRQ method can also work well for that since it's only needed once so it won't add any real slowdown and will save you a channel for something else.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>alekmaul</b> [ Thu Apr 26, 2012 1:06 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />OK, thanks, will try that.
<br />HDMA is a really great feature for the Snes <img src="./images/smilies/icon_smile.gif" alt=":)" title="Smile" />

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Bregalad</b> [ Thu Apr 26, 2012 4:05 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">wiiqwertyuiop wrote:</div><div class="quotecontent">Also I'm not sure about F-Zero, but Mario Kart used the DSP-1 for it's mode 7 effects.</div>
<br />The DSP1 is not necessarly to do mode 7 effects.
<br />I think it was used to speed up the calculations to know the distance between the karts and things like that. I'm not too sure cause I haven't reverse engineered SMK, but I'm sure it's possible to do 3D style effects without using a DSP1.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>smkd</b> [ Thu Apr 26, 2012 7:48 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />F-Zero had tables in ROM for each angle they wanted visible. The game just points the HDMA source to the entry for the visible angle on screen. The camera only rotates on a single dimension when racing so that helps keep the number of table entries reasonable. It's limiting though depending on what flexibility you want in your game. You wouldn't get away with that method if you wanted something like Pilotwings. Too many tables for each possible angle if you wanted to avoid calculating anything in real time.
<br />
<br />Mario Kart had a similar approach even though it had a DSP1. They used the chip to build all the needed mode 7 tables once and stored them all in RAM. They get pointed to for HDMA similar to how F-Zero does it. Even though the DSP1 can do the mode 7 setup faster than the SNES, it still takes a while to actually get the results from the chip into RAM so I'm guessing that's why they precomputed everything. It's doing all of that when the "Nintendo" logo appears on startup if you want to see in a debugger. This method doesn't need a DSP1 obviously and it avoids excessive ROM usage too. Both F-Zero and Mario Kart had the same limits camera rotation so they could get away with this type of shortcut.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>tepples</b> [ Thu Apr 26, 2012 8:08 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />How many angles do those games use, and how many scanlines are in each table?

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>smkd</b> [ Fri Apr 27, 2012 5:38 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />I haven't touched F-Zero in a while and I forgot what it used.  F-Zero's track animation when you rotate is pretty jittery and the sprite animation doesn't look good either so they (understandably) cut corners there compared to SMK. I know SMK had 48K of RAM used for mode 7 plus some extra data for the overhead map view. It gets 128 angles worth of tables from the chip and only saves 2 of the ABCD parameters. Each one is 96 lines large so 128 * 96 * 2 = 24K each or 48K total for the 2 parameters.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>MottZilla</b> [ Fri Apr 27, 2012 9:04 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Does that mean SMK doesn't use the DSP chip after this table is precomputed?
<br />
<br />Edit: Nevermind, it apparently does.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Bregalad</b> [ Fri Apr 27, 2012 12:01 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />I don't really understand this approach.
<br />If I were to program something like that I'd definitely do all the calculations in real time.
<br />
<br />OK multiplications aren't so fast on 65xxx processors, and you have to compute 4 matrix coefficient for every scanline, but because of the symety of a rotation/scaling matrix, only 2 have to be computed, so there is 128 scanlines that 256 multiplications to do.
<br />
<br />However I'm sure there is ways to cheat and makes the multiplications faster, and that way you're not limited in angles and all this stuff.
<br />
<br />Also you could change the scaling factor only every 2 scanlines or so. Maybe it wouldn't look as great, but it would half the number of multiplications.

		

		</td>
	</tr>
	</table>


<hr width="85%" />

<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
<tr>
	<td><span class="gensmall">Page <strong>1</strong> of <strong>2</strong></span></td>
	<td align="right"><span class="gensmall">All times are UTC - 7 hours </span></td>
</tr>
<tr>
	<td colspan="2" align="center"><span class="gensmall">Powered by phpBB&reg; Forum Software &copy; phpBB Group<br />http://www.phpbb.com/</span></td>
</tr>
</table>

</body>
</html>