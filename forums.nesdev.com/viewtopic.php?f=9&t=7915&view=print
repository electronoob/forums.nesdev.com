<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html dir="ltr" lang="en-gb">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta http-equiv="Content-Style-Type" content="text/css">
<meta http-equiv="Content-Language" content="en-gb">
<title>nesdev.com :: View topic - 6502 Emulated on AVR, Any Uses for This?</title>

<style type="text/css">
<!--

body {
	font-family: Verdana,serif;
	font-size: 10pt;
}

img {
	border: 0;
}

td {
	font-family: Verdana,serif;
	font-size: 10pt;
	line-height: 150%;
}

.code, .codecontent, 
.quote, .quotecontent {
	margin: 0 5px 0 5px;
	padding: 5px;
	font-size: smaller;
	border: black solid 1px;
}

.quotetitle {
	color: black;
	display : block;
	font-weight: bold;
}

.forum {
	font-family: Arial,Helvetica,sans-serif;
	font-weight: bold;
	font-size: 18pt;
}

.topic {
	font-family: Arial,Helvetica,sans-serif;
	font-size: 14pt;
	font-weight: bold;
}

.gensmall {
	font-size: 8pt;
}

hr {
	color: #888;
	height: 3px;
	border-style: solid;
}

hr.sep {
	color: #aaa;
	height: 1px;
	border-style: dashed;
}
//-->
</style>

</head>
<body>

<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
<tr>
	<td colspan="2" align="center"><span class="Forum">nesdev.com</span><br /><span class="gensmall"><a href="http://forums.nesdev.com/">http://forums.nesdev.com/</a></span></td>
</tr>
<tr>
	<td colspan="2"><br /></td>
</tr>
<tr>
	<td><span class="topic">6502 Emulated on AVR, Any Uses for This?</span><br /><span class="gensmall"><a href="http://forums.nesdev.com/viewtopic.php?f=9&amp;t=7915">http://forums.nesdev.com/viewtopic.php?f=9&amp;t=7915</a></span></td>
	<td align="right" valign="bottom"><span class="gensmall">Page <strong>1</strong> of <strong>1</strong></span></td>
</tr>
</table>



	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>qbradq</b> [ Tue Jun 28, 2011 6:50 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>6502 Emulated on AVR, Any Uses for This?</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Hi all. I haven't posted any crazy hardware stuff last week because I was putting together an EEPROM burner with and Arduino board. This week my NROM board is broken, so I'll have to talk about something other than mappers <img src="./images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" />
<br />
<br />I had a thought in the shower this morning that I could probably emulate a 6502 on an AVR MCU. It would not be pin-compatible, nor would the logic timings match 100%, but the cycle times could be made to match the genuine article.
<br />
<br />Would there be any use for this anyone can think of? I've always wanted to build a single board computer based on a 6502, but I hate destroying original equipment for them and sourcing small quantities from WDC is not possible.
<br />
<br />Wow, I just double-checked WDC's website and they now have an online <a href="http://www.westerndesigncenter.com/wdc/Form_Order_Form.cfm" class="postlink">order form</a> and they have removed the $250 minimum order requirement. Now you can get your very own W65C02 for the low-low cost of $25 after S&amp;H. That's pretty cool <img src="./images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" />

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>teaguecl</b> [ Tue Jun 28, 2011 8:58 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />I personally can't think of a use for this other than to build a clone, but that's not the easiest way to do it.  I seriously doubt you could match the cycle times well enough to connect it to a 2C02 and have it work, which is why up till now people have used FPGA for this.  But don't let me deter you, I've been wrong before...

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>kevtris</b> [ Tue Jun 28, 2011 9:12 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: 6502 Emulated on AVR, Any Uses for This?</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">qbradq wrote:</div><div class="quotecontent">Hi all. I haven't posted any crazy hardware stuff last week because I was putting together an EEPROM burner with and Arduino board. This week my NROM board is broken, so I'll have to talk about something other than mappers <img src="./images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" /><br /><br />I had a thought in the shower this morning that I could probably emulate a 6502 on an AVR MCU. It would not be pin-compatible, nor would the logic timings match 100%, but the cycle times could be made to match the genuine article.<br /><br />Would there be any use for this anyone can think of? I've always wanted to build a single board computer based on a 6502, but I hate destroying original equipment for them and sourcing small quantities from WDC is not possible.<br /><br /></div>
<br />
<br />You can also buy 6502's and other related chips from places such as Jameco.  That, and you can probably find some on ebay too, either standalone or inside something (yeah, it only hurts a little while, hehe).  Actually there are probably random PCBs with 6502's and other older useful chips on them available.
<br />
<br />As for emulating the 6502 on a micro, I actually did do that back in 2001 or so on a PIC16F877 and later on a PIC18F452.  The purpose was for playing SID tunes.  It ended up working pretty decently.  An NSF player might be cool done in a similar fashion, but generating the audio might need a second microcontroller, since I suspect it'd take quite a bit of horsepower to do so.
<br />
<br />On the SID emulator though I did manage to play the digi stuff using the PIC while it emulated the C64 and 6502 and everything else.  That was on a 38.18MHz PIC so an AVR shouldn't have much issues.  
<br />
<br />Of course it was not cycle accurate at all, but this wasn't a concern for SID tunes and it isn't a concern for NSFs.   You might be able to get away with less than full speed operation (maybe even 20% to 30% full speed) for NSFs since they are designed to take up maybe 5-10% max of the CPU time per frame.
<br />
<br />I ended up emulating a 6800 and 8085 later on using the same 18F452 for a speech synthesizer and a product at work, respectively.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>qbradq</b> [ Tue Jun 28, 2011 10:50 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Thanks for the tip Kevtris! I never thought of looking on Jameco for a 6502. It's only $5.95 <img src="./images/smilies/icon_biggrin.gif" alt=":D" title="Very Happy" />
<br />
<br />I also see they have 80486's laying around as well. I'll have to remember that if I ever need to refurb an old beige box.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>hyarion</b> [ Tue Jun 28, 2011 3:08 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />I helped a friend port a 6502 emulator to an atmega (AVR) back in 2006(?) and connected that to a SID chip (apperently just like kevtris), so yes it is possible.
<br />
<br />I remember though, that we had some problem with the memory. The emu tried to allocate a static 64KB array, which ofcause didn't fit in the MCu RAM. We found that we could substitute it to a linked list instead with linear access time. Sure a hashmap would have been better but it turned out that only &lt;20 bytes was used by most of the songs anyway so it didn't really matter.
<br />
<br />What i'm trying to say is that it works but you might want to add external memory if you want to run programs that use more memory than ~512Bytes. <img src="./images/smilies/icon_smile.gif" alt=":)" title="Smile" />

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>tepples</b> [ Tue Jun 28, 2011 4:47 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Only 20 bytes? That sounds a bit low. Could someone who has experience with SID playback engines <a href="http://nesdev.com/bbs/viewtopic.php?p=80736#80736" class="postlink">help me understand</a>?

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Jarhmander</b> [ Tue Jun 28, 2011 4:57 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />The complexity of the sound engine is unspecified. I suspect that Rob Hubard's or Jeroen Tel's is more hungry in RAM.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Memblers</b> [ Tue Jun 28, 2011 5:53 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />I remember thinking it would be cool to do that with the PIC18F452 on the original Squeedo board.  The slow speed of it compared to just using PIC18F asm made me figure it a low priority, but I thought if I had released that cart, it would have been an easy way for developers to speed their programs up without rewriting it much (using it as a co-processor).
<br />
<br />With the (eventual) rev3 Squeedo it will be lot more interesting, because I'm pretty sure the MCU (w/ MIPS32 @ 80Mhz) would be able to emulate it faster than the NES CPU runs.  Why not put the whole game there? <img src="./images/smilies/icon_razz.gif" alt=":P" title="Razz" />
<br />
<br />So yeah I think something like that, if a cart had an MCU as a coprocessor could be interesting.  It would still better to just write native code though, and use the speed for something. <img src="./images/smilies/icon_smile.gif" alt=":)" title="Smile" />

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>kevtris</b> [ Wed Jun 29, 2011 8:54 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">hyarion wrote:</div><div class="quotecontent">I helped a friend port a 6502 emulator to an atmega (AVR) back in 2006(?) and connected that to a SID chip (apperently just like kevtris), so yes it is possible.<br /><br />I remember though, that we had some problem with the memory. The emu tried to allocate a static 64KB array, which ofcause didn't fit in the MCu RAM. We found that we could substitute it to a linked list instead with linear access time. Sure a hashmap would have been better but it turned out that only &lt;20 bytes was used by most of the songs anyway so it didn't really matter.<br /><br />What i'm trying to say is that it works but you might want to add external memory if you want to run programs that use more memory than ~512Bytes. <img src="./images/smilies/icon_smile.gif" alt=":)" title="Smile" /></div>
<br />
<br />I am dubious about it only taking 20 bytes of RAM.  Most replay engines seem to use quite a bit of space for RAM.  A good 100 to 200 bytes or so, depending on the replay engine.  I could see such a thing working, but many tunes will also relocate code in memory, uncompressing before playback.
<br />
<br />I ended up going with a 512K battery backed SRAM.  64K of this was used for the "virtual C64" memory arena that I executed out of, and the remainder was used as a smallish RAM drive to store the tunes.  On selection, it'd clear the first 64K of RAM, then load the SID tune into RAM and run it from there.
<br />
<br />To make a good job of it,  you also have to support the registers at 0000h and 0001h for bankswitching, too (this allows you to turn off the C64's kernal and basic ROMs, as well as unmapping the IO (SID chip, etc) since some tunes store data here).  Supporting the CIA timer (generally, just a 16 bit timer mapped in at 0314h and 0315h).
<br />
<br />I ended up using an external PLL chip (4046) and a divide by 64 (4040) chip to make a *64 PLL, which I fed from one of the PIC's timers.  This allowed for PAL and NTSC speed selection, and produced the approx. 1MHz clock for the SID chips.  This clock was fed back into the PIC, and operated another 16 bit timer which was used to time the music playback code, allowing for SID tune selectable CIA rates.  It also fed the 3rd PIC timer which was used to run the PCM digi engine.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>hyarion</b> [ Thu Jun 30, 2011 12:30 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b></b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">kevtris wrote:</div><div class="quotecontent">I am dubious about it only taking 20 bytes of RAM.  Most replay engines seem to use quite a bit of space for RAM.  A good 100 to 200 bytes or so, depending on the replay engine.  I could see such a thing working, but many tunes will also relocate code in memory, uncompressing before playback.<br /></div>
<br />
<br />hmmm... 20 sounds a bit low when I think of it, but that is however what I remember, 200 sounds more reasonable... guess my I should have allocated some more bytes in my own memory, or at least documented it somewhere :/

		

		</td>
	</tr>
	</table>


<hr width="85%" />

<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
<tr>
	<td><span class="gensmall">Page <strong>1</strong> of <strong>1</strong></span></td>
	<td align="right"><span class="gensmall">All times are UTC - 7 hours </span></td>
</tr>
<tr>
	<td colspan="2" align="center"><span class="gensmall">Powered by phpBB&reg; Forum Software &copy; phpBB Group<br />http://www.phpbb.com/</span></td>
</tr>
</table>

</body>
</html>