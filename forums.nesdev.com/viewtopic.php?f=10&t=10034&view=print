<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html dir="ltr" lang="en-gb">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta http-equiv="Content-Style-Type" content="text/css">
<meta http-equiv="Content-Language" content="en-gb">
<title>nesdev.com :: View topic - cc65 makes comparing variables require a subroutine</title>

<style type="text/css">
<!--

body {
	font-family: Verdana,serif;
	font-size: 10pt;
}

img {
	border: 0;
}

td {
	font-family: Verdana,serif;
	font-size: 10pt;
	line-height: 150%;
}

.code, .codecontent, 
.quote, .quotecontent {
	margin: 0 5px 0 5px;
	padding: 5px;
	font-size: smaller;
	border: black solid 1px;
}

.quotetitle {
	color: black;
	display : block;
	font-weight: bold;
}

.forum {
	font-family: Arial,Helvetica,sans-serif;
	font-weight: bold;
	font-size: 18pt;
}

.topic {
	font-family: Arial,Helvetica,sans-serif;
	font-size: 14pt;
	font-weight: bold;
}

.gensmall {
	font-size: 8pt;
}

hr {
	color: #888;
	height: 3px;
	border-style: solid;
}

hr.sep {
	color: #aaa;
	height: 1px;
	border-style: dashed;
}
//-->
</style>

</head>
<body>

<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
<tr>
	<td colspan="2" align="center"><span class="Forum">nesdev.com</span><br /><span class="gensmall"><a href="http://forums.nesdev.com/">http://forums.nesdev.com/</a></span></td>
</tr>
<tr>
	<td colspan="2"><br /></td>
</tr>
<tr>
	<td><span class="topic">cc65 makes comparing variables require a subroutine</span><br /><span class="gensmall"><a href="http://forums.nesdev.com/viewtopic.php?f=10&amp;t=10034">http://forums.nesdev.com/viewtopic.php?f=10&amp;t=10034</a></span></td>
	<td align="right" valign="bottom"><span class="gensmall">Page <strong>1</strong> of <strong>1</strong></span></td>
</tr>
</table>



	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>strat</b> [ Sat Apr 20, 2013 3:49 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>cc65 makes comparing variables require a subroutine</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />I'm starting to program for the NES in C and noticed that an if statement comparing two variables compiled to calling pusha0 and tosicmp.  Shiru's example project &quot;Chase&quot; compiles to the same thing.  It seems like tosicmp is supposed to be doing a signed comparison, but it's called regardless if the variables are signed or unsigned, 8-bit or 16-bit.  The only workaround would be a macro with inline assembly, but that's obviously not why I'm using C to begin with.  So does anybody who uses cc65 know how to get rid of it?

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>thefox</b> [ Sat Apr 20, 2013 4:10 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: cc65 makes comparing variables require a subroutine</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Please show code and the compiler flags you're using.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Bregalad</b> [ Sat Apr 20, 2013 8:57 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: cc65 makes comparing variables require a subroutine</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />That's fairly typical of cc65. From my experience, code generated by cc65 will be between 8 and 20 times more instructions and slower than hand written assembly code.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>strat</b> [ Sat Apr 20, 2013 5:30 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: cc65 makes comparing variables require a subroutine</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />It's only an 'if' statement<br /><br />if (var0 &lt; var1)<br /><br />becomes<br />jsr pusha0<br />...<br />jsr tosicmp<br />bcs label<br /><br />the compiler flag is Oi.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>lidnariq</b> [ Sat Apr 20, 2013 7:01 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: cc65 makes comparing variables require a subroutine</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />The ANSI C standard specifies that all math is promoted to at least 16 bit. While I've used compilers that don't enforce that (PICC, e.g.), things like SDCC and CC65 seem to (even though they're not ANSI C compilers)

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>tepples</b> [ Sat Apr 20, 2013 7:08 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: cc65 makes comparing variables require a subroutine</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />If both arguments are known to be 8-bit before promotion, isn't there a way to do the comparison <a href="http://en.cppreference.com/w/cpp/language/as_if" class="postlink">as if</a> the operands had been promoted to 16-bit without actually promoting them?

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>strat</b> [ Sat Apr 20, 2013 11:24 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: cc65 makes comparing variables require a subroutine</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Ummm... well... I went ahead and downloaded the src for cc65 with the idea of tinkering with it, and after running the build tried it with the -Or flag.  The compare symbols &quot;&lt;&quot; and &quot;&gt;=&quot; compile to cmp/branch pairs as expected.  Guess it never hurts to check the latest download; it was updated in Feb. of this year.<br /><br />Just for the record, I'm sure the asm it outputs will be adequate given the C code conforms to 6502 restrictions.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>Shiru</b> [ Sat Apr 20, 2013 11:50 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: cc65 makes comparing variables require a subroutine</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />Is the latest download in the Download section (cc65-win32-2.13.3-1.zip), or you have built it from sources? Because latest compiled download is from Feb. 2012.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>strat</b> [ Sun Apr 21, 2013 1:51 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: cc65 makes comparing variables require a subroutine</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />The one I'm using is built from source.

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>thefox</b> [ Sun Apr 21, 2013 2:45 am ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: cc65 makes comparing variables require a subroutine</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" /><div class="quotetitle">strat wrote:</div><div class="quotecontent">It's only an 'if' statement<br /><br />if (var0 &lt; var1)<br /><br />becomes<br />jsr pusha0<br />...<br />jsr tosicmp<br />bcs label<br /><br />the compiler flag is Oi.</div><br />I meant the complete, compilable source code, to see if there are integer promotion issues etc. But looks like your issue is solved already.<br /><br /><div class="quotetitle">Shiru wrote:</div><div class="quotecontent">Is the latest download in the Download section (cc65-win32-2.13.3-1.zip), or you have built it from sources? Because latest compiled download is from Feb. 2012.</div><br />There <em>was</em> a recent snapshot build available on cc65.org during the last couple of months, but since Uz is stepping down as the maintainer of CC65 the download folder has been removed. &quot;Stable&quot; versions are/were released quite rarely, so I really would suggest everybody to use the snapshot version, I never had any major problems with it.<br /><br />I guess the snapshot builds may resurface at some point, but if and while they don't, here's a link to a fairly recent Win32 build: <!-- m --><a class="postlink" href="http://thefox.aspekt.fi/cc65-snapshot-win32-2.13.9.20130307-1.zip">http://thefox.aspekt.fi/cc65-snapshot-w ... 0307-1.zip</a><!-- m -->

		

		</td>
	</tr>
	</table>


	<hr width="85%" />

	<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
	<tr>
		<td width="10%" nowrap="nowrap">Author:&nbsp;</td>
		<td><b>strat</b> [ Sun Apr 21, 2013 1:09 pm ]</td>
	</tr>
	<tr>
		<td width="10%" nowrap="nowrap">Post subject:&nbsp;</td>
		<td><b>Re: cc65 makes comparing variables require a subroutine</b></td>
	</tr>
	<tr>
		<td colspan="2"><hr class="sep" />It happened on the older version (V2.12.0) with minimal source code (a main and two variables).  I just dug it out to test for integer promotion - addition is still 8-bit.  Here's the code for the heck of it.<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">char var0;<br />char var1;<br />char var2;<br />void main(void) {<br /><br />&nbsp; &nbsp;var0 = 5;<br />&nbsp; &nbsp;var1 = 6;<br />&nbsp; &nbsp;var2 = var0 + var1;<br />&nbsp; &nbsp;if (var0 &lt; var1) {<br />&nbsp; &nbsp;&nbsp; &nbsp;var2 = 8;<br />&nbsp; &nbsp;}<br /><br />}<br /><br />Compile with -Or flag<br /><br />;<br />; var0 = 5;<br />;<br />&nbsp; &nbsp;lda&nbsp; &nbsp; &nbsp;#$05<br />&nbsp; &nbsp;sta&nbsp; &nbsp; &nbsp;_var0<br />;<br />; var1 = 6;<br />;<br />&nbsp; &nbsp;lda&nbsp; &nbsp; &nbsp;#$06<br />&nbsp; &nbsp;sta&nbsp; &nbsp; &nbsp;_var1<br />;<br />; var2 = var0 + var1;<br />;<br />&nbsp; &nbsp;lda&nbsp; &nbsp; &nbsp;_var0<br />&nbsp; &nbsp;clc<br />&nbsp; &nbsp;adc&nbsp; &nbsp; &nbsp;_var1<br />&nbsp; &nbsp;sta&nbsp; &nbsp; &nbsp;_var2<br />;<br />; if (var0 &lt; var1) {<br />;<br />&nbsp; &nbsp;lda&nbsp; &nbsp; &nbsp;_var0<br />&nbsp; &nbsp;jsr&nbsp; &nbsp; &nbsp;pusha0<br />&nbsp; &nbsp;lda&nbsp; &nbsp; &nbsp;_var1<br />&nbsp; &nbsp;jsr&nbsp; &nbsp; &nbsp;tosicmp<br />&nbsp; &nbsp;bcs&nbsp; &nbsp; &nbsp;L0009<br />;<br />; var2 = 8;<br />;<br />&nbsp; &nbsp;lda&nbsp; &nbsp; &nbsp;#$08<br />&nbsp; &nbsp;sta&nbsp; &nbsp; &nbsp;_var2<br />;<br />; }<br />;<br />L0009:&nbsp; &nbsp;rts<br /></div><br /><br />But this indeed got fixed in newer versions, so it's all good.

		

		</td>
	</tr>
	</table>


<hr width="85%" />

<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
<tr>
	<td><span class="gensmall">Page <strong>1</strong> of <strong>1</strong></span></td>
	<td align="right"><span class="gensmall">All times are UTC - 7 hours </span></td>
</tr>
<tr>
	<td colspan="2" align="center"><span class="gensmall">Powered by phpBB&reg; Forum Software &copy; phpBB Group<br />http://www.phpbb.com/</span></td>
</tr>
</table>

</body>
</html>