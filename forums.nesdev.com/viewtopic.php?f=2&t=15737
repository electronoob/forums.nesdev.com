<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en-gb" xml:lang="en-gb">
<head>

<link rel="icon" href="/favicon.ico" type="image/x-icon" />
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
<meta http-equiv="content-language" content="en-gb" />
<meta http-equiv="content-style-type" content="text/css" />
<meta http-equiv="imagetoolbar" content="no" />
<meta name="resource-type" content="document" />
<meta name="distribution" content="global" />
<meta name="keywords" content="" />
<meta name="description" content="" />

<title>nesdev.com &bull; View topic - Game stuck at credits, except during soft reset</title>

<link rel="alternate" type="application/atom+xml" title="Feed - nesdev.com" href="http://forums.nesdev.com/feed.php" /><link rel="alternate" type="application/atom+xml" title="Feed - News" href="http://forums.nesdev.com/feed.php?mode=news" /><link rel="alternate" type="application/atom+xml" title="Feed - All forums" href="http://forums.nesdev.com/feed.php?mode=forums" /><link rel="alternate" type="application/atom+xml" title="Feed - New Topics" href="http://forums.nesdev.com/feed.php?mode=topics" /><link rel="alternate" type="application/atom+xml" title="Feed - Active Topics" href="http://forums.nesdev.com/feed.php?mode=topics_active" /><link rel="alternate" type="application/atom+xml" title="Feed - Forum - NESdev" href="http://forums.nesdev.com/feed.php?f=2" /><link rel="alternate" type="application/atom+xml" title="Feed - Topic - Game stuck at credits, except during soft reset" href="http://forums.nesdev.com/feed.php?f=2&amp;t=15737" />

<link rel="stylesheet" href="./style.php?id=1&amp;lang=en" type="text/css" />

<script type="text/javascript">
// <![CDATA[


function popup(url, width, height, name)
{
	if (!name)
	{
		name = '_popup';
	}

	window.open(url.replace(/&amp;/g, '&'), name, 'height=' + height + ',resizable=yes,scrollbars=yes,width=' + width);
	return false;
}

function jumpto()
{
	var page = prompt('Enter the page number you wish to go to:', '1');
	var per_page = '';
	var base_url = '';

	if (page !== null && !isNaN(page) && page == Math.floor(page) && page > 0)
	{
		if (base_url.indexOf('?') == -1)
		{
			document.location.href = base_url + '?start=' + ((page - 1) * per_page);
		}
		else
		{
			document.location.href = base_url.replace(/&amp;/g, '&') + '&start=' + ((page - 1) * per_page);
		}
	}
}

/**
* Find a member
*/
function find_username(url)
{
	popup(url, 760, 570, '_usersearch');
	return false;
}

/**
* Mark/unmark checklist
* id = ID of parent container, name = name prefix, state = state [true/false]
*/
function marklist(id, name, state)
{
	var parent = document.getElementById(id);
	if (!parent)
	{
		eval('parent = document.' + id);
	}

	if (!parent)
	{
		return;
	}

	var rb = parent.getElementsByTagName('input');
	
	for (var r = 0; r < rb.length; r++)
	{
		if (rb[r].name.substr(0, name.length) == name)
		{
			rb[r].checked = state;
		}
	}
}



// ]]>
</script>
</head>
<body class="ltr">

<a name="top"></a>

<div id="wrapheader">

	<div id="logodesc">
	</div>

	<div id="menubar">

		<table width="100%" cellspacing="0">
		<tr>
			<td rowspan="2"><a href="./index.php"><img src="./styles/subsilver2/imageset/site_logo.gif" alt="" title="" /></a></td>
			<td width="100%" align="center"><h1>nesdev.com</h1><span class="gen">NES Development and Strangulation Records message boards</span></td>
		</tr>
		<tr>
			<td align="center">
				<!--<div style="float: right;">
					<form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_top">
					<input type="hidden" name="cmd" value="_s-xclick">
					<input type="hidden" name="hosted_button_id" value="X2HM4WNR5YT8S">
					<input type="image" src="https://www.paypalobjects.com/en_US/i/btn/btn_donateCC_LG.gif" border="0" name="submit" alt="PayPal - The safer, easier way to pay online!">
					<img alt="" border="0" src="https://www.paypalobjects.com/en_US/i/scr/pixel.gif" width="1" height="1">
					</form>
				</div>-->
				<a href="./faq.php"><img src="./styles/prosilver/theme/images/icon_mini_faq.gif" width="12" height="13" alt="*" /> FAQ</a>
				&nbsp; &nbsp;<a href="./search.php"><img src="./styles/prosilver/theme/images/icon_mini_search.gif" width="12" height="13" alt="*" /> Search</a>
				<br />	
				 &nbsp;<a href="./ucp.php?mode=minion"><img src="./styles/prosilver/theme/images/icon_mini_register.gif" width="12" height="13" alt="*" /> Register</a>
					&nbsp; &nbsp;<a href="./ucp.php?mode=login"><img src="./styles/prosilver/theme/images/icon_mini_login.gif" width="12" height="13" alt="*" /> Login</a>&nbsp;
			</td>
		</tr>
		</table>
	</div>

	<div id="datebar">
		<table width="100%" cellspacing="0">
		<tr>
			<td class="gensmall"></td>
			<td class="gensmall" align="right">It is currently Fri Aug 17, 2018 12:27 am<br /></td>
		</tr>
		</table>
	</div>

</div>

<div id="wrapcentre">

	
	<p class="searchbar">
		<span style="float: left;"><a href="./search.php?search_id=unanswered">View unanswered posts</a> | <a href="./search.php?search_id=active_topics">View active topics</a></span>
		
	</p>
	

	<br style="clear: both;" />

	<table class="tablebg" width="100%" cellspacing="1" cellpadding="0" style="margin-top: 5px;">
	<tr>
		<td class="row1">
			<p class="breadcrumbs"><a href="./index.php">Board index</a> &#187; <a href="./viewforum.php?f=24">NES / Famicom</a> &#187; <a href="./viewforum.php?f=2">NESdev</a></p>
			<p class="datetime">All times are UTC - 7 hours </p>
		</td>
	</tr>
	</table>

	<br />
	

					<center>
					<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
					<!-- NesDev Forums -->
					<ins class="adsbygoogle"
						 style="display:block"
						 data-ad-client="ca-pub-7801010229099644"
						 data-ad-slot="7979066809"
						 data-ad-format="auto"></ins>
					<script>
					(adsbygoogle = window.adsbygoogle || []).push({});
					</script>
					</center>
	<br />


<div id="pageheader">
	<h2><a class="titles" href="./viewtopic.php?f=2&amp;t=15737">Game stuck at credits, except during soft reset</a></h2>


	<p class="moderators">Moderator: <a href="./memberlist.php?mode=group&amp;g=320">Moderators</a></p>

</div>

<br clear="all" /><br />

<div id="pagecontent">

	<table width="100%" cellspacing="1">
	<tr>
		<td align="left" valign="middle" nowrap="nowrap">
		<a href="./posting.php?mode=post&amp;f=2"><img src="./styles/subsilver2/imageset/en/button_topic_new.gif" alt="Post new topic" title="Post new topic" /></a>&nbsp;<a href="./posting.php?mode=reply&amp;f=2&amp;t=15737"><img src="./styles/subsilver2/imageset/en/button_topic_reply.gif" alt="Reply to topic" title="Reply to topic" /></a>
		</td>
		
			<td class="nav" valign="middle" nowrap="nowrap">&nbsp;Page <strong>1</strong> of <strong>1</strong><br /></td>
			<td class="gensmall" nowrap="nowrap">&nbsp;[ 15 posts ]&nbsp;</td>
			<td class="gensmall" width="100%" align="right" nowrap="nowrap"></td>
		
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr>
		<td class="cat">
			<table width="100%" cellspacing="0">
			<tr>
				<td class="nav" nowrap="nowrap">&nbsp;
				<a href="./viewtopic.php?f=2&amp;t=15737&amp;view=print" title="Print view">Print view</a>
				</td>
				<td class="nav" align="right" nowrap="nowrap"><a href="./viewtopic.php?f=2&amp;t=15737&amp;view=previous">Previous topic</a> | <a href="./viewtopic.php?f=2&amp;t=15737&amp;view=next">Next topic</a>&nbsp;</td>
			</tr>
			</table>
		</td>
	</tr>

	</table>


	<table class="tablebg" width="100%" cellspacing="1">
	
		<tr>
			<th>Author</th>
			<th>Message</th>
		</tr>
	<tr class="row1">

			<td align="center" valign="middle">
				<a name="p192287"></a>
				<b class="postauthor">DRW</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p192287">Game stuck at credits, except during soft reset</a></div><div style="float: right;"><a href="./viewtopic.php?p=192287#p192287"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Fri Mar 31, 2017 11:30 am&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				<tr>
					<td><img src="./download/file.php?avatar=6156_1471126672.png" width="100" height="88" alt="User avatar" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Sat Sep 07, 2013 2:59 pm<br /><b>Posts:</b> 1662
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">Today, I tried out the cartridge of my game and I saw that the game gets suck during the credits screen and you cannot advance.<br />If you press Reset or if you press Power in a very short amount of time, it works.<br /><br />The game does use sprite 0 split and nine sprites overflow split, even in the credits screen where it is not necessary, but I didn't want to change the logic for it.<br />However, I'm not sure why this works after a reset, but not during power on.<br /><br />Can this have anything to do with the PPU not being ready yet or something like this? In a way that the background is already enabled, but sprites are not (despite me enabling both at the same time) and the game goes into an infinity loop waiting for sprite 0?<br /><br />None of the popular emulators, fceux, Nestopia and Nintendulator, shows this behavior with the ROM. And it was fine when I last checked it with a PowerPak.<br /><br /><br />If there's no known way how I could reproduce the error on an emulator, does anybody on this forum have the means to test the game on an actual cartridge?<br />PowerPak or Everdrive would not suffice. It has to be an actual standalone 32 KB NROM cartridge with vertical mirroring.</div>

					
						<div class="postbody"><br />_________________<br />Available now: My game &quot;City Trouble&quot;.<br />Website: <!-- m --><a class="postlink" href="https://megacatstudios.com/products/city-trouble">https://megacatstudios.com/products/city-trouble</a><!-- m --><br />Trailer: <!-- m --><a class="postlink" href="https://youtu.be/IYXpP59qSxA">https://youtu.be/IYXpP59qSxA</a><!-- m --><br />Gameplay: <!-- m --><a class="postlink" href="https://youtu.be/Eee0yurkIW4">https://youtu.be/Eee0yurkIW4</a><!-- m --><br />German Retro Gamer article: <!-- m --><a class="postlink" href="http://i67.tinypic.com/345o108.jpg">http://i67.tinypic.com/345o108.jpg</a><!-- m --></div>
					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=6156"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row2">

			<td align="center" valign="middle">
				<a name="p192296"></a>
				<b class="postauthor">lidnariq</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p192296">Re: Game stuck at credits, except during soft reset</a></div><div style="float: right;"><a href="./viewtopic.php?p=192296#p192296"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Fri Mar 31, 2017 11:50 am&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Sun Apr 13, 2008 11:12 am<br /><b>Posts:</b> 7391<br /><b>Location:</b> Seattle
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">Is there any memory or PPU/APU register that you didn't set to a known value in your powerup routine?</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=3512"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row1">

			<td align="center" valign="middle">
				<a name="p192298"></a>
				<b class="postauthor">DRW</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p192298">Re: Game stuck at credits, except during soft reset</a></div><div style="float: right;"><a href="./viewtopic.php?p=192298#p192298"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Fri Mar 31, 2017 11:57 am&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				<tr>
					<td><img src="./download/file.php?avatar=6156_1471126672.png" width="100" height="88" alt="User avatar" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Sat Sep 07, 2013 2:59 pm<br /><b>Posts:</b> 1662
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">I don't know. Actually, I did all the stuff that needs to be done, according to the tutorials and the wiki.<br /><br />Maybe not enough wait for vblank?<br /><br />However, here's the (hopefully) relevant code:<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">.segment &quot;CODE&quot;<br /><br />&nbsp; &nbsp;; Wait for vblank is needed more than once, so we declare it as a macro.<br />.macro WAIT_FOR_VBLANK<br />&nbsp; &nbsp;.local @waitForVBlank<br /><br />&nbsp; &nbsp;; Check the vblank flag to be sure that we wait for a vertical blank.<br />&nbsp; &nbsp;BIT PpuStatus<br /><br />@waitForVBlank:<br /><br />&nbsp; &nbsp;; The vblank flag is cleared and we wait while the resulting value is positive.<br />&nbsp; &nbsp;BIT PpuStatus<br />&nbsp; &nbsp;BPL @waitForVBlank<br />.endmacro<br /><br />&nbsp; &nbsp;; There are several PPU statuses that we need to wait for,<br />&nbsp; &nbsp;; so we declare it as a macro with a parameter.<br />.macro WAIT_FOR_PPU_STATUS value<br />&nbsp; &nbsp;.local @waitForNotPpuStatus, @waitForPpuStatus<br /><br />&nbsp; &nbsp;; Wait while the PPU status hasn't happened.<br />@waitForNotPpuStatus:<br /><br />&nbsp; &nbsp;; Checks if the status has happened.<br />&nbsp; &nbsp;LDA PpuStatus<br />&nbsp; &nbsp;AND #value<br />&nbsp; &nbsp;BNE @waitForNotPpuStatus<br /><br />&nbsp; &nbsp;; Wait until the status has happened.<br />@waitForPpuStatus:<br /><br />&nbsp; &nbsp;; Checks if the status has happened.<br />&nbsp; &nbsp;LDA PpuStatus<br />&nbsp; &nbsp;AND #value<br />&nbsp; &nbsp;BEQ @waitForPpuStatus<br /><br />&nbsp; &nbsp;; The status has happened now.<br />.endmacro<br /><br />&nbsp; &nbsp;; Due to parallax scrolling, we set the scrolling position more than once.<br />.macro SET_SCROLLING_POSITION scrollingPosition, nameTable<br />&nbsp; &nbsp;; The horizontal scrolling position is set while vertical scrolling is always 0.<br />&nbsp; &nbsp;LDA scrollingPosition<br />&nbsp; &nbsp;STA PpuScroll<br />&nbsp; &nbsp;LDA #0<br />&nbsp; &nbsp;STA PpuScroll<br /><br />&nbsp; &nbsp;; We set the name table by taking the horizontal PPU control register value<br />&nbsp; &nbsp;; and OR-connect it with the currently set name table value.<br />&nbsp; &nbsp;; In the PPU control register, the name tables are set at bit 1 and 0, so the OR works.<br />&nbsp; &nbsp;LDA #PpuCtrlHorizontal<br />&nbsp; &nbsp;ORA nameTable<br />&nbsp; &nbsp;STA PpuCtrl<br />.endmacro<br /><br />&nbsp; &nbsp;; The start of the reset function.<br />Reset:<br /><br />&nbsp; &nbsp;; At first, general system initialization has to be done.<br /><br />&nbsp; &nbsp;; Disable interrupt requests (IRQs).<br />&nbsp; &nbsp;SEI<br /><br />&nbsp; &nbsp;; Disable decimal mode since it isn't available on the NES anyway.<br />&nbsp; &nbsp;CLD<br /><br />&nbsp; &nbsp;; Disable APU frame IRQ.<br />&nbsp; &nbsp;LDX #$40<br />&nbsp; &nbsp;STX ApuFrameCounter<br /><br />&nbsp; &nbsp;; Set up the stack.<br />&nbsp; &nbsp;LDX #$FF<br />&nbsp; &nbsp;TXS<br /><br />&nbsp; &nbsp;; Set X to 0.<br />&nbsp; &nbsp;INX<br /><br />&nbsp; &nbsp;; Disable NMI, rendering and DMC IRQs.<br />&nbsp; &nbsp;STX PpuCtrl<br />&nbsp; &nbsp;STX PpuMask<br />&nbsp; &nbsp;STX DmcFreq<br /><br />&nbsp; &nbsp;; The PPU needs two waits for vblank to be ready.<br />&nbsp; &nbsp;; This is the first one.<br />&nbsp; &nbsp;WAIT_FOR_VBLANK<br /><br />&nbsp; &nbsp;; In the meantime, set the whole RAM memory (i.e. all variables) to zero.<br />&nbsp; &nbsp;; The RAM goes from address $0000 to $07FF.<br />&nbsp; &nbsp;; The current address value goes into a two bytes pointer.<br />&nbsp; &nbsp;; The values are set in two loops.<br /><br />&nbsp; &nbsp;; X is still 0.<br /><br />&nbsp; &nbsp;; The X and Y registers are used as counters for the loops and initialized with 0.<br />&nbsp; &nbsp;TXA<br />&nbsp; &nbsp;TAY<br /><br />&nbsp; &nbsp;; A, X and Y all have the value 0 now.<br /><br />&nbsp; &nbsp;; Pointer always remains 0.<br />&nbsp; &nbsp;; The address is calculated by Pointer + 1 and Y.<br />&nbsp; &nbsp;STA Pointer<br />&nbsp; &nbsp;STA Pointer + 1<br /><br />@initializeRamOuterLoop:<br />@initializeRamInnerLoop:<br /><br />&nbsp; &nbsp;; There is a certain RAM area that shall not be initialized with zeroes<br />&nbsp; &nbsp;; because this area shall be persistent when the Reset button is pressed.<br />&nbsp; &nbsp;; We check if we reached that RAM area.<br /><br />&nbsp; &nbsp;; The high byte of the address is checked.<br />&nbsp; &nbsp;LDA Pointer + 1<br />&nbsp; &nbsp;CMP #&gt;(__NO_RESET_LOAD__)<br />&nbsp; &nbsp;BNE @noNoResetSkip<br /><br />&nbsp; &nbsp;; The low byte is checked.<br />&nbsp; &nbsp;CPY #&lt;(__NO_RESET_LOAD__)<br />&nbsp; &nbsp;BNE @noNoResetSkip<br /><br />&nbsp; &nbsp;; If we reached the reset-persistent area,<br />&nbsp; &nbsp;; we change the address to the first value after the area.<br />&nbsp; &nbsp;; This way, the reset-persistent area doesn't get changed.<br />&nbsp; &nbsp;LDY #&lt;(__NO_RESET_LOAD__ + __NO_RESET_SIZE__)<br />&nbsp; &nbsp;LDA #&gt;(__NO_RESET_LOAD__ + __NO_RESET_SIZE__)<br />&nbsp; &nbsp;STA Pointer + 1<br /><br />@noNoResetSkip:<br /><br />&nbsp; &nbsp;; Set the value of 0 to the current address.<br />&nbsp; &nbsp;LDA #0<br />&nbsp; &nbsp;STA (Pointer), Y<br /><br />&nbsp; &nbsp;; Increment the low byte part of the address.<br />&nbsp; &nbsp;INY<br /><br />&nbsp; &nbsp;; If it is set back to zero, increment the high byte part<br />&nbsp; &nbsp;; and, of course, the counter.<br />&nbsp; &nbsp;; Otherwise, continue with the inner loop.<br />&nbsp; &nbsp;BNE @initializeRamInnerLoop<br />&nbsp; &nbsp;INC Pointer + 1<br />&nbsp; &nbsp;INX<br /><br />&nbsp; &nbsp;; The outer loop ends just before address $0800.<br />&nbsp; &nbsp;CPX #$08<br />&nbsp; &nbsp;BNE @initializeRamOuterLoop<br /><br />&nbsp; &nbsp;; The RAM has now been initialized with all zeroes.<br /><br />&nbsp; &nbsp;; The second wait for vblank.<br />&nbsp; &nbsp;WAIT_FOR_VBLANK<br /><br />&nbsp; &nbsp;; From now on, the system is properly initialized.<br /><br />&nbsp; &nbsp;; We want to check whether the console is NTSC or PAL.<br />&nbsp; &nbsp;; This is needed only for the music.<br />&nbsp; &nbsp;; The gameplay isn't adjusted to this value.<br /><br />&nbsp; &nbsp;; We set counters.<br />&nbsp; &nbsp;LDX #52<br />&nbsp; &nbsp;LDY #24<br /><br />@ntscPalLoop:<br /><br />&nbsp; &nbsp;DEX<br />&nbsp; &nbsp;BNE @ntscPalLoop<br />&nbsp; &nbsp;DEY<br />&nbsp; &nbsp;BNE @ntscPalLoop<br /><br />&nbsp; &nbsp;; Now we AND-combine PpuStatus with $80.<br />&nbsp; &nbsp;; This tells us whether we have NTSC or PAL.<br />&nbsp; &nbsp;; 0 means the console is PAL, non-zero means it's NTSC.<br />&nbsp; &nbsp;LDA PpuStatus<br />&nbsp; &nbsp;AND #$80<br /><br />&nbsp; &nbsp;; The FamiTone sound library gets initialized.<br />&nbsp; &nbsp;; The value in A is necessary for setting NTSC or PAL.<br />&nbsp; &nbsp;JSR InitializeSound<br /><br />&nbsp; &nbsp;; The argument stack pointer for CC65 is initialized.<br />&nbsp; &nbsp;; From now on, we can call functions written in C.<br />&nbsp; &nbsp;LDA #&lt;(__STACK_START__ + __STACK_SIZE__)<br />&nbsp; &nbsp;STA sp<br />&nbsp; &nbsp;LDA #&gt;(__STACK_START__ + __STACK_SIZE__)<br />&nbsp; &nbsp;STA sp + 1<br /><br />&nbsp; &nbsp;; The reset-persistent data is checked and set to an initial value<br />&nbsp; &nbsp;; if the console was started with the Power button.<br />&nbsp; &nbsp;JSR InitializeNoResetData<br /><br />&nbsp; &nbsp;; General initializations of graphics, game logic and everything else.<br />&nbsp; &nbsp;JSR Initialize<br /><br />&nbsp; &nbsp;; The first thing that is supposed to run is the NMI.<br />&nbsp; &nbsp;; Therefore, we set the WaitForNmi variable to true.<br />&nbsp; &nbsp;LDA #true<br />&nbsp; &nbsp;STA WaitForNmi<br /><br />&nbsp; &nbsp;; The PPU control register is set with its horizontal value.<br />&nbsp; &nbsp;; This means the NMI is enabled now.<br />&nbsp; &nbsp;; From now on, NMI should never be switched off again.<br />&nbsp; &nbsp;; The various bits in the value can change,<br />&nbsp; &nbsp;; but NMI itself should always be on.<br />&nbsp; &nbsp;LDA #PpuCtrlHorizontal<br />&nbsp; &nbsp;STA PpuCtrl<br /><br />&nbsp; &nbsp;; The general game logic.<br />@gameLogic:<br /><br />&nbsp; &nbsp;; When the program is waiting for the NMI to hit<br />&nbsp; &nbsp;; after the game logic has run already,<br />&nbsp; &nbsp;; then the game logic is not allowed to run again and is skipped.<br />&nbsp; &nbsp;; Only when NMI is done is the game logic actually entered.<br />&nbsp; &nbsp;LDA WaitForNmi<br />&nbsp; &nbsp;BNE @gameLogicEnd<br /><br />&nbsp; &nbsp;; Next, the buttons of the controller are read.<br /><br />&nbsp; &nbsp;; Before we read the controller input, we save the status from the previous frame.<br />&nbsp; &nbsp;LDA ControllerInput<br />&nbsp; &nbsp;STA PreviousControllerInput<br /><br />&nbsp; &nbsp;; Latch the buttons of the controller.<br />&nbsp; &nbsp;LDA #1<br />&nbsp; &nbsp;STA ControllerPort<br />&nbsp; &nbsp;LDA #0<br />&nbsp; &nbsp;STA ControllerPort<br /><br />&nbsp; &nbsp;; X is the counter for each button.<br />&nbsp; &nbsp;LDX #8<br /><br />@readControllerLoop:<br /><br />&nbsp; &nbsp;PHA<br /><br />&nbsp; &nbsp;; Each button is read.<br />&nbsp; &nbsp;LDA ControllerPort<br /><br />&nbsp; &nbsp;; The lowest two bytes are masked off.<br />&nbsp; &nbsp;AND #%00000011<br /><br />&nbsp; &nbsp;; Compare to 1 which sets the carry flag<br />&nbsp; &nbsp;; to check if either or both bits are set.<br />&nbsp; &nbsp;CMP #1<br /><br />&nbsp; &nbsp;; Rotate the carry flag into the top of A.<br />&nbsp; &nbsp;PLA<br /><br />&nbsp; &nbsp;; Shift all other buttons to the right.<br />&nbsp; &nbsp;ROR A<br /><br />&nbsp; &nbsp;; There are eight buttons to read for the controller.<br />&nbsp; &nbsp;; The counter is decremented until the loop is over.<br />&nbsp; &nbsp;DEX<br />&nbsp; &nbsp;BNE @readControllerLoop<br /><br />&nbsp; &nbsp;; The controller input is saved.<br />&nbsp; &nbsp;STA ControllerInput<br /><br />&nbsp; &nbsp;; Controller reading has ended.<br /><br />&nbsp; &nbsp;; The next frame is calculated based on the current frame and the controller input.<br />&nbsp; &nbsp;; Due to the parallax scrolling, we have three frame processing functions.<br />&nbsp; &nbsp;; This is the first one.<br />&nbsp; &nbsp;; It needs to be finished until the status bar has been drawn.<br />&nbsp; &nbsp;JSR ProcessNextFrameTop<br /><br />&nbsp; &nbsp;; If PpuMaskValue is 0, we skip the top scrolling.<br />&nbsp; &nbsp;LDA PpuMaskValue<br />&nbsp; &nbsp;BEQ @skipScrollingTop<br /><br />&nbsp; &nbsp;; Wait for the first sprite overflow (more than eight sprites on one scanline).<br />&nbsp; &nbsp;WAIT_FOR_PPU_STATUS %00100000<br /><br />&nbsp; &nbsp;; The scrolling position for the middle screen is done.<br />&nbsp; &nbsp;SET_SCROLLING_POSITION ScrollingPositionMiddle, NameTableMiddle<br /><br />@skipScrollingTop:<br /><br />&nbsp; &nbsp;; The second frame processing function.<br />&nbsp; &nbsp;; This is the one that has the most time.<br />&nbsp; &nbsp;; It needs to be finished until the point for parallax scrolling is reached.<br />&nbsp; &nbsp;JSR ProcessNextFrameMiddle<br /><br />&nbsp; &nbsp;; If PpuMaskValue is 0, we skip the middle scrolling.<br />&nbsp; &nbsp;LDA PpuMaskValue<br />&nbsp; &nbsp;BEQ @skipScrollingBottom<br /><br />&nbsp; &nbsp;; Wait for sprite 0 hit.<br />&nbsp; &nbsp;WAIT_FOR_PPU_STATUS %01000000<br /><br />&nbsp; &nbsp;; The scrolling position for the lower screen is done.<br />&nbsp; &nbsp;; If midframe scrolling is disabled,<br />&nbsp; &nbsp;; this is the only scrolling that is done at all.<br />&nbsp; &nbsp;SET_SCROLLING_POSITION ScrollingPositionBottom, NameTableBottom<br /><br />@skipScrollingBottom:<br /><br />&nbsp; &nbsp;; The third frame processing function.<br />&nbsp; &nbsp;JSR ProcessNextFrameBottom<br /><br />&nbsp; &nbsp;; The next thing that needs to be executed is the NMI.<br />&nbsp; &nbsp;LDA #true<br />&nbsp; &nbsp;STA WaitForNmi<br /><br />@gameLogicEnd:<br /><br />&nbsp; &nbsp;; The program goes into an infinite loop where it processes the game logic whenever it's allowed.<br />&nbsp; &nbsp;JMP @gameLogic</div></div>

					
						<div class="postbody"><br />_________________<br />Available now: My game &quot;City Trouble&quot;.<br />Website: <!-- m --><a class="postlink" href="https://megacatstudios.com/products/city-trouble">https://megacatstudios.com/products/city-trouble</a><!-- m --><br />Trailer: <!-- m --><a class="postlink" href="https://youtu.be/IYXpP59qSxA">https://youtu.be/IYXpP59qSxA</a><!-- m --><br />Gameplay: <!-- m --><a class="postlink" href="https://youtu.be/Eee0yurkIW4">https://youtu.be/Eee0yurkIW4</a><!-- m --><br />German Retro Gamer article: <!-- m --><a class="postlink" href="http://i67.tinypic.com/345o108.jpg">http://i67.tinypic.com/345o108.jpg</a><!-- m --></div>
					
							<br /><br />
							<span class="gensmall">Last edited by <a href="./memberlist.php?mode=viewprofile&amp;u=6156">DRW</a> on Fri Mar 31, 2017 12:02 pm, edited 1 time in total.</span>
						<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=6156"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row2">

			<td align="center" valign="middle">
				<a name="p192300"></a>
				<b class="postauthor" style="color: #FF3300">tepples</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p192300">Re: Game stuck at credits, except during soft reset</a></div><div style="float: right;"><a href="./viewtopic.php?p=192300#p192300"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Fri Mar 31, 2017 12:00 pm&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Sun Sep 19, 2004 11:12 pm<br /><b>Posts:</b> 20409<br /><b>Location:</b> NE Indiana, USA (NTSC)
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">Dynamic random access memory (DRAM) decays if not refreshed. OAM in the PPU is DRAM, and rendering refreshes it. Not rendering for longer than about a couple dozen scanlines (the length of vblank) causes OAM to decay to unpredictable values, including the position and identity of sprite 0. So if you disable rendering for a while (to set up your credit screen) and then wait for sprite 0 hit, you need to keep uploading display lists to OAM using $4014.</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=9"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row1">

			<td align="center" valign="middle">
				<a name="p192302"></a>
				<b class="postauthor">DRW</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p192302">Re: Game stuck at credits, except during soft reset</a></div><div style="float: right;"><a href="./viewtopic.php?p=192302#p192302"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Fri Mar 31, 2017 12:18 pm&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				<tr>
					<td><img src="./download/file.php?avatar=6156_1471126672.png" width="100" height="88" alt="User avatar" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Sat Sep 07, 2013 2:59 pm<br /><b>Posts:</b> 1662
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">I indeed do a bunch of stuff before rendering is turned on again before a game section:<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">TempNameTableMiddle = NameTableMiddle =<br />TempScrollingPositionMiddle = ScrollingPositionMiddle =<br />TempNameTableBottom = NameTableBottom =<br />TempScrollingPositionBottom = ScrollingPositionBottom =<br />&nbsp; &nbsp; 0;<br /><br />/* The system sprites for the scrolling split<br />&nbsp; &nbsp;are set to their correct locations. */<br />UpdateSystemSprites();<br /><br />ClearSprites(FirstNonSystemSpriteIndex);<br /><br />ClearPpu();<br /><br />if (GameSectionIsLevel())<br />&nbsp; &nbsp; InitializeLevel();<br />else<br />&nbsp; &nbsp; InitializeTextScreen();<br /><br />GameSectionIsInitialized = true;<br /><br />/* The PPU mask variable is set<br />&nbsp; &nbsp;with its default value.<br />&nbsp; &nbsp;This means rendering is enabled<br />&nbsp; &nbsp;once the value is written<br />&nbsp; &nbsp;to the actual PPU mask.<br />&nbsp; &nbsp;Enabling and disabling the PPU mask<br />&nbsp; &nbsp;should be done only inside NMI.<br />&nbsp; &nbsp;Otherwise, rendering the current data<br />&nbsp; &nbsp;might happen mid-frame. */<br />PpuMaskValue = Bin(0,0,0,1,1,1,1,0);</div><br /><br />However, nothing sprite-related writes to the actual PPU in this case.<br />ClearSprites and UpdateSystemSprites do nothing but writing stuff into a plain and simple array:<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">byte Sprites&#91;256&#93;;</div><br />which is located at $0200. (The location is forced by the NES.cfg file and putting the array into a specific segment.)<br /><br />The actual sprites in the PPU are only ever accessed in the NMI, and only in this way:<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">; The low byte of the sprites address gets sent to the PPU port.<br />LDA #&lt;Sprites<br />STA OamAddr<br /><br />; The high byte gets sent and we specify that the transfer is done immediately.<br />LDA #&gt;Sprites<br />STA OamDma</div><br /><br />So, can this still be the issue?<br /><br />What about too few wait for vblank? I once heard of someone who uses a third one to be sure. Can this be the problem?</div>

					
						<div class="postbody"><br />_________________<br />Available now: My game &quot;City Trouble&quot;.<br />Website: <!-- m --><a class="postlink" href="https://megacatstudios.com/products/city-trouble">https://megacatstudios.com/products/city-trouble</a><!-- m --><br />Trailer: <!-- m --><a class="postlink" href="https://youtu.be/IYXpP59qSxA">https://youtu.be/IYXpP59qSxA</a><!-- m --><br />Gameplay: <!-- m --><a class="postlink" href="https://youtu.be/Eee0yurkIW4">https://youtu.be/Eee0yurkIW4</a><!-- m --><br />German Retro Gamer article: <!-- m --><a class="postlink" href="http://i67.tinypic.com/345o108.jpg">http://i67.tinypic.com/345o108.jpg</a><!-- m --></div>
					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=6156"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row2">

			<td align="center" valign="middle">
				<a name="p192304"></a>
				<b class="postauthor">DRW</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p192304">Re: Game stuck at credits, except during soft reset</a></div><div style="float: right;"><a href="./viewtopic.php?p=192304#p192304"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Fri Mar 31, 2017 12:23 pm&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				<tr>
					<td><img src="./download/file.php?avatar=6156_1471126672.png" width="100" height="88" alt="User avatar" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Sat Sep 07, 2013 2:59 pm<br /><b>Posts:</b> 1662
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">Besides, naturally, I never wait for sprite 0 and sprite overflow when rendering is disabled:<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">&nbsp; &nbsp;; The next frame is calculated based on the current frame and the controller input.<br />&nbsp; &nbsp;; Due to the parallax scrolling, we have three frame processing functions.<br />&nbsp; &nbsp;; This is the first one.<br />&nbsp; &nbsp;; It needs to be finished until the status bar has been drawn.<br />&nbsp; &nbsp;JSR ProcessNextFrameTop<br /><br />&nbsp; &nbsp;; If PpuMaskValue is 0, we skip the top scrolling.<br />&nbsp; &nbsp;LDA PpuMaskValue<br />&nbsp; &nbsp;BEQ @skipScrollingTop<br /><br />&nbsp; &nbsp;; Wait for the first sprite overflow (more than eight sprites on one scanline).<br />&nbsp; &nbsp;WAIT_FOR_PPU_STATUS %00100000<br /><br />&nbsp; &nbsp;; The scrolling position for the middle screen is done.<br />&nbsp; &nbsp;SET_SCROLLING_POSITION ScrollingPositionMiddle, NameTableMiddle<br /><br />@skipScrollingTop:<br /><br />&nbsp; &nbsp;; The second frame processing function.<br />&nbsp; &nbsp;; This is the one that has the most time.<br />&nbsp; &nbsp;; It needs to be finished until the point for parallax scrolling is reached.<br />&nbsp; &nbsp;JSR ProcessNextFrameMiddle<br /><br />&nbsp; &nbsp;; If PpuMaskValue is 0, we skip the middle scrolling.<br />&nbsp; &nbsp;LDA PpuMaskValue<br />&nbsp; &nbsp;BEQ @skipScrollingBottom<br /><br />&nbsp; &nbsp;; Wait for sprite 0 hit.<br />&nbsp; &nbsp;WAIT_FOR_PPU_STATUS %01000000<br /><br />&nbsp; &nbsp;; The scrolling position for the lower screen is done.<br />&nbsp; &nbsp;; If midframe scrolling is disabled,<br />&nbsp; &nbsp;; this is the only scrolling that is done at all.<br />&nbsp; &nbsp;SET_SCROLLING_POSITION ScrollingPositionBottom, NameTableBottom<br /><br />@skipScrollingBottom:<br /><br />&nbsp; &nbsp;; The third frame processing function.<br />&nbsp; &nbsp;JSR ProcessNextFrameBottom<br /><br />&nbsp; &nbsp;; The next thing that needs to be executed is the NMI.<br />&nbsp; &nbsp;LDA #true<br />&nbsp; &nbsp;STA WaitForNmi</div></div>

					
						<div class="postbody"><br />_________________<br />Available now: My game &quot;City Trouble&quot;.<br />Website: <!-- m --><a class="postlink" href="https://megacatstudios.com/products/city-trouble">https://megacatstudios.com/products/city-trouble</a><!-- m --><br />Trailer: <!-- m --><a class="postlink" href="https://youtu.be/IYXpP59qSxA">https://youtu.be/IYXpP59qSxA</a><!-- m --><br />Gameplay: <!-- m --><a class="postlink" href="https://youtu.be/Eee0yurkIW4">https://youtu.be/Eee0yurkIW4</a><!-- m --><br />German Retro Gamer article: <!-- m --><a class="postlink" href="http://i67.tinypic.com/345o108.jpg">http://i67.tinypic.com/345o108.jpg</a><!-- m --></div>
					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=6156"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row1">

			<td align="center" valign="middle">
				<a name="p192307"></a>
				<b class="postauthor">DRW</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p192307">Re: Game stuck at credits, except during soft reset</a></div><div style="float: right;"><a href="./viewtopic.php?p=192307#p192307"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Fri Mar 31, 2017 12:56 pm&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				<tr>
					<td><img src="./download/file.php?avatar=6156_1471126672.png" width="100" height="88" alt="User avatar" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Sat Sep 07, 2013 2:59 pm<br /><b>Posts:</b> 1662
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">And in case it's necessary, here's my NMI function:<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">.segment &quot;CODE&quot;<br /><br />Nmi:<br /><br />&nbsp; &nbsp;; The registers are put to the stack.<br />&nbsp; &nbsp;; This is done because NMI can trigger any time,<br />&nbsp; &nbsp;; even if the program is right in the middle of the game logic.<br />&nbsp; &nbsp;; In this case, we have to be able<br />&nbsp; &nbsp;; to restore the current status when NMI is left again.<br />&nbsp; &nbsp;PHA<br />&nbsp; &nbsp;TXA<br />&nbsp; &nbsp;PHA<br />&nbsp; &nbsp;TYA<br />&nbsp; &nbsp;PHA<br /><br />&nbsp; &nbsp;; If it's not time for the NMI to trigger<br />&nbsp; &nbsp;; because the game logic has still not finished,<br />&nbsp; &nbsp;; NMI is left again.<br />&nbsp; &nbsp;; Otherwise we go on.<br />&nbsp; &nbsp;LDA WaitForNmi<br />&nbsp; &nbsp;BEQ @end<br /><br />&nbsp; &nbsp;; After the NMI was processed, the game logic may start again<br />&nbsp; &nbsp;; and NMI is disallowed until the game logic is over.<br />&nbsp; &nbsp;; Setting this value right here at the start<br />&nbsp; &nbsp;; would also prevent a second NMI to do anything<br />&nbsp; &nbsp;; in case the first NMI ever takes too long.<br />&nbsp; &nbsp;; (Which shouldn't happen, but it's still safe this way.)<br />&nbsp; &nbsp;LDA #false<br />&nbsp; &nbsp;STA WaitForNmi<br /><br />&nbsp; &nbsp;; The actual PPU mask is set with the value that was saved for it.<br />&nbsp; &nbsp;LDA PpuMaskValue<br />&nbsp; &nbsp;STA PpuMask<br /><br />&nbsp; &nbsp;; If it is 0, NMI is left again.<br />&nbsp; &nbsp;BEQ @end<br /><br />&nbsp; &nbsp;; Rendering the sprites.<br />&nbsp; &nbsp;; The NMI gets the sprites per direct memory access (DMA).<br />&nbsp; &nbsp;; So, we tell it where in memory they can be found:<br /><br />&nbsp; &nbsp;; The low byte of the sprites address gets sent to the PPU port.<br />&nbsp; &nbsp;LDA #&lt;Sprites<br />&nbsp; &nbsp;STA OamAddr<br /><br />&nbsp; &nbsp;; The high byte gets sent and we specify that the transfer is done immediately.<br />&nbsp; &nbsp;LDA #&gt;Sprites<br />&nbsp; &nbsp;STA OamDma<br /><br />&nbsp; &nbsp;; Drawing the background, the attributes and the palettes.<br />&nbsp; &nbsp;; There is not enough time to draw the whole background every frame.<br />&nbsp; &nbsp;; That's why the following code may only draw whatever has changed.<br />&nbsp; &nbsp;; Important: Palette updates should ALWAYS be in the NMI, never outside it.<br />&nbsp; &nbsp;; Otherwise they might change the screen's color when rendering is turned off.<br />&nbsp; &nbsp;; So, don't call UpdatePpu outside of NMI when it contains palettes data.<br />&nbsp; &nbsp;; Updating the background and the attributes outside of NMI is o.k. though.<br />&nbsp; &nbsp;JSR UpdatePpu<br /><br />&nbsp; &nbsp;; Setting the scrolling position.<br /><br />&nbsp; &nbsp;; At first, the status bar is drawn.<br />&nbsp; &nbsp;; So, the horizontal and vertical scrolling position are set to 0.<br />&nbsp; &nbsp;LDA #0<br />&nbsp; &nbsp;STA PpuScroll<br />&nbsp; &nbsp;STA PpuScroll<br /><br />&nbsp; &nbsp;; The status bar appears in nametable 0, so we set the horizontal value.<br />&nbsp; &nbsp;LDA #PpuCtrlHorizontal<br />&nbsp; &nbsp;STA PpuCtrl<br /><br />&nbsp; &nbsp;; The rest of the scrolling is done outside NMI<br />&nbsp; &nbsp;; when the corresponding places<br />&nbsp; &nbsp;; (status bar end, parallax scrolling line)<br />&nbsp; &nbsp;; are reached.<br /><br />@end:<br /><br />&nbsp; &nbsp;; The sound update is done always,<br />&nbsp; &nbsp;; so that the sound wouldn't lag<br />&nbsp; &nbsp;; even if the game logic does.<br />&nbsp; &nbsp;JSR FamiToneUpdate<br /><br />&nbsp; &nbsp;; The registers are pulled from the stack,<br />&nbsp; &nbsp;; so that they get the same values as when NMI hit.<br />&nbsp; &nbsp;PLA<br />&nbsp; &nbsp;TAY<br />&nbsp; &nbsp;PLA<br />&nbsp; &nbsp;TAX<br />&nbsp; &nbsp;PLA<br /><br />&nbsp; &nbsp;; The NMI has ended and the program returns<br />&nbsp; &nbsp;; to the code that was interrupted by the NMI.<br />&nbsp; &nbsp;RTI</div></div>

					
						<div class="postbody"><br />_________________<br />Available now: My game &quot;City Trouble&quot;.<br />Website: <!-- m --><a class="postlink" href="https://megacatstudios.com/products/city-trouble">https://megacatstudios.com/products/city-trouble</a><!-- m --><br />Trailer: <!-- m --><a class="postlink" href="https://youtu.be/IYXpP59qSxA">https://youtu.be/IYXpP59qSxA</a><!-- m --><br />Gameplay: <!-- m --><a class="postlink" href="https://youtu.be/Eee0yurkIW4">https://youtu.be/Eee0yurkIW4</a><!-- m --><br />German Retro Gamer article: <!-- m --><a class="postlink" href="http://i67.tinypic.com/345o108.jpg">http://i67.tinypic.com/345o108.jpg</a><!-- m --></div>
					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=6156"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row2">

			<td align="center" valign="middle">
				<a name="p192351"></a>
				<b class="postauthor">Pokun</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p192351">Re: Game stuck at credits, except during soft reset</a></div><div style="float: right;"><a href="./viewtopic.php?p=192351#p192351"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Sat Apr 01, 2017 9:51 am&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Tue May 28, 2013 5:49 am<br /><b>Posts:</b> 999<br /><b>Location:</b> Sweden
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">I see a classic mistake in the OAM DMA:<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">&nbsp; &nbsp;; The low byte of the sprites address gets sent to the PPU port.<br />&nbsp; &nbsp;LDA #&lt;Sprites<br />&nbsp; &nbsp;STA OamAddr<br />&nbsp;<br />&nbsp; &nbsp;; The high byte gets sent and we specify that the transfer is done immediately.<br />&nbsp; &nbsp;LDA #&gt;Sprites<br />&nbsp; &nbsp;STA OamDma<br /></div><br />This code probably works, but the label usage and comments hints that the assumptions how these registers works are incorrect.<br />OamAddr ($2003) isn't used for the low byte of the source address, it's the start address of the destination in the OAM (OAM is only 256 byte so only one byte is needed for the address). OamDma ($4014) takes the high byte of the starting source address which is normally the page number of a RAM page (only full RAM pages can be used for shadow OAM as I understand it), so there is no need to specify the low part of the source address.<br /><br />Before starting an OAM DMA you always write 0 to OamAddr to make sure the OAM DMA writes from the beginning of OAM. Then you write the RAM page number you are using as shadow OAM to OamDma to invoke the DMA.<br />If &quot;Sprite&quot; is changed to something that doesn't have $00 in it's upper byte, the code won't work as expected.<br />So the code should probably look something like this:<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">&nbsp; &nbsp;; Ensure OAM address $00 is selected as destination start address.<br />&nbsp; &nbsp;LDA #$00<br />&nbsp; &nbsp;STA OamAddr<br />&nbsp;<br />&nbsp; &nbsp;; Set the RAM page to be used as source address and invoke OAM-DMA<br />&nbsp; &nbsp;LDA #&gt;Sprites<br />&nbsp; &nbsp;STA OamDma<br /></div></div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=6013"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row1">

			<td align="center" valign="middle">
				<a name="p192354"></a>
				<b class="postauthor">tokumaru</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p192354">Re: Game stuck at credits, except during soft reset</a></div><div style="float: right;"><a href="./viewtopic.php?p=192354#p192354"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Sat Apr 01, 2017 10:05 am&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				<tr>
					<td><img src="./download/file.php?avatar=95.png" width="80" height="80" alt="User avatar" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Sat Feb 12, 2005 9:43 pm<br /><b>Posts:</b> 10714<br /><b>Location:</b> Rio de Janeiro - Brazil
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">This mistake comes straight out of Nerdy Nights.</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=95"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row2">

			<td align="center" valign="middle">
				<a name="p192365"></a>
				<b class="postauthor">DRW</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p192365">Re: Game stuck at credits, except during soft reset</a></div><div style="float: right;"><a href="./viewtopic.php?p=192365#p192365"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Sat Apr 01, 2017 11:23 am&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				<tr>
					<td><img src="./download/file.php?avatar=6156_1471126672.png" width="100" height="88" alt="User avatar" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Sat Sep 07, 2013 2:59 pm<br /><b>Posts:</b> 1662
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">Indeed, it is out of Nerdy Nights.<br /><br />However, this cannot be the specific mistake in my case because I'm fully aware that my sprite array has to be aligned to $100. And I took means that this is always guaranteed:<br /><br />NES.cfg (only the relevant stuff):<div class="codetitle"><b>Code:</b></div><div class="codecontent">MEMORY<br />{<br />&nbsp; &nbsp;ZP:&nbsp; &nbsp; &nbsp; type = rw, start = $0001,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; size = $00FF,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;file = &quot;&quot;;<br />&nbsp; &nbsp;RAM:&nbsp; &nbsp; &nbsp;type = rw, start = $0200,&nbsp; &nbsp;size = $0400,&nbsp; &nbsp;file = &quot;&quot;;<br />}<br /><br />SEGMENTS<br />{<br />&nbsp; &nbsp;ZEROPAGE: load = ZP,&nbsp; &nbsp; &nbsp; type = zp;<br />&nbsp; &nbsp;SPRITES:&nbsp; load = RAM,&nbsp; &nbsp; &nbsp;type = bss, align = $0100;<br />&nbsp; &nbsp;FAMITONE: load = RAM,&nbsp; &nbsp; &nbsp;type = bss, align = $0100;<br />&nbsp; &nbsp;BSS:&nbsp; &nbsp; &nbsp; load = RAM,&nbsp; &nbsp; &nbsp;type = bss;<br />&nbsp; &nbsp;NO_RESET: load = RAM,&nbsp; &nbsp; &nbsp;type = bss,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; define = yes;<br />}</div><br /><br />Declaration in the code:<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">.segment &quot;SPRITES&quot;<br /><br />&nbsp; &nbsp;Sprites: .res $100<br />&nbsp; &nbsp;.export Sprites<br />&nbsp; &nbsp;.export _Sprites = Sprites</div><br /><br />So, thanks for the hint. I'll correct it in the future and write a better comment.<br />But binary-wise, it makes no difference because the low byte of the sprites array is always 0.<br />Otherwise, my sprite clearing function wouldn't work anyway since it goes through the array until the counter reaches 0 again.<br /><br />So, unfortunately, this was not relevant to the specific issue I'm having.</div>

					
						<div class="postbody"><br />_________________<br />Available now: My game &quot;City Trouble&quot;.<br />Website: <!-- m --><a class="postlink" href="https://megacatstudios.com/products/city-trouble">https://megacatstudios.com/products/city-trouble</a><!-- m --><br />Trailer: <!-- m --><a class="postlink" href="https://youtu.be/IYXpP59qSxA">https://youtu.be/IYXpP59qSxA</a><!-- m --><br />Gameplay: <!-- m --><a class="postlink" href="https://youtu.be/Eee0yurkIW4">https://youtu.be/Eee0yurkIW4</a><!-- m --><br />German Retro Gamer article: <!-- m --><a class="postlink" href="http://i67.tinypic.com/345o108.jpg">http://i67.tinypic.com/345o108.jpg</a><!-- m --></div>
					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=6156"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row1">

			<td align="center" valign="middle">
				<a name="p192368"></a>
				<b class="postauthor">tokumaru</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p192368">Re: Game stuck at credits, except during soft reset</a></div><div style="float: right;"><a href="./viewtopic.php?p=192368#p192368"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Sat Apr 01, 2017 11:44 am&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				<tr>
					<td><img src="./download/file.php?avatar=95.png" width="80" height="80" alt="User avatar" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Sat Feb 12, 2005 9:43 pm<br /><b>Posts:</b> 10714<br /><b>Location:</b> Rio de Janeiro - Brazil
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">Yeah, this makes no difference for the final binary. I haven't looked at all the code posted, but the suspicion​ is that rendering is disabled long enough for the OAM data to decay and corrupt the sprite data, so when rendering is enabled again the sprites aren't properly arranged to trigger the sprite 0 hit and/or the sprite overflow. The quick fix in this case would be to do an OAM DMA before enabling rendering again, to make sure the sprite data is valid.<br /><br />I don't think any emulators simulate OAM decay, so it actually makes a lot of sense that they wouldn't exhibit this problem. But like I said, I didn't read all of the code in this thread, so I'm sorry if this theory has already been debunked.</div>

					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=95"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row2">

			<td align="center" valign="middle">
				<a name="p192373"></a>
				<b class="postauthor">DRW</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p192373">Re: Game stuck at credits, except during soft reset</a></div><div style="float: right;"><a href="./viewtopic.php?p=192373#p192373"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Sat Apr 01, 2017 1:17 pm&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				<tr>
					<td><img src="./download/file.php?avatar=6156_1471126672.png" width="100" height="88" alt="User avatar" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Sat Sep 07, 2013 2:59 pm<br /><b>Posts:</b> 1662
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">Hmm. O.k., I'll try it. (Memblers is checking the ROMs on real hardware for me.)<br /><br />However, I'm not sure whether this can actually be the issue.<br /><br />Here, let me show you a shortened version of the code:<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">&nbsp; &nbsp;JSR Initialize<br />&nbsp; &nbsp;; Sets PpuMaskValue to %00011110 in C.<br /><br />&nbsp; &nbsp;LDA #true<br />&nbsp; &nbsp;STA WaitForNmi<br /><br />&nbsp; &nbsp;LDA #%10010000<br />&nbsp; &nbsp;STA PpuCtrl<br /><br />@gameLogic:<br /><br />&nbsp; &nbsp;LDA WaitForNmi<br />&nbsp; &nbsp;BNE @gameLogicEnd<br /><br />&nbsp; &nbsp;;;; ReadController ;;;<br /><br />&nbsp; &nbsp;JSR ProcessNextFrameTop<br /><br />&nbsp; &nbsp;LDA PpuMaskValue<br />&nbsp; &nbsp;BEQ @skipScrollingTop<br /><br />&nbsp; &nbsp;WAIT_FOR_PPU_STATUS %00100000<br />&nbsp; &nbsp;SET_SCROLLING_POSITION ScrollingPositionMiddle, NameTableMiddle<br /><br />@skipScrollingTop:<br /><br />&nbsp; &nbsp;JSR ProcessNextFrameMiddle<br /><br />&nbsp; &nbsp;LDA PpuMaskValue<br />&nbsp; &nbsp;BEQ @skipScrollingBottom<br /><br />&nbsp; &nbsp;WAIT_FOR_PPU_STATUS %01000000<br />&nbsp; &nbsp;SET_SCROLLING_POSITION ScrollingPositionBottom, NameTableBottom<br /><br />@skipScrollingBottom:<br /><br />&nbsp; &nbsp;JSR ProcessNextFrameBottom<br /><br />&nbsp; &nbsp;LDA #true<br />&nbsp; &nbsp;STA WaitForNmi<br /><br />@gameLogicEnd:<br /><br />&nbsp; &nbsp;JMP @gameLogic</div><br />At first, I set WaitForNmi to true, then I enable the rendering, then comes the game logic.<br />If WaitForNmi is still true, the game logic skips right to the end where it jumps back to the beginning.<br /><br />Only if WaitForNmi is false is the game logic done and the sprite 0 split actually checked.<br /><br />Therefore, no wait for sprite 0 or for sprite overflow can appear unless NMI has run. Also, it's only checked if the PpuMask is actually on.<br /><br />Furthermore, this is a shortened version of Nmi:<br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">Nmi:<br /><br />&nbsp; &nbsp;;;;;; PHA TXA PHA TYA PHA ;;;;;<br /><br />&nbsp; &nbsp;LDA WaitForNmi<br />&nbsp; &nbsp;BEQ @end<br /><br />&nbsp; &nbsp;LDA #false<br />&nbsp; &nbsp;STA WaitForNmi<br /><br />&nbsp; &nbsp;LDA PpuMaskValue<br />&nbsp; &nbsp;STA PpuMask<br />&nbsp; &nbsp;BEQ @end<br /><br />&nbsp; &nbsp;LDA #0<br />&nbsp; &nbsp;STA OamAddr<br />&nbsp; &nbsp;LDA #&gt;Sprites<br />&nbsp; &nbsp;STA OamDma<br /><br />&nbsp; &nbsp;JSR UpdatePpu<br /><br />&nbsp; &nbsp;LDA #0<br />&nbsp; &nbsp;STA PpuScroll<br />&nbsp; &nbsp;STA PpuScroll<br /><br />&nbsp; &nbsp;LDA #%10010000<br />&nbsp; &nbsp;STA PpuCtrl<br /><br />@end:<br /><br />&nbsp; &nbsp;JSR FamiToneUpdate<br /><br />&nbsp; &nbsp;;;;;; PLA TAY PLA TAX PLA ;;;;;</div><br />As you see, the NMI is the only place where the PPUMASK register is actually set.<br /><br />And right after this, it's always a sprite update (except if PPUMASK was set to 0 of course, but in this case, the game logic will skip sprite 0 and sprite overflow check anyway).<br /><br />So, after seeing this, can the decaying still be the issue?</div>

					
						<div class="postbody"><br />_________________<br />Available now: My game &quot;City Trouble&quot;.<br />Website: <!-- m --><a class="postlink" href="https://megacatstudios.com/products/city-trouble">https://megacatstudios.com/products/city-trouble</a><!-- m --><br />Trailer: <!-- m --><a class="postlink" href="https://youtu.be/IYXpP59qSxA">https://youtu.be/IYXpP59qSxA</a><!-- m --><br />Gameplay: <!-- m --><a class="postlink" href="https://youtu.be/Eee0yurkIW4">https://youtu.be/Eee0yurkIW4</a><!-- m --><br />German Retro Gamer article: <!-- m --><a class="postlink" href="http://i67.tinypic.com/345o108.jpg">http://i67.tinypic.com/345o108.jpg</a><!-- m --></div>
					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=6156"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row1">

			<td align="center" valign="middle">
				<a name="p192417"></a>
				<b class="postauthor">infiniteneslives</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p192417">Re: Game stuck at credits, except during soft reset</a></div><div style="float: right;"><a href="./viewtopic.php?p=192417#p192417"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Sat Apr 01, 2017 11:07 pm&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				<tr>
					<td><img src="./download/file.php?avatar=4832_1403414291.jpg" width="100" height="52" alt="User avatar" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Mon Apr 04, 2011 11:49 am<br /><b>Posts:</b> 2082<br /><b>Location:</b> WhereverIparkIt, USA
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">Have you tried simply waiting more vblanks before making any PPU writes?</div>

					
						<div class="postbody"><br />_________________<br />If you're gonna play the Game Boy, you gotta learn to play it right.  -Kenny Rogers</div>
					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=4832"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row2">

			<td align="center" valign="middle">
				<a name="p192423"></a>
				<b class="postauthor">DRW</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p192423">Re: Game stuck at credits, except during soft reset</a></div><div style="float: right;"><a href="./viewtopic.php?p=192423#p192423"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Sun Apr 02, 2017 12:50 am&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				<tr>
					<td><img src="./download/file.php?avatar=6156_1471126672.png" width="100" height="88" alt="User avatar" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Sat Sep 07, 2013 2:59 pm<br /><b>Posts:</b> 1662
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">Yes, I compiled a version where I wait three instead of two and one where a loop lets the game wait 10 vblanks.<br /><br />I sent all of those to Memblers, including the ones with the additional OAMDMA. It remains to be seen which version still has the error.</div>

					
						<div class="postbody"><br />_________________<br />Available now: My game &quot;City Trouble&quot;.<br />Website: <!-- m --><a class="postlink" href="https://megacatstudios.com/products/city-trouble">https://megacatstudios.com/products/city-trouble</a><!-- m --><br />Trailer: <!-- m --><a class="postlink" href="https://youtu.be/IYXpP59qSxA">https://youtu.be/IYXpP59qSxA</a><!-- m --><br />Gameplay: <!-- m --><a class="postlink" href="https://youtu.be/Eee0yurkIW4">https://youtu.be/Eee0yurkIW4</a><!-- m --><br />German Retro Gamer article: <!-- m --><a class="postlink" href="http://i67.tinypic.com/345o108.jpg">http://i67.tinypic.com/345o108.jpg</a><!-- m --></div>
					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row2">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=6156"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table class="tablebg" width="100%" cellspacing="1">
	<tr class="row1">

			<td align="center" valign="middle">
				<a name="p192461"></a>
				<b class="postauthor">DRW</b>
			</td>
			<td width="100%" height="25">
				<table width="100%" cellspacing="0">
				<tr>
				
					<td class="gensmall" width="100%"><div style="float: left;">&nbsp;<b>Post subject:</b> <a href="#p192461">Re: Game stuck at credits, except during soft reset</a></div><div style="float: right;"><a href="./viewtopic.php?p=192461#p192461"><img src="./styles/subsilver2/imageset/icon_post_target.gif" width="12" height="9" alt="Post" title="Post" /></a><b>Posted:</b> Mon Apr 03, 2017 10:45 am&nbsp;</div></td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td valign="top" class="profile">
				<table cellspacing="4" align="center" width="150">
			
				<tr>
					<td><img src="./styles/subsilver2/imageset/en/icon_user_offline.gif" alt="Offline" title="Offline" /></td>
				</tr>
			
				<tr>
					<td><img src="./download/file.php?avatar=6156_1471126672.png" width="100" height="88" alt="User avatar" /></td>
				</tr>
			
				</table>

				<span class="postdetails">
					<br /><b>Joined:</b> Sat Sep 07, 2013 2:59 pm<br /><b>Posts:</b> 1662
				</span>

			</td>
			<td valign="top">
				<table width="100%" cellspacing="5">
				<tr>
					<td>
					

						<div class="postbody">O.k., the publisher tested my test ROMs. I tried all of the things you told me and some more, each thing in a separate ROM:<br /><br />Setting the &quot;system sprites&quot; and manual OAMDMA at startup.<br />10 vblanks before doing anything else.<br />Checking PPUMASK directly instead of my temporary variable.<br />etc.<br /><br />The only thing that helped was completely disabling the wait for the &quot;nine sprites overflow&quot; flag. When I did this, the game always worked.<br />Sprite 0 flag wait is fine. This one doesn't freeze anything.<br />But nine sprites overflow causes the freezing.<br /><br />Now my question:<br />Is it possible that the overflow flag doesn't hit at the beginning, even though sprite 0 already does?<br />I mean, it's not that the game stops midway during playing. Also, it almost always works after a soft reset.<br />(So, a mundame error like &quot;Did you actually position the sprites correctly&quot; is also pretty much out of the question.)<br /><br />But it looks like you cannot check for nine sprites at the beginning, even though you can already check for nine sprites overflow.<br /><br />Alternately, can you please check whether my sprites overflow wait is even correct?<br /><br /><div class="codetitle"><b>Code:</b></div><div class="codecontent">.macro WAIT_FOR_PPU_STATUS value<br />&nbsp; &nbsp;.local @waitForNotPpuStatus, @waitForPpuStatus<br /><br />@waitForNotPpuStatus:<br /><br />&nbsp; &nbsp;LDA PpuStatus<br />&nbsp; &nbsp;AND #value<br />&nbsp; &nbsp;BNE @waitForNotPpuStatus<br /><br />@waitForPpuStatus:<br /><br />&nbsp; &nbsp;LDA PpuStatus<br />&nbsp; &nbsp;AND #value<br />&nbsp; &nbsp;BEQ @waitForPpuStatus<br /><br />.endmacro<br /><br />&nbsp; &nbsp;;;; Do some stuff ;;;<br /><br />&nbsp; &nbsp;WAIT_FOR_PPU_STATUS %00100000<br /><br />&nbsp; &nbsp;;;; Do some stuff ;;;<br /><br />&nbsp; &nbsp;WAIT_FOR_PPU_STATUS %01000000<br /><br />&nbsp; &nbsp;;;; Do some stuff ;;;</div></div>

					
						<div class="postbody"><br />_________________<br />Available now: My game &quot;City Trouble&quot;.<br />Website: <!-- m --><a class="postlink" href="https://megacatstudios.com/products/city-trouble">https://megacatstudios.com/products/city-trouble</a><!-- m --><br />Trailer: <!-- m --><a class="postlink" href="https://youtu.be/IYXpP59qSxA">https://youtu.be/IYXpP59qSxA</a><!-- m --><br />Gameplay: <!-- m --><a class="postlink" href="https://youtu.be/Eee0yurkIW4">https://youtu.be/Eee0yurkIW4</a><!-- m --><br />German Retro Gamer article: <!-- m --><a class="postlink" href="http://i67.tinypic.com/345o108.jpg">http://i67.tinypic.com/345o108.jpg</a><!-- m --></div>
					<br clear="all" /><br />

						<table width="100%" cellspacing="0">
						<tr valign="middle">
							<td class="gensmall" align="right">
							
							</td>
						</tr>
						</table>
					</td>
				</tr>
				</table>
			</td>
		</tr>

		<tr class="row1">

			<td class="profile"><strong><a href="#wrapheader">Top</a></strong></td>
			<td><div class="gensmall" style="float: left;">&nbsp;<a href="./memberlist.php?mode=viewprofile&amp;u=6156"><img src="./styles/subsilver2/imageset/en/icon_user_profile.gif" alt="Profile" title="Profile" /></a> &nbsp;</div> <div class="gensmall" style="float: right;">&nbsp;</div></td>
	
		</tr>

	<tr>
		<td class="spacer" colspan="2" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
	</tr>
	</table>

	<table width="100%" cellspacing="1" class="tablebg">
	<tr align="center">
		<td class="cat"><form name="viewtopic" method="post" action="./viewtopic.php?f=2&amp;t=15737"><span class="gensmall">Display posts from previous:</span> <select name="st" id="st"><option value="0" selected="selected">All posts</option><option value="1">1 day</option><option value="7">7 days</option><option value="14">2 weeks</option><option value="30">1 month</option><option value="90">3 months</option><option value="180">6 months</option><option value="365">1 year</option></select>&nbsp;<span class="gensmall">Sort by</span> <select name="sk" id="sk"><option value="a">Author</option><option value="t" selected="selected">Post time</option><option value="s">Subject</option></select> <select name="sd" id="sd"><option value="a" selected="selected">Ascending</option><option value="d">Descending</option></select>&nbsp;<input class="btnlite" type="submit" value="Go" name="sort" /></form></td>
	</tr>
	</table>
	

	<table width="100%" cellspacing="1">
	<tr>
		<td align="left" valign="middle" nowrap="nowrap">
		<a href="./posting.php?mode=post&amp;f=2"><img src="./styles/subsilver2/imageset/en/button_topic_new.gif" alt="Post new topic" title="Post new topic" /></a>&nbsp;<a href="./posting.php?mode=reply&amp;f=2&amp;t=15737"><img src="./styles/subsilver2/imageset/en/button_topic_reply.gif" alt="Reply to topic" title="Reply to topic" /></a>
		</td>
		
			<td class="nav" valign="middle" nowrap="nowrap">&nbsp;Page <strong>1</strong> of <strong>1</strong><br /></td>
			<td class="gensmall" nowrap="nowrap">&nbsp;[ 15 posts ]&nbsp;</td>
			<td class="gensmall" width="100%" align="right" nowrap="nowrap"></td>
		
	</tr>
	</table>

</div>

<div id="pagefooter"></div>

<br clear="all" />
<table class="tablebg" width="100%" cellspacing="1" cellpadding="0" style="margin-top: 5px;">
	<tr>
		<td class="row1">
			<p class="breadcrumbs"><a href="./index.php">Board index</a> &#187; <a href="./viewforum.php?f=24">NES / Famicom</a> &#187; <a href="./viewforum.php?f=2">NESdev</a></p>
			<p class="datetime">All times are UTC - 7 hours </p>
		</td>
	</tr>
	</table>
	<br clear="all" />

	<table class="tablebg" width="100%" cellspacing="1">
	<tr>
		<td class="cat"><h4>Who is online</h4></td>
	</tr>
	<tr>
		<td class="row1"><p class="gensmall">Users browsing this forum: <a href="./memberlist.php?mode=viewprofile&amp;u=38">Bregalad</a> and 4 guests</p></td>
	</tr>
	</table>


<br clear="all" />

<table width="100%" cellspacing="1">
<tr>
	<td width="40%" valign="top" nowrap="nowrap" align="left"></td>
	<td align="right" valign="top" nowrap="nowrap"><span class="gensmall">You <strong>cannot</strong> post new topics in this forum<br />You <strong>cannot</strong> reply to topics in this forum<br />You <strong>cannot</strong> edit your posts in this forum<br />You <strong>cannot</strong> delete your posts in this forum<br />You <strong>cannot</strong> post attachments in this forum<br /></span></td>
</tr>
</table>

<br clear="all" />

<table width="100%" cellspacing="0">
<tr>
	<td><form method="get" name="search" action="./search.php"><span class="gensmall">Search for:</span> <input class="post" type="text" name="keywords" size="20" /> <input class="btnlite" type="submit" value="Go" /><input type="hidden" name="t" value="15737" />
<input type="hidden" name="sf" value="msgonly" />
</form></td>
	<td align="right">
	<form method="post" name="jumpbox" action="./viewforum.php" onsubmit="if(document.jumpbox.f.value == -1){return false;}">

	<table cellspacing="0" cellpadding="0" border="0">
	<tr>
		<td nowrap="nowrap"><span class="gensmall">Jump to:</span>&nbsp;<select name="f" onchange="if(this.options[this.selectedIndex].value != -1){ document.forms['jumpbox'].submit() }">

		
			<option value="-1">Select a forum</option>
		<option value="-1">------------------</option>
			<option value="24">NES / Famicom</option>
		
			<option value="2" selected="selected">&nbsp; &nbsp;NESdev</option>
		
			<option value="3">&nbsp; &nbsp;NESemdev</option>
		
			<option value="21">&nbsp; &nbsp;NES Graphics</option>
		
			<option value="6">&nbsp; &nbsp;NES Music</option>
		
			<option value="22">&nbsp; &nbsp;Homebrew Projects</option>
		
			<option value="34">&nbsp; &nbsp;&nbsp; &nbsp;2018 NESdev Competition</option>
		
			<option value="33">&nbsp; &nbsp;&nbsp; &nbsp;2017 NESdev Competition</option>
		
			<option value="32">&nbsp; &nbsp;&nbsp; &nbsp;2016 NESdev Competition</option>
		
			<option value="31">&nbsp; &nbsp;&nbsp; &nbsp;2014 NESdev Competition</option>
		
			<option value="30">&nbsp; &nbsp;&nbsp; &nbsp;2011 NESdev Competition</option>
		
			<option value="10">&nbsp; &nbsp;Newbie Help Center</option>
		
			<option value="9">&nbsp; &nbsp;NES Hardware and Flash Equipment</option>
		
			<option value="28">&nbsp; &nbsp;&nbsp; &nbsp;Reproduction</option>
		
			<option value="19">&nbsp; &nbsp;NESdev International</option>
		
			<option value="11">&nbsp; &nbsp;&nbsp; &nbsp;FCdev</option>
		
			<option value="18">&nbsp; &nbsp;&nbsp; &nbsp;NESdev China</option>
		
			<option value="27">&nbsp; &nbsp;&nbsp; &nbsp;NESdev Middle East</option>
		
			<option value="25">Other</option>
		
			<option value="5">&nbsp; &nbsp;General Stuff</option>
		
			<option value="4">&nbsp; &nbsp;Membler Industries</option>
		
			<option value="23">&nbsp; &nbsp;Other Retro Dev</option>
		
			<option value="12">&nbsp; &nbsp;&nbsp; &nbsp;SNESdev</option>
		
			<option value="20">&nbsp; &nbsp;&nbsp; &nbsp;GBDev</option>
		
			<option value="15">&nbsp; &nbsp;Test Forum</option>
		
			<option value="26">Site Issues</option>
		
			<option value="13">&nbsp; &nbsp;phpBB Issues</option>
		
			<option value="14">&nbsp; &nbsp;Web Issues</option>
		
			<option value="16">&nbsp; &nbsp;nesdevWiki</option>
		

		</select>&nbsp;<input class="btnlite" type="submit" value="Go" /></td>
	</tr>
	</table>

	</form>
</td>
</tr>
</table>


</div>


<div id="wrapfooter">
	
	<span class="copyright">Powered by <a href="http://www.phpbb.com/">phpBB</a>&reg; Forum Software &copy; phpBB Group
	</span>
</div>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-61452025-2', 'auto');
  ga('send', 'pageview');

</script>
</body>
</html>